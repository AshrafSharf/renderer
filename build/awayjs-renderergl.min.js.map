{"version":3,"sources":["node_modules/browserify/node_modules/browser-pack/_prelude.js","awayjs-renderergl/lib/defaultrenderer.ts","awayjs-renderergl/lib/depthrenderer.ts","awayjs-renderergl/lib/distancerenderer.ts","awayjs-renderergl/lib/filter3drenderer.ts","awayjs-renderergl/lib/animators/animationsetbase.ts","awayjs-renderergl/lib/animators/animatorbase.ts","awayjs-renderergl/lib/animators/particleanimationset.ts","awayjs-renderergl/lib/animators/particleanimator.ts","awayjs-renderergl/lib/animators/skeletonanimationset.ts","awayjs-renderergl/lib/animators/skeletonanimator.ts","awayjs-renderergl/lib/animators/vertexanimationset.ts","awayjs-renderergl/lib/animators/vertexanimator.ts","awayjs-renderergl/lib/animators/data/animationregistercache.ts","awayjs-renderergl/lib/animators/data/animationsubgeometry.ts","awayjs-renderergl/lib/animators/data/colorsegmentpoint.ts","awayjs-renderergl/lib/animators/data/jointpose.ts","awayjs-renderergl/lib/animators/data/particleanimationdata.ts","awayjs-renderergl/lib/animators/data/particledata.ts","awayjs-renderergl/lib/animators/data/particlepropertiesmode.ts","awayjs-renderergl/lib/animators/data/particleproperties.ts","awayjs-renderergl/lib/animators/data/skeletonjoint.ts","awayjs-renderergl/lib/animators/data/skeletonpose.ts","awayjs-renderergl/lib/animators/data/skeleton.ts","awayjs-renderergl/lib/animators/data/vertexanimationmode.ts","awayjs-renderergl/lib/animators/nodes/animationclipnodebase.ts","awayjs-renderergl/lib/animators/nodes/particleaccelerationnode.ts","awayjs-renderergl/lib/animators/nodes/particlebeziercurvenode.ts","awayjs-renderergl/lib/animators/nodes/particlebillboardnode.ts","awayjs-renderergl/lib/animators/nodes/particlecolornode.ts","awayjs-renderergl/lib/animators/nodes/particlefollownode.ts","awayjs-renderergl/lib/animators/nodes/particleinitialcolornode.ts","awayjs-renderergl/lib/animators/nodes/particlenodebase.ts","awayjs-renderergl/lib/animators/nodes/particleorbitnode.ts","awayjs-renderergl/lib/animators/nodes/particleoscillatornode.ts","awayjs-renderergl/lib/animators/nodes/particlepositionnode.ts","awayjs-renderergl/lib/animators/nodes/particlerotatetoheadingnode.ts","awayjs-renderergl/lib/animators/nodes/particlerotatetopositionnode.ts","awayjs-renderergl/lib/animators/nodes/particlerotationalvelocitynode.ts","awayjs-renderergl/lib/animators/nodes/particlescalenode.ts","awayjs-renderergl/lib/animators/nodes/particlesegmentedcolornode.ts","awayjs-renderergl/lib/animators/nodes/particlespritesheetnode.ts","awayjs-renderergl/lib/animators/nodes/particletimenode.ts","awayjs-renderergl/lib/animators/nodes/particleuvnode.ts","awayjs-renderergl/lib/animators/nodes/particlevelocitynode.ts","awayjs-renderergl/lib/animators/nodes/skeletonbinarylerpnode.ts","awayjs-renderergl/lib/animators/nodes/skeletonclipnode.ts","awayjs-renderergl/lib/animators/nodes/skeletondifferencenode.ts","awayjs-renderergl/lib/animators/nodes/skeletondirectionalnode.ts","awayjs-renderergl/lib/animators/nodes/skeletonnarylerpnode.ts","awayjs-renderergl/lib/animators/nodes/vertexclipnode.ts","awayjs-renderergl/lib/animators/states/animationclipstate.ts","awayjs-renderergl/lib/animators/states/animationstatebase.ts","awayjs-renderergl/lib/animators/states/particleaccelerationstate.ts","awayjs-renderergl/lib/animators/states/particlebeziercurvestate.ts","awayjs-renderergl/lib/animators/states/particlebillboardstate.ts","awayjs-renderergl/lib/animators/states/particlecolorstate.ts","awayjs-renderergl/lib/animators/states/particlefollowstate.ts","awayjs-renderergl/lib/animators/states/particleinitialcolorstate.ts","awayjs-renderergl/lib/animators/states/particleorbitstate.ts","awayjs-renderergl/lib/animators/states/particleoscillatorstate.ts","awayjs-renderergl/lib/animators/states/particlepositionstate.ts","awayjs-renderergl/lib/animators/states/particlerotatetoheadingstate.ts","awayjs-renderergl/lib/animators/states/particlerotatetopositionstate.ts","awayjs-renderergl/lib/animators/states/particlerotationalvelocitystate.ts","awayjs-renderergl/lib/animators/states/particlescalestate.ts","awayjs-renderergl/lib/animators/states/particlesegmentedcolorstate.ts","awayjs-renderergl/lib/animators/states/particlespritesheetstate.ts","awayjs-renderergl/lib/animators/states/particlestatebase.ts","awayjs-renderergl/lib/animators/states/particletimestate.ts","awayjs-renderergl/lib/animators/states/particleuvstate.ts","awayjs-renderergl/lib/animators/states/particlevelocitystate.ts","awayjs-renderergl/lib/animators/states/skeletonbinarylerpstate.ts","awayjs-renderergl/lib/animators/states/skeletonclipstate.ts","awayjs-renderergl/lib/animators/states/skeletondifferencestate.ts","awayjs-renderergl/lib/animators/states/skeletondirectionalstate.ts","awayjs-renderergl/lib/animators/states/skeletonnarylerpstate.ts","awayjs-renderergl/lib/animators/states/vertexclipstate.ts","awayjs-renderergl/lib/animators/transitions/crossfadetransitionnode.ts","awayjs-renderergl/lib/animators/transitions/crossfadetransitionstate.ts","awayjs-renderergl/lib/animators/transitions/crossfadetransition.ts","awayjs-renderergl/lib/base/particlegeometry.ts","awayjs-renderergl/lib/base/rendererbase.ts","awayjs-renderergl/lib/compilation/depthrenderobject.ts","awayjs-renderergl/lib/compilation/distancerenderobject.ts","awayjs-renderergl/lib/compilation/registerpool.ts","awayjs-renderergl/lib/compilation/renderbasicmaterialobject.ts","awayjs-renderergl/lib/compilation/renderobjectbase.ts","awayjs-renderergl/lib/compilation/renderobjectpool.ts","awayjs-renderergl/lib/compilation/shadercompilerbase.ts","awayjs-renderergl/lib/compilation/shaderlightingcompiler.ts","awayjs-renderergl/lib/compilation/shaderlightingobject.ts","awayjs-renderergl/lib/compilation/shaderobjectbase.ts","awayjs-renderergl/lib/compilation/shaderregistercache.ts","awayjs-renderergl/lib/compilation/shaderregisterdata.ts","awayjs-renderergl/lib/compilation/shaderregisterelement.ts","awayjs-renderergl/lib/compilation/skyboxrenderobject.ts","awayjs-renderergl/lib/errors/animationseterror.ts","awayjs-renderergl/lib/events/animationstateevent.ts","awayjs-renderergl/lib/events/animatorevent.ts","awayjs-renderergl/lib/events/shadingmethodevent.ts","awayjs-renderergl/lib/filters/filter3dbase.ts","awayjs-renderergl/lib/filters/tasks/filter3dtaskbase.ts","awayjs-renderergl/lib/managers/defaultmaterialmanager.ts","awayjs-renderergl/lib/managers/rttbuffermanager.ts","awayjs-renderergl/lib/passes/basicmaterialpass.ts","awayjs-renderergl/lib/passes/depthpass.ts","awayjs-renderergl/lib/passes/distancepass.ts","awayjs-renderergl/lib/passes/renderpassbase.ts","awayjs-renderergl/lib/passes/skyboxpass.ts","awayjs-renderergl/lib/pick/jspickingcollider.ts","awayjs-renderergl/lib/pick/pickingcolliderbase.ts","awayjs-renderergl/lib/pick/shaderpicker.ts","awayjs-renderergl/lib/pool/billboardrenderable.ts","awayjs-renderergl/lib/pool/linesegmentrenderable.ts","awayjs-renderergl/lib/pool/linesubmeshrenderable.ts","awayjs-renderergl/lib/pool/renderablebase.ts","awayjs-renderergl/lib/pool/renderablepoolbase.ts","awayjs-renderergl/lib/pool/rendererpoolbase.ts","awayjs-renderergl/lib/pool/skyboxrenderable.ts","awayjs-renderergl/lib/pool/trianglesubmeshrenderable.ts","awayjs-renderergl/lib/tools/commands/merge.ts","awayjs-renderergl/lib/tools/data/particlegeometrytransform.ts","awayjs-renderergl/lib/utils/particlegeometryhelper.ts","awayjs-renderergl/lib/utils/perspectivematrix3d.ts","awayjs-renderergl/lib/utils/shadercompilerhelper.ts"],"names":[],"mappings":"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","file":"awayjs-renderergl.min.js","sourcesContent":["(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})","import Matrix3D\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3D\");\nimport Rectangle\t\t\t\t\t= require(\"awayjs-core/lib/geom/Rectangle\");\nimport Vector3D\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\nimport RenderTexture\t\t\t\t= require(\"awayjs-core/lib/textures/RenderTexture\");\nimport TextureProxyBase\t\t\t\t= require(\"awayjs-core/lib/textures/TextureProxyBase\");\n\nimport LightBase\t\t\t\t\t= require(\"awayjs-display/lib/base/LightBase\");\nimport IRenderer\t\t\t\t\t= require(\"awayjs-display/lib/render/IRenderer\");\nimport EntityCollector\t\t\t\t= require(\"awayjs-display/lib/traverse/EntityCollector\");\nimport ICollector\t\t\t\t\t= require(\"awayjs-display/lib/traverse/ICollector\");\nimport Camera\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\nimport DirectionalLight\t\t\t\t= require(\"awayjs-display/lib/entities/DirectionalLight\");\nimport PointLight\t\t\t\t\t= require(\"awayjs-display/lib/entities/PointLight\");\nimport MaterialBase\t\t\t\t\t= require(\"awayjs-display/lib/materials/MaterialBase\");\nimport ShadowMapperBase\t\t\t\t= require(\"awayjs-display/lib/materials/shadowmappers/ShadowMapperBase\");\n\nimport Stage\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\nimport ContextGLBlendFactor\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLBlendFactor\");\nimport ContextGLCompareMode\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLCompareMode\");\nimport ContextGLClearMask\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLClearMask\");\nimport IContextGL\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/IContextGL\");\n\nimport DepthRenderer\t\t\t\t= require(\"awayjs-renderergl/lib/DepthRenderer\");\nimport DistanceRenderer\t\t\t\t= require(\"awayjs-renderergl/lib/DistanceRenderer\");\nimport Filter3DRenderer\t\t\t\t= require(\"awayjs-renderergl/lib/Filter3DRenderer\");\nimport RendererBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/base/RendererBase\");\nimport Filter3DBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/filters/Filter3DBase\");\nimport RenderObjectBase\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/RenderObjectBase\");\nimport ShaderObjectBase\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport IRenderObjectOwner\t\t\t= require(\"awayjs-display/lib/base/IRenderObjectOwner\");\nimport IRendererPoolClass\t\t\t= require(\"awayjs-renderergl/lib/pool/IRendererPoolClass\");\nimport RenderableBase\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\nimport RenderablePoolBase\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderablePoolBase\");\nimport SkyboxRenderable\t\t\t\t= require(\"awayjs-renderergl/lib/pool/SkyboxRenderable\");\nimport RTTBufferManager\t\t\t\t= require(\"awayjs-renderergl/lib/managers/RTTBufferManager\");\nimport RenderPassBase\t\t\t\t= require(\"awayjs-renderergl/lib/passes/RenderPassBase\");\n\n/**\n * The DefaultRenderer class provides the default rendering method. It renders the scene graph objects using the\n * materials assigned to them.\n *\n * @class away.render.DefaultRenderer\n */\nclass DefaultRenderer extends RendererBase implements IRenderer\n{\n\tpublic _pRequireDepthRender:boolean;\n\tprivate _skyboxRenderablePool:RenderablePoolBase;\n\n\tprivate _pDistanceRenderer:DepthRenderer;\n\tprivate _pDepthRenderer:DepthRenderer;\n\tprivate _skyboxProjection:Matrix3D = new Matrix3D();\n\tpublic _pFilter3DRenderer:Filter3DRenderer;\n\n\tpublic _pDepthRender:TextureProxyBase;\n\n\tprivate _antiAlias:number;\n\n\tpublic get antiAlias():number\n\t{\n\t\treturn this._antiAlias;\n\t}\n\n\tpublic set antiAlias(value:number)\n\t{\n\t\tif (this._antiAlias == value)\n\t\t\treturn;\n\n\t\tthis._antiAlias = value;\n\n\t\tthis._pBackBufferInvalid = true;\n\t}\n\n\t/**\n\t *\n\t */\n\tpublic get depthPrepass():boolean\n\t{\n\t\treturn this._depthPrepass;\n\t}\n\n\tpublic set depthPrepass(value:boolean)\n\t{\n\t\tthis._depthPrepass = value;\n\t}\n\n\t/**\n\t *\n\t * @returns {*}\n\t */\n\tpublic get filters3d():Array<Filter3DBase>\n\t{\n\t\treturn this._pFilter3DRenderer? this._pFilter3DRenderer.filters : null;\n\t}\n\tpublic set filters3d(value:Array<Filter3DBase>)\n\t{\n\t\tif (value && value.length == 0)\n\t\t\tvalue = null;\n\n\t\tif (this._pFilter3DRenderer && !value) {\n\t\t\tthis._pFilter3DRenderer.dispose();\n\t\t\tthis._pFilter3DRenderer = null;\n\t\t} else if (!this._pFilter3DRenderer && value) {\n\t\t\tthis._pFilter3DRenderer = new Filter3DRenderer(this._pStage);\n\t\t\tthis._pFilter3DRenderer.filters = value;\n\t\t}\n\n\t\tif (this._pFilter3DRenderer) {\n\t\t\tthis._pFilter3DRenderer.filters = value;\n\t\t\tthis._pRequireDepthRender = this._pFilter3DRenderer.requireDepthRender;\n\t\t} else {\n\t\t\tthis._pRequireDepthRender = false;\n\n\t\t\tif (this._pDepthRender) {\n\t\t\t\tthis._pDepthRender.dispose();\n\t\t\t\tthis._pDepthRender = null;\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Creates a new DefaultRenderer object.\n\t *\n\t * @param antiAlias The amount of anti-aliasing to use.\n\t * @param renderMode The render mode to use.\n\t */\n\tconstructor(rendererPoolClass:IRendererPoolClass = null, stage:Stage = null)\n\t{\n\t\tsuper(rendererPoolClass, stage);\n\n\t\tif (this._width == 0)\n\t\t\tthis.width = window.innerWidth;\n\t\telse\n\t\t\tthis._pRttBufferManager.viewWidth = this._width;\n\n\t\tif (this._height == 0)\n\t\t\tthis.height = window.innerHeight;\n\t\telse\n\t\t\tthis._pRttBufferManager.viewHeight = this._height;\n\t}\n\n\tpublic render(entityCollector:ICollector)\n\t{\n\t\tsuper.render(entityCollector);\n\n\t\tif (!this._pStage.recoverFromDisposal()) {//if context has Disposed by the OS,don't render at this frame\n\t\t\tthis._pBackBufferInvalid = true;\n\t\t\treturn;\n\t\t}\n\n\t\tif (this._pBackBufferInvalid)// reset or update render settings\n\t\t\tthis.pUpdateBackBuffer();\n\n\t\tif (this._shareContext && this._pContext)\n\t\t\tthis._pContext.clear(0, 0, 0, 1, 1, 0, ContextGLClearMask.DEPTH);\n\n\t\tif (this._pFilter3DRenderer) {\n\t\t\tthis.textureRatioX = this._pRttBufferManager.textureRatioX;\n\t\t\tthis.textureRatioY = this._pRttBufferManager.textureRatioY;\n\t\t} else {\n\t\t\tthis.textureRatioX = 1;\n\t\t\tthis.textureRatioY = 1;\n\t\t}\n\n\t\tif (this._pRequireDepthRender)\n\t\t\tthis.pRenderSceneDepthToTexture(<EntityCollector> entityCollector);\n\n\t\tif (this._depthPrepass)\n\t\t\tthis.pRenderDepthPrepass(<EntityCollector> entityCollector);\n\n\t\tif (this._pFilter3DRenderer && this._pContext) { //TODO\n\t\t\t//this._iRender(entityCollector, this._pFilter3DRenderer.getMainInputTexture(this._pStage), this._pRttBufferManager.renderToTextureRect);\n\t\t\t//this._pFilter3DRenderer.render(this._pStage, entityCollector.camera, this._pDepthRender);\n\n\t\t} else {\n\n\t\t\tif (this._shareContext)\n\t\t\t\tthis._iRender(entityCollector, null, this._pScissorRect);\n\t\t\telse\n\t\t\t\tthis._iRender(entityCollector);\n\t\t}\n\n\t\tsuper.render(entityCollector);\n\n\t\tif (!this._shareContext && this._pContext)\n\t\t\tthis._pContext.present();\n\n\t\t// register that a view has been rendered\n\t\tthis._pStage.bufferClear = false;\n\t}\n\n\tpublic pExecuteRender(entityCollector:EntityCollector, target:TextureProxyBase = null, scissorRect:Rectangle = null, surfaceSelector:number = 0)\n\t{\n\t\tthis.updateLights(entityCollector);\n\n\t\tsuper.pExecuteRender(entityCollector, target, scissorRect, surfaceSelector);\n\t}\n\n\tprivate updateLights(entityCollector:EntityCollector)\n\t{\n\t\tvar dirLights:Array<DirectionalLight> = entityCollector.directionalLights;\n\t\tvar pointLights:Array<PointLight> = entityCollector.pointLights;\n\t\tvar len:number, i:number;\n\t\tvar light:LightBase;\n\t\tvar shadowMapper:ShadowMapperBase;\n\n\t\tlen = dirLights.length;\n\t\tfor (i = 0; i < len; ++i) {\n\t\t\tlight = dirLights[i];\n\n\t\t\tshadowMapper = light.shadowMapper;\n\n\t\t\tif (light.castsShadows && (shadowMapper.autoUpdateShadows || shadowMapper._iShadowsInvalid ))\n\t\t\t\tshadowMapper.iRenderDepthMap(entityCollector, this._pDepthRenderer);\n\t\t}\n\n\t\tlen = pointLights.length;\n\t\tfor (i = 0; i < len; ++i) {\n\t\t\tlight = pointLights[i];\n\n\t\t\tshadowMapper = light.shadowMapper;\n\n\t\t\tif (light.castsShadows && (shadowMapper.autoUpdateShadows || shadowMapper._iShadowsInvalid))\n\t\t\t\tshadowMapper.iRenderDepthMap(entityCollector, this._pDistanceRenderer);\n\t\t}\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic pDraw(entityCollector:EntityCollector)\n\t{\n\t\tif (entityCollector.skyBox) {\n\t\t\tthis._pContext.setDepthTest(false, ContextGLCompareMode.ALWAYS);\n\n\t\t\tthis.drawSkybox(entityCollector);\n\t\t}\n\n\t\tsuper.pDraw(entityCollector);\n\t}\n\n\tpublic _pGetRenderObject(renderable:RenderableBase, renderObjectOwner:IRenderObjectOwner):RenderObjectBase\n\t{\n\t\treturn <RenderObjectBase> renderObjectOwner.getRenderObject(renderable._pool);\n\t}\n\n\t/**\n\t * Draw the skybox if present.\n\t *\n\t * @param entityCollector The EntityCollector containing all potentially visible information.\n\t */\n\tprivate drawSkybox(entityCollector:EntityCollector)\n\t{\n\t\tvar skyBox:SkyboxRenderable = <SkyboxRenderable> this._skyboxRenderablePool.getItem(entityCollector.skyBox);\n\n\t\tvar camera:Camera = entityCollector.camera;\n\n\t\tthis.updateSkyboxProjection(camera);\n\n\t\tvar renderObject:RenderObjectBase = skyBox.renderObject = this._pGetRenderObject(skyBox, skyBox.renderObjectOwner);\n\t\tvar pass:RenderPassBase = renderObject.passes[0];\n\n\t\tthis.activatePass(skyBox, pass, camera);\n\t\tskyBox._iRender(pass, camera, this._skyboxProjection);\n\t\tthis.deactivatePass(skyBox, pass);\n\t}\n\n\tprivate updateSkyboxProjection(camera:Camera)\n\t{\n\t\tvar near:Vector3D = new Vector3D();\n\n\t\tthis._skyboxProjection.copyFrom(this._pRttViewProjectionMatrix);\n\t\tthis._skyboxProjection.copyRowTo(2, near);\n\n\t\tvar camPos:Vector3D = camera.scenePosition;\n\n\t\tvar cx:number = near.x;\n\t\tvar cy:number = near.y;\n\t\tvar cz:number = near.z;\n\t\tvar cw:number = -(near.x*camPos.x + near.y*camPos.y + near.z*camPos.z + Math.sqrt(cx*cx + cy*cy + cz*cz));\n\n\t\tvar signX:number = cx >= 0? 1 : -1;\n\t\tvar signY:number = cy >= 0? 1 : -1;\n\n\t\tvar p:Vector3D = new Vector3D(signX, signY, 1, 1);\n\n\t\tvar inverse:Matrix3D = this._skyboxProjection.clone();\n\t\tinverse.invert();\n\n\t\tvar q:Vector3D = inverse.transformVector(p);\n\n\t\tthis._skyboxProjection.copyRowTo(3, p);\n\n\t\tvar a:number = (q.x*p.x + q.y*p.y + q.z*p.z + q.w*p.w)/(cx*q.x + cy*q.y + cz*q.z + cw*q.w);\n\n\t\tthis._skyboxProjection.copyRowFrom(2, new Vector3D(cx*a, cy*a, cz*a, cw*a));\n\t}\n\n\tpublic dispose()\n\t{\n\t\tif (!this._shareContext)\n\t\t\tthis._pStage.dispose();\n\n\t\tthis._skyboxRenderablePool.dispose();\n\t\tthis._skyboxRenderablePool = null;\n\n\t\tthis._pRttBufferManager.dispose();\n\t\tthis._pRttBufferManager = null;\n\n\t\tthis._pDepthRenderer.dispose();\n\t\tthis._pDistanceRenderer.dispose();\n\t\tthis._pDepthRenderer = null;\n\t\tthis._pDistanceRenderer = null;\n\n\t\tthis._pDepthRender = null;\n\n\t\tsuper.dispose();\n\t}\n\n\n\t/**\n\t *\n\t */\n\tpublic pRenderDepthPrepass(entityCollector:EntityCollector)\n\t{\n\t\tthis._pDepthRenderer.disableColor = true;\n\n\t\tif (this._pFilter3DRenderer) { //TODO\n//\t\t\t\tthis._pDepthRenderer.textureRatioX = this._pRttBufferManager.textureRatioX;\n//\t\t\t\tthis._pDepthRenderer.textureRatioY = this._pRttBufferManager.textureRatioY;\n//\t\t\t\tthis._pDepthRenderer._iRender(entityCollector, this._pFilter3DRenderer.getMainInputTexture(this._pStage), this._pRttBufferManager.renderToTextureRect);\n\t\t} else {\n\t\t\tthis._pDepthRenderer.textureRatioX = 1;\n\t\t\tthis._pDepthRenderer.textureRatioY = 1;\n\t\t\tthis._pDepthRenderer._iRender(entityCollector);\n\t\t}\n\n\t\tthis._pDepthRenderer.disableColor = false;\n\t}\n\n\n\t/**\n\t *\n\t */\n\tpublic pRenderSceneDepthToTexture(entityCollector:EntityCollector)\n\t{\n\t\tif (this._pDepthTextureInvalid || !this._pDepthRender)\n\t\t\tthis.initDepthTexture(<IContextGL> this._pStage.context);\n\n\t\tthis._pDepthRenderer.textureRatioX = this._pRttBufferManager.textureRatioX;\n\t\tthis._pDepthRenderer.textureRatioY = this._pRttBufferManager.textureRatioY;\n\t\tthis._pDepthRenderer._iRender(entityCollector, this._pDepthRender);\n\t}\n\n\n\t/**\n\t * Updates the backbuffer dimensions.\n\t */\n\tpublic pUpdateBackBuffer()\n\t{\n\t\t// No reason trying to configure back buffer if there is no context available.\n\t\t// Doing this anyway (and relying on _stage to cache width/height for\n\t\t// context does get available) means usesSoftwareRendering won't be reliable.\n\t\tif (this._pStage.context && !this._shareContext) {\n\t\t\tif (this._width && this._height) {\n\t\t\t\tthis._pStage.configureBackBuffer(this._width, this._height, this._antiAlias, true);\n\t\t\t\tthis._pBackBufferInvalid = false;\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic iSetStage(value:Stage)\n\t{\n\t\tsuper.iSetStage(value);\n\n\t\tif (this._pStage) {\n\t\t\tthis._pRttBufferManager = RTTBufferManager.getInstance(this._pStage);\n\n\t\t\tthis._pDepthRenderer = new DepthRenderer(this._pRendererPoolClass, this._pStage);\n\t\t\tthis._pDistanceRenderer = new DistanceRenderer(this._pRendererPoolClass, this._pStage);\n\n\t\t\tthis._skyboxRenderablePool = RenderablePoolBase.getPool(SkyboxRenderable, this._pStage);\n\t\t}\n\t}\n\n\t/**\n\t *\n\t */\n\tprivate initDepthTexture(context:IContextGL):void\n\t{\n\t\tthis._pDepthTextureInvalid = false;\n\n\t\tif (this._pDepthRender)\n\t\t\tthis._pDepthRender.dispose();\n\n\t\tthis._pDepthRender = new RenderTexture(this._pRttBufferManager.textureWidth, this._pRttBufferManager.textureHeight);\n\t}\n}\n\nexport = DefaultRenderer;","import TextureProxyBase\t\t\t\t= require(\"awayjs-core/lib/textures/TextureProxyBase\");\n\nimport ContextGLBlendFactor\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLBlendFactor\");\nimport ContextGLCompareMode\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLCompareMode\");\nimport Stage\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\n\nimport IRenderObjectOwner\t\t\t= require(\"awayjs-display/lib/base/IRenderObjectOwner\");\nimport MaterialBase\t\t\t\t\t= require(\"awayjs-display/lib/materials/MaterialBase\");\nimport EntityCollector\t\t\t\t= require(\"awayjs-display/lib/traverse/EntityCollector\");\n\nimport RendererBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/base/RendererBase\");\nimport RenderObjectBase\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/RenderObjectBase\");\nimport RenderObjectPool\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/RenderObjectPool\");\nimport RenderableBase\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\nimport IRendererPoolClass\t\t\t= require(\"awayjs-renderergl/lib/pool/IRendererPoolClass\");\n\n\n/**\n * The DepthRenderer class renders 32-bit depth information encoded as RGBA\n *\n * @class away.render.DepthRenderer\n */\nclass DepthRenderer extends RendererBase\n{\n\t/**\n\t * Creates a new DepthRenderer object.\n\t * @param renderBlended Indicates whether semi-transparent objects should be rendered.\n\t * @param distanceBased Indicates whether the written depth value is distance-based or projected depth-based\n\t */\n\tconstructor(rendererPoolClass:IRendererPoolClass = null, stage:Stage = null)\n\t{\n\t\tsuper(rendererPoolClass, stage);\n\n\t\tthis._iBackgroundR = 1;\n\t\tthis._iBackgroundG = 1;\n\t\tthis._iBackgroundB = 1;\n\n\t}\n\n\tpublic _pGetRenderObject(renderable:RenderableBase, renderObjectOwner:IRenderObjectOwner):RenderObjectBase\n\t{\n\t\treturn renderable._pool.getDepthRenderObject(renderObjectOwner);\n\t}\n}\n\nexport = DepthRenderer;","import TextureProxyBase\t\t\t\t= require(\"awayjs-core/lib/textures/TextureProxyBase\");\n\nimport ContextGLBlendFactor\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLBlendFactor\");\nimport ContextGLCompareMode\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLCompareMode\");\nimport Stage\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\n\nimport IRenderObjectOwner\t\t\t= require(\"awayjs-display/lib/base/IRenderObjectOwner\");\nimport MaterialBase\t\t\t\t\t= require(\"awayjs-display/lib/materials/MaterialBase\");\nimport EntityCollector\t\t\t\t= require(\"awayjs-display/lib/traverse/EntityCollector\");\n\nimport RendererBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/base/RendererBase\");\nimport RenderObjectBase\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/RenderObjectBase\");\nimport RenderObjectPool\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/RenderObjectPool\");\nimport RenderableBase\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\nimport IRendererPoolClass\t\t\t= require(\"awayjs-renderergl/lib/pool/IRendererPoolClass\");\n\n\n/**\n * The DistanceRenderer class renders 32-bit depth information encoded as RGBA\n *\n * @class away.render.DistanceRenderer\n */\nclass DistanceRenderer extends RendererBase\n{\n\t/**\n\t * Creates a new DistanceRenderer object.\n\t * @param renderBlended Indicates whether semi-transparent objects should be rendered.\n\t * @param distanceBased Indicates whether the written depth value is distance-based or projected depth-based\n\t */\n\tconstructor(rendererPoolClass:IRendererPoolClass = null, stage:Stage = null)\n\t{\n\t\tsuper(rendererPoolClass, stage);\n\n\t\tthis._iBackgroundR = 1;\n\t\tthis._iBackgroundG = 1;\n\t\tthis._iBackgroundB = 1;\n\n\t}\n\n\tpublic _pGetRenderObject(renderable:RenderableBase, renderObjectOwner:IRenderObjectOwner):RenderObjectBase\n\t{\n\t\treturn renderable._pool.getDistanceRenderObject(renderObjectOwner);\n\t}\n}\n\nexport = DistanceRenderer;","import Event\t\t\t\t\t\t= require(\"awayjs-core/lib/events/Event\");\n\nimport Camera\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\n\nimport Stage\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\nimport ContextGLBlendFactor\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLBlendFactor\");\nimport ContextGLVertexBufferFormat\t= require(\"awayjs-stagegl/lib/base/ContextGLVertexBufferFormat\");\nimport IContextGL\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/IContextGL\");\nimport IIndexBuffer\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/IIndexBuffer\");\nimport ITexture\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/ITexture\");\nimport IVertexBuffer\t\t\t\t= require(\"awayjs-stagegl/lib/base/IVertexBuffer\");\n\nimport RTTBufferManager\t\t\t\t= require(\"awayjs-renderergl/lib/managers/RTTBufferManager\");\nimport Filter3DBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/filters/Filter3DBase\");\nimport Filter3DTaskBase\t\t\t\t= require(\"awayjs-renderergl/lib/filters/tasks/Filter3DTaskBase\");\n\n/**\n * @class away.render.Filter3DRenderer\n */\nclass Filter3DRenderer\n{\n\tprivate _filters:Array<Filter3DBase>;\n\tprivate _tasks:Array<Filter3DTaskBase>;\n\tprivate _filterTasksInvalid:boolean;\n\tprivate _mainInputTexture:ITexture;\n\tprivate _requireDepthRender:boolean;\n\tprivate _rttManager:RTTBufferManager;\n\tprivate _stage:Stage;\n\tprivate _filterSizesInvalid:boolean = true;\n\tprivate _onRTTResizeDelegate:(event:Event) => void;\n\n\tconstructor(stage:Stage)\n\t{\n\t\tthis._onRTTResizeDelegate = (event:Event) => this.onRTTResize(event);\n\n\t\tthis._stage = stage;\n\t\tthis._rttManager = RTTBufferManager.getInstance(stage);\n\t\tthis._rttManager.addEventListener(Event.RESIZE, this._onRTTResizeDelegate);\n\n\t}\n\n\tprivate onRTTResize(event:Event)\n\t{\n\t\tthis._filterSizesInvalid = true;\n\t}\n\n\tpublic get requireDepthRender():boolean\n\t{\n\t\treturn this._requireDepthRender;\n\t}\n\n\tpublic getMainInputTexture(stage:Stage):ITexture\n\t{\n\t\tif (this._filterTasksInvalid) {\n\n\t\t\tthis.updateFilterTasks(stage);\n\n\t\t}\n\n\t\treturn this._mainInputTexture;\n\t}\n\n\tpublic get filters():Filter3DBase[]\n\t{\n\t\treturn this._filters;\n\t}\n\n\tpublic set filters(value:Filter3DBase[])\n\t{\n\t\tthis._filters = value;\n\n\t\tthis._filterTasksInvalid = true;\n\n\t\tthis._requireDepthRender = false;\n\n\t\tif (!this._filters) {\n\n\t\t\treturn;\n\n\t\t}\n\n\t\tfor (var i:number = 0; i < this._filters.length; ++i) {\n\n\t\t\t// TODO: check logic:\n\t\t\t// this._requireDepthRender ||=  Boolean ( this._filters[i].requireDepthRender )\n\n\t\t\tvar s:any = this._filters[i];\n\t\t\tvar b:boolean = <boolean> ( s.requireDepthRender == null )? false : s.requireDepthRender;\n\n\t\t\tthis._requireDepthRender = this._requireDepthRender || b;\n\n\t\t}\n\n\t\tthis._filterSizesInvalid = true;\n\n\t}\n\n\tprivate updateFilterTasks(stage:Stage)\n\t{\n\t\tvar len:number;\n\n\t\tif (this._filterSizesInvalid) {\n\n\t\t\tthis.updateFilterSizes();\n\n\t\t}\n\n\t\tif (!this._filters) {\n\t\t\tthis._tasks = null;\n\t\t\treturn;\n\t\t}\n\n\t\tthis._tasks = new Array<Filter3DTaskBase>();\n\n\t\tlen = this._filters.length - 1;\n\n\t\tvar filter:Filter3DBase;\n\n\t\tfor (var i:number = 0; i <= len; ++i) {\n\n\t\t\t// make sure all internal tasks are linked together\n\t\t\tfilter = this._filters[i];\n\n\t\t\t// TODO: check logic\n\t\t\t// filter.setRenderTargets(i == len? null : Filter3DBase(_filters[i + 1]).getMainInputTexture(stage), stage);\n\n\t\t\tfilter.setRenderTargets(i == len? null : this._filters[i + 1].getMainInputTexture(stage), stage);\n\n\t\t\tthis._tasks = this._tasks.concat(filter.tasks);\n\n\t\t}\n\n\t\tthis._mainInputTexture = this._filters[0].getMainInputTexture(stage);\n\n\t}\n\n\tpublic render(stage:Stage, camera:Camera, depthTexture:ITexture)\n\t{\n\t\tvar len:number;\n\t\tvar i:number;\n\t\tvar task:Filter3DTaskBase;\n\t\tvar context:IContextGL = <IContextGL> stage.context;\n\n\t\tvar indexBuffer:IIndexBuffer = this._rttManager.indexBuffer;\n\n\t\tvar vertexBuffer:IVertexBuffer = this._rttManager.renderToTextureVertexBuffer;\n\n\t\tif (!this._filters) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (this._filterSizesInvalid) {\n\t\t\tthis.updateFilterSizes();\n\t\t}\n\n\t\tif (this._filterTasksInvalid) {\n\t\t\tthis.updateFilterTasks(stage);\n\t\t}\n\n\t\tlen = this._filters.length;\n\n\t\tfor (i = 0; i < len; ++i) {\n\t\t\tthis._filters[i].update(stage, camera);\n\t\t}\n\n\t\tlen = this._tasks.length;\n\n\t\tif (len > 1) {\n\t\t\tcontext.setVertexBufferAt(0, vertexBuffer, 0, ContextGLVertexBufferFormat.FLOAT_2);\n\t\t\tcontext.setVertexBufferAt(1, vertexBuffer, 2, ContextGLVertexBufferFormat.FLOAT_2);\n\t\t}\n\n\t\tfor (i = 0; i < len; ++i) {\n\n\t\t\ttask = this._tasks[i];\n\n\t\t\t//stage.setRenderTarget(task.target); //TODO\n\n\t\t\tif (!task.target) {\n\n\t\t\t\tstage.scissorRect = null;\n\t\t\t\tvertexBuffer = this._rttManager.renderToScreenVertexBuffer;\n\t\t\t\tcontext.setVertexBufferAt(0, vertexBuffer, 0, ContextGLVertexBufferFormat.FLOAT_2);\n\t\t\t\tcontext.setVertexBufferAt(1, vertexBuffer, 2, ContextGLVertexBufferFormat.FLOAT_2);\n\n\t\t\t}\n\n\t\t\tcontext.setTextureAt(0, task.getMainInputTexture(stage));\n\t\t\tcontext.setProgram(task.getProgram(stage));\n\t\t\tcontext.clear(0.0, 0.0, 0.0, 0.0);\n\n\t\t\ttask.activate(stage, camera, depthTexture);\n\n\t\t\tcontext.setBlendFactors(ContextGLBlendFactor.ONE, ContextGLBlendFactor.ZERO);\n\t\t\tcontext.drawTriangles(indexBuffer, 0, 2);\n\n\t\t\ttask.deactivate(stage);\n\t\t}\n\n\t\tcontext.setTextureAt(0, null);\n\t\tcontext.setVertexBufferAt(0, null);\n\t\tcontext.setVertexBufferAt(1, null);\n\t}\n\n\tprivate updateFilterSizes()\n\t{\n\t\tfor (var i:number = 0; i < this._filters.length; ++i) {\n\t\t\tthis._filters[i].textureWidth = this._rttManager.textureWidth;\n\t\t\tthis._filters[i].textureHeight = this._rttManager.textureHeight;\n\t\t}\n\n\t\tthis._filterSizesInvalid = true;\n\n\t}\n\n\tpublic dispose()\n\t{\n\t\tthis._rttManager.removeEventListener(Event.RESIZE, this._onRTTResizeDelegate);\n\t\tthis._rttManager = null;\n\t\tthis._stage = null;\n\t}\n}\n\nexport = Filter3DRenderer;","import AssetType\t\t\t\t\t= require(\"awayjs-core/lib/library/AssetType\");\nimport IAsset\t\t\t\t\t\t= require(\"awayjs-core/lib/library/IAsset\");\nimport NamedAssetBase\t\t\t\t= require(\"awayjs-core/lib/library/NamedAssetBase\");\nimport AbstractMethodError\t\t\t= require(\"awayjs-core/lib/errors/AbstractMethodError\");\n\nimport AnimationNodeBase\t\t\t= require(\"awayjs-display/lib/animators/nodes/AnimationNodeBase\");\n\nimport Stage\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\n\nimport AnimationSetError\t\t\t= require(\"awayjs-renderergl/lib/errors/AnimationSetError\");\nimport ShaderObjectBase\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport ShaderRegisterElement\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\n\n/**\n * Provides an abstract base class for data set classes that hold animation data for use in animator classes.\n *\n * @see away.animators.AnimatorBase\n */\nclass AnimationSetBase extends NamedAssetBase implements IAsset\n{\n\tprivate _usesCPU:boolean;\n\tprivate _animations:Array<AnimationNodeBase> = new Array<AnimationNodeBase>();\n\tprivate _animationNames:Array<string> = new Array<string>();\n\tprivate _animationDictionary:Object = new Object();\n\n\tconstructor()\n\t{\n\t\tsuper();\n\t}\n\n\t/**\n\t * Retrieves a temporary GPU register that's still free.\n\t *\n\t * @param exclude An array of non-free temporary registers.\n\t * @param excludeAnother An additional register that's not free.\n\t * @return A temporary register that can be used.\n\t */\n\tpublic _pFindTempReg(exclude:Array<string>, excludeAnother:string = null):string\n\t{\n\t\tvar i:number /*uint*/ = 0;\n\t\tvar reg:string;\n\n\t\twhile (true) {\n\t\t\treg = \"vt\" + i;\n\t\t\tif (exclude.indexOf(reg) == -1 && excludeAnother != reg)\n\t\t\t\treturn reg;\n\t\t\t++i;\n\t\t}\n\n\t\t// can't be reached\n\t\treturn null;\n\t}\n\n\t/**\n\t * Indicates whether the properties of the animation data contained within the set combined with\n\t * the vertex registers already in use on shading materials allows the animation data to utilise\n\t * GPU calls.\n\t */\n\tpublic get usesCPU():boolean\n\t{\n\t\treturn this._usesCPU;\n\t}\n\n\t/**\n\t * Called by the material to reset the GPU indicator before testing whether register space in the shader\n\t * is available for running GPU-based animation code.\n\t *\n\t * @private\n\t */\n\tpublic resetGPUCompatibility()\n\t{\n\t\tthis._usesCPU = false;\n\t}\n\n\tpublic cancelGPUCompatibility()\n\t{\n\t\tthis._usesCPU = true;\n\t}\n\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAGALVertexCode(shaderObject:ShaderObjectBase):string\n\t{\n\t\tthrow new AbstractMethodError();\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic activate(shaderObject:ShaderObjectBase, stage:Stage)\n\t{\n\t\tthrow new AbstractMethodError();\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic deactivate(shaderObject:ShaderObjectBase, stage:Stage)\n\t{\n\t\tthrow new AbstractMethodError();\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAGALFragmentCode(shaderObject:ShaderObjectBase, shadedTarget:string):string\n\t{\n\t\tthrow new AbstractMethodError();\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAGALUVCode(shaderObject:ShaderObjectBase):string\n\t{\n\t\tthrow new AbstractMethodError();\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic doneAGALCode(shaderObject:ShaderObjectBase)\n\t{\n\t\tthrow new AbstractMethodError();\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic get assetType():string\n\t{\n\t\treturn AssetType.ANIMATION_SET;\n\t}\n\n\t/**\n\t * Returns a vector of animation state objects that make up the contents of the animation data set.\n\t */\n\tpublic get animations():Array<AnimationNodeBase>\n\t{\n\t\treturn this._animations;\n\t}\n\n\t/**\n\t * Returns a vector of animation state objects that make up the contents of the animation data set.\n\t */\n\tpublic get animationNames():Array<string>\n\t{\n\t\treturn this._animationNames;\n\t}\n\n\t/**\n\t * Check to determine whether a state is registered in the animation set under the given name.\n\t *\n\t * @param stateName The name of the animation state object to be checked.\n\t */\n\tpublic hasAnimation(name:string):boolean\n\t{\n\t\treturn this._animationDictionary[name] != null;\n\t}\n\n\t/**\n\t * Retrieves the animation state object registered in the animation data set under the given name.\n\t *\n\t * @param stateName The name of the animation state object to be retrieved.\n\t */\n\tpublic getAnimation(name:string):AnimationNodeBase\n\t{\n\t\treturn this._animationDictionary[name];\n\t}\n\n\t/**\n\t * Adds an animation state object to the aniamtion data set under the given name.\n\t *\n\t * @param stateName The name under which the animation state object will be stored.\n\t * @param animationState The animation state object to be staored in the set.\n\t */\n\tpublic addAnimation(node:AnimationNodeBase)\n\t{\n\t\tif (this._animationDictionary[node.name])\n\t\t\tthrow new AnimationSetError(\"root node name '\" + node.name + \"' already exists in the set\");\n\n\t\tthis._animationDictionary[node.name] = node;\n\n\t\tthis._animations.push(node);\n\n\t\tthis._animationNames.push(node.name);\n\t}\n\n\t/**\n\t * Cleans up any resources used by the current object.\n\t */\n\tpublic dispose()\n\t{\n\t}\n}\n\nexport = AnimationSetBase;","import Vector3D\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\nimport AssetType\t\t\t\t\t= require(\"awayjs-core/lib/library/AssetType\");\nimport NamedAssetBase\t\t\t\t= require(\"awayjs-core/lib/library/NamedAssetBase\");\nimport AbstractMethodError\t\t\t= require(\"awayjs-core/lib/errors/AbstractMethodError\");\nimport RequestAnimationFrame\t\t= require(\"awayjs-core/lib/utils/RequestAnimationFrame\");\nimport getTimer\t\t\t\t\t\t= require(\"awayjs-core/lib/utils/getTimer\");\n\nimport IAnimationSet\t\t\t\t= require(\"awayjs-display/lib/animators/IAnimationSet\");\nimport IAnimator\t\t\t\t\t= require(\"awayjs-display/lib/animators/IAnimator\");\nimport AnimationNodeBase\t\t\t= require(\"awayjs-display/lib/animators/nodes/AnimationNodeBase\");\nimport TriangleSubGeometry\t\t\t= require(\"awayjs-display/lib/base/TriangleSubGeometry\");\nimport Camera\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\nimport Mesh\t\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Mesh\");\n\nimport Stage\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\n\nimport IAnimationState\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/IAnimationState\");\nimport RenderableBase\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\nimport TriangleSubMeshRenderable\t= require(\"awayjs-renderergl/lib/pool/TriangleSubMeshRenderable\");\nimport AnimatorEvent\t\t\t\t= require(\"awayjs-renderergl/lib/events/AnimatorEvent\");\nimport ShaderObjectBase\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\n\n/**\n * Dispatched when playback of an animation inside the animator object starts.\n *\n * @eventType away3d.events.AnimatorEvent\n */\n//[Event(name=\"start\", type=\"away3d.events.AnimatorEvent\")]\n\n/**\n * Dispatched when playback of an animation inside the animator object stops.\n *\n * @eventType away3d.events.AnimatorEvent\n */\n//[Event(name=\"stop\", type=\"away3d.events.AnimatorEvent\")]\n\n/**\n * Dispatched when playback of an animation reaches the end of an animation.\n *\n * @eventType away3d.events.AnimatorEvent\n */\n//[Event(name=\"cycle_complete\", type=\"away3d.events.AnimatorEvent\")]\n\n/**\n * Provides an abstract base class for animator classes that control animation output from a data set subtype of <code>AnimationSetBase</code>.\n *\n * @see away.animators.AnimationSetBase\n */\nclass AnimatorBase extends NamedAssetBase implements IAnimator\n{\n\tprivate _broadcaster:RequestAnimationFrame;\n\tprivate _isPlaying:boolean;\n\tprivate _autoUpdate:boolean = true;\n\tprivate _startEvent:AnimatorEvent;\n\tprivate _stopEvent:AnimatorEvent;\n\tprivate _cycleEvent:AnimatorEvent;\n\tprivate _time:number /*int*/ = 0;\n\tprivate _playbackSpeed:number = 1;\n\n\tpublic _pAnimationSet:IAnimationSet;\n\tpublic _pOwners:Array<Mesh> = new Array<Mesh>();\n\tpublic _pActiveNode:AnimationNodeBase;\n\tpublic _pActiveState:IAnimationState;\n\tpublic _pActiveAnimationName:string;\n\tpublic _pAbsoluteTime:number = 0;\n\n\tprivate _animationStates:Object = new Object();\n\n\t/**\n\t * Enables translation of the animated mesh from data returned per frame via the positionDelta property of the active animation node. Defaults to true.\n\t *\n\t * @see away.animators.IAnimationState#positionDelta\n\t */\n\tpublic updatePosition:boolean = true;\n\n\tpublic getAnimationState(node:AnimationNodeBase):IAnimationState\n\t{\n\t\tvar className:any = node.stateClass;\n\t\tvar uID:number = node.id;\n\n\t\tif (this._animationStates[uID] == null)\n\t\t\tthis._animationStates[uID] = new className(this, node);\n\n\t\treturn this._animationStates[uID];\n\t}\n\n\tpublic getAnimationStateByName(name:string):IAnimationState\n\t{\n\t\treturn this.getAnimationState(this._pAnimationSet.getAnimation(name));\n\t}\n\n\t/**\n\t * Returns the internal absolute time of the animator, calculated by the current time and the playback speed.\n\t *\n\t * @see #time\n\t * @see #playbackSpeed\n\t */\n\tpublic get absoluteTime():number\n\t{\n\t\treturn this._pAbsoluteTime;\n\t}\n\n\t/**\n\t * Returns the animation data set in use by the animator.\n\t */\n\tpublic get animationSet():IAnimationSet\n\t{\n\t\treturn this._pAnimationSet;\n\t}\n\n\t/**\n\t * Returns the current active animation state.\n\t */\n\tpublic get activeState():IAnimationState\n\t{\n\t\treturn this._pActiveState;\n\t}\n\n\t/**\n\t * Returns the current active animation node.\n\t */\n\tpublic get activeAnimation():AnimationNodeBase\n\t{\n\t\treturn this._pAnimationSet.getAnimation(this._pActiveAnimationName);\n\t}\n\n\t/**\n\t * Returns the current active animation node.\n\t */\n\tpublic get activeAnimationName():string\n\t{\n\t\treturn this._pActiveAnimationName;\n\t}\n\n\t/**\n\t * Determines whether the animators internal update mechanisms are active. Used in cases\n\t * where manual updates are required either via the <code>time</code> property or <code>update()</code> method.\n\t * Defaults to true.\n\t *\n\t * @see #time\n\t * @see #update()\n\t */\n\tpublic get autoUpdate():boolean\n\t{\n\t\treturn this._autoUpdate;\n\t}\n\n\tpublic set autoUpdate(value:boolean)\n\t{\n\t\tif (this._autoUpdate == value)\n\t\t\treturn;\n\n\t\tthis._autoUpdate = value;\n\n\t\tif (this._autoUpdate)\n\t\t\tthis.start(); else\n\t\t\tthis.stop();\n\t}\n\n\t/**\n\t * Gets and sets the internal time clock of the animator.\n\t */\n\tpublic get time():number /*int*/\n\t{\n\t\treturn this._time;\n\t}\n\n\tpublic set time(value:number /*int*/)\n\t{\n\t\tif (this._time == value)\n\t\t\treturn;\n\n\t\tthis.update(value);\n\t}\n\n\t/**\n\t * Sets the animation phase of the current active state's animation clip(s).\n\t *\n\t * @param value The phase value to use. 0 represents the beginning of an animation clip, 1 represents the end.\n\t */\n\tpublic phase(value:number)\n\t{\n\t\tthis._pActiveState.phase(value);\n\t}\n\n\t/**\n\t * Creates a new <code>AnimatorBase</code> object.\n\t *\n\t * @param animationSet The animation data set to be used by the animator object.\n\t */\n\tconstructor(animationSet:IAnimationSet)\n\t{\n\t\tsuper();\n\n\t\tthis._pAnimationSet = animationSet;\n\n\t\tthis._broadcaster = new RequestAnimationFrame(this.onEnterFrame, this);\n\t}\n\n\t/**\n\t * The amount by which passed time should be scaled. Used to slow down or speed up animations. Defaults to 1.\n\t */\n\tpublic get playbackSpeed():number\n\t{\n\t\treturn this._playbackSpeed;\n\t}\n\n\tpublic set playbackSpeed(value:number)\n\t{\n\t\tthis._playbackSpeed = value;\n\t}\n\n\tpublic setRenderState(shaderObject:ShaderObjectBase, renderable:RenderableBase, stage:Stage, camera:Camera, vertexConstantOffset:number /*int*/, vertexStreamOffset:number /*int*/)\n\t{\n\t\tthrow new AbstractMethodError();\n\t}\n\n\t/**\n\t * Resumes the automatic playback clock controling the active state of the animator.\n\t */\n\tpublic start()\n\t{\n\t\tif (this._isPlaying || !this._autoUpdate)\n\t\t\treturn;\n\n\t\tthis._time = this._pAbsoluteTime = getTimer();\n\n\t\tthis._isPlaying = true;\n\n\t\tthis._broadcaster.start();\n\n\t\tif (!this.hasEventListener(AnimatorEvent.START))\n\t\t\treturn;\n\n\t\tif (this._startEvent == null)\n\t\t\tthis._startEvent = new AnimatorEvent(AnimatorEvent.START, this);\n\n\t\tthis.dispatchEvent(this._startEvent);\n\t}\n\n\t/**\n\t * Pauses the automatic playback clock of the animator, in case manual updates are required via the\n\t * <code>time</code> property or <code>update()</code> method.\n\t *\n\t * @see #time\n\t * @see #update()\n\t */\n\tpublic stop()\n\t{\n\t\tif (!this._isPlaying)\n\t\t\treturn;\n\n\t\tthis._isPlaying = false;\n\n\t\tthis._broadcaster.stop();\n\n\t\tif (!this.hasEventListener(AnimatorEvent.STOP))\n\t\t\treturn;\n\n\t\tif (this._stopEvent == null)\n\t\t\tthis._stopEvent = new AnimatorEvent(AnimatorEvent.STOP, this);\n\n\t\tthis.dispatchEvent(this._stopEvent);\n\t}\n\n\t/**\n\t * Provides a way to manually update the active state of the animator when automatic\n\t * updates are disabled.\n\t *\n\t * @see #stop()\n\t * @see #autoUpdate\n\t */\n\tpublic update(time:number /*int*/)\n\t{\n\t\tvar dt:number = (time - this._time)*this.playbackSpeed;\n\n\t\tthis._pUpdateDeltaTime(dt);\n\n\t\tthis._time = time;\n\t}\n\n\tpublic reset(name:string, offset:number = 0)\n\t{\n\t\tthis.getAnimationState(this._pAnimationSet.getAnimation(name)).offset(offset + this._pAbsoluteTime);\n\t}\n\n\t/**\n\t * Used by the mesh object to which the animator is applied, registers the owner for internal use.\n\t *\n\t * @private\n\t */\n\tpublic addOwner(mesh:Mesh)\n\t{\n\t\tthis._pOwners.push(mesh);\n\t}\n\n\t/**\n\t * Used by the mesh object from which the animator is removed, unregisters the owner for internal use.\n\t *\n\t * @private\n\t */\n\tpublic removeOwner(mesh:Mesh)\n\t{\n\t\tthis._pOwners.splice(this._pOwners.indexOf(mesh), 1);\n\t}\n\n\t/**\n\t * Internal abstract method called when the time delta property of the animator's contents requires updating.\n\t *\n\t * @private\n\t */\n\tpublic _pUpdateDeltaTime(dt:number)\n\t{\n\t\tthis._pAbsoluteTime += dt;\n\n\t\tthis._pActiveState.update(this._pAbsoluteTime);\n\n\t\tif (this.updatePosition)\n\t\t\tthis.applyPositionDelta();\n\t}\n\n\t/**\n\t * Enter frame event handler for automatically updating the active state of the animator.\n\t */\n\tprivate onEnterFrame(event:Event = null)\n\t{\n\t\tthis.update(getTimer());\n\t}\n\n\tprivate applyPositionDelta()\n\t{\n\t\tvar delta:Vector3D = this._pActiveState.positionDelta;\n\t\tvar dist:number = delta.length;\n\t\tvar len:number /*uint*/;\n\t\tif (dist > 0) {\n\t\t\tlen = this._pOwners.length;\n\t\t\tfor (var i:number /*uint*/ = 0; i < len; ++i)\n\t\t\t\tthis._pOwners[i].translateLocal(delta, dist);\n\t\t}\n\t}\n\n\t/**\n\t *  for internal use.\n\t *\n\t * @private\n\t */\n\tpublic dispatchCycleEvent()\n\t{\n\t\tif (this.hasEventListener(AnimatorEvent.CYCLE_COMPLETE)) {\n\t\t\tif (this._cycleEvent == null)\n\t\t\t\tthis._cycleEvent = new AnimatorEvent(AnimatorEvent.CYCLE_COMPLETE, this);\n\n\t\t\tthis.dispatchEvent(this._cycleEvent);\n\t\t}\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic clone():AnimatorBase\n\t{\n\t\tthrow new AbstractMethodError();\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic dispose()\n\t{\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic testGPUCompatibility(shaderObject:ShaderObjectBase)\n\t{\n\t\tthrow new AbstractMethodError();\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic get assetType():string\n\t{\n\t\treturn AssetType.ANIMATOR;\n\t}\n\n\n\tpublic getRenderableSubGeometry(renderable:TriangleSubMeshRenderable, sourceSubGeometry:TriangleSubGeometry):TriangleSubGeometry\n\t{\n\t\t//nothing to do here\n\t\treturn sourceSubGeometry;\n\t}\n}\n\nexport = AnimatorBase;","import IAnimationSet\t\t\t\t\t= require(\"awayjs-display/lib/animators/IAnimationSet\");\nimport AnimationNodeBase\t\t\t\t= require(\"awayjs-display/lib/animators/nodes/AnimationNodeBase\");\nimport ISubMesh\t\t\t\t\t\t\t= require(\"awayjs-display/lib/base/ISubMesh\");\nimport SubGeometryBase\t\t\t\t\t= require(\"awayjs-display/lib/base/SubGeometryBase\");\nimport Mesh\t\t\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Mesh\");\n\nimport Stage\t\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\n\nimport AnimationSetBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimationSetBase\");\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport AnimationSubGeometry\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationSubGeometry\");\nimport ParticleAnimationData\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticleAnimationData\");\nimport ParticleProperties\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticleProperties\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticleData\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticleData\");\nimport ParticleNodeBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleNodeBase\");\nimport ParticleTimeNode\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleTimeNode\");\nimport ParticleGeometry\t\t\t\t\t= require(\"awayjs-renderergl/lib/base/ParticleGeometry\");\nimport ShaderObjectBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\n\n\n/**\n * The animation data set used by particle-based animators, containing particle animation data.\n *\n * @see away.animators.ParticleAnimator\n */\nclass ParticleAnimationSet extends AnimationSetBase implements IAnimationSet\n{\n\t/** @private */\n\tpublic _iAnimationRegisterCache:AnimationRegisterCache;\n\n\t//all other nodes dependent on it\n\tprivate _timeNode:ParticleTimeNode;\n\n\t/**\n\t * Property used by particle nodes that require compilation at the end of the shader\n\t */\n\tpublic static POST_PRIORITY:number /*int*/ = 9;\n\n\t/**\n\t * Property used by particle nodes that require color compilation\n\t */\n\tpublic static COLOR_PRIORITY:number /*int*/ = 18;\n\n\tprivate _animationSubGeometries:Object = new Object();\n\tprivate _particleNodes:Array<ParticleNodeBase> = new Array<ParticleNodeBase>();\n\tprivate _localDynamicNodes:Array<ParticleNodeBase> = new Array<ParticleNodeBase>();\n\tprivate _localStaticNodes:Array<ParticleNodeBase> = new Array<ParticleNodeBase>();\n\tprivate _totalLenOfOneVertex:number /*int*/ = 0;\n\n\t//set true if has an node which will change UV\n\tpublic hasUVNode:boolean;\n\t//set if the other nodes need to access the velocity\n\tpublic needVelocity:boolean;\n\t//set if has a billboard node.\n\tpublic hasBillboard:boolean;\n\t//set if has an node which will apply color multiple operation\n\tpublic hasColorMulNode:boolean;\n\t//set if has an node which will apply color add operation\n\tpublic hasColorAddNode:boolean;\n\n\t/**\n\t * Initialiser function for static particle properties. Needs to reference a with the following format\n\t *\n\t * <code>\n\t * initParticleFunc(prop:ParticleProperties)\n\t * {\n\t * \t\t//code for settings local properties\n\t * }\n\t * </code>\n\t *\n\t * Aside from setting any properties required in particle animation nodes using local static properties, the initParticleFunc function\n\t * is required to time node requirements as they may be needed. These properties on the ParticleProperties object can include\n\t * <code>startTime</code>, <code>duration</code> and <code>delay</code>. The use of these properties is determined by the setting\n\t * arguments passed in the constructor of the particle animation set. By default, only the <code>startTime</code> property is required.\n\t */\n\tpublic initParticleFunc:Function;\n\n\t/**\n\t * Initialiser function scope for static particle properties\n\t */\n\tpublic initParticleScope:Object;\n\n\t/**\n\t * Creates a new <code>ParticleAnimationSet</code>\n\t *\n\t * @param    [optional] usesDuration    Defines whether the animation set uses the <code>duration</code> data in its static properties to determine how long a particle is visible for. Defaults to false.\n\t * @param    [optional] usesLooping     Defines whether the animation set uses a looping timeframe for each particle determined by the <code>startTime</code>, <code>duration</code> and <code>delay</code> data in its static properties function. Defaults to false. Requires <code>usesDuration</code> to be true.\n\t * @param    [optional] usesDelay       Defines whether the animation set uses the <code>delay</code> data in its static properties to determine how long a particle is hidden for. Defaults to false. Requires <code>usesLooping</code> to be true.\n\t */\n\tconstructor(usesDuration:boolean = false, usesLooping:boolean = false, usesDelay:boolean = false)\n\t{\n\t\tsuper();\n\n\t\t//automatically add a particle time node to the set\n\t\tthis.addAnimation(this._timeNode = new ParticleTimeNode(usesDuration, usesLooping, usesDelay));\n\t}\n\n\t/**\n\t * Returns a vector of the particle animation nodes contained within the set.\n\t */\n\tpublic get particleNodes():Array<ParticleNodeBase>\n\t{\n\t\treturn this._particleNodes;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic addAnimation(node:AnimationNodeBase)\n\t{\n\t\tvar i:number /*int*/;\n\t\tvar n:ParticleNodeBase = <ParticleNodeBase> node;\n\t\tn._iProcessAnimationSetting(this);\n\t\tif (n.mode == ParticlePropertiesMode.LOCAL_STATIC) {\n\t\t\tn._iDataOffset = this._totalLenOfOneVertex;\n\t\t\tthis._totalLenOfOneVertex += n.dataLength;\n\t\t\tthis._localStaticNodes.push(n);\n\t\t} else if (n.mode == ParticlePropertiesMode.LOCAL_DYNAMIC)\n\t\t\tthis._localDynamicNodes.push(n);\n\n\t\tfor (i = this._particleNodes.length - 1; i >= 0; i--) {\n\t\t\tif (this._particleNodes[i].priority <= n.priority)\n\t\t\t\tbreak;\n\t\t}\n\n\t\tthis._particleNodes.splice(i + 1, 0, n);\n\n\t\tsuper.addAnimation(node);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic activate(shaderObject:ShaderObjectBase, stage:Stage)\n\t{\n//\t\t\tthis._iAnimationRegisterCache = pass.animationRegisterCache;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic deactivate(shaderObject:ShaderObjectBase, stage:Stage)\n\t{\n//\t\t\tvar context:IContextGL = <IContextGL> stage.context;\n//\t\t\tvar offset:number /*int*/ = this._iAnimationRegisterCache.vertexAttributesOffset;\n//\t\t\tvar used:number /*int*/ = this._iAnimationRegisterCache.numUsedStreams;\n//\t\t\tfor (var i:number /*int*/ = offset; i < used; i++)\n//\t\t\t\tcontext.setVertexBufferAt(i, null);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAGALVertexCode(shaderObject:ShaderObjectBase):string\n\t{\n\t\t//grab animationRegisterCache from the materialpassbase or create a new one if the first time\n\t\tthis._iAnimationRegisterCache = shaderObject.animationRegisterCache;\n\n\t\tif (this._iAnimationRegisterCache == null)\n\t\t\tthis._iAnimationRegisterCache = shaderObject.animationRegisterCache = new AnimationRegisterCache(shaderObject.profile);\n\n\t\t//reset animationRegisterCache\n\t\tthis._iAnimationRegisterCache.vertexConstantOffset = shaderObject.numUsedVertexConstants;\n\t\tthis._iAnimationRegisterCache.vertexAttributesOffset = shaderObject.numUsedStreams;\n\t\tthis._iAnimationRegisterCache.varyingsOffset = shaderObject.numUsedVaryings;\n\t\tthis._iAnimationRegisterCache.fragmentConstantOffset = shaderObject.numUsedFragmentConstants;\n\t\tthis._iAnimationRegisterCache.hasUVNode = this.hasUVNode;\n\t\tthis._iAnimationRegisterCache.needVelocity = this.needVelocity;\n\t\tthis._iAnimationRegisterCache.hasBillboard = this.hasBillboard;\n\t\tthis._iAnimationRegisterCache.sourceRegisters = shaderObject.animatableAttributes;\n\t\tthis._iAnimationRegisterCache.targetRegisters = shaderObject.animationTargetRegisters;\n\t\tthis._iAnimationRegisterCache.needFragmentAnimation = shaderObject.usesFragmentAnimation;\n\t\tthis._iAnimationRegisterCache.needUVAnimation = !shaderObject.usesUVTransform;\n\t\tthis._iAnimationRegisterCache.hasColorAddNode = this.hasColorAddNode;\n\t\tthis._iAnimationRegisterCache.hasColorMulNode = this.hasColorMulNode;\n\t\tthis._iAnimationRegisterCache.reset();\n\n\t\tvar code:string = \"\";\n\n\t\tcode += this._iAnimationRegisterCache.getInitCode();\n\n\t\tvar node:ParticleNodeBase;\n\t\tvar i:number /*int*/;\n\n\t\tfor (i = 0; i < this._particleNodes.length; i++) {\n\t\t\tnode = this._particleNodes[i];\n\t\t\tif (node.priority < ParticleAnimationSet.POST_PRIORITY)\n\t\t\t\tcode += node.getAGALVertexCode(shaderObject, this._iAnimationRegisterCache);\n\t\t}\n\n\t\tcode += this._iAnimationRegisterCache.getCombinationCode();\n\n\t\tfor (i = 0; i < this._particleNodes.length; i++) {\n\t\t\tnode = this._particleNodes[i];\n\t\t\tif (node.priority >= ParticleAnimationSet.POST_PRIORITY && node.priority < ParticleAnimationSet.COLOR_PRIORITY)\n\t\t\t\tcode += node.getAGALVertexCode(shaderObject, this._iAnimationRegisterCache);\n\t\t}\n\n\t\tcode += this._iAnimationRegisterCache.initColorRegisters();\n\n\t\tfor (i = 0; i < this._particleNodes.length; i++) {\n\t\t\tnode = this._particleNodes[i];\n\t\t\tif (node.priority >= ParticleAnimationSet.COLOR_PRIORITY)\n\t\t\t\tcode += node.getAGALVertexCode(shaderObject, this._iAnimationRegisterCache);\n\t\t}\n\t\tcode += this._iAnimationRegisterCache.getColorPassCode();\n\t\treturn code;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAGALUVCode(shaderObject:ShaderObjectBase):string\n\t{\n\t\tvar code:string = \"\";\n\t\tif (this.hasUVNode) {\n\t\t\tthis._iAnimationRegisterCache.setUVSourceAndTarget(shaderObject.uvSource, shaderObject.uvTarget);\n\t\t\tcode += \"mov \" + this._iAnimationRegisterCache.uvTarget + \".xy,\" + this._iAnimationRegisterCache.uvAttribute.toString() + \"\\n\";\n\t\t\tvar node:ParticleNodeBase;\n\t\t\tfor (var i:number /*uint*/ = 0; i < this._particleNodes.length; i++)\n\t\t\t\tnode = this._particleNodes[i];\n\t\t\t\tcode += node.getAGALUVCode(shaderObject, this._iAnimationRegisterCache);\n\t\t\tcode += \"mov \" + this._iAnimationRegisterCache.uvVar.toString() + \",\" + this._iAnimationRegisterCache.uvTarget + \".xy\\n\";\n\t\t} else\n\t\t\tcode += \"mov \" + shaderObject.uvTarget + \",\" + shaderObject.uvSource + \"\\n\";\n\t\treturn code;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAGALFragmentCode(shaderObject:ShaderObjectBase, shadedTarget:string):string\n\t{\n\t\treturn this._iAnimationRegisterCache.getColorCombinationCode(shadedTarget);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic doneAGALCode(shaderObject:ShaderObjectBase)\n\t{\n\t\tthis._iAnimationRegisterCache.setDataLength();\n\n\t\t//set vertexZeroConst,vertexOneConst,vertexTwoConst\n\t\tthis._iAnimationRegisterCache.setVertexConst(this._iAnimationRegisterCache.vertexZeroConst.index, 0, 1, 2, 0);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic get usesCPU():boolean\n\t{\n\t\treturn false;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic cancelGPUCompatibility()\n\t{\n\n\t}\n\n\tpublic dispose()\n\t{\n\t\tfor (var key in this._animationSubGeometries)\n\t\t\t(<AnimationSubGeometry> this._animationSubGeometries[key]).dispose();\n\n\t\tsuper.dispose();\n\t}\n\n\tpublic getAnimationSubGeometry(subMesh:ISubMesh)\n\t{\n\t\tvar mesh:Mesh = subMesh.parentMesh;\n\t\tvar animationSubGeometry:AnimationSubGeometry = (mesh.shareAnimationGeometry)? this._animationSubGeometries[subMesh.subGeometry.id] : this._animationSubGeometries[subMesh.id];\n\n\t\tif (animationSubGeometry)\n\t\t\treturn animationSubGeometry;\n\n\t\tthis._iGenerateAnimationSubGeometries(mesh);\n\n\t\treturn (mesh.shareAnimationGeometry)? this._animationSubGeometries[subMesh.subGeometry.id] : this._animationSubGeometries[subMesh.id];\n\t}\n\n\n\t/** @private */\n\tpublic _iGenerateAnimationSubGeometries(mesh:Mesh)\n\t{\n\t\tif (this.initParticleFunc == null)\n\t\t\tthrow(new Error(\"no initParticleFunc set\"));\n\n\t\tvar geometry:ParticleGeometry = <ParticleGeometry> mesh.geometry;\n\n\t\tif (!geometry)\n\t\t\tthrow(new Error(\"Particle animation can only be performed on a ParticleGeometry object\"));\n\n\t\tvar i:number /*int*/, j:number /*int*/, k:number /*int*/;\n\t\tvar animationSubGeometry:AnimationSubGeometry;\n\t\tvar newAnimationSubGeometry:boolean = false;\n\t\tvar subGeometry:SubGeometryBase;\n\t\tvar subMesh:ISubMesh;\n\t\tvar localNode:ParticleNodeBase;\n\n\t\tfor (i = 0; i < mesh.subMeshes.length; i++) {\n\t\t\tsubMesh = mesh.subMeshes[i];\n\t\t\tsubGeometry = subMesh.subGeometry;\n\t\t\tif (mesh.shareAnimationGeometry) {\n\t\t\t\tanimationSubGeometry = this._animationSubGeometries[subGeometry.id];\n\n\t\t\t\tif (animationSubGeometry)\n\t\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tanimationSubGeometry = new AnimationSubGeometry();\n\n\t\t\tif (mesh.shareAnimationGeometry)\n\t\t\t\tthis._animationSubGeometries[subGeometry.id] = animationSubGeometry;\n\t\t\telse\n\t\t\t\tthis._animationSubGeometries[subMesh.id] = animationSubGeometry;\n\n\t\t\tnewAnimationSubGeometry = true;\n\n\t\t\t//create the vertexData vector that will be used for local node data\n\t\t\tanimationSubGeometry.createVertexData(subGeometry.numVertices, this._totalLenOfOneVertex);\n\t\t}\n\n\t\tif (!newAnimationSubGeometry)\n\t\t\treturn;\n\n\t\tvar particles:Array<ParticleData> = geometry.particles;\n\t\tvar particlesLength:number /*uint*/ = particles.length;\n\t\tvar numParticles:number /*uint*/ = geometry.numParticles;\n\t\tvar particleProperties:ParticleProperties = new ParticleProperties();\n\t\tvar particle:ParticleData;\n\n\t\tvar oneDataLen:number /*int*/;\n\t\tvar oneDataOffset:number /*int*/;\n\t\tvar counterForVertex:number /*int*/;\n\t\tvar counterForOneData:number /*int*/;\n\t\tvar oneData:Array<number>;\n\t\tvar numVertices:number /*uint*/;\n\t\tvar vertexData:Array<number>;\n\t\tvar vertexLength:number /*uint*/;\n\t\tvar startingOffset:number /*uint*/;\n\t\tvar vertexOffset:number /*uint*/;\n\n\t\t//default values for particle param\n\t\tparticleProperties.total = numParticles;\n\t\tparticleProperties.startTime = 0;\n\t\tparticleProperties.duration = 1000;\n\t\tparticleProperties.delay = 0.1;\n\n\t\ti = 0;\n\t\tj = 0;\n\t\twhile (i < numParticles) {\n\t\t\tparticleProperties.index = i;\n\n\t\t\t//call the init on the particle parameters\n\t\t\tthis.initParticleFunc.call(this.initParticleScope, particleProperties);\n\n\t\t\t//create the next set of node properties for the particle\n\t\t\tfor (k = 0; k < this._localStaticNodes.length; k++)\n\t\t\t\tthis._localStaticNodes[k]._iGeneratePropertyOfOneParticle(particleProperties);\n\n\t\t\t//loop through all particle data for the curent particle\n\t\t\twhile (j < particlesLength && (particle = particles[j]).particleIndex == i) {\n\t\t\t\t//find the target animationSubGeometry\n\t\t\t\tfor (k = 0; k < mesh.subMeshes.length; k++) {\n\t\t\t\t\tsubMesh = mesh.subMeshes[k];\n\t\t\t\t\tif (subMesh.subGeometry == particle.subGeometry) {\n\t\t\t\t\t\tanimationSubGeometry = (mesh.shareAnimationGeometry)? this._animationSubGeometries[subMesh.subGeometry.id] : this._animationSubGeometries[subMesh.id];\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tnumVertices = particle.numVertices;\n\t\t\t\tvertexData = animationSubGeometry.vertexData;\n\t\t\t\tvertexLength = numVertices*this._totalLenOfOneVertex;\n\t\t\t\tstartingOffset = animationSubGeometry.numProcessedVertices*this._totalLenOfOneVertex;\n\n\t\t\t\t//loop through each static local node in the animation set\n\t\t\t\tfor (k = 0; k < this._localStaticNodes.length; k++) {\n\t\t\t\t\tlocalNode = this._localStaticNodes[k];\n\t\t\t\t\toneData = localNode.oneData;\n\t\t\t\t\toneDataLen = localNode.dataLength;\n\t\t\t\t\toneDataOffset = startingOffset + localNode._iDataOffset;\n\n\t\t\t\t\t//loop through each vertex set in the vertex data\n\t\t\t\t\tfor (counterForVertex = 0; counterForVertex < vertexLength; counterForVertex += this._totalLenOfOneVertex) {\n\t\t\t\t\t\tvertexOffset = oneDataOffset + counterForVertex;\n\n\t\t\t\t\t\t//add the data for the local node to the vertex data\n\t\t\t\t\t\tfor (counterForOneData = 0; counterForOneData < oneDataLen; counterForOneData++)\n\t\t\t\t\t\t\tvertexData[vertexOffset + counterForOneData] = oneData[counterForOneData];\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t\t//store particle properties if they need to be retreived for dynamic local nodes\n\t\t\t\tif (this._localDynamicNodes.length)\n\t\t\t\t\tanimationSubGeometry.animationParticles.push(new ParticleAnimationData(i, particleProperties.startTime, particleProperties.duration, particleProperties.delay, particle));\n\n\t\t\t\tanimationSubGeometry.numProcessedVertices += numVertices;\n\n\t\t\t\t//next index\n\t\t\t\tj++;\n\t\t\t}\n\n\t\t\t//next particle\n\t\t\ti++;\n\t\t}\n\t}\n}\n\nexport = ParticleAnimationSet;","import ISubMesh\t\t\t\t\t\t\t= require(\"awayjs-display/lib/base/ISubMesh\");\nimport SubGeometryBase\t\t\t\t\t= require(\"awayjs-display/lib/base/SubGeometryBase\");\nimport Camera\t\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\n\nimport ContextGLProgramType\t\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLProgramType\");\nimport Stage\t\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport ParticleAnimationSet\t\t\t\t= require(\"awayjs-renderergl/lib/animators/ParticleAnimationSet\");\nimport AnimationSubGeometry\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationSubGeometry\");\nimport ParticleAnimationData\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticleAnimationData\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticleNodeBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleNodeBase\");\nimport ParticleStateBase\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleStateBase\");\nimport ShaderObjectBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport RenderableBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\nimport TriangleSubMeshRenderable\t\t= require(\"awayjs-renderergl/lib/pool/TriangleSubMeshRenderable\");\n\n/**\n * Provides an interface for assigning paricle-based animation data sets to mesh-based entity objects\n * and controlling the various available states of animation through an interative playhead that can be\n * automatically updated or manually triggered.\n *\n * Requires that the containing geometry of the parent mesh is particle geometry\n *\n * @see away.base.ParticleGeometry\n */\nclass ParticleAnimator extends AnimatorBase\n{\n\n\tprivate _particleAnimationSet:ParticleAnimationSet;\n\tprivate _animationParticleStates:Array<ParticleStateBase> = new Array<ParticleStateBase>();\n\tprivate _animatorParticleStates:Array<ParticleStateBase> = new Array<ParticleStateBase>();\n\tprivate _timeParticleStates:Array<ParticleStateBase> = new Array<ParticleStateBase>();\n\tprivate _totalLenOfOneVertex:number /*uint*/ = 0;\n\tprivate _animatorSubGeometries:Object = new Object();\n\n\t/**\n\t * Creates a new <code>ParticleAnimator</code> object.\n\t *\n\t * @param particleAnimationSet The animation data set containing the particle animations used by the animator.\n\t */\n\tconstructor(particleAnimationSet:ParticleAnimationSet)\n\t{\n\t\tsuper(particleAnimationSet);\n\t\tthis._particleAnimationSet = particleAnimationSet;\n\n\t\tvar state:ParticleStateBase;\n\t\tvar node:ParticleNodeBase;\n\n\t\tfor (var i:number = 0; i < this._particleAnimationSet.particleNodes.length; i++) {\n\t\t\tnode = this._particleAnimationSet.particleNodes[i];\n\t\t\tstate = <ParticleStateBase> this.getAnimationState(node);\n\t\t\tif (node.mode == ParticlePropertiesMode.LOCAL_DYNAMIC) {\n\t\t\t\tthis._animatorParticleStates.push(state);\n\t\t\t\tnode._iDataOffset = this._totalLenOfOneVertex;\n\t\t\t\tthis._totalLenOfOneVertex += node.dataLength;\n\t\t\t} else {\n\t\t\t\tthis._animationParticleStates.push(state);\n\t\t\t}\n\t\t\tif (state.needUpdateTime)\n\t\t\t\tthis._timeParticleStates.push(state);\n\t\t}\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic clone():AnimatorBase\n\t{\n\t\treturn new ParticleAnimator(this._particleAnimationSet);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic setRenderState(shaderObject:ShaderObjectBase, renderable:RenderableBase, stage:Stage, camera:Camera, vertexConstantOffset:number /*int*/, vertexStreamOffset:number /*int*/)\n\t{\n\t\tvar animationRegisterCache:AnimationRegisterCache = this._particleAnimationSet._iAnimationRegisterCache;\n\n\t\tvar subMesh:ISubMesh = (<TriangleSubMeshRenderable> renderable).subMesh;\n\t\tvar state:ParticleStateBase;\n\t\tvar i:number;\n\n\t\tif (!subMesh)\n\t\t\tthrow(new Error(\"Must be subMesh\"));\n\n\t\t//process animation sub geometries\n\t\tvar animationSubGeometry:AnimationSubGeometry = this._particleAnimationSet.getAnimationSubGeometry(subMesh);\n\n\t\tfor (i = 0; i < this._animationParticleStates.length; i++)\n\t\t\tthis._animationParticleStates[i].setRenderState(stage, renderable, animationSubGeometry, animationRegisterCache, camera);\n\n\t\t//process animator subgeometries\n\t\tvar animatorSubGeometry:AnimationSubGeometry = this.getAnimatorSubGeometry(subMesh);\n\n\t\tfor (i = 0; i < this._animatorParticleStates.length; i++)\n\t\t\tthis._animatorParticleStates[i].setRenderState(stage, renderable, animatorSubGeometry, animationRegisterCache, camera);\n\n\t\tstage.context.setProgramConstantsFromArray(ContextGLProgramType.VERTEX, animationRegisterCache.vertexConstantOffset, animationRegisterCache.vertexConstantData, animationRegisterCache.numVertexConstant);\n\n\t\tif (animationRegisterCache.numFragmentConstant > 0)\n\t\t\tstage.context.setProgramConstantsFromArray(ContextGLProgramType.FRAGMENT, animationRegisterCache.fragmentConstantOffset, animationRegisterCache.fragmentConstantData, animationRegisterCache.numFragmentConstant);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic testGPUCompatibility(shaderObject:ShaderObjectBase)\n\t{\n\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic start()\n\t{\n\t\tsuper.start();\n\n\t\tfor (var i:number = 0; i < this._timeParticleStates.length; i++)\n\t\t\tthis._timeParticleStates[i].offset(this._pAbsoluteTime);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _pUpdateDeltaTime(dt:number)\n\t{\n\t\tthis._pAbsoluteTime += dt;\n\n\t\tfor (var i:number = 0; i < this._timeParticleStates.length; i++)\n\t\t\tthis._timeParticleStates[i].update(this._pAbsoluteTime);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic resetTime(offset:number /*int*/ = 0)\n\t{\n\t\tfor (var i:number = 0; i < this._timeParticleStates.length; i++)\n\t\t\tthis._timeParticleStates[i].offset(this._pAbsoluteTime + offset);\n\t\tthis.update(this.time);\n\t}\n\n\tpublic dispose()\n\t{\n\t\tfor (var key in this._animatorSubGeometries)\n\t\t\t(<AnimationSubGeometry> this._animatorSubGeometries[key]).dispose();\n\t}\n\n\tprivate getAnimatorSubGeometry(subMesh:ISubMesh):AnimationSubGeometry\n\t{\n\t\tif (!this._animatorParticleStates.length)\n\t\t\treturn;\n\n\t\tvar subGeometry:SubGeometryBase = subMesh.subGeometry;\n\t\tvar animatorSubGeometry:AnimationSubGeometry = this._animatorSubGeometries[subGeometry.id] = new AnimationSubGeometry();\n\n\t\t//create the vertexData vector that will be used for local state data\n\t\tanimatorSubGeometry.createVertexData(subGeometry.numVertices, this._totalLenOfOneVertex);\n\n\t\t//pass the particles data to the animator subGeometry\n\t\tanimatorSubGeometry.animationParticles = this._particleAnimationSet.getAnimationSubGeometry(subMesh).animationParticles;\n\t}\n}\n\nexport = ParticleAnimator;","import IAnimationSet\t\t\t\t\t= require(\"awayjs-display/lib/animators/IAnimationSet\");\n\nimport Stage\t\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\n\nimport AnimationSetBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimationSetBase\");\nimport ShaderObjectBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\n\n/**\n * The animation data set used by skeleton-based animators, containing skeleton animation data.\n *\n * @see away.animators.SkeletonAnimator\n */\nclass SkeletonAnimationSet extends AnimationSetBase implements IAnimationSet\n{\n\tprivate _jointsPerVertex:number /*uint*/;\n\n\t/**\n\t * Returns the amount of skeleton joints that can be linked to a single vertex via skinned weight values. For GPU-base animation, the\n\t * maximum allowed value is 4.\n\t */\n\tpublic get jointsPerVertex():number /*uint*/\n\t{\n\t\treturn this._jointsPerVertex;\n\t}\n\n\t/**\n\t * Creates a new <code>SkeletonAnimationSet</code> object.\n\t *\n\t * @param jointsPerVertex Sets the amount of skeleton joints that can be linked to a single vertex via skinned weight values. For GPU-base animation, the maximum allowed value is 4. Defaults to 4.\n\t */\n\tconstructor(jointsPerVertex:number /*uint*/ = 4)\n\t{\n\t\tsuper();\n\n\t\tthis._jointsPerVertex = jointsPerVertex;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAGALVertexCode(shaderObject:ShaderObjectBase):string\n\t{\n\t\tvar len:number /*uint*/ = shaderObject.animatableAttributes.length;\n\n\t\tvar indexOffset0:number /*uint*/ = shaderObject.numUsedVertexConstants;\n\t\tvar indexOffset1:number /*uint*/ = indexOffset0 + 1;\n\t\tvar indexOffset2:number /*uint*/ = indexOffset0 + 2;\n\t\tvar indexStream:string = \"va\" + shaderObject.numUsedStreams;\n\t\tvar weightStream:string = \"va\" + (shaderObject.numUsedStreams + 1);\n\t\tvar indices:Array<string> = [ indexStream + \".x\", indexStream + \".y\", indexStream + \".z\", indexStream + \".w\" ];\n\t\tvar weights:Array<string> = [ weightStream + \".x\", weightStream + \".y\", weightStream + \".z\", weightStream + \".w\" ];\n\t\tvar temp1:string = this._pFindTempReg(shaderObject.animationTargetRegisters);\n\t\tvar temp2:string = this._pFindTempReg(shaderObject.animationTargetRegisters, temp1);\n\t\tvar dot:string = \"dp4\";\n\t\tvar code:string = \"\";\n\n\t\tfor (var i:number /*uint*/ = 0; i < len; ++i) {\n\n\t\t\tvar src:string = shaderObject.animatableAttributes[i];\n\n\t\t\tfor (var j:number /*uint*/ = 0; j < this._jointsPerVertex; ++j) {\n\t\t\t\tcode += dot + \" \" + temp1 + \".x, \" + src + \", vc[\" + indices[j] + \"+\" + indexOffset0 + \"]\\n\" +\n\t\t\t\t\tdot + \" \" + temp1 + \".y, \" + src + \", vc[\" + indices[j] + \"+\" + indexOffset1 + \"]\\n\" +\n\t\t\t\t\tdot + \" \" + temp1 + \".z, \" + src + \", vc[\" + indices[j] + \"+\" + indexOffset2 + \"]\\n\" +\n\t\t\t\t\t\"mov \" + temp1 + \".w, \" + src + \".w\\n\" +\n\t\t\t\t\t\"mul \" + temp1 + \", \" + temp1 + \", \" + weights[j] + \"\\n\"; // apply weight\n\n\t\t\t\t// add or mov to target. Need to write to a temp reg first, because an output can be a target\n\t\t\t\tif (j == 0)\n\t\t\t\t\tcode += \"mov \" + temp2 + \", \" + temp1 + \"\\n\"; else\n\t\t\t\t\tcode += \"add \" + temp2 + \", \" + temp2 + \", \" + temp1 + \"\\n\";\n\t\t\t}\n\t\t\t// switch to dp3 once positions have been transformed, from now on, it should only be vectors instead of points\n\t\t\tdot = \"dp3\";\n\t\t\tcode += \"mov \" + shaderObject.animationTargetRegisters[i] + \", \" + temp2 + \"\\n\";\n\t\t}\n\n\t\treturn code;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic activate(shaderObject:ShaderObjectBase, stage:Stage)\n\t{\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic deactivate(shaderObject:ShaderObjectBase, stage:Stage)\n\t{\n//\t\t\tvar streamOffset:number /*uint*/ = pass.numUsedStreams;\n//\t\t\tvar context:IContextGL = <IContextGL> stage.context;\n//\t\t\tcontext.setVertexBufferAt(streamOffset, null);\n//\t\t\tcontext.setVertexBufferAt(streamOffset + 1, null);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAGALFragmentCode(shaderObject:ShaderObjectBase, shadedTarget:string):string\n\t{\n\t\treturn \"\";\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAGALUVCode(shaderObject:ShaderObjectBase):string\n\t{\n\t\treturn \"mov \" + shaderObject.uvTarget + \",\" + shaderObject.uvSource + \"\\n\";\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic doneAGALCode(shaderObject:ShaderObjectBase)\n\t{\n\n\t}\n}\n\nexport = SkeletonAnimationSet;","import Quaternion\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Quaternion\");\nimport Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport ISubMesh\t\t\t\t\t\t\t= require(\"awayjs-display/lib/base/ISubMesh\");\nimport TriangleSubGeometry\t\t\t\t= require(\"awayjs-display/lib/base/TriangleSubGeometry\");\nimport TriangleSubMesh\t\t\t\t\t= require(\"awayjs-display/lib/base/TriangleSubMesh\");\nimport Camera\t\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\nimport SubGeometryEvent\t\t\t\t\t= require(\"awayjs-display/lib/events/SubGeometryEvent\");\n\nimport ContextGLProgramType\t\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLProgramType\");\nimport Stage\t\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport SkeletonAnimationSet\t\t\t\t= require(\"awayjs-renderergl/lib/animators/SkeletonAnimationSet\");\nimport JointPose\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/JointPose\");\nimport Skeleton\t\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/Skeleton\");\nimport SkeletonJoint\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/SkeletonJoint\");\nimport SkeletonPose\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/SkeletonPose\");\nimport ISkeletonAnimationState\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ISkeletonAnimationState\");\nimport IAnimationTransition\t\t\t\t= require(\"awayjs-renderergl/lib/animators/transitions/IAnimationTransition\");\nimport AnimationStateEvent\t\t\t\t= require(\"awayjs-renderergl/lib/events/AnimationStateEvent\");\nimport ShaderObjectBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport RenderableBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\nimport TriangleSubMeshRenderable\t\t= require(\"awayjs-renderergl/lib/pool/TriangleSubMeshRenderable\");\n\n/**\n * Provides an interface for assigning skeleton-based animation data sets to mesh-based entity objects\n * and controlling the various available states of animation through an interative playhead that can be\n * automatically updated or manually triggered.\n */\nclass SkeletonAnimator extends AnimatorBase\n{\n\tprivate _globalMatrices:Array<number>;\n\tprivate _globalPose:SkeletonPose = new SkeletonPose();\n\tprivate _globalPropertiesDirty:boolean;\n\tprivate _numJoints:number /*uint*/;\n\tprivate _morphedSubGeometry:Object = new Object();\n\tprivate _morphedSubGeometryDirty:Object = new Object();\n\tprivate _condensedMatrices:Array<number>;\n\n\tprivate _skeleton:Skeleton;\n\tprivate _forceCPU:boolean;\n\tprivate _useCondensedIndices:boolean;\n\tprivate _jointsPerVertex:number /*uint*/;\n\tprivate _activeSkeletonState:ISkeletonAnimationState;\n\tprivate _onTransitionCompleteDelegate:(event:AnimationStateEvent) => void;\n\n\tprivate _onIndicesUpdateDelegate:(event:SubGeometryEvent) => void;\n\tprivate _onVerticesUpdateDelegate:(event:SubGeometryEvent) => void;\n\n\t/**\n\t * returns the calculated global matrices of the current skeleton pose.\n\t *\n\t * @see #globalPose\n\t */\n\tpublic get globalMatrices():Array<number>\n\t{\n\t\tif (this._globalPropertiesDirty)\n\t\t\tthis.updateGlobalProperties();\n\n\t\treturn this._globalMatrices;\n\t}\n\n\t/**\n\t * returns the current skeleton pose output from the animator.\n\t *\n\t * @see away.animators.data.SkeletonPose\n\t */\n\tpublic get globalPose():SkeletonPose\n\t{\n\t\tif (this._globalPropertiesDirty)\n\t\t\tthis.updateGlobalProperties();\n\n\t\treturn this._globalPose;\n\t}\n\n\t/**\n\t * Returns the skeleton object in use by the animator - this defines the number and heirarchy of joints used by the\n\t * skinned geoemtry to which skeleon animator is applied.\n\t */\n\tpublic get skeleton():Skeleton\n\t{\n\t\treturn this._skeleton;\n\t}\n\n\t/**\n\t * Indicates whether the skeleton animator is disabled by default for GPU rendering, something that allows the animator to perform calculation on the GPU.\n\t * Defaults to false.\n\t */\n\tpublic get forceCPU():boolean\n\t{\n\t\treturn this._forceCPU;\n\t}\n\n\t/**\n\t * Offers the option of enabling GPU accelerated animation on skeletons larger than 32 joints\n\t * by condensing the number of joint index values required per mesh. Only applicable to\n\t * skeleton animations that utilise more than one mesh object. Defaults to false.\n\t */\n\tpublic get useCondensedIndices():boolean\n\t{\n\t\treturn this._useCondensedIndices;\n\t}\n\n\tpublic set useCondensedIndices(value:boolean)\n\t{\n\t\tthis._useCondensedIndices = value;\n\t}\n\n\t/**\n\t * Creates a new <code>SkeletonAnimator</code> object.\n\t *\n\t * @param skeletonAnimationSet The animation data set containing the skeleton animations used by the animator.\n\t * @param skeleton The skeleton object used for calculating the resulting global matrices for transforming skinned mesh data.\n\t * @param forceCPU Optional value that only allows the animator to perform calculation on the CPU. Defaults to false.\n\t */\n\tconstructor(animationSet:SkeletonAnimationSet, skeleton:Skeleton, forceCPU:boolean = false)\n\t{\n\t\tsuper(animationSet);\n\n\t\tthis._skeleton = skeleton;\n\t\tthis._forceCPU = forceCPU;\n\t\tthis._jointsPerVertex = animationSet.jointsPerVertex;\n\n\t\tthis._numJoints = this._skeleton.numJoints;\n\t\tthis._globalMatrices = new Array<number>(this._numJoints*12);\n\n\t\tvar j:number /*int*/ = 0;\n\t\tfor (var i:number /*uint*/ = 0; i < this._numJoints; ++i) {\n\t\t\tthis._globalMatrices[j++] = 1;\n\t\t\tthis._globalMatrices[j++] = 0;\n\t\t\tthis._globalMatrices[j++] = 0;\n\t\t\tthis._globalMatrices[j++] = 0;\n\t\t\tthis._globalMatrices[j++] = 0;\n\t\t\tthis._globalMatrices[j++] = 1;\n\t\t\tthis._globalMatrices[j++] = 0;\n\t\t\tthis._globalMatrices[j++] = 0;\n\t\t\tthis._globalMatrices[j++] = 0;\n\t\t\tthis._globalMatrices[j++] = 0;\n\t\t\tthis._globalMatrices[j++] = 1;\n\t\t\tthis._globalMatrices[j++] = 0;\n\t\t}\n\n\t\tthis._onTransitionCompleteDelegate = (event:AnimationStateEvent) => this.onTransitionComplete(event);\n\t\tthis._onIndicesUpdateDelegate = (event:SubGeometryEvent) => this.onIndicesUpdate(event);\n\t\tthis._onVerticesUpdateDelegate = (event:SubGeometryEvent) => this.onVerticesUpdate(event);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic clone():AnimatorBase\n\t{\n\t\t/* The cast to SkeletonAnimationSet should never fail, as _animationSet can only be set\n\t\t through the constructor, which will only accept a SkeletonAnimationSet. */\n\t\treturn new SkeletonAnimator(<SkeletonAnimationSet> this._pAnimationSet, this._skeleton, this._forceCPU);\n\t}\n\n\t/**\n\t * Plays an animation state registered with the given name in the animation data set.\n\t *\n\t * @param name The data set name of the animation state to be played.\n\t * @param transition An optional transition object that determines how the animator will transition from the currently active animation state.\n\t * @param offset An option offset time (in milliseconds) that resets the state's internal clock to the absolute time of the animator plus the offset value. Required for non-looping animation states.\n\t */\n\tpublic play(name:string, transition:IAnimationTransition = null, offset:number = NaN)\n\t{\n\t\tif (this._pActiveAnimationName == name)\n\t\t\treturn;\n\n\t\tthis._pActiveAnimationName = name;\n\n\t\tif (!this._pAnimationSet.hasAnimation(name))\n\t\t\tthrow new Error(\"Animation root node \" + name + \" not found!\");\n\n\t\tif (transition && this._pActiveNode) {\n\t\t\t//setup the transition\n\t\t\tthis._pActiveNode = transition.getAnimationNode(this, this._pActiveNode, this._pAnimationSet.getAnimation(name), this._pAbsoluteTime);\n\t\t\tthis._pActiveNode.addEventListener(AnimationStateEvent.TRANSITION_COMPLETE, this._onTransitionCompleteDelegate);\n\t\t} else\n\t\t\tthis._pActiveNode = this._pAnimationSet.getAnimation(name);\n\n\t\tthis._pActiveState = this.getAnimationState(this._pActiveNode);\n\n\t\tif (this.updatePosition) {\n\t\t\t//update straight away to reset position deltas\n\t\t\tthis._pActiveState.update(this._pAbsoluteTime);\n\t\t\tthis._pActiveState.positionDelta;\n\t\t}\n\n\t\tthis._activeSkeletonState = <ISkeletonAnimationState> this._pActiveState;\n\n\t\tthis.start();\n\n\t\t//apply a time offset if specified\n\t\tif (!isNaN(offset))\n\t\t\tthis.reset(name, offset);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic setRenderState(shaderObject:ShaderObjectBase, renderable:RenderableBase, stage:Stage, camera:Camera, vertexConstantOffset:number /*int*/, vertexStreamOffset:number /*int*/)\n\t{\n\t\t// do on request of globalProperties\n\t\tif (this._globalPropertiesDirty)\n\t\t\tthis.updateGlobalProperties();\n\n\t\tvar subGeometry:TriangleSubGeometry = <TriangleSubGeometry> (<TriangleSubMesh> (<TriangleSubMeshRenderable> renderable).subMesh).subGeometry;\n\n\t\tsubGeometry.useCondensedIndices = this._useCondensedIndices;\n\n\t\tif (this._useCondensedIndices) {\n\t\t\t// using a condensed data set\n\t\t\tthis.updateCondensedMatrices(subGeometry.condensedIndexLookUp, subGeometry.numCondensedJoints);\n\t\t\tstage.context.setProgramConstantsFromArray(ContextGLProgramType.VERTEX, vertexConstantOffset, this._condensedMatrices, subGeometry.numCondensedJoints*3);\n\t\t} else {\n\t\t\tif (this._pAnimationSet.usesCPU) {\n\t\t\t\tif (this._morphedSubGeometryDirty[subGeometry.id])\n\t\t\t\t\tthis.morphSubGeometry(<TriangleSubMeshRenderable> renderable, subGeometry);\n\n\t\t\t\treturn\n\t\t\t}\n\t\t\tstage.context.setProgramConstantsFromArray(ContextGLProgramType.VERTEX, vertexConstantOffset, this._globalMatrices, this._numJoints*3);\n\t\t}\n\n\t\tstage.activateBuffer(vertexStreamOffset, renderable.getVertexData(TriangleSubGeometry.JOINT_INDEX_DATA), renderable.getVertexOffset(TriangleSubGeometry.JOINT_INDEX_DATA), renderable.JOINT_INDEX_FORMAT);\n\t\tstage.activateBuffer(vertexStreamOffset + 1, renderable.getVertexData(TriangleSubGeometry.JOINT_WEIGHT_DATA), renderable.getVertexOffset(TriangleSubGeometry.JOINT_WEIGHT_DATA), renderable.JOINT_WEIGHT_FORMAT);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic testGPUCompatibility(shaderObject:ShaderObjectBase)\n\t{\n\t\tif (!this._useCondensedIndices && (this._forceCPU || this._jointsPerVertex > 4 || shaderObject.numUsedVertexConstants + this._numJoints*3 > 128))\n\t\t\tthis._pAnimationSet.cancelGPUCompatibility();\n\t}\n\n\t/**\n\t * Applies the calculated time delta to the active animation state node or state transition object.\n\t */\n\tpublic _pUpdateDeltaTime(dt:number)\n\t{\n\t\tsuper._pUpdateDeltaTime(dt);\n\n\t\t//invalidate pose matrices\n\t\tthis._globalPropertiesDirty = true;\n\n\t\t//trigger geometry invalidation if using CPU animation\n\t\tif (this._pAnimationSet.usesCPU)\n\t\t\tfor (var key in this._morphedSubGeometryDirty)\n\t\t\t\tthis._morphedSubGeometryDirty[key] = true;\n\t}\n\n\tprivate updateCondensedMatrices(condensedIndexLookUp:Array<number> /*uint*/, numJoints:number /*uint*/)\n\t{\n\t\tvar i:number /*uint*/ = 0, j:number /*uint*/ = 0;\n\t\tvar len:number /*uint*/;\n\t\tvar srcIndex:number /*uint*/;\n\n\t\tthis._condensedMatrices = new Array<number>();\n\n\t\tdo {\n\t\t\tsrcIndex = condensedIndexLookUp[i]*4;\n\t\t\tlen = srcIndex + 12;\n\t\t\t// copy into condensed\n\t\t\twhile (srcIndex < len)\n\t\t\t\tthis._condensedMatrices[j++] = this._globalMatrices[srcIndex++];\n\t\t} while (++i < numJoints);\n\t}\n\n\tprivate updateGlobalProperties()\n\t{\n\t\tthis._globalPropertiesDirty = false;\n\n\t\t//get global pose\n\t\tthis.localToGlobalPose(this._activeSkeletonState.getSkeletonPose(this._skeleton), this._globalPose, this._skeleton);\n\n\t\t// convert pose to matrix\n\t\tvar mtxOffset:number /*uint*/ = 0;\n\t\tvar globalPoses:Array<JointPose> = this._globalPose.jointPoses;\n\t\tvar raw:Array<number>;\n\t\tvar ox:number, oy:number, oz:number, ow:number;\n\t\tvar xy2:number, xz2:number, xw2:number;\n\t\tvar yz2:number, yw2:number, zw2:number;\n\t\tvar n11:number, n12:number, n13:number;\n\t\tvar n21:number, n22:number, n23:number;\n\t\tvar n31:number, n32:number, n33:number;\n\t\tvar m11:number, m12:number, m13:number, m14:number;\n\t\tvar m21:number, m22:number, m23:number, m24:number;\n\t\tvar m31:number, m32:number, m33:number, m34:number;\n\t\tvar joints:Array<SkeletonJoint> = this._skeleton.joints;\n\t\tvar pose:JointPose;\n\t\tvar quat:Quaternion;\n\t\tvar vec:Vector3D;\n\t\tvar t:number;\n\n\t\tfor (var i:number /*uint*/ = 0; i < this._numJoints; ++i) {\n\t\t\tpose = globalPoses[i];\n\t\t\tquat = pose.orientation;\n\t\t\tvec = pose.translation;\n\t\t\tox = quat.x;\n\t\t\toy = quat.y;\n\t\t\toz = quat.z;\n\t\t\tow = quat.w;\n\n\t\t\txy2 = (t = 2.0*ox)*oy;\n\t\t\txz2 = t*oz;\n\t\t\txw2 = t*ow;\n\t\t\tyz2 = (t = 2.0*oy)*oz;\n\t\t\tyw2 = t*ow;\n\t\t\tzw2 = 2.0*oz*ow;\n\n\t\t\tyz2 = 2.0*oy*oz;\n\t\t\tyw2 = 2.0*oy*ow;\n\t\t\tzw2 = 2.0*oz*ow;\n\t\t\tox *= ox;\n\t\t\toy *= oy;\n\t\t\toz *= oz;\n\t\t\tow *= ow;\n\n\t\t\tn11 = (t = ox - oy) - oz + ow;\n\t\t\tn12 = xy2 - zw2;\n\t\t\tn13 = xz2 + yw2;\n\t\t\tn21 = xy2 + zw2;\n\t\t\tn22 = -t - oz + ow;\n\t\t\tn23 = yz2 - xw2;\n\t\t\tn31 = xz2 - yw2;\n\t\t\tn32 = yz2 + xw2;\n\t\t\tn33 = -ox - oy + oz + ow;\n\n\t\t\t// prepend inverse bind pose\n\t\t\traw = joints[i].inverseBindPose;\n\t\t\tm11 = raw[0];\n\t\t\tm12 = raw[4];\n\t\t\tm13 = raw[8];\n\t\t\tm14 = raw[12];\n\t\t\tm21 = raw[1];\n\t\t\tm22 = raw[5];\n\t\t\tm23 = raw[9];\n\t\t\tm24 = raw[13];\n\t\t\tm31 = raw[2];\n\t\t\tm32 = raw[6];\n\t\t\tm33 = raw[10];\n\t\t\tm34 = raw[14];\n\n\t\t\tthis._globalMatrices[mtxOffset] = n11*m11 + n12*m21 + n13*m31;\n\t\t\tthis._globalMatrices[mtxOffset + 1] = n11*m12 + n12*m22 + n13*m32;\n\t\t\tthis._globalMatrices[mtxOffset + 2] = n11*m13 + n12*m23 + n13*m33;\n\t\t\tthis._globalMatrices[mtxOffset + 3] = n11*m14 + n12*m24 + n13*m34 + vec.x;\n\t\t\tthis._globalMatrices[mtxOffset + 4] = n21*m11 + n22*m21 + n23*m31;\n\t\t\tthis._globalMatrices[mtxOffset + 5] = n21*m12 + n22*m22 + n23*m32;\n\t\t\tthis._globalMatrices[mtxOffset + 6] = n21*m13 + n22*m23 + n23*m33;\n\t\t\tthis._globalMatrices[mtxOffset + 7] = n21*m14 + n22*m24 + n23*m34 + vec.y;\n\t\t\tthis._globalMatrices[mtxOffset + 8] = n31*m11 + n32*m21 + n33*m31;\n\t\t\tthis._globalMatrices[mtxOffset + 9] = n31*m12 + n32*m22 + n33*m32;\n\t\t\tthis._globalMatrices[mtxOffset + 10] = n31*m13 + n32*m23 + n33*m33;\n\t\t\tthis._globalMatrices[mtxOffset + 11] = n31*m14 + n32*m24 + n33*m34 + vec.z;\n\n\t\t\tmtxOffset = mtxOffset + 12;\n\t\t}\n\t}\n\n\n\tpublic getRenderableSubGeometry(renderable:TriangleSubMeshRenderable, sourceSubGeometry:TriangleSubGeometry):TriangleSubGeometry\n\t{\n\t\tthis._morphedSubGeometryDirty[sourceSubGeometry.id] = true;\n\n\t\t//early out for GPU animations\n\t\tif (!this._pAnimationSet.usesCPU)\n\t\t\treturn sourceSubGeometry;\n\n\t\tvar targetSubGeometry:TriangleSubGeometry;\n\n\t\tif (!(targetSubGeometry = this._morphedSubGeometry[sourceSubGeometry.id])) {\n\t\t\t//not yet stored\n\t\t\ttargetSubGeometry = this._morphedSubGeometry[sourceSubGeometry.id] = sourceSubGeometry.clone();\n\t\t\t//turn off auto calculations on the morphed geometry\n\t\t\ttargetSubGeometry.autoDeriveNormals = false;\n\t\t\ttargetSubGeometry.autoDeriveTangents = false;\n\t\t\ttargetSubGeometry.autoDeriveUVs = false;\n\t\t\t//add event listeners for any changes in UV values on the source geometry\n\t\t\tsourceSubGeometry.addEventListener(SubGeometryEvent.INDICES_UPDATED, this._onIndicesUpdateDelegate);\n\t\t\tsourceSubGeometry.addEventListener(SubGeometryEvent.VERTICES_UPDATED, this._onVerticesUpdateDelegate);\n\t\t}\n\n\t\treturn targetSubGeometry;\n\t}\n\n\t/**\n\t * If the animation can't be performed on GPU, transform vertices manually\n\t * @param subGeom The subgeometry containing the weights and joint index data per vertex.\n\t * @param pass The material pass for which we need to transform the vertices\n\t */\n\tpublic morphSubGeometry(renderable:TriangleSubMeshRenderable, sourceSubGeometry:TriangleSubGeometry)\n\t{\n\t\tthis._morphedSubGeometryDirty[sourceSubGeometry.id] = false;\n\n\t\tvar sourcePositions:Array<number> = sourceSubGeometry.positions;\n\t\tvar sourceNormals:Array<number> = sourceSubGeometry.vertexNormals;\n\t\tvar sourceTangents:Array<number> = sourceSubGeometry.vertexTangents;\n\n\t\tvar jointIndices:Array<number> = sourceSubGeometry.jointIndices;\n\t\tvar jointWeights:Array<number> = sourceSubGeometry.jointWeights;\n\n\t\tvar targetSubGeometry = this._morphedSubGeometry[sourceSubGeometry.id];\n\n\t\tvar targetPositions:Array<number> = targetSubGeometry.positions;\n\t\tvar targetNormals:Array<number> = targetSubGeometry.vertexNormals;\n\t\tvar targetTangents:Array<number> = targetSubGeometry.vertexTangents;\n\n\t\tvar index:number /*uint*/ = 0;\n\t\tvar j:number /*uint*/ = 0;\n\t\tvar k:number /*uint*/;\n\t\tvar vx:number, vy:number, vz:number;\n\t\tvar nx:number, ny:number, nz:number;\n\t\tvar tx:number, ty:number, tz:number;\n\t\tvar len:number /*int*/ = sourcePositions.length;\n\t\tvar weight:number;\n\t\tvar vertX:number, vertY:number, vertZ:number;\n\t\tvar normX:number, normY:number, normZ:number;\n\t\tvar tangX:number, tangY:number, tangZ:number;\n\t\tvar m11:number, m12:number, m13:number, m14:number;\n\t\tvar m21:number, m22:number, m23:number, m24:number;\n\t\tvar m31:number, m32:number, m33:number, m34:number;\n\n\t\twhile (index < len) {\n\t\t\tvertX = sourcePositions[index];\n\t\t\tvertY = sourcePositions[index + 1];\n\t\t\tvertZ = sourcePositions[index + 2];\n\t\t\tnormX = sourceNormals[index];\n\t\t\tnormY = sourceNormals[index + 1];\n\t\t\tnormZ = sourceNormals[index + 2];\n\t\t\ttangX = sourceTangents[index];\n\t\t\ttangY = sourceTangents[index + 1];\n\t\t\ttangZ = sourceTangents[index + 2];\n\t\t\tvx = 0;\n\t\t\tvy = 0;\n\t\t\tvz = 0;\n\t\t\tnx = 0;\n\t\t\tny = 0;\n\t\t\tnz = 0;\n\t\t\ttx = 0;\n\t\t\tty = 0;\n\t\t\ttz = 0;\n\t\t\tk = 0;\n\t\t\twhile (k < this._jointsPerVertex) {\n\t\t\t\tweight = jointWeights[j];\n\t\t\t\tif (weight > 0) {\n\t\t\t\t\t// implicit /3*12 (/3 because indices are multiplied by 3 for gpu matrix access, *12 because it's the matrix size)\n\t\t\t\t\tvar mtxOffset:number /*uint*/ = jointIndices[j++] << 2;\n\t\t\t\t\tm11 = this._globalMatrices[mtxOffset];\n\t\t\t\t\tm12 = this._globalMatrices[mtxOffset + 1];\n\t\t\t\t\tm13 = this._globalMatrices[mtxOffset + 2];\n\t\t\t\t\tm14 = this._globalMatrices[mtxOffset + 3];\n\t\t\t\t\tm21 = this._globalMatrices[mtxOffset + 4];\n\t\t\t\t\tm22 = this._globalMatrices[mtxOffset + 5];\n\t\t\t\t\tm23 = this._globalMatrices[mtxOffset + 6];\n\t\t\t\t\tm24 = this._globalMatrices[mtxOffset + 7];\n\t\t\t\t\tm31 = this._globalMatrices[mtxOffset + 8];\n\t\t\t\t\tm32 = this._globalMatrices[mtxOffset + 9];\n\t\t\t\t\tm33 = this._globalMatrices[mtxOffset + 10];\n\t\t\t\t\tm34 = this._globalMatrices[mtxOffset + 11];\n\t\t\t\t\tvx += weight*(m11*vertX + m12*vertY + m13*vertZ + m14);\n\t\t\t\t\tvy += weight*(m21*vertX + m22*vertY + m23*vertZ + m24);\n\t\t\t\t\tvz += weight*(m31*vertX + m32*vertY + m33*vertZ + m34);\n\t\t\t\t\tnx += weight*(m11*normX + m12*normY + m13*normZ);\n\t\t\t\t\tny += weight*(m21*normX + m22*normY + m23*normZ);\n\t\t\t\t\tnz += weight*(m31*normX + m32*normY + m33*normZ);\n\t\t\t\t\ttx += weight*(m11*tangX + m12*tangY + m13*tangZ);\n\t\t\t\t\tty += weight*(m21*tangX + m22*tangY + m23*tangZ);\n\t\t\t\t\ttz += weight*(m31*tangX + m32*tangY + m33*tangZ);\n\t\t\t\t\t++k;\n\t\t\t\t} else {\n\t\t\t\t\tj += (this._jointsPerVertex - k);\n\t\t\t\t\tk = this._jointsPerVertex;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\ttargetPositions[index] = vx;\n\t\t\ttargetPositions[index + 1] = vy;\n\t\t\ttargetPositions[index + 2] = vz;\n\t\t\ttargetNormals[index] = nx;\n\t\t\ttargetNormals[index + 1] = ny;\n\t\t\ttargetNormals[index + 2] = nz;\n\t\t\ttargetTangents[index] = tx;\n\t\t\ttargetTangents[index + 1] = ty;\n\t\t\ttargetTangents[index + 2] = tz;\n\n\t\t\tindex += 3;\n\t\t}\n\n\t\ttargetSubGeometry.updatePositions(targetPositions);\n\t\ttargetSubGeometry.updateVertexNormals(targetNormals);\n\t\ttargetSubGeometry.updateVertexTangents(targetTangents);\n\t}\n\n\t/**\n\t * Converts a local hierarchical skeleton pose to a global pose\n\t * @param targetPose The SkeletonPose object that will contain the global pose.\n\t * @param skeleton The skeleton containing the joints, and as such, the hierarchical data to transform to global poses.\n\t */\n\tprivate localToGlobalPose(sourcePose:SkeletonPose, targetPose:SkeletonPose, skeleton:Skeleton)\n\t{\n\t\tvar globalPoses:Array<JointPose> = targetPose.jointPoses;\n\t\tvar globalJointPose:JointPose;\n\t\tvar joints:Array<SkeletonJoint> = skeleton.joints;\n\t\tvar len:number /*uint*/ = sourcePose.numJointPoses;\n\t\tvar jointPoses:Array<JointPose> = sourcePose.jointPoses;\n\t\tvar parentIndex:number /*int*/;\n\t\tvar joint:SkeletonJoint;\n\t\tvar parentPose:JointPose;\n\t\tvar pose:JointPose;\n\t\tvar or:Quaternion;\n\t\tvar tr:Vector3D;\n\t\tvar t:Vector3D;\n\t\tvar q:Quaternion;\n\n\t\tvar x1:number, y1:number, z1:number, w1:number;\n\t\tvar x2:number, y2:number, z2:number, w2:number;\n\t\tvar x3:number, y3:number, z3:number;\n\n\t\t// :s\n\t\tif (globalPoses.length != len)\n\t\t\tglobalPoses.length = len;\n\n\t\tfor (var i:number /*uint*/ = 0; i < len; ++i) {\n\t\t\tglobalJointPose = globalPoses[i];\n\n\t\t\tif (globalJointPose == null)\n\t\t\t\tglobalJointPose = globalPoses[i] = new JointPose();\n\n\t\t\tjoint = joints[i];\n\t\t\tparentIndex = joint.parentIndex;\n\t\t\tpose = jointPoses[i];\n\n\t\t\tq = globalJointPose.orientation;\n\t\t\tt = globalJointPose.translation;\n\n\t\t\tif (parentIndex < 0) {\n\t\t\t\ttr = pose.translation;\n\t\t\t\tor = pose.orientation;\n\t\t\t\tq.x = or.x;\n\t\t\t\tq.y = or.y;\n\t\t\t\tq.z = or.z;\n\t\t\t\tq.w = or.w;\n\t\t\t\tt.x = tr.x;\n\t\t\t\tt.y = tr.y;\n\t\t\t\tt.z = tr.z;\n\t\t\t} else {\n\t\t\t\t// append parent pose\n\t\t\t\tparentPose = globalPoses[parentIndex];\n\n\t\t\t\t// rotate point\n\t\t\t\tor = parentPose.orientation;\n\t\t\t\ttr = pose.translation;\n\t\t\t\tx2 = or.x;\n\t\t\t\ty2 = or.y;\n\t\t\t\tz2 = or.z;\n\t\t\t\tw2 = or.w;\n\t\t\t\tx3 = tr.x;\n\t\t\t\ty3 = tr.y;\n\t\t\t\tz3 = tr.z;\n\n\t\t\t\tw1 = -x2*x3 - y2*y3 - z2*z3;\n\t\t\t\tx1 = w2*x3 + y2*z3 - z2*y3;\n\t\t\t\ty1 = w2*y3 - x2*z3 + z2*x3;\n\t\t\t\tz1 = w2*z3 + x2*y3 - y2*x3;\n\n\t\t\t\t// append parent translation\n\t\t\t\ttr = parentPose.translation;\n\t\t\t\tt.x = -w1*x2 + x1*w2 - y1*z2 + z1*y2 + tr.x;\n\t\t\t\tt.y = -w1*y2 + x1*z2 + y1*w2 - z1*x2 + tr.y;\n\t\t\t\tt.z = -w1*z2 - x1*y2 + y1*x2 + z1*w2 + tr.z;\n\n\t\t\t\t// append parent orientation\n\t\t\t\tx1 = or.x;\n\t\t\t\ty1 = or.y;\n\t\t\t\tz1 = or.z;\n\t\t\t\tw1 = or.w;\n\t\t\t\tor = pose.orientation;\n\t\t\t\tx2 = or.x;\n\t\t\t\ty2 = or.y;\n\t\t\t\tz2 = or.z;\n\t\t\t\tw2 = or.w;\n\n\t\t\t\tq.w = w1*w2 - x1*x2 - y1*y2 - z1*z2;\n\t\t\t\tq.x = w1*x2 + x1*w2 + y1*z2 - z1*y2;\n\t\t\t\tq.y = w1*y2 - x1*z2 + y1*w2 + z1*x2;\n\t\t\t\tq.z = w1*z2 + x1*y2 - y1*x2 + z1*w2;\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate onTransitionComplete(event:AnimationStateEvent)\n\t{\n\t\tif (event.type == AnimationStateEvent.TRANSITION_COMPLETE) {\n\t\t\tevent.animationNode.removeEventListener(AnimationStateEvent.TRANSITION_COMPLETE, this._onTransitionCompleteDelegate);\n\t\t\t//if this is the current active state transition, revert control to the active node\n\t\t\tif (this._pActiveState == event.animationState) {\n\t\t\t\tthis._pActiveNode = this._pAnimationSet.getAnimation(this._pActiveAnimationName);\n\t\t\t\tthis._pActiveState = this.getAnimationState(this._pActiveNode);\n\t\t\t\tthis._activeSkeletonState = <ISkeletonAnimationState> this._pActiveState;\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate onIndicesUpdate(event:SubGeometryEvent)\n\t{\n\t\tvar subGeometry:TriangleSubGeometry = <TriangleSubGeometry> event.target;\n\n\t\t(<TriangleSubGeometry> this._morphedSubGeometry[subGeometry.id]).updateIndices(subGeometry.indices);\n\t}\n\n\tprivate onVerticesUpdate(event:SubGeometryEvent)\n\t{\n\t\tvar subGeometry:TriangleSubGeometry = <TriangleSubGeometry> event.target;\n\t\tvar morphGeometry:TriangleSubGeometry = <TriangleSubGeometry> this._morphedSubGeometry[subGeometry.id];\n\n\t\tswitch(event.dataType) {\n\t\t\tcase TriangleSubGeometry.UV_DATA:\n\t\t\t\tmorphGeometry.updateUVs(subGeometry.uvs);\n\t\t\tcase TriangleSubGeometry.SECONDARY_UV_DATA:\n\t\t\t\tmorphGeometry.updateUVs(subGeometry.secondaryUVs);\n\t\t}\n\t}\n}\n\nexport = SkeletonAnimator;","import IAnimationSet\t\t\t\t\t= require(\"awayjs-display/lib/animators/IAnimationSet\");\n\nimport Stage\t\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\n\nimport AnimationSetBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimationSetBase\");\nimport VertexAnimationMode\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/VertexAnimationMode\");\nimport ShaderObjectBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\n\n/**\n * The animation data set used by vertex-based animators, containing vertex animation state data.\n *\n * @see VertexAnimator\n */\nclass VertexAnimationSet extends AnimationSetBase implements IAnimationSet\n{\n\tprivate _numPoses:number /*uint*/;\n\tprivate _blendMode:string;\n\n\t/**\n\t * Returns the number of poses made available at once to the GPU animation code.\n\t */\n\tpublic get numPoses():number /*uint*/\n\t{\n\t\treturn this._numPoses;\n\t}\n\n\t/**\n\t * Returns the active blend mode of the vertex animator object.\n\t */\n\tpublic get blendMode():string\n\t{\n\t\treturn this._blendMode;\n\t}\n\n\t/**\n\t * Returns whether or not normal data is used in last set GPU pass of the vertex shader.\n\t */\n//\t\tpublic get useNormals():boolean\n//\t\t{\n//\t\t\treturn this._uploadNormals;\n//\t\t}\n\n\t/**\n\t * Creates a new <code>VertexAnimationSet</code> object.\n\t *\n\t * @param numPoses The number of poses made available at once to the GPU animation code.\n\t * @param blendMode Optional value for setting the animation mode of the vertex animator object.\n\t *\n\t * @see away3d.animators.data.VertexAnimationMode\n\t */\n\tconstructor(numPoses:number /*uint*/ = 2, blendMode:string = \"absolute\")\n\t{\n\t\tsuper();\n\t\tthis._numPoses = numPoses;\n\t\tthis._blendMode = blendMode;\n\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAGALVertexCode(shaderObject:ShaderObjectBase):string\n\t{\n\t\tif (this._blendMode == VertexAnimationMode.ABSOLUTE)\n\t\t\treturn this.getAbsoluteAGALCode(shaderObject);\n\t\telse\n\t\t\treturn this.getAdditiveAGALCode(shaderObject);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic activate(shaderObject:ShaderObjectBase, stage:Stage)\n\t{\n//\t\t\tvar uID:number = pass._iUniqueId;\n//\t\t\tthis._uploadNormals = <boolean> this._useNormals[uID];\n//\t\t\tthis._uploadTangents = <boolean> this._useTangents[uID];\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic deactivate(shaderObject:ShaderObjectBase, stage:Stage)\n\t{\n//\t\t\tvar uID:number = pass._iUniqueId;\n//\t\t\tvar index:number /*uint*/ = this._streamIndices[uID];\n//\t\t\tvar context:IContextGL = <IContextGL> stage.context;\n//\t\t\tcontext.setVertexBufferAt(index, null);\n//\t\t\tif (this._uploadNormals)\n//\t\t\t\tcontext.setVertexBufferAt(index + 1, null);\n//\t\t\tif (this._uploadTangents)\n//\t\t\t\tcontext.setVertexBufferAt(index + 2, null);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAGALFragmentCode(shaderObject:ShaderObjectBase, shadedTarget:string):string\n\t{\n\t\treturn \"\";\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAGALUVCode(shaderObject:ShaderObjectBase):string\n\t{\n\t\treturn \"mov \" + shaderObject.uvTarget + \",\" + shaderObject.uvSource + \"\\n\";\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic doneAGALCode(shaderObject:ShaderObjectBase)\n\t{\n\n\t}\n\n\t/**\n\t * Generates the vertex AGAL code for absolute blending.\n\t */\n\tprivate getAbsoluteAGALCode(shaderObject:ShaderObjectBase):string\n\t{\n\t\tvar code:string = \"\";\n\t\tvar temp1:string = this._pFindTempReg(shaderObject.animationTargetRegisters);\n\t\tvar temp2:string = this._pFindTempReg(shaderObject.animationTargetRegisters, temp1);\n\t\tvar regs:Array<string> = new Array<string>(\"x\", \"y\", \"z\", \"w\");\n\t\tvar len:number /*uint*/ = shaderObject.animatableAttributes.length;\n\t\tvar constantReg:string = \"vc\" + shaderObject.numUsedVertexConstants;\n\n\t\tif (len > 2)\n\t\t\tlen = 2;\n\t\tvar streamIndex:number /*uint*/ = shaderObject.numUsedStreams;\n\n\t\tfor (var i:number /*uint*/ = 0; i < len; ++i) {\n\t\t\tcode += \"mul \" + temp1 + \", \" + shaderObject.animatableAttributes[i] + \", \" + constantReg + \".\" + regs[0] + \"\\n\";\n\n\t\t\tfor (var j:number /*uint*/ = 1; j < this._numPoses; ++j) {\n\t\t\t\tcode += \"mul \" + temp2 + \", va\" + streamIndex + \", \" + constantReg + \".\" + regs[j] + \"\\n\";\n\n\t\t\t\tif (j < this._numPoses - 1)\n\t\t\t\t\tcode += \"add \" + temp1 + \", \" + temp1 + \", \" + temp2 + \"\\n\";\n\n\t\t\t\t++streamIndex;\n\t\t\t}\n\n\t\t\tcode += \"add \" + shaderObject.animationTargetRegisters[i] + \", \" + temp1 + \", \" + temp2 + \"\\n\";\n\t\t}\n\n\t\t// add code for bitangents if tangents are used\n\t\tif (shaderObject.tangentDependencies > 0 || shaderObject.outputsNormals) {\n\t\t\tcode += \"dp3 \" + temp1 + \".x, \" + shaderObject.animatableAttributes[2] + \", \" + shaderObject.animationTargetRegisters[1] + \"\\n\" +\n\t\t\t\t\"mul \" + temp1 + \", \" + shaderObject.animationTargetRegisters[1] + \", \" + temp1 + \".x\\n\" +\n\t\t\t\t\"sub \" + shaderObject.animationTargetRegisters[2] + \", \" + shaderObject.animationTargetRegisters[2] + \", \" + temp1 + \"\\n\";\n\t\t}\n\t\treturn code;\n\t}\n\n\t/**\n\t * Generates the vertex AGAL code for additive blending.\n\t */\n\tprivate getAdditiveAGALCode(shaderObject:ShaderObjectBase):string\n\t{\n\t\tvar code:string = \"\";\n\t\tvar len:number /*uint*/ = shaderObject.animatableAttributes.length;\n\t\tvar regs:Array<string> = [\"x\", \"y\", \"z\", \"w\"];\n\t\tvar temp1:string = this._pFindTempReg(shaderObject.animationTargetRegisters);\n\t\tvar k:number /*uint*/;\n\n\t\tvar streamIndex:number /*uint*/ = shaderObject.numUsedStreams;\n\n\t\tif (len > 2)\n\t\t\tlen = 2;\n\n\t\tcode += \"mov  \" + shaderObject.animationTargetRegisters[0] + \", \" + shaderObject.animatableAttributes[0] + \"\\n\";\n\t\tif (shaderObject.normalDependencies > 0)\n\t\t\tcode += \"mov \" + shaderObject.animationTargetRegisters[1] + \", \" + shaderObject.animatableAttributes[1] + \"\\n\";\n\n\t\tfor (var i:number /*uint*/ = 0; i < len; ++i) {\n\t\t\tfor (var j:number /*uint*/ = 0; j < this._numPoses; ++j) {\n\t\t\t\tcode += \"mul \" + temp1 + \", va\" + (streamIndex + k) + \", vc\" + shaderObject.numUsedVertexConstants + \".\" + regs[j] + \"\\n\" +\n\t\t\t\t\t\"add \" + shaderObject.animationTargetRegisters[i] + \", \" + shaderObject.animationTargetRegisters[i] + \", \" + temp1 + \"\\n\";\n\t\t\t\tk++;\n\t\t\t}\n\t\t}\n\n\t\tif (shaderObject.tangentDependencies > 0 || shaderObject.outputsNormals) {\n\t\t\tcode += \"dp3 \" + temp1 + \".x, \" + shaderObject.animatableAttributes[2] + \", \" + shaderObject.animationTargetRegisters[1] + \"\\n\" +\n\t\t\t\t\"mul \" + temp1 + \", \" + shaderObject.animationTargetRegisters[1] + \", \" + temp1 + \".x\\n\" +\n\t\t\t\t\"sub \" + shaderObject.animationTargetRegisters[2] + \", \" + shaderObject.animatableAttributes[2] + \", \" + temp1 + \"\\n\";\n\t\t}\n\n\t\treturn code;\n\t}\n}\n\nexport = VertexAnimationSet;","import Geometry\t\t\t\t\t\t\t= require(\"awayjs-display/lib/base/Geometry\");\nimport SubGeometryBase\t\t\t\t\t= require(\"awayjs-display/lib/base/SubGeometryBase\");\nimport TriangleSubGeometry\t\t\t\t= require(\"awayjs-display/lib/base/TriangleSubGeometry\");\nimport TriangleSubMesh\t\t\t\t\t= require(\"awayjs-display/lib/base/TriangleSubMesh\");\nimport Camera\t\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\nimport Mesh\t\t\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Mesh\");\n\nimport Stage\t\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\nimport ContextGLProgramType\t\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLProgramType\");\nimport VertexDataPool\t\t\t\t\t= require(\"awayjs-stagegl/lib/pool/VertexDataPool\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport VertexAnimationSet\t\t\t\t= require(\"awayjs-renderergl/lib/animators/VertexAnimationSet\");\nimport VertexAnimationMode\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/VertexAnimationMode\");\nimport IVertexAnimationState\t\t\t= require(\"awayjs-renderergl/lib/animators/states/IVertexAnimationState\");\nimport IAnimationTransition\t\t\t\t= require(\"awayjs-renderergl/lib/animators/transitions/IAnimationTransition\");\nimport TriangleSubMeshRenderable\t\t= require(\"awayjs-renderergl/lib/pool/TriangleSubMeshRenderable\");\nimport RenderableBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\nimport ShaderObjectBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\n\n/**\n * Provides an interface for assigning vertex-based animation data sets to mesh-based entity objects\n * and controlling the various available states of animation through an interative playhead that can be\n * automatically updated or manually triggered.\n */\nclass VertexAnimator extends AnimatorBase\n{\n\tprivate _vertexAnimationSet:VertexAnimationSet;\n\tprivate _poses:Array<Geometry> = new Array<Geometry>();\n\tprivate _weights:Array<number> = Array<number>(1, 0, 0, 0);\n\tprivate _numPoses:number /*uint*/;\n\tprivate _blendMode:string;\n\tprivate _activeVertexState:IVertexAnimationState;\n\n\t/**\n\t * Creates a new <code>VertexAnimator</code> object.\n\t *\n\t * @param vertexAnimationSet The animation data set containing the vertex animations used by the animator.\n\t */\n\tconstructor(vertexAnimationSet:VertexAnimationSet)\n\t{\n\t\tsuper(vertexAnimationSet);\n\n\t\tthis._vertexAnimationSet = vertexAnimationSet;\n\t\tthis._numPoses = vertexAnimationSet.numPoses;\n\t\tthis._blendMode = vertexAnimationSet.blendMode;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic clone():AnimatorBase\n\t{\n\t\treturn new VertexAnimator(this._vertexAnimationSet);\n\t}\n\n\t/**\n\t * Plays a sequence with a given name. If the sequence is not found, it may not be loaded yet, and it will retry every frame.\n\t * @param sequenceName The name of the clip to be played.\n\t */\n\tpublic play(name:string, transition:IAnimationTransition = null, offset:number = NaN)\n\t{\n\t\tif (this._pActiveAnimationName == name)\n\t\t\treturn;\n\n\t\tthis._pActiveAnimationName = name;\n\n\t\t//TODO: implement transitions in vertex animator\n\n\t\tif (!this._pAnimationSet.hasAnimation(name))\n\t\t\tthrow new Error(\"Animation root node \" + name + \" not found!\");\n\n\t\tthis._pActiveNode = this._pAnimationSet.getAnimation(name);\n\n\t\tthis._pActiveState = this.getAnimationState(this._pActiveNode);\n\n\t\tif (this.updatePosition) {\n\t\t\t//update straight away to reset position deltas\n\t\t\tthis._pActiveState.update(this._pAbsoluteTime);\n\t\t\tthis._pActiveState.positionDelta;\n\t\t}\n\n\t\tthis._activeVertexState = <IVertexAnimationState> this._pActiveState;\n\n\t\tthis.start();\n\n\t\t//apply a time offset if specified\n\t\tif (!isNaN(offset))\n\t\t\tthis.reset(name, offset);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _pUpdateDeltaTime(dt:number)\n\t{\n\t\tsuper._pUpdateDeltaTime(dt);\n\n\t\tvar geometryFlag:boolean = false;\n\n\t\tif (this._poses[0] != this._activeVertexState.currentGeometry) {\n\t\t\tthis._poses[0] = this._activeVertexState.currentGeometry;\n\t\t\tgeometryFlag = true;\n\t\t}\n\n\t\tif (this._poses[1] != this._activeVertexState.nextGeometry) {\n\t\t\tthis._poses[1] = this._activeVertexState.nextGeometry;\n\t\t\tgeometryFlag = true;\n\t\t}\n\n\t\tthis._weights[0] = 1 - (this._weights[1] = this._activeVertexState.blendWeight);\n\n\t\tif (geometryFlag) {\n\t\t\t//invalidate meshes\n\t\t\tvar mesh:Mesh;\n\t\t\tvar len:number = this._pOwners.length;\n\t\t\tfor (var i:number = 0; i < len; i++) {\n\t\t\t\tmesh = this._pOwners[i];\n\t\t\t\tmesh._iInvalidateRenderableGeometries();\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic setRenderState(shaderObject:ShaderObjectBase, renderable:RenderableBase, stage:Stage, camera:Camera, vertexConstantOffset:number /*int*/, vertexStreamOffset:number /*int*/)\n\t{\n\t\t// todo: add code for when running on cpu\n\n\t\t// if no poses defined, set temp data\n\t\tif (!this._poses.length) {\n\t\t\tthis.setNullPose(shaderObject, renderable, stage, vertexConstantOffset, vertexStreamOffset);\n\t\t\treturn;\n\t\t}\n\n\t\t// this type of animation can only be SubMesh\n\t\tvar subMesh:TriangleSubMesh = <TriangleSubMesh> (<TriangleSubMeshRenderable> renderable).subMesh;\n\t\tvar subGeom:SubGeometryBase;\n\t\tvar i:number /*uint*/;\n\t\tvar len:number /*uint*/ = this._numPoses;\n\n\t\tstage.context.setProgramConstantsFromArray(ContextGLProgramType.VERTEX, vertexConstantOffset, this._weights, 1);\n\n\t\tif (this._blendMode == VertexAnimationMode.ABSOLUTE)\n\t\t\ti = 1;\n\t\telse\n\t\t\ti = 0;\n\n\t\tfor (; i < len; ++i) {\n\t\t\tsubGeom = this._poses[i].subGeometries[subMesh._iIndex] || subMesh.subGeometry;\n\n\t\t\tstage.activateBuffer(vertexStreamOffset++, VertexDataPool.getItem(subGeom, renderable.getIndexData(), TriangleSubGeometry.POSITION_DATA), subGeom.getOffset(TriangleSubGeometry.POSITION_DATA), TriangleSubGeometry.POSITION_FORMAT);\n\n\t\t\tif (shaderObject.normalDependencies > 0)\n\t\t\t\tstage.activateBuffer(vertexStreamOffset++, VertexDataPool.getItem(subGeom, renderable.getIndexData(), TriangleSubGeometry.NORMAL_DATA), subGeom.getOffset(TriangleSubGeometry.NORMAL_DATA), TriangleSubGeometry.NORMAL_FORMAT);\n\t\t}\n\t}\n\n\tprivate setNullPose(shaderObject:ShaderObjectBase, renderable:RenderableBase, stage:Stage, vertexConstantOffset:number /*int*/, vertexStreamOffset:number /*int*/)\n\t{\n\t\tstage.context.setProgramConstantsFromArray(ContextGLProgramType.VERTEX, vertexConstantOffset, this._weights, 1);\n\n\t\tif (this._blendMode == VertexAnimationMode.ABSOLUTE) {\n\t\t\tvar len:number /*uint*/ = this._numPoses;\n\t\t\tfor (var i:number /*uint*/ = 1; i < len; ++i) {\n\t\t\t\tstage.activateBuffer(vertexStreamOffset++, renderable.getVertexData(TriangleSubGeometry.POSITION_DATA), renderable.getVertexOffset(TriangleSubGeometry.POSITION_DATA), TriangleSubGeometry.POSITION_FORMAT);\n\n\t\t\t\tif (shaderObject.normalDependencies > 0)\n\t\t\t\t\tstage.activateBuffer(vertexStreamOffset++, renderable.getVertexData(TriangleSubGeometry.NORMAL_DATA), renderable.getVertexOffset(TriangleSubGeometry.NORMAL_DATA), TriangleSubGeometry.NORMAL_FORMAT);\n\t\t\t}\n\t\t}\n\t\t// todo: set temp data for additive?\n\t}\n\n\t/**\n\t * Verifies if the animation will be used on cpu. Needs to be true for all passes for a material to be able to use it on gpu.\n\t * Needs to be called if gpu code is potentially required.\n\t */\n\tpublic testGPUCompatibility(shaderObject:ShaderObjectBase)\n\t{\n\t}\n\n\tpublic getRenderableSubGeometry(renderable:TriangleSubMeshRenderable, sourceSubGeometry:TriangleSubGeometry):TriangleSubGeometry\n\t{\n\t\tif (this._blendMode == VertexAnimationMode.ABSOLUTE && this._poses.length)\n\t\t\treturn <TriangleSubGeometry> this._poses[0].subGeometries[renderable.subMesh._iIndex] || sourceSubGeometry;\n\n\t\t//nothing to do here\n\t\treturn sourceSubGeometry;\n\t}\n}\n\nexport = VertexAnimator;","import Matrix3D\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3D\");\n\nimport AnimationNodeBase\t\t\t= require(\"awayjs-display/lib/animators/nodes/AnimationNodeBase\");\n\nimport ShaderRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterCache\");\nimport ShaderRegisterElement\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\n\n\n/**\n * ...\n */\nclass AnimationRegisterCache extends ShaderRegisterCache\n{\n\t//vertex\n\tpublic positionAttribute:ShaderRegisterElement;\n\tpublic uvAttribute:ShaderRegisterElement;\n\tpublic positionTarget:ShaderRegisterElement;\n\tpublic scaleAndRotateTarget:ShaderRegisterElement;\n\tpublic velocityTarget:ShaderRegisterElement;\n\tpublic vertexTime:ShaderRegisterElement;\n\tpublic vertexLife:ShaderRegisterElement;\n\tpublic vertexZeroConst:ShaderRegisterElement;\n\tpublic vertexOneConst:ShaderRegisterElement;\n\tpublic vertexTwoConst:ShaderRegisterElement;\n\tpublic uvTarget:ShaderRegisterElement;\n\tpublic colorAddTarget:ShaderRegisterElement;\n\tpublic colorMulTarget:ShaderRegisterElement;\n\t//vary\n\tpublic colorAddVary:ShaderRegisterElement;\n\tpublic colorMulVary:ShaderRegisterElement;\n\n\t//fragment\n\n\tpublic uvVar:ShaderRegisterElement;\n\n\t//these are targets only need to rotate ( normal and tangent )\n\tpublic rotationRegisters:Array<ShaderRegisterElement>;\n\n\tpublic needFragmentAnimation:boolean;\n\tpublic needUVAnimation:boolean;\n\n\tpublic sourceRegisters:Array<string>;\n\tpublic targetRegisters:Array<string>;\n\n\tprivate indexDictionary:Object = new Object();\n\n\t//set true if has an node which will change UV\n\tpublic hasUVNode:boolean;\n\t//set if the other nodes need to access the velocity\n\tpublic needVelocity:boolean;\n\t//set if has a billboard node.\n\tpublic hasBillboard:boolean;\n\t//set if has an node which will apply color multiple operation\n\tpublic hasColorMulNode:boolean;\n\t//set if has an node which will apply color add operation\n\tpublic hasColorAddNode:boolean;\n\n\tconstructor(profile:string)\n\t{\n\t\tsuper(profile);\n\t}\n\n\tpublic reset()\n\t{\n\t\tsuper.reset();\n\n\t\tthis.rotationRegisters = new Array<ShaderRegisterElement>();\n\t\tthis.positionAttribute = this.getRegisterFromString(this.sourceRegisters[0]);\n\t\tthis.scaleAndRotateTarget = this.getRegisterFromString(this.targetRegisters[0]);\n\t\tthis.addVertexTempUsages(this.scaleAndRotateTarget, 1);\n\n\t\tfor (var i:number /*int*/ = 1; i < this.targetRegisters.length; i++) {\n\t\t\tthis.rotationRegisters.push(this.getRegisterFromString(this.targetRegisters[i]));\n\t\t\tthis.addVertexTempUsages(this.rotationRegisters[i - 1], 1);\n\t\t}\n\n\t\tthis.scaleAndRotateTarget = new ShaderRegisterElement(this.scaleAndRotateTarget.regName, this.scaleAndRotateTarget.index); //only use xyz, w is used as vertexLife\n\n\t\t//allot const register\n\n\t\tthis.vertexZeroConst = this.getFreeVertexConstant();\n\t\tthis.vertexZeroConst = new ShaderRegisterElement(this.vertexZeroConst.regName, this.vertexZeroConst.index, 0);\n\t\tthis.vertexOneConst = new ShaderRegisterElement(this.vertexZeroConst.regName, this.vertexZeroConst.index, 1);\n\t\tthis.vertexTwoConst = new ShaderRegisterElement(this.vertexZeroConst.regName, this.vertexZeroConst.index, 2);\n\n\t\t//allot temp register\n\t\tthis.positionTarget = this.getFreeVertexVectorTemp();\n\t\tthis.addVertexTempUsages(this.positionTarget, 1);\n\t\tthis.positionTarget = new ShaderRegisterElement(this.positionTarget.regName, this.positionTarget.index);\n\n\t\tif (this.needVelocity) {\n\t\t\tthis.velocityTarget = this.getFreeVertexVectorTemp();\n\t\t\tthis.addVertexTempUsages(this.velocityTarget, 1);\n\t\t\tthis.velocityTarget = new ShaderRegisterElement(this.velocityTarget.regName, this.velocityTarget.index);\n\t\t\tthis.vertexTime = new ShaderRegisterElement(this.velocityTarget.regName, this.velocityTarget.index, 3);\n\t\t\tthis.vertexLife = new ShaderRegisterElement(this.positionTarget.regName, this.positionTarget.index, 3);\n\t\t} else {\n\t\t\tvar tempTime:ShaderRegisterElement = this.getFreeVertexVectorTemp();\n\t\t\tthis.addVertexTempUsages(tempTime, 1);\n\t\t\tthis.vertexTime = new ShaderRegisterElement(tempTime.regName, tempTime.index, 0);\n\t\t\tthis.vertexLife = new ShaderRegisterElement(tempTime.regName, tempTime.index, 1);\n\t\t}\n\n\t}\n\n\tpublic setUVSourceAndTarget(UVAttribute:string, UVVaring:string)\n\t{\n\t\tthis.uvVar = this.getRegisterFromString(UVVaring);\n\t\tthis.uvAttribute = this.getRegisterFromString(UVAttribute);\n\t\t//uv action is processed after normal actions,so use offsetTarget as uvTarget\n\t\tthis.uvTarget = new ShaderRegisterElement(this.positionTarget.regName, this.positionTarget.index);\n\t}\n\n\tpublic setRegisterIndex(node:AnimationNodeBase, parameterIndex:number /*int*/, registerIndex:number /*int*/)\n\t{\n\t\t//8 should be enough for any node.\n\t\tvar t:Array<number> /*int*/ = this.indexDictionary[node.id];\n\n\t\tif (t == null)\n\t\t\tt = this.indexDictionary[node.id] = new Array<number>(8) /*int*/;\n\n\t\tt[parameterIndex] = registerIndex;\n\t}\n\n\tpublic getRegisterIndex(node:AnimationNodeBase, parameterIndex:number /*int*/):number /*int*/\n\t{\n\t\treturn (<Array<number>> this.indexDictionary[node.id])[parameterIndex];\n\t}\n\n\tpublic getInitCode():string\n\t{\n\t\tvar len:number /*int*/ = this.sourceRegisters.length;\n\t\tvar code:string = \"\";\n\t\tfor (var i:number /*int*/ = 0; i < len; i++)\n\t\t\tcode += \"mov \" + this.targetRegisters[i] + \",\" + this.sourceRegisters[i] + \"\\n\";\n\n\t\tcode += \"mov \" + this.positionTarget + \".xyz,\" + this.vertexZeroConst.toString() + \"\\n\";\n\n\t\tif (this.needVelocity)\n\t\t\tcode += \"mov \" + this.velocityTarget + \".xyz,\" + this.vertexZeroConst.toString() + \"\\n\";\n\n\t\treturn code;\n\t}\n\n\tpublic getCombinationCode():string\n\t{\n\t\treturn \"add \" + this.scaleAndRotateTarget + \".xyz,\" + this.scaleAndRotateTarget + \".xyz,\" + this.positionTarget + \".xyz\\n\";\n\t}\n\n\tpublic initColorRegisters():string\n\t{\n\t\tvar code:string = \"\";\n\t\tif (this.hasColorMulNode) {\n\t\t\tthis.colorMulTarget = this.getFreeVertexVectorTemp();\n\t\t\tthis.addVertexTempUsages(this.colorMulTarget, 1);\n\t\t\tthis.colorMulVary = this.getFreeVarying();\n\t\t\tcode += \"mov \" + this.colorMulTarget + \",\" + this.vertexOneConst + \"\\n\";\n\t\t}\n\t\tif (this.hasColorAddNode) {\n\t\t\tthis.colorAddTarget = this.getFreeVertexVectorTemp();\n\t\t\tthis.addVertexTempUsages(this.colorAddTarget, 1);\n\t\t\tthis.colorAddVary = this.getFreeVarying();\n\t\t\tcode += \"mov \" + this.colorAddTarget + \",\" + this.vertexZeroConst + \"\\n\";\n\t\t}\n\t\treturn code;\n\t}\n\n\tpublic getColorPassCode():string\n\t{\n\t\tvar code:string = \"\";\n\t\tif (this.needFragmentAnimation && (this.hasColorAddNode || this.hasColorMulNode)) {\n\t\t\tif (this.hasColorMulNode)\n\t\t\t\tcode += \"mov \" + this.colorMulVary + \",\" + this.colorMulTarget + \"\\n\";\n\t\t\tif (this.hasColorAddNode)\n\t\t\t\tcode += \"mov \" + this.colorAddVary + \",\" + this.colorAddTarget + \"\\n\";\n\t\t}\n\t\treturn code;\n\t}\n\n\tpublic getColorCombinationCode(shadedTarget:string):string\n\t{\n\t\tvar code:string = \"\";\n\t\tif (this.needFragmentAnimation && (this.hasColorAddNode || this.hasColorMulNode)) {\n\t\t\tvar colorTarget:ShaderRegisterElement = this.getRegisterFromString(shadedTarget);\n\t\t\tthis.addFragmentTempUsages(colorTarget, 1);\n\t\t\tif (this.hasColorMulNode)\n\t\t\t\tcode += \"mul \" + colorTarget + \",\" + colorTarget + \",\" + this.colorMulVary + \"\\n\";\n\t\t\tif (this.hasColorAddNode)\n\t\t\t\tcode += \"add \" + colorTarget + \",\" + colorTarget + \",\" + this.colorAddVary + \"\\n\";\n\t\t}\n\t\treturn code;\n\t}\n\n\tprivate getRegisterFromString(code:string):ShaderRegisterElement\n\t{\n\t\tvar temp:Array<string> = code.split(/(\\d+)/);\n\t\treturn new ShaderRegisterElement(temp[0], parseInt(temp[1]));\n\t}\n\n\tpublic vertexConstantData:Array<number> = new Array<number>();\n\tpublic fragmentConstantData:Array<number> = new Array<number>();\n\n\tprivate _numVertexConstant:number /*int*/;\n\tprivate _numFragmentConstant:number /*int*/;\n\n\tpublic get numVertexConstant():number /*int*/\n\t{\n\t\treturn this._numVertexConstant;\n\t}\n\n\tpublic get numFragmentConstant():number /*int*/\n\t{\n\t\treturn this._numFragmentConstant;\n\t}\n\n\tpublic setDataLength()\n\t{\n\t\tthis._numVertexConstant = this.numUsedVertexConstants - this.vertexConstantOffset;\n\t\tthis._numFragmentConstant = this.numUsedFragmentConstants - this.fragmentConstantOffset;\n\t\tthis.vertexConstantData.length = this._numVertexConstant*4;\n\t\tthis.fragmentConstantData.length = this._numFragmentConstant*4;\n\t}\n\n\tpublic setVertexConst(index:number /*int*/, x:number = 0, y:number = 0, z:number = 0, w:number = 0)\n\t{\n\t\tvar _index:number /*int*/ = (index - this.vertexConstantOffset)*4;\n\t\tthis.vertexConstantData[_index++] = x;\n\t\tthis.vertexConstantData[_index++] = y;\n\t\tthis.vertexConstantData[_index++] = z;\n\t\tthis.vertexConstantData[_index] = w;\n\t}\n\n\tpublic setVertexConstFromArray(index:number /*int*/, data:Array<number>)\n\t{\n\t\tvar _index:number /*int*/ = (index - this.vertexConstantOffset)*4;\n\t\tfor (var i:number /*int*/ = 0; i < data.length; i++)\n\t\t\tthis.vertexConstantData[_index++] = data[i];\n\t}\n\n\tpublic setVertexConstFromMatrix(index:number /*int*/, matrix:Matrix3D)\n\t{\n\t\tvar rawData:Array<number> = matrix.rawData;\n\t\tvar _index:number /*int*/ = (index - this.vertexConstantOffset)*4;\n\t\tthis.vertexConstantData[_index++] = rawData[0];\n\t\tthis.vertexConstantData[_index++] = rawData[4];\n\t\tthis.vertexConstantData[_index++] = rawData[8];\n\t\tthis.vertexConstantData[_index++] = rawData[12];\n\t\tthis.vertexConstantData[_index++] = rawData[1];\n\t\tthis.vertexConstantData[_index++] = rawData[5];\n\t\tthis.vertexConstantData[_index++] = rawData[9];\n\t\tthis.vertexConstantData[_index++] = rawData[13];\n\t\tthis.vertexConstantData[_index++] = rawData[2];\n\t\tthis.vertexConstantData[_index++] = rawData[6];\n\t\tthis.vertexConstantData[_index++] = rawData[10];\n\t\tthis.vertexConstantData[_index++] = rawData[14];\n\t\tthis.vertexConstantData[_index++] = rawData[3];\n\t\tthis.vertexConstantData[_index++] = rawData[7];\n\t\tthis.vertexConstantData[_index++] = rawData[11];\n\t\tthis.vertexConstantData[_index] = rawData[15];\n\n\t}\n\n\tpublic setFragmentConst(index:number /*int*/, x:number = 0, y:number = 0, z:number = 0, w:number = 0)\n\t{\n\t\tvar _index:number /*int*/ = (index - this.fragmentConstantOffset)*4;\n\t\tthis.fragmentConstantData[_index++] = x;\n\t\tthis.fragmentConstantData[_index++] = y;\n\t\tthis.fragmentConstantData[_index++] = z;\n\t\tthis.fragmentConstantData[_index] = w;\n\t}\n}\n\nexport = AnimationRegisterCache;","import Stage\t\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\nimport IContextGL\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/IContextGL\");\nimport IVertexBuffer\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/IVertexBuffer\");\n\nimport ParticleAnimationData\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticleAnimationData\");\n\n/**\n * ...\n */\nclass AnimationSubGeometry\n{\n\tpublic static SUBGEOM_ID_COUNT:number = 0;\n\n\tpublic _pVertexData:Array<number>;\n\n\tpublic _pVertexBuffer:Array<IVertexBuffer> = new Array<IVertexBuffer>(8);\n\tpublic _pBufferContext:Array<IContextGL> = new Array<IContextGL>(8);\n\tpublic _pBufferDirty:Array<boolean> = new Array<boolean>(8);\n\n\tprivate _numVertices:number /*uint*/;\n\n\tprivate _totalLenOfOneVertex:number /*uint*/;\n\n\tpublic numProcessedVertices:number /*int*/ = 0;\n\n\tpublic previousTime:number = Number.NEGATIVE_INFINITY;\n\n\tpublic animationParticles:Array<ParticleAnimationData> = new Array<ParticleAnimationData>();\n\n\t/**\n\t * An id for this animation subgeometry, used to identify animation subgeometries when using animation sets.\n\t *\n\t * @private\n\t */\n\tpublic _iUniqueId:number;//Arcane\n\n\tconstructor()\n\t{\n\t\tfor (var i:number /*int*/ = 0; i < 8; i++)\n\t\t\tthis._pBufferDirty[i] = true;\n\n\t\tthis._iUniqueId = AnimationSubGeometry.SUBGEOM_ID_COUNT++;\n\t}\n\n\tpublic createVertexData(numVertices:number /*uint*/, totalLenOfOneVertex:number /*uint*/)\n\t{\n\t\tthis._numVertices = numVertices;\n\t\tthis._totalLenOfOneVertex = totalLenOfOneVertex;\n\t\tthis._pVertexData = new Array<number>(numVertices*totalLenOfOneVertex);\n\t}\n\n\tpublic activateVertexBuffer(index:number /*int*/, bufferOffset:number /*int*/, stage:Stage, format:string)\n\t{\n\t\tvar contextIndex:number /*int*/ = stage.stageIndex;\n\t\tvar context:IContextGL = <IContextGL> stage.context;\n\n\t\tvar buffer:IVertexBuffer = this._pVertexBuffer[contextIndex];\n\t\tif (!buffer || this._pBufferContext[contextIndex] != context) {\n\t\t\tbuffer = this._pVertexBuffer[contextIndex] = context.createVertexBuffer(this._numVertices, this._totalLenOfOneVertex);\n\t\t\tthis._pBufferContext[contextIndex] = context;\n\t\t\tthis._pBufferDirty[contextIndex] = true;\n\t\t}\n\t\tif (this._pBufferDirty[contextIndex]) {\n\t\t\tbuffer.uploadFromArray(this._pVertexData, 0, this._numVertices);\n\t\t\tthis._pBufferDirty[contextIndex] = false;\n\t\t}\n\t\tcontext.setVertexBufferAt(index, buffer, bufferOffset, format);\n\t}\n\n\tpublic dispose()\n\t{\n\t\twhile (this._pVertexBuffer.length) {\n\t\t\tvar vertexBuffer:IVertexBuffer = this._pVertexBuffer.pop()\n\n\t\t\tif (vertexBuffer)\n\t\t\t\tvertexBuffer.dispose();\n\t\t}\n\t}\n\n\tpublic invalidateBuffer()\n\t{\n\t\tfor (var i:number /*int*/ = 0; i < 8; i++)\n\t\t\tthis._pBufferDirty[i] = true;\n\t}\n\n\tpublic get vertexData():Array<number>\n\t{\n\t\treturn this._pVertexData;\n\t}\n\n\tpublic get numVertices():number /*uint*/\n\t{\n\t\treturn this._numVertices;\n\t}\n\n\tpublic get totalLenOfOneVertex():number /*uint*/\n\t{\n\t\treturn this._totalLenOfOneVertex;\n\t}\n}\n\nexport = AnimationSubGeometry;","import ColorTransform\t\t\t\t\t= require(\"awayjs-core/lib/geom/ColorTransform\");\n\nclass ColorSegmentPoint\n{\n\tprivate _color:ColorTransform;\n\tprivate _life:number;\n\n\tconstructor(life:number, color:ColorTransform)\n\t{\n\t\t//0<life<1\n\t\tif (life <= 0 || life >= 1)\n\t\t\tthrow(new Error(\"life exceeds range (0,1)\"));\n\t\tthis._life = life;\n\t\tthis._color = color;\n\t}\n\n\tpublic get color():ColorTransform\n\t{\n\t\treturn this._color;\n\t}\n\n\tpublic get life():number\n\t{\n\t\treturn this._life;\n\t}\n\n}\n\nexport = ColorSegmentPoint;","import Matrix3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3D\");\nimport Quaternion\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Quaternion\");\nimport Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\n/**\n * Contains transformation data for a skeleton joint, used for skeleton animation.\n *\n * @see away.animation.Skeleton\n * @see away.animation.SkeletonJoint\n *\n * todo: support (uniform) scale\n */\nclass JointPose\n{\n\t/**\n\t * The name of the joint to which the pose is associated\n\t */\n\tpublic name:string; // intention is that this should be used only at load time, not in the main loop\n\n\t/**\n\t * The rotation of the pose stored as a quaternion\n\t */\n\tpublic orientation:Quaternion = new Quaternion();\n\n\t/**\n\t * The translation of the pose\n\t */\n\tpublic translation:Vector3D = new Vector3D();\n\n\tconstructor()\n\t{\n\n\t}\n\n\t/**\n\t * Converts the transformation to a Matrix3D representation.\n\t *\n\t * @param target An optional target matrix to store the transformation. If not provided, it will create a new instance.\n\t * @return The transformation matrix of the pose.\n\t */\n\tpublic toMatrix3D(target:Matrix3D = null):Matrix3D\n\t{\n\t\tif (target == null)\n\t\t\ttarget = new Matrix3D();\n\n\t\tthis.orientation.toMatrix3D(target);\n\t\ttarget.appendTranslation(this.translation.x, this.translation.y, this.translation.z);\n\t\treturn target;\n\t}\n\n\t/**\n\t * Copies the transformation data from a source pose object into the existing pose object.\n\t *\n\t * @param pose The source pose to copy from.\n\t */\n\tpublic copyFrom(pose:JointPose)\n\t{\n\t\tvar or:Quaternion = pose.orientation;\n\t\tvar tr:Vector3D = pose.translation;\n\t\tthis.orientation.x = or.x;\n\t\tthis.orientation.y = or.y;\n\t\tthis.orientation.z = or.z;\n\t\tthis.orientation.w = or.w;\n\t\tthis.translation.x = tr.x;\n\t\tthis.translation.y = tr.y;\n\t\tthis.translation.z = tr.z;\n\t}\n}\n\nexport = JointPose;","import ParticleData\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticleData\");\n\n/**\n * ...\n */\nclass ParticleAnimationData\n{\n\tpublic index:number /*uint*/;\n\tpublic startTime:number;\n\tpublic totalTime:number;\n\tpublic duration:number;\n\tpublic delay:number;\n\tpublic startVertexIndex:number /*uint*/;\n\tpublic numVertices:number /*uint*/;\n\n\tconstructor(index:number /*uint*/, startTime:number, duration:number, delay:number, particle:ParticleData)\n\t{\n\t\tthis.index = index;\n\t\tthis.startTime = startTime;\n\t\tthis.totalTime = duration + delay;\n\t\tthis.duration = duration;\n\t\tthis.delay = delay;\n\t\tthis.startVertexIndex = particle.startVertexIndex;\n\t\tthis.numVertices = particle.numVertices;\n\t}\n}\n\nexport = ParticleAnimationData;","import TriangleSubGeometry\t\t\t\t= require(\"awayjs-display/lib/base/TriangleSubGeometry\");\n\nclass ParticleData\n{\n\tpublic particleIndex:number /*uint*/;\n\tpublic numVertices:number /*uint*/;\n\tpublic startVertexIndex:number /*uint*/;\n\tpublic subGeometry:TriangleSubGeometry;\n}\n\nexport = ParticleData","/**\n * Options for setting the properties mode of a particle animation node.\n */\nclass ParticlePropertiesMode\n{\n\t/**\n\t * Mode that defines the particle node as acting on global properties (ie. the properties set in the node constructor or the corresponding animation state).\n\t */\n\tpublic static GLOBAL:number /*uint*/ = 0;\n\n\t/**\n\t * Mode that defines the particle node as acting on local static properties (ie. the properties of particles set in the initialising on the animation set).\n\t */\n\tpublic static LOCAL_STATIC:number /*uint*/ = 1;\n\n\t/**\n\t * Mode that defines the particle node as acting on local dynamic properties (ie. the properties of the particles set in the corresponding animation state).\n\t */\n\tpublic static LOCAL_DYNAMIC:number /*uint*/ = 2;\n}\n\nexport = ParticlePropertiesMode;","/**\n * Dynamic class for holding the local properties of a particle, used for processing the static properties\n * of particles in the particle animation set before beginning upload to the GPU.\n */\nclass ParticleProperties\n{\n\t/**\n\t * The index of the current particle being set.\n\t */\n\tpublic index:number /*uint*/;\n\n\t/**\n\t * The total number of particles being processed by the particle animation set.\n\t */\n\tpublic total:number /*uint*/;\n\n\t/**\n\t * The start time of the particle.\n\t */\n\tpublic startTime:number;\n\n\t/**\n\t * The duration of the particle, an optional value used when the particle aniamtion set settings for <code>useDuration</code> are enabled in the constructor.\n\t *\n\t * @see away.animators.ParticleAnimationSet\n\t */\n\tpublic duration:number;\n\n\t/**\n\t * The delay between cycles of the particle, an optional value used when the particle aniamtion set settings for <code>useLooping</code> and  <code>useDelay</code> are enabled in the constructor.\n\t *\n\t * @see away.animators.ParticleAnimationSet\n\t */\n\tpublic delay:number;\n}\n\nexport = ParticleProperties;","/**\n * A value obect representing a single joint in a skeleton object.\n *\n * @see away.animators.Skeleton\n */\nclass SkeletonJoint\n{\n\t/**\n\t * The index of the parent joint in the skeleton's joints vector.\n\t *\n\t * @see away.animators.Skeleton#joints\n\t */\n\tpublic parentIndex:number /*int*/ = -1;\n\n\t/**\n\t * The name of the joint\n\t */\n\tpublic name:string; // intention is that this should be used only at load time, not in the main loop\n\n\t/**\n\t * The inverse bind pose matrix, as raw data, used to transform vertices to bind joint space in preparation for transformation using the joint matrix.\n\t */\n\tpublic inverseBindPose:Array<number>;\n\n\t/**\n\t * Creates a new <code>SkeletonJoint</code> object\n\t */\n\tconstructor()\n\t{\n\t}\n}\n\nexport = SkeletonJoint;","import AssetType\t\t\t\t\t\t= require(\"awayjs-core/lib/library/AssetType\");\nimport IAsset\t\t\t\t\t\t\t= require(\"awayjs-core/lib/library/IAsset\");\nimport NamedAssetBase\t\t\t\t\t= require(\"awayjs-core/lib/library/NamedAssetBase\");\n\nimport JointPose\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/JointPose\");\n\n\n/**\n * A collection of pose objects, determining the pose for an entire skeleton.\n * The <code>jointPoses</code> vector object corresponds to a skeleton's <code>joints</code> vector object, however, there is no\n * reference to a skeleton's instance, since several skeletons can be influenced by the same pose (eg: animation\n * clips are added to any animator with a valid skeleton)\n *\n * @see away.animators.Skeleton\n * @see away.animators.JointPose\n */\nclass SkeletonPose extends NamedAssetBase implements IAsset\n{\n\t/**\n\t * A flat list of pose objects that comprise the skeleton pose. The pose indices correspond to the target skeleton's joint indices.\n\t *\n\t * @see away.animators.Skeleton#joints\n\t */\n\tpublic jointPoses:Array<JointPose>;\n\n\t/**\n\t * The total number of joint poses in the skeleton pose.\n\t */\n\tpublic get numJointPoses():number /*uint*/\n\t{\n\t\treturn this.jointPoses.length;\n\t}\n\n\t/**\n\t * Creates a new <code>SkeletonPose</code> object.\n\t */\n\tconstructor()\n\t{\n\t\tsuper();\n\n\t\tthis.jointPoses = new Array<JointPose>();\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic get assetType():string\n\t{\n\t\treturn AssetType.SKELETON_POSE;\n\t}\n\n\t/**\n\t * Returns the joint pose object with the given joint name, otherwise returns a null object.\n\t *\n\t * @param jointName The name of the joint object whose pose is to be found.\n\t * @return The pose object with the given joint name.\n\t */\n\tpublic jointPoseFromName(jointName:string):JointPose\n\t{\n\t\tvar jointPoseIndex:number /*int*/ = this.jointPoseIndexFromName(jointName);\n\t\tif (jointPoseIndex != -1)\n\t\t\treturn this.jointPoses[jointPoseIndex]; else\n\t\t\treturn null;\n\t}\n\n\t/**\n\t * Returns the pose index, given the joint name. -1 is returned if the joint name is not found in the pose.\n\t *\n\t * @param The name of the joint object whose pose is to be found.\n\t * @return The index of the pose object in the jointPoses Array\n\t *\n\t * @see #jointPoses\n\t */\n\tpublic jointPoseIndexFromName(jointName:string):number /*int*/\n\t{\n\t\t// this is implemented as a linear search, rather than a possibly\n\t\t// more optimal method (Dictionary lookup, for example) because:\n\t\t// a) it is assumed that it will be called once for each joint\n\t\t// b) it is assumed that it will be called only during load, and not during main loop\n\t\t// c) maintaining a dictionary (for safety) would dictate an interface to access JointPoses,\n\t\t//    rather than direct array access.  this would be sub-optimal.\n\t\tvar jointPoseIndex:number /*int*/;\n\t\tvar jointPose:JointPose;\n\t\tfor (var i:number /*uint*/; i < this.jointPoses.length; i++) {\n\t\t\tjointPose = this.jointPoses[i];\n\t\t\tif (jointPose.name == jointName)\n\t\t\t\treturn jointPoseIndex;\n\t\t\tjointPoseIndex++;\n\t\t}\n\n\t\treturn -1;\n\t}\n\n\t/**\n\t * Creates a copy of the <code>SkeletonPose</code> object, with a dulpicate of its component joint poses.\n\t *\n\t * @return SkeletonPose\n\t */\n\tpublic clone():SkeletonPose\n\t{\n\t\tvar clone:SkeletonPose = new SkeletonPose();\n\t\tvar numJointPoses:number /*uint*/ = this.jointPoses.length;\n\t\tfor (var i:number /*uint*/ = 0; i < numJointPoses; i++) {\n\t\t\tvar cloneJointPose:JointPose = new JointPose();\n\t\t\tvar thisJointPose:JointPose = this.jointPoses[i];\n\t\t\tcloneJointPose.name = thisJointPose.name;\n\t\t\tcloneJointPose.copyFrom(thisJointPose);\n\t\t\tclone.jointPoses[i] = cloneJointPose;\n\t\t}\n\t\treturn clone;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic dispose()\n\t{\n\t\tthis.jointPoses.length = 0;\n\t}\n}\n\nexport = SkeletonPose;","import SkeletonJoint\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/SkeletonJoint\");\n\nimport AssetType\t\t\t\t\t\t= require(\"awayjs-core/lib/library/AssetType\");\nimport IAsset\t\t\t\t\t\t\t= require(\"awayjs-core/lib/library/IAsset\");\nimport NamedAssetBase\t\t\t\t\t= require(\"awayjs-core/lib/library/NamedAssetBase\");\n\n/**\n * A Skeleton object is a hierarchical grouping of joint objects that can be used for skeletal animation.\n *\n * @see away.animators.SkeletonJoint\n */\nclass Skeleton extends NamedAssetBase implements IAsset\n{\n\t/**\n\t * A flat list of joint objects that comprise the skeleton. Every joint except for the root has a parentIndex\n\t * property that is an index into this list.\n\t * A child joint should always have a higher index than its parent.\n\t */\n\tpublic joints:Array<SkeletonJoint>;\n\n\t/**\n\t * The total number of joints in the skeleton.\n\t */\n\tpublic get numJoints():number /*uint*/\n\t{\n\t\treturn this.joints.length;\n\t}\n\n\t/**\n\t * Creates a new <code>Skeleton</code> object\n\t */\n\tconstructor()\n\t{\n\t\tsuper();\n\n\t\t// in the long run, it might be a better idea to not store Joint objects, but keep all data in Vectors, that we can upload easily?\n\t\tthis.joints = new Array<SkeletonJoint>();\n\t}\n\n\t/**\n\t * Returns the joint object in the skeleton with the given name, otherwise returns a null object.\n\t *\n\t * @param jointName The name of the joint object to be found.\n\t * @return The joint object with the given name.\n\t *\n\t * @see #joints\n\t */\n\tpublic jointFromName(jointName:string):SkeletonJoint\n\t{\n\t\tvar jointIndex:number /*int*/ = this.jointIndexFromName(jointName);\n\t\tif (jointIndex != -1)\n\t\t\treturn this.joints[jointIndex]; else\n\t\t\treturn null;\n\t}\n\n\t/**\n\t * Returns the joint index, given the joint name. -1 is returned if the joint name is not found.\n\t *\n\t * @param jointName The name of the joint object to be found.\n\t * @return The index of the joint object in the joints Array\n\t *\n\t * @see #joints\n\t */\n\tpublic jointIndexFromName(jointName:string):number /*int*/\n\t{\n\t\t// this is implemented as a linear search, rather than a possibly\n\t\t// more optimal method (Dictionary lookup, for example) because:\n\t\t// a) it is assumed that it will be called once for each joint\n\t\t// b) it is assumed that it will be called only during load, and not during main loop\n\t\t// c) maintaining a dictionary (for safety) would dictate an interface to access SkeletonJoints,\n\t\t//    rather than direct array access.  this would be sub-optimal.\n\t\tvar jointIndex:number /*int*/;\n\t\tvar joint:SkeletonJoint;\n\t\tfor (var i:number /*int*/; i < this.joints.length; i++) {\n\t\t\tjoint = this.joints[i];\n\t\t\tif (joint.name == jointName)\n\t\t\t\treturn jointIndex;\n\t\t\tjointIndex++;\n\t\t}\n\n\t\treturn -1;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic dispose()\n\t{\n\t\tthis.joints.length = 0;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic get assetType():string\n\t{\n\t\treturn AssetType.SKELETON;\n\t}\n}\n\nexport = Skeleton;","/**\n * Options for setting the animation mode of a vertex animator object.\n *\n * @see away.animators.VertexAnimator\n */\nclass VertexAnimationMode\n{\n\t/**\n\t * Animation mode that adds all outputs from active vertex animation state to form the current vertex animation pose.\n\t */\n\tpublic static ADDITIVE:string = \"additive\";\n\n\t/**\n\t * Animation mode that picks the output from a single vertex animation state to form the current vertex animation pose.\n\t */\n\tpublic static ABSOLUTE:string = \"absolute\";\n}\n\nexport = VertexAnimationMode;","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport AnimationNodeBase\t\t\t\t= require(\"awayjs-display/lib/animators/nodes/AnimationNodeBase\");\n\n/**\n * Provides an abstract base class for nodes with time-based animation data in an animation blend tree.\n */\nclass AnimationClipNodeBase extends AnimationNodeBase\n{\n\tpublic _pLooping:boolean = true;\n\tpublic _pTotalDuration:number /*uint*/ = 0;\n\tpublic _pLastFrame:number /*uint*/;\n\n\tpublic _pStitchDirty:boolean = true;\n\tpublic _pStitchFinalFrame:boolean = false;\n\tpublic _pNumFrames:number /*uint*/ = 0;\n\n\tpublic _pDurations:Array<number> = new Array<number>();\n\t/*uint*/\n\tpublic _pTotalDelta:Vector3D = new Vector3D();\n\n\tpublic fixedFrameRate:boolean = true;\n\n\t/**\n\t * Determines whether the contents of the animation node have looping characteristics enabled.\n\t */\n\tpublic get looping():boolean\n\t{\n\t\treturn this._pLooping;\n\t}\n\n\tpublic set looping(value:boolean)\n\t{\n\t\tif (this._pLooping == value)\n\t\t\treturn;\n\n\t\tthis._pLooping = value;\n\n\t\tthis._pStitchDirty = true;\n\t}\n\n\t/**\n\t * Defines if looping content blends the final frame of animation data with the first (true) or works on the\n\t * assumption that both first and last frames are identical (false). Defaults to false.\n\t */\n\tpublic get stitchFinalFrame():boolean\n\t{\n\t\treturn this._pStitchFinalFrame;\n\t}\n\n\tpublic set stitchFinalFrame(value:boolean)\n\t{\n\t\tif (this._pStitchFinalFrame == value)\n\t\t\treturn;\n\n\t\tthis._pStitchFinalFrame = value;\n\n\t\tthis._pStitchDirty = true;\n\t}\n\n\tpublic get totalDuration():number /*uint*/\n\t{\n\t\tif (this._pStitchDirty)\n\t\t\tthis._pUpdateStitch();\n\n\t\treturn this._pTotalDuration;\n\t}\n\n\tpublic get totalDelta():Vector3D\n\t{\n\t\tif (this._pStitchDirty)\n\t\t\tthis._pUpdateStitch();\n\n\t\treturn this._pTotalDelta;\n\t}\n\n\tpublic get lastFrame():number /*uint*/\n\t{\n\t\tif (this._pStitchDirty)\n\t\t\tthis._pUpdateStitch();\n\n\t\treturn this._pLastFrame;\n\t}\n\n\t/**\n\t * Returns a vector of time values representing the duration (in milliseconds) of each animation frame in the clip.\n\t */\n\tpublic get durations():Array<number> /*uint*/\n\t{\n\t\treturn this._pDurations;\n\t}\n\n\t/**\n\t * Creates a new <code>AnimationClipNodeBase</code> object.\n\t */\n\tconstructor()\n\t{\n\t\tsuper();\n\t}\n\n\t/**\n\t * Updates the node's final frame stitch state.\n\t *\n\t * @see #stitchFinalFrame\n\t */\n\tpublic _pUpdateStitch()\n\t{\n\t\tthis._pStitchDirty = false;\n\n\t\tthis._pLastFrame = (this._pStitchFinalFrame)? this._pNumFrames : this._pNumFrames - 1;\n\n\t\tthis._pTotalDuration = 0;\n\t\tthis._pTotalDelta.x = 0;\n\t\tthis._pTotalDelta.y = 0;\n\t\tthis._pTotalDelta.z = 0;\n\t}\n}\n\nexport = AnimationClipNodeBase;","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport ShaderObjectBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport ShaderRegisterElement\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\n\nimport ParticleProperties\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticleProperties\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticleNodeBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleNodeBase\");\nimport ParticleAccelerationState\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleAccelerationState\");\n\n/**\n * A particle animation node used to apply a constant acceleration vector to the motion of a particle.\n */\nclass ParticleAccelerationNode extends ParticleNodeBase\n{\n\t/** @private */\n\tpublic _acceleration:Vector3D;\n\n\t/**\n\t * Reference for acceleration node properties on a single particle (when in local property mode).\n\t * Expects a <code>Vector3D</code> object representing the direction of acceleration on the particle.\n\t */\n\tpublic static ACCELERATION_VECTOR3D:string = \"AccelerationVector3D\";\n\n\t/**\n\t * Creates a new <code>ParticleAccelerationNode</code>\n\t *\n\t * @param               mode            Defines whether the mode of operation acts on local properties of a particle or global properties of the node.\n\t * @param    [optional] acceleration    Defines the default acceleration vector of the node, used when in global mode.\n\t */\n\tconstructor(mode:number /*uint*/, acceleration:Vector3D = null)\n\t{\n\t\tsuper(\"ParticleAcceleration\", mode, 3);\n\n\t\tthis._pStateClass = ParticleAccelerationState;\n\n\t\tthis._acceleration = acceleration || new Vector3D();\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic pGetAGALVertexCode(shaderObject:ShaderObjectBase, animationRegisterCache:AnimationRegisterCache):string\n\t{\n\t\tvar accelerationValue:ShaderRegisterElement = (this._pMode == ParticlePropertiesMode.GLOBAL)? animationRegisterCache.getFreeVertexConstant() : animationRegisterCache.getFreeVertexAttribute();\n\t\tanimationRegisterCache.setRegisterIndex(this, ParticleAccelerationState.ACCELERATION_INDEX, accelerationValue.index);\n\n\t\tvar temp:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\t\tanimationRegisterCache.addVertexTempUsages(temp, 1);\n\n\t\tvar code:string = \"mul \" + temp + \",\" + animationRegisterCache.vertexTime + \",\" + accelerationValue + \"\\n\";\n\n\t\tif (animationRegisterCache.needVelocity) {\n\t\t\tvar temp2:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\t\t\tcode += \"mul \" + temp2 + \",\" + temp + \",\" + animationRegisterCache.vertexTwoConst + \"\\n\";\n\t\t\tcode += \"add \" + animationRegisterCache.velocityTarget + \".xyz,\" + temp2 + \".xyz,\" + animationRegisterCache.velocityTarget + \".xyz\\n\";\n\t\t}\n\t\tanimationRegisterCache.removeVertexTempUsage(temp);\n\n\t\tcode += \"mul \" + temp + \",\" + temp + \",\" + animationRegisterCache.vertexTime + \"\\n\";\n\t\tcode += \"add \" + animationRegisterCache.positionTarget + \".xyz,\" + temp + \",\" + animationRegisterCache.positionTarget + \".xyz\\n\";\n\t\treturn code;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAnimationState(animator:AnimatorBase):ParticleAccelerationState\n\t{\n\t\treturn <ParticleAccelerationState> animator.getAnimationState(this);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iGeneratePropertyOfOneParticle(param:ParticleProperties)\n\t{\n\t\tvar tempAcceleration:Vector3D = param[ParticleAccelerationNode.ACCELERATION_VECTOR3D];\n\t\tif (!tempAcceleration)\n\t\t\tthrow new Error(\"there is no \" + ParticleAccelerationNode.ACCELERATION_VECTOR3D + \" in param!\");\n\n\t\tthis._pOneData[0] = tempAcceleration.x/2;\n\t\tthis._pOneData[1] = tempAcceleration.y/2;\n\t\tthis._pOneData[2] = tempAcceleration.z/2;\n\t}\n}\n\nexport = ParticleAccelerationNode;","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport ShaderObjectBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport ShaderRegisterElement\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\n\nimport ParticleProperties\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticleProperties\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticleNodeBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleNodeBase\");\nimport ParticleBezierCurveState\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleBezierCurveState\");\n\n/**\n * A particle animation node used to control the position of a particle over time along a bezier curve.\n */\nclass ParticleBezierCurveNode extends ParticleNodeBase\n{\n\t/** @private */\n\tpublic _iControlPoint:Vector3D;\n\t/** @private */\n\tpublic _iEndPoint:Vector3D;\n\n\t/**\n\t * Reference for bezier curve node properties on a single particle (when in local property mode).\n\t * Expects a <code>Vector3D</code> object representing the control point position (0, 1, 2) of the curve.\n\t */\n\tpublic static BEZIER_CONTROL_VECTOR3D:string = \"BezierControlVector3D\";\n\n\t/**\n\t * Reference for bezier curve node properties on a single particle (when in local property mode).\n\t * Expects a <code>Vector3D</code> object representing the end point position (0, 1, 2) of the curve.\n\t */\n\tpublic static BEZIER_END_VECTOR3D:string = \"BezierEndVector3D\";\n\n\t/**\n\t * Creates a new <code>ParticleBezierCurveNode</code>\n\t *\n\t * @param               mode            Defines whether the mode of operation acts on local properties of a particle or global properties of the node.\n\t * @param    [optional] controlPoint    Defines the default control point of the node, used when in global mode.\n\t * @param    [optional] endPoint        Defines the default end point of the node, used when in global mode.\n\t */\n\tconstructor(mode:number /*uint*/, controlPoint:Vector3D = null, endPoint:Vector3D = null)\n\t{\n\t\tsuper(\"ParticleBezierCurve\", mode, 6);\n\n\t\tthis._pStateClass = ParticleBezierCurveState;\n\n\t\tthis._iControlPoint = controlPoint || new Vector3D();\n\t\tthis._iEndPoint = endPoint || new Vector3D();\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAGALVertexCode(shaderObject:ShaderObjectBase, animationRegisterCache:AnimationRegisterCache):string\n\t{\n\t\tvar controlValue:ShaderRegisterElement = (this._pMode == ParticlePropertiesMode.GLOBAL)? animationRegisterCache.getFreeVertexConstant() : animationRegisterCache.getFreeVertexAttribute();\n\t\tanimationRegisterCache.setRegisterIndex(this, ParticleBezierCurveState.BEZIER_CONTROL_INDEX, controlValue.index);\n\n\t\tvar endValue:ShaderRegisterElement = (this._pMode == ParticlePropertiesMode.GLOBAL)? animationRegisterCache.getFreeVertexConstant() : animationRegisterCache.getFreeVertexAttribute();\n\t\tanimationRegisterCache.setRegisterIndex(this, ParticleBezierCurveState.BEZIER_END_INDEX, endValue.index);\n\n\t\tvar temp:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\t\tvar rev_time:ShaderRegisterElement = new ShaderRegisterElement(temp.regName, temp.index, 0);\n\t\tvar time_2:ShaderRegisterElement = new ShaderRegisterElement(temp.regName, temp.index, 1);\n\t\tvar time_temp:ShaderRegisterElement = new ShaderRegisterElement(temp.regName, temp.index, 2);\n\t\tanimationRegisterCache.addVertexTempUsages(temp, 1);\n\t\tvar temp2:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\t\tvar distance:ShaderRegisterElement = new ShaderRegisterElement(temp2.regName, temp2.index);\n\t\tanimationRegisterCache.removeVertexTempUsage(temp);\n\n\t\tvar code:string = \"\";\n\t\tcode += \"sub \" + rev_time + \",\" + animationRegisterCache.vertexOneConst + \",\" + animationRegisterCache.vertexLife + \"\\n\";\n\t\tcode += \"mul \" + time_2 + \",\" + animationRegisterCache.vertexLife + \",\" + animationRegisterCache.vertexLife + \"\\n\";\n\n\t\tcode += \"mul \" + time_temp + \",\" + animationRegisterCache.vertexLife + \",\" + rev_time + \"\\n\";\n\t\tcode += \"mul \" + time_temp + \",\" + time_temp + \",\" + animationRegisterCache.vertexTwoConst + \"\\n\";\n\t\tcode += \"mul \" + distance + \".xyz,\" + time_temp + \",\" + controlValue + \"\\n\";\n\t\tcode += \"add \" + animationRegisterCache.positionTarget + \".xyz,\" + distance + \".xyz,\" + animationRegisterCache.positionTarget + \".xyz\\n\";\n\t\tcode += \"mul \" + distance + \".xyz,\" + time_2 + \",\" + endValue + \"\\n\";\n\t\tcode += \"add \" + animationRegisterCache.positionTarget + \".xyz,\" + distance + \".xyz,\" + animationRegisterCache.positionTarget + \".xyz\\n\";\n\n\t\tif (animationRegisterCache.needVelocity) {\n\t\t\tcode += \"mul \" + time_2 + \",\" + animationRegisterCache.vertexLife + \",\" + animationRegisterCache.vertexTwoConst + \"\\n\";\n\t\t\tcode += \"sub \" + time_temp + \",\" + animationRegisterCache.vertexOneConst + \",\" + time_2 + \"\\n\";\n\t\t\tcode += \"mul \" + time_temp + \",\" + animationRegisterCache.vertexTwoConst + \",\" + time_temp + \"\\n\";\n\t\t\tcode += \"mul \" + distance + \".xyz,\" + controlValue + \",\" + time_temp + \"\\n\";\n\t\t\tcode += \"add \" + animationRegisterCache.velocityTarget + \".xyz,\" + distance + \".xyz,\" + animationRegisterCache.velocityTarget + \".xyz\\n\";\n\t\t\tcode += \"mul \" + distance + \".xyz,\" + endValue + \",\" + time_2 + \"\\n\";\n\t\t\tcode += \"add \" + animationRegisterCache.velocityTarget + \".xyz,\" + distance + \".xyz,\" + animationRegisterCache.velocityTarget + \".xyz\\n\";\n\t\t}\n\n\t\treturn code;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAnimationState(animator:AnimatorBase):ParticleBezierCurveState\n\t{\n\t\treturn <ParticleBezierCurveState> animator.getAnimationState(this);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iGeneratePropertyOfOneParticle(param:ParticleProperties)\n\t{\n\t\tvar bezierControl:Vector3D = param[ParticleBezierCurveNode.BEZIER_CONTROL_VECTOR3D];\n\t\tif (!bezierControl)\n\t\t\tthrow new Error(\"there is no \" + ParticleBezierCurveNode.BEZIER_CONTROL_VECTOR3D + \" in param!\");\n\n\t\tvar bezierEnd:Vector3D = param[ParticleBezierCurveNode.BEZIER_END_VECTOR3D];\n\t\tif (!bezierEnd)\n\t\t\tthrow new Error(\"there is no \" + ParticleBezierCurveNode.BEZIER_END_VECTOR3D + \" in param!\");\n\n\t\tthis._pOneData[0] = bezierControl.x;\n\t\tthis._pOneData[1] = bezierControl.y;\n\t\tthis._pOneData[2] = bezierControl.z;\n\t\tthis._pOneData[3] = bezierEnd.x;\n\t\tthis._pOneData[4] = bezierEnd.y;\n\t\tthis._pOneData[5] = bezierEnd.z;\n\t}\n}\n\nexport = ParticleBezierCurveNode;","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport ShaderObjectBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport ShaderRegisterElement\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\n\nimport ParticleAnimationSet\t\t\t\t= require(\"awayjs-renderergl/lib/animators/ParticleAnimationSet\");\nimport ParticleProperties\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticleProperties\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticleNodeBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleNodeBase\");\nimport ParticleBillboardState\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleBillboardState\");\n\n/**\n * A particle animation node that controls the rotation of a particle to always face the camera.\n */\nclass ParticleBillboardNode extends ParticleNodeBase\n{\n\t/** @private */\n\tpublic _iBillboardAxis:Vector3D;\n\n\t/**\n\t * Creates a new <code>ParticleBillboardNode</code>\n\t */\n\tconstructor(billboardAxis:Vector3D = null)\n\t{\n\t\tsuper(\"ParticleBillboard\", ParticlePropertiesMode.GLOBAL, 0, 4);\n\n\t\tthis._pStateClass = ParticleBillboardState;\n\n\t\tthis._iBillboardAxis = billboardAxis;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAGALVertexCode(shaderObject:ShaderObjectBase, animationRegisterCache:AnimationRegisterCache):string\n\t{\n\t\tvar rotationMatrixRegister:ShaderRegisterElement = animationRegisterCache.getFreeVertexConstant();\n\t\tanimationRegisterCache.setRegisterIndex(this, ParticleBillboardState.MATRIX_INDEX, rotationMatrixRegister.index);\n\t\tanimationRegisterCache.getFreeVertexConstant();\n\t\tanimationRegisterCache.getFreeVertexConstant();\n\t\tanimationRegisterCache.getFreeVertexConstant();\n\n\t\tvar temp:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\n\t\tvar code:string = \"m33 \" + temp + \".xyz,\" + animationRegisterCache.scaleAndRotateTarget + \",\" + rotationMatrixRegister + \"\\n\" +\n\t\t\t\t\t\t  \"mov \" + animationRegisterCache.scaleAndRotateTarget + \".xyz,\" + temp + \"\\n\";\n\n\t\tvar shaderRegisterElement:ShaderRegisterElement;\n\t\tfor (var i:number /*uint*/ = 0; i < animationRegisterCache.rotationRegisters.length; i++) {\n\t\t\tshaderRegisterElement = animationRegisterCache.rotationRegisters[i];\n\t\t\tcode += \"m33 \" + temp + \".xyz,\" + shaderRegisterElement + \",\" + rotationMatrixRegister + \"\\n\" +\n\t\t\t\t\t\"mov \" + shaderRegisterElement + \".xyz,\" + shaderRegisterElement + \"\\n\";\n\t\t}\n\n\t\treturn code;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAnimationState(animator:AnimatorBase):ParticleBillboardState\n\t{\n\t\treturn <ParticleBillboardState> animator.getAnimationState(this);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iProcessAnimationSetting(particleAnimationSet:ParticleAnimationSet)\n\t{\n\t\tparticleAnimationSet.hasBillboard = true;\n\t}\n}\n\nexport = ParticleBillboardNode;","import ColorTransform\t\t\t\t\t= require(\"awayjs-core/lib/geom/ColorTransform\");\nimport Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport ShaderObjectBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport ShaderRegisterElement\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\n\nimport ParticleAnimationSet\t\t\t\t= require(\"awayjs-renderergl/lib/animators/ParticleAnimationSet\");\nimport ParticleProperties\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticleProperties\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticleNodeBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleNodeBase\");\nimport ParticleColorState\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleColorState\");\n\n/**\n * A particle animation node used to control the color variation of a particle over time.\n */\nclass ParticleColorNode extends ParticleNodeBase\n{\n\t//default values used when creating states\n\t/** @private */\n\tpublic _iUsesMultiplier:boolean;\n\t/** @private */\n\tpublic _iUsesOffset:boolean;\n\t/** @private */\n\tpublic _iUsesCycle:boolean;\n\t/** @private */\n\tpublic _iUsesPhase:boolean;\n\t/** @private */\n\tpublic _iStartColor:ColorTransform;\n\t/** @private */\n\tpublic _iEndColor:ColorTransform;\n\t/** @private */\n\tpublic _iCycleDuration:number;\n\t/** @private */\n\tpublic _iCyclePhase:number;\n\n\t/**\n\t * Reference for color node properties on a single particle (when in local property mode).\n\t * Expects a <code>ColorTransform</code> object representing the start color transform applied to the particle.\n\t */\n\tpublic static COLOR_START_COLORTRANSFORM:string = \"ColorStartColorTransform\";\n\n\t/**\n\t * Reference for color node properties on a single particle (when in local property mode).\n\t * Expects a <code>ColorTransform</code> object representing the end color transform applied to the particle.\n\t */\n\tpublic static COLOR_END_COLORTRANSFORM:string = \"ColorEndColorTransform\";\n\n\t/**\n\t * Creates a new <code>ParticleColorNode</code>\n\t *\n\t * @param               mode            Defines whether the mode of operation acts on local properties of a particle or global properties of the node.\n\t * @param    [optional] usesMultiplier  Defines whether the node uses multiplier data in the shader for its color transformations. Defaults to true.\n\t * @param    [optional] usesOffset      Defines whether the node uses offset data in the shader for its color transformations. Defaults to true.\n\t * @param    [optional] usesCycle       Defines whether the node uses the <code>cycleDuration</code> property in the shader to calculate the period of the animation independent of particle duration. Defaults to false.\n\t * @param    [optional] usesPhase       Defines whether the node uses the <code>cyclePhase</code> property in the shader to calculate a starting offset to the cycle rotation of the particle. Defaults to false.\n\t * @param    [optional] startColor      Defines the default start color transform of the node, when in global mode.\n\t * @param    [optional] endColor        Defines the default end color transform of the node, when in global mode.\n\t * @param    [optional] cycleDuration   Defines the duration of the animation in seconds, used as a period independent of particle duration when in global mode. Defaults to 1.\n\t * @param    [optional] cyclePhase      Defines the phase of the cycle in degrees, used as the starting offset of the cycle when in global mode. Defaults to 0.\n\t */\n\tconstructor(mode:number /*uint*/, usesMultiplier:boolean = true, usesOffset:boolean = true, usesCycle:boolean = false, usesPhase:boolean = false, startColor:ColorTransform = null, endColor:ColorTransform = null, cycleDuration:number = 1, cyclePhase:number = 0)\n\t{\n\t\tsuper(\"ParticleColor\", mode, (usesMultiplier && usesOffset)? 16 : 8, ParticleAnimationSet.COLOR_PRIORITY);\n\n\t\tthis._pStateClass = ParticleColorState;\n\n\t\tthis._iUsesMultiplier = usesMultiplier;\n\t\tthis._iUsesOffset = usesOffset;\n\t\tthis._iUsesCycle = usesCycle;\n\t\tthis._iUsesPhase = usesPhase;\n\n\t\tthis._iStartColor = startColor || new ColorTransform();\n\t\tthis._iEndColor = endColor || new ColorTransform();\n\t\tthis._iCycleDuration = cycleDuration;\n\t\tthis._iCyclePhase = cyclePhase;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAGALVertexCode(shaderObject:ShaderObjectBase, animationRegisterCache:AnimationRegisterCache):string\n\t{\n\t\tvar code:string = \"\";\n\t\tif (animationRegisterCache.needFragmentAnimation) {\n\t\t\tvar temp:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\n\t\t\tif (this._iUsesCycle) {\n\t\t\t\tvar cycleConst:ShaderRegisterElement = animationRegisterCache.getFreeVertexConstant();\n\t\t\t\tanimationRegisterCache.setRegisterIndex(this, ParticleColorState.CYCLE_INDEX, cycleConst.index);\n\n\t\t\t\tanimationRegisterCache.addVertexTempUsages(temp, 1);\n\t\t\t\tvar sin:ShaderRegisterElement = animationRegisterCache.getFreeVertexSingleTemp();\n\t\t\t\tanimationRegisterCache.removeVertexTempUsage(temp);\n\n\t\t\t\tcode += \"mul \" + sin + \",\" + animationRegisterCache.vertexTime + \",\" + cycleConst + \".x\\n\";\n\n\t\t\t\tif (this._iUsesPhase)\n\t\t\t\t\tcode += \"add \" + sin + \",\" + sin + \",\" + cycleConst + \".y\\n\";\n\n\t\t\t\tcode += \"sin \" + sin + \",\" + sin + \"\\n\";\n\t\t\t}\n\n\t\t\tif (this._iUsesMultiplier) {\n\t\t\t\tvar startMultiplierValue:ShaderRegisterElement = (this._pMode == ParticlePropertiesMode.GLOBAL)? animationRegisterCache.getFreeVertexConstant() : animationRegisterCache.getFreeVertexAttribute();\n\t\t\t\tvar deltaMultiplierValue:ShaderRegisterElement = (this._pMode == ParticlePropertiesMode.GLOBAL)? animationRegisterCache.getFreeVertexConstant() : animationRegisterCache.getFreeVertexAttribute();\n\n\t\t\t\tanimationRegisterCache.setRegisterIndex(this, ParticleColorState.START_MULTIPLIER_INDEX, startMultiplierValue.index);\n\t\t\t\tanimationRegisterCache.setRegisterIndex(this, ParticleColorState.DELTA_MULTIPLIER_INDEX, deltaMultiplierValue.index);\n\n\t\t\t\tcode += \"mul \" + temp + \",\" + deltaMultiplierValue + \",\" + (this._iUsesCycle? sin : animationRegisterCache.vertexLife) + \"\\n\";\n\t\t\t\tcode += \"add \" + temp + \",\" + temp + \",\" + startMultiplierValue + \"\\n\";\n\t\t\t\tcode += \"mul \" + animationRegisterCache.colorMulTarget + \",\" + temp + \",\" + animationRegisterCache.colorMulTarget + \"\\n\";\n\t\t\t}\n\n\t\t\tif (this._iUsesOffset) {\n\t\t\t\tvar startOffsetValue:ShaderRegisterElement = (this._pMode == ParticlePropertiesMode.LOCAL_STATIC)? animationRegisterCache.getFreeVertexAttribute() : animationRegisterCache.getFreeVertexConstant();\n\t\t\t\tvar deltaOffsetValue:ShaderRegisterElement = (this._pMode == ParticlePropertiesMode.LOCAL_STATIC)? animationRegisterCache.getFreeVertexAttribute() : animationRegisterCache.getFreeVertexConstant();\n\n\t\t\t\tanimationRegisterCache.setRegisterIndex(this, ParticleColorState.START_OFFSET_INDEX, startOffsetValue.index);\n\t\t\t\tanimationRegisterCache.setRegisterIndex(this, ParticleColorState.DELTA_OFFSET_INDEX, deltaOffsetValue.index);\n\n\t\t\t\tcode += \"mul \" + temp + \",\" + deltaOffsetValue + \",\" + (this._iUsesCycle? sin : animationRegisterCache.vertexLife) + \"\\n\";\n\t\t\t\tcode += \"add \" + temp + \",\" + temp + \",\" + startOffsetValue + \"\\n\";\n\t\t\t\tcode += \"add \" + animationRegisterCache.colorAddTarget + \",\" + temp + \",\" + animationRegisterCache.colorAddTarget + \"\\n\";\n\t\t\t}\n\t\t}\n\n\t\treturn code;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAnimationState(animator:AnimatorBase):ParticleColorState\n\t{\n\t\treturn <ParticleColorState> animator.getAnimationState(this);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iProcessAnimationSetting(particleAnimationSet:ParticleAnimationSet)\n\t{\n\t\tif (this._iUsesMultiplier)\n\t\t\tparticleAnimationSet.hasColorMulNode = true;\n\t\tif (this._iUsesOffset)\n\t\t\tparticleAnimationSet.hasColorAddNode = true;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iGeneratePropertyOfOneParticle(param:ParticleProperties)\n\t{\n\t\tvar startColor:ColorTransform = param[ParticleColorNode.COLOR_START_COLORTRANSFORM];\n\t\tif (!startColor)\n\t\t\tthrow(new Error(\"there is no \" + ParticleColorNode.COLOR_START_COLORTRANSFORM + \" in param!\"));\n\n\t\tvar endColor:ColorTransform = param[ParticleColorNode.COLOR_END_COLORTRANSFORM];\n\t\tif (!endColor)\n\t\t\tthrow(new Error(\"there is no \" + ParticleColorNode.COLOR_END_COLORTRANSFORM + \" in param!\"));\n\n\t\tvar i:number /*uint*/ = 0;\n\n\t\tif (!this._iUsesCycle) {\n\t\t\t//multiplier\n\t\t\tif (this._iUsesMultiplier) {\n\t\t\t\tthis._pOneData[i++] = startColor.redMultiplier;\n\t\t\t\tthis._pOneData[i++] = startColor.greenMultiplier;\n\t\t\t\tthis._pOneData[i++] = startColor.blueMultiplier;\n\t\t\t\tthis._pOneData[i++] = startColor.alphaMultiplier;\n\t\t\t\tthis._pOneData[i++] = endColor.redMultiplier - startColor.redMultiplier;\n\t\t\t\tthis._pOneData[i++] = endColor.greenMultiplier - startColor.greenMultiplier;\n\t\t\t\tthis._pOneData[i++] = endColor.blueMultiplier - startColor.blueMultiplier;\n\t\t\t\tthis._pOneData[i++] = endColor.alphaMultiplier - startColor.alphaMultiplier;\n\t\t\t}\n\n\t\t\t//offset\n\t\t\tif (this._iUsesOffset) {\n\t\t\t\tthis._pOneData[i++] = startColor.redOffset/255;\n\t\t\t\tthis._pOneData[i++] = startColor.greenOffset/255;\n\t\t\t\tthis._pOneData[i++] = startColor.blueOffset/255;\n\t\t\t\tthis._pOneData[i++] = startColor.alphaOffset/255;\n\t\t\t\tthis._pOneData[i++] = (endColor.redOffset - startColor.redOffset)/255;\n\t\t\t\tthis._pOneData[i++] = (endColor.greenOffset - startColor.greenOffset)/255;\n\t\t\t\tthis._pOneData[i++] = (endColor.blueOffset - startColor.blueOffset)/255;\n\t\t\t\tthis._pOneData[i++] = (endColor.alphaOffset - startColor.alphaOffset)/255;\n\t\t\t}\n\t\t} else {\n\t\t\t//multiplier\n\t\t\tif (this._iUsesMultiplier) {\n\t\t\t\tthis._pOneData[i++] = (startColor.redMultiplier + endColor.redMultiplier)/2;\n\t\t\t\tthis._pOneData[i++] = (startColor.greenMultiplier + endColor.greenMultiplier)/2;\n\t\t\t\tthis._pOneData[i++] = (startColor.blueMultiplier + endColor.blueMultiplier)/2;\n\t\t\t\tthis._pOneData[i++] = (startColor.alphaMultiplier + endColor.alphaMultiplier)/2;\n\t\t\t\tthis._pOneData[i++] = (startColor.redMultiplier - endColor.redMultiplier)/2;\n\t\t\t\tthis._pOneData[i++] = (startColor.greenMultiplier - endColor.greenMultiplier)/2;\n\t\t\t\tthis._pOneData[i++] = (startColor.blueMultiplier - endColor.blueMultiplier)/2;\n\t\t\t\tthis._pOneData[i++] = (startColor.alphaMultiplier - endColor.alphaMultiplier)/2;\n\t\t\t}\n\n\t\t\t//offset\n\t\t\tif (this._iUsesOffset) {\n\t\t\t\tthis._pOneData[i++] = (startColor.redOffset + endColor.redOffset)/(255*2);\n\t\t\t\tthis._pOneData[i++] = (startColor.greenOffset + endColor.greenOffset)/(255*2);\n\t\t\t\tthis._pOneData[i++] = (startColor.blueOffset + endColor.blueOffset)/(255*2);\n\t\t\t\tthis._pOneData[i++] = (startColor.alphaOffset + endColor.alphaOffset)/(255*2);\n\t\t\t\tthis._pOneData[i++] = (startColor.redOffset - endColor.redOffset)/(255*2);\n\t\t\t\tthis._pOneData[i++] = (startColor.greenOffset - endColor.greenOffset)/(255*2);\n\t\t\t\tthis._pOneData[i++] = (startColor.blueOffset - endColor.blueOffset)/(255*2);\n\t\t\t\tthis._pOneData[i++] = (startColor.alphaOffset - endColor.alphaOffset)/(255*2);\n\t\t\t}\n\t\t}\n\n\t}\n}\n\nexport = ParticleColorNode;","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport ShaderObjectBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport ShaderRegisterElement\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\n\nimport ParticleAnimationSet\t\t\t\t= require(\"awayjs-renderergl/lib/animators/ParticleAnimationSet\");\nimport ParticleProperties\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticleProperties\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticleNodeBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleNodeBase\");\nimport ParticleFollowState\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleFollowState\");\n\n/**\n * A particle animation node used to create a follow behaviour on a particle system.\n */\nclass ParticleFollowNode extends ParticleNodeBase\n{\n\t/** @private */\n\tpublic _iUsesPosition:boolean;\n\n\t/** @private */\n\tpublic _iUsesRotation:boolean;\n\n\t/** @private */\n\tpublic _iSmooth:boolean;\n\n\t/**\n\t * Creates a new <code>ParticleFollowNode</code>\n\t *\n\t * @param    [optional] usesPosition     Defines wehether the individual particle reacts to the position of the target.\n\t * @param    [optional] usesRotation     Defines wehether the individual particle reacts to the rotation of the target.\n\t * @param    [optional] smooth     Defines wehether the state calculate the interpolated value.\n\t */\n\tconstructor(usesPosition:boolean = true, usesRotation:boolean = true, smooth:boolean = false)\n\t{\n\t\tsuper(\"ParticleFollow\", ParticlePropertiesMode.LOCAL_DYNAMIC, (usesPosition && usesRotation)? 6 : 3, ParticleAnimationSet.POST_PRIORITY);\n\n\t\tthis._pStateClass = ParticleFollowState;\n\n\t\tthis._iUsesPosition = usesPosition;\n\t\tthis._iUsesRotation = usesRotation;\n\t\tthis._iSmooth = smooth;\n\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAGALVertexCode(shaderObject:ShaderObjectBase, animationRegisterCache:AnimationRegisterCache):string\n\t{\n\t\t//TODO: use Quaternion to implement this function\n\t\tvar code:string = \"\";\n\t\tif (this._iUsesRotation) {\n\t\t\tvar rotationAttribute:ShaderRegisterElement = animationRegisterCache.getFreeVertexAttribute();\n\t\t\tanimationRegisterCache.setRegisterIndex(this, ParticleFollowState.FOLLOW_ROTATION_INDEX, rotationAttribute.index);\n\n\t\t\tvar temp1:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\t\t\tanimationRegisterCache.addVertexTempUsages(temp1, 1);\n\t\t\tvar temp2:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\t\t\tanimationRegisterCache.addVertexTempUsages(temp2, 1);\n\t\t\tvar temp3:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\n\t\t\tvar temp4:ShaderRegisterElement;\n\t\t\tif (animationRegisterCache.hasBillboard) {\n\t\t\t\tanimationRegisterCache.addVertexTempUsages(temp3, 1);\n\t\t\t\ttemp4 = animationRegisterCache.getFreeVertexVectorTemp();\n\t\t\t}\n\n\t\t\tanimationRegisterCache.removeVertexTempUsage(temp1);\n\t\t\tanimationRegisterCache.removeVertexTempUsage(temp2);\n\t\t\tif (animationRegisterCache.hasBillboard)\n\t\t\t\tanimationRegisterCache.removeVertexTempUsage(temp3);\n\n\t\t\tvar len:number /*int*/ = animationRegisterCache.rotationRegisters.length;\n\t\t\tvar i:number /*int*/;\n\n\t\t\t//x axis\n\t\t\tcode += \"mov \" + temp1 + \",\" + animationRegisterCache.vertexZeroConst + \"\\n\";\n\t\t\tcode += \"mov \" + temp1 + \".x,\" + animationRegisterCache.vertexOneConst + \"\\n\";\n\t\t\tcode += \"mov \" + temp3 + \",\" + animationRegisterCache.vertexZeroConst + \"\\n\";\n\t\t\tcode += \"sin \" + temp3 + \".y,\" + rotationAttribute + \".x\\n\";\n\t\t\tcode += \"cos \" + temp3 + \".z,\" + rotationAttribute + \".x\\n\";\n\t\t\tcode += \"mov \" + temp2 + \".x,\" + animationRegisterCache.vertexZeroConst + \"\\n\";\n\t\t\tcode += \"mov \" + temp2 + \".y,\" + temp3 + \".z\\n\";\n\t\t\tcode += \"neg \" + temp2 + \".z,\" + temp3 + \".y\\n\";\n\n\t\t\tif (animationRegisterCache.hasBillboard)\n\t\t\t\tcode += \"m33 \" + temp4 + \".xyz,\" + animationRegisterCache.positionTarget + \".xyz,\" + temp1 + \"\\n\";\n\t\t\telse {\n\t\t\t\tcode += \"m33 \" + animationRegisterCache.scaleAndRotateTarget + \".xyz,\" + animationRegisterCache.scaleAndRotateTarget + \".xyz,\" + temp1 + \"\\n\";\n\t\t\t\tfor (i = 0; i < len; i++)\n\t\t\t\t\tcode += \"m33 \" + animationRegisterCache.rotationRegisters[i] + \".xyz,\" + animationRegisterCache.rotationRegisters[i] + \",\" + temp1 + \"\\n\";\n\t\t\t}\n\n\t\t\t//y axis\n\t\t\tcode += \"mov \" + temp1 + \",\" + animationRegisterCache.vertexZeroConst + \"\\n\";\n\t\t\tcode += \"cos \" + temp1 + \".x,\" + rotationAttribute + \".y\\n\";\n\t\t\tcode += \"sin \" + temp1 + \".z,\" + rotationAttribute + \".y\\n\";\n\t\t\tcode += \"mov \" + temp2 + \",\" + animationRegisterCache.vertexZeroConst + \"\\n\";\n\t\t\tcode += \"mov \" + temp2 + \".y,\" + animationRegisterCache.vertexOneConst + \"\\n\";\n\t\t\tcode += \"mov \" + temp3 + \",\" + animationRegisterCache.vertexZeroConst + \"\\n\";\n\t\t\tcode += \"neg \" + temp3 + \".x,\" + temp1 + \".z\\n\";\n\t\t\tcode += \"mov \" + temp3 + \".z,\" + temp1 + \".x\\n\";\n\n\t\t\tif (animationRegisterCache.hasBillboard)\n\t\t\t\tcode += \"m33 \" + temp4 + \".xyz,\" + temp4 + \".xyz,\" + temp1 + \"\\n\";\n\t\t\telse {\n\t\t\t\tcode += \"m33 \" + animationRegisterCache.scaleAndRotateTarget + \".xyz,\" + animationRegisterCache.scaleAndRotateTarget + \".xyz,\" + temp1 + \"\\n\";\n\t\t\t\tfor (i = 0; i < len; i++)\n\t\t\t\t\tcode += \"m33 \" + animationRegisterCache.rotationRegisters[i] + \".xyz,\" + animationRegisterCache.rotationRegisters[i] + \",\" + temp1 + \"\\n\";\n\t\t\t}\n\n\t\t\t//z axis\n\t\t\tcode += \"mov \" + temp2 + \",\" + animationRegisterCache.vertexZeroConst + \"\\n\";\n\t\t\tcode += \"sin \" + temp2 + \".x,\" + rotationAttribute + \".z\\n\";\n\t\t\tcode += \"cos \" + temp2 + \".y,\" + rotationAttribute + \".z\\n\";\n\t\t\tcode += \"mov \" + temp1 + \",\" + animationRegisterCache.vertexZeroConst + \"\\n\";\n\t\t\tcode += \"mov \" + temp1 + \".x,\" + temp2 + \".y\\n\";\n\t\t\tcode += \"neg \" + temp1 + \".y,\" + temp2 + \".x\\n\";\n\t\t\tcode += \"mov \" + temp3 + \",\" + animationRegisterCache.vertexZeroConst + \"\\n\";\n\t\t\tcode += \"mov \" + temp3 + \".z,\" + animationRegisterCache.vertexOneConst + \"\\n\";\n\n\t\t\tif (animationRegisterCache.hasBillboard) {\n\t\t\t\tcode += \"m33 \" + temp4 + \".xyz,\" + temp4 + \".xyz,\" + temp1 + \"\\n\";\n\t\t\t\tcode += \"sub \" + temp4 + \".xyz,\" + temp4 + \".xyz,\" + animationRegisterCache.positionTarget + \".xyz\\n\";\n\t\t\t\tcode += \"add \" + animationRegisterCache.scaleAndRotateTarget + \".xyz,\" + temp4 + \".xyz,\" + animationRegisterCache.scaleAndRotateTarget + \".xyz\\n\";\n\t\t\t} else {\n\t\t\t\tcode += \"m33 \" + animationRegisterCache.scaleAndRotateTarget + \".xyz,\" + animationRegisterCache.scaleAndRotateTarget + \".xyz,\" + temp1 + \"\\n\";\n\t\t\t\tfor (i = 0; i < len; i++)\n\t\t\t\t\tcode += \"m33 \" + animationRegisterCache.rotationRegisters[i] + \".xyz,\" + animationRegisterCache.rotationRegisters[i] + \",\" + temp1 + \"\\n\";\n\t\t\t}\n\n\t\t}\n\n\t\tif (this._iUsesPosition) {\n\t\t\tvar positionAttribute:ShaderRegisterElement = animationRegisterCache.getFreeVertexAttribute();\n\t\t\tanimationRegisterCache.setRegisterIndex(this, ParticleFollowState.FOLLOW_POSITION_INDEX, positionAttribute.index);\n\t\t\tcode += \"add \" + animationRegisterCache.scaleAndRotateTarget + \".xyz,\" + positionAttribute + \",\" + animationRegisterCache.scaleAndRotateTarget + \".xyz\\n\";\n\t\t}\n\n\t\treturn code;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAnimationState(animator:AnimatorBase):ParticleFollowState\n\t{\n\t\treturn <ParticleFollowState> animator.getAnimationState(this);\n\t}\n}\n\nexport = ParticleFollowNode;","import ColorTransform\t\t\t\t\t= require(\"awayjs-core/lib/geom/ColorTransform\");\nimport Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport ShaderObjectBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport ShaderRegisterElement\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\n\nimport ParticleAnimationSet\t\t\t\t= require(\"awayjs-renderergl/lib/animators/ParticleAnimationSet\");\nimport ParticleProperties\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticleProperties\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticleNodeBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleNodeBase\");\nimport ParticleInitialColorState\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleInitialColorState\");\n\n/**\n *\n */\nclass ParticleInitialColorNode extends ParticleNodeBase\n{\n\t//default values used when creating states\n\t/** @private */\n\tpublic _iUsesMultiplier:boolean;\n\t/** @private */\n\tpublic _iUsesOffset:boolean;\n\t/** @private */\n\tpublic _iInitialColor:ColorTransform;\n\n\t/**\n\t * Reference for color node properties on a single particle (when in local property mode).\n\t * Expects a <code>ColorTransform</code> object representing the color transform applied to the particle.\n\t */\n\tpublic static COLOR_INITIAL_COLORTRANSFORM:string = \"ColorInitialColorTransform\";\n\n\tconstructor(mode:number /*uint*/, usesMultiplier:boolean = true, usesOffset:boolean = false, initialColor:ColorTransform = null)\n\t{\n\t\tsuper(\"ParticleInitialColor\", mode, (usesMultiplier && usesOffset)? 8 : 4, ParticleAnimationSet.COLOR_PRIORITY);\n\n\t\tthis._pStateClass = ParticleInitialColorState;\n\n\t\tthis._iUsesMultiplier = usesMultiplier;\n\t\tthis._iUsesOffset = usesOffset;\n\t\tthis._iInitialColor = initialColor || new ColorTransform();\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAGALVertexCode(shaderObject:ShaderObjectBase, animationRegisterCache:AnimationRegisterCache):string\n\t{\n\t\tvar code:string = \"\";\n\t\tif (animationRegisterCache.needFragmentAnimation) {\n\n\t\t\tif (this._iUsesMultiplier) {\n\t\t\t\tvar multiplierValue:ShaderRegisterElement = (this._pMode == ParticlePropertiesMode.GLOBAL)? animationRegisterCache.getFreeVertexConstant() : animationRegisterCache.getFreeVertexAttribute();\n\t\t\t\tanimationRegisterCache.setRegisterIndex(this, ParticleInitialColorState.MULTIPLIER_INDEX, multiplierValue.index);\n\n\t\t\t\tcode += \"mul \" + animationRegisterCache.colorMulTarget + \",\" + multiplierValue + \",\" + animationRegisterCache.colorMulTarget + \"\\n\";\n\t\t\t}\n\n\t\t\tif (this._iUsesOffset) {\n\t\t\t\tvar offsetValue:ShaderRegisterElement = (this._pMode == ParticlePropertiesMode.LOCAL_STATIC)? animationRegisterCache.getFreeVertexAttribute() : animationRegisterCache.getFreeVertexConstant();\n\t\t\t\tanimationRegisterCache.setRegisterIndex(this, ParticleInitialColorState.OFFSET_INDEX, offsetValue.index);\n\n\t\t\t\tcode += \"add \" + animationRegisterCache.colorAddTarget + \",\" + offsetValue + \",\" + animationRegisterCache.colorAddTarget + \"\\n\";\n\t\t\t}\n\t\t}\n\n\t\treturn code;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iProcessAnimationSetting(particleAnimationSet:ParticleAnimationSet)\n\t{\n\t\tif (this._iUsesMultiplier)\n\t\t\tparticleAnimationSet.hasColorMulNode = true;\n\t\tif (this._iUsesOffset)\n\t\t\tparticleAnimationSet.hasColorAddNode = true;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iGeneratePropertyOfOneParticle(param:ParticleProperties)\n\t{\n\t\tvar initialColor:ColorTransform = param[ParticleInitialColorNode.COLOR_INITIAL_COLORTRANSFORM];\n\t\tif (!initialColor)\n\t\t\tthrow(new Error(\"there is no \" + ParticleInitialColorNode.COLOR_INITIAL_COLORTRANSFORM + \" in param!\"));\n\n\t\tvar i:number /*uint*/ = 0;\n\n\t\t//multiplier\n\t\tif (this._iUsesMultiplier) {\n\t\t\tthis._pOneData[i++] = initialColor.redMultiplier;\n\t\t\tthis._pOneData[i++] = initialColor.greenMultiplier;\n\t\t\tthis._pOneData[i++] = initialColor.blueMultiplier;\n\t\t\tthis._pOneData[i++] = initialColor.alphaMultiplier;\n\t\t}\n\t\t//offset\n\t\tif (this._iUsesOffset) {\n\t\t\tthis._pOneData[i++] = initialColor.redOffset/255;\n\t\t\tthis._pOneData[i++] = initialColor.greenOffset/255;\n\t\t\tthis._pOneData[i++] = initialColor.blueOffset/255;\n\t\t\tthis._pOneData[i++] = initialColor.alphaOffset/255;\n\t\t}\n\n\t}\n\n}\n\nexport = ParticleInitialColorNode;","import AnimationNodeBase\t\t\t\t= require(\"awayjs-display/lib/animators/nodes/AnimationNodeBase\");\n\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport ShaderObjectBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\n\nimport ParticleAnimationSet\t\t\t\t= require(\"awayjs-renderergl/lib/animators/ParticleAnimationSet\");\nimport ParticleProperties\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticleProperties\");\n\n/**\n * Provides an abstract base class for particle animation nodes.\n */\nclass ParticleNodeBase extends AnimationNodeBase\n{\n\tprivate _priority:number /*int*/;\n\n\tpublic _pMode:number /*uint*/;\n\tpublic _pDataLength:number /*uint*/ = 3;\n\tpublic _pOneData:Array<number>;\n\n\tpublic _iDataOffset:number /*uint*/;\n\n\t//modes alias\n\tprivate static GLOBAL:string = 'Global';\n\tprivate static LOCAL_STATIC:string = 'LocalStatic';\n\tprivate static LOCAL_DYNAMIC:string = 'LocalDynamic';\n\n\t//modes list\n\tprivate static MODES:Object =\n\t{\n\t\t0:ParticleNodeBase.GLOBAL,\n\t\t1:ParticleNodeBase.LOCAL_STATIC,\n\t\t2:ParticleNodeBase.LOCAL_DYNAMIC\n\t};\n\n\t/**\n\t * Returns the property mode of the particle animation node. Typically set in the node constructor\n\t *\n\t * @see away.animators.ParticlePropertiesMode\n\t */\n\tpublic get mode():number /*uint*/\n\t{\n\t\treturn this._pMode;\n\t}\n\n\t/**\n\t * Returns the priority of the particle animation node, used to order the agal generated in a particle animation set. Set automatically on instantiation.\n\t *\n\t * @see away.animators.ParticleAnimationSet\n\t * @see #getAGALVertexCode\n\t */\n\tpublic get priority():number /*int*/\n\t{\n\t\treturn this._priority;\n\t}\n\n\t/**\n\t * Returns the length of the data used by the node when in <code>LOCAL_STATIC</code> mode. Used to generate the local static data of the particle animation set.\n\t *\n\t * @see away.animators.ParticleAnimationSet\n\t * @see #getAGALVertexCode\n\t */\n\tpublic get dataLength():number /*int*/\n\t{\n\t\treturn this._pDataLength;\n\t}\n\n\t/**\n\t * Returns the generated data vector of the node after one particle pass during the generation of all local static data of the particle animation set.\n\t *\n\t * @see away.animators.ParticleAnimationSet\n\t * @see #generatePropertyOfOneParticle\n\t */\n\tpublic get oneData():Array<number>\n\t{\n\t\treturn this._pOneData;\n\t}\n\n\t/**\n\t * Creates a new <code>ParticleNodeBase</code> object.\n\t *\n\t * @param               name            Defines the generic name of the particle animation node.\n\t * @param               mode            Defines whether the mode of operation acts on local properties of a particle or global properties of the node.\n\t * @param               dataLength      Defines the length of the data used by the node when in <code>LOCAL_STATIC</code> mode.\n\t * @param    [optional] priority        the priority of the particle animation node, used to order the agal generated in a particle animation set. Defaults to 1.\n\t */\n\tconstructor(name:string, mode:number /*uint*/, dataLength:number /*uint*/, priority:number /*int*/ = 1)\n\t{\n\t\tsuper();\n\n\t\tname = name + ParticleNodeBase.MODES[mode];\n\n\t\tthis.name = name;\n\t\tthis._pMode = mode;\n\t\tthis._priority = priority;\n\t\tthis._pDataLength = dataLength;\n\n\t\tthis._pOneData = new Array<number>(this._pDataLength);\n\t}\n\n\t/**\n\t * Returns the AGAL code of the particle animation node for use in the vertex shader.\n\t */\n\tpublic getAGALVertexCode(shaderObject:ShaderObjectBase, animationRegisterCache:AnimationRegisterCache):string\n\t{\n\t\treturn \"\";\n\t}\n\n\t/**\n\t * Returns the AGAL code of the particle animation node for use in the fragment shader.\n\t */\n\tpublic getAGALFragmentCode(shaderObject:ShaderObjectBase, animationRegisterCache:AnimationRegisterCache):string\n\t{\n\t\treturn \"\";\n\t}\n\n\t/**\n\t * Returns the AGAL code of the particle animation node for use in the fragment shader when UV coordinates are required.\n\t */\n\tpublic getAGALUVCode(shaderObject:ShaderObjectBase, animationRegisterCache:AnimationRegisterCache):string\n\t{\n\t\treturn \"\";\n\t}\n\n\t/**\n\t * Called internally by the particle animation set when assigning the set of static properties originally defined by the initParticleFunc of the set.\n\t *\n\t * @see away.animators.ParticleAnimationSet#initParticleFunc\n\t */\n\tpublic _iGeneratePropertyOfOneParticle(param:ParticleProperties)\n\t{\n\n\t}\n\n\t/**\n\t * Called internally by the particle animation set when determining the requirements of the particle animation node AGAL.\n\t */\n\tpublic _iProcessAnimationSetting(particleAnimationSet:ParticleAnimationSet)\n\t{\n\n\t}\n}\n\nexport = ParticleNodeBase;","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport ShaderObjectBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport ShaderRegisterElement\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\n\nimport ParticleProperties\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticleProperties\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticleNodeBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleNodeBase\");\nimport ParticleOrbitState\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleOrbitState\");\n\n/**\n * A particle animation node used to control the position of a particle over time around a circular orbit.\n */\nclass ParticleOrbitNode extends ParticleNodeBase\n{\n\t/** @private */\n\tpublic _iUsesEulers:boolean;\n\n\t/** @private */\n\tpublic _iUsesCycle:boolean;\n\n\t/** @private */\n\tpublic _iUsesPhase:boolean;\n\n\t/** @private */\n\tpublic _iRadius:number;\n\t/** @private */\n\tpublic _iCycleDuration:number;\n\t/** @private */\n\tpublic _iCyclePhase:number;\n\t/** @private */\n\tpublic _iEulers:Vector3D;\n\n\t/**\n\t * Reference for orbit node properties on a single particle (when in local property mode).\n\t * Expects a <code>Vector3D</code> object representing the radius (x), cycle speed (y) and cycle phase (z) of the motion on the particle.\n\t */\n\tpublic static ORBIT_VECTOR3D:string = \"OrbitVector3D\";\n\n\t/**\n\t * Creates a new <code>ParticleOrbitNode</code> object.\n\t *\n\t * @param               mode            Defines whether the mode of operation acts on local properties of a particle or global properties of the node.\n\t * @param    [optional] usesEulers      Defines whether the node uses the <code>eulers</code> property in the shader to calculate a rotation on the orbit. Defaults to true.\n\t * @param    [optional] usesCycle       Defines whether the node uses the <code>cycleDuration</code> property in the shader to calculate the period of the orbit independent of particle duration. Defaults to false.\n\t * @param    [optional] usesPhase       Defines whether the node uses the <code>cyclePhase</code> property in the shader to calculate a starting offset to the cycle rotation of the particle. Defaults to false.\n\t * @param    [optional] radius          Defines the radius of the orbit when in global mode. Defaults to 100.\n\t * @param    [optional] cycleDuration   Defines the duration of the orbit in seconds, used as a period independent of particle duration when in global mode. Defaults to 1.\n\t * @param    [optional] cyclePhase      Defines the phase of the orbit in degrees, used as the starting offset of the cycle when in global mode. Defaults to 0.\n\t * @param    [optional] eulers          Defines the euler rotation in degrees, applied to the orientation of the orbit when in global mode.\n\t */\n\tconstructor(mode:number /*uint*/, usesEulers:boolean = true, usesCycle:boolean = false, usesPhase:boolean = false, radius:number = 100, cycleDuration:number = 1, cyclePhase:number = 0, eulers:Vector3D = null)\n\t{\n\t\tvar len:number /*int*/ = 3;\n\t\tif (usesPhase)\n\t\t\tlen++;\n\t\tsuper(\"ParticleOrbit\", mode, len);\n\n\t\tthis._pStateClass = ParticleOrbitState;\n\n\t\tthis._iUsesEulers = usesEulers;\n\t\tthis._iUsesCycle = usesCycle;\n\t\tthis._iUsesPhase = usesPhase;\n\n\t\tthis._iRadius = radius;\n\t\tthis._iCycleDuration = cycleDuration;\n\t\tthis._iCyclePhase = cyclePhase;\n\t\tthis._iEulers = eulers || new Vector3D();\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAGALVertexCode(shaderObject:ShaderObjectBase, animationRegisterCache:AnimationRegisterCache):string\n\t{\n\t\tvar orbitRegister:ShaderRegisterElement = (this._pMode == ParticlePropertiesMode.GLOBAL)? animationRegisterCache.getFreeVertexConstant() : animationRegisterCache.getFreeVertexAttribute();\n\t\tanimationRegisterCache.setRegisterIndex(this, ParticleOrbitState.ORBIT_INDEX, orbitRegister.index);\n\n\t\tvar eulersMatrixRegister:ShaderRegisterElement = animationRegisterCache.getFreeVertexConstant();\n\t\tanimationRegisterCache.setRegisterIndex(this, ParticleOrbitState.EULERS_INDEX, eulersMatrixRegister.index);\n\t\tanimationRegisterCache.getFreeVertexConstant();\n\t\tanimationRegisterCache.getFreeVertexConstant();\n\t\tanimationRegisterCache.getFreeVertexConstant();\n\n\t\tvar temp1:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\t\tanimationRegisterCache.addVertexTempUsages(temp1, 1);\n\t\tvar distance:ShaderRegisterElement = new ShaderRegisterElement(temp1.regName, temp1.index);\n\n\t\tvar temp2:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\t\tvar cos:ShaderRegisterElement = new ShaderRegisterElement(temp2.regName, temp2.index, 0);\n\t\tvar sin:ShaderRegisterElement = new ShaderRegisterElement(temp2.regName, temp2.index, 1);\n\t\tvar degree:ShaderRegisterElement = new ShaderRegisterElement(temp2.regName, temp2.index, 2);\n\t\tanimationRegisterCache.removeVertexTempUsage(temp1);\n\n\t\tvar code:string = \"\";\n\n\t\tif (this._iUsesCycle) {\n\t\t\tcode += \"mul \" + degree + \",\" + animationRegisterCache.vertexTime + \",\" + orbitRegister + \".y\\n\";\n\n\t\t\tif (this._iUsesPhase)\n\t\t\t\tcode += \"add \" + degree + \",\" + degree + \",\" + orbitRegister + \".w\\n\";\n\t\t} else\n\t\t\tcode += \"mul \" + degree + \",\" + animationRegisterCache.vertexLife + \",\" + orbitRegister + \".y\\n\";\n\n\t\tcode += \"cos \" + cos + \",\" + degree + \"\\n\";\n\t\tcode += \"sin \" + sin + \",\" + degree + \"\\n\";\n\t\tcode += \"mul \" + distance + \".x,\" + cos + \",\" + orbitRegister + \".x\\n\";\n\t\tcode += \"mul \" + distance + \".y,\" + sin + \",\" + orbitRegister + \".x\\n\";\n\t\tcode += \"mov \" + distance + \".wz\" + animationRegisterCache.vertexZeroConst + \"\\n\";\n\t\tif (this._iUsesEulers)\n\t\t\tcode += \"m44 \" + distance + \",\" + distance + \",\" + eulersMatrixRegister + \"\\n\";\n\t\tcode += \"add \" + animationRegisterCache.positionTarget + \".xyz,\" + distance + \".xyz,\" + animationRegisterCache.positionTarget + \".xyz\\n\";\n\n\t\tif (animationRegisterCache.needVelocity) {\n\t\t\tcode += \"neg \" + distance + \".x,\" + sin + \"\\n\";\n\t\t\tcode += \"mov \" + distance + \".y,\" + cos + \"\\n\";\n\t\t\tcode += \"mov \" + distance + \".zw,\" + animationRegisterCache.vertexZeroConst + \"\\n\";\n\t\t\tif (this._iUsesEulers)\n\t\t\t\tcode += \"m44 \" + distance + \",\" + distance + \",\" + eulersMatrixRegister + \"\\n\";\n\t\t\tcode += \"mul \" + distance + \",\" + distance + \",\" + orbitRegister + \".z\\n\";\n\t\t\tcode += \"div \" + distance + \",\" + distance + \",\" + orbitRegister + \".y\\n\";\n\t\t\tif (!this._iUsesCycle)\n\t\t\t\tcode += \"div \" + distance + \",\" + distance + \",\" + animationRegisterCache.vertexLife + \"\\n\";\n\t\t\tcode += \"add \" + animationRegisterCache.velocityTarget + \".xyz,\" + animationRegisterCache.velocityTarget + \".xyz,\" + distance + \".xyz\\n\";\n\t\t}\n\t\treturn code;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAnimationState(animator:AnimatorBase):ParticleOrbitState\n\t{\n\t\treturn <ParticleOrbitState> animator.getAnimationState(this);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iGeneratePropertyOfOneParticle(param:ParticleProperties)\n\t{\n\t\t//Vector3D.x is radius, Vector3D.y is cycle duration, Vector3D.z is phase\n\t\tvar orbit:Vector3D = param[ParticleOrbitNode.ORBIT_VECTOR3D];\n\t\tif (!orbit)\n\t\t\tthrow new Error(\"there is no \" + ParticleOrbitNode.ORBIT_VECTOR3D + \" in param!\");\n\n\t\tthis._pOneData[0] = orbit.x;\n\t\tif (this._iUsesCycle && orbit.y <= 0)\n\t\t\tthrow(new Error(\"the cycle duration must be greater than zero\"));\n\t\tthis._pOneData[1] = Math.PI*2/(!this._iUsesCycle? 1 : orbit.y);\n\t\tthis._pOneData[2] = orbit.x*Math.PI*2;\n\t\tif (this._iUsesPhase)\n\t\t\tthis._pOneData[3] = orbit.z*Math.PI/180;\n\t}\n}\n\nexport = ParticleOrbitNode;","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport ShaderObjectBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport ShaderRegisterElement\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\n\nimport ParticleProperties\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticleProperties\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticleNodeBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleNodeBase\");\nimport ParticleOscillatorState\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleOscillatorState\");\n\n/**\n * A particle animation node used to control the position of a particle over time using simple harmonic motion.\n */\nclass ParticleOscillatorNode extends ParticleNodeBase\n{\n\t/** @private */\n\tpublic _iOscillator:Vector3D;\n\n\t/**\n\t * Reference for ocsillator node properties on a single particle (when in local property mode).\n\t * Expects a <code>Vector3D</code> object representing the axis (x,y,z) and cycle speed (w) of the motion on the particle.\n\t */\n\tpublic static OSCILLATOR_VECTOR3D:string = \"OscillatorVector3D\";\n\n\t/**\n\t * Creates a new <code>ParticleOscillatorNode</code>\n\t *\n\t * @param               mode            Defines whether the mode of operation acts on local properties of a particle or global properties of the node.\n\t * @param    [optional] oscillator      Defines the default oscillator axis (x, y, z) and cycleDuration (w) of the node, used when in global mode.\n\t */\n\tconstructor(mode:number /*uint*/, oscillator:Vector3D = null)\n\t{\n\t\tsuper(\"ParticleOscillator\", mode, 4);\n\n\t\tthis._pStateClass = ParticleOscillatorState;\n\n\t\tthis._iOscillator = oscillator || new Vector3D();\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAGALVertexCode(shaderObject:ShaderObjectBase, animationRegisterCache:AnimationRegisterCache):string\n\t{\n\t\tvar oscillatorRegister:ShaderRegisterElement = (this._pMode == ParticlePropertiesMode.GLOBAL)? animationRegisterCache.getFreeVertexConstant() : animationRegisterCache.getFreeVertexAttribute();\n\t\tanimationRegisterCache.setRegisterIndex(this, ParticleOscillatorState.OSCILLATOR_INDEX, oscillatorRegister.index);\n\t\tvar temp:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\t\tvar dgree:ShaderRegisterElement = new ShaderRegisterElement(temp.regName, temp.index, 0);\n\t\tvar sin:ShaderRegisterElement = new ShaderRegisterElement(temp.regName, temp.index, 1);\n\t\tvar cos:ShaderRegisterElement = new ShaderRegisterElement(temp.regName, temp.index, 2);\n\t\tanimationRegisterCache.addVertexTempUsages(temp, 1);\n\t\tvar temp2:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\t\tvar distance:ShaderRegisterElement = new ShaderRegisterElement(temp2.regName, temp2.index);\n\t\tanimationRegisterCache.removeVertexTempUsage(temp);\n\n\t\tvar code:string = \"\";\n\t\tcode += \"mul \" + dgree + \",\" + animationRegisterCache.vertexTime + \",\" + oscillatorRegister + \".w\\n\";\n\t\tcode += \"sin \" + sin + \",\" + dgree + \"\\n\";\n\t\tcode += \"mul \" + distance + \".xyz,\" + sin + \",\" + oscillatorRegister + \".xyz\\n\";\n\t\tcode += \"add \" + animationRegisterCache.positionTarget + \".xyz,\" + distance + \".xyz,\" + animationRegisterCache.positionTarget + \".xyz\\n\";\n\n\t\tif (animationRegisterCache.needVelocity) {\n\t\t\tcode += \"cos \" + cos + \",\" + dgree + \"\\n\";\n\t\t\tcode += \"mul \" + distance + \".xyz,\" + cos + \",\" + oscillatorRegister + \".xyz\\n\";\n\t\t\tcode += \"add \" + animationRegisterCache.velocityTarget + \".xyz,\" + distance + \".xyz,\" + animationRegisterCache.velocityTarget + \".xyz\\n\";\n\t\t}\n\n\t\treturn code;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAnimationState(animator:AnimatorBase):ParticleOscillatorState\n\t{\n\t\treturn <ParticleOscillatorState> animator.getAnimationState(this);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iGeneratePropertyOfOneParticle(param:ParticleProperties)\n\t{\n\t\t//(Vector3D.x,Vector3D.y,Vector3D.z) is oscillator axis, Vector3D.w is oscillator cycle duration\n\t\tvar drift:Vector3D = param[ParticleOscillatorNode.OSCILLATOR_VECTOR3D];\n\t\tif (!drift)\n\t\t\tthrow(new Error(\"there is no \" + ParticleOscillatorNode.OSCILLATOR_VECTOR3D + \" in param!\"));\n\n\t\tthis._pOneData[0] = drift.x;\n\t\tthis._pOneData[1] = drift.y;\n\t\tthis._pOneData[2] = drift.z;\n\t\tif (drift.w <= 0)\n\t\t\tthrow(new Error(\"the cycle duration must greater than zero\"));\n\t\tthis._pOneData[3] = Math.PI*2/drift.w;\n\t}\n}\n\nexport = ParticleOscillatorNode;","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport ShaderObjectBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport ShaderRegisterElement\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\n\nimport ParticleProperties\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticleProperties\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticleNodeBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleNodeBase\");\nimport ParticlePositionState\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticlePositionState\");\n\n/**\n * A particle animation node used to set the starting position of a particle.\n */\nclass ParticlePositionNode extends ParticleNodeBase\n{\n\t/** @private */\n\tpublic _iPosition:Vector3D;\n\n\t/**\n\t * Reference for position node properties on a single particle (when in local property mode).\n\t * Expects a <code>Vector3D</code> object representing position of the particle.\n\t */\n\tpublic static POSITION_VECTOR3D:string = \"PositionVector3D\";\n\n\t/**\n\t * Creates a new <code>ParticlePositionNode</code>\n\t *\n\t * @param               mode            Defines whether the mode of operation acts on local properties of a particle or global properties of the node.\n\t * @param    [optional] position        Defines the default position of the particle when in global mode. Defaults to 0,0,0.\n\t */\n\tconstructor(mode:number /*uint*/, position:Vector3D = null)\n\t{\n\t\tsuper(\"ParticlePosition\", mode, 3);\n\n\t\tthis._pStateClass = ParticlePositionState;\n\n\t\tthis._iPosition = position || new Vector3D();\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAGALVertexCode(shaderObject:ShaderObjectBase, animationRegisterCache:AnimationRegisterCache):string\n\t{\n\t\tvar positionAttribute:ShaderRegisterElement = (this._pMode == ParticlePropertiesMode.GLOBAL)? animationRegisterCache.getFreeVertexConstant() : animationRegisterCache.getFreeVertexAttribute();\n\t\tanimationRegisterCache.setRegisterIndex(this, ParticlePositionState.POSITION_INDEX, positionAttribute.index);\n\n\t\treturn \"add \" + animationRegisterCache.positionTarget + \".xyz,\" + positionAttribute + \".xyz,\" + animationRegisterCache.positionTarget + \".xyz\\n\";\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAnimationState(animator:AnimatorBase):ParticlePositionState\n\t{\n\t\treturn <ParticlePositionState> animator.getAnimationState(this);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iGeneratePropertyOfOneParticle(param:ParticleProperties)\n\t{\n\t\tvar offset:Vector3D = param[ParticlePositionNode.POSITION_VECTOR3D];\n\t\tif (!offset)\n\t\t\tthrow(new Error(\"there is no \" + ParticlePositionNode.POSITION_VECTOR3D + \" in param!\"));\n\n\t\tthis._pOneData[0] = offset.x;\n\t\tthis._pOneData[1] = offset.y;\n\t\tthis._pOneData[2] = offset.z;\n\t}\n}\n\nexport = ParticlePositionNode;","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport ShaderObjectBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport ShaderRegisterElement\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\n\nimport ParticleAnimationSet\t\t\t\t= require(\"awayjs-renderergl/lib/animators/ParticleAnimationSet\");\nimport ParticleProperties\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticleProperties\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticleNodeBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleNodeBase\");\nimport ParticleRotateToHeadingState\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleRotateToHeadingState\");\n\n/**\n * A particle animation node used to control the rotation of a particle to match its heading vector.\n */\nclass ParticleRotateToHeadingNode extends ParticleNodeBase\n{\n\t/**\n\t * Creates a new <code>ParticleBillboardNode</code>\n\t */\n\tconstructor()\n\t{\n\t\tsuper(\"ParticleRotateToHeading\", ParticlePropertiesMode.GLOBAL, 0, 3);\n\n\t\tthis._pStateClass = ParticleRotateToHeadingState;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAGALVertexCode(shaderObject:ShaderObjectBase, animationRegisterCache:AnimationRegisterCache):string\n\t{\n\t\tvar code:string = \"\";\n\t\tvar len:number /*int*/ = animationRegisterCache.rotationRegisters.length;\n\t\tvar i:number /*int*/;\n\t\tif (animationRegisterCache.hasBillboard) {\n\t\t\tvar temp1:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\t\t\tanimationRegisterCache.addVertexTempUsages(temp1, 1);\n\t\t\tvar temp2:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\t\t\tanimationRegisterCache.addVertexTempUsages(temp2, 1);\n\t\t\tvar temp3:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\n\t\t\tvar rotationMatrixRegister:ShaderRegisterElement = animationRegisterCache.getFreeVertexConstant();\n\t\t\tanimationRegisterCache.setRegisterIndex(this, ParticleRotateToHeadingState.MATRIX_INDEX, rotationMatrixRegister.index);\n\t\t\tanimationRegisterCache.getFreeVertexConstant();\n\t\t\tanimationRegisterCache.getFreeVertexConstant();\n\t\t\tanimationRegisterCache.getFreeVertexConstant();\n\n\t\t\tanimationRegisterCache.removeVertexTempUsage(temp1);\n\t\t\tanimationRegisterCache.removeVertexTempUsage(temp2);\n\n\t\t\t//process the velocity\n\t\t\tcode += \"m33 \" + temp1 + \".xyz,\" + animationRegisterCache.velocityTarget + \".xyz,\" + rotationMatrixRegister + \"\\n\";\n\n\t\t\tcode += \"mov \" + temp3 + \",\" + animationRegisterCache.vertexZeroConst + \"\\n\";\n\t\t\tcode += \"mov \" + temp3 + \".xy,\" + temp1 + \".xy\\n\";\n\t\t\tcode += \"nrm \" + temp3 + \".xyz,\" + temp3 + \".xyz\\n\";\n\n\t\t\t//temp3.x=cos,temp3.y=sin\n\t\t\t//only process z axis\n\t\t\tcode += \"mov \" + temp2 + \",\" + animationRegisterCache.vertexZeroConst + \"\\n\";\n\t\t\tcode += \"mov \" + temp2 + \".x,\" + temp3 + \".y\\n\";\n\t\t\tcode += \"mov \" + temp2 + \".y,\" + temp3 + \".x\\n\";\n\t\t\tcode += \"mov \" + temp1 + \",\" + animationRegisterCache.vertexZeroConst + \"\\n\";\n\t\t\tcode += \"mov \" + temp1 + \".x,\" + temp3 + \".x\\n\";\n\t\t\tcode += \"neg \" + temp1 + \".y,\" + temp3 + \".y\\n\";\n\t\t\tcode += \"mov \" + temp3 + \",\" + animationRegisterCache.vertexZeroConst + \"\\n\";\n\t\t\tcode += \"mov \" + temp3 + \".z,\" + animationRegisterCache.vertexOneConst + \"\\n\";\n\t\t\tcode += \"m33 \" + animationRegisterCache.scaleAndRotateTarget + \".xyz,\" + animationRegisterCache.scaleAndRotateTarget + \".xyz,\" + temp1 + \"\\n\";\n\t\t\tfor (i = 0; i < len; i++)\n\t\t\t\tcode += \"m33 \" + animationRegisterCache.rotationRegisters[i] + \".xyz,\" + animationRegisterCache.rotationRegisters[i] + \",\" + temp1 + \"\\n\";\n\t\t} else {\n\t\t\tvar nrmVel:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\t\t\tanimationRegisterCache.addVertexTempUsages(nrmVel, 1);\n\n\t\t\tvar xAxis:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\t\t\tanimationRegisterCache.addVertexTempUsages(xAxis, 1);\n\n\t\t\tvar R:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\t\t\tanimationRegisterCache.addVertexTempUsages(R, 1);\n\t\t\tvar R_rev:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\t\t\tvar cos:ShaderRegisterElement = new ShaderRegisterElement(R.regName, R.index, 3);\n\t\t\tvar sin:ShaderRegisterElement = new ShaderRegisterElement(R_rev.regName, R_rev.index, 3);\n\t\t\tvar cos2:ShaderRegisterElement = new ShaderRegisterElement(nrmVel.regName, nrmVel.index, 3);\n\t\t\tvar tempSingle:ShaderRegisterElement = sin;\n\n\t\t\tanimationRegisterCache.removeVertexTempUsage(nrmVel);\n\t\t\tanimationRegisterCache.removeVertexTempUsage(xAxis);\n\t\t\tanimationRegisterCache.removeVertexTempUsage(R);\n\n\t\t\tcode += \"mov \" + xAxis + \".x,\" + animationRegisterCache.vertexOneConst + \"\\n\";\n\t\t\tcode += \"mov \" + xAxis + \".yz,\" + animationRegisterCache.vertexZeroConst + \"\\n\";\n\n\t\t\tcode += \"nrm \" + nrmVel + \".xyz,\" + animationRegisterCache.velocityTarget + \".xyz\\n\";\n\t\t\tcode += \"dp3 \" + cos2 + \",\" + nrmVel + \".xyz,\" + xAxis + \".xyz\\n\";\n\t\t\tcode += \"crs \" + nrmVel + \".xyz,\" + xAxis + \".xyz,\" + nrmVel + \".xyz\\n\";\n\t\t\tcode += \"nrm \" + nrmVel + \".xyz,\" + nrmVel + \".xyz\\n\";\n\t\t\t//use R as temp to judge if nrm is (0,0,0).\n\t\t\t//if nrm is (0,0,0) ,change it to (0,0,1).\n\t\t\tcode += \"dp3 \" + R + \".x,\" + nrmVel + \".xyz,\" + nrmVel + \".xyz\\n\";\n\t\t\tcode += \"sge \" + R + \".x,\" + animationRegisterCache.vertexZeroConst + \",\" + R + \".x\\n\";\n\t\t\tcode += \"add \" + nrmVel + \".z,\" + R + \".x,\" + nrmVel + \".z\\n\";\n\n\t\t\tcode += \"add \" + tempSingle + \",\" + cos2 + \",\" + animationRegisterCache.vertexOneConst + \"\\n\";\n\t\t\tcode += \"div \" + tempSingle + \",\" + tempSingle + \",\" + animationRegisterCache.vertexTwoConst + \"\\n\";\n\t\t\tcode += \"sqt \" + cos + \",\" + tempSingle + \"\\n\";\n\n\t\t\tcode += \"sub \" + tempSingle + \",\" + animationRegisterCache.vertexOneConst + \",\" + cos2 + \"\\n\";\n\t\t\tcode += \"div \" + tempSingle + \",\" + tempSingle + \",\" + animationRegisterCache.vertexTwoConst + \"\\n\";\n\t\t\tcode += \"sqt \" + sin + \",\" + tempSingle + \"\\n\";\n\n\t\t\tcode += \"mul \" + R + \".xyz,\" + sin + \",\" + nrmVel + \".xyz\\n\";\n\n\t\t\t//use cos as R.w\n\n\t\t\tcode += \"mul \" + R_rev + \".xyz,\" + sin + \",\" + nrmVel + \".xyz\\n\";\n\t\t\tcode += \"neg \" + R_rev + \".xyz,\" + R_rev + \".xyz\\n\";\n\n\t\t\t//use cos as R_rev.w\n\n\t\t\t//nrmVel and xAxis are used as temp register\n\t\t\tcode += \"crs \" + nrmVel + \".xyz,\" + R + \".xyz,\" + animationRegisterCache.scaleAndRotateTarget + \".xyz\\n\";\n\n\t\t\t//use cos as R.w\n\t\t\tcode += \"mul \" + xAxis + \".xyz,\" + cos + \",\" + animationRegisterCache.scaleAndRotateTarget + \".xyz\\n\";\n\t\t\tcode += \"add \" + nrmVel + \".xyz,\" + nrmVel + \".xyz,\" + xAxis + \".xyz\\n\";\n\t\t\tcode += \"dp3 \" + xAxis + \".w,\" + R + \".xyz,\" + animationRegisterCache.scaleAndRotateTarget + \".xyz\\n\";\n\t\t\tcode += \"neg \" + nrmVel + \".w,\" + xAxis + \".w\\n\";\n\n\t\t\tcode += \"crs \" + R + \".xyz,\" + nrmVel + \".xyz,\" + R_rev + \".xyz\\n\";\n\t\t\t//code += \"mul \" + xAxis + \".xyzw,\" + nrmVel + \".xyzw,\" +R_rev + \".w\\n\";\n\t\t\tcode += \"mul \" + xAxis + \".xyzw,\" + nrmVel + \".xyzw,\" + cos + \"\\n\";\n\t\t\tcode += \"add \" + R + \".xyz,\" + R + \".xyz,\" + xAxis + \".xyz\\n\";\n\t\t\tcode += \"mul \" + xAxis + \".xyz,\" + nrmVel + \".w,\" + R_rev + \".xyz\\n\";\n\n\t\t\tcode += \"add \" + animationRegisterCache.scaleAndRotateTarget + \".xyz,\" + R + \".xyz,\" + xAxis + \".xyz\\n\";\n\n\t\t\tfor (i = 0; i < len; i++) {\n\t\t\t\t//just repeat the calculate above\n\t\t\t\t//because of the limited registers, no need to optimise\n\t\t\t\tcode += \"mov \" + xAxis + \".x,\" + animationRegisterCache.vertexOneConst + \"\\n\";\n\t\t\t\tcode += \"mov \" + xAxis + \".yz,\" + animationRegisterCache.vertexZeroConst + \"\\n\";\n\t\t\t\tcode += \"nrm \" + nrmVel + \".xyz,\" + animationRegisterCache.velocityTarget + \".xyz\\n\";\n\t\t\t\tcode += \"dp3 \" + cos2 + \",\" + nrmVel + \".xyz,\" + xAxis + \".xyz\\n\";\n\t\t\t\tcode += \"crs \" + nrmVel + \".xyz,\" + xAxis + \".xyz,\" + nrmVel + \".xyz\\n\";\n\t\t\t\tcode += \"nrm \" + nrmVel + \".xyz,\" + nrmVel + \".xyz\\n\";\n\t\t\t\tcode += \"dp3 \" + R + \".x,\" + nrmVel + \".xyz,\" + nrmVel + \".xyz\\n\";\n\t\t\t\tcode += \"sge \" + R + \".x,\" + animationRegisterCache.vertexZeroConst + \",\" + R + \".x\\n\";\n\t\t\t\tcode += \"add \" + nrmVel + \".z,\" + R + \".x,\" + nrmVel + \".z\\n\";\n\t\t\t\tcode += \"add \" + tempSingle + \",\" + cos2 + \",\" + animationRegisterCache.vertexOneConst + \"\\n\";\n\t\t\t\tcode += \"div \" + tempSingle + \",\" + tempSingle + \",\" + animationRegisterCache.vertexTwoConst + \"\\n\";\n\t\t\t\tcode += \"sqt \" + cos + \",\" + tempSingle + \"\\n\";\n\t\t\t\tcode += \"sub \" + tempSingle + \",\" + animationRegisterCache.vertexOneConst + \",\" + cos2 + \"\\n\";\n\t\t\t\tcode += \"div \" + tempSingle + \",\" + tempSingle + \",\" + animationRegisterCache.vertexTwoConst + \"\\n\";\n\t\t\t\tcode += \"sqt \" + sin + \",\" + tempSingle + \"\\n\";\n\t\t\t\tcode += \"mul \" + R + \".xyz,\" + sin + \",\" + nrmVel + \".xyz\\n\";\n\t\t\t\tcode += \"mul \" + R_rev + \".xyz,\" + sin + \",\" + nrmVel + \".xyz\\n\";\n\t\t\t\tcode += \"neg \" + R_rev + \".xyz,\" + R_rev + \".xyz\\n\";\n\t\t\t\tcode += \"crs \" + nrmVel + \".xyz,\" + R + \".xyz,\" + animationRegisterCache.rotationRegisters[i] + \".xyz\\n\";\n\t\t\t\tcode += \"mul \" + xAxis + \".xyz,\" + cos + \",\" + animationRegisterCache.rotationRegisters[i] + \".xyz\\n\";\n\t\t\t\tcode += \"add \" + nrmVel + \".xyz,\" + nrmVel + \".xyz,\" + xAxis + \".xyz\\n\";\n\t\t\t\tcode += \"dp3 \" + xAxis + \".w,\" + R + \".xyz,\" + animationRegisterCache.rotationRegisters[i] + \".xyz\\n\";\n\t\t\t\tcode += \"neg \" + nrmVel + \".w,\" + xAxis + \".w\\n\";\n\t\t\t\tcode += \"crs \" + R + \".xyz,\" + nrmVel + \".xyz,\" + R_rev + \".xyz\\n\";\n\t\t\t\tcode += \"mul \" + xAxis + \".xyzw,\" + nrmVel + \".xyzw,\" + cos + \"\\n\";\n\t\t\t\tcode += \"add \" + R + \".xyz,\" + R + \".xyz,\" + xAxis + \".xyz\\n\";\n\t\t\t\tcode += \"mul \" + xAxis + \".xyz,\" + nrmVel + \".w,\" + R_rev + \".xyz\\n\";\n\t\t\t\tcode += \"add \" + animationRegisterCache.rotationRegisters[i] + \".xyz,\" + R + \".xyz,\" + xAxis + \".xyz\\n\";\n\t\t\t}\n\n\t\t}\n\t\treturn code;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAnimationState(animator:AnimatorBase):ParticleRotateToHeadingState\n\t{\n\t\treturn <ParticleRotateToHeadingState> animator.getAnimationState(this);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iProcessAnimationSetting(particleAnimationSet:ParticleAnimationSet)\n\t{\n\t\tparticleAnimationSet.needVelocity = true;\n\t}\n}\n\nexport = ParticleRotateToHeadingNode;","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport ShaderObjectBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport ShaderRegisterElement\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\n\nimport ParticleProperties\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticleProperties\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticleNodeBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleNodeBase\");\nimport ParticleRotateToPositionState\t= require(\"awayjs-renderergl/lib/animators/states/ParticleRotateToPositionState\");\n\n/**\n * A particle animation node used to control the rotation of a particle to face to a position\n */\nclass ParticleRotateToPositionNode extends ParticleNodeBase\n{\n\t/** @private */\n\tpublic _iPosition:Vector3D;\n\n\t/**\n\t * Reference for the position the particle will rotate to face for a single particle (when in local property mode).\n\t * Expects a <code>Vector3D</code> object representing the position that the particle must face.\n\t */\n\tpublic static POSITION_VECTOR3D:string = \"RotateToPositionVector3D\";\n\n\t/**\n\t * Creates a new <code>ParticleRotateToPositionNode</code>\n\t */\n\tconstructor(mode:number /*uint*/, position:Vector3D = null)\n\t{\n\t\tsuper(\"ParticleRotateToPosition\", mode, 3, 3);\n\n\t\tthis._pStateClass = ParticleRotateToPositionState;\n\n\t\tthis._iPosition = position || new Vector3D();\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAGALVertexCode(shaderObject:ShaderObjectBase, animationRegisterCache:AnimationRegisterCache):string\n\t{\n\t\tvar positionAttribute:ShaderRegisterElement = (this._pMode == ParticlePropertiesMode.GLOBAL)? animationRegisterCache.getFreeVertexConstant() : animationRegisterCache.getFreeVertexAttribute();\n\t\tanimationRegisterCache.setRegisterIndex(this, ParticleRotateToPositionState.POSITION_INDEX, positionAttribute.index);\n\n\t\tvar code:string = \"\";\n\t\tvar len:number /*int*/ = animationRegisterCache.rotationRegisters.length;\n\t\tvar i:number /*int*/;\n\t\tif (animationRegisterCache.hasBillboard) {\n\t\t\tvar temp1:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\t\t\tanimationRegisterCache.addVertexTempUsages(temp1, 1);\n\t\t\tvar temp2:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\t\t\tanimationRegisterCache.addVertexTempUsages(temp2, 1);\n\t\t\tvar temp3:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\n\t\t\tvar rotationMatrixRegister:ShaderRegisterElement = animationRegisterCache.getFreeVertexConstant();\n\t\t\tanimationRegisterCache.setRegisterIndex(this, ParticleRotateToPositionState.MATRIX_INDEX, rotationMatrixRegister.index);\n\t\t\tanimationRegisterCache.getFreeVertexConstant();\n\t\t\tanimationRegisterCache.getFreeVertexConstant();\n\t\t\tanimationRegisterCache.getFreeVertexConstant();\n\n\t\t\tanimationRegisterCache.removeVertexTempUsage(temp1);\n\t\t\tanimationRegisterCache.removeVertexTempUsage(temp2);\n\n\t\t\t//process the position\n\t\t\tcode += \"sub \" + temp1 + \".xyz,\" + positionAttribute + \".xyz,\" + animationRegisterCache.positionTarget + \".xyz\\n\";\n\t\t\tcode += \"m33 \" + temp1 + \".xyz,\" + temp1 + \".xyz,\" + rotationMatrixRegister + \"\\n\";\n\n\t\t\tcode += \"mov \" + temp3 + \",\" + animationRegisterCache.vertexZeroConst + \"\\n\";\n\t\t\tcode += \"mov \" + temp3 + \".xy,\" + temp1 + \".xy\\n\";\n\t\t\tcode += \"nrm \" + temp3 + \".xyz,\" + temp3 + \".xyz\\n\";\n\n\t\t\t//temp3.x=cos,temp3.y=sin\n\t\t\t//only process z axis\n\t\t\tcode += \"mov \" + temp2 + \",\" + animationRegisterCache.vertexZeroConst + \"\\n\";\n\t\t\tcode += \"mov \" + temp2 + \".x,\" + temp3 + \".y\\n\";\n\t\t\tcode += \"mov \" + temp2 + \".y,\" + temp3 + \".x\\n\";\n\t\t\tcode += \"mov \" + temp1 + \",\" + animationRegisterCache.vertexZeroConst + \"\\n\";\n\t\t\tcode += \"mov \" + temp1 + \".x,\" + temp3 + \".x\\n\";\n\t\t\tcode += \"neg \" + temp1 + \".y,\" + temp3 + \".y\\n\";\n\t\t\tcode += \"mov \" + temp3 + \",\" + animationRegisterCache.vertexZeroConst + \"\\n\";\n\t\t\tcode += \"mov \" + temp3 + \".z,\" + animationRegisterCache.vertexOneConst + \"\\n\";\n\t\t\tcode += \"m33 \" + animationRegisterCache.scaleAndRotateTarget + \".xyz,\" + animationRegisterCache.scaleAndRotateTarget + \".xyz,\" + temp1 + \"\\n\";\n\t\t\tfor (i = 0; i < len; i++)\n\t\t\t\tcode += \"m33 \" + animationRegisterCache.rotationRegisters[i] + \".xyz,\" + animationRegisterCache.rotationRegisters[i] + \",\" + temp1 + \"\\n\";\n\t\t} else {\n\t\t\tvar nrmDirection:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\t\t\tanimationRegisterCache.addVertexTempUsages(nrmDirection, 1);\n\n\t\t\tvar temp:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\t\t\tanimationRegisterCache.addVertexTempUsages(temp, 1);\n\t\t\tvar cos:ShaderRegisterElement = new ShaderRegisterElement(temp.regName, temp.index, 0);\n\t\t\tvar sin:ShaderRegisterElement = new ShaderRegisterElement(temp.regName, temp.index, 1);\n\t\t\tvar o_temp:ShaderRegisterElement = new ShaderRegisterElement(temp.regName, temp.index, 2);\n\t\t\tvar tempSingle:ShaderRegisterElement = new ShaderRegisterElement(temp.regName, temp.index, 3);\n\n\t\t\tvar R:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\t\t\tanimationRegisterCache.addVertexTempUsages(R, 1);\n\n\t\t\tanimationRegisterCache.removeVertexTempUsage(nrmDirection);\n\t\t\tanimationRegisterCache.removeVertexTempUsage(temp);\n\t\t\tanimationRegisterCache.removeVertexTempUsage(R);\n\n\t\t\tcode += \"sub \" + nrmDirection + \".xyz,\" + positionAttribute + \".xyz,\" + animationRegisterCache.positionTarget + \".xyz\\n\";\n\t\t\tcode += \"nrm \" + nrmDirection + \".xyz,\" + nrmDirection + \".xyz\\n\";\n\n\t\t\tcode += \"mov \" + sin + \",\" + nrmDirection + \".y\\n\";\n\t\t\tcode += \"mul \" + cos + \",\" + sin + \",\" + sin + \"\\n\";\n\t\t\tcode += \"sub \" + cos + \",\" + animationRegisterCache.vertexOneConst + \",\" + cos + \"\\n\";\n\t\t\tcode += \"sqt \" + cos + \",\" + cos + \"\\n\";\n\n\t\t\tcode += \"mul \" + R + \".x,\" + cos + \",\" + animationRegisterCache.scaleAndRotateTarget + \".y\\n\";\n\t\t\tcode += \"mul \" + R + \".y,\" + sin + \",\" + animationRegisterCache.scaleAndRotateTarget + \".z\\n\";\n\t\t\tcode += \"mul \" + R + \".z,\" + sin + \",\" + animationRegisterCache.scaleAndRotateTarget + \".y\\n\";\n\t\t\tcode += \"mul \" + R + \".w,\" + cos + \",\" + animationRegisterCache.scaleAndRotateTarget + \".z\\n\";\n\n\t\t\tcode += \"sub \" + animationRegisterCache.scaleAndRotateTarget + \".y,\" + R + \".x,\" + R + \".y\\n\";\n\t\t\tcode += \"add \" + animationRegisterCache.scaleAndRotateTarget + \".z,\" + R + \".z,\" + R + \".w\\n\";\n\n\t\t\tcode += \"abs \" + R + \".y,\" + nrmDirection + \".y\\n\";\n\t\t\tcode += \"sge \" + R + \".z,\" + R + \".y,\" + animationRegisterCache.vertexOneConst + \"\\n\";\n\t\t\tcode += \"mul \" + R + \".x,\" + R + \".y,\" + nrmDirection + \".y\\n\";\n\n\t\t\t//judgu if nrmDirection=(0,1,0);\n\t\t\tcode += \"mov \" + nrmDirection + \".y,\" + animationRegisterCache.vertexZeroConst + \"\\n\";\n\t\t\tcode += \"dp3 \" + sin + \",\" + nrmDirection + \".xyz,\" + nrmDirection + \".xyz\\n\";\n\t\t\tcode += \"sge \" + tempSingle + \",\" + animationRegisterCache.vertexZeroConst + \",\" + sin + \"\\n\";\n\n\t\t\tcode += \"mov \" + nrmDirection + \".y,\" + animationRegisterCache.vertexZeroConst + \"\\n\";\n\t\t\tcode += \"nrm \" + nrmDirection + \".xyz,\" + nrmDirection + \".xyz\\n\";\n\n\t\t\tcode += \"sub \" + sin + \",\" + animationRegisterCache.vertexOneConst + \",\" + tempSingle + \"\\n\";\n\t\t\tcode += \"mul \" + sin + \",\" + sin + \",\" + nrmDirection + \".x\\n\";\n\n\t\t\tcode += \"mov \" + cos + \",\" + nrmDirection + \".z\\n\";\n\t\t\tcode += \"neg \" + cos + \",\" + cos + \"\\n\";\n\t\t\tcode += \"sub \" + o_temp + \",\" + animationRegisterCache.vertexOneConst + \",\" + cos + \"\\n\";\n\t\t\tcode += \"mul \" + o_temp + \",\" + R + \".x,\" + tempSingle + \"\\n\";\n\t\t\tcode += \"add \" + cos + \",\" + cos + \",\" + o_temp + \"\\n\";\n\n\t\t\tcode += \"mul \" + R + \".x,\" + cos + \",\" + animationRegisterCache.scaleAndRotateTarget + \".x\\n\";\n\t\t\tcode += \"mul \" + R + \".y,\" + sin + \",\" + animationRegisterCache.scaleAndRotateTarget + \".z\\n\";\n\t\t\tcode += \"mul \" + R + \".z,\" + sin + \",\" + animationRegisterCache.scaleAndRotateTarget + \".x\\n\";\n\t\t\tcode += \"mul \" + R + \".w,\" + cos + \",\" + animationRegisterCache.scaleAndRotateTarget + \".z\\n\";\n\n\t\t\tcode += \"sub \" + animationRegisterCache.scaleAndRotateTarget + \".x,\" + R + \".x,\" + R + \".y\\n\";\n\t\t\tcode += \"add \" + animationRegisterCache.scaleAndRotateTarget + \".z,\" + R + \".z,\" + R + \".w\\n\";\n\n\t\t\tfor (i = 0; i < len; i++) {\n\t\t\t\t//just repeat the calculate above\n\t\t\t\t//because of the limited registers, no need to optimise\n\t\t\t\tcode += \"sub \" + nrmDirection + \".xyz,\" + positionAttribute + \".xyz,\" + animationRegisterCache.positionTarget + \".xyz\\n\";\n\t\t\t\tcode += \"nrm \" + nrmDirection + \".xyz,\" + nrmDirection + \".xyz\\n\";\n\t\t\t\tcode += \"mov \" + sin + \",\" + nrmDirection + \".y\\n\";\n\t\t\t\tcode += \"mul \" + cos + \",\" + sin + \",\" + sin + \"\\n\";\n\t\t\t\tcode += \"sub \" + cos + \",\" + animationRegisterCache.vertexOneConst + \",\" + cos + \"\\n\";\n\t\t\t\tcode += \"sqt \" + cos + \",\" + cos + \"\\n\";\n\t\t\t\tcode += \"mul \" + R + \".x,\" + cos + \",\" + animationRegisterCache.rotationRegisters[i] + \".y\\n\";\n\t\t\t\tcode += \"mul \" + R + \".y,\" + sin + \",\" + animationRegisterCache.rotationRegisters[i] + \".z\\n\";\n\t\t\t\tcode += \"mul \" + R + \".z,\" + sin + \",\" + animationRegisterCache.rotationRegisters[i] + \".y\\n\";\n\t\t\t\tcode += \"mul \" + R + \".w,\" + cos + \",\" + animationRegisterCache.rotationRegisters[i] + \".z\\n\";\n\t\t\t\tcode += \"sub \" + animationRegisterCache.rotationRegisters[i] + \".y,\" + R + \".x,\" + R + \".y\\n\";\n\t\t\t\tcode += \"add \" + animationRegisterCache.rotationRegisters[i] + \".z,\" + R + \".z,\" + R + \".w\\n\";\n\t\t\t\tcode += \"abs \" + R + \".y,\" + nrmDirection + \".y\\n\";\n\t\t\t\tcode += \"sge \" + R + \".z,\" + R + \".y,\" + animationRegisterCache.vertexOneConst + \"\\n\";\n\t\t\t\tcode += \"mul \" + R + \".x,\" + R + \".y,\" + nrmDirection + \".y\\n\";\n\t\t\t\tcode += \"mov \" + nrmDirection + \".y,\" + animationRegisterCache.vertexZeroConst + \"\\n\";\n\t\t\t\tcode += \"dp3 \" + sin + \",\" + nrmDirection + \".xyz,\" + nrmDirection + \".xyz\\n\";\n\t\t\t\tcode += \"sge \" + tempSingle + \",\" + animationRegisterCache.vertexZeroConst + \",\" + sin + \"\\n\";\n\t\t\t\tcode += \"mov \" + nrmDirection + \".y,\" + animationRegisterCache.vertexZeroConst + \"\\n\";\n\t\t\t\tcode += \"nrm \" + nrmDirection + \".xyz,\" + nrmDirection + \".xyz\\n\";\n\t\t\t\tcode += \"sub \" + sin + \",\" + animationRegisterCache.vertexOneConst + \",\" + tempSingle + \"\\n\";\n\t\t\t\tcode += \"mul \" + sin + \",\" + sin + \",\" + nrmDirection + \".x\\n\";\n\t\t\t\tcode += \"mov \" + cos + \",\" + nrmDirection + \".z\\n\";\n\t\t\t\tcode += \"neg \" + cos + \",\" + cos + \"\\n\";\n\t\t\t\tcode += \"sub \" + o_temp + \",\" + animationRegisterCache.vertexOneConst + \",\" + cos + \"\\n\";\n\t\t\t\tcode += \"mul \" + o_temp + \",\" + R + \".x,\" + tempSingle + \"\\n\";\n\t\t\t\tcode += \"add \" + cos + \",\" + cos + \",\" + o_temp + \"\\n\";\n\t\t\t\tcode += \"mul \" + R + \".x,\" + cos + \",\" + animationRegisterCache.rotationRegisters[i] + \".x\\n\";\n\t\t\t\tcode += \"mul \" + R + \".y,\" + sin + \",\" + animationRegisterCache.rotationRegisters[i] + \".z\\n\";\n\t\t\t\tcode += \"mul \" + R + \".z,\" + sin + \",\" + animationRegisterCache.rotationRegisters[i] + \".x\\n\";\n\t\t\t\tcode += \"mul \" + R + \".w,\" + cos + \",\" + animationRegisterCache.rotationRegisters[i] + \".z\\n\";\n\t\t\t\tcode += \"sub \" + animationRegisterCache.rotationRegisters[i] + \".x,\" + R + \".x,\" + R + \".y\\n\";\n\t\t\t\tcode += \"add \" + animationRegisterCache.rotationRegisters[i] + \".z,\" + R + \".z,\" + R + \".w\\n\";\n\t\t\t}\n\t\t}\n\t\treturn code;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAnimationState(animator:AnimatorBase):ParticleRotateToPositionState\n\t{\n\t\treturn <ParticleRotateToPositionState> animator.getAnimationState(this);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iGeneratePropertyOfOneParticle(param:ParticleProperties)\n\t{\n\t\tvar offset:Vector3D = param[ParticleRotateToPositionNode.POSITION_VECTOR3D];\n\t\tif (!offset)\n\t\t\tthrow(new Error(\"there is no \" + ParticleRotateToPositionNode.POSITION_VECTOR3D + \" in param!\"));\n\n\t\tthis._pOneData[0] = offset.x;\n\t\tthis._pOneData[1] = offset.y;\n\t\tthis._pOneData[2] = offset.z;\n\t}\n}\n\nexport = ParticleRotateToPositionNode;","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport ShaderObjectBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport ShaderRegisterElement\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\n\nimport ParticleProperties\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticleProperties\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticleNodeBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleNodeBase\");\nimport ParticleRotationalVelocityState\t= require(\"awayjs-renderergl/lib/animators/states/ParticleRotationalVelocityState\");\n\n/**\n * A particle animation node used to set the starting rotational velocity of a particle.\n */\nclass ParticleRotationalVelocityNode extends ParticleNodeBase\n{\n\t/** @private */\n\tpublic _iRotationalVelocity:Vector3D;\n\n\t/**\n\t * Reference for rotational velocity node properties on a single particle (when in local property mode).\n\t * Expects a <code>Vector3D</code> object representing the rotational velocity around an axis of the particle.\n\t */\n\tpublic static ROTATIONALVELOCITY_VECTOR3D:string = \"RotationalVelocityVector3D\";\n\n\t/**\n\t * Creates a new <code>ParticleRotationalVelocityNode</code>\n\t *\n\t * @param               mode            Defines whether the mode of operation acts on local properties of a particle or global properties of the node.\n\t */\n\tconstructor(mode:number /*uint*/, rotationalVelocity:Vector3D = null)\n\t{\n\t\tsuper(\"ParticleRotationalVelocity\", mode, 4);\n\n\t\tthis._pStateClass = ParticleRotationalVelocityState;\n\n\t\tthis._iRotationalVelocity = rotationalVelocity || new Vector3D();\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAGALVertexCode(shaderObject:ShaderObjectBase, animationRegisterCache:AnimationRegisterCache):string\n\t{\n\t\tvar rotationRegister:ShaderRegisterElement = (this._pMode == ParticlePropertiesMode.GLOBAL)? animationRegisterCache.getFreeVertexConstant() : animationRegisterCache.getFreeVertexAttribute();\n\t\tanimationRegisterCache.setRegisterIndex(this, ParticleRotationalVelocityState.ROTATIONALVELOCITY_INDEX, rotationRegister.index);\n\n\t\tvar nrmVel:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\t\tanimationRegisterCache.addVertexTempUsages(nrmVel, 1);\n\n\t\tvar xAxis:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\t\tanimationRegisterCache.addVertexTempUsages(xAxis, 1);\n\n\t\tvar temp:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\t\tanimationRegisterCache.addVertexTempUsages(temp, 1);\n\t\tvar Rtemp:ShaderRegisterElement = new ShaderRegisterElement(temp.regName, temp.index);\n\t\tvar R_rev:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\t\tR_rev = new ShaderRegisterElement(R_rev.regName, R_rev.index);\n\n\t\tvar cos:ShaderRegisterElement = new ShaderRegisterElement(Rtemp.regName, Rtemp.index, 3);\n\t\tvar sin:ShaderRegisterElement = new ShaderRegisterElement(R_rev.regName, R_rev.index, 3);\n\n\t\tanimationRegisterCache.removeVertexTempUsage(nrmVel);\n\t\tanimationRegisterCache.removeVertexTempUsage(xAxis);\n\t\tanimationRegisterCache.removeVertexTempUsage(temp);\n\n\t\tvar code:string = \"\";\n\t\tcode += \"mov \" + nrmVel + \".xyz,\" + rotationRegister + \".xyz\\n\";\n\t\tcode += \"mov \" + nrmVel + \".w,\" + animationRegisterCache.vertexZeroConst + \"\\n\";\n\n\t\tcode += \"mul \" + cos + \",\" + animationRegisterCache.vertexTime + \",\" + rotationRegister + \".w\\n\";\n\n\t\tcode += \"sin \" + sin + \",\" + cos + \"\\n\";\n\t\tcode += \"cos \" + cos + \",\" + cos + \"\\n\";\n\n\t\tcode += \"mul \" + Rtemp + \".xyz,\" + sin + \",\" + nrmVel + \".xyz\\n\";\n\n\t\tcode += \"mul \" + R_rev + \".xyz,\" + sin + \",\" + nrmVel + \".xyz\\n\";\n\t\tcode += \"neg \" + R_rev + \".xyz,\" + R_rev + \".xyz\\n\";\n\n\t\t//nrmVel and xAxis are used as temp register\n\t\tcode += \"crs \" + nrmVel + \".xyz,\" + Rtemp + \".xyz,\" + animationRegisterCache.scaleAndRotateTarget + \".xyz\\n\";\n\n\t\tcode += \"mul \" + xAxis + \".xyz,\" + cos + \",\" + animationRegisterCache.scaleAndRotateTarget + \".xyz\\n\";\n\t\tcode += \"add \" + nrmVel + \".xyz,\" + nrmVel + \".xyz,\" + xAxis + \".xyz\\n\";\n\t\tcode += \"dp3 \" + xAxis + \".w,\" + Rtemp + \".xyz,\" + animationRegisterCache.scaleAndRotateTarget + \".xyz\\n\";\n\t\tcode += \"neg \" + nrmVel + \".w,\" + xAxis + \".w\\n\";\n\n\t\tcode += \"crs \" + Rtemp + \".xyz,\" + nrmVel + \".xyz,\" + R_rev + \".xyz\\n\";\n\n\t\t//use cos as R_rev.w\n\t\tcode += \"mul \" + xAxis + \".xyzw,\" + nrmVel + \".xyzw,\" + cos + \"\\n\";\n\t\tcode += \"add \" + Rtemp + \".xyz,\" + Rtemp + \".xyz,\" + xAxis + \".xyz\\n\";\n\t\tcode += \"mul \" + xAxis + \".xyz,\" + nrmVel + \".w,\" + R_rev + \".xyz\\n\";\n\n\t\tcode += \"add \" + animationRegisterCache.scaleAndRotateTarget + \".xyz,\" + Rtemp + \".xyz,\" + xAxis + \".xyz\\n\";\n\n\t\tvar len:number /*int*/ = animationRegisterCache.rotationRegisters.length;\n\t\tfor (var i:number /*int*/ = 0; i < len; i++) {\n\t\t\tcode += \"mov \" + nrmVel + \".xyz,\" + rotationRegister + \".xyz\\n\";\n\t\t\tcode += \"mov \" + nrmVel + \".w,\" + animationRegisterCache.vertexZeroConst + \"\\n\";\n\t\t\tcode += \"mul \" + cos + \",\" + animationRegisterCache.vertexTime + \",\" + rotationRegister + \".w\\n\";\n\t\t\tcode += \"sin \" + sin + \",\" + cos + \"\\n\";\n\t\t\tcode += \"cos \" + cos + \",\" + cos + \"\\n\";\n\t\t\tcode += \"mul \" + Rtemp + \".xyz,\" + sin + \",\" + nrmVel + \".xyz\\n\";\n\t\t\tcode += \"mul \" + R_rev + \".xyz,\" + sin + \",\" + nrmVel + \".xyz\\n\";\n\t\t\tcode += \"neg \" + R_rev + \".xyz,\" + R_rev + \".xyz\\n\";\n\t\t\tcode += \"crs \" + nrmVel + \".xyz,\" + Rtemp + \".xyz,\" + animationRegisterCache.rotationRegisters[i] + \".xyz\\n\";\n\t\t\tcode += \"mul \" + xAxis + \".xyz,\" + cos + \",\" + animationRegisterCache.rotationRegisters[i] + \"\\n\";\n\t\t\tcode += \"add \" + nrmVel + \".xyz,\" + nrmVel + \".xyz,\" + xAxis + \".xyz\\n\";\n\t\t\tcode += \"dp3 \" + xAxis + \".w,\" + Rtemp + \".xyz,\" + animationRegisterCache.rotationRegisters[i] + \"\\n\";\n\t\t\tcode += \"neg \" + nrmVel + \".w,\" + xAxis + \".w\\n\";\n\t\t\tcode += \"crs \" + Rtemp + \".xyz,\" + nrmVel + \".xyz,\" + R_rev + \".xyz\\n\";\n\t\t\tcode += \"mul \" + xAxis + \".xyzw,\" + nrmVel + \".xyzw,\" + cos + \"\\n\";\n\t\t\tcode += \"add \" + Rtemp + \".xyz,\" + Rtemp + \".xyz,\" + xAxis + \".xyz\\n\";\n\t\t\tcode += \"mul \" + xAxis + \".xyz,\" + nrmVel + \".w,\" + R_rev + \".xyz\\n\";\n\t\t\tcode += \"add \" + animationRegisterCache.rotationRegisters[i] + \",\" + Rtemp + \".xyz,\" + xAxis + \".xyz\\n\";\n\t\t}\n\t\treturn code;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAnimationState(animator:AnimatorBase):ParticleRotationalVelocityState\n\t{\n\t\treturn <ParticleRotationalVelocityState> animator.getAnimationState(this);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iGeneratePropertyOfOneParticle(param:ParticleProperties)\n\t{\n\t\t//(Vector3d.x,Vector3d.y,Vector3d.z) is rotation axis,Vector3d.w is cycle duration\n\t\tvar rotate:Vector3D = param[ParticleRotationalVelocityNode.ROTATIONALVELOCITY_VECTOR3D];\n\t\tif (!rotate)\n\t\t\tthrow(new Error(\"there is no \" + ParticleRotationalVelocityNode.ROTATIONALVELOCITY_VECTOR3D + \" in param!\"));\n\n\t\tif (rotate.length <= 0)\n\t\t\trotate.z = 1; //set the default direction\n\t\telse\n\t\t\trotate.normalize();\n\n\t\tthis._pOneData[0] = rotate.x;\n\t\tthis._pOneData[1] = rotate.y;\n\t\tthis._pOneData[2] = rotate.z;\n\t\tif (rotate.w <= 0)\n\t\t\tthrow(new Error(\"the cycle duration must greater than zero\"));\n\t\t// it's used as angle/2 in agal\n\t\tthis._pOneData[3] = Math.PI/rotate.w;\n\t}\n}\n\nexport = ParticleRotationalVelocityNode;","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport ShaderObjectBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport ShaderRegisterElement\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\n\nimport ParticleProperties\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticleProperties\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticleNodeBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleNodeBase\");\nimport ParticleScaleState\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleScaleState\");\n\n/**\n * A particle animation node used to control the scale variation of a particle over time.\n */\nclass ParticleScaleNode extends ParticleNodeBase\n{\n\t/** @private */\n\tpublic _iUsesCycle:boolean;\n\n\t/** @private */\n\tpublic _iUsesPhase:boolean;\n\n\t/** @private */\n\tpublic _iMinScale:number;\n\t/** @private */\n\tpublic _iMaxScale:number;\n\t/** @private */\n\tpublic _iCycleDuration:number;\n\t/** @private */\n\tpublic _iCyclePhase:number;\n\n\t/**\n\t * Reference for scale node properties on a single particle (when in local property mode).\n\t * Expects a <code>Vector3D</code> representing the min scale (x), max scale(y), optional cycle speed (z) and phase offset (w) applied to the particle.\n\t */\n\tpublic static SCALE_VECTOR3D:string = \"ScaleVector3D\";\n\n\t/**\n\t * Creates a new <code>ParticleScaleNode</code>\n\t *\n\t * @param               mode            Defines whether the mode of operation acts on local properties of a particle or global properties of the node.\n\t * @param    [optional] usesCycle       Defines whether the node uses the <code>cycleDuration</code> property in the shader to calculate the period of animation independent of particle duration. Defaults to false.\n\t * @param    [optional] usesPhase       Defines whether the node uses the <code>cyclePhase</code> property in the shader to calculate a starting offset to the animation cycle. Defaults to false.\n\t * @param    [optional] minScale        Defines the default min scale transform of the node, when in global mode. Defaults to 1.\n\t * @param    [optional] maxScale        Defines the default max color transform of the node, when in global mode. Defaults to 1.\n\t * @param    [optional] cycleDuration   Defines the default duration of the animation in seconds, used as a period independent of particle duration when in global mode. Defaults to 1.\n\t * @param    [optional] cyclePhase      Defines the default phase of the cycle in degrees, used as the starting offset of the cycle when in global mode. Defaults to 0.\n\t */\n\tconstructor(mode:number /*uint*/, usesCycle:boolean, usesPhase:boolean, minScale:number = 1, maxScale:number = 1, cycleDuration:number = 1, cyclePhase:number = 0)\n\t{\n\t\tsuper(\"ParticleScale\", mode, (usesCycle && usesPhase)? 4 : ((usesCycle || usesPhase)? 3 : 2), 3);\n\n\t\tthis._pStateClass = ParticleScaleState;\n\n\t\tthis._iUsesCycle = usesCycle;\n\t\tthis._iUsesPhase = usesPhase;\n\n\t\tthis._iMinScale = minScale;\n\t\tthis._iMaxScale = maxScale;\n\t\tthis._iCycleDuration = cycleDuration;\n\t\tthis._iCyclePhase = cyclePhase;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAGALVertexCode(shaderObject:ShaderObjectBase, animationRegisterCache:AnimationRegisterCache):string\n\t{\n\t\tvar code:string = \"\";\n\t\tvar temp:ShaderRegisterElement = animationRegisterCache.getFreeVertexSingleTemp();\n\n\t\tvar scaleRegister:ShaderRegisterElement = (this._pMode == ParticlePropertiesMode.GLOBAL)? animationRegisterCache.getFreeVertexConstant() : animationRegisterCache.getFreeVertexAttribute();\n\t\tanimationRegisterCache.setRegisterIndex(this, ParticleScaleState.SCALE_INDEX, scaleRegister.index);\n\n\t\tif (this._iUsesCycle) {\n\t\t\tcode += \"mul \" + temp + \",\" + animationRegisterCache.vertexTime + \",\" + scaleRegister + \".z\\n\";\n\n\t\t\tif (this._iUsesPhase)\n\t\t\t\tcode += \"add \" + temp + \",\" + temp + \",\" + scaleRegister + \".w\\n\";\n\n\t\t\tcode += \"sin \" + temp + \",\" + temp + \"\\n\";\n\t\t}\n\n\t\tcode += \"mul \" + temp + \",\" + scaleRegister + \".y,\" + ((this._iUsesCycle)? temp : animationRegisterCache.vertexLife) + \"\\n\";\n\t\tcode += \"add \" + temp + \",\" + scaleRegister + \".x,\" + temp + \"\\n\";\n\t\tcode += \"mul \" + animationRegisterCache.scaleAndRotateTarget + \".xyz,\" + animationRegisterCache.scaleAndRotateTarget + \".xyz,\" + temp + \"\\n\";\n\n\t\treturn code;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAnimationState(animator:AnimatorBase):ParticleScaleState\n\t{\n\t\treturn <ParticleScaleState> animator.getAnimationState(this);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iGeneratePropertyOfOneParticle(param:ParticleProperties)\n\t{\n\t\tvar scale:Vector3D = param[ParticleScaleNode.SCALE_VECTOR3D];\n\t\tif (!scale)\n\t\t\tthrow(new Error(\"there is no \" + ParticleScaleNode.SCALE_VECTOR3D + \" in param!\"));\n\n\t\tif (this._iUsesCycle) {\n\t\t\tthis._pOneData[0] = (scale.x + scale.y)/2;\n\t\t\tthis._pOneData[1] = Math.abs(scale.x - scale.y)/2;\n\t\t\tif (scale.z <= 0)\n\t\t\t\tthrow(new Error(\"the cycle duration must be greater than zero\"));\n\t\t\tthis._pOneData[2] = Math.PI*2/scale.z;\n\t\t\tif (this._iUsesPhase)\n\t\t\t\tthis._pOneData[3] = scale.w*Math.PI/180;\n\t\t} else {\n\t\t\tthis._pOneData[0] = scale.x;\n\t\t\tthis._pOneData[1] = scale.y - scale.x;\n\t\t}\n\t}\n}\n\nexport = ParticleScaleNode;","import ColorTransform\t\t\t\t\t= require(\"awayjs-core/lib/geom/ColorTransform\");\nimport Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport ShaderObjectBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport ShaderRegisterElement\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\n\nimport ParticleAnimationSet\t\t\t\t= require(\"awayjs-renderergl/lib/animators/ParticleAnimationSet\");\nimport ColorSegmentPoint\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ColorSegmentPoint\");\nimport ParticleProperties\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticleProperties\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticleNodeBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleNodeBase\");\nimport ParticleSegmentedColorState\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleSegmentedColorState\");\n\n/**\n *\n */\nclass ParticleSegmentedColorNode extends ParticleNodeBase\n{\n\t/** @private */\n\tpublic _iUsesMultiplier:boolean;\n\t/** @private */\n\tpublic _iUsesOffset:boolean;\n\t/** @private */\n\tpublic _iStartColor:ColorTransform;\n\t/** @private */\n\tpublic _iEndColor:ColorTransform;\n\t/** @private */\n\tpublic _iNumSegmentPoint:number /*int*/;\n\t/** @private */\n\tpublic _iSegmentPoints:Array<ColorSegmentPoint>;\n\n\tconstructor(usesMultiplier:boolean, usesOffset:boolean, numSegmentPoint:number /*int*/, startColor:ColorTransform, endColor:ColorTransform, segmentPoints:Array<ColorSegmentPoint>)\n\t{\n\t\t//because of the stage3d register limitation, it only support the global mode\n\t\tsuper(\"ParticleSegmentedColor\", ParticlePropertiesMode.GLOBAL, 0, ParticleAnimationSet.COLOR_PRIORITY);\n\n\t\tthis._pStateClass = ParticleSegmentedColorState;\n\n\t\tif (numSegmentPoint > 4)\n\t\t\tthrow(new Error(\"the numSegmentPoint must be less or equal 4\"));\n\t\tthis._iUsesMultiplier = usesMultiplier;\n\t\tthis._iUsesOffset = usesOffset;\n\t\tthis._iNumSegmentPoint = numSegmentPoint;\n\t\tthis._iStartColor = startColor;\n\t\tthis._iEndColor = endColor;\n\t\tthis._iSegmentPoints = segmentPoints;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iProcessAnimationSetting(particleAnimationSet:ParticleAnimationSet)\n\t{\n\t\tif (this._iUsesMultiplier)\n\t\t\tparticleAnimationSet.hasColorMulNode = true;\n\t\tif (this._iUsesOffset)\n\t\t\tparticleAnimationSet.hasColorAddNode = true;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAGALVertexCode(shaderObject:ShaderObjectBase, animationRegisterCache:AnimationRegisterCache):string\n\t{\n\t\tvar code:string = \"\";\n\t\tif (animationRegisterCache.needFragmentAnimation) {\n\t\t\tvar accMultiplierColor:ShaderRegisterElement;\n\t\t\t//var accOffsetColor:ShaderRegisterElement;\n\t\t\tif (this._iUsesMultiplier) {\n\t\t\t\taccMultiplierColor = animationRegisterCache.getFreeVertexVectorTemp();\n\t\t\t\tanimationRegisterCache.addVertexTempUsages(accMultiplierColor, 1);\n\t\t\t}\n\n\t\t\tvar tempColor:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\t\t\tanimationRegisterCache.addVertexTempUsages(tempColor, 1);\n\n\t\t\tvar temp:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\t\t\tvar accTime:ShaderRegisterElement = new ShaderRegisterElement(temp.regName, temp.index, 0);\n\t\t\tvar tempTime:ShaderRegisterElement = new ShaderRegisterElement(temp.regName, temp.index, 1);\n\n\t\t\tif (this._iUsesMultiplier)\n\t\t\t\tanimationRegisterCache.removeVertexTempUsage(accMultiplierColor);\n\n\t\t\tanimationRegisterCache.removeVertexTempUsage(tempColor);\n\n\t\t\t//for saving all the life values (at most 4)\n\t\t\tvar lifeTimeRegister:ShaderRegisterElement = animationRegisterCache.getFreeVertexConstant();\n\t\t\tanimationRegisterCache.setRegisterIndex(this, ParticleSegmentedColorState.TIME_DATA_INDEX, lifeTimeRegister.index);\n\n\t\t\tvar i:number /*int*/;\n\n\t\t\tvar startMulValue:ShaderRegisterElement;\n\t\t\tvar deltaMulValues:Array<ShaderRegisterElement>;\n\t\t\tif (this._iUsesMultiplier) {\n\t\t\t\tstartMulValue = animationRegisterCache.getFreeVertexConstant();\n\t\t\t\tanimationRegisterCache.setRegisterIndex(this, ParticleSegmentedColorState.START_MULTIPLIER_INDEX, startMulValue.index);\n\t\t\t\tdeltaMulValues = new Array<ShaderRegisterElement>();\n\t\t\t\tfor (i = 0; i < this._iNumSegmentPoint + 1; i++)\n\t\t\t\t\tdeltaMulValues.push(animationRegisterCache.getFreeVertexConstant());\n\t\t\t}\n\n\t\t\tvar startOffsetValue:ShaderRegisterElement;\n\t\t\tvar deltaOffsetValues:Array<ShaderRegisterElement>;\n\t\t\tif (this._iUsesOffset) {\n\t\t\t\tstartOffsetValue = animationRegisterCache.getFreeVertexConstant();\n\t\t\t\tanimationRegisterCache.setRegisterIndex(this, ParticleSegmentedColorState.START_OFFSET_INDEX, startOffsetValue.index);\n\t\t\t\tdeltaOffsetValues = new Array<ShaderRegisterElement>();\n\t\t\t\tfor (i = 0; i < this._iNumSegmentPoint + 1; i++)\n\t\t\t\t\tdeltaOffsetValues.push(animationRegisterCache.getFreeVertexConstant());\n\t\t\t}\n\n\t\t\tif (this._iUsesMultiplier)\n\t\t\t\tcode += \"mov \" + accMultiplierColor + \",\" + startMulValue + \"\\n\";\n\t\t\tif (this._iUsesOffset)\n\t\t\t\tcode += \"add \" + animationRegisterCache.colorAddTarget + \",\" + animationRegisterCache.colorAddTarget + \",\" + startOffsetValue + \"\\n\";\n\n\t\t\tfor (i = 0; i < this._iNumSegmentPoint; i++) {\n\t\t\t\tswitch (i) {\n\t\t\t\t\tcase 0:\n\t\t\t\t\t\tcode += \"min \" + tempTime + \",\" + animationRegisterCache.vertexLife + \",\" + lifeTimeRegister + \".x\\n\";\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 1:\n\t\t\t\t\t\tcode += \"sub \" + accTime + \",\" + animationRegisterCache.vertexLife + \",\" + lifeTimeRegister + \".x\\n\";\n\t\t\t\t\t\tcode += \"max \" + tempTime + \",\" + accTime + \",\" + animationRegisterCache.vertexZeroConst + \"\\n\";\n\t\t\t\t\t\tcode += \"min \" + tempTime + \",\" + tempTime + \",\" + lifeTimeRegister + \".y\\n\";\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 2:\n\t\t\t\t\t\tcode += \"sub \" + accTime + \",\" + accTime + \",\" + lifeTimeRegister + \".y\\n\";\n\t\t\t\t\t\tcode += \"max \" + tempTime + \",\" + accTime + \",\" + animationRegisterCache.vertexZeroConst + \"\\n\";\n\t\t\t\t\t\tcode += \"min \" + tempTime + \",\" + tempTime + \",\" + lifeTimeRegister + \".z\\n\";\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 3:\n\t\t\t\t\t\tcode += \"sub \" + accTime + \",\" + accTime + \",\" + lifeTimeRegister + \".z\\n\";\n\t\t\t\t\t\tcode += \"max \" + tempTime + \",\" + accTime + \",\" + animationRegisterCache.vertexZeroConst + \"\\n\";\n\t\t\t\t\t\tcode += \"min \" + tempTime + \",\" + tempTime + \",\" + lifeTimeRegister + \".w\\n\";\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tif (this._iUsesMultiplier) {\n\t\t\t\t\tcode += \"mul \" + tempColor + \",\" + tempTime + \",\" + deltaMulValues[i] + \"\\n\";\n\t\t\t\t\tcode += \"add \" + accMultiplierColor + \",\" + accMultiplierColor + \",\" + tempColor + \"\\n\";\n\t\t\t\t}\n\t\t\t\tif (this._iUsesOffset) {\n\t\t\t\t\tcode += \"mul \" + tempColor + \",\" + tempTime + \",\" + deltaOffsetValues[i] + \"\\n\";\n\t\t\t\t\tcode += \"add \" + animationRegisterCache.colorAddTarget + \",\" + animationRegisterCache.colorAddTarget + \",\" + tempColor + \"\\n\";\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t//for the last segment:\n\t\t\tif (this._iNumSegmentPoint == 0)\n\t\t\t\ttempTime = animationRegisterCache.vertexLife;\n\t\t\telse {\n\t\t\t\tswitch (this._iNumSegmentPoint) {\n\t\t\t\t\tcase 1:\n\t\t\t\t\t\tcode += \"sub \" + accTime + \",\" + animationRegisterCache.vertexLife + \",\" + lifeTimeRegister + \".x\\n\";\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 2:\n\t\t\t\t\t\tcode += \"sub \" + accTime + \",\" + accTime + \",\" + lifeTimeRegister + \".y\\n\";\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 3:\n\t\t\t\t\t\tcode += \"sub \" + accTime + \",\" + accTime + \",\" + lifeTimeRegister + \".z\\n\";\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 4:\n\t\t\t\t\t\tcode += \"sub \" + accTime + \",\" + accTime + \",\" + lifeTimeRegister + \".w\\n\";\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcode += \"max \" + tempTime + \",\" + accTime + \",\" + animationRegisterCache.vertexZeroConst + \"\\n\";\n\t\t\t}\n\t\t\tif (this._iUsesMultiplier) {\n\t\t\t\tcode += \"mul \" + tempColor + \",\" + tempTime + \",\" + deltaMulValues[this._iNumSegmentPoint] + \"\\n\";\n\t\t\t\tcode += \"add \" + accMultiplierColor + \",\" + accMultiplierColor + \",\" + tempColor + \"\\n\";\n\t\t\t\tcode += \"mul \" + animationRegisterCache.colorMulTarget + \",\" + animationRegisterCache.colorMulTarget + \",\" + accMultiplierColor + \"\\n\";\n\t\t\t}\n\t\t\tif (this._iUsesOffset) {\n\t\t\t\tcode += \"mul \" + tempColor + \",\" + tempTime + \",\" + deltaOffsetValues[this._iNumSegmentPoint] + \"\\n\";\n\t\t\t\tcode += \"add \" + animationRegisterCache.colorAddTarget + \",\" + animationRegisterCache.colorAddTarget + \",\" + tempColor + \"\\n\";\n\t\t\t}\n\n\t\t}\n\t\treturn code;\n\t}\n\n}\n\nexport = ParticleSegmentedColorNode;","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport ShaderObjectBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport ShaderRegisterElement\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\n\nimport ParticleAnimationSet\t\t\t\t= require(\"awayjs-renderergl/lib/animators/ParticleAnimationSet\");\nimport ParticleProperties\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticleProperties\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticleNodeBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleNodeBase\");\nimport ParticleSpriteSheetState\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleSpriteSheetState\");\n\n/**\n * A particle animation node used when a spritesheet texture is required to animate the particle.\n * NB: to enable use of this node, the <code>repeat</code> property on the material has to be set to true.\n */\nclass ParticleSpriteSheetNode extends ParticleNodeBase\n{\n\t/** @private */\n\tpublic _iUsesCycle:boolean;\n\n\t/** @private */\n\tpublic _iUsesPhase:boolean;\n\n\t/** @private */\n\tpublic _iTotalFrames:number /*int*/;\n\t/** @private */\n\tpublic _iNumColumns:number /*int*/;\n\t/** @private */\n\tpublic _iNumRows:number /*int*/;\n\t/** @private */\n\tpublic _iCycleDuration:number;\n\t/** @private */\n\tpublic _iCyclePhase:number;\n\n\t/**\n\t * Reference for spritesheet node properties on a single particle (when in local property mode).\n\t * Expects a <code>Vector3D</code> representing the cycleDuration (x), optional phaseTime (y).\n\t */\n\tpublic static UV_VECTOR3D:string = \"UVVector3D\";\n\n\t/**\n\t * Defines the number of columns in the spritesheet, when in global mode. Defaults to 1. Read only.\n\t */\n\tpublic get numColumns():number\n\t{\n\t\treturn this._iNumColumns;\n\t}\n\n\t/**\n\t * Defines the number of rows in the spritesheet, when in global mode. Defaults to 1. Read only.\n\t */\n\tpublic get numRows():number\n\t{\n\t\treturn this._iNumRows;\n\t}\n\n\t/**\n\t * Defines the total number of frames used by the spritesheet, when in global mode. Defaults to the number defined by numColumns and numRows. Read only.\n\t */\n\tpublic get totalFrames():number\n\t{\n\t\treturn this._iTotalFrames;\n\t}\n\n\t/**\n\t * Creates a new <code>ParticleSpriteSheetNode</code>\n\t *\n\t * @param               mode            Defines whether the mode of operation acts on local properties of a particle or global properties of the node.\n\t * @param    [optional] numColumns      Defines the number of columns in the spritesheet, when in global mode. Defaults to 1.\n\t * @param    [optional] numRows         Defines the number of rows in the spritesheet, when in global mode. Defaults to 1.\n\t * @param    [optional] cycleDuration   Defines the default cycle duration in seconds, when in global mode. Defaults to 1.\n\t * @param    [optional] cyclePhase      Defines the default cycle phase, when in global mode. Defaults to 0.\n\t * @param    [optional] totalFrames     Defines the total number of frames used by the spritesheet, when in global mode. Defaults to the number defined by numColumns and numRows.\n\t * @param    [optional] looping         Defines whether the spritesheet animation is set to loop indefinitely. Defaults to true.\n\t */\n\tconstructor(mode:number /*uint*/, usesCycle:boolean, usesPhase:boolean, numColumns:number /*int*/ = 1, numRows:number /*uint*/ = 1, cycleDuration:number = 1, cyclePhase:number = 0, totalFrames:number /*uint*/ = Number.MAX_VALUE)\n\t{\n\t\tsuper(\"ParticleSpriteSheet\", mode, usesCycle? (usesPhase? 3 : 2) : 1, ParticleAnimationSet.POST_PRIORITY + 1);\n\n\t\tthis._pStateClass = ParticleSpriteSheetState;\n\n\t\tthis._iUsesCycle = usesCycle;\n\t\tthis._iUsesPhase = usesPhase;\n\n\t\tthis._iNumColumns = numColumns;\n\t\tthis._iNumRows = numRows;\n\t\tthis._iCyclePhase = cyclePhase;\n\t\tthis._iCycleDuration = cycleDuration;\n\t\tthis._iTotalFrames = Math.min(totalFrames, numColumns*numRows);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAGALUVCode(shaderObject:ShaderObjectBase, animationRegisterCache:AnimationRegisterCache):string\n\t{\n\t\t//get 2 vc\n\t\tvar uvParamConst1:ShaderRegisterElement = animationRegisterCache.getFreeVertexConstant();\n\t\tvar uvParamConst2:ShaderRegisterElement = (this._pMode == ParticlePropertiesMode.GLOBAL)? animationRegisterCache.getFreeVertexConstant() : animationRegisterCache.getFreeVertexAttribute();\n\t\tanimationRegisterCache.setRegisterIndex(this, ParticleSpriteSheetState.UV_INDEX_0, uvParamConst1.index);\n\t\tanimationRegisterCache.setRegisterIndex(this, ParticleSpriteSheetState.UV_INDEX_1, uvParamConst2.index);\n\n\t\tvar uTotal:ShaderRegisterElement = new ShaderRegisterElement(uvParamConst1.regName, uvParamConst1.index, 0);\n\t\tvar uStep:ShaderRegisterElement = new ShaderRegisterElement(uvParamConst1.regName, uvParamConst1.index, 1);\n\t\tvar vStep:ShaderRegisterElement = new ShaderRegisterElement(uvParamConst1.regName, uvParamConst1.index, 2);\n\n\t\tvar uSpeed:ShaderRegisterElement = new ShaderRegisterElement(uvParamConst2.regName, uvParamConst2.index, 0);\n\t\tvar cycle:ShaderRegisterElement = new ShaderRegisterElement(uvParamConst2.regName, uvParamConst2.index, 1);\n\t\tvar phaseTime:ShaderRegisterElement = new ShaderRegisterElement(uvParamConst2.regName, uvParamConst2.index, 2);\n\n\t\tvar temp:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\t\tvar time:ShaderRegisterElement = new ShaderRegisterElement(temp.regName, temp.index, 0);\n\t\tvar vOffset:ShaderRegisterElement = new ShaderRegisterElement(temp.regName, temp.index, 1);\n\t\ttemp = new ShaderRegisterElement(temp.regName, temp.index, 2);\n\t\tvar temp2:ShaderRegisterElement = new ShaderRegisterElement(temp.regName, temp.index, 3);\n\n\t\tvar u:ShaderRegisterElement = new ShaderRegisterElement(animationRegisterCache.uvTarget.regName, animationRegisterCache.uvTarget.index, 0);\n\t\tvar v:ShaderRegisterElement = new ShaderRegisterElement(animationRegisterCache.uvTarget.regName, animationRegisterCache.uvTarget.index, 1);\n\n\t\tvar code:string = \"\";\n\t\t//scale uv\n\t\tcode += \"mul \" + u + \",\" + u + \",\" + uStep + \"\\n\";\n\t\tif (this._iNumRows > 1)\n\t\t\tcode += \"mul \" + v + \",\" + v + \",\" + vStep + \"\\n\";\n\n\t\tif (this._iUsesCycle) {\n\t\t\tif (this._iUsesPhase)\n\t\t\t\tcode += \"add \" + time + \",\" + animationRegisterCache.vertexTime + \",\" + phaseTime + \"\\n\";\n\t\t\telse\n\t\t\t\tcode += \"mov \" + time + \",\" + animationRegisterCache.vertexTime + \"\\n\";\n\t\t\tcode += \"div \" + time + \",\" + time + \",\" + cycle + \"\\n\";\n\t\t\tcode += \"frc \" + time + \",\" + time + \"\\n\";\n\t\t\tcode += \"mul \" + time + \",\" + time + \",\" + cycle + \"\\n\";\n\t\t\tcode += \"mul \" + temp + \",\" + time + \",\" + uSpeed + \"\\n\";\n\t\t} else\n\t\t\tcode += \"mul \" + temp.toString() + \",\" + animationRegisterCache.vertexLife + \",\" + uTotal + \"\\n\";\n\n\t\tif (this._iNumRows > 1) {\n\t\t\tcode += \"frc \" + temp2 + \",\" + temp + \"\\n\";\n\t\t\tcode += \"sub \" + vOffset + \",\" + temp + \",\" + temp2 + \"\\n\";\n\t\t\tcode += \"mul \" + vOffset + \",\" + vOffset + \",\" + vStep + \"\\n\";\n\t\t\tcode += \"add \" + v + \",\" + v + \",\" + vOffset + \"\\n\";\n\t\t}\n\n\t\tcode += \"div \" + temp2 + \",\" + temp + \",\" + uStep + \"\\n\";\n\t\tcode += \"frc \" + temp + \",\" + temp2 + \"\\n\";\n\t\tcode += \"sub \" + temp2 + \",\" + temp2 + \",\" + temp + \"\\n\";\n\t\tcode += \"mul \" + temp + \",\" + temp2 + \",\" + uStep + \"\\n\";\n\n\t\tif (this._iNumRows > 1)\n\t\t\tcode += \"frc \" + temp + \",\" + temp + \"\\n\";\n\t\tcode += \"add \" + u + \",\" + u + \",\" + temp + \"\\n\";\n\n\t\treturn code;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAnimationState(animator:AnimatorBase):ParticleSpriteSheetState\n\t{\n\t\treturn <ParticleSpriteSheetState> animator.getAnimationState(this);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iProcessAnimationSetting(particleAnimationSet:ParticleAnimationSet)\n\t{\n\t\tparticleAnimationSet.hasUVNode = true;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iGeneratePropertyOfOneParticle(param:ParticleProperties)\n\t{\n\t\tif (this._iUsesCycle) {\n\t\t\tvar uvCycle:Vector3D = param[ParticleSpriteSheetNode.UV_VECTOR3D];\n\t\t\tif (!uvCycle)\n\t\t\t\tthrow(new Error(\"there is no \" + ParticleSpriteSheetNode.UV_VECTOR3D + \" in param!\"));\n\t\t\tif (uvCycle.x <= 0)\n\t\t\t\tthrow(new Error(\"the cycle duration must be greater than zero\"));\n\t\t\tvar uTotal:number = this._iTotalFrames/this._iNumColumns;\n\t\t\tthis._pOneData[0] = uTotal/uvCycle.x;\n\t\t\tthis._pOneData[1] = uvCycle.x;\n\t\t\tif (this._iUsesPhase)\n\t\t\t\tthis._pOneData[2] = uvCycle.y;\n\t\t}\n\t}\n}\n\nexport = ParticleSpriteSheetNode;","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport ShaderObjectBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport ShaderRegisterElement\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\n\nimport ParticleProperties\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticleProperties\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticleNodeBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleNodeBase\");\nimport ParticleTimeState\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleTimeState\");\n\n/**\n * A particle animation node used as the base node for timekeeping inside a particle. Automatically added to a particle animation set on instatiation.\n */\nclass ParticleTimeNode extends ParticleNodeBase\n{\n\t/** @private */\n\tpublic _iUsesDuration:boolean;\n\t/** @private */\n\tpublic _iUsesDelay:boolean;\n\t/** @private */\n\tpublic _iUsesLooping:boolean;\n\n\t/**\n\t * Creates a new <code>ParticleTimeNode</code>\n\t *\n\t * @param    [optional] usesDuration    Defines whether the node uses the <code>duration</code> data in the static properties to determine how long a particle is visible for. Defaults to false.\n\t * @param    [optional] usesDelay       Defines whether the node uses the <code>delay</code> data in the static properties to determine how long a particle is hidden for. Defaults to false. Requires <code>usesDuration</code> to be true.\n\t * @param    [optional] usesLooping     Defines whether the node creates a looping timeframe for each particle determined by the <code>startTime</code>, <code>duration</code> and <code>delay</code> data in the static properties function. Defaults to false. Requires <code>usesLooping</code> to be true.\n\t */\n\tconstructor(usesDuration:boolean = false, usesLooping:boolean = false, usesDelay:boolean = false)\n\t{\n\t\tthis._pStateClass = ParticleTimeState;\n\n\t\tthis._iUsesDuration = usesDuration;\n\t\tthis._iUsesLooping = usesLooping;\n\t\tthis._iUsesDelay = usesDelay;\n\n\t\tsuper(\"ParticleTime\", ParticlePropertiesMode.LOCAL_STATIC, 4, 0);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAGALVertexCode(shaderObject:ShaderObjectBase, animationRegisterCache:AnimationRegisterCache):string\n\t{\n\t\tvar timeStreamRegister:ShaderRegisterElement = animationRegisterCache.getFreeVertexAttribute(); //timeStreamRegister.x is start，timeStreamRegister.y is during time\n\t\tanimationRegisterCache.setRegisterIndex(this, ParticleTimeState.TIME_STREAM_INDEX, timeStreamRegister.index);\n\t\tvar timeConst:ShaderRegisterElement = animationRegisterCache.getFreeVertexConstant();\n\t\tanimationRegisterCache.setRegisterIndex(this, ParticleTimeState.TIME_CONSTANT_INDEX, timeConst.index);\n\n\t\tvar code:string = \"\";\n\t\tcode += \"sub \" + animationRegisterCache.vertexTime + \",\" + timeConst + \",\" + timeStreamRegister + \".x\\n\";\n\t\t//if time=0,set the position to zero.\n\t\tvar temp:ShaderRegisterElement = animationRegisterCache.getFreeVertexSingleTemp();\n\t\tcode += \"sge \" + temp + \",\" + animationRegisterCache.vertexTime + \",\" + animationRegisterCache.vertexZeroConst + \"\\n\";\n\t\tcode += \"mul \" + animationRegisterCache.scaleAndRotateTarget + \".xyz,\" + animationRegisterCache.scaleAndRotateTarget + \".xyz,\" + temp + \"\\n\";\n\t\tif (this._iUsesDuration) {\n\t\t\tif (this._iUsesLooping) {\n\t\t\t\tvar div:ShaderRegisterElement = animationRegisterCache.getFreeVertexSingleTemp();\n\t\t\t\tif (this._iUsesDelay) {\n\t\t\t\t\tcode += \"div \" + div + \",\" + animationRegisterCache.vertexTime + \",\" + timeStreamRegister + \".z\\n\";\n\t\t\t\t\tcode += \"frc \" + div + \",\" + div + \"\\n\";\n\t\t\t\t\tcode += \"mul \" + animationRegisterCache.vertexTime + \",\" + div + \",\" + timeStreamRegister + \".z\\n\";\n\t\t\t\t\tcode += \"slt \" + div + \",\" + animationRegisterCache.vertexTime + \",\" + timeStreamRegister + \".y\\n\";\n\t\t\t\t\tcode += \"mul \" + animationRegisterCache.scaleAndRotateTarget + \".xyz,\" + animationRegisterCache.scaleAndRotateTarget + \".xyz,\" + div + \"\\n\";\n\t\t\t\t} else {\n\t\t\t\t\tcode += \"mul \" + div + \",\" + animationRegisterCache.vertexTime + \",\" + timeStreamRegister + \".w\\n\";\n\t\t\t\t\tcode += \"frc \" + div + \",\" + div + \"\\n\";\n\t\t\t\t\tcode += \"mul \" + animationRegisterCache.vertexTime + \",\" + div + \",\" + timeStreamRegister + \".y\\n\";\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tvar sge:ShaderRegisterElement = animationRegisterCache.getFreeVertexSingleTemp();\n\t\t\t\tcode += \"sge \" + sge + \",\" + timeStreamRegister + \".y,\" + animationRegisterCache.vertexTime + \"\\n\";\n\t\t\t\tcode += \"mul \" + animationRegisterCache.scaleAndRotateTarget + \".xyz,\" + animationRegisterCache.scaleAndRotateTarget + \".xyz,\" + sge + \"\\n\";\n\t\t\t}\n\t\t}\n\t\tcode += \"mul \" + animationRegisterCache.vertexLife + \",\" + animationRegisterCache.vertexTime + \",\" + timeStreamRegister + \".w\\n\";\n\t\treturn code;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAnimationState(animator:AnimatorBase):ParticleTimeState\n\t{\n\t\treturn <ParticleTimeState> animator.getAnimationState(this);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iGeneratePropertyOfOneParticle(param:ParticleProperties)\n\t{\n\t\tthis._pOneData[0] = param.startTime;\n\t\tthis._pOneData[1] = param.duration;\n\t\tthis._pOneData[2] = param.delay + param.duration;\n\t\tthis._pOneData[3] = 1/param.duration;\n\n\t}\n}\n\nexport = ParticleTimeNode;","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport ShaderObjectBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport ShaderRegisterElement\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\n\nimport ParticleAnimationSet\t\t\t\t= require(\"awayjs-renderergl/lib/animators/ParticleAnimationSet\");\nimport ParticleProperties\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticleProperties\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticleNodeBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleNodeBase\");\nimport ParticleUVState\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleUVState\");\n\n/**\n * A particle animation node used to control the UV offset and scale of a particle over time.\n */\nclass ParticleUVNode extends ParticleNodeBase\n{\n\t/** @private */\n\tpublic _iUvData:Vector3D;\n\n\t/**\n\t *\n\t */\n\tpublic static U_AXIS:string = \"x\";\n\n\t/**\n\t *\n\t */\n\tpublic static V_AXIS:string = \"y\";\n\n\tprivate _cycle:number;\n\tprivate _scale:number;\n\tprivate _axis:string;\n\n\t/**\n\t * Creates a new <code>ParticleTimeNode</code>\n\t *\n\t * @param               mode            Defines whether the mode of operation acts on local properties of a particle or global properties of the node.\n\t * @param    [optional] cycle           Defines whether the time track is in loop mode. Defaults to false.\n\t * @param    [optional] scale           Defines whether the time track is in loop mode. Defaults to false.\n\t * @param    [optional] axis            Defines whether the time track is in loop mode. Defaults to false.\n\t */\n\tconstructor(mode:number /*uint*/, cycle:number = 1, scale:number = 1, axis:string = \"x\")\n\t{\n\t\t//because of the stage3d register limitation, it only support the global mode\n\t\tsuper(\"ParticleUV\", ParticlePropertiesMode.GLOBAL, 4, ParticleAnimationSet.POST_PRIORITY + 1);\n\n\t\tthis._pStateClass = ParticleUVState;\n\n\t\tthis._cycle = cycle;\n\t\tthis._scale = scale;\n\t\tthis._axis = axis;\n\n\t\tthis.updateUVData();\n\t}\n\n\t/**\n\t *\n\t */\n\tpublic get cycle():number\n\t{\n\t\treturn this._cycle;\n\t}\n\n\tpublic set cycle(value:number)\n\t{\n\t\tthis._cycle = value;\n\n\t\tthis.updateUVData();\n\t}\n\n\t/**\n\t *\n\t */\n\tpublic get scale():number\n\t{\n\t\treturn this._scale;\n\t}\n\n\tpublic set scale(value:number)\n\t{\n\t\tthis._scale = value;\n\n\t\tthis.updateUVData();\n\t}\n\n\t/**\n\t *\n\t */\n\tpublic get axis():string\n\t{\n\t\treturn this._axis;\n\t}\n\n\tpublic set axis(value:string)\n\t{\n\t\tthis._axis = value;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAGALUVCode(shaderObject:ShaderObjectBase, animationRegisterCache:AnimationRegisterCache):string\n\t{\n\t\tvar code:string = \"\";\n\n\t\tvar uvConst:ShaderRegisterElement = animationRegisterCache.getFreeVertexConstant();\n\t\tanimationRegisterCache.setRegisterIndex(this, ParticleUVState.UV_INDEX, uvConst.index);\n\n\t\tvar axisIndex:number = this._axis == \"x\"? 0 : (this._axis == \"y\"? 1 : 2);\n\n\t\tvar target:ShaderRegisterElement = new ShaderRegisterElement(animationRegisterCache.uvTarget.regName, animationRegisterCache.uvTarget.index, axisIndex);\n\n\t\tvar sin:ShaderRegisterElement = animationRegisterCache.getFreeVertexSingleTemp();\n\n\t\tif (this._scale != 1)\n\t\t\tcode += \"mul \" + target + \",\" + target + \",\" + uvConst + \".y\\n\";\n\n\t\tcode += \"mul \" + sin + \",\" + animationRegisterCache.vertexTime + \",\" + uvConst + \".x\\n\";\n\t\tcode += \"sin \" + sin + \",\" + sin + \"\\n\";\n\t\tcode += \"add \" + target + \",\" + target + \",\" + sin + \"\\n\";\n\n\t\treturn code;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAnimationState(animator:AnimatorBase):ParticleUVState\n\t{\n\t\treturn <ParticleUVState> animator.getAnimationState(this);\n\t}\n\n\tprivate updateUVData()\n\t{\n\t\tthis._iUvData = new Vector3D(Math.PI*2/this._cycle, this._scale, 0, 0);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iProcessAnimationSetting(particleAnimationSet:ParticleAnimationSet)\n\t{\n\t\tparticleAnimationSet.hasUVNode = true;\n\t}\n}\n\nexport = ParticleUVNode;","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport ShaderObjectBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport ShaderRegisterElement\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\n\nimport ParticleProperties\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticleProperties\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticleNodeBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleNodeBase\");\nimport ParticleVelocityState\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleVelocityState\");\n\n/**\n * A particle animation node used to set the starting velocity of a particle.\n */\nclass ParticleVelocityNode extends ParticleNodeBase\n{\n\t/** @private */\n\tpublic _iVelocity:Vector3D;\n\n\t/**\n\t * Reference for velocity node properties on a single particle (when in local property mode).\n\t * Expects a <code>Vector3D</code> object representing the direction of movement on the particle.\n\t */\n\tpublic static VELOCITY_VECTOR3D:string = \"VelocityVector3D\";\n\n\t/**\n\t * Creates a new <code>ParticleVelocityNode</code>\n\t *\n\t * @param               mode            Defines whether the mode of operation acts on local properties of a particle or global properties of the node.\n\t * @param    [optional] velocity        Defines the default velocity vector of the node, used when in global mode.\n\t */\n\tconstructor(mode:number /*uint*/, velocity:Vector3D = null)\n\t{\n\t\tsuper(\"ParticleVelocity\", mode, 3);\n\n\t\tthis._pStateClass = ParticleVelocityState;\n\n\t\tthis._iVelocity = velocity || new Vector3D();\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAGALVertexCode(shaderObject:ShaderObjectBase, animationRegisterCache:AnimationRegisterCache):string\n\t{\n\t\tvar velocityValue:ShaderRegisterElement = (this._pMode == ParticlePropertiesMode.GLOBAL)? animationRegisterCache.getFreeVertexConstant() : animationRegisterCache.getFreeVertexAttribute();\n\t\tanimationRegisterCache.setRegisterIndex(this, ParticleVelocityState.VELOCITY_INDEX, velocityValue.index);\n\n\t\tvar distance:ShaderRegisterElement = animationRegisterCache.getFreeVertexVectorTemp();\n\t\tvar code:string = \"\";\n\t\tcode += \"mul \" + distance + \",\" + animationRegisterCache.vertexTime + \",\" + velocityValue + \"\\n\";\n\t\tcode += \"add \" + animationRegisterCache.positionTarget + \".xyz,\" + distance + \",\" + animationRegisterCache.positionTarget + \".xyz\\n\";\n\n\t\tif (animationRegisterCache.needVelocity)\n\t\t\tcode += \"add \" + animationRegisterCache.velocityTarget + \".xyz,\" + velocityValue + \".xyz,\" + animationRegisterCache.velocityTarget + \".xyz\\n\";\n\n\t\treturn code;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAnimationState(animator:AnimatorBase):ParticleVelocityState\n\t{\n\t\treturn <ParticleVelocityState> animator.getAnimationState(this);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iGeneratePropertyOfOneParticle(param:ParticleProperties)\n\t{\n\t\tvar _tempVelocity:Vector3D = param[ParticleVelocityNode.VELOCITY_VECTOR3D];\n\t\tif (!_tempVelocity)\n\t\t\tthrow new Error(\"there is no \" + ParticleVelocityNode.VELOCITY_VECTOR3D + \" in param!\");\n\n\t\tthis._pOneData[0] = _tempVelocity.x;\n\t\tthis._pOneData[1] = _tempVelocity.y;\n\t\tthis._pOneData[2] = _tempVelocity.z;\n\t}\n}\n\nexport = ParticleVelocityNode;","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport AnimationNodeBase\t\t\t\t= require(\"awayjs-display/lib/animators/nodes/AnimationNodeBase\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\n\nimport SkeletonBinaryLERPState\t\t\t= require(\"awayjs-renderergl/lib/animators/states/SkeletonBinaryLERPState\");\n\n/**\n * A skeleton animation node that uses two animation node inputs to blend a lineraly interpolated output of a skeleton pose.\n */\nclass SkeletonBinaryLERPNode extends AnimationNodeBase\n{\n\t/**\n\t * Defines input node A to use for the blended output.\n\t */\n\tpublic inputA:AnimationNodeBase;\n\n\t/**\n\t * Defines input node B to use for the blended output.\n\t */\n\tpublic inputB:AnimationNodeBase;\n\n\t/**\n\t * Creates a new <code>SkeletonBinaryLERPNode</code> object.\n\t */\n\tconstructor()\n\t{\n\t\tsuper();\n\n\t\tthis._pStateClass = SkeletonBinaryLERPState;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAnimationState(animator:AnimatorBase):SkeletonBinaryLERPState\n\t{\n\t\treturn <SkeletonBinaryLERPState> animator.getAnimationState(this);\n\t}\n}\n\nexport = SkeletonBinaryLERPNode;","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\n\nimport SkeletonPose\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/SkeletonPose\");\nimport AnimationClipNodeBase\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/AnimationClipNodeBase\");\nimport SkeletonClipState\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/SkeletonClipState\");\n\n/**\n * A skeleton animation node containing time-based animation data as individual skeleton poses.\n */\nclass SkeletonClipNode extends AnimationClipNodeBase\n{\n\tprivate _frames:Array<SkeletonPose> = new Array<SkeletonPose>();\n\n\t/**\n\t * Determines whether to use SLERP equations (true) or LERP equations (false) in the calculation\n\t * of the output skeleton pose. Defaults to false.\n\t */\n\tpublic highQuality:boolean = false;\n\n\t/**\n\t * Returns a vector of skeleton poses representing the pose of each animation frame in the clip.\n\t */\n\tpublic get frames():Array<SkeletonPose>\n\t{\n\t\treturn this._frames;\n\t}\n\n\t/**\n\t * Creates a new <code>SkeletonClipNode</code> object.\n\t */\n\tconstructor()\n\t{\n\t\tsuper();\n\n\t\tthis._pStateClass = SkeletonClipState;\n\t}\n\n\t/**\n\t * Adds a skeleton pose frame to the internal timeline of the animation node.\n\t *\n\t * @param skeletonPose The skeleton pose object to add to the timeline of the node.\n\t * @param duration The specified duration of the frame in milliseconds.\n\t */\n\tpublic addFrame(skeletonPose:SkeletonPose, duration:number /*number /*uint*/)\n\t{\n\t\tthis._frames.push(skeletonPose);\n\t\tthis._pDurations.push(duration);\n\n\t\tthis._pNumFrames = this._pDurations.length;\n\n\t\tthis._pStitchDirty = true;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAnimationState(animator:AnimatorBase):SkeletonClipState\n\t{\n\t\treturn <SkeletonClipState> animator.getAnimationState(this);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _pUpdateStitch()\n\t{\n\t\tsuper._pUpdateStitch();\n\n\t\tvar i:number /*uint*/ = this._pNumFrames - 1;\n\t\tvar p1:Vector3D, p2:Vector3D, delta:Vector3D;\n\t\twhile (i--) {\n\t\t\tthis._pTotalDuration += this._pDurations[i];\n\t\t\tp1 = this._frames[i].jointPoses[0].translation;\n\t\t\tp2 = this._frames[i + 1].jointPoses[0].translation;\n\t\t\tdelta = p2.subtract(p1);\n\t\t\tthis._pTotalDelta.x += delta.x;\n\t\t\tthis._pTotalDelta.y += delta.y;\n\t\t\tthis._pTotalDelta.z += delta.z;\n\t\t}\n\n\t\tif (this._pStitchFinalFrame || !this._pLooping) {\n\t\t\tthis._pTotalDuration += this._pDurations[this._pNumFrames - 1];\n\t\t\tp1 = this._frames[0].jointPoses[0].translation;\n\t\t\tp2 = this._frames[1].jointPoses[0].translation;\n\t\t\tdelta = p2.subtract(p1);\n\t\t\tthis._pTotalDelta.x += delta.x;\n\t\t\tthis._pTotalDelta.y += delta.y;\n\t\t\tthis._pTotalDelta.z += delta.z;\n\t\t}\n\t}\n}\n\nexport = SkeletonClipNode;","import AnimationNodeBase\t\t\t\t= require(\"awayjs-display/lib/animators/nodes/AnimationNodeBase\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\n\nimport SkeletonDifferenceState\t\t\t= require(\"awayjs-renderergl/lib/animators/states/SkeletonDifferenceState\");\n\n/**\n * A skeleton animation node that uses a difference input pose with a base input pose to blend a linearly interpolated output of a skeleton pose.\n */\nclass SkeletonDifferenceNode extends AnimationNodeBase\n{\n\t/**\n\t * Defines a base input node to use for the blended output.\n\t */\n\tpublic baseInput:AnimationNodeBase;\n\n\t/**\n\t * Defines a difference input node to use for the blended output.\n\t */\n\tpublic differenceInput:AnimationNodeBase;\n\n\t/**\n\t * Creates a new <code>SkeletonAdditiveNode</code> object.\n\t */\n\tconstructor()\n\t{\n\t\tsuper();\n\n\t\tthis._pStateClass = SkeletonDifferenceState;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAnimationState(animator:AnimatorBase):SkeletonDifferenceState\n\t{\n\t\treturn <SkeletonDifferenceState> animator.getAnimationState(this);\n\t}\n}\n\nexport = SkeletonDifferenceNode","import AnimationNodeBase\t\t\t\t= require(\"awayjs-display/lib/animators/nodes/AnimationNodeBase\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\n\nimport SkeletonDirectionalState\t\t\t= require(\"awayjs-renderergl/lib/animators/states/SkeletonDirectionalState\");\n\n/**\n * A skeleton animation node that uses four directional input poses with an input direction to blend a linearly interpolated output of a skeleton pose.\n */\nclass SkeletonDirectionalNode extends AnimationNodeBase\n{\n\t/**\n\t * Defines the forward configured input node to use for the blended output.\n\t */\n\tpublic forward:AnimationNodeBase;\n\n\t/**\n\t * Defines the backwards configured input node to use for the blended output.\n\t */\n\tpublic backward:AnimationNodeBase;\n\n\t/**\n\t * Defines the left configured input node to use for the blended output.\n\t */\n\tpublic left:AnimationNodeBase;\n\n\t/**\n\t * Defines the right configured input node to use for the blended output.\n\t */\n\tpublic right:AnimationNodeBase;\n\n\tconstructor()\n\t{\n\t\tsuper();\n\n\t\tthis._pStateClass = SkeletonDirectionalState;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAnimationState(animator:AnimatorBase):SkeletonDirectionalState\n\t{\n\t\treturn <SkeletonDirectionalState> animator.getAnimationState(this);\n\t}\n\n}\n\nexport = SkeletonDirectionalNode;","import AnimationNodeBase\t\t\t\t= require(\"awayjs-display/lib/animators/nodes/AnimationNodeBase\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\n\nimport SkeletonNaryLERPState\t\t\t= require(\"awayjs-renderergl/lib/animators/states/SkeletonNaryLERPState\");\n\n/**\n * A skeleton animation node that uses an n-dimensional array of animation node inputs to blend a lineraly interpolated output of a skeleton pose.\n */\nclass SkeletonNaryLERPNode extends AnimationNodeBase\n{\n\tpublic _iInputs:Array<AnimationNodeBase> = new Array<AnimationNodeBase>();\n\n\tprivate _numInputs:number /*uint*/;\n\n\tpublic get numInputs():number /*uint*/\n\t{\n\t\treturn this._numInputs;\n\t}\n\n\t/**\n\t * Creates a new <code>SkeletonNaryLERPNode</code> object.\n\t */\n\tconstructor()\n\t{\n\t\tsuper();\n\n\t\tthis._pStateClass = SkeletonNaryLERPState;\n\t}\n\n\t/**\n\t * Returns an integer representing the input index of the given skeleton animation node.\n\t *\n\t * @param input The skeleton animation node for with the input index is requested.\n\t */\n\tpublic getInputIndex(input:AnimationNodeBase):number /*int*/\n\t{\n\t\treturn this._iInputs.indexOf(input);\n\t}\n\n\t/**\n\t * Returns the skeleton animation node object that resides at the given input index.\n\t *\n\t * @param index The input index for which the skeleton animation node is requested.\n\t */\n\tpublic getInputAt(index:number /*uint*/):AnimationNodeBase\n\t{\n\t\treturn this._iInputs[index];\n\t}\n\n\t/**\n\t * Adds a new skeleton animation node input to the animation node.\n\t */\n\tpublic addInput(input:AnimationNodeBase)\n\t{\n\t\tthis._iInputs[this._numInputs++] = input;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getAnimationState(animator:AnimatorBase):SkeletonNaryLERPState\n\t{\n\t\treturn <SkeletonNaryLERPState> animator.getAnimationState(this);\n\t}\n}\n\nexport = SkeletonNaryLERPNode","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport Geometry\t\t\t\t\t\t\t= require(\"awayjs-display/lib/base/Geometry\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\n\nimport AnimationClipNodeBase\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/AnimationClipNodeBase\");\nimport VertexClipState\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/VertexClipState\");\n\n/**\n * A vertex animation node containing time-based animation data as individual geometry obejcts.\n */\nclass VertexClipNode extends AnimationClipNodeBase\n{\n\tprivate _frames:Array<Geometry> = new Array<Geometry>();\n\tprivate _translations:Array<Vector3D> = new Array<Vector3D>();\n\n\t/**\n\t * Returns a vector of geometry frames representing the vertex values of each animation frame in the clip.\n\t */\n\tpublic get frames():Array<Geometry>\n\t{\n\t\treturn this._frames;\n\t}\n\n\t/**\n\t * Creates a new <code>VertexClipNode</code> object.\n\t */\n\tconstructor()\n\t{\n\t\tsuper();\n\n\t\tthis._pStateClass = VertexClipState;\n\t}\n\n\t/**\n\t * Adds a geometry object to the internal timeline of the animation node.\n\t *\n\t * @param geometry The geometry object to add to the timeline of the node.\n\t * @param duration The specified duration of the frame in milliseconds.\n\t * @param translation The absolute translation of the frame, used in root delta calculations for mesh movement.\n\t */\n\tpublic addFrame(geometry:Geometry, duration:number /*uint*/, translation:Vector3D = null)\n\t{\n\t\tthis._frames.push(geometry);\n\t\tthis._pDurations.push(duration);\n\t\tthis._translations.push(translation || new Vector3D());\n\n\t\tthis._pNumFrames = this._pDurations.length;\n\n\t\tthis._pStitchDirty = true;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _pUpdateStitch()\n\t{\n\t\tsuper._pUpdateStitch();\n\n\t\tvar i:number /*uint*/ = this._pNumFrames - 1;\n\t\tvar p1:Vector3D, p2:Vector3D, delta:Vector3D;\n\t\twhile (i--) {\n\t\t\tthis._pTotalDuration += this._pDurations[i];\n\t\t\tp1 = this._translations[i];\n\t\t\tp2 = this._translations[i + 1];\n\t\t\tdelta = p2.subtract(p1);\n\t\t\tthis._pTotalDelta.x += delta.x;\n\t\t\tthis._pTotalDelta.y += delta.y;\n\t\t\tthis._pTotalDelta.z += delta.z;\n\t\t}\n\n\t\tif (this._pNumFrames > 1 && (this._pStitchFinalFrame || !this._pLooping)) {\n\t\t\tthis._pTotalDuration += this._pDurations[this._pNumFrames - 1];\n\t\t\tp1 = this._translations[0];\n\t\t\tp2 = this._translations[1];\n\t\t\tdelta = p2.subtract(p1);\n\t\t\tthis._pTotalDelta.x += delta.x;\n\t\t\tthis._pTotalDelta.y += delta.y;\n\t\t\tthis._pTotalDelta.z += delta.z;\n\t\t}\n\t}\n}\n\nexport = VertexClipNode;","import AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\n\nimport AnimationClipNodeBase\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/AnimationClipNodeBase\");\nimport AnimationStateBase\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/AnimationStateBase\");\nimport AnimationStateEvent\t\t\t\t= require(\"awayjs-renderergl/lib/events/AnimationStateEvent\");\n\n/**\n *\n */\nclass AnimationClipState extends AnimationStateBase\n{\n\tprivate _animationClipNode:AnimationClipNodeBase;\n\tprivate _animationStatePlaybackComplete:AnimationStateEvent;\n\tpublic _pBlendWeight:number;\n\tpublic _pCurrentFrame:number /*uint*/;\n\tpublic _pNextFrame:number /*uint*/;\n\n\tpublic _pOldFrame:number /*uint*/;\n\tpublic _pTimeDir:number /*int*/;\n\tpublic _pFramesDirty:boolean = true;\n\n\t/**\n\t * Returns a fractional value between 0 and 1 representing the blending ratio of the current playhead position\n\t * between the current frame (0) and next frame (1) of the animation.\n\t *\n\t * @see #currentFrame\n\t * @see #nextFrame\n\t */\n\tpublic get blendWeight():number\n\t{\n\t\tif (this._pFramesDirty)\n\t\t\tthis._pUpdateFrames();\n\n\t\treturn this._pBlendWeight;\n\t}\n\n\t/**\n\t * Returns the current frame of animation in the clip based on the internal playhead position.\n\t */\n\tpublic get currentFrame():number /*uint*/\n\t{\n\t\tif (this._pFramesDirty)\n\t\t\tthis._pUpdateFrames();\n\n\t\treturn this._pCurrentFrame;\n\t}\n\n\t/**\n\t * Returns the next frame of animation in the clip based on the internal playhead position.\n\t */\n\tpublic get nextFrame():number /*uint*/\n\t{\n\t\tif (this._pFramesDirty)\n\t\t\tthis._pUpdateFrames();\n\n\t\treturn this._pNextFrame;\n\t}\n\n\tconstructor(animator:AnimatorBase, animationClipNode:AnimationClipNodeBase)\n\t{\n\t\tsuper(animator, animationClipNode);\n\n\t\tthis._animationClipNode = animationClipNode;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic update(time:number /*int*/)\n\t{\n\t\tif (!this._animationClipNode.looping) {\n\t\t\tif (time > this._pStartTime + this._animationClipNode.totalDuration)\n\t\t\t\ttime = this._pStartTime + this._animationClipNode.totalDuration; else if (time < this._pStartTime)\n\t\t\t\ttime = this._pStartTime;\n\t\t}\n\n\t\tif (this._pTime == time - this._pStartTime)\n\t\t\treturn;\n\n\t\tthis._pUpdateTime(time);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic phase(value:number)\n\t{\n\t\tvar time:number /*int*/ = value*this._animationClipNode.totalDuration + this._pStartTime;\n\n\t\tif (this._pTime == time - this._pStartTime)\n\t\t\treturn;\n\n\t\tthis._pUpdateTime(time);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _pUpdateTime(time:number /*int*/)\n\t{\n\t\tthis._pFramesDirty = true;\n\n\t\tthis._pTimeDir = (time - this._pStartTime > this._pTime)? 1 : -1;\n\n\t\tsuper._pUpdateTime(time);\n\t}\n\n\t/**\n\t * Updates the nodes internal playhead to determine the current and next animation frame, and the blendWeight between the two.\n\t *\n\t * @see #currentFrame\n\t * @see #nextFrame\n\t * @see #blendWeight\n\t */\n\tpublic _pUpdateFrames()\n\t{\n\t\tthis._pFramesDirty = false;\n\n\t\tvar looping:boolean = this._animationClipNode.looping;\n\t\tvar totalDuration:number /*uint*/ = this._animationClipNode.totalDuration;\n\t\tvar lastFrame:number /*uint*/ = this._animationClipNode.lastFrame;\n\t\tvar time:number /*int*/ = this._pTime;\n\n\t\t//trace(\"time\", time, totalDuration)\n\t\tif (looping && (time >= totalDuration || time < 0)) {\n\t\t\ttime %= totalDuration;\n\t\t\tif (time < 0)\n\t\t\t\ttime += totalDuration;\n\t\t}\n\n\t\tif (!looping && time >= totalDuration) {\n\t\t\tthis.notifyPlaybackComplete();\n\t\t\tthis._pCurrentFrame = lastFrame;\n\t\t\tthis._pNextFrame = lastFrame;\n\t\t\tthis._pBlendWeight = 0;\n\t\t} else if (!looping && time <= 0) {\n\t\t\tthis._pCurrentFrame = 0;\n\t\t\tthis._pNextFrame = 0;\n\t\t\tthis._pBlendWeight = 0;\n\t\t} else if (this._animationClipNode.fixedFrameRate) {\n\t\t\tvar t:number = time/totalDuration*lastFrame;\n\t\t\tthis._pCurrentFrame = Math.floor(t);\n\t\t\tthis._pBlendWeight = t - this._pCurrentFrame;\n\t\t\tthis._pNextFrame = this._pCurrentFrame + 1;\n\t\t} else {\n\t\t\tthis._pCurrentFrame = 0;\n\t\t\tthis._pNextFrame = 0;\n\n\t\t\tvar dur:number /*uint*/ = 0, frameTime:number /*uint*/;\n\t\t\tvar durations:Array<number> /*uint*/ = this._animationClipNode.durations;\n\n\t\t\tdo {\n\t\t\t\tframeTime = dur;\n\t\t\t\tdur += durations[this._pNextFrame];\n\t\t\t\tthis._pCurrentFrame = this._pNextFrame++;\n\t\t\t} while (time > dur);\n\n\t\t\tif (this._pCurrentFrame == lastFrame) {\n\t\t\t\tthis._pCurrentFrame = 0;\n\t\t\t\tthis._pNextFrame = 1;\n\t\t\t}\n\n\t\t\tthis._pBlendWeight = (time - frameTime)/durations[this._pCurrentFrame];\n\t\t}\n\t}\n\n\tprivate notifyPlaybackComplete()\n\t{\n\t\tif (this._animationStatePlaybackComplete == null)\n\t\t\tthis._animationStatePlaybackComplete = new AnimationStateEvent(AnimationStateEvent.PLAYBACK_COMPLETE, this._pAnimator, this, this._animationClipNode);\n\n\t\tthis._animationClipNode.dispatchEvent(this._animationStatePlaybackComplete);\n\t}\n}\n\nexport = AnimationClipState;","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport AnimationNodeBase\t\t\t\t= require(\"awayjs-display/lib/animators/nodes/AnimationNodeBase\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport IAnimationState\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/IAnimationState\");\n\nimport AnimationStateEvent\t\t\t\t= require(\"awayjs-renderergl/lib/events/AnimationStateEvent\");\n\n/**\n *\n */\nclass AnimationStateBase implements IAnimationState\n{\n\tpublic _pAnimationNode:AnimationNodeBase;\n\tpublic _pRootDelta:Vector3D = new Vector3D();\n\tpublic _pPositionDeltaDirty:boolean = true;\n\n\tpublic _pTime:number;\n\tpublic _pStartTime:number = 0;\n\tpublic _pAnimator:AnimatorBase;\n\n\t/**\n\t * Returns a 3d vector representing the translation delta of the animating entity for the current timestep of animation\n\t */\n\tpublic get positionDelta():Vector3D\n\t{\n\t\tif (this._pPositionDeltaDirty) {\n\n\t\t\tthis._pUpdatePositionDelta();\n\t\t}\n\n\t\treturn this._pRootDelta;\n\n\t}\n\n\tconstructor(animator:AnimatorBase, animationNode:AnimationNodeBase)\n\t{\n\t\tthis._pAnimator = animator;\n\t\tthis._pAnimationNode = animationNode;\n\t}\n\n\t/**\n\t * Resets the start time of the node to a  new value.\n\t *\n\t * @param startTime The absolute start time (in milliseconds) of the node's starting time.\n\t */\n\tpublic offset(startTime:number)\n\t{\n\t\tthis._pStartTime = startTime;\n\n\t\tthis._pPositionDeltaDirty = true;\n\t}\n\n\t/**\n\t * Updates the configuration of the node to its current state.\n\t *\n\t * @param time The absolute time (in milliseconds) of the animator's play head position.\n\t *\n\t * @see AnimatorBase#update()\n\t */\n\tpublic update(time:number)\n\t{\n\t\tif (this._pTime == time - this._pStartTime) {\n\n\t\t\treturn;\n\n\t\t}\n\n\t\tthis._pUpdateTime(time);\n\n\t}\n\n\t/**\n\t * Sets the animation phase of the node.\n\t *\n\t * @param value The phase value to use. 0 represents the beginning of an animation clip, 1 represents the end.\n\t */\n\tpublic phase(value:number)\n\t{\n\n\t}\n\n\t/**\n\t * Updates the node's internal playhead position.\n\t *\n\t * @param time The local time (in milliseconds) of the node's playhead position.\n\t */\n\tpublic _pUpdateTime(time:number)\n\t{\n\t\tthis._pTime = time - this._pStartTime;\n\n\t\tthis._pPositionDeltaDirty = true;\n\t}\n\n\t/**\n\t * Updates the node's root delta position\n\t */\n\tpublic _pUpdatePositionDelta()\n\t{\n\t}\n}\n\nexport = AnimationStateBase;","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport Camera\t\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\n\nimport Stage\t\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\nimport ContextGLVertexBufferFormat\t\t= require(\"awayjs-stagegl/lib/base/ContextGLVertexBufferFormat\");\n\nimport ParticleAnimator\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/ParticleAnimator\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport AnimationSubGeometry\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationSubGeometry\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticleAccelerationNode\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleAccelerationNode\");\nimport ParticleStateBase\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleStateBase\");\nimport RenderableBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\n\n/**\n * ...\n */\nclass ParticleAccelerationState extends ParticleStateBase\n{\n\t/** @private */\n\tpublic static ACCELERATION_INDEX:number /*int*/ = 0;\n\n\tprivate _particleAccelerationNode:ParticleAccelerationNode;\n\tprivate _acceleration:Vector3D;\n\tprivate _halfAcceleration:Vector3D;\n\t\n\t/**\n\t * Defines the acceleration vector of the state, used when in global mode.\n\t */\n\tpublic get acceleration():Vector3D\n\t{\n\t\treturn this._acceleration;\n\t}\n\t\n\tpublic set acceleration(value:Vector3D)\n\t{\n\t\tthis._acceleration.x = value.x;\n\t\tthis._acceleration.y = value.y;\n\t\tthis._acceleration.z = value.z;\n\n\t\tthis.updateAccelerationData();\n\t}\n\t\n\tconstructor(animator:ParticleAnimator, particleAccelerationNode:ParticleAccelerationNode)\n\t{\n\t\tsuper(animator, particleAccelerationNode);\n\n\t\tthis._particleAccelerationNode = particleAccelerationNode;\n\t\tthis._acceleration = this._particleAccelerationNode._acceleration;\n\n\t\tthis.updateAccelerationData();\n\t}\n\t\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic setRenderState(stage:Stage, renderable:RenderableBase, animationSubGeometry:AnimationSubGeometry, animationRegisterCache:AnimationRegisterCache, camera:Camera)\n\t{\n\t\tvar index:number /*int*/ = animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleAccelerationState.ACCELERATION_INDEX);\n\t\t\n\t\tif (this._particleAccelerationNode.mode == ParticlePropertiesMode.LOCAL_STATIC)\n\t\t\tanimationSubGeometry.activateVertexBuffer(index, this._particleAccelerationNode._iDataOffset, stage, ContextGLVertexBufferFormat.FLOAT_3);\n\t\telse\n\t\t\tanimationRegisterCache.setVertexConst(index, this._halfAcceleration.x, this._halfAcceleration.y, this._halfAcceleration.z);\n\t}\n\t\n\tprivate updateAccelerationData()\n\t{\n\t\tif (this._particleAccelerationNode.mode == ParticlePropertiesMode.GLOBAL)\n\t\t\tthis._halfAcceleration = new Vector3D(this._acceleration.x/2, this._acceleration.y/2, this._acceleration.z/2);\n\t}\n}\n\nexport = ParticleAccelerationState;","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport Camera\t\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\n\nimport Stage\t\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\nimport ContextGLVertexBufferFormat\t\t= require(\"awayjs-stagegl/lib/base/ContextGLVertexBufferFormat\");\n\nimport ParticleAnimator\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/ParticleAnimator\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport AnimationSubGeometry\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationSubGeometry\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticleBezierCurveNode\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleBezierCurveNode\");\nimport ParticleStateBase\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleStateBase\");\nimport RenderableBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\n/**\n * ...\n */\nclass ParticleBezierCurveState extends ParticleStateBase\n{\n\t/** @private */\n\tpublic static BEZIER_CONTROL_INDEX:number /*int*/ = 0;\n\n\t/** @private */\n\tpublic static BEZIER_END_INDEX:number /*int*/ = 1;\n\n\tprivate _particleBezierCurveNode:ParticleBezierCurveNode;\n\tprivate _controlPoint:Vector3D;\n\tprivate _endPoint:Vector3D;\n\n\t/**\n\t * Defines the default control point of the node, used when in global mode.\n\t */\n\tpublic get controlPoint():Vector3D\n\t{\n\t\treturn this._controlPoint;\n\t}\n\n\tpublic set controlPoint(value:Vector3D)\n\t{\n\t\tthis._controlPoint = value;\n\t}\n\n\t/**\n\t * Defines the default end point of the node, used when in global mode.\n\t */\n\tpublic get endPoint():Vector3D\n\t{\n\t\treturn this._endPoint;\n\t}\n\n\tpublic set endPoint(value:Vector3D)\n\t{\n\t\tthis._endPoint = value;\n\t}\n\n\tconstructor(animator:ParticleAnimator, particleBezierCurveNode:ParticleBezierCurveNode)\n\t{\n\t\tsuper(animator, particleBezierCurveNode);\n\n\t\tthis._particleBezierCurveNode = particleBezierCurveNode;\n\t\tthis._controlPoint = this._particleBezierCurveNode._iControlPoint;\n\t\tthis._endPoint = this._particleBezierCurveNode._iEndPoint;\n\t}\n\n\tpublic setRenderState(stage:Stage, renderable:RenderableBase, animationSubGeometry:AnimationSubGeometry, animationRegisterCache:AnimationRegisterCache, camera:Camera)\n\t{\n\t\tvar controlIndex:number /*int*/ = animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleBezierCurveState.BEZIER_CONTROL_INDEX);\n\t\tvar endIndex:number /*int*/ = animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleBezierCurveState.BEZIER_END_INDEX);\n\n\t\tif (this._particleBezierCurveNode.mode == ParticlePropertiesMode.LOCAL_STATIC) {\n\t\t\tanimationSubGeometry.activateVertexBuffer(controlIndex, this._particleBezierCurveNode._iDataOffset, stage, ContextGLVertexBufferFormat.FLOAT_3);\n\t\t\tanimationSubGeometry.activateVertexBuffer(endIndex, this._particleBezierCurveNode._iDataOffset + 3, stage, ContextGLVertexBufferFormat.FLOAT_3);\n\t\t} else {\n\t\t\tanimationRegisterCache.setVertexConst(controlIndex, this._controlPoint.x, this._controlPoint.y, this._controlPoint.z);\n\t\t\tanimationRegisterCache.setVertexConst(endIndex, this._endPoint.x, this._endPoint.y, this._endPoint.z);\n\t\t}\n\t}\n}\n\nexport = ParticleBezierCurveState;","import MathConsts\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/MathConsts\");\nimport Matrix3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3D\");\nimport Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\nimport Orientation3D\t\t\t\t\t= require(\"awayjs-core/lib/geom/Orientation3D\");\n\nimport Camera\t\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\n\nimport Stage\t\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\n\nimport ParticleAnimator\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/ParticleAnimator\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport AnimationSubGeometry\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationSubGeometry\");\nimport ParticleBillboardNode\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleBillboardNode\");\nimport ParticleStateBase\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleStateBase\");\nimport RenderableBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\n\n/**\n * ...\n */\nclass ParticleBillboardState extends ParticleStateBase\n{\n\t/** @private */\n\tpublic static MATRIX_INDEX:number /*int*/ = 0;\n\n\tprivate _matrix:Matrix3D = new Matrix3D;\n\n\tprivate _billboardAxis:Vector3D;\n\n\t/**\n\t *\n\t */\n\tconstructor(animator:ParticleAnimator, particleNode:ParticleBillboardNode)\n\t{\n\t\tsuper(animator, particleNode);\n\n\t\tthis._billboardAxis = particleNode._iBillboardAxis;\n\t}\n\n\tpublic setRenderState(stage:Stage, renderable:RenderableBase, animationSubGeometry:AnimationSubGeometry, animationRegisterCache:AnimationRegisterCache, camera:Camera)\n\t{\n\t\tvar comps:Array<Vector3D>;\n\t\tif (this._billboardAxis) {\n\t\t\tvar pos:Vector3D = renderable.sourceEntity.sceneTransform.position;\n\t\t\tvar look:Vector3D = camera.sceneTransform.position.subtract(pos);\n\t\t\tvar right:Vector3D = look.crossProduct(this._billboardAxis);\n\t\t\tright.normalize();\n\t\t\tlook = this.billboardAxis.crossProduct(right);\n\t\t\tlook.normalize();\n\n\t\t\t//create a quick inverse projection matrix\n\t\t\tthis._matrix.copyFrom(renderable.sourceEntity.sceneTransform);\n\t\t\tcomps = this._matrix.decompose(Orientation3D.AXIS_ANGLE);\n\t\t\tthis._matrix.copyColumnFrom(0, right);\n\t\t\tthis._matrix.copyColumnFrom(1, this.billboardAxis);\n\t\t\tthis._matrix.copyColumnFrom(2, look);\n\t\t\tthis._matrix.copyColumnFrom(3, pos);\n\t\t\tthis._matrix.appendRotation(-comps[1].w*MathConsts.RADIANS_TO_DEGREES, comps[1]);\n\t\t} else {\n\t\t\t//create a quick inverse projection matrix\n\t\t\tthis._matrix.copyFrom(renderable.sourceEntity.sceneTransform);\n\t\t\tthis._matrix.append(camera.inverseSceneTransform);\n\n\t\t\t//decompose using axis angle rotations\n\t\t\tcomps = this._matrix.decompose(Orientation3D.AXIS_ANGLE);\n\n\t\t\t//recreate the matrix with just the rotation data\n\t\t\tthis._matrix.identity();\n\t\t\tthis._matrix.appendRotation(-comps[1].w*MathConsts.RADIANS_TO_DEGREES, comps[1]);\n\t\t}\n\n\t\t//set a new matrix transform constant\n\t\tanimationRegisterCache.setVertexConstFromMatrix(animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleBillboardState.MATRIX_INDEX), this._matrix);\n\t}\n\n\t/**\n\t * Defines the billboard axis.\n\t */\n\tpublic get billboardAxis():Vector3D\n\t{\n\t\treturn this.billboardAxis;\n\t}\n\n\tpublic set billboardAxis(value:Vector3D)\n\t{\n\t\tthis.billboardAxis = value? value.clone() : null;\n\t\tif (this.billboardAxis)\n\t\t\tthis.billboardAxis.normalize();\n\t}\n\n}\n\nexport = ParticleBillboardState;","import ColorTransform\t\t\t\t\t= require(\"awayjs-core/lib/geom/ColorTransform\");\nimport Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport Camera\t\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\n\nimport Stage\t\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\nimport ContextGLVertexBufferFormat\t\t= require(\"awayjs-stagegl/lib/base/ContextGLVertexBufferFormat\");\n\nimport ParticleAnimator\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/ParticleAnimator\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport AnimationSubGeometry\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationSubGeometry\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticleColorNode\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleColorNode\");\nimport ParticleStateBase\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleStateBase\");\nimport RenderableBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\n\n/**\n * ...\n * @author ...\n */\nclass ParticleColorState extends ParticleStateBase\n{\n\t/** @private */\n\tpublic static START_MULTIPLIER_INDEX:number /*uint*/ = 0;\n\n\t/** @private */\n\tpublic static DELTA_MULTIPLIER_INDEX:number /*uint*/ = 1;\n\n\t/** @private */\n\tpublic static START_OFFSET_INDEX:number /*uint*/ = 2;\n\n\t/** @private */\n\tpublic static DELTA_OFFSET_INDEX:number /*uint*/ = 3;\n\n\t/** @private */\n\tpublic static CYCLE_INDEX:number /*uint*/ = 4;\n\n\tprivate _particleColorNode:ParticleColorNode;\n\tprivate _usesMultiplier:boolean;\n\tprivate _usesOffset:boolean;\n\tprivate _usesCycle:boolean;\n\tprivate _usesPhase:boolean;\n\tprivate _startColor:ColorTransform;\n\tprivate _endColor:ColorTransform;\n\tprivate _cycleDuration:number;\n\tprivate _cyclePhase:number;\n\tprivate _cycleData:Vector3D;\n\tprivate _startMultiplierData:Vector3D;\n\tprivate _deltaMultiplierData:Vector3D;\n\tprivate _startOffsetData:Vector3D;\n\tprivate _deltaOffsetData:Vector3D;\n\n\t/**\n\t * Defines the start color transform of the state, when in global mode.\n\t */\n\tpublic get startColor():ColorTransform\n\t{\n\t\treturn this._startColor;\n\t}\n\n\tpublic set startColor(value:ColorTransform)\n\t{\n\t\tthis._startColor = value;\n\n\t\tthis.updateColorData();\n\t}\n\n\t/**\n\t * Defines the end color transform of the state, when in global mode.\n\t */\n\tpublic get endColor():ColorTransform\n\t{\n\t\treturn this._endColor;\n\t}\n\n\tpublic set endColor(value:ColorTransform)\n\t{\n\t\tthis._endColor = value;\n\n\t\tthis.updateColorData();\n\t}\n\n\t/**\n\t * Defines the duration of the animation in seconds, used as a period independent of particle duration when in global mode. Defaults to 1.\n\t */\n\tpublic get cycleDuration():number\n\t{\n\t\treturn this._cycleDuration;\n\t}\n\n\tpublic set cycleDuration(value:number)\n\t{\n\t\tthis._cycleDuration = value;\n\n\t\tthis.updateColorData();\n\t}\n\n\t/**\n\t * Defines the phase of the cycle in degrees, used as the starting offset of the cycle when in global mode. Defaults to 0.\n\t */\n\tpublic get cyclePhase():number\n\t{\n\t\treturn this._cyclePhase;\n\t}\n\n\tpublic set cyclePhase(value:number)\n\t{\n\t\tthis._cyclePhase = value;\n\n\t\tthis.updateColorData();\n\t}\n\n\tconstructor(animator:ParticleAnimator, particleColorNode:ParticleColorNode)\n\t{\n\t\tsuper(animator, particleColorNode);\n\n\t\tthis._particleColorNode = particleColorNode;\n\t\tthis._usesMultiplier = this._particleColorNode._iUsesMultiplier;\n\t\tthis._usesOffset = this._particleColorNode._iUsesOffset;\n\t\tthis._usesCycle = this._particleColorNode._iUsesCycle;\n\t\tthis._usesPhase = this._particleColorNode._iUsesPhase;\n\t\tthis._startColor = this._particleColorNode._iStartColor;\n\t\tthis._endColor = this._particleColorNode._iEndColor;\n\t\tthis._cycleDuration = this._particleColorNode._iCycleDuration;\n\t\tthis._cyclePhase = this._particleColorNode._iCyclePhase;\n\n\t\tthis.updateColorData();\n\t}\n\n\tpublic setRenderState(stage:Stage, renderable:RenderableBase, animationSubGeometry:AnimationSubGeometry, animationRegisterCache:AnimationRegisterCache, camera:Camera)\n\t{\n\t\tif (animationRegisterCache.needFragmentAnimation) {\n\t\t\tvar dataOffset:number /*uint*/ = this._particleColorNode._iDataOffset;\n\t\t\tif (this._usesCycle)\n\t\t\t\tanimationRegisterCache.setVertexConst(animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleColorState.CYCLE_INDEX), this._cycleData.x, this._cycleData.y, this._cycleData.z, this._cycleData.w);\n\n\t\t\tif (this._usesMultiplier) {\n\t\t\t\tif (this._particleColorNode.mode == ParticlePropertiesMode.LOCAL_STATIC) {\n\t\t\t\t\tanimationSubGeometry.activateVertexBuffer(animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleColorState.START_MULTIPLIER_INDEX), dataOffset, stage, ContextGLVertexBufferFormat.FLOAT_4);\n\t\t\t\t\tdataOffset += 4;\n\t\t\t\t\tanimationSubGeometry.activateVertexBuffer(animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleColorState.DELTA_MULTIPLIER_INDEX), dataOffset, stage, ContextGLVertexBufferFormat.FLOAT_4);\n\t\t\t\t\tdataOffset += 4;\n\t\t\t\t} else {\n\t\t\t\t\tanimationRegisterCache.setVertexConst(animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleColorState.START_MULTIPLIER_INDEX), this._startMultiplierData.x, this._startMultiplierData.y, this._startMultiplierData.z, this._startMultiplierData.w);\n\t\t\t\t\tanimationRegisterCache.setVertexConst(animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleColorState.DELTA_MULTIPLIER_INDEX), this._deltaMultiplierData.x, this._deltaMultiplierData.y, this._deltaMultiplierData.z, this._deltaMultiplierData.w);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (this._usesOffset) {\n\t\t\t\tif (this._particleColorNode.mode == ParticlePropertiesMode.LOCAL_STATIC) {\n\t\t\t\t\tanimationSubGeometry.activateVertexBuffer(animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleColorState.START_OFFSET_INDEX), dataOffset, stage, ContextGLVertexBufferFormat.FLOAT_4);\n\t\t\t\t\tdataOffset += 4;\n\t\t\t\t\tanimationSubGeometry.activateVertexBuffer(animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleColorState.DELTA_OFFSET_INDEX), dataOffset, stage, ContextGLVertexBufferFormat.FLOAT_4);\n\t\t\t\t\tdataOffset += 4;\n\t\t\t\t} else {\n\t\t\t\t\tanimationRegisterCache.setVertexConst(animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleColorState.START_OFFSET_INDEX), this._startOffsetData.x, this._startOffsetData.y, this._startOffsetData.z, this._startOffsetData.w);\n\t\t\t\t\tanimationRegisterCache.setVertexConst(animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleColorState.DELTA_OFFSET_INDEX), this._deltaOffsetData.x, this._deltaOffsetData.y, this._deltaOffsetData.z, this._deltaOffsetData.w);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate updateColorData()\n\t{\n\t\tif (this._usesCycle) {\n\t\t\tif (this._cycleDuration <= 0)\n\t\t\t\tthrow(new Error(\"the cycle duration must be greater than zero\"));\n\t\t\tthis._cycleData = new Vector3D(Math.PI*2/this._cycleDuration, this._cyclePhase*Math.PI/180, 0, 0);\n\t\t}\n\t\tif (this._particleColorNode.mode == ParticlePropertiesMode.GLOBAL) {\n\t\t\tif (this._usesCycle) {\n\t\t\t\tif (this._usesMultiplier) {\n\t\t\t\t\tthis._startMultiplierData = new Vector3D((this._startColor.redMultiplier + this._endColor.redMultiplier)/2, (this._startColor.greenMultiplier + this._endColor.greenMultiplier)/2, (this._startColor.blueMultiplier + this._endColor.blueMultiplier)/2, (this._startColor.alphaMultiplier + this._endColor.alphaMultiplier)/2);\n\t\t\t\t\tthis._deltaMultiplierData = new Vector3D((this._endColor.redMultiplier - this._startColor.redMultiplier)/2, (this._endColor.greenMultiplier - this._startColor.greenMultiplier)/2, (this._endColor.blueMultiplier - this._startColor.blueMultiplier)/2, (this._endColor.alphaMultiplier - this._startColor.alphaMultiplier)/2);\n\t\t\t\t}\n\n\t\t\t\tif (this._usesOffset) {\n\t\t\t\t\tthis._startOffsetData = new Vector3D((this._startColor.redOffset + this._endColor.redOffset)/(255*2), (this._startColor.greenOffset + this._endColor.greenOffset)/(255*2), (this._startColor.blueOffset + this._endColor.blueOffset)/(255*2), (this._startColor.alphaOffset + this._endColor.alphaOffset)/(255*2));\n\t\t\t\t\tthis._deltaOffsetData = new Vector3D((this._endColor.redOffset - this._startColor.redOffset)/(255*2), (this._endColor.greenOffset - this._startColor.greenOffset)/(255*2), (this._endColor.blueOffset - this._startColor.blueOffset)/(255*2), (this._endColor.alphaOffset - this._startColor.alphaOffset)/(255*2));\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (this._usesMultiplier) {\n\t\t\t\t\tthis._startMultiplierData = new Vector3D(this._startColor.redMultiplier, this._startColor.greenMultiplier, this._startColor.blueMultiplier, this._startColor.alphaMultiplier);\n\t\t\t\t\tthis._deltaMultiplierData = new Vector3D((this._endColor.redMultiplier - this._startColor.redMultiplier), (this._endColor.greenMultiplier - this._startColor.greenMultiplier), (this._endColor.blueMultiplier - this._startColor.blueMultiplier), (this._endColor.alphaMultiplier - this._startColor.alphaMultiplier));\n\t\t\t\t}\n\n\t\t\t\tif (this._usesOffset) {\n\t\t\t\t\tthis._startOffsetData = new Vector3D(this._startColor.redOffset/255, this._startColor.greenOffset/255, this._startColor.blueOffset/255, this._startColor.alphaOffset/255);\n\t\t\t\t\tthis._deltaOffsetData = new Vector3D((this._endColor.redOffset - this._startColor.redOffset)/255, (this._endColor.greenOffset - this._startColor.greenOffset)/255, (this._endColor.blueOffset - this._startColor.blueOffset )/255, (this._endColor.alphaOffset - this._startColor.alphaOffset)/255);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\n\nexport = ParticleColorState;","import MathConsts\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/MathConsts\");\nimport Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport DisplayObject\t\t\t\t\t= require(\"awayjs-display/lib/base/DisplayObject\");\nimport Camera\t\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\n\nimport Stage\t\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\nimport ContextGLVertexBufferFormat\t\t= require(\"awayjs-stagegl/lib/base/ContextGLVertexBufferFormat\");\n\nimport ParticleAnimator\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/ParticleAnimator\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport AnimationSubGeometry\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationSubGeometry\");\nimport ParticleAnimationData\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticleAnimationData\");\nimport ParticleFollowNode\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleFollowNode\");\nimport ParticleStateBase\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleStateBase\");\nimport RenderableBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\n\n/**\n * ...\n */\nclass ParticleFollowState extends ParticleStateBase\n{\n\t/** @private */\n\tpublic static FOLLOW_POSITION_INDEX:number /*uint*/ = 0;\n\n\t/** @private */\n\tpublic static FOLLOW_ROTATION_INDEX:number /*uint*/ = 1;\n\n\tprivate _particleFollowNode:ParticleFollowNode;\n\tprivate _followTarget:DisplayObject;\n\n\tprivate _targetPos:Vector3D = new Vector3D();\n\tprivate _targetEuler:Vector3D = new Vector3D();\n\tprivate _prePos:Vector3D;\n\tprivate _preEuler:Vector3D;\n\tprivate _smooth:boolean;\n\n\t//temporary vector3D for calculation\n\tprivate _temp:Vector3D = new Vector3D();\n\n\tconstructor(animator:ParticleAnimator, particleFollowNode:ParticleFollowNode)\n\t{\n\t\tsuper(animator, particleFollowNode, true);\n\n\t\tthis._particleFollowNode = particleFollowNode;\n\t\tthis._smooth = particleFollowNode._iSmooth;\n\t}\n\n\tpublic get followTarget():DisplayObject\n\t{\n\t\treturn this._followTarget;\n\t}\n\n\tpublic set followTarget(value:DisplayObject)\n\t{\n\t\tthis._followTarget = value;\n\t}\n\n\tpublic get smooth():boolean\n\t{\n\t\treturn this._smooth;\n\t}\n\n\tpublic set smooth(value:boolean)\n\t{\n\t\tthis._smooth = value;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic setRenderState(stage:Stage, renderable:RenderableBase, animationSubGeometry:AnimationSubGeometry, animationRegisterCache:AnimationRegisterCache, camera:Camera)\n\t{\n\t\tif (this._followTarget) {\n\t\t\tif (this._particleFollowNode._iUsesPosition) {\n\t\t\t\tthis._targetPos.x = this._followTarget.transform.position.x/renderable.sourceEntity.scaleX;\n\t\t\t\tthis._targetPos.y = this._followTarget.transform.position.y/renderable.sourceEntity.scaleY;\n\t\t\t\tthis._targetPos.z = this._followTarget.transform.position.z/renderable.sourceEntity.scaleZ;\n\t\t\t}\n\t\t\tif (this._particleFollowNode._iUsesRotation) {\n\t\t\t\tthis._targetEuler.x = this._followTarget.rotationX;\n\t\t\t\tthis._targetEuler.y = this._followTarget.rotationY;\n\t\t\t\tthis._targetEuler.z = this._followTarget.rotationZ;\n\t\t\t\tthis._targetEuler.scaleBy(MathConsts.DEGREES_TO_RADIANS);\n\t\t\t}\n\t\t}\n\t\t//initialization\n\t\tif (!this._prePos)\n\t\t\tthis._prePos = this._targetPos.clone();\n\t\tif (!this._preEuler)\n\t\t\tthis._preEuler = this._targetEuler.clone();\n\n\t\tvar currentTime:number = this._pTime/1000;\n\t\tvar previousTime:number = animationSubGeometry.previousTime;\n\t\tvar deltaTime:number = currentTime - previousTime;\n\n\t\tvar needProcess:boolean = previousTime != currentTime;\n\n\t\tif (this._particleFollowNode._iUsesPosition && this._particleFollowNode._iUsesRotation) {\n\t\t\tif (needProcess)\n\t\t\t\tthis.processPositionAndRotation(currentTime, deltaTime, animationSubGeometry);\n\n\t\t\tanimationSubGeometry.activateVertexBuffer(animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleFollowState.FOLLOW_POSITION_INDEX), this._particleFollowNode._iDataOffset, stage, ContextGLVertexBufferFormat.FLOAT_3);\n\t\t\tanimationSubGeometry.activateVertexBuffer(animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleFollowState.FOLLOW_ROTATION_INDEX), this._particleFollowNode._iDataOffset + 3, stage, ContextGLVertexBufferFormat.FLOAT_3);\n\t\t} else if (this._particleFollowNode._iUsesPosition) {\n\t\t\tif (needProcess)\n\t\t\t\tthis.processPosition(currentTime, deltaTime, animationSubGeometry);\n\n\t\t\tanimationSubGeometry.activateVertexBuffer(animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleFollowState.FOLLOW_POSITION_INDEX), this._particleFollowNode._iDataOffset, stage, ContextGLVertexBufferFormat.FLOAT_3);\n\t\t} else if (this._particleFollowNode._iUsesRotation) {\n\t\t\tif (needProcess)\n\t\t\t\tthis.precessRotation(currentTime, deltaTime, animationSubGeometry);\n\n\t\t\tanimationSubGeometry.activateVertexBuffer(animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleFollowState.FOLLOW_ROTATION_INDEX), this._particleFollowNode._iDataOffset, stage, ContextGLVertexBufferFormat.FLOAT_3);\n\t\t}\n\n\t\tthis._prePos.copyFrom(this._targetPos);\n\t\tthis._targetEuler.copyFrom(this._targetEuler);\n\t\tanimationSubGeometry.previousTime = currentTime;\n\t}\n\n\tprivate processPosition(currentTime:number, deltaTime:number, animationSubGeometry:AnimationSubGeometry)\n\t{\n\t\tvar data:Array<ParticleAnimationData> = animationSubGeometry.animationParticles;\n\t\tvar vertexData:Array<number> = animationSubGeometry.vertexData;\n\n\t\tvar changed:boolean = false;\n\t\tvar len:number /*uint*/ = data.length;\n\t\tvar interpolatedPos:Vector3D;\n\t\tvar posVelocity:Vector3D;\n\t\tif (this._smooth) {\n\t\t\tposVelocity = this._prePos.subtract(this._targetPos);\n\t\t\tposVelocity.scaleBy(1/deltaTime);\n\t\t} else\n\t\t\tinterpolatedPos = this._targetPos;\n\t\tfor (var i:number /*uint*/ = 0; i < len; i++) {\n\t\t\tvar k:number = (currentTime - data[i].startTime)/data[i].totalTime;\n\t\t\tvar t:number = (k - Math.floor(k))*data[i].totalTime;\n\t\t\tif (t - deltaTime <= 0) {\n\t\t\t\tvar inc:number /*int*/ = data[i].startVertexIndex*animationSubGeometry.totalLenOfOneVertex + this._particleFollowNode._iDataOffset;\n\n\t\t\t\tif (this._smooth) {\n\t\t\t\t\tthis._temp.copyFrom(posVelocity);\n\t\t\t\t\tthis._temp.scaleBy(t);\n\t\t\t\t\tinterpolatedPos = this._targetPos.add(this._temp);\n\t\t\t\t}\n\n\t\t\t\tif (vertexData[inc] != interpolatedPos.x || vertexData[inc + 1] != interpolatedPos.y || vertexData[inc + 2] != interpolatedPos.z) {\n\t\t\t\t\tchanged = true;\n\t\t\t\t\tfor (var j:number /*uint*/ = 0; j < data[i].numVertices; j++) {\n\t\t\t\t\t\tvertexData[inc++] = interpolatedPos.x;\n\t\t\t\t\t\tvertexData[inc++] = interpolatedPos.y;\n\t\t\t\t\t\tvertexData[inc++] = interpolatedPos.z;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (changed)\n\t\t\tanimationSubGeometry.invalidateBuffer();\n\n\t}\n\n\tprivate precessRotation(currentTime:number, deltaTime:number, animationSubGeometry:AnimationSubGeometry)\n\t{\n\t\tvar data:Array<ParticleAnimationData> = animationSubGeometry.animationParticles;\n\t\tvar vertexData:Array<number> = animationSubGeometry.vertexData;\n\n\t\tvar changed:boolean = false;\n\t\tvar len:number /*uint*/ = data.length;\n\n\t\tvar interpolatedRotation:Vector3D;\n\t\tvar rotationVelocity:Vector3D;\n\n\t\tif (this._smooth) {\n\t\t\trotationVelocity = this._preEuler.subtract(this._targetEuler);\n\t\t\trotationVelocity.scaleBy(1/deltaTime);\n\t\t} else\n\t\t\tinterpolatedRotation = this._targetEuler;\n\n\t\tfor (var i:number /*uint*/ = 0; i < len; i++) {\n\t\t\tvar k:number = (currentTime - data[i].startTime)/data[i].totalTime;\n\t\t\tvar t:number = (k - Math.floor(k))*data[i].totalTime;\n\t\t\tif (t - deltaTime <= 0) {\n\t\t\t\tvar inc:number /*int*/ = data[i].startVertexIndex*animationSubGeometry.totalLenOfOneVertex + this._particleFollowNode._iDataOffset;\n\n\t\t\t\tif (this._smooth) {\n\t\t\t\t\tthis._temp.copyFrom(rotationVelocity);\n\t\t\t\t\tthis._temp.scaleBy(t);\n\t\t\t\t\tinterpolatedRotation = this._targetEuler.add(this._temp);\n\t\t\t\t}\n\n\t\t\t\tif (vertexData[inc] != interpolatedRotation.x || vertexData[inc + 1] != interpolatedRotation.y || vertexData[inc + 2] != interpolatedRotation.z) {\n\t\t\t\t\tchanged = true;\n\t\t\t\t\tfor (var j:number /*uint*/ = 0; j < data[i].numVertices; j++) {\n\t\t\t\t\t\tvertexData[inc++] = interpolatedRotation.x;\n\t\t\t\t\t\tvertexData[inc++] = interpolatedRotation.y;\n\t\t\t\t\t\tvertexData[inc++] = interpolatedRotation.z;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (changed)\n\t\t\tanimationSubGeometry.invalidateBuffer();\n\n\t}\n\n\tprivate processPositionAndRotation(currentTime:number, deltaTime:number, animationSubGeometry:AnimationSubGeometry)\n\t{\n\t\tvar data:Array<ParticleAnimationData> = animationSubGeometry.animationParticles;\n\t\tvar vertexData:Array<number> = animationSubGeometry.vertexData;\n\n\t\tvar changed:boolean = false;\n\t\tvar len:number /*uint*/ = data.length;\n\n\t\tvar interpolatedPos:Vector3D;\n\t\tvar interpolatedRotation:Vector3D;\n\n\t\tvar posVelocity:Vector3D;\n\t\tvar rotationVelocity:Vector3D;\n\t\tif (this._smooth) {\n\t\t\tposVelocity = this._prePos.subtract(this._targetPos);\n\t\t\tposVelocity.scaleBy(1/deltaTime);\n\t\t\trotationVelocity = this._preEuler.subtract(this._targetEuler);\n\t\t\trotationVelocity.scaleBy(1/deltaTime);\n\t\t} else {\n\t\t\tinterpolatedPos = this._targetPos;\n\t\t\tinterpolatedRotation = this._targetEuler;\n\t\t}\n\n\t\tfor (var i:number /*uint*/ = 0; i < len; i++) {\n\t\t\tvar k:number = (currentTime - data[i].startTime)/data[i].totalTime;\n\t\t\tvar t:number = (k - Math.floor(k))*data[i].totalTime;\n\t\t\tif (t - deltaTime <= 0) {\n\t\t\t\tvar inc:number /*int*/ = data[i].startVertexIndex*animationSubGeometry.totalLenOfOneVertex + this._particleFollowNode._iDataOffset;\n\t\t\t\tif (this._smooth) {\n\t\t\t\t\tthis._temp.copyFrom(posVelocity);\n\t\t\t\t\tthis._temp.scaleBy(t);\n\t\t\t\t\tinterpolatedPos = this._targetPos.add(this._temp);\n\n\t\t\t\t\tthis._temp.copyFrom(rotationVelocity);\n\t\t\t\t\tthis._temp.scaleBy(t);\n\t\t\t\t\tinterpolatedRotation = this._targetEuler.add(this._temp);\n\t\t\t\t}\n\n\t\t\t\tif (vertexData[inc] != interpolatedPos.x || vertexData[inc + 1] != interpolatedPos.y || vertexData[inc + 2] != interpolatedPos.z || vertexData[inc + 3] != interpolatedRotation.x || vertexData[inc + 4] != interpolatedRotation.y || vertexData[inc + 5] != interpolatedRotation.z) {\n\t\t\t\t\tchanged = true;\n\t\t\t\t\tfor (var j:number /*uint*/ = 0; j < data[i].numVertices; j++) {\n\t\t\t\t\t\tvertexData[inc++] = interpolatedPos.x;\n\t\t\t\t\t\tvertexData[inc++] = interpolatedPos.y;\n\t\t\t\t\t\tvertexData[inc++] = interpolatedPos.z;\n\t\t\t\t\t\tvertexData[inc++] = interpolatedRotation.x;\n\t\t\t\t\t\tvertexData[inc++] = interpolatedRotation.y;\n\t\t\t\t\t\tvertexData[inc++] = interpolatedRotation.z;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (changed)\n\t\t\tanimationSubGeometry.invalidateBuffer();\n\t}\n\n}\n\nexport = ParticleFollowState;","import ColorTransform\t\t\t\t\t= require(\"awayjs-core/lib/geom/ColorTransform\");\nimport Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport Camera\t\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\n\nimport Stage\t\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\nimport ContextGLVertexBufferFormat\t\t= require(\"awayjs-stagegl/lib/base/ContextGLVertexBufferFormat\");\n\nimport ParticleAnimator\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/ParticleAnimator\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport AnimationSubGeometry\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationSubGeometry\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticleInitialColorNode\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleInitialColorNode\");\nimport ParticleStateBase\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleStateBase\");\nimport RenderableBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\n\n/**\n*\n*/\nclass ParticleInitialColorState extends ParticleStateBase\n{\n\t/** @private */\n\tpublic static MULTIPLIER_INDEX:number /*uint*/ = 0;\n\t/** @private */\n\tpublic static OFFSET_INDEX:number /*uint*/ = 1;\n\n\tprivate _particleInitialColorNode:ParticleInitialColorNode;\n\tprivate _usesMultiplier:boolean;\n\tprivate _usesOffset:boolean;\n\tprivate _initialColor:ColorTransform;\n\tprivate _multiplierData:Vector3D;\n\tprivate _offsetData:Vector3D;\n\n\tconstructor(animator:ParticleAnimator, particleInitialColorNode:ParticleInitialColorNode)\n\t{\n\t\tsuper(animator, particleInitialColorNode);\n\n\t\tthis._particleInitialColorNode = particleInitialColorNode;\n\t\tthis._usesMultiplier = particleInitialColorNode._iUsesMultiplier;\n\t\tthis._usesOffset = particleInitialColorNode._iUsesOffset;\n\t\tthis._initialColor = particleInitialColorNode._iInitialColor;\n\n\t\tthis.updateColorData();\n\t}\n\n\t/**\n\t * Defines the initial color transform of the state, when in global mode.\n\t */\n\tpublic get initialColor():ColorTransform\n\t{\n\t\treturn this._initialColor;\n\t}\n\n\tpublic set initialColor(value:ColorTransform)\n\t{\n\t\tthis._initialColor = value;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic setRenderState(stage:Stage, renderable:RenderableBase, animationSubGeometry:AnimationSubGeometry, animationRegisterCache:AnimationRegisterCache, camera:Camera)\n\t{\n\t\t// TODO: not used\n\t\trenderable = renderable;\n\t\tcamera = camera;\n\n\t\tif (animationRegisterCache.needFragmentAnimation) {\n\t\t\tif (this._particleInitialColorNode.mode == ParticlePropertiesMode.LOCAL_STATIC) {\n\t\t\t\tvar dataOffset:number /*uint*/ = this._particleInitialColorNode._iDataOffset;\n\t\t\t\tif (this._usesMultiplier) {\n\t\t\t\t\tanimationSubGeometry.activateVertexBuffer(animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleInitialColorState.MULTIPLIER_INDEX), dataOffset, stage, ContextGLVertexBufferFormat.FLOAT_4);\n\t\t\t\t\tdataOffset += 4;\n\t\t\t\t}\n\t\t\t\tif (this._usesOffset)\n\t\t\t\t\tanimationSubGeometry.activateVertexBuffer(animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleInitialColorState.OFFSET_INDEX), dataOffset, stage, ContextGLVertexBufferFormat.FLOAT_4);\n\t\t\t} else {\n\t\t\t\tif (this._usesMultiplier)\n\t\t\t\t\tanimationRegisterCache.setVertexConst(animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleInitialColorState.MULTIPLIER_INDEX), this._multiplierData.x, this._multiplierData.y, this._multiplierData.z, this._multiplierData.w);\n\t\t\t\tif (this._usesOffset)\n\t\t\t\t\tanimationRegisterCache.setVertexConst(animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleInitialColorState.OFFSET_INDEX), this._offsetData.x, this._offsetData.y, this._offsetData.z, this._offsetData.w);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate updateColorData()\n\t{\n\t\tif (this._particleInitialColorNode.mode == ParticlePropertiesMode.GLOBAL) {\n\t\t\tif (this._usesMultiplier)\n\t\t\t\tthis._multiplierData = new Vector3D(this._initialColor.redMultiplier, this._initialColor.greenMultiplier, this._initialColor.blueMultiplier, this._initialColor.alphaMultiplier);\n\t\t\tif (this._usesOffset)\n\t\t\t\tthis._offsetData = new Vector3D(this._initialColor.redOffset/255, this._initialColor.greenOffset/255, this._initialColor.blueOffset/255, this._initialColor.alphaOffset/255);\n\t\t}\n\t}\n\n}\n\nexport = ParticleInitialColorState;","import Matrix3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3D\");\nimport Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport Camera\t\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\n\nimport Stage\t\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\nimport ContextGLVertexBufferFormat\t\t= require(\"awayjs-stagegl/lib/base/ContextGLVertexBufferFormat\");\n\nimport ParticleAnimator\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/ParticleAnimator\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport AnimationSubGeometry\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationSubGeometry\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticleOrbitNode\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleOrbitNode\");\nimport ParticleStateBase\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleStateBase\");\nimport RenderableBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\n\n/**\n * ...\n */\nclass ParticleOrbitState extends ParticleStateBase\n{\n\t/** @private */\n\tpublic static ORBIT_INDEX:number /*uint*/ = 0;\n\n\t/** @private */\n\tpublic static EULERS_INDEX:number /*uint*/ = 1;\n\n\tprivate _particleOrbitNode:ParticleOrbitNode;\n\tprivate _usesEulers:boolean;\n\tprivate _usesCycle:boolean;\n\tprivate _usesPhase:boolean;\n\tprivate _radius:number;\n\tprivate _cycleDuration:number;\n\tprivate _cyclePhase:number;\n\tprivate _eulers:Vector3D;\n\tprivate _orbitData:Vector3D;\n\tprivate _eulersMatrix:Matrix3D;\n\n\t/**\n\t * Defines the radius of the orbit when in global mode. Defaults to 100.\n\t */\n\tpublic get radius():number\n\t{\n\t\treturn this._radius;\n\t}\n\n\tpublic set radius(value:number)\n\t{\n\t\tthis._radius = value;\n\n\t\tthis.updateOrbitData();\n\t}\n\n\t/**\n\t * Defines the duration of the orbit in seconds, used as a period independent of particle duration when in global mode. Defaults to 1.\n\t */\n\tpublic get cycleDuration():number\n\t{\n\t\treturn this._cycleDuration;\n\t}\n\n\tpublic set cycleDuration(value:number)\n\t{\n\t\tthis._cycleDuration = value;\n\n\t\tthis.updateOrbitData();\n\t}\n\n\t/**\n\t * Defines the phase of the orbit in degrees, used as the starting offset of the cycle when in global mode. Defaults to 0.\n\t */\n\tpublic get cyclePhase():number\n\t{\n\t\treturn this._cyclePhase;\n\t}\n\n\tpublic set cyclePhase(value:number)\n\t{\n\t\tthis._cyclePhase = value;\n\n\t\tthis.updateOrbitData();\n\t}\n\n\t/**\n\t * Defines the euler rotation in degrees, applied to the orientation of the orbit when in global mode.\n\t */\n\tpublic get eulers():Vector3D\n\t{\n\t\treturn this._eulers;\n\t}\n\n\tpublic set eulers(value:Vector3D)\n\t{\n\t\tthis._eulers = value;\n\n\t\tthis.updateOrbitData();\n\n\t}\n\n\tconstructor(animator:ParticleAnimator, particleOrbitNode:ParticleOrbitNode)\n\t{\n\t\tsuper(animator, particleOrbitNode);\n\n\t\tthis._particleOrbitNode = particleOrbitNode;\n\t\tthis._usesEulers = this._particleOrbitNode._iUsesEulers;\n\t\tthis._usesCycle = this._particleOrbitNode._iUsesCycle;\n\t\tthis._usesPhase = this._particleOrbitNode._iUsesPhase;\n\t\tthis._eulers = this._particleOrbitNode._iEulers;\n\t\tthis._radius = this._particleOrbitNode._iRadius;\n\t\tthis._cycleDuration = this._particleOrbitNode._iCycleDuration;\n\t\tthis._cyclePhase = this._particleOrbitNode._iCyclePhase;\n\t\tthis.updateOrbitData();\n\t}\n\n\tpublic setRenderState(stage:Stage, renderable:RenderableBase, animationSubGeometry:AnimationSubGeometry, animationRegisterCache:AnimationRegisterCache, camera:Camera)\n\t{\n\t\tvar index:number /*int*/ = animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleOrbitState.ORBIT_INDEX);\n\n\t\tif (this._particleOrbitNode.mode == ParticlePropertiesMode.LOCAL_STATIC) {\n\t\t\tif (this._usesPhase)\n\t\t\t\tanimationSubGeometry.activateVertexBuffer(index, this._particleOrbitNode._iDataOffset, stage, ContextGLVertexBufferFormat.FLOAT_4);\n\t\t\telse\n\t\t\t\tanimationSubGeometry.activateVertexBuffer(index, this._particleOrbitNode._iDataOffset, stage, ContextGLVertexBufferFormat.FLOAT_3);\n\t\t} else\n\t\t\tanimationRegisterCache.setVertexConst(index, this._orbitData.x, this._orbitData.y, this._orbitData.z, this._orbitData.w);\n\n\t\tif (this._usesEulers)\n\t\t\tanimationRegisterCache.setVertexConstFromMatrix(animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleOrbitState.EULERS_INDEX), this._eulersMatrix);\n\t}\n\n\tprivate updateOrbitData()\n\t{\n\t\tif (this._usesEulers) {\n\t\t\tthis._eulersMatrix = new Matrix3D();\n\t\t\tthis._eulersMatrix.appendRotation(this._eulers.x, Vector3D.X_AXIS);\n\t\t\tthis._eulersMatrix.appendRotation(this._eulers.y, Vector3D.Y_AXIS);\n\t\t\tthis._eulersMatrix.appendRotation(this._eulers.z, Vector3D.Z_AXIS);\n\t\t}\n\t\tif (this._particleOrbitNode.mode == ParticlePropertiesMode.GLOBAL) {\n\t\t\tthis._orbitData = new Vector3D(this._radius, 0, this._radius*Math.PI*2, this._cyclePhase*Math.PI/180);\n\t\t\tif (this._usesCycle) {\n\t\t\t\tif (this._cycleDuration <= 0)\n\t\t\t\t\tthrow(new Error(\"the cycle duration must be greater than zero\"));\n\t\t\t\tthis._orbitData.y = Math.PI*2/this._cycleDuration;\n\t\t\t} else\n\t\t\t\tthis._orbitData.y = Math.PI*2;\n\t\t}\n\t}\n}\n\nexport = ParticleOrbitState;","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport Camera\t\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\n\nimport Stage\t\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\nimport ContextGLVertexBufferFormat\t\t= require(\"awayjs-stagegl/lib/base/ContextGLVertexBufferFormat\");\n\nimport ParticleAnimator\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/ParticleAnimator\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport AnimationSubGeometry\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationSubGeometry\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticleOscillatorNode\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleOscillatorNode\");\nimport ParticleStateBase\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleStateBase\");\nimport RenderableBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\n\n/**\n * ...\n */\nclass ParticleOscillatorState extends ParticleStateBase\n{\n\t/** @private */\n\tpublic static OSCILLATOR_INDEX:number /*uint*/ = 0;\n\n\tprivate _particleOscillatorNode:ParticleOscillatorNode;\n\tprivate _oscillator:Vector3D;\n\tprivate _oscillatorData:Vector3D;\n\n\t/**\n\t * Defines the default oscillator axis (x, y, z) and cycleDuration (w) of the state, used when in global mode.\n\t */\n\tpublic get oscillator():Vector3D\n\t{\n\t\treturn this._oscillator;\n\t}\n\n\tpublic set oscillator(value:Vector3D)\n\t{\n\t\tthis._oscillator = value;\n\n\t\tthis.updateOscillatorData();\n\t}\n\n\tconstructor(animator:ParticleAnimator, particleOscillatorNode:ParticleOscillatorNode)\n\t{\n\t\tsuper(animator, particleOscillatorNode);\n\n\t\tthis._particleOscillatorNode = particleOscillatorNode;\n\t\tthis._oscillator = this._particleOscillatorNode._iOscillator;\n\n\t\tthis.updateOscillatorData();\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic setRenderState(stage:Stage, renderable:RenderableBase, animationSubGeometry:AnimationSubGeometry, animationRegisterCache:AnimationRegisterCache, camera:Camera)\n\t{\n\t\tvar index:number /*int*/ = animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleOscillatorState.OSCILLATOR_INDEX);\n\n\t\tif (this._particleOscillatorNode.mode == ParticlePropertiesMode.LOCAL_STATIC)\n\t\t\tanimationSubGeometry.activateVertexBuffer(index, this._particleOscillatorNode._iDataOffset, stage, ContextGLVertexBufferFormat.FLOAT_4);\n\t\telse\n\t\t\tanimationRegisterCache.setVertexConst(index, this._oscillatorData.x, this._oscillatorData.y, this._oscillatorData.z, this._oscillatorData.w);\n\t}\n\n\tprivate updateOscillatorData()\n\t{\n\t\tif (this._particleOscillatorNode.mode == ParticlePropertiesMode.GLOBAL) {\n\t\t\tif (this._oscillator.w <= 0)\n\t\t\t\tthrow(new Error(\"the cycle duration must greater than zero\"));\n\n\t\t\tif (this._oscillatorData == null)\n\t\t\t\tthis._oscillatorData = new Vector3D();\n\n\t\t\tthis._oscillatorData.x = this._oscillator.x;\n\t\t\tthis._oscillatorData.y = this._oscillator.y;\n\t\t\tthis._oscillatorData.z = this._oscillator.z;\n\t\t\tthis._oscillatorData.w = Math.PI*2/this._oscillator.w;\n\t\t}\n\t}\n}\n\nexport = ParticleOscillatorState;","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport Camera\t\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\n\nimport Stage\t\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\nimport ContextGLVertexBufferFormat\t\t= require(\"awayjs-stagegl/lib/base/ContextGLVertexBufferFormat\");\n\nimport ParticleAnimator\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/ParticleAnimator\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport AnimationSubGeometry\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationSubGeometry\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticlePositionNode\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticlePositionNode\");\nimport ParticleStateBase\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleStateBase\");\nimport RenderableBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\n\n/**\n * ...\n * @author ...\n */\nclass ParticlePositionState extends ParticleStateBase\n{\n\t/** @private */\n\tpublic static POSITION_INDEX:number /*uint*/ = 0;\n\n\tprivate _particlePositionNode:ParticlePositionNode;\n\tprivate _position:Vector3D;\n\n\t/**\n\t * Defines the position of the particle when in global mode. Defaults to 0,0,0.\n\t */\n\tpublic get position():Vector3D\n\t{\n\t\treturn this._position;\n\t}\n\n\tpublic set position(value:Vector3D)\n\t{\n\t\tthis._position = value;\n\t}\n\n\t/**\n\t *\n\t */\n\tpublic getPositions():Array<Vector3D>\n\t{\n\t\treturn this._pDynamicProperties;\n\t}\n\n\tpublic setPositions(value:Array<Vector3D>)\n\t{\n\t\tthis._pDynamicProperties = value;\n\n\t\tthis._pDynamicPropertiesDirty = new Object();\n\t}\n\n\tconstructor(animator:ParticleAnimator, particlePositionNode:ParticlePositionNode)\n\t{\n\t\tsuper(animator, particlePositionNode);\n\n\t\tthis._particlePositionNode = particlePositionNode;\n\t\tthis._position = this._particlePositionNode._iPosition;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic setRenderState(stage:Stage, renderable:RenderableBase, animationSubGeometry:AnimationSubGeometry, animationRegisterCache:AnimationRegisterCache, camera:Camera)\n\t{\n\t\tif (this._particlePositionNode.mode == ParticlePropertiesMode.LOCAL_DYNAMIC && !this._pDynamicPropertiesDirty[animationSubGeometry._iUniqueId])\n\t\t\tthis._pUpdateDynamicProperties(animationSubGeometry);\n\n\t\tvar index:number /*int*/ = animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticlePositionState.POSITION_INDEX);\n\n\t\tif (this._particlePositionNode.mode == ParticlePropertiesMode.GLOBAL)\n\t\t\tanimationRegisterCache.setVertexConst(index, this._position.x, this._position.y, this._position.z);\n\t\telse\n\t\t\tanimationSubGeometry.activateVertexBuffer(index, this._particlePositionNode._iDataOffset, stage, ContextGLVertexBufferFormat.FLOAT_3);\n\t}\n}\n\nexport = ParticlePositionState;","import Matrix3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3D\");\n\nimport Camera\t\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\n\nimport Stage\t\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\n\nimport ParticleAnimator\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/ParticleAnimator\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport AnimationSubGeometry\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationSubGeometry\");\nimport ParticleNodeBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleNodeBase\");\nimport ParticleRotateToHeadingNode\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleRotateToHeadingNode\");\nimport ParticleStateBase\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleStateBase\");\nimport RenderableBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\n\n/**\n * ...\n */\nclass ParticleRotateToHeadingState extends ParticleStateBase\n{\n\t/** @private */\n\tpublic static MATRIX_INDEX:number /*int*/ = 0;\n\n\tprivate _matrix:Matrix3D = new Matrix3D();\n\n\tconstructor(animator:ParticleAnimator, particleNode:ParticleNodeBase)\n\t{\n\t\tsuper(animator, particleNode);\n\t}\n\n\tpublic setRenderState(stage:Stage, renderable:RenderableBase, animationSubGeometry:AnimationSubGeometry, animationRegisterCache:AnimationRegisterCache, camera:Camera)\n\t{\n\t\tif (animationRegisterCache.hasBillboard) {\n\t\t\tthis._matrix.copyFrom(renderable.sourceEntity.sceneTransform);\n\t\t\tthis._matrix.append(camera.inverseSceneTransform);\n\t\t\tanimationRegisterCache.setVertexConstFromMatrix(animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleRotateToHeadingState.MATRIX_INDEX), this._matrix);\n\t\t}\n\t}\n\n}\n\nexport = ParticleRotateToHeadingState;","import Matrix3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3D\");\nimport Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport Camera\t\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\n\nimport Stage\t\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\nimport ContextGLVertexBufferFormat\t\t= require(\"awayjs-stagegl/lib/base/ContextGLVertexBufferFormat\");\n\nimport ParticleAnimator\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/ParticleAnimator\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport AnimationSubGeometry\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationSubGeometry\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticleRotateToPositionNode\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleRotateToPositionNode\");\nimport ParticleStateBase\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleStateBase\");\nimport RenderableBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\n\n/**\n * ...\n */\nclass ParticleRotateToPositionState extends ParticleStateBase\n{\n\t/** @private */\n\tpublic static MATRIX_INDEX:number /*int*/ = 0;\n\t/** @private */\n\tpublic static POSITION_INDEX:number /*int*/ = 1;\n\n\tprivate _particleRotateToPositionNode:ParticleRotateToPositionNode;\n\tprivate _position:Vector3D;\n\tprivate _matrix:Matrix3D = new Matrix3D();\n\tprivate _offset:Vector3D;\n\n\t/**\n\t * Defines the position of the point the particle will rotate to face when in global mode. Defaults to 0,0,0.\n\t */\n\tpublic get position():Vector3D\n\t{\n\t\treturn this._position;\n\t}\n\n\tpublic set position(value:Vector3D)\n\t{\n\t\tthis._position = value;\n\t}\n\n\tconstructor(animator:ParticleAnimator, particleRotateToPositionNode:ParticleRotateToPositionNode)\n\t{\n\t\tsuper(animator, particleRotateToPositionNode);\n\n\t\tthis._particleRotateToPositionNode = particleRotateToPositionNode;\n\t\tthis._position = this._particleRotateToPositionNode._iPosition;\n\t}\n\n\tpublic setRenderState(stage:Stage, renderable:RenderableBase, animationSubGeometry:AnimationSubGeometry, animationRegisterCache:AnimationRegisterCache, camera:Camera)\n\t{\n\t\tvar index:number /*int*/ = animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleRotateToPositionState.POSITION_INDEX);\n\n\t\tif (animationRegisterCache.hasBillboard) {\n\t\t\tthis._matrix.copyFrom(renderable.sourceEntity.sceneTransform);\n\t\t\tthis._matrix.append(camera.inverseSceneTransform);\n\t\t\tanimationRegisterCache.setVertexConstFromMatrix(animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleRotateToPositionState.MATRIX_INDEX), this._matrix);\n\t\t}\n\n\t\tif (this._particleRotateToPositionNode.mode == ParticlePropertiesMode.GLOBAL) {\n\t\t\tthis._offset = renderable.sourceEntity.inverseSceneTransform.transformVector(this._position);\n\t\t\tanimationRegisterCache.setVertexConst(index, this._offset.x, this._offset.y, this._offset.z);\n\t\t} else\n\t\t\tanimationSubGeometry.activateVertexBuffer(index, this._particleRotateToPositionNode._iDataOffset, stage, ContextGLVertexBufferFormat.FLOAT_3);\n\n\t}\n\n}\n\nexport = ParticleRotateToPositionState;","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport Camera\t\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\n\nimport Stage\t\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\nimport ContextGLVertexBufferFormat\t\t= require(\"awayjs-stagegl/lib/base/ContextGLVertexBufferFormat\");\n\nimport ParticleAnimator\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/ParticleAnimator\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport AnimationSubGeometry\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationSubGeometry\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticleRotationalVelocityNode\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleRotationalVelocityNode\");\nimport ParticleStateBase\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleStateBase\");\nimport RenderableBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\n\n/**\n * ...\n */\nclass ParticleRotationalVelocityState extends ParticleStateBase\n{\n\t/** @private */\n\tpublic static ROTATIONALVELOCITY_INDEX:number /*uint*/ = 0;\n\n\tprivate _particleRotationalVelocityNode:ParticleRotationalVelocityNode;\n\tprivate _rotationalVelocityData:Vector3D;\n\tprivate _rotationalVelocity:Vector3D;\n\n\t/**\n\t * Defines the default rotationalVelocity of the state, used when in global mode.\n\t */\n\tpublic get rotationalVelocity():Vector3D\n\t{\n\t\treturn this._rotationalVelocity;\n\t}\n\n\tpublic set rotationalVelocity(value:Vector3D)\n\t{\n\t\tthis._rotationalVelocity = value;\n\n\t\tthis.updateRotationalVelocityData();\n\t}\n\n\t/**\n\t *\n\t */\n\tpublic getRotationalVelocities():Array<Vector3D>\n\t{\n\t\treturn this._pDynamicProperties;\n\t}\n\n\tpublic setRotationalVelocities(value:Array<Vector3D>)\n\t{\n\t\tthis._pDynamicProperties = value;\n\n\t\tthis._pDynamicPropertiesDirty = new Object();\n\t}\n\n\tconstructor(animator:ParticleAnimator, particleRotationNode:ParticleRotationalVelocityNode)\n\t{\n\t\tsuper(animator, particleRotationNode);\n\n\t\tthis._particleRotationalVelocityNode = particleRotationNode;\n\t\tthis._rotationalVelocity = this._particleRotationalVelocityNode._iRotationalVelocity;\n\n\t\tthis.updateRotationalVelocityData();\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic setRenderState(stage:Stage, renderable:RenderableBase, animationSubGeometry:AnimationSubGeometry, animationRegisterCache:AnimationRegisterCache, camera:Camera)\n\t{\n\t\tif (this._particleRotationalVelocityNode.mode == ParticlePropertiesMode.LOCAL_DYNAMIC && !this._pDynamicPropertiesDirty[animationSubGeometry._iUniqueId])\n\t\t\tthis._pUpdateDynamicProperties(animationSubGeometry);\n\n\t\tvar index:number /*int*/ = animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleRotationalVelocityState.ROTATIONALVELOCITY_INDEX);\n\n\t\tif (this._particleRotationalVelocityNode.mode == ParticlePropertiesMode.GLOBAL)\n\t\t\tanimationRegisterCache.setVertexConst(index, this._rotationalVelocityData.x, this._rotationalVelocityData.y, this._rotationalVelocityData.z, this._rotationalVelocityData.w);\n\t\telse\n\t\t\tanimationSubGeometry.activateVertexBuffer(index, this._particleRotationalVelocityNode._iDataOffset, stage, ContextGLVertexBufferFormat.FLOAT_4);\n\t}\n\n\tprivate updateRotationalVelocityData()\n\t{\n\t\tif (this._particleRotationalVelocityNode.mode == ParticlePropertiesMode.GLOBAL) {\n\t\t\tif (this._rotationalVelocity.w <= 0)\n\t\t\t\tthrow(new Error(\"the cycle duration must greater than zero\"));\n\t\t\tvar rotation:Vector3D = this._rotationalVelocity.clone();\n\n\t\t\tif (rotation.length <= 0)\n\t\t\t\trotation.z = 1; //set the default direction\n\t\t\telse\n\t\t\t\trotation.normalize();\n\t\t\t// w is used as angle/2 in agal\n\t\t\tthis._rotationalVelocityData = new Vector3D(rotation.x, rotation.y, rotation.z, Math.PI/rotation.w);\n\t\t}\n\t}\n}\n\nexport = ParticleRotationalVelocityState;","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport Camera\t\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\n\nimport Stage\t\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\nimport ContextGLVertexBufferFormat\t\t= require(\"awayjs-stagegl/lib/base/ContextGLVertexBufferFormat\");\n\nimport ParticleAnimator\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/ParticleAnimator\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport AnimationSubGeometry\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationSubGeometry\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticleScaleNode\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleScaleNode\");\nimport ParticleStateBase\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleStateBase\");\nimport RenderableBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\n\n/**\n * ...\n */\nclass ParticleScaleState extends ParticleStateBase\n{\n\t/** @private */\n\tpublic static SCALE_INDEX:number /*uint*/ = 0;\n\n\tprivate _particleScaleNode:ParticleScaleNode;\n\tprivate _usesCycle:boolean;\n\tprivate _usesPhase:boolean;\n\tprivate _minScale:number;\n\tprivate _maxScale:number;\n\tprivate _cycleDuration:number;\n\tprivate _cyclePhase:number;\n\tprivate _scaleData:Vector3D;\n\n\t/**\n\t * Defines the end scale of the state, when in global mode. Defaults to 1.\n\t */\n\tpublic get minScale():number\n\t{\n\t\treturn this._minScale;\n\t}\n\n\tpublic set minScale(value:number)\n\t{\n\t\tthis._minScale = value;\n\n\t\tthis.updateScaleData();\n\t}\n\n\t/**\n\t * Defines the end scale of the state, when in global mode. Defaults to 1.\n\t */\n\tpublic get maxScale():number\n\t{\n\t\treturn this._maxScale;\n\t}\n\n\tpublic set maxScale(value:number)\n\t{\n\t\tthis._maxScale = value;\n\n\t\tthis.updateScaleData();\n\t}\n\n\t/**\n\t * Defines the duration of the animation in seconds, used as a period independent of particle duration when in global mode. Defaults to 1.\n\t */\n\tpublic get cycleDuration():number\n\t{\n\t\treturn this._cycleDuration;\n\t}\n\n\tpublic set cycleDuration(value:number)\n\t{\n\t\tthis._cycleDuration = value;\n\n\t\tthis.updateScaleData();\n\t}\n\n\t/**\n\t * Defines the phase of the cycle in degrees, used as the starting offset of the cycle when in global mode. Defaults to 0.\n\t */\n\tpublic get cyclePhase():number\n\t{\n\t\treturn this._cyclePhase;\n\t}\n\n\tpublic set cyclePhase(value:number)\n\t{\n\t\tthis._cyclePhase = value;\n\n\t\tthis.updateScaleData();\n\t}\n\n\tconstructor(animator:ParticleAnimator, particleScaleNode:ParticleScaleNode)\n\t{\n\t\tsuper(animator, particleScaleNode);\n\n\t\tthis._particleScaleNode = particleScaleNode;\n\t\tthis._usesCycle = this._particleScaleNode._iUsesCycle;\n\t\tthis._usesPhase = this._particleScaleNode._iUsesPhase;\n\t\tthis._minScale = this._particleScaleNode._iMinScale;\n\t\tthis._maxScale = this._particleScaleNode._iMaxScale;\n\t\tthis._cycleDuration = this._particleScaleNode._iCycleDuration;\n\t\tthis._cyclePhase = this._particleScaleNode._iCyclePhase;\n\n\t\tthis.updateScaleData();\n\t}\n\n\tpublic setRenderState(stage:Stage, renderable:RenderableBase, animationSubGeometry:AnimationSubGeometry, animationRegisterCache:AnimationRegisterCache, camera:Camera)\n\t{\n\t\tvar index:number /*int*/ = animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleScaleState.SCALE_INDEX);\n\n\t\tif (this._particleScaleNode.mode == ParticlePropertiesMode.LOCAL_STATIC) {\n\t\t\tif (this._usesCycle) {\n\t\t\t\tif (this._usesPhase)\n\t\t\t\t\tanimationSubGeometry.activateVertexBuffer(index, this._particleScaleNode._iDataOffset, stage, ContextGLVertexBufferFormat.FLOAT_4);\n\t\t\t\telse\n\t\t\t\t\tanimationSubGeometry.activateVertexBuffer(index, this._particleScaleNode._iDataOffset, stage, ContextGLVertexBufferFormat.FLOAT_3);\n\t\t\t} else\n\t\t\t\tanimationSubGeometry.activateVertexBuffer(index, this._particleScaleNode._iDataOffset, stage, ContextGLVertexBufferFormat.FLOAT_2);\n\t\t} else\n\t\t\tanimationRegisterCache.setVertexConst(index, this._scaleData.x, this._scaleData.y, this._scaleData.z, this._scaleData.w);\n\t}\n\n\tprivate updateScaleData()\n\t{\n\t\tif (this._particleScaleNode.mode == ParticlePropertiesMode.GLOBAL) {\n\t\t\tif (this._usesCycle) {\n\t\t\t\tif (this._cycleDuration <= 0)\n\t\t\t\t\tthrow(new Error(\"the cycle duration must be greater than zero\"));\n\t\t\t\tthis._scaleData = new Vector3D((this._minScale + this._maxScale)/2, Math.abs(this._minScale - this._maxScale)/2, Math.PI*2/this._cycleDuration, this._cyclePhase*Math.PI/180);\n\t\t\t} else\n\t\t\t\tthis._scaleData = new Vector3D(this._minScale, this._maxScale - this._minScale, 0, 0);\n\t\t}\n\t}\n}\n\nexport = ParticleScaleState;","import ColorTransform\t\t\t\t\t= require(\"awayjs-core/lib/geom/ColorTransform\");\nimport Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport Camera\t\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\n\nimport Stage\t\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\nimport ContextGLVertexBufferFormat\t\t= require(\"awayjs-stagegl/lib/base/ContextGLVertexBufferFormat\");\n\nimport ParticleAnimator\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/ParticleAnimator\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport AnimationSubGeometry\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationSubGeometry\");\nimport ColorSegmentPoint\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ColorSegmentPoint\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticleSegmentedColorNode\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleSegmentedColorNode\");\nimport ParticleStateBase\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleStateBase\");\nimport RenderableBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\n\n/**\n *\n */\nclass ParticleSegmentedColorState extends ParticleStateBase\n{\n\t/** @private */\n\tpublic static START_MULTIPLIER_INDEX:number /*uint*/ = 0;\n\n\t/** @private */\n\tpublic static START_OFFSET_INDEX:number /*uint*/ = 1;\n\n\t/** @private */\n\tpublic static TIME_DATA_INDEX:number /*uint*/ = 2;\n\n\tprivate _usesMultiplier:boolean;\n\tprivate _usesOffset:boolean;\n\tprivate _startColor:ColorTransform;\n\tprivate _endColor:ColorTransform;\n\tprivate _segmentPoints:Array<ColorSegmentPoint>;\n\tprivate _numSegmentPoint:number /*int*/;\n\n\tprivate _timeLifeData:Array<number>;\n\tprivate _multiplierData:Array<number>;\n\tprivate _offsetData:Array<number>;\n\n\t/**\n\t * Defines the start color transform of the state, when in global mode.\n\t */\n\tpublic get startColor():ColorTransform\n\t{\n\t\treturn this._startColor;\n\t}\n\n\tpublic set startColor(value:ColorTransform)\n\t{\n\t\tthis._startColor = value;\n\n\t\tthis.updateColorData();\n\t}\n\n\t/**\n\t * Defines the end color transform of the state, when in global mode.\n\t */\n\tpublic get endColor():ColorTransform\n\t{\n\t\treturn this._endColor;\n\t}\n\n\tpublic set endColor(value:ColorTransform)\n\t{\n\t\tthis._endColor = value;\n\t\tthis.updateColorData();\n\t}\n\n\t/**\n\t * Defines the number of segments.\n\t */\n\tpublic get numSegmentPoint():number /*int*/\n\t{\n\t\treturn this._numSegmentPoint;\n\t}\n\n\t/**\n\t * Defines the key points of color\n\t */\n\tpublic get segmentPoints():Array<ColorSegmentPoint>\n\t{\n\t\treturn this._segmentPoints;\n\t}\n\n\tpublic set segmentPoints(value:Array<ColorSegmentPoint>)\n\t{\n\t\tthis._segmentPoints = value;\n\t\tthis.updateColorData();\n\t}\n\n\tpublic get usesMultiplier():boolean\n\t{\n\t\treturn this._usesMultiplier;\n\t}\n\n\tpublic get usesOffset():boolean\n\t{\n\t\treturn this._usesOffset;\n\t}\n\n\tconstructor(animator:ParticleAnimator, particleSegmentedColorNode:ParticleSegmentedColorNode)\n\t{\n\t\tsuper(animator, particleSegmentedColorNode);\n\n\t\tthis._usesMultiplier = particleSegmentedColorNode._iUsesMultiplier;\n\t\tthis._usesOffset = particleSegmentedColorNode._iUsesOffset;\n\t\tthis._startColor = particleSegmentedColorNode._iStartColor;\n\t\tthis._endColor = particleSegmentedColorNode._iEndColor;\n\t\tthis._segmentPoints = particleSegmentedColorNode._iSegmentPoints;\n\t\tthis._numSegmentPoint = particleSegmentedColorNode._iNumSegmentPoint;\n\t\tthis.updateColorData();\n\t}\n\n\tpublic setRenderState(stage:Stage, renderable:RenderableBase, animationSubGeometry:AnimationSubGeometry, animationRegisterCache:AnimationRegisterCache, camera:Camera)\n\t{\n\t\tif (animationRegisterCache.needFragmentAnimation) {\n\t\t\tif (this._numSegmentPoint > 0)\n\t\t\t\tanimationRegisterCache.setVertexConst(animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleSegmentedColorState.TIME_DATA_INDEX), this._timeLifeData[0], this._timeLifeData[1], this._timeLifeData[2], this._timeLifeData[3]);\n\t\t\tif (this._usesMultiplier)\n\t\t\t\tanimationRegisterCache.setVertexConstFromArray(animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleSegmentedColorState.START_MULTIPLIER_INDEX), this._multiplierData);\n\t\t\tif (this._usesOffset)\n\t\t\t\tanimationRegisterCache.setVertexConstFromArray(animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleSegmentedColorState.START_OFFSET_INDEX), this._offsetData);\n\t\t}\n\t}\n\n\tprivate updateColorData()\n\t{\n\t\tthis._timeLifeData = new Array<number>();\n\t\tthis._multiplierData = new Array<number>();\n\t\tthis._offsetData = new Array<number>();\n\t\tvar i:number /*int*/;\n\t\tfor (i = 0; i < this._numSegmentPoint; i++) {\n\t\t\tif (i == 0)\n\t\t\t\tthis._timeLifeData.push(this._segmentPoints[i].life);\n\t\t\telse\n\t\t\t\tthis._timeLifeData.push(this._segmentPoints[i].life - this._segmentPoints[i - 1].life);\n\t\t}\n\t\tif (this._numSegmentPoint == 0)\n\t\t\tthis._timeLifeData.push(1);\n\t\telse\n\t\t\tthis._timeLifeData.push(1 - this._segmentPoints[i - 1].life);\n\n\t\tif (this._usesMultiplier) {\n\t\t\tthis._multiplierData.push(this._startColor.redMultiplier, this._startColor.greenMultiplier, this._startColor.blueMultiplier, this._startColor.alphaMultiplier);\n\t\t\tfor (i = 0; i < this._numSegmentPoint; i++) {\n\t\t\t\tif (i == 0)\n\t\t\t\t\tthis._multiplierData.push((this._segmentPoints[i].color.redMultiplier - this._startColor.redMultiplier)/this._timeLifeData[i], (this._segmentPoints[i].color.greenMultiplier - this._startColor.greenMultiplier)/this._timeLifeData[i], (this._segmentPoints[i].color.blueMultiplier - this._startColor.blueMultiplier)/this._timeLifeData[i], (this._segmentPoints[i].color.alphaMultiplier - this._startColor.alphaMultiplier)/this._timeLifeData[i]);\n\t\t\t\telse\n\t\t\t\t\tthis._multiplierData.push((this._segmentPoints[i].color.redMultiplier - this._segmentPoints[i - 1].color.redMultiplier)/this._timeLifeData[i], (this._segmentPoints[i].color.greenMultiplier - this._segmentPoints[i - 1].color.greenMultiplier)/this._timeLifeData[i], (this._segmentPoints[i].color.blueMultiplier - this._segmentPoints[i - 1].color.blueMultiplier)/this._timeLifeData[i], (this._segmentPoints[i].color.alphaMultiplier - this._segmentPoints[i - 1].color.alphaMultiplier)/this._timeLifeData[i]);\n\t\t\t}\n\t\t\tif (this._numSegmentPoint == 0)\n\t\t\t\tthis._multiplierData.push(this._endColor.redMultiplier - this._startColor.redMultiplier, this._endColor.greenMultiplier - this._startColor.greenMultiplier, this._endColor.blueMultiplier - this._startColor.blueMultiplier, this._endColor.alphaMultiplier - this._startColor.alphaMultiplier);\n\t\t\telse\n\t\t\t\tthis._multiplierData.push((this._endColor.redMultiplier - this._segmentPoints[i - 1].color.redMultiplier)/this._timeLifeData[i], (this._endColor.greenMultiplier - this._segmentPoints[i - 1].color.greenMultiplier)/this._timeLifeData[i], (this._endColor.blueMultiplier - this._segmentPoints[i - 1].color.blueMultiplier)/this._timeLifeData[i], (this._endColor.alphaMultiplier - this._segmentPoints[i - 1].color.alphaMultiplier)/this._timeLifeData[i]);\n\t\t}\n\n\t\tif (this._usesOffset) {\n\t\t\tthis._offsetData.push(this._startColor.redOffset/255, this._startColor.greenOffset/255, this._startColor.blueOffset/255, this._startColor.alphaOffset/255);\n\t\t\tfor (i = 0; i < this._numSegmentPoint; i++) {\n\t\t\t\tif (i == 0)\n\t\t\t\t\tthis._offsetData.push((this._segmentPoints[i].color.redOffset - this._startColor.redOffset)/this._timeLifeData[i]/255, (this._segmentPoints[i].color.greenOffset - this._startColor.greenOffset)/this._timeLifeData[i]/255, (this._segmentPoints[i].color.blueOffset - this._startColor.blueOffset)/this._timeLifeData[i]/255, (this._segmentPoints[i].color.alphaOffset - this._startColor.alphaOffset)/this._timeLifeData[i]/255);\n\t\t\t\telse\n\t\t\t\t\tthis._offsetData.push((this._segmentPoints[i].color.redOffset - this._segmentPoints[i - 1].color.redOffset)/this._timeLifeData[i]/255, (this._segmentPoints[i].color.greenOffset - this._segmentPoints[i - 1].color.greenOffset)/this._timeLifeData[i]/255, (this._segmentPoints[i].color.blueOffset - this._segmentPoints[i - 1].color.blueOffset)/this._timeLifeData[i]/255, (this._segmentPoints[i].color.alphaOffset - this._segmentPoints[i - 1].color.alphaOffset)/this._timeLifeData[i]/255);\n\t\t\t}\n\t\t\tif (this._numSegmentPoint == 0)\n\t\t\t\tthis._offsetData.push((this._endColor.redOffset - this._startColor.redOffset)/255, (this._endColor.greenOffset - this._startColor.greenOffset)/255, (this._endColor.blueOffset - this._startColor.blueOffset)/255, (this._endColor.alphaOffset - this._startColor.alphaOffset)/255);\n\t\t\telse\n\t\t\t\tthis._offsetData.push((this._endColor.redOffset - this._segmentPoints[i - 1].color.redOffset)/this._timeLifeData[i]/255, (this._endColor.greenOffset - this._segmentPoints[i - 1].color.greenOffset)/this._timeLifeData[i]/255, (this._endColor.blueOffset - this._segmentPoints[i - 1].color.blueOffset)/this._timeLifeData[i]/255, (this._endColor.alphaOffset - this._segmentPoints[i - 1].color.alphaOffset)/this._timeLifeData[i]/255);\n\t\t}\n\t\t//cut off the data\n\t\tthis._timeLifeData.length = 4;\n\t}\n}\n\nexport = ParticleSegmentedColorState;","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport Camera\t\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\n\nimport Stage\t\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\nimport ContextGLVertexBufferFormat\t\t= require(\"awayjs-stagegl/lib/base/ContextGLVertexBufferFormat\");\n\nimport ParticleAnimator\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/ParticleAnimator\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport AnimationSubGeometry\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationSubGeometry\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticleSpriteSheetNode\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleSpriteSheetNode\");\nimport ParticleStateBase\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleStateBase\");\nimport RenderableBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\n\n/**\n * ...\n */\nclass ParticleSpriteSheetState extends ParticleStateBase\n{\n\t/** @private */\n\tpublic static UV_INDEX_0:number /*uint*/ = 0;\n\n\t/** @private */\n\tpublic static UV_INDEX_1:number /*uint*/ = 1;\n\n\tprivate _particleSpriteSheetNode:ParticleSpriteSheetNode;\n\tprivate _usesCycle:boolean;\n\tprivate _usesPhase:boolean;\n\tprivate _totalFrames:number /*int*/;\n\tprivate _numColumns:number /*int*/;\n\tprivate _numRows:number /*int*/;\n\tprivate _cycleDuration:number;\n\tprivate _cyclePhase:number;\n\tprivate _spriteSheetData:Array<number>;\n\n\t/**\n\t * Defines the cycle phase, when in global mode. Defaults to zero.\n\t */\n\tpublic get cyclePhase():number\n\t{\n\t\treturn this._cyclePhase;\n\t}\n\n\tpublic set cyclePhase(value:number)\n\t{\n\t\tthis._cyclePhase = value;\n\n\t\tthis.updateSpriteSheetData();\n\t}\n\n\t/**\n\t * Defines the cycle duration in seconds, when in global mode. Defaults to 1.\n\t */\n\tpublic get cycleDuration():number\n\t{\n\t\treturn this._cycleDuration;\n\t}\n\n\tpublic set cycleDuration(value:number)\n\t{\n\t\tthis._cycleDuration = value;\n\n\t\tthis.updateSpriteSheetData();\n\t}\n\n\tconstructor(animator:ParticleAnimator, particleSpriteSheetNode:ParticleSpriteSheetNode)\n\t{\n\t\tsuper(animator, particleSpriteSheetNode);\n\n\t\tthis._particleSpriteSheetNode = particleSpriteSheetNode;\n\n\t\tthis._usesCycle = this._particleSpriteSheetNode._iUsesCycle;\n\t\tthis._usesPhase = this._particleSpriteSheetNode._iUsesCycle;\n\t\tthis._totalFrames = this._particleSpriteSheetNode._iTotalFrames;\n\t\tthis._numColumns = this._particleSpriteSheetNode._iNumColumns;\n\t\tthis._numRows = this._particleSpriteSheetNode._iNumRows;\n\t\tthis._cycleDuration = this._particleSpriteSheetNode._iCycleDuration;\n\t\tthis._cyclePhase = this._particleSpriteSheetNode._iCyclePhase;\n\n\t\tthis.updateSpriteSheetData();\n\t}\n\n\tpublic setRenderState(stage:Stage, renderable:RenderableBase, animationSubGeometry:AnimationSubGeometry, animationRegisterCache:AnimationRegisterCache, camera:Camera)\n\t{\n\t\tif (animationRegisterCache.needUVAnimation) {\n\t\t\tanimationRegisterCache.setVertexConst(animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleSpriteSheetState.UV_INDEX_0), this._spriteSheetData[0], this._spriteSheetData[1], this._spriteSheetData[2], this._spriteSheetData[3]);\n\t\t\tif (this._usesCycle) {\n\t\t\t\tvar index:number /*int*/ = animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleSpriteSheetState.UV_INDEX_1);\n\t\t\t\tif (this._particleSpriteSheetNode.mode == ParticlePropertiesMode.LOCAL_STATIC) {\n\t\t\t\t\tif (this._usesPhase)\n\t\t\t\t\t\tanimationSubGeometry.activateVertexBuffer(index, this._particleSpriteSheetNode._iDataOffset, stage, ContextGLVertexBufferFormat.FLOAT_3);\n\t\t\t\t\telse\n\t\t\t\t\t\tanimationSubGeometry.activateVertexBuffer(index, this._particleSpriteSheetNode._iDataOffset, stage, ContextGLVertexBufferFormat.FLOAT_2);\n\t\t\t\t} else\n\t\t\t\t\tanimationRegisterCache.setVertexConst(index, this._spriteSheetData[4], this._spriteSheetData[5]);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate updateSpriteSheetData()\n\t{\n\t\tthis._spriteSheetData = new Array<number>(8);\n\n\t\tvar uTotal:number = this._totalFrames/this._numColumns;\n\n\t\tthis._spriteSheetData[0] = uTotal;\n\t\tthis._spriteSheetData[1] = 1/this._numColumns;\n\t\tthis._spriteSheetData[2] = 1/this._numRows;\n\n\t\tif (this._usesCycle) {\n\t\t\tif (this._cycleDuration <= 0)\n\t\t\t\tthrow(new Error(\"the cycle duration must be greater than zero\"));\n\t\t\tthis._spriteSheetData[4] = uTotal/this._cycleDuration;\n\t\t\tthis._spriteSheetData[5] = this._cycleDuration;\n\t\t\tif (this._usesPhase)\n\t\t\t\tthis._spriteSheetData[6] = this._cyclePhase;\n\t\t}\n\t}\n}\n\nexport = ParticleSpriteSheetState;","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport Camera\t\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\n\nimport Stage\t\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\n\nimport ParticleAnimator\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/ParticleAnimator\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport AnimationSubGeometry\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationSubGeometry\");\nimport ParticleAnimationData\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticleAnimationData\");\nimport ParticleNodeBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleNodeBase\");\nimport AnimationStateBase\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/AnimationStateBase\");\nimport RenderableBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\n\n/**\n * ...\n */\nclass ParticleStateBase extends AnimationStateBase\n{\n\tprivate _particleNode:ParticleNodeBase;\n\n\tpublic _pDynamicProperties:Array<Vector3D> = new Array<Vector3D>();\n\tpublic _pDynamicPropertiesDirty:Object = new Object();\n\n\tpublic _pNeedUpdateTime:boolean;\n\n\tconstructor(animator:ParticleAnimator, particleNode:ParticleNodeBase, needUpdateTime:boolean = false)\n\t{\n\t\tsuper(animator, particleNode);\n\n\t\tthis._particleNode = particleNode;\n\t\tthis._pNeedUpdateTime = needUpdateTime;\n\t}\n\n\tpublic get needUpdateTime():boolean\n\t{\n\t\treturn this._pNeedUpdateTime;\n\t}\n\n\tpublic setRenderState(stage:Stage, renderable:RenderableBase, animationSubGeometry:AnimationSubGeometry, animationRegisterCache:AnimationRegisterCache, camera:Camera)\n\t{\n\n\t}\n\n\tpublic _pUpdateDynamicProperties(animationSubGeometry:AnimationSubGeometry)\n\t{\n\t\tthis._pDynamicPropertiesDirty[animationSubGeometry._iUniqueId] = true;\n\n\t\tvar animationParticles:Array<ParticleAnimationData> = animationSubGeometry.animationParticles;\n\t\tvar vertexData:Array<number> = animationSubGeometry.vertexData;\n\t\tvar totalLenOfOneVertex:number /*uint*/ = animationSubGeometry.totalLenOfOneVertex;\n\t\tvar dataLength:number /*uint*/ = this._particleNode.dataLength;\n\t\tvar dataOffset:number /*uint*/ = this._particleNode._iDataOffset;\n\t\tvar vertexLength:number /*uint*/;\n\t\t//\t\t\tvar particleOffset:number /*uint*/;\n\t\tvar startingOffset:number /*uint*/;\n\t\tvar vertexOffset:number /*uint*/;\n\t\tvar data:Vector3D;\n\t\tvar animationParticle:ParticleAnimationData;\n\n\t\t//\t\t\tvar numParticles:number /*uint*/ = _positions.length/dataLength;\n\t\tvar numParticles:number /*uint*/ = this._pDynamicProperties.length;\n\t\tvar i:number /*uint*/ = 0;\n\t\tvar j:number /*uint*/ = 0;\n\t\tvar k:number /*uint*/ = 0;\n\n\t\t//loop through all particles\n\t\twhile (i < numParticles) {\n\t\t\t//loop through each particle data for the current particle\n\t\t\twhile (j < numParticles && (animationParticle = animationParticles[j]).index == i) {\n\t\t\t\tdata = this._pDynamicProperties[i];\n\t\t\t\tvertexLength = animationParticle.numVertices*totalLenOfOneVertex;\n\t\t\t\tstartingOffset = animationParticle.startVertexIndex*totalLenOfOneVertex + dataOffset;\n\t\t\t\t//loop through each vertex in the particle data\n\t\t\t\tfor (k = 0; k < vertexLength; k += totalLenOfOneVertex) {\n\t\t\t\t\tvertexOffset = startingOffset + k;\n\t\t\t\t\t//\t\t\t\t\t\tparticleOffset = i * dataLength;\n\t\t\t\t\t//loop through all vertex data for the current particle data\n\t\t\t\t\tfor (k = 0; k < vertexLength; k += totalLenOfOneVertex) {\n\t\t\t\t\t\tvertexOffset = startingOffset + k;\n\t\t\t\t\t\tvertexData[vertexOffset++] = data.x;\n\t\t\t\t\t\tvertexData[vertexOffset++] = data.y;\n\t\t\t\t\t\tvertexData[vertexOffset++] = data.z;\n\n\t\t\t\t\t\tif (dataLength == 4)\n\t\t\t\t\t\t\tvertexData[vertexOffset++] = data.w;\n\t\t\t\t\t}\n\t\t\t\t\t\t//loop through each value in the particle vertex\n\t\t\t\t\t\t//\t\t\t\t\t\tswitch(dataLength) {\n\t\t\t\t\t\t//\t\t\t\t\t\t\tcase 4:\n\t\t\t\t\t\t//\t\t\t\t\t\t\t\tvertexData[vertexOffset++] = _positions[particleOffset++];\n\t\t\t\t\t\t//\t\t\t\t\t\t\tcase 3:\n\t\t\t\t\t\t//\t\t\t\t\t\t\t\tvertexData[vertexOffset++] = _positions[particleOffset++];\n\t\t\t\t\t\t//\t\t\t\t\t\t\tcase 2:\n\t\t\t\t\t\t//\t\t\t\t\t\t\t\tvertexData[vertexOffset++] = _positions[particleOffset++];\n\t\t\t\t\t\t//\t\t\t\t\t\t\tcase 1:\n\t\t\t\t\t\t//\t\t\t\t\t\t\t\tvertexData[vertexOffset++] = _positions[particleOffset++];\n\t\t\t\t\t\t//\t\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tj++;\n\t\t\t}\n\t\t\ti++;\n\t\t}\n\n\t\tanimationSubGeometry.invalidateBuffer();\n\t}\n\n}\n\nexport = ParticleStateBase;","import Camera\t\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\n\nimport Stage\t\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\nimport ContextGLVertexBufferFormat\t\t= require(\"awayjs-stagegl/lib/base/ContextGLVertexBufferFormat\");\n\nimport ParticleAnimator\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/ParticleAnimator\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport AnimationSubGeometry\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationSubGeometry\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticleTimeNode\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleTimeNode\");\nimport ParticleStateBase\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleStateBase\");\nimport RenderableBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\n\n/**\n * ...\n */\nclass ParticleTimeState extends ParticleStateBase\n{\n\t/** @private */\n\tpublic static TIME_STREAM_INDEX:number /*uint*/ = 0;\n\n\t/** @private */\n\tpublic static TIME_CONSTANT_INDEX:number /*uint*/ = 1;\n\n\tprivate _particleTimeNode:ParticleTimeNode;\n\n\tconstructor(animator:ParticleAnimator, particleTimeNode:ParticleTimeNode)\n\t{\n\t\tsuper(animator, particleTimeNode, true);\n\n\t\tthis._particleTimeNode = particleTimeNode;\n\t}\n\n\tpublic setRenderState(stage:Stage, renderable:RenderableBase, animationSubGeometry:AnimationSubGeometry, animationRegisterCache:AnimationRegisterCache, camera:Camera)\n\t{\n\t\tanimationSubGeometry.activateVertexBuffer(animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleTimeState.TIME_STREAM_INDEX), this._particleTimeNode._iDataOffset, stage, ContextGLVertexBufferFormat.FLOAT_4);\n\n\t\tvar particleTime:number = this._pTime/1000;\n\t\tanimationRegisterCache.setVertexConst(animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleTimeState.TIME_CONSTANT_INDEX), particleTime, particleTime, particleTime, particleTime);\n\t}\n\n}\n\nexport = ParticleTimeState;","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport Camera\t\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\n\nimport Stage\t\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\n\nimport ParticleAnimator\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/ParticleAnimator\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport AnimationSubGeometry\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationSubGeometry\");\nimport ParticleUVNode\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleUVNode\");\nimport ParticleStateBase\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleStateBase\");\nimport RenderableBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\n\n/**\n * ...\n */\nclass ParticleUVState extends ParticleStateBase\n{\n\t/** @private */\n\tpublic static UV_INDEX:number /*uint*/ = 0;\n\n\tprivate _particleUVNode:ParticleUVNode;\n\n\tconstructor(animator:ParticleAnimator, particleUVNode:ParticleUVNode)\n\t{\n\t\tsuper(animator, particleUVNode);\n\n\t\tthis._particleUVNode = particleUVNode;\n\t}\n\n\tpublic setRenderState(stage:Stage, renderable:RenderableBase, animationSubGeometry:AnimationSubGeometry, animationRegisterCache:AnimationRegisterCache, camera:Camera)\n\t{\n\t\tif (animationRegisterCache.needUVAnimation) {\n\t\t\tvar index:number /*int*/ = animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleUVState.UV_INDEX);\n\t\t\tvar data:Vector3D = this._particleUVNode._iUvData;\n\t\t\tanimationRegisterCache.setVertexConst(index, data.x, data.y);\n\t\t}\n\t}\n\n}\n\nexport = ParticleUVState;","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport Camera\t\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\n\nimport Stage\t\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\nimport ContextGLVertexBufferFormat\t\t= require(\"awayjs-stagegl/lib/base/ContextGLVertexBufferFormat\");\n\nimport ParticleAnimator\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/ParticleAnimator\");\nimport AnimationRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport AnimationSubGeometry\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationSubGeometry\");\nimport ParticlePropertiesMode\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticlePropertiesMode\");\nimport ParticleVelocityNode\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/ParticleVelocityNode\");\nimport ParticleStateBase\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ParticleStateBase\");\nimport RenderableBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\n\n/**\n * ...\n */\nclass ParticleVelocityState extends ParticleStateBase\n{\n\t/** @private */\n\tpublic static VELOCITY_INDEX:number /*int*/ = 0;\n\n\tprivate _particleVelocityNode:ParticleVelocityNode;\n\tprivate _velocity:Vector3D;\n\n\t/**\n\t * Defines the default velocity vector of the state, used when in global mode.\n\t */\n\tpublic get velocity():Vector3D\n\t{\n\t\treturn this._velocity;\n\t}\n\n\tpublic set velocity(value:Vector3D)\n\t{\n\t\tthis._velocity = value;\n\t}\n\n\t/**\n\t *\n\t */\n\tpublic getVelocities():Array<Vector3D>\n\t{\n\t\treturn this._pDynamicProperties;\n\t}\n\n\tpublic setVelocities(value:Array<Vector3D>)\n\t{\n\t\tthis._pDynamicProperties = value;\n\n\t\tthis._pDynamicPropertiesDirty = new Object();\n\t}\n\n\tconstructor(animator:ParticleAnimator, particleVelocityNode:ParticleVelocityNode)\n\t{\n\t\tsuper(animator, particleVelocityNode);\n\n\t\tthis._particleVelocityNode = particleVelocityNode;\n\t\tthis._velocity = this._particleVelocityNode._iVelocity;\n\t}\n\n\tpublic setRenderState(stage:Stage, renderable:RenderableBase, animationSubGeometry:AnimationSubGeometry, animationRegisterCache:AnimationRegisterCache, camera:Camera)\n\t{\n\t\tif (this._particleVelocityNode.mode == ParticlePropertiesMode.LOCAL_DYNAMIC && !this._pDynamicPropertiesDirty[animationSubGeometry._iUniqueId])\n\t\t\tthis._pUpdateDynamicProperties(animationSubGeometry);\n\n\t\tvar index:number /*int*/ = animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleVelocityState.VELOCITY_INDEX);\n\n\t\tif (this._particleVelocityNode.mode == ParticlePropertiesMode.GLOBAL)\n\t\t\tanimationRegisterCache.setVertexConst(index, this._velocity.x, this._velocity.y, this._velocity.z);\n\t\telse\n\t\t\tanimationSubGeometry.activateVertexBuffer(index, this._particleVelocityNode._iDataOffset, stage, ContextGLVertexBufferFormat.FLOAT_3);\n\t}\n}\n\nexport = ParticleVelocityState;","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport JointPose\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/JointPose\");\nimport Skeleton\t\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/Skeleton\");\nimport SkeletonPose\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/SkeletonPose\");\nimport SkeletonBinaryLERPNode\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/SkeletonBinaryLERPNode\");\nimport AnimationStateBase\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/AnimationStateBase\");\nimport ISkeletonAnimationState\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ISkeletonAnimationState\");\n\n/**\n *\n */\nclass SkeletonBinaryLERPState extends AnimationStateBase implements ISkeletonAnimationState\n{\n\tprivate _blendWeight:number = 0;\n\tprivate _skeletonAnimationNode:SkeletonBinaryLERPNode;\n\tprivate _skeletonPose:SkeletonPose = new SkeletonPose();\n\tprivate _skeletonPoseDirty:boolean = true;\n\tprivate _inputA:ISkeletonAnimationState;\n\tprivate _inputB:ISkeletonAnimationState;\n\n\t/**\n\t * Defines a fractional value between 0 and 1 representing the blending ratio between inputA (0) and inputB (1),\n\t * used to produce the skeleton pose output.\n\t *\n\t * @see inputA\n\t * @see inputB\n\t */\n\tpublic get blendWeight():number\n\t{\n\t\treturn this._blendWeight;\n\t}\n\n\tpublic set blendWeight(value:number)\n\t{\n\t\tthis._blendWeight = value;\n\n\t\tthis._pPositionDeltaDirty = true;\n\t\tthis._skeletonPoseDirty = true;\n\t}\n\n\tconstructor(animator:AnimatorBase, skeletonAnimationNode:SkeletonBinaryLERPNode)\n\t{\n\t\tsuper(animator, skeletonAnimationNode);\n\n\t\tthis._skeletonAnimationNode = skeletonAnimationNode;\n\n\t\tthis._inputA = <ISkeletonAnimationState> animator.getAnimationState(this._skeletonAnimationNode.inputA);\n\t\tthis._inputB = <ISkeletonAnimationState> animator.getAnimationState(this._skeletonAnimationNode.inputB);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic phase(value:number)\n\t{\n\t\tthis._skeletonPoseDirty = true;\n\n\t\tthis._pPositionDeltaDirty = true;\n\n\t\tthis._inputA.phase(value);\n\t\tthis._inputB.phase(value);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _pUpdateTime(time:number /*int*/)\n\t{\n\t\tthis._skeletonPoseDirty = true;\n\n\t\tthis._inputA.update(time);\n\t\tthis._inputB.update(time);\n\n\t\tsuper._pUpdateTime(time);\n\t}\n\n\t/**\n\t * Returns the current skeleton pose of the animation in the clip based on the internal playhead position.\n\t */\n\tpublic getSkeletonPose(skeleton:Skeleton):SkeletonPose\n\t{\n\t\tif (this._skeletonPoseDirty)\n\t\t\tthis.updateSkeletonPose(skeleton);\n\n\t\treturn this._skeletonPose;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _pUpdatePositionDelta()\n\t{\n\t\tthis._pPositionDeltaDirty = false;\n\n\t\tvar deltA:Vector3D = this._inputA.positionDelta;\n\t\tvar deltB:Vector3D = this._inputB.positionDelta;\n\n\t\tthis._pRootDelta.x = deltA.x + this._blendWeight*(deltB.x - deltA.x);\n\t\tthis._pRootDelta.y = deltA.y + this._blendWeight*(deltB.y - deltA.y);\n\t\tthis._pRootDelta.z = deltA.z + this._blendWeight*(deltB.z - deltA.z);\n\t}\n\n\t/**\n\t * Updates the output skeleton pose of the node based on the blendWeight value between input nodes.\n\t *\n\t * @param skeleton The skeleton used by the animator requesting the ouput pose.\n\t */\n\tprivate updateSkeletonPose(skeleton:Skeleton)\n\t{\n\t\tthis._skeletonPoseDirty = false;\n\n\t\tvar endPose:JointPose;\n\t\tvar endPoses:Array<JointPose> = this._skeletonPose.jointPoses;\n\t\tvar poses1:Array<JointPose> = this._inputA.getSkeletonPose(skeleton).jointPoses;\n\t\tvar poses2:Array<JointPose> = this._inputB.getSkeletonPose(skeleton).jointPoses;\n\t\tvar pose1:JointPose, pose2:JointPose;\n\t\tvar p1:Vector3D, p2:Vector3D;\n\t\tvar tr:Vector3D;\n\t\tvar numJoints:number /*uint*/ = skeleton.numJoints;\n\n\t\t// :s\n\t\tif (endPoses.length != numJoints)\n\t\t\tendPoses.length = numJoints;\n\n\t\tfor (var i:number /*uint*/ = 0; i < numJoints; ++i) {\n\t\t\tendPose = endPoses[i];\n\n\t\t\tif (endPose == null)\n\t\t\t\tendPose = endPoses[i] = new JointPose();\n\n\t\t\tpose1 = poses1[i];\n\t\t\tpose2 = poses2[i];\n\t\t\tp1 = pose1.translation;\n\t\t\tp2 = pose2.translation;\n\n\t\t\tendPose.orientation.lerp(pose1.orientation, pose2.orientation, this._blendWeight);\n\n\t\t\ttr = endPose.translation;\n\t\t\ttr.x = p1.x + this._blendWeight*(p2.x - p1.x);\n\t\t\ttr.y = p1.y + this._blendWeight*(p2.y - p1.y);\n\t\t\ttr.z = p1.z + this._blendWeight*(p2.z - p1.z);\n\t\t}\n\t}\n}\n\nexport = SkeletonBinaryLERPState;","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport SkeletonAnimator\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/SkeletonAnimator\");\nimport JointPose\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/JointPose\");\nimport Skeleton\t\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/Skeleton\");\nimport SkeletonPose\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/SkeletonPose\");\nimport SkeletonClipNode\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/SkeletonClipNode\");\nimport AnimationClipState\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/AnimationClipState\");\nimport ISkeletonAnimationState\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ISkeletonAnimationState\");\n\n/**\n *\n */\nclass SkeletonClipState extends AnimationClipState implements ISkeletonAnimationState\n{\n\tprivate _rootPos:Vector3D = new Vector3D();\n\tprivate _frames:Array<SkeletonPose>;\n\tprivate _skeletonClipNode:SkeletonClipNode;\n\tprivate _skeletonPose:SkeletonPose = new SkeletonPose();\n\tprivate _skeletonPoseDirty:boolean = true;\n\tprivate _currentPose:SkeletonPose;\n\tprivate _nextPose:SkeletonPose;\n\n\t/**\n\t * Returns the current skeleton pose frame of animation in the clip based on the internal playhead position.\n\t */\n\tpublic get currentPose():SkeletonPose\n\t{\n\t\tif (this._pFramesDirty)\n\t\t\tthis._pUpdateFrames();\n\n\t\treturn this._currentPose;\n\t}\n\n\t/**\n\t * Returns the next skeleton pose frame of animation in the clip based on the internal playhead position.\n\t */\n\tpublic get nextPose():SkeletonPose\n\t{\n\t\tif (this._pFramesDirty)\n\t\t\tthis._pUpdateFrames();\n\n\t\treturn this._nextPose;\n\t}\n\n\tconstructor(animator:AnimatorBase, skeletonClipNode:SkeletonClipNode)\n\t{\n\t\tsuper(animator, skeletonClipNode);\n\n\t\tthis._skeletonClipNode = skeletonClipNode;\n\t\tthis._frames = this._skeletonClipNode.frames;\n\t}\n\n\t/**\n\t * Returns the current skeleton pose of the animation in the clip based on the internal playhead position.\n\t */\n\tpublic getSkeletonPose(skeleton:Skeleton):SkeletonPose\n\t{\n\t\tif (this._skeletonPoseDirty)\n\t\t\tthis.updateSkeletonPose(skeleton);\n\n\t\treturn this._skeletonPose;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _pUpdateTime(time:number /*int*/)\n\t{\n\t\tthis._skeletonPoseDirty = true;\n\n\t\tsuper._pUpdateTime(time);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _pUpdateFrames()\n\t{\n\t\tsuper._pUpdateFrames();\n\n\t\tthis._currentPose = this._frames[this._pCurrentFrame];\n\n\t\tif (this._skeletonClipNode.looping && this._pNextFrame >= this._skeletonClipNode.lastFrame) {\n\t\t\tthis._nextPose = this._frames[0];\n\t\t\t(<SkeletonAnimator> this._pAnimator).dispatchCycleEvent();\n\t\t} else\n\t\t\tthis._nextPose = this._frames[this._pNextFrame];\n\t}\n\n\t/**\n\t * Updates the output skeleton pose of the node based on the internal playhead position.\n\t *\n\t * @param skeleton The skeleton used by the animator requesting the ouput pose.\n\t */\n\tprivate updateSkeletonPose(skeleton:Skeleton)\n\t{\n\t\tthis._skeletonPoseDirty = false;\n\n\t\tif (!this._skeletonClipNode.totalDuration)\n\t\t\treturn;\n\n\t\tif (this._pFramesDirty)\n\t\t\tthis._pUpdateFrames();\n\n\t\tvar currentPose:Array<JointPose> = this._currentPose.jointPoses;\n\t\tvar nextPose:Array<JointPose> = this._nextPose.jointPoses;\n\t\tvar numJoints:number /*uint*/ = skeleton.numJoints;\n\t\tvar p1:Vector3D, p2:Vector3D;\n\t\tvar pose1:JointPose, pose2:JointPose;\n\t\tvar endPoses:Array<JointPose> = this._skeletonPose.jointPoses;\n\t\tvar endPose:JointPose;\n\t\tvar tr:Vector3D;\n\n\t\t// :s\n\t\tif (endPoses.length != numJoints)\n\t\t\tendPoses.length = numJoints;\n\n\t\tif ((numJoints != currentPose.length) || (numJoints != nextPose.length))\n\t\t\tthrow new Error(\"joint counts don't match!\");\n\n\t\tfor (var i:number /*uint*/ = 0; i < numJoints; ++i) {\n\t\t\tendPose = endPoses[i];\n\n\t\t\tif (endPose == null)\n\t\t\t\tendPose = endPoses[i] = new JointPose();\n\n\t\t\tpose1 = currentPose[i];\n\t\t\tpose2 = nextPose[i];\n\t\t\tp1 = pose1.translation;\n\t\t\tp2 = pose2.translation;\n\n\t\t\tif (this._skeletonClipNode.highQuality)\n\t\t\t\tendPose.orientation.slerp(pose1.orientation, pose2.orientation, this._pBlendWeight); else\n\t\t\t\tendPose.orientation.lerp(pose1.orientation, pose2.orientation, this._pBlendWeight);\n\n\t\t\tif (i > 0) {\n\t\t\t\ttr = endPose.translation;\n\t\t\t\ttr.x = p1.x + this._pBlendWeight*(p2.x - p1.x);\n\t\t\t\ttr.y = p1.y + this._pBlendWeight*(p2.y - p1.y);\n\t\t\t\ttr.z = p1.z + this._pBlendWeight*(p2.z - p1.z);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _pUpdatePositionDelta()\n\t{\n\t\tthis._pPositionDeltaDirty = false;\n\n\t\tif (this._pFramesDirty)\n\t\t\tthis._pUpdateFrames();\n\n\t\tvar p1:Vector3D, p2:Vector3D, p3:Vector3D;\n\t\tvar totalDelta:Vector3D = this._skeletonClipNode.totalDelta;\n\n\t\t// jumping back, need to reset position\n\t\tif ((this._pTimeDir > 0 && this._pNextFrame < this._pOldFrame) || (this._pTimeDir < 0 && this._pNextFrame > this._pOldFrame)) {\n\t\t\tthis._rootPos.x -= totalDelta.x*this._pTimeDir;\n\t\t\tthis._rootPos.y -= totalDelta.y*this._pTimeDir;\n\t\t\tthis._rootPos.z -= totalDelta.z*this._pTimeDir;\n\t\t}\n\n\t\tvar dx:number = this._rootPos.x;\n\t\tvar dy:number = this._rootPos.y;\n\t\tvar dz:number = this._rootPos.z;\n\n\t\tif (this._skeletonClipNode.stitchFinalFrame && this._pNextFrame == this._skeletonClipNode.lastFrame) {\n\t\t\tp1 = this._frames[0].jointPoses[0].translation;\n\t\t\tp2 = this._frames[1].jointPoses[0].translation;\n\t\t\tp3 = this._currentPose.jointPoses[0].translation;\n\n\t\t\tthis._rootPos.x = p3.x + p1.x + this._pBlendWeight*(p2.x - p1.x);\n\t\t\tthis._rootPos.y = p3.y + p1.y + this._pBlendWeight*(p2.y - p1.y);\n\t\t\tthis._rootPos.z = p3.z + p1.z + this._pBlendWeight*(p2.z - p1.z);\n\t\t} else {\n\t\t\tp1 = this._currentPose.jointPoses[0].translation;\n\t\t\tp2 = this._frames[this._pNextFrame].jointPoses[0].translation; //cover the instances where we wrap the pose but still want the final frame translation values\n\t\t\tthis._rootPos.x = p1.x + this._pBlendWeight*(p2.x - p1.x);\n\t\t\tthis._rootPos.y = p1.y + this._pBlendWeight*(p2.y - p1.y);\n\t\t\tthis._rootPos.z = p1.z + this._pBlendWeight*(p2.z - p1.z);\n\t\t}\n\n\t\tthis._pRootDelta.x = this._rootPos.x - dx;\n\t\tthis._pRootDelta.y = this._rootPos.y - dy;\n\t\tthis._pRootDelta.z = this._rootPos.z - dz;\n\n\t\tthis._pOldFrame = this._pNextFrame;\n\t}\n}\n\nexport = SkeletonClipState;","import Quaternion\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Quaternion\");\nimport Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport JointPose\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/JointPose\");\nimport Skeleton\t\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/Skeleton\");\nimport SkeletonPose\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/SkeletonPose\");\nimport SkeletonDifferenceNode\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/SkeletonDifferenceNode\");\nimport AnimationStateBase\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/AnimationStateBase\");\nimport ISkeletonAnimationState\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ISkeletonAnimationState\");\n\n/**\n *\n */\nclass SkeletonDifferenceState extends AnimationStateBase implements ISkeletonAnimationState\n{\n\tprivate _blendWeight:number = 0;\n\tprivate static _tempQuat:Quaternion = new Quaternion();\n\tprivate _skeletonAnimationNode:SkeletonDifferenceNode;\n\tprivate _skeletonPose:SkeletonPose = new SkeletonPose();\n\tprivate _skeletonPoseDirty:boolean = true;\n\tprivate _baseInput:ISkeletonAnimationState;\n\tprivate _differenceInput:ISkeletonAnimationState;\n\n\t/**\n\t * Defines a fractional value between 0 and 1 representing the blending ratio between the base input (0) and difference input (1),\n\t * used to produce the skeleton pose output.\n\t *\n\t * @see #baseInput\n\t * @see #differenceInput\n\t */\n\tpublic get blendWeight():number\n\t{\n\t\treturn this._blendWeight;\n\t}\n\n\tpublic set blendWeight(value:number)\n\t{\n\t\tthis._blendWeight = value;\n\n\t\tthis._pPositionDeltaDirty = true;\n\t\tthis._skeletonPoseDirty = true;\n\t}\n\n\tconstructor(animator:AnimatorBase, skeletonAnimationNode:SkeletonDifferenceNode)\n\t{\n\t\tsuper(animator, skeletonAnimationNode);\n\n\t\tthis._skeletonAnimationNode = skeletonAnimationNode;\n\n\t\tthis._baseInput = <ISkeletonAnimationState> animator.getAnimationState(this._skeletonAnimationNode.baseInput);\n\t\tthis._differenceInput = <ISkeletonAnimationState> animator.getAnimationState(this._skeletonAnimationNode.differenceInput);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic phase(value:number)\n\t{\n\t\tthis._skeletonPoseDirty = true;\n\n\t\tthis._pPositionDeltaDirty = true;\n\n\t\tthis._baseInput.phase(value);\n\t\tthis._baseInput.phase(value);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _pUpdateTime(time:number /*int*/)\n\t{\n\t\tthis._skeletonPoseDirty = true;\n\n\t\tthis._baseInput.update(time);\n\t\tthis._differenceInput.update(time);\n\n\t\tsuper._pUpdateTime(time);\n\t}\n\n\t/**\n\t * Returns the current skeleton pose of the animation in the clip based on the internal playhead position.\n\t */\n\tpublic getSkeletonPose(skeleton:Skeleton):SkeletonPose\n\t{\n\t\tif (this._skeletonPoseDirty)\n\t\t\tthis.updateSkeletonPose(skeleton);\n\n\t\treturn this._skeletonPose;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _pUpdatePositionDelta()\n\t{\n\t\tthis._pPositionDeltaDirty = false;\n\n\t\tvar deltA:Vector3D = this._baseInput.positionDelta;\n\t\tvar deltB:Vector3D = this._differenceInput.positionDelta;\n\n\t\tthis.positionDelta.x = deltA.x + this._blendWeight*deltB.x;\n\t\tthis.positionDelta.y = deltA.y + this._blendWeight*deltB.y;\n\t\tthis.positionDelta.z = deltA.z + this._blendWeight*deltB.z;\n\t}\n\n\t/**\n\t * Updates the output skeleton pose of the node based on the blendWeight value between base input and difference input nodes.\n\t *\n\t * @param skeleton The skeleton used by the animator requesting the ouput pose.\n\t */\n\tprivate updateSkeletonPose(skeleton:Skeleton)\n\t{\n\t\tthis._skeletonPoseDirty = false;\n\n\t\tvar endPose:JointPose;\n\t\tvar endPoses:Array<JointPose> = this._skeletonPose.jointPoses;\n\t\tvar basePoses:Array<JointPose> = this._baseInput.getSkeletonPose(skeleton).jointPoses;\n\t\tvar diffPoses:Array<JointPose> = this._differenceInput.getSkeletonPose(skeleton).jointPoses;\n\t\tvar base:JointPose, diff:JointPose;\n\t\tvar basePos:Vector3D, diffPos:Vector3D;\n\t\tvar tr:Vector3D;\n\t\tvar numJoints:number /*uint*/ = skeleton.numJoints;\n\n\t\t// :s\n\t\tif (endPoses.length != numJoints)\n\t\t\tendPoses.length = numJoints;\n\n\t\tfor (var i:number /*uint*/ = 0; i < numJoints; ++i) {\n\t\t\tendPose = endPoses[i];\n\n\t\t\tif (endPose == null)\n\t\t\t\tendPose = endPoses[i] = new JointPose();\n\n\t\t\tbase = basePoses[i];\n\t\t\tdiff = diffPoses[i];\n\t\t\tbasePos = base.translation;\n\t\t\tdiffPos = diff.translation;\n\n\t\t\tSkeletonDifferenceState._tempQuat.multiply(diff.orientation, base.orientation);\n\t\t\tendPose.orientation.lerp(base.orientation, SkeletonDifferenceState._tempQuat, this._blendWeight);\n\n\t\t\ttr = endPose.translation;\n\t\t\ttr.x = basePos.x + this._blendWeight*diffPos.x;\n\t\t\ttr.y = basePos.y + this._blendWeight*diffPos.y;\n\t\t\ttr.z = basePos.z + this._blendWeight*diffPos.z;\n\t\t}\n\t}\n}\n\nexport = SkeletonDifferenceState;","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport JointPose\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/JointPose\");\nimport Skeleton\t\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/Skeleton\");\nimport SkeletonPose\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/SkeletonPose\");\nimport SkeletonDirectionalNode\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/SkeletonDirectionalNode\");\nimport AnimationStateBase\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/AnimationStateBase\");\nimport ISkeletonAnimationState\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ISkeletonAnimationState\");\n\n/**\n *\n */\nclass SkeletonDirectionalState extends AnimationStateBase implements ISkeletonAnimationState\n{\n\tprivate _skeletonAnimationNode:SkeletonDirectionalNode;\n\tprivate _skeletonPose:SkeletonPose = new SkeletonPose();\n\tprivate _skeletonPoseDirty:boolean = true;\n\tprivate _inputA:ISkeletonAnimationState;\n\tprivate _inputB:ISkeletonAnimationState;\n\tprivate _blendWeight:number = 0;\n\tprivate _direction:number = 0;\n\tprivate _blendDirty:boolean = true;\n\tprivate _forward:ISkeletonAnimationState;\n\tprivate _backward:ISkeletonAnimationState;\n\tprivate _left:ISkeletonAnimationState;\n\tprivate _right:ISkeletonAnimationState;\n\n\t/**\n\t * Defines the direction in degrees of the aniamtion between the forwards (0), right(90) backwards (180) and left(270) input nodes,\n\t * used to produce the skeleton pose output.\n\t */\n\tpublic set direction(value:number)\n\t{\n\t\tif (this._direction == value)\n\t\t\treturn;\n\n\t\tthis._direction = value;\n\n\t\tthis._blendDirty = true;\n\n\t\tthis._skeletonPoseDirty = true;\n\t\tthis._pPositionDeltaDirty = true;\n\t}\n\n\tpublic get direction():number\n\t{\n\t\treturn this._direction;\n\t}\n\n\tconstructor(animator:AnimatorBase, skeletonAnimationNode:SkeletonDirectionalNode)\n\t{\n\t\tsuper(animator, skeletonAnimationNode);\n\n\t\tthis._skeletonAnimationNode = skeletonAnimationNode;\n\n\t\tthis._forward = <ISkeletonAnimationState> animator.getAnimationState(this._skeletonAnimationNode.forward);\n\t\tthis._backward = <ISkeletonAnimationState> animator.getAnimationState(this._skeletonAnimationNode.backward);\n\t\tthis._left = <ISkeletonAnimationState> animator.getAnimationState(this._skeletonAnimationNode.left);\n\t\tthis._right = <ISkeletonAnimationState> animator.getAnimationState(this._skeletonAnimationNode.right);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic phase(value:number)\n\t{\n\t\tif (this._blendDirty)\n\t\t\tthis.updateBlend();\n\n\t\tthis._skeletonPoseDirty = true;\n\n\t\tthis._pPositionDeltaDirty = true;\n\n\t\tthis._inputA.phase(value);\n\t\tthis._inputB.phase(value);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _pUdateTime(time:number /*int*/)\n\t{\n\t\tif (this._blendDirty)\n\t\t\tthis.updateBlend();\n\n\t\tthis._skeletonPoseDirty = true;\n\n\t\tthis._inputA.update(time);\n\t\tthis._inputB.update(time);\n\n\t\tsuper._pUpdateTime(time);\n\t}\n\n\t/**\n\t * Returns the current skeleton pose of the animation in the clip based on the internal playhead position.\n\t */\n\tpublic getSkeletonPose(skeleton:Skeleton):SkeletonPose\n\t{\n\t\tif (this._skeletonPoseDirty)\n\t\t\tthis.updateSkeletonPose(skeleton);\n\n\t\treturn this._skeletonPose;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _pUpdatePositionDelta()\n\t{\n\t\tthis._pPositionDeltaDirty = false;\n\n\t\tif (this._blendDirty)\n\t\t\tthis.updateBlend();\n\n\t\tvar deltA:Vector3D = this._inputA.positionDelta;\n\t\tvar deltB:Vector3D = this._inputB.positionDelta;\n\n\t\tthis.positionDelta.x = deltA.x + this._blendWeight*(deltB.x - deltA.x);\n\t\tthis.positionDelta.y = deltA.y + this._blendWeight*(deltB.y - deltA.y);\n\t\tthis.positionDelta.z = deltA.z + this._blendWeight*(deltB.z - deltA.z);\n\t}\n\n\t/**\n\t * Updates the output skeleton pose of the node based on the direction value between forward, backwards, left and right input nodes.\n\t *\n\t * @param skeleton The skeleton used by the animator requesting the ouput pose.\n\t */\n\tprivate updateSkeletonPose(skeleton:Skeleton)\n\t{\n\t\tthis._skeletonPoseDirty = false;\n\n\t\tif (this._blendDirty)\n\t\t\tthis.updateBlend();\n\n\t\tvar endPose:JointPose;\n\t\tvar endPoses:Array<JointPose> = this._skeletonPose.jointPoses;\n\t\tvar poses1:Array<JointPose> = this._inputA.getSkeletonPose(skeleton).jointPoses;\n\t\tvar poses2:Array<JointPose> = this._inputB.getSkeletonPose(skeleton).jointPoses;\n\t\tvar pose1:JointPose, pose2:JointPose;\n\t\tvar p1:Vector3D, p2:Vector3D;\n\t\tvar tr:Vector3D;\n\t\tvar numJoints:number /*uint*/ = skeleton.numJoints;\n\n\t\t// :s\n\t\tif (endPoses.length != numJoints)\n\t\t\tendPoses.length = numJoints;\n\n\t\tfor (var i:number /*uint*/ = 0; i < numJoints; ++i) {\n\t\t\tendPose = endPoses[i];\n\n\t\t\tif (endPose == null)\n\t\t\t\tendPose = endPoses[i] = new JointPose();\n\n\t\t\tpose1 = poses1[i];\n\t\t\tpose2 = poses2[i];\n\t\t\tp1 = pose1.translation;\n\t\t\tp2 = pose2.translation;\n\n\t\t\tendPose.orientation.lerp(pose1.orientation, pose2.orientation, this._blendWeight);\n\n\t\t\ttr = endPose.translation;\n\t\t\ttr.x = p1.x + this._blendWeight*(p2.x - p1.x);\n\t\t\ttr.y = p1.y + this._blendWeight*(p2.y - p1.y);\n\t\t\ttr.z = p1.z + this._blendWeight*(p2.z - p1.z);\n\t\t}\n\t}\n\n\t/**\n\t * Updates the blend value for the animation output based on the direction value between forward, backwards, left and right input nodes.\n\t *\n\t * @private\n\t */\n\tprivate updateBlend()\n\t{\n\t\tthis._blendDirty = false;\n\n\t\tif (this._direction < 0 || this._direction > 360) {\n\t\t\tthis._direction %= 360;\n\t\t\tif (this._direction < 0)\n\t\t\t\tthis._direction += 360;\n\t\t}\n\n\t\tif (this._direction < 90) {\n\t\t\tthis._inputA = this._forward;\n\t\t\tthis._inputB = this._right;\n\t\t\tthis._blendWeight = this._direction/90;\n\t\t} else if (this._direction < 180) {\n\t\t\tthis._inputA = this._right;\n\t\t\tthis._inputB = this._backward;\n\t\t\tthis._blendWeight = (this._direction - 90)/90;\n\t\t} else if (this._direction < 270) {\n\t\t\tthis._inputA = this._backward;\n\t\t\tthis._inputB = this._left;\n\t\t\tthis._blendWeight = (this._direction - 180)/90;\n\t\t} else {\n\t\t\tthis._inputA = this._left;\n\t\t\tthis._inputB = this._forward;\n\t\t\tthis._blendWeight = (this._direction - 270)/90;\n\t\t}\n\t}\n}\n\nexport = SkeletonDirectionalState;","import Quaternion\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Quaternion\");\nimport Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport JointPose\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/JointPose\");\nimport Skeleton\t\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/Skeleton\");\nimport SkeletonPose\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/SkeletonPose\");\nimport SkeletonNaryLERPNode\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/SkeletonNaryLERPNode\");\nimport AnimationStateBase\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/AnimationStateBase\");\nimport ISkeletonAnimationState\t\t\t= require(\"awayjs-renderergl/lib/animators/states/ISkeletonAnimationState\");\n\n/**\n *\n */\nclass SkeletonNaryLERPState extends AnimationStateBase implements ISkeletonAnimationState\n{\n\tprivate _skeletonAnimationNode:SkeletonNaryLERPNode;\n\tprivate _skeletonPose:SkeletonPose = new SkeletonPose();\n\tprivate _skeletonPoseDirty:boolean = true;\n\tprivate _blendWeights:Array<number> = new Array<number>();\n\tprivate _inputs:Array<ISkeletonAnimationState> = new Array<ISkeletonAnimationState>();\n\n\tconstructor(animator:AnimatorBase, skeletonAnimationNode:SkeletonNaryLERPNode)\n\t{\n\t\tsuper(animator, skeletonAnimationNode);\n\n\t\tthis._skeletonAnimationNode = skeletonAnimationNode;\n\n\t\tvar i:number /*uint*/ = this._skeletonAnimationNode.numInputs;\n\n\t\twhile (i--)\n\t\t\tthis._inputs[i] = <ISkeletonAnimationState> animator.getAnimationState(this._skeletonAnimationNode._iInputs[i]);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic phase(value:number)\n\t{\n\t\tthis._skeletonPoseDirty = true;\n\n\t\tthis._pPositionDeltaDirty = true;\n\n\t\tfor (var j:number /*uint*/ = 0; j < this._skeletonAnimationNode.numInputs; ++j) {\n\t\t\tif (this._blendWeights[j])\n\t\t\t\tthis._inputs[j].update(value);\n\t\t}\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _pUdateTime(time:number /*int*/)\n\t{\n\t\tfor (var j:number /*uint*/ = 0; j < this._skeletonAnimationNode.numInputs; ++j) {\n\t\t\tif (this._blendWeights[j])\n\t\t\t\tthis._inputs[j].update(time);\n\t\t}\n\n\t\tsuper._pUpdateTime(time);\n\t}\n\n\t/**\n\t * Returns the current skeleton pose of the animation in the clip based on the internal playhead position.\n\t */\n\tpublic getSkeletonPose(skeleton:Skeleton):SkeletonPose\n\t{\n\t\tif (this._skeletonPoseDirty)\n\t\t\tthis.updateSkeletonPose(skeleton);\n\n\t\treturn this._skeletonPose;\n\t}\n\n\t/**\n\t * Returns the blend weight of the skeleton aniamtion node that resides at the given input index.\n\t *\n\t * @param index The input index for which the skeleton animation node blend weight is requested.\n\t */\n\tpublic getBlendWeightAt(index:number /*uint*/):number\n\t{\n\t\treturn this._blendWeights[index];\n\t}\n\n\t/**\n\t * Sets the blend weight of the skeleton aniamtion node that resides at the given input index.\n\t *\n\t * @param index The input index on which the skeleton animation node blend weight is to be set.\n\t * @param blendWeight The blend weight value to use for the given skeleton animation node index.\n\t */\n\tpublic setBlendWeightAt(index:number /*uint*/, blendWeight:number)\n\t{\n\t\tthis._blendWeights[index] = blendWeight;\n\n\t\tthis._pPositionDeltaDirty = true;\n\t\tthis._skeletonPoseDirty = true;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _pUpdatePositionDelta()\n\t{\n\t\tthis._pPositionDeltaDirty = false;\n\n\t\tvar delta:Vector3D;\n\t\tvar weight:number;\n\n\t\tthis.positionDelta.x = 0;\n\t\tthis.positionDelta.y = 0;\n\t\tthis.positionDelta.z = 0;\n\n\t\tfor (var j:number /*uint*/ = 0; j < this._skeletonAnimationNode.numInputs; ++j) {\n\t\t\tweight = this._blendWeights[j];\n\n\t\t\tif (weight) {\n\t\t\t\tdelta = this._inputs[j].positionDelta;\n\t\t\t\tthis.positionDelta.x += weight*delta.x;\n\t\t\t\tthis.positionDelta.y += weight*delta.y;\n\t\t\t\tthis.positionDelta.z += weight*delta.z;\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Updates the output skeleton pose of the node based on the blend weight values given to the input nodes.\n\t *\n\t * @param skeleton The skeleton used by the animator requesting the ouput pose.\n\t */\n\tprivate updateSkeletonPose(skeleton:Skeleton)\n\t{\n\t\tthis._skeletonPoseDirty = false;\n\n\t\tvar weight:number;\n\t\tvar endPoses:Array<JointPose> = this._skeletonPose.jointPoses;\n\t\tvar poses:Array<JointPose>;\n\t\tvar endPose:JointPose, pose:JointPose;\n\t\tvar endTr:Vector3D, tr:Vector3D;\n\t\tvar endQuat:Quaternion, q:Quaternion;\n\t\tvar firstPose:Array<JointPose>;\n\t\tvar i:number /*uint*/;\n\t\tvar w0:number, x0:number, y0:number, z0:number;\n\t\tvar w1:number, x1:number, y1:number, z1:number;\n\t\tvar numJoints:number /*uint*/ = skeleton.numJoints;\n\n\t\t// :s\n\t\tif (endPoses.length != numJoints)\n\t\t\tendPoses.length = numJoints;\n\n\t\tfor (var j:number /*uint*/ = 0; j < this._skeletonAnimationNode.numInputs; ++j) {\n\t\t\tweight = this._blendWeights[j];\n\n\t\t\tif (!weight)\n\t\t\t\tcontinue;\n\n\t\t\tposes = this._inputs[j].getSkeletonPose(skeleton).jointPoses;\n\n\t\t\tif (!firstPose) {\n\t\t\t\tfirstPose = poses;\n\t\t\t\tfor (i = 0; i < numJoints; ++i) {\n\t\t\t\t\tendPose = endPoses[i];\n\n\t\t\t\t\tif (endPose == null)\n\t\t\t\t\t\tendPose = endPoses[i] = new JointPose();\n\n\t\t\t\t\tpose = poses[i];\n\t\t\t\t\tq = pose.orientation;\n\t\t\t\t\ttr = pose.translation;\n\n\t\t\t\t\tendQuat = endPose.orientation;\n\n\t\t\t\t\tendQuat.x = weight*q.x;\n\t\t\t\t\tendQuat.y = weight*q.y;\n\t\t\t\t\tendQuat.z = weight*q.z;\n\t\t\t\t\tendQuat.w = weight*q.w;\n\n\t\t\t\t\tendTr = endPose.translation;\n\t\t\t\t\tendTr.x = weight*tr.x;\n\t\t\t\t\tendTr.y = weight*tr.y;\n\t\t\t\t\tendTr.z = weight*tr.z;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tfor (i = 0; i < skeleton.numJoints; ++i) {\n\t\t\t\t\tendPose = endPoses[i];\n\t\t\t\t\tpose = poses[i];\n\n\t\t\t\t\tq = firstPose[i].orientation;\n\t\t\t\t\tx0 = q.x;\n\t\t\t\t\ty0 = q.y;\n\t\t\t\t\tz0 = q.z;\n\t\t\t\t\tw0 = q.w;\n\n\t\t\t\t\tq = pose.orientation;\n\t\t\t\t\ttr = pose.translation;\n\n\t\t\t\t\tx1 = q.x;\n\t\t\t\t\ty1 = q.y;\n\t\t\t\t\tz1 = q.z;\n\t\t\t\t\tw1 = q.w;\n\t\t\t\t\t// find shortest direction\n\t\t\t\t\tif (x0*x1 + y0*y1 + z0*z1 + w0*w1 < 0) {\n\t\t\t\t\t\tx1 = -x1;\n\t\t\t\t\t\ty1 = -y1;\n\t\t\t\t\t\tz1 = -z1;\n\t\t\t\t\t\tw1 = -w1;\n\t\t\t\t\t}\n\t\t\t\t\tendQuat = endPose.orientation;\n\t\t\t\t\tendQuat.x += weight*x1;\n\t\t\t\t\tendQuat.y += weight*y1;\n\t\t\t\t\tendQuat.z += weight*z1;\n\t\t\t\t\tendQuat.w += weight*w1;\n\n\t\t\t\t\tendTr = endPose.translation;\n\t\t\t\t\tendTr.x += weight*tr.x;\n\t\t\t\t\tendTr.y += weight*tr.y;\n\t\t\t\t\tendTr.z += weight*tr.z;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tfor (i = 0; i < skeleton.numJoints; ++i)\n\t\t\tendPoses[i].orientation.normalize();\n\t}\n}\n\nexport = SkeletonNaryLERPState;","import Geometry\t\t\t\t\t\t\t= require(\"awayjs-display/lib/base/Geometry\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport VertexAnimator\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/VertexAnimator\");\nimport VertexClipNode\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/VertexClipNode\");\nimport AnimationClipState\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/AnimationClipState\");\nimport IVertexAnimationState\t\t\t= require(\"awayjs-renderergl/lib/animators/states/IVertexAnimationState\");\n\n/**\n *\n */\nclass VertexClipState extends AnimationClipState implements IVertexAnimationState\n{\n\tprivate _frames:Array<Geometry>;\n\tprivate _vertexClipNode:VertexClipNode;\n\tprivate _currentGeometry:Geometry;\n\tprivate _nextGeometry:Geometry;\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic get currentGeometry():Geometry\n\t{\n\t\tif (this._pFramesDirty)\n\t\t\tthis._pUpdateFrames();\n\n\t\treturn this._currentGeometry;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic get nextGeometry():Geometry\n\t{\n\t\tif (this._pFramesDirty)\n\t\t\tthis._pUpdateFrames();\n\n\t\treturn this._nextGeometry;\n\t}\n\n\tconstructor(animator:AnimatorBase, vertexClipNode:VertexClipNode)\n\t{\n\t\tsuper(animator, vertexClipNode);\n\n\t\tthis._vertexClipNode = vertexClipNode;\n\t\tthis._frames = this._vertexClipNode.frames;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _pUpdateFrames()\n\t{\n\t\tsuper._pUpdateFrames();\n\n\t\tthis._currentGeometry = this._frames[this._pCurrentFrame];\n\n\t\tif (this._vertexClipNode.looping && this._pNextFrame >= this._vertexClipNode.lastFrame) {\n\t\t\tthis._nextGeometry = this._frames[0];\n\t\t\t(<VertexAnimator> this._pAnimator).dispatchCycleEvent();\n\t\t} else\n\t\t\tthis._nextGeometry = this._frames[this._pNextFrame];\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _pUpdatePositionDelta()\n\t{\n\t\t//TODO:implement positiondelta functionality for vertex animations\n\t}\n}\n\nexport = VertexClipState;","import SkeletonBinaryLERPNode\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/SkeletonBinaryLERPNode\");\nimport CrossfadeTransitionState\t\t\t= require(\"awayjs-renderergl/lib/animators/transitions/CrossfadeTransitionState\");\n\n/**\n * A skeleton animation node that uses two animation node inputs to blend a lineraly interpolated output of a skeleton pose.\n */\nclass CrossfadeTransitionNode extends SkeletonBinaryLERPNode\n{\n\tpublic blendSpeed:number;\n\n\tpublic startBlend:number /*int*/;\n\n\t/**\n\t * Creates a new <code>CrossfadeTransitionNode</code> object.\n\t */\n\tconstructor()\n\t{\n\t\tsuper();\n\n\t\tthis._pStateClass = CrossfadeTransitionState;\n\t}\n}\n\nexport = CrossfadeTransitionNode;","import AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport SkeletonBinaryLERPNode\t\t\t= require(\"awayjs-renderergl/lib/animators/nodes/SkeletonBinaryLERPNode\");\nimport SkeletonBinaryLERPState\t\t\t= require(\"awayjs-renderergl/lib/animators/states/SkeletonBinaryLERPState\");\nimport CrossfadeTransitionNode\t\t\t= require(\"awayjs-renderergl/lib/animators/transitions/CrossfadeTransitionNode\");\nimport AnimationStateEvent\t\t\t\t= require(\"awayjs-renderergl/lib/events/AnimationStateEvent\");\n\n/**\n *\n */\nclass CrossfadeTransitionState extends SkeletonBinaryLERPState\n{\n\tprivate _crossfadeTransitionNode:CrossfadeTransitionNode;\n\tprivate _animationStateTransitionComplete:AnimationStateEvent;\n\n\tconstructor(animator:AnimatorBase, skeletonAnimationNode:CrossfadeTransitionNode)\n\t{\n\t\tsuper(animator, <SkeletonBinaryLERPNode> skeletonAnimationNode);\n\n\t\tthis._crossfadeTransitionNode = skeletonAnimationNode;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _pUpdateTime(time:number /*int*/)\n\t{\n\t\tthis.blendWeight = Math.abs(time - this._crossfadeTransitionNode.startBlend)/(1000*this._crossfadeTransitionNode.blendSpeed);\n\n\t\tif (this.blendWeight >= 1) {\n\t\t\tthis.blendWeight = 1;\n\n\t\t\tif (this._animationStateTransitionComplete == null)\n\t\t\t\tthis._animationStateTransitionComplete = new AnimationStateEvent(AnimationStateEvent.TRANSITION_COMPLETE, this._pAnimator, this, this._crossfadeTransitionNode);\n\n\t\t\tthis._crossfadeTransitionNode.dispatchEvent(this._animationStateTransitionComplete);\n\t\t}\n\n\t\tsuper._pUpdateTime(time);\n\t}\n}\n\nexport = CrossfadeTransitionState;","import AnimationNodeBase\t\t\t\t= require(\"awayjs-display/lib/animators/nodes/AnimationNodeBase\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport CrossfadeTransitionNode\t\t\t= require(\"awayjs-renderergl/lib/animators/transitions/CrossfadeTransitionNode\");\nimport IAnimationTransition\t\t\t\t= require(\"awayjs-renderergl/lib/animators/transitions/IAnimationTransition\");\n\n/**\n *\n */\nclass CrossfadeTransition implements IAnimationTransition\n{\n\tpublic blendSpeed:number = 0.5;\n\n\tconstructor(blendSpeed:number)\n\t{\n\t\tthis.blendSpeed = blendSpeed;\n\t}\n\n\tpublic getAnimationNode(animator:AnimatorBase, startNode:AnimationNodeBase, endNode:AnimationNodeBase, startBlend:number /*int*/):AnimationNodeBase\n\t{\n\t\tvar crossFadeTransitionNode:CrossfadeTransitionNode = new CrossfadeTransitionNode();\n\t\tcrossFadeTransitionNode.inputA = startNode;\n\t\tcrossFadeTransitionNode.inputB = endNode;\n\t\tcrossFadeTransitionNode.blendSpeed = this.blendSpeed;\n\t\tcrossFadeTransitionNode.startBlend = startBlend;\n\n\t\treturn <AnimationNodeBase> crossFadeTransitionNode;\n\t}\n}\n\nexport = CrossfadeTransition;","import Geometry\t\t\t\t\t\t\t= require(\"awayjs-display/lib/base/Geometry\");\n\nimport ParticleData\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticleData\");\n\n/**\n * @class away.base.ParticleGeometry\n */\nclass ParticleGeometry extends Geometry\n{\n\tpublic particles:Array<ParticleData>;\n\n\tpublic numParticles:number /*uint*/;\n\n}\n\nexport = ParticleGeometry;","import BitmapData\t\t\t\t\t= require(\"awayjs-core/lib/base/BitmapData\");\nimport Matrix3D\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3D\");\nimport Plane3D\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Plane3D\");\nimport Point\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Point\");\nimport Rectangle\t\t\t\t\t= require(\"awayjs-core/lib/geom/Rectangle\");\nimport Vector3D\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\nimport AbstractMethodError\t\t\t= require(\"awayjs-core/lib/errors/AbstractMethodError\");\nimport EventDispatcher\t\t\t\t= require(\"awayjs-core/lib/events/EventDispatcher\");\nimport TextureProxyBase\t\t\t\t= require(\"awayjs-core/lib/textures/TextureProxyBase\");\nimport ByteArray\t\t\t\t\t= require(\"awayjs-core/lib/utils/ByteArray\");\n\nimport LineSubMesh\t\t\t\t\t= require(\"awayjs-display/lib/base/LineSubMesh\");\nimport IRenderObjectOwner\t\t\t= require(\"awayjs-display/lib/base/IRenderObjectOwner\");\nimport TriangleSubMesh\t\t\t\t= require(\"awayjs-display/lib/base/TriangleSubMesh\");\nimport EntityListItem\t\t\t\t= require(\"awayjs-display/lib/pool/EntityListItem\");\nimport IEntitySorter\t\t\t\t= require(\"awayjs-display/lib/sort/IEntitySorter\");\nimport RenderableMergeSort\t\t\t= require(\"awayjs-display/lib/sort/RenderableMergeSort\");\nimport IRenderer\t\t\t\t\t= require(\"awayjs-display/lib/render/IRenderer\");\nimport Billboard\t\t\t\t\t= require(\"awayjs-display/lib/entities/Billboard\");\nimport Camera\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\nimport IEntity\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/IEntity\");\nimport Skybox\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Skybox\");\nimport RendererEvent\t\t\t\t= require(\"awayjs-display/lib/events/RendererEvent\");\nimport StageEvent\t\t\t\t\t= require(\"awayjs-display/lib/events/StageEvent\");\nimport MaterialBase\t\t\t\t\t= require(\"awayjs-display/lib/materials/MaterialBase\");\nimport EntityCollector\t\t\t\t= require(\"awayjs-display/lib/traverse/EntityCollector\");\nimport ICollector\t\t\t\t\t= require(\"awayjs-display/lib/traverse/ICollector\");\nimport ShadowCasterCollector\t\t= require(\"awayjs-display/lib/traverse/ShadowCasterCollector\");\nimport DefaultMaterialManager\t\t= require(\"awayjs-display/lib/managers/DefaultMaterialManager\");\n\nimport AGALMiniAssembler\t\t\t= require(\"awayjs-stagegl/lib/aglsl/assembler/AGALMiniAssembler\");\nimport ContextGLBlendFactor\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLBlendFactor\");\nimport ContextGLCompareMode\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLCompareMode\");\nimport IContextGL\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/IContextGL\");\nimport Stage\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\nimport StageManager\t\t\t\t\t= require(\"awayjs-stagegl/lib/managers/StageManager\");\nimport ProgramData\t\t\t\t\t= require(\"awayjs-stagegl/lib/pool/ProgramData\");\n\nimport AnimationSetBase\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimationSetBase\");\nimport AnimatorBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport RenderObjectBase\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/RenderObjectBase\");\nimport RenderableBase\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\nimport IRendererPoolClass\t\t\t= require(\"awayjs-renderergl/lib/pool/IRendererPoolClass\");\nimport RTTBufferManager\t\t\t\t= require(\"awayjs-renderergl/lib/managers/RTTBufferManager\");\nimport RenderPassBase\t\t\t\t= require(\"awayjs-renderergl/lib/passes/RenderPassBase\");\nimport RendererPoolBase\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RendererPoolBase\");\n\n\n/**\n * RendererBase forms an abstract base class for classes that are used in the rendering pipeline to render the\n * contents of a partition\n *\n * @class away.render.RendererBase\n */\nclass RendererBase extends EventDispatcher\n{\n\tprivate _numUsedStreams:number = 0;\n\tprivate _numUsedTextures:number = 0;\n\n\tprivate _rendererPool:RendererPoolBase;\n\n\tpublic _pRendererPoolClass:IRendererPoolClass;\n\tpublic _pContext:IContextGL;\n\tpublic _pStage:Stage;\n\n\tpublic _pCamera:Camera;\n\tpublic _iEntryPoint:Vector3D;\n\tpublic _pCameraForward:Vector3D;\n\n\tpublic _pRttBufferManager:RTTBufferManager;\n\tprivate _viewPort:Rectangle = new Rectangle();\n\tprivate _viewportDirty:boolean;\n\tprivate _scissorDirty:boolean;\n\n\tpublic _pBackBufferInvalid:boolean = true;\n\tpublic _pDepthTextureInvalid:boolean = true;\n\tpublic _depthPrepass:boolean = false;\n\tprivate _backgroundR:number = 0;\n\tprivate _backgroundG:number = 0;\n\tprivate _backgroundB:number = 0;\n\tprivate _backgroundAlpha:number = 1;\n\tpublic _shareContext:boolean = false;\n\n\t// only used by renderers that need to render geometry to textures\n\tpublic _width:number;\n\tpublic _height:number;\n\n\tpublic textureRatioX:number = 1;\n\tpublic textureRatioY:number = 1;\n\n\tprivate _snapshotBitmapData:BitmapData;\n\tprivate _snapshotRequired:boolean;\n\n\tpublic _pRttViewProjectionMatrix:Matrix3D = new Matrix3D();\n\n\tprivate _localPos:Point = new Point();\n\tprivate _globalPos:Point = new Point();\n\tpublic _pScissorRect:Rectangle = new Rectangle();\n\n\tprivate _scissorUpdated:RendererEvent;\n\tprivate _viewPortUpdated:RendererEvent;\n\n\tprivate _onContextUpdateDelegate:Function;\n\tprivate _onViewportUpdatedDelegate;\n\n\tpublic _pNumTriangles:number = 0;\n\n\tpublic _pOpaqueRenderableHead:RenderableBase;\n\tpublic _pBlendedRenderableHead:RenderableBase;\n\tpublic _disableColor:boolean = false;\n\tpublic _renderBlended:boolean = true;\n\n\n\tpublic get renderBlended():boolean\n\t{\n\t\treturn this._renderBlended;\n\t}\n\n\tpublic set renderBlended(value:boolean)\n\t{\n\t\tthis._renderBlended = value;\n\t}\n\n\n\tpublic get disableColor():boolean\n\t{\n\t\treturn this._disableColor;\n\t}\n\n\tpublic set disableColor(value:boolean)\n\t{\n\t\tthis._disableColor = value;\n\t}\n\n\t/**\n\t *\n\t */\n\tpublic get numTriangles():number\n\t{\n\t\treturn this._pNumTriangles;\n\t}\n\n\t/**\n\t *\n\t */\n\tpublic renderableSorter:IEntitySorter;\n\n\n\t/**\n\t * A viewPort rectangle equivalent of the Stage size and position.\n\t */\n\tpublic get viewPort():Rectangle\n\t{\n\t\treturn this._viewPort;\n\t}\n\n\t/**\n\t * A scissor rectangle equivalent of the view size and position.\n\t */\n\tpublic get scissorRect():Rectangle\n\t{\n\t\treturn this._pScissorRect;\n\t}\n\n\t/**\n\t *\n\t */\n\tpublic get x():number\n\t{\n\t\treturn this._localPos.x;\n\t}\n\n\tpublic set x(value:number)\n\t{\n\t\tif (this.x == value)\n\t\t\treturn;\n\n\t\tthis._globalPos.x = this._localPos.x = value;\n\n\t\tthis.updateGlobalPos();\n\t}\n\n\t/**\n\t *\n\t */\n\tpublic get y():number\n\t{\n\t\treturn this._localPos.y;\n\t}\n\n\tpublic set y(value:number)\n\t{\n\t\tif (this.y == value)\n\t\t\treturn;\n\n\t\tthis._globalPos.y = this._localPos.y = value;\n\n\t\tthis.updateGlobalPos();\n\t}\n\n\t/**\n\t *\n\t */\n\tpublic get width():number\n\t{\n\t\treturn this._width;\n\t}\n\n\tpublic set width(value:number)\n\t{\n\t\tif (this._width == value)\n\t\t\treturn;\n\n\t\tthis._width = value;\n\t\tthis._pScissorRect.width = value;\n\n\t\tif (this._pRttBufferManager)\n\t\t\tthis._pRttBufferManager.viewWidth = value;\n\n\t\tthis._pBackBufferInvalid = true;\n\t\tthis._pDepthTextureInvalid = true;\n\n\t\tthis.notifyScissorUpdate();\n\t}\n\n\t/**\n\t *\n\t */\n\tpublic get height():number\n\t{\n\t\treturn this._height;\n\t}\n\n\tpublic set height(value:number)\n\t{\n\t\tif (this._height == value)\n\t\t\treturn;\n\n\t\tthis._height = value;\n\t\tthis._pScissorRect.height = value;\n\n\t\tif (this._pRttBufferManager)\n\t\t\tthis._pRttBufferManager.viewHeight = value;\n\n\t\tthis._pBackBufferInvalid = true;\n\t\tthis._pDepthTextureInvalid = true;\n\n\t\tthis.notifyScissorUpdate();\n\t}\n\n\t/**\n\t * Creates a new RendererBase object.\n\t */\n\tconstructor(rendererPoolClass:IRendererPoolClass = null, stage:Stage = null)\n\t{\n\t\tsuper();\n\n\t\tthis._pRendererPoolClass = rendererPoolClass;\n\n\t\tthis._onViewportUpdatedDelegate = (event:StageEvent) => this.onViewportUpdated(event)\n\t\tthis._onContextUpdateDelegate = (event:Event) => this.onContextUpdate(event);\n\n\t\t//default sorting algorithm\n\t\tthis.renderableSorter = new RenderableMergeSort();\n\n\t\tthis._rendererPool = (rendererPoolClass)? new this._pRendererPoolClass(this) : new RendererPoolBase(this);\n\n\t\tthis.stage = stage || StageManager.getInstance().getFreeStage();\n\t}\n\n\tpublic activatePass(renderable:RenderableBase, pass:RenderPassBase, camera:Camera)\n\t{\n\t\t//clear unused vertex streams\n\t\tfor (var i = pass.shader.numUsedStreams; i < this._numUsedStreams; i++)\n\t\t\tthis._pContext.setVertexBufferAt(i, null);\n\n\t\t//clear unused texture streams\n\t\tfor (var i = pass.shader.numUsedTextures; i < this._numUsedTextures; i++)\n\t\t\tthis._pContext.setTextureAt(i, null);\n\n\t\t//check program data is uploaded\n\t\tvar programData:ProgramData = pass.shader.programData;\n\n\t\tif (!programData.program) {\n\t\t\tprogramData.program = this._pContext.createProgram();\n\t\t\tvar vertexByteCode:ByteArray = (new AGALMiniAssembler().assemble(\"part vertex 1\\n\" + programData.vertexString + \"endpart\"))['vertex'].data;\n\t\t\tvar fragmentByteCode:ByteArray = (new AGALMiniAssembler().assemble(\"part fragment 1\\n\" + programData.fragmentString + \"endpart\"))['fragment'].data;\n\t\t\tprogramData.program.upload(vertexByteCode, fragmentByteCode);\n\t\t}\n\n\t\t//set program data\n\t\tthis._pContext.setProgram(programData.program);\n\n\t\t//activate shader object through renderable\n\t\trenderable._iActivate(pass, camera);\n\t}\n\n\tpublic deactivatePass(renderable:RenderableBase, pass:RenderPassBase)\n\t{\n\t\t//deactivate shader object\n\t\trenderable._iDeactivate(pass);\n\n\t\tthis._numUsedStreams = pass.shader.numUsedStreams;\n\t\tthis._numUsedTextures = pass.shader.numUsedTextures;\n\t}\n\n\tpublic _iCreateEntityCollector():ICollector\n\t{\n\t\treturn new EntityCollector();\n\t}\n\n\t/**\n\t * The background color's red component, used when clearing.\n\t *\n\t * @private\n\t */\n\tpublic get _iBackgroundR():number\n\t{\n\t\treturn this._backgroundR;\n\t}\n\n\tpublic set _iBackgroundR(value:number)\n\t{\n\t\tif (this._backgroundR == value)\n\t\t\treturn;\n\n\t\tthis._backgroundR = value;\n\n\t\tthis._pBackBufferInvalid = true;\n\t}\n\n\t/**\n\t * The background color's green component, used when clearing.\n\t *\n\t * @private\n\t */\n\tpublic get _iBackgroundG():number\n\t{\n\t\treturn this._backgroundG;\n\t}\n\n\tpublic set _iBackgroundG(value:number)\n\t{\n\t\tif (this._backgroundG == value)\n\t\t\treturn;\n\n\t\tthis._backgroundG = value;\n\n\t\tthis._pBackBufferInvalid = true;\n\t}\n\n\t/**\n\t * The background color's blue component, used when clearing.\n\t *\n\t * @private\n\t */\n\tpublic get _iBackgroundB():number\n\t{\n\t\treturn this._backgroundB;\n\t}\n\n\tpublic set _iBackgroundB(value:number)\n\t{\n\t\tif (this._backgroundB == value)\n\t\t\treturn;\n\n\t\tthis._backgroundB = value;\n\n\t\tthis._pBackBufferInvalid = true;\n\t}\n\n\tpublic get context():IContextGL\n\t{\n\t\treturn this._pContext;\n\t}\n\n\t/**\n\t * The Stage that will provide the ContextGL used for rendering.\n\t */\n\tpublic get stage():Stage\n\t{\n\t\treturn this._pStage;\n\t}\n\n\tpublic set stage(value:Stage)\n\t{\n\t\tif (this._pStage == value)\n\t\t\treturn;\n\n\t\tthis.iSetStage(value);\n\t}\n\n\tpublic iSetStage(value:Stage)\n\t{\n\t\tif (this._pStage)\n\t\t\tthis.dispose();\n\n\t\tif (value) {\n\t\t\tthis._pStage = value;\n\n\t\t\tthis._rendererPool.stage = this._pStage;\n\n\t\t\tthis._pStage.addEventListener(StageEvent.CONTEXT_CREATED, this._onContextUpdateDelegate);\n\t\t\tthis._pStage.addEventListener(StageEvent.CONTEXT_RECREATED, this._onContextUpdateDelegate);\n\t\t\tthis._pStage.addEventListener(StageEvent.VIEWPORT_UPDATED, this._onViewportUpdatedDelegate);\n\n\t\t\t/*\n\t\t\t if (_backgroundImageRenderer)\n\t\t\t _backgroundImageRenderer.stage = value;\n\t\t\t */\n\t\t\tif (this._pStage.context)\n\t\t\t\tthis._pContext = <IContextGL> this._pStage.context;\n\t\t}\n\n\t\tthis._pBackBufferInvalid = true;\n\n\t\tthis.updateGlobalPos();\n\t}\n\n\t/**\n\t * Defers control of ContextGL clear() and present() calls to Stage, enabling multiple Stage frameworks\n\t * to share the same ContextGL object.\n\t */\n\tpublic get shareContext():boolean\n\t{\n\t\treturn this._shareContext;\n\t}\n\n\tpublic set shareContext(value:boolean)\n\t{\n\t\tif (this._shareContext == value)\n\t\t\treturn;\n\n\t\tthis._shareContext = value;\n\n\t\tthis.updateGlobalPos();\n\t}\n\n\t/**\n\t * Disposes the resources used by the RendererBase.\n\t */\n\tpublic dispose()\n\t{\n\t\tthis._rendererPool.dispose();\n\n\t\tthis._pStage.removeEventListener(StageEvent.CONTEXT_CREATED, this._onContextUpdateDelegate);\n\t\tthis._pStage.removeEventListener(StageEvent.CONTEXT_RECREATED, this._onContextUpdateDelegate);\n\t\tthis._pStage.removeEventListener(StageEvent.VIEWPORT_UPDATED, this._onViewportUpdatedDelegate);\n\n\t\tthis._pStage = null;\n\t\tthis._pContext = null;\n\t\t/*\n\t\t if (_backgroundImageRenderer) {\n\t\t _backgroundImageRenderer.dispose();\n\t\t _backgroundImageRenderer = null;\n\t\t }\n\t\t */\n\t}\n\n\tpublic render(entityCollector:ICollector)\n\t{\n\t\tthis._viewportDirty = false;\n\t\tthis._scissorDirty = false;\n\t}\n\n\t/**\n\t * Renders the potentially visible geometry to the back buffer or texture.\n\t * @param entityCollector The EntityCollector object containing the potentially visible geometry.\n\t * @param target An option target texture to render to.\n\t * @param surfaceSelector The index of a CubeTexture's face to render to.\n\t * @param additionalClearMask Additional clear mask information, in case extra clear channels are to be omitted.\n\t */\n\tpublic _iRender(entityCollector:ICollector, target:TextureProxyBase = null, scissorRect:Rectangle = null, surfaceSelector:number = 0)\n\t{\n\t\t//TODO refactor setTarget so that rendertextures are created before this check\n\t\tif (!this._pStage || !this._pContext)\n\t\t\treturn;\n\n\t\tthis._pRttViewProjectionMatrix.copyFrom(entityCollector.camera.viewProjection);\n\t\tthis._pRttViewProjectionMatrix.appendScale(this.textureRatioX, this.textureRatioY, 1);\n\n\t\tthis.pExecuteRender(entityCollector, target, scissorRect, surfaceSelector);\n\n\t\t// generate mip maps on target (if target exists) //TODO\n\t\t//if (target)\n\t\t//\t(<Texture>target).generateMipmaps();\n\n\t\t// clear buffers\n\t\tfor (var i:number = 0; i < 8; ++i) {\n\t\t\tthis._pContext.setVertexBufferAt(i, null);\n\t\t\tthis._pContext.setTextureAt(i, null);\n\t\t}\n\t}\n\n\tpublic _iRenderCascades(entityCollector:ShadowCasterCollector, target:TextureProxyBase, numCascades:number, scissorRects:Array<Rectangle>, cameras:Array<Camera>)\n\t{\n\t\tthis.pCollectRenderables(entityCollector);\n\n\t\tthis._pStage.setRenderTarget(target, true, 0);\n\t\tthis._pContext.clear(1, 1, 1, 1, 1, 0);\n\n\t\tthis._pContext.setBlendFactors(ContextGLBlendFactor.ONE, ContextGLBlendFactor.ZERO);\n\t\tthis._pContext.setDepthTest(true, ContextGLCompareMode.LESS);\n\n\t\tvar head:RenderableBase = this._pOpaqueRenderableHead;\n\n\t\tvar first:boolean = true;\n\n\t\tfor (var i:number = numCascades - 1; i >= 0; --i) {\n\t\t\tthis._pStage.scissorRect = scissorRects[i];\n\t\t\tthis.drawCascadeRenderables(head, cameras[i], first? null : cameras[i].frustumPlanes);\n\t\t\tfirst = false;\n\t\t}\n\n\t\t//line required for correct rendering when using away3d with starling. DO NOT REMOVE UNLESS STARLING INTEGRATION IS RETESTED!\n\t\tthis._pContext.setDepthTest(false, ContextGLCompareMode.LESS_EQUAL);\n\n\t\tthis._pStage.scissorRect = null;\n\t}\n\n\tpublic pCollectRenderables(entityCollector:ICollector)\n\t{\n\t\t//reset head values\n\t\tthis._pBlendedRenderableHead = null;\n\t\tthis._pOpaqueRenderableHead = null;\n\t\tthis._pNumTriangles = 0;\n\n\t\t//grab entity head\n\t\tvar item:EntityListItem = entityCollector.entityHead;\n\n\t\t//set temp values for entry point and camera forward vector\n\t\tthis._pCamera = entityCollector.camera;\n\t\tthis._iEntryPoint = this._pCamera.scenePosition;\n\t\tthis._pCameraForward = this._pCamera.transform.forwardVector;\n\n\t\t//iterate through all entities\n\t\twhile (item) {\n\t\t\titem.entity._iCollectRenderables(this._rendererPool);\n\t\t\titem = item.next;\n\t\t}\n\n\t\t//sort the resulting renderables\n\t\tthis._pOpaqueRenderableHead = <RenderableBase> this.renderableSorter.sortOpaqueRenderables(this._pOpaqueRenderableHead);\n\t\tthis._pBlendedRenderableHead = <RenderableBase> this.renderableSorter.sortBlendedRenderables(this._pBlendedRenderableHead);\n\t}\n\n\t/**\n\t * Renders the potentially visible geometry to the back buffer or texture. Only executed if everything is set up.\n\t *\n\t * @param entityCollector The EntityCollector object containing the potentially visible geometry.\n\t * @param target An option target texture to render to.\n\t * @param surfaceSelector The index of a CubeTexture's face to render to.\n\t * @param additionalClearMask Additional clear mask information, in case extra clear channels are to be omitted.\n\t */\n\tpublic pExecuteRender(entityCollector:ICollector, target:TextureProxyBase = null, scissorRect:Rectangle = null, surfaceSelector:number = 0)\n\t{\n\t\tthis._pStage.setRenderTarget(target, true, surfaceSelector);\n\n\t\tif ((target || !this._shareContext) && !this._depthPrepass)\n\t\t\tthis._pContext.clear(this._backgroundR, this._backgroundG, this._backgroundB, this._backgroundAlpha, 1, 0);\n\n\t\tthis._pStage.scissorRect = scissorRect;\n\n\t\t/*\n\t\t if (_backgroundImageRenderer)\n\t\t _backgroundImageRenderer.render();\n\t\t */\n\t\tthis.pCollectRenderables(entityCollector);\n\n\t\tthis._pContext.setBlendFactors(ContextGLBlendFactor.ONE, ContextGLBlendFactor.ZERO);\n\n\t\tthis.pDraw(entityCollector);\n\n\t\t//line required for correct rendering when using away3d with starling. DO NOT REMOVE UNLESS STARLING INTEGRATION IS RETESTED!\n\t\t//this._pContext.setDepthTest(false, ContextGLCompareMode.LESS_EQUAL); //oopsie\n\n\t\tif (!this._shareContext) {\n\t\t\tif (this._snapshotRequired && this._snapshotBitmapData) {\n\t\t\t\tthis._pContext.drawToBitmapData(this._snapshotBitmapData);\n\t\t\t\tthis._snapshotRequired = false;\n\t\t\t}\n\t\t}\n\n\t\tthis._pStage.scissorRect = null;\n\t}\n\n\t/*\n\t * Will draw the renderer's output on next render to the provided bitmap data.\n\t * */\n\tpublic queueSnapshot(bmd:BitmapData)\n\t{\n\t\tthis._snapshotRequired = true;\n\t\tthis._snapshotBitmapData = bmd;\n\t}\n\n\t/**\n\t * Performs the actual drawing of geometry to the target.\n\t * @param entityCollector The EntityCollector object containing the potentially visible geometry.\n\t */\n\tpublic pDraw(entityCollector:ICollector)\n\t{\n\t\tthis._pContext.setDepthTest(true, ContextGLCompareMode.LESS_EQUAL);\n\n\t\tif (this._disableColor)\n\t\t\tthis._pContext.setColorMask(false, false, false, false);\n\n\t\tthis.drawRenderables(this._pOpaqueRenderableHead, entityCollector);\n\n\t\tif (this._renderBlended)\n\t\t\tthis.drawRenderables(this._pBlendedRenderableHead, entityCollector);\n\n\t\tif (this._disableColor)\n\t\t\tthis._pContext.setColorMask(true, true, true, true);\n\t}\n\n\tprivate drawCascadeRenderables(renderable:RenderableBase, camera:Camera, cullPlanes:Array<Plane3D>)\n\t{\n\t\tvar renderable2:RenderableBase;\n\t\tvar renderObject:RenderObjectBase;\n\t\tvar pass:RenderPassBase;\n\n\t\twhile (renderable) {\n\t\t\trenderable2 = renderable;\n\t\t\trenderObject = renderable.renderObject;\n\t\t\tpass = renderObject.passes[0] //assuming only one pass per material\n\n\t\t\tthis.activatePass(renderable, pass, camera);\n\n\t\t\tdo {\n\t\t\t\t// if completely in front, it will fall in a different cascade\n\t\t\t\t// do not use near and far planes\n\t\t\t\tif (!cullPlanes || renderable2.sourceEntity.worldBounds.isInFrustum(cullPlanes, 4)) {\n\t\t\t\t\trenderable2._iRender(pass, camera, this._pRttViewProjectionMatrix);\n\t\t\t\t} else {\n\t\t\t\t\trenderable2.cascaded = true;\n\t\t\t\t}\n\n\t\t\t\trenderable2 = renderable2.next;\n\n\t\t\t} while (renderable2 && renderable2.renderObject == renderObject && !renderable2.cascaded);\n\n\t\t\tthis.deactivatePass(renderable, pass);\n\n\t\t\trenderable = renderable2;\n\t\t}\n\t}\n\n\t/**\n\t * Draw a list of renderables.\n\t *\n\t * @param renderables The renderables to draw.\n\t * @param entityCollector The EntityCollector containing all potentially visible information.\n\t */\n\tpublic drawRenderables(renderable:RenderableBase, entityCollector:ICollector)\n\t{\n\t\tvar i:number;\n\t\tvar len:number;\n\t\tvar renderable2:RenderableBase;\n\t\tvar renderObject:RenderObjectBase;\n\t\tvar passes:Array<RenderPassBase>;\n\t\tvar pass:RenderPassBase;\n\t\tvar camera:Camera = entityCollector.camera;\n\n\n\t\twhile (renderable) {\n\t\t\trenderObject = renderable.renderObject;\n\t\t\tpasses = renderObject.passes;\n\n\t\t\t// otherwise this would result in depth rendered anyway because fragment shader kil is ignored\n\t\t\tif (this._disableColor && renderObject._renderObjectOwner.alphaThreshold != 0) {\n\t\t\t\trenderable2 = renderable;\n\t\t\t\t// fast forward\n\t\t\t\tdo {\n\t\t\t\t\trenderable2 = renderable2.next;\n\n\t\t\t\t} while (renderable2 && renderable2.renderObject == renderObject);\n\t\t\t} else {\n\t\t\t\t//iterate through each shader object\n\t\t\t\tlen = passes.length;\n\t\t\t\tfor (i = 0; i < len; i++) {\n\t\t\t\t\trenderable2 = renderable;\n\t\t\t\t\tpass = passes[i];\n\n\t\t\t\t\tthis.activatePass(renderable, pass, camera);\n\n\t\t\t\t\tdo {\n\t\t\t\t\t\trenderable2._iRender(pass, camera, this._pRttViewProjectionMatrix);\n\n\t\t\t\t\t\trenderable2 = renderable2.next;\n\n\t\t\t\t\t} while (renderable2 && renderable2.renderObject == renderObject);\n\n\t\t\t\t\tthis.deactivatePass(renderable, pass);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\trenderable = renderable2;\n\t\t}\n\t}\n\n\t/**\n\t * Assign the context once retrieved\n\t */\n\tprivate onContextUpdate(event:Event)\n\t{\n\t\tthis._pContext = <IContextGL> this._pStage.context;\n\t}\n\n\tpublic get _iBackgroundAlpha():number\n\t{\n\t\treturn this._backgroundAlpha;\n\t}\n\n\tpublic set _iBackgroundAlpha(value:number)\n\t{\n\t\tif (this._backgroundAlpha == value)\n\t\t\treturn;\n\n\t\tthis._backgroundAlpha = value;\n\n\t\tthis._pBackBufferInvalid = true;\n\t}\n\n\t/*\n\t public get iBackground():Texture2DBase\n\t {\n\t return this._background;\n\t }\n\t */\n\n\t/*\n\t public set iBackground(value:Texture2DBase)\n\t {\n\t if (this._backgroundImageRenderer && !value) {\n\t this._backgroundImageRenderer.dispose();\n\t this._backgroundImageRenderer = null;\n\t }\n\n\t if (!this._backgroundImageRenderer && value)\n\t {\n\n\t this._backgroundImageRenderer = new BackgroundImageRenderer(this._pStage);\n\n\t }\n\n\n\t this._background = value;\n\n\t if (this._backgroundImageRenderer)\n\t this._backgroundImageRenderer.texture = value;\n\t }\n\t */\n\t/*\n\t public get backgroundImageRenderer():BackgroundImageRenderer\n\t {\n\t return _backgroundImageRenderer;\n\t }\n\t */\n\n\n\t/**\n\t * @private\n\t */\n\tprivate notifyScissorUpdate()\n\t{\n\t\tif (this._scissorDirty)\n\t\t\treturn;\n\n\t\tthis._scissorDirty = true;\n\n\t\tif (!this._scissorUpdated)\n\t\t\tthis._scissorUpdated = new RendererEvent(RendererEvent.SCISSOR_UPDATED);\n\n\t\tthis.dispatchEvent(this._scissorUpdated);\n\t}\n\n\n\t/**\n\t * @private\n\t */\n\tprivate notifyViewportUpdate()\n\t{\n\t\tif (this._viewportDirty)\n\t\t\treturn;\n\n\t\tthis._viewportDirty = true;\n\n\t\tif (!this._viewPortUpdated)\n\t\t\tthis._viewPortUpdated = new RendererEvent(RendererEvent.VIEWPORT_UPDATED);\n\n\t\tthis.dispatchEvent(this._viewPortUpdated);\n\t}\n\n\t/**\n\t *\n\t */\n\tpublic onViewportUpdated(event:StageEvent)\n\t{\n\t\tthis._viewPort = this._pStage.viewPort;\n\t\t//TODO stop firing viewport updated for every stagegl viewport change\n\n\t\tif (this._shareContext) {\n\t\t\tthis._pScissorRect.x = this._globalPos.x - this._pStage.x;\n\t\t\tthis._pScissorRect.y = this._globalPos.y - this._pStage.y;\n\t\t\tthis.notifyScissorUpdate();\n\t\t}\n\n\t\tthis.notifyViewportUpdate();\n\t}\n\n\t/**\n\t *\n\t */\n\tpublic updateGlobalPos()\n\t{\n\t\tif (this._shareContext) {\n\t\t\tthis._pScissorRect.x = this._globalPos.x - this._viewPort.x;\n\t\t\tthis._pScissorRect.y = this._globalPos.y - this._viewPort.y;\n\t\t} else {\n\t\t\tthis._pScissorRect.x = 0;\n\t\t\tthis._pScissorRect.y = 0;\n\t\t\tthis._viewPort.x = this._globalPos.x;\n\t\t\tthis._viewPort.y = this._globalPos.y;\n\t\t}\n\n\t\tthis.notifyScissorUpdate();\n\t}\n\n\t/**\n\t *\n\t * @param renderable\n\t * @protected\n\t */\n\tpublic applyRenderable(renderable:RenderableBase)\n\t{\n\t\t//set local vars for faster referencing\n\t\tvar renderObject:RenderObjectBase = this._pGetRenderObject(renderable, renderable.renderObjectOwner || DefaultMaterialManager.getDefaultMaterial(renderable.renderableOwner));\n\n\t\trenderable.renderObject = renderObject;\n\t\trenderable.renderObjectId = renderObject.renderObjectId;\n\t\trenderable.renderOrderId = renderObject.renderOrderId;\n\n\t\trenderable.cascaded = false;\n\n\t\tvar entity:IEntity = renderable.sourceEntity;\n\t\tvar position:Vector3D = entity.scenePosition;\n\n\t\t// project onto camera's z-axis\n\t\tposition = this._iEntryPoint.subtract(position);\n\t\trenderable.zIndex = entity.zOffset + position.dotProduct(this._pCameraForward);\n\n\t\t//store reference to scene transform\n\t\trenderable.renderSceneTransform = renderable.sourceEntity.getRenderSceneTransform(this._pCamera);\n\n\t\tif (renderObject.requiresBlending) {\n\t\t\trenderable.next = this._pBlendedRenderableHead;\n\t\t\tthis._pBlendedRenderableHead = renderable;\n\t\t} else {\n\t\t\trenderable.next = this._pOpaqueRenderableHead;\n\t\t\tthis._pOpaqueRenderableHead = renderable;\n\t\t}\n\n\t\tthis._pNumTriangles += renderable.numTriangles;\n\n\t\t//handle any overflow for renderables with data that exceeds GPU limitations\n\t\tif (renderable.overflow)\n\t\t\tthis.applyRenderable(renderable.overflow);\n\t}\n\n\tpublic _pGetRenderObject(renderable:RenderableBase, renderObjectOwner:IRenderObjectOwner):RenderObjectBase\n\t{\n\t\tthrow new AbstractMethodError();\n\t}\n}\n\nexport = RendererBase;","import IRenderObjectOwner\t\t\t= require(\"awayjs-display/lib/base/IRenderObjectOwner\");\n\nimport Stage\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\n\nimport RenderObjectBase\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/RenderObjectBase\");\nimport RenderObjectPool\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/RenderObjectPool\");\nimport IRenderableClass\t\t\t\t= require(\"awayjs-renderergl/lib/pool/IRenderableClass\");\nimport DepthPass\t\t\t\t\t= require(\"awayjs-renderergl/lib/passes/DepthPass\");\n\n/**\n * DepthRenderObject forms an abstract base class for the default shaded materials provided by Stage,\n * using material methods to define their appearance.\n */\nclass DepthRenderObject extends RenderObjectBase\n{\n\t/**\n\t *\n\t */\n\tpublic static id:string = \"depth\";\n\n\tconstructor(pool:RenderObjectPool, renderObjectOwner:IRenderObjectOwner, renderableClass:IRenderableClass, stage:Stage)\n\t{\n\t\tsuper(pool, renderObjectOwner, renderableClass, stage);\n\n\t\tthis._pAddScreenPass(new DepthPass(this, renderObjectOwner, renderableClass, this._stage));\n\t}\n}\n\nexport = DepthRenderObject;","﻿import IRenderObjectOwner\t\t\t= require(\"awayjs-display/lib/base/IRenderObjectOwner\");\n\nimport Stage\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\n\nimport RenderObjectPool\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/RenderObjectPool\");\nimport RenderObjectBase\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/RenderObjectBase\");\nimport IRenderableClass\t\t\t\t= require(\"awayjs-renderergl/lib/pool/IRenderableClass\");\nimport DistancePass\t\t\t\t\t= require(\"awayjs-renderergl/lib/passes/DistancePass\");\n\n/**\n * DistanceRenderObject is a pass that writes distance values to a depth map as a 32-bit value exploded over the 4 texture channels.\n * This is used to render omnidirectional shadow maps.\n */\nclass DistanceRenderObject extends RenderObjectBase\n{\n\t/**\n\t *\n\t */\n\tpublic static id:string = \"distance\";\n\n\t/**\n\t * Creates a new DistanceRenderObject object.\n\t *\n\t * @param material The material to which this pass belongs.\n\t */\n\tconstructor(pool:RenderObjectPool, renderObjectOwner:IRenderObjectOwner, renderableClass:IRenderableClass, stage:Stage)\n\t{\n\t\tsuper(pool, renderObjectOwner, renderableClass, stage);\n\n\t\tthis._pAddScreenPass(new DistancePass(this, renderObjectOwner, renderableClass, this._stage));\n\t}\n}\n\nexport = DistanceRenderObject;","import ShaderRegisterElement\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\n\n/**\n * RegisterPool is used by the shader compilation process to keep track of which registers of a certain type are\n * currently used and should not be allowed to be written to. Either entire registers can be requested and locked,\n * or single components (x, y, z, w) of a single register.\n * It is used by ShaderRegisterCache to track usages of individual register types.\n *\n * @see away.materials.ShaderRegisterCache\n */\nclass RegisterPool\n{\n\tprivate static _regPool:Object = new Object();\n\tprivate static _regCompsPool:Object = new Object();\n\n\tprivate _vectorRegisters:Array<ShaderRegisterElement>;\n\tprivate _registerComponents;\n\n\tprivate _regName:string;\n\tprivate _usedSingleCount:Array<Array<number>>;\n\tprivate _usedVectorCount:Array<number> /*uint*/;\n\tprivate _regCount:number;\n\n\tprivate _persistent:boolean;\n\n\t/**\n\t * Creates a new RegisterPool object.\n\t * @param regName The base name of the register type (\"ft\" for fragment temporaries, \"vc\" for vertex constants, etc)\n\t * @param regCount The amount of available registers of this type.\n\t * @param persistent Whether or not registers, once reserved, can be freed again. For example, temporaries are not persistent, but constants are.\n\t */\n\tconstructor(regName:string, regCount:number, persistent:boolean = true)\n\t{\n\t\tthis._regName = regName;\n\t\tthis._regCount = regCount;\n\t\tthis._persistent = persistent;\n\t\tthis.initRegisters(regName, regCount);\n\t}\n\n\t/**\n\t * Retrieve an entire vector register that's still available.\n\t */\n\tpublic requestFreeVectorReg():ShaderRegisterElement\n\t{\n\t\tfor (var i:number = 0; i < this._regCount; ++i) {\n\t\t\tif (!this.isRegisterUsed(i)) {\n\t\t\t\tif (this._persistent)\n\t\t\t\t\tthis._usedVectorCount[i]++;\n\n\t\t\t\treturn this._vectorRegisters[i];\n\t\t\t}\n\t\t}\n\n\t\tthrow new Error(\"Register overflow!\");\n\t}\n\n\t/**\n\t * Retrieve a single vector component that's still available.\n\t */\n\tpublic requestFreeRegComponent():ShaderRegisterElement\n\t{\n\t\tfor (var i:number = 0; i < this._regCount; ++i) {\n\t\t\tif (this._usedVectorCount[i] > 0)\n\t\t\t\tcontinue;\n\n\t\t\tfor (var j:number = 0; j < 4; ++j) {\n\t\t\t\tif (this._usedSingleCount[j][i] == 0) {\n\t\t\t\t\tif (this._persistent)\n\t\t\t\t\t\tthis._usedSingleCount[j][i]++;\n\n\t\t\t\t\treturn this._registerComponents[j][i];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthrow new Error(\"Register overflow!\");\n\t}\n\n\t/**\n\t * Marks a register as used, so it cannot be retrieved. The register won't be able to be used until removeUsage\n\t * has been called usageCount times again.\n\t * @param register The register to mark as used.\n\t * @param usageCount The amount of usages to add.\n\t */\n\tpublic addUsage(register:ShaderRegisterElement, usageCount:number)\n\t{\n\t\tif (register._component > -1)\n\t\t\tthis._usedSingleCount[register._component][register.index] += usageCount;\n\t\telse\n\t\t\tthis._usedVectorCount[register.index] += usageCount;\n\t}\n\n\t/**\n\t * Removes a usage from a register. When usages reach 0, the register is freed again.\n\t * @param register The register for which to remove a usage.\n\t */\n\tpublic removeUsage(register:ShaderRegisterElement)\n\t{\n\t\tif (register._component > -1) {\n\t\t\tif (--this._usedSingleCount[register._component][register.index] < 0)\n\t\t\t\tthrow new Error(\"More usages removed than exist!\");\n\t\t} else {\n\t\t\tif (--this._usedVectorCount[register.index] < 0)\n\t\t\t\tthrow new Error(\"More usages removed than exist!\");\n\t\t}\n\t}\n\n\t/**\n\t * Disposes any resources used by the current RegisterPool object.\n\t */\n\tpublic dispose()\n\t{\n\t\tthis._vectorRegisters = null;\n\t\tthis._registerComponents = null;\n\t\tthis._usedSingleCount = null;\n\t\tthis._usedVectorCount = null;\n\t}\n\n\t/**\n\t * Indicates whether or not any registers are in use.\n\t */\n\tpublic hasRegisteredRegs():boolean\n\t{\n\t\tfor (var i:number = 0; i < this._regCount; ++i)\n\t\t\tif (this.isRegisterUsed(i))\n\t\t\t\treturn true;\n\n\t\treturn false;\n\t}\n\n\t/**\n\t * Initializes all registers.\n\t */\n\tprivate initRegisters(regName:string, regCount:number)\n\t{\n\t\tvar hash:string = RegisterPool._initPool(regName, regCount);\n\n\t\tthis._vectorRegisters = RegisterPool._regPool[hash];\n\t\tthis._registerComponents = RegisterPool._regCompsPool[hash];\n\n\t\tthis._usedVectorCount = this._initArray(Array<number>(regCount), 0);\n\n\t\tthis._usedSingleCount = new Array<Array<number>>(4);\n\t\tthis._usedSingleCount[0] = this._initArray(new Array<number>(regCount), 0);\n\t\tthis._usedSingleCount[1] = this._initArray(new Array<number>(regCount), 0);\n\t\tthis._usedSingleCount[2] = this._initArray(new Array<number>(regCount), 0);\n\t\tthis._usedSingleCount[3] = this._initArray(new Array<number>(regCount), 0);\n\t}\n\n\tprivate static _initPool(regName:string, regCount:number):string\n\t{\n\t\tvar hash:string = regName + regCount;\n\n\t\tif (RegisterPool._regPool[hash] != undefined)\n\t\t\treturn hash;\n\n\t\tvar vectorRegisters:Array<ShaderRegisterElement> = new Array<ShaderRegisterElement>(regCount);\n\t\tRegisterPool._regPool[hash] = vectorRegisters;\n\n\t\tvar registerComponents = [\n\t\t\t[],\n\t\t\t[],\n\t\t\t[],\n\t\t\t[]\n\t\t];\n\t\tRegisterPool._regCompsPool[hash] = registerComponents;\n\n\t\tfor (var i:number = 0; i < regCount; ++i) {\n\n\t\t\tvectorRegisters[i] = new ShaderRegisterElement(regName, i);\n\n\t\t\tfor (var j:number = 0; j < 4; ++j)\n\t\t\t\tregisterComponents[j][i] = new ShaderRegisterElement(regName, i, j);\n\t\t}\n\n\t\treturn hash;\n\t}\n\n\n\t/**\n\t * Check if the temp register is either used for single or vector use\n\t */\n\tprivate isRegisterUsed(index:number):boolean\n\t{\n\t\tif (this._usedVectorCount[index] > 0)\n\t\t\treturn true;\n\n\t\tfor (var i:number = 0; i < 4; ++i)\n\t\t\tif (this._usedSingleCount[i][index] > 0)\n\t\t\t\treturn true;\n\n\t\treturn false;\n\t}\n\n\n\tprivate _initArray(a:Array<any>, val:any):Array<any>\n\t{\n\t\tvar l:number = a.length;\n\n\t\tfor (var c:number = 0; c < l; c++)\n\t\t\ta[c] = val;\n\n\t\treturn a;\n\t}\n}\n\nexport = RegisterPool;\n","import BlendMode\t\t\t\t\t= require(\"awayjs-display/lib/base/BlendMode\");\nimport IRenderObjectOwner\t\t\t= require(\"awayjs-display/lib/base/IRenderObjectOwner\");\nimport BasicMaterial\t\t\t\t= require(\"awayjs-display/lib/materials/BasicMaterial\");\n\nimport Stage\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\n\nimport RenderObjectBase\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/RenderObjectBase\");\nimport RenderObjectPool\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/RenderObjectPool\");\nimport IRenderableClass\t\t\t\t= require(\"awayjs-renderergl/lib/pool/IRenderableClass\");\nimport BasicMaterialPass\t\t\t= require(\"awayjs-renderergl/lib/passes/BasicMaterialPass\");\n\n/**\n * RenderMaterialObject forms an abstract base class for the default shaded materials provided by Stage,\n * using material methods to define their appearance.\n */\nclass RenderBasicMaterialObject extends RenderObjectBase\n{\n\t/**\n\t *\n\t */\n\tpublic static id:string = \"basic\";\n\n\tprivate _material:BasicMaterial;\n\tprivate _screenPass:BasicMaterialPass;\n\n\n\tconstructor(pool:RenderObjectPool, material:BasicMaterial, renderableClass:IRenderableClass, stage:Stage)\n\t{\n\t\tsuper(pool, material, renderableClass, stage);\n\n\t\tthis._material = material;\n\n\t\tthis._pAddScreenPass(this._screenPass = new BasicMaterialPass(this, material, renderableClass, this._stage));\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _pUpdateRenderObject()\n\t{\n\t\tsuper._pUpdateRenderObject();\n\n\t\tthis._pRequiresBlending = (this._material.blendMode != BlendMode.NORMAL || this._material.alphaBlending || (this._material.colorTransform && this._material.colorTransform.alphaMultiplier < 1));\n\t\t//this._screenPass.preserveAlpha = this._pRequiresBlending;\n\t\tthis._screenPass.setBlendMode((this._renderObjectOwner.blendMode == BlendMode.NORMAL && this._pRequiresBlending)? BlendMode.LAYER : this._material.blendMode);\n\t\t//this._screenPass.forceSeparateMVP = false;\n\t}\n}\n\nexport = RenderBasicMaterialObject;","import Matrix3D\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3D\");\nimport Event\t\t\t\t\t\t= require(\"awayjs-core/lib/events/Event\");\nimport AssetType\t\t\t\t\t= require(\"awayjs-core/lib/library/AssetType\");\n\nimport IRenderObject\t\t\t\t= require(\"awayjs-display/lib/pool/IRenderObject\");\nimport IRenderObjectOwner\t\t\t= require(\"awayjs-display/lib/base/IRenderObjectOwner\");\nimport Camera\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\nimport IRenderableOwner\t\t\t\t= require(\"awayjs-display/lib/base/IRenderableOwner\");\nimport MaterialBase\t\t\t\t\t= require(\"awayjs-display/lib/materials/MaterialBase\");\n\nimport Stage\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\n\nimport AnimatorBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport ShaderObjectBase\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport ShaderRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterCache\");\nimport ShaderRegisterData\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterData\");\nimport RenderObjectPool\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/RenderObjectPool\");\nimport RenderPassBase\t\t\t\t= require(\"awayjs-renderergl/lib/passes/RenderPassBase\");\nimport RenderableBase\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\nimport IRenderableClass\t\t\t\t= require(\"awayjs-renderergl/lib/pool/IRenderableClass\");\n\n/**\n *\n * @class away.pool.ScreenPasses\n */\nclass RenderObjectBase implements IRenderObject\n{\n\tpublic _forceSeparateMVP:boolean = false;\n\n\tprivate _pool:RenderObjectPool;\n\tpublic _renderObjectOwner:IRenderObjectOwner;\n\tpublic _renderableClass:IRenderableClass;\n\tpublic _stage:Stage;\n\n\tprivate _renderOrderId:number;\n\tprivate _invalidAnimation:boolean = true;\n\tprivate _invalidRenderObject:boolean = true;\n\tprivate _passes:Array<RenderPassBase> = new Array<RenderPassBase>();\n\n\n\n\tpublic _pRequiresBlending:boolean = false;\n\n\tprivate _onPassChangeDelegate:(event:Event) => void;\n\n\tpublic renderObjectId:number;\n\n\t/**\n\t * Indicates whether or not the renderable requires alpha blending during rendering.\n\t */\n\tpublic get requiresBlending():boolean\n\t{\n\t\treturn this._pRequiresBlending;\n\t}\n\n\tpublic get renderOrderId():number\n\t{\n\t\tif (this._invalidAnimation)\n\t\t\tthis._updateAnimation();\n\n\t\treturn this._renderOrderId;\n\t}\n\n\tpublic get passes():Array<RenderPassBase>\n\t{\n\t\tif (this._invalidAnimation)\n\t\t\tthis._updateAnimation();\n\n\t\treturn this._passes;\n\t}\n\n\tconstructor(pool:RenderObjectPool, renderObjectOwner:IRenderObjectOwner, renderableClass:IRenderableClass, stage:Stage)\n\t{\n\t\tthis._pool = pool;\n\t\tthis.renderObjectId = renderObjectOwner.id;\n\t\tthis._renderObjectOwner = renderObjectOwner;\n\t\tthis._renderableClass = renderableClass;\n\t\tthis._stage = stage;\n\n\n\t\tthis._onPassChangeDelegate = (event:Event) => this.onPassChange(event);\n\t}\n\n\tpublic _iIncludeDependencies(shaderObject:ShaderObjectBase)\n\t{\n\t\tthis._renderableClass._iIncludeDependencies(shaderObject);\n\n\t\tshaderObject.alphaThreshold = this._renderObjectOwner.alphaThreshold;\n\t\tshaderObject.useMipmapping = this._renderObjectOwner.mipmap;\n\t\tshaderObject.useSmoothTextures = this._renderObjectOwner.smooth;\n\n\t\tif (this._renderObjectOwner.assetType = AssetType.MATERIAL) {\n\t\t\tvar material:MaterialBase = <MaterialBase> this._renderObjectOwner;\n\t\t\tshaderObject.useAlphaPremultiplied = material.alphaPremultiplied;\n\t\t\tshaderObject.useBothSides = material.bothSides;\n\t\t\tshaderObject.repeatTextures = material.repeat;\n\t\t\tshaderObject.usesUVTransform = material.animateUVs;\n\t\t\tshaderObject.texture = material.texture;\n\t\t\tshaderObject.color = material.color;\n\t\t}\n\t}\n\n\t/**\n\t *\n\t */\n\tpublic dispose()\n\t{\n\t\tthis._pClearScreenPasses();\n\n\t\tvar len:number = this._passes.length;\n\t\tfor (var i:number = 0; i < len; i++)\n\t\t\tthis._passes[i].dispose();\n\n\t\tthis._passes = null;\n\n\t\tthis._pool.disposeItem(this._renderObjectOwner);\n\t}\n\n\t/**\n\t *\n\t */\n\tpublic invalidateRenderObject()\n\t{\n\t\tthis._invalidRenderObject = true;\n\t\tthis._invalidAnimation = true;\n\t}\n\n\t/**\n\t *\n\t */\n\tpublic invalidatePasses()\n\t{\n\t\tvar len:number = this._passes.length;\n\t\tfor (var i:number = 0; i < len; i++)\n\t\t\tthis._passes[i].invalidatePass();\n\n\t\tthis._invalidAnimation = true;\n\t}\n\n\t/**\n\t *\n\t */\n\tpublic invalidateAnimation()\n\t{\n\t\tthis._invalidAnimation = true;\n\t}\n\n\t/**\n\t *\n\t * @param renderObjectOwner\n\t */\n\tprivate _updateAnimation()\n\t{\n\t\tif (this._invalidRenderObject)\n\t\t\tthis._pUpdateRenderObject();\n\n\t\tthis._invalidAnimation = false;\n\n\t\tvar enabledGPUAnimation:boolean = this._getEnabledGPUAnimation();\n\n\t\tvar renderOrderId = 0;\n\t\tvar mult:number = 1;\n\t\tvar shaderObject:ShaderObjectBase;\n\t\tvar len:number = this._passes.length;\n\t\tfor (var i:number = 0; i < len; i++) {\n\t\t\tshaderObject = this._passes[i].shader;\n\n\t\t\tif (shaderObject.usesAnimation != enabledGPUAnimation) {\n\t\t\t\tshaderObject.usesAnimation = enabledGPUAnimation;\n\t\t\t\tshaderObject.invalidateProgram();\n\t\t\t}\n\n\t\t\trenderOrderId += shaderObject.programData.id*mult;\n\t\t\tmult *= 1000;\n\t\t}\n\n\t\tthis._renderOrderId = renderOrderId;\n\t}\n\n\t/**\n\t * Performs any processing that needs to occur before any of its passes are used.\n\t *\n\t * @private\n\t */\n\tpublic _pUpdateRenderObject()\n\t{\n\t\tthis._invalidRenderObject = false;\n\n\t\t//overrride to update shader object properties\n\t}\n\n\t/**\n\t * Removes a pass from the renderObjectOwner.\n\t * @param pass The pass to be removed.\n\t */\n\tpublic _pRemoveScreenPass(pass:RenderPassBase)\n\t{\n\t\tpass.removeEventListener(Event.CHANGE, this._onPassChangeDelegate);\n\t\tthis._passes.splice(this._passes.indexOf(pass), 1);\n\t}\n\n\t/**\n\t * Removes all passes from the renderObjectOwner\n\t */\n\tpublic _pClearScreenPasses()\n\t{\n\t\tvar len:number = this._passes.length;\n\t\tfor (var i:number = 0; i < len; ++i)\n\t\t\tthis._passes[i].removeEventListener(Event.CHANGE, this._onPassChangeDelegate);\n\n\t\tthis._passes.length = 0;\n\t}\n\n\t/**\n\t * Adds a pass to the renderObjectOwner\n\t * @param pass\n\t */\n\tpublic _pAddScreenPass(pass:RenderPassBase)\n\t{\n\t\tthis._passes.push(pass);\n\t\tpass.addEventListener(Event.CHANGE, this._onPassChangeDelegate);\n\t}\n\n\t/**\n\t * Listener for when a pass's shader code changes. It recalculates the render order id.\n\t */\n\tprivate onPassChange(event:Event)\n\t{\n\t\tthis.invalidateAnimation();\n\t}\n\n\n\t/**\n\t * test if animation will be able to run on gpu BEFORE compiling materials\n\t * test if the shader objects supports animating the animation set in the vertex shader\n\t * if any object using this material fails to support accelerated animations for any of the shader objects,\n\t * we should do everything on cpu (otherwise we have the cost of both gpu + cpu animations)\n\t */\n\tprivate _getEnabledGPUAnimation():boolean\n\t{\n\t\tif (this._renderObjectOwner.animationSet) {\n\t\t\tthis._renderObjectOwner.animationSet.resetGPUCompatibility();\n\n\t\t\tvar owners:Array<IRenderableOwner> = this._renderObjectOwner.iOwners;\n\t\t\tvar numOwners:number = owners.length;\n\n\t\t\tvar len:number = this._passes.length;\n\t\t\tfor (var i:number = 0; i < len; i++)\n\t\t\t\tfor (var j:number = 0; j < numOwners; j++)\n\t\t\t\t\tif (owners[j].animator)\n\t\t\t\t\t\t(<AnimatorBase> owners[j].animator).testGPUCompatibility(this._passes[i].shader);\n\n\t\t\treturn !this._renderObjectOwner.animationSet.usesCPU;\n\t\t}\n\n\t\treturn false;\n\t}\n}\n\nexport = RenderObjectBase;","import IRenderObjectOwner\t\t\t= require(\"awayjs-display/lib/base/IRenderObjectOwner\");\n\nimport Stage\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\n\nimport IRenderObjectClass\t\t\t= require(\"awayjs-renderergl/lib/compilation/IRenderObjectClass\");\nimport RenderObjectBase\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/RenderObjectBase\");\nimport IRenderableClass\t\t\t\t= require(\"awayjs-renderergl/lib/pool/IRenderableClass\");\nimport RenderableBase\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\n\n/**\n * @class away.pool.RenderObjectPool\n */\nclass RenderObjectPool\n{\n\tprivate _renderObjectPool:Object = new Object();\n\tprivate _renderObjectClass:IRenderObjectClass;\n\tprivate _renderableClass:IRenderableClass;\n\tprivate _stage:Stage;\n\n\t/**\n\t * //TODO\n\t *\n\t * @param renderObjectClass\n\t */\n\tconstructor(renderObjectClass:IRenderObjectClass, renderableClass:IRenderableClass, stage:Stage)\n\t{\n\t\tthis._renderObjectClass = renderObjectClass;\n\t\tthis._renderableClass = renderableClass;\n\t\tthis._stage = stage;\n\t}\n\n\t/**\n\t * //TODO\n\t *\n\t * @param renderableOwner\n\t * @returns IRenderable\n\t */\n\tpublic getItem(renderObjectOwner:IRenderObjectOwner):RenderObjectBase\n\t{\n\t\treturn (this._renderObjectPool[renderObjectOwner.id] || (this._renderObjectPool[renderObjectOwner.id] = renderObjectOwner._iAddRenderObject(new this._renderObjectClass(this, renderObjectOwner, this._renderableClass, this._stage))))\n\t}\n\n\t/**\n\t * //TODO\n\t *\n\t * @param renderableOwner\n\t */\n\tpublic disposeItem(renderObjectOwner:IRenderObjectOwner)\n\t{\n\t\trenderObjectOwner._iRemoveRenderObject(this._renderObjectPool[renderObjectOwner.id]);\n\n\t\tthis._renderObjectPool[renderObjectOwner.id] = null;\n\t}\n}\n\nexport = RenderObjectPool;","import AnimationSetBase\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimationSetBase\");\nimport RenderableBase\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\nimport ShaderObjectBase\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport ShaderRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterCache\");\nimport ShaderRegisterData\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterData\");\nimport ShaderRegisterElement\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\nimport IRenderPassBase\t\t\t\t= require(\"awayjs-renderergl/lib/passes/IRenderPassBase\");\nimport IRenderableClass\t\t\t\t= require(\"awayjs-renderergl/lib/pool/IRenderableClass\");\n\n/**\n * ShaderCompilerBase is an abstract base class for shader compilers that use modular shader methods to assemble a\n * material. Concrete subclasses are used by the default materials.\n *\n * @see away.materials.ShadingMethodBase\n */\nclass ShaderCompilerBase\n{\n\tpublic _pShaderObject:ShaderObjectBase;\n\tpublic _pSharedRegisters:ShaderRegisterData;\n\tpublic _pRegisterCache:ShaderRegisterCache;\n\tpublic _pRenderableClass:IRenderableClass;\n\tpublic _pRenderPass:IRenderPassBase;\n\n\tpublic _pVertexCode:string = ''; // Changed to emtpy string- AwayTS\n\tpublic _pFragmentCode:string = '';// Changed to emtpy string - AwayTS\n\tpublic _pPostAnimationFragmentCode:string = '';// Changed to emtpy string - AwayTS\n\n\t//The attributes that need to be animated by animators.\n\tpublic _pAnimatableAttributes:Array<string>;\n\n\t//The target registers for animated properties, written to by the animators.\n\tpublic _pAnimationTargetRegisters:Array<string>;\n\n\t//The target register to place the animated UV coordinate.\n\tprivate _uvTarget:string;\n\n\t//The souce register providing the UV coordinate to animate.\n\tprivate _uvSource:string;\n\n\t/**\n\t * Creates a new ShaderCompilerBase object.\n\t * @param profile The compatibility profile of the renderer.\n\t */\n\tconstructor(renderableClass:IRenderableClass, renderPass:IRenderPassBase, shaderObject:ShaderObjectBase)\n\t{\n\t\tthis._pRenderableClass = renderableClass;\n\t\tthis._pRenderPass = renderPass;\n\t\tthis._pShaderObject = shaderObject;\n\n\t\tthis._pSharedRegisters = new ShaderRegisterData();\n\n\t\tthis._pRegisterCache = new ShaderRegisterCache(shaderObject.profile);\n\t\tthis._pRegisterCache.vertexAttributesOffset = renderableClass.vertexAttributesOffset;\n\t\tthis._pRegisterCache.reset();\n\t}\n\n\t/**\n\t * Compiles the code after all setup on the compiler has finished.\n\t */\n\tpublic compile()\n\t{\n\t\tthis._pShaderObject.reset();\n\n\t\tthis.pIncludeDependencies();\n\n\t\tthis.pInitRegisterIndices();\n\n\t\tthis.pCompileDependencies();\n\n\t\t//compile custom vertex & fragment codes\n\t\tthis._pVertexCode += this._pRenderPass._iGetVertexCode(this._pShaderObject, this._pRegisterCache, this._pSharedRegisters);\n\t\tthis._pPostAnimationFragmentCode += this._pRenderPass._iGetFragmentCode(this._pShaderObject, this._pRegisterCache, this._pSharedRegisters);\n\n\t\t//assign the final output color to the output register\n\t\tthis._pPostAnimationFragmentCode += \"mov \" + this._pRegisterCache.fragmentOutputRegister + \", \" + this._pSharedRegisters.shadedTarget + \"\\n\";\n\t\tthis._pRegisterCache.removeFragmentTempUsage(this._pSharedRegisters.shadedTarget);\n\n\t\t//initialise the required shader constants\n\t\tthis._pShaderObject.initConstantData(this._pRegisterCache, this._pAnimatableAttributes, this._pAnimationTargetRegisters, this._uvSource, this._uvTarget);\n\t\tthis._pRenderPass._iInitConstantData(this._pShaderObject);\n\t}\n\n\tpublic pIncludeDependencies()\n\t{\n\t\tthis._pShaderObject._iIncludeDependencies();\n\n\t\tthis._pShaderObject.outputsNormals = this._pRenderPass._pOutputsNormals(this._pShaderObject);\n\t\tthis._pShaderObject.outputsTangentNormals = this._pShaderObject.outputsNormals && this._pRenderPass._pOutputsTangentNormals(this._pShaderObject);\n\t\tthis._pShaderObject.usesTangentSpace = this._pShaderObject.outputsTangentNormals && this._pRenderPass._pUsesTangentSpace(this._pShaderObject);\n\n\t\tif (!this._pShaderObject.usesTangentSpace && this._pShaderObject.viewDirDependencies > 0)\n\t\t\tthis._pShaderObject.globalPosDependencies++;\n\t}\n\n\t/**\n\t * Compile the code for the methods.\n\t */\n\tpublic pCompileDependencies()\n\t{\n\t\tthis._pSharedRegisters.shadedTarget = this._pRegisterCache.getFreeFragmentVectorTemp();\n\t\tthis._pRegisterCache.addFragmentTempUsages(this._pSharedRegisters.shadedTarget, 1);\n\n\t\t//compile the world-space position if required\n\t\tif (this._pShaderObject.globalPosDependencies > 0)\n\t\t\tthis.compileGlobalPositionCode();\n\n\t\t//Calculate the (possibly animated) UV coordinates.\n\t\tif (this._pShaderObject.uvDependencies > 0)\n\t\t\tthis.compileUVCode();\n\n\t\tif (this._pShaderObject.secondaryUVDependencies > 0)\n\t\t\tthis.compileSecondaryUVCode();\n\n\t\tif (this._pShaderObject.normalDependencies > 0)\n\t\t\tthis.compileNormalCode();\n\n\t\tif (this._pShaderObject.viewDirDependencies > 0)\n\t\t\tthis.compileViewDirCode();\n\n\t\t//collect code from material\n\t\tthis._pVertexCode += this._pRenderableClass._iGetVertexCode(this._pShaderObject, this._pRegisterCache, this._pSharedRegisters);\n\t\tthis._pFragmentCode += this._pRenderableClass._iGetFragmentCode(this._pShaderObject, this._pRegisterCache, this._pSharedRegisters);\n\n\t\t//collect code from pass\n\t\tthis._pVertexCode += this._pRenderPass._iGetPreLightingVertexCode(this._pShaderObject, this._pRegisterCache, this._pSharedRegisters);\n\t\tthis._pFragmentCode += this._pRenderPass._iGetPreLightingFragmentCode(this._pShaderObject, this._pRegisterCache, this._pSharedRegisters);\n\t}\n\n\tprivate compileGlobalPositionCode()\n\t{\n\t\tthis._pRegisterCache.addVertexTempUsages(this._pSharedRegisters.globalPositionVertex = this._pRegisterCache.getFreeVertexVectorTemp(), this._pShaderObject.globalPosDependencies);\n\n\t\tvar sceneMatrixReg:ShaderRegisterElement = this._pRegisterCache.getFreeVertexConstant();\n\t\tthis._pRegisterCache.getFreeVertexConstant();\n\t\tthis._pRegisterCache.getFreeVertexConstant();\n\t\tthis._pRegisterCache.getFreeVertexConstant();\n\n\t\tthis._pShaderObject.sceneMatrixIndex = sceneMatrixReg.index*4;\n\n\t\tthis._pVertexCode += \"m44 \" + this._pSharedRegisters.globalPositionVertex + \", \" + this._pSharedRegisters.localPosition + \", \" + sceneMatrixReg + \"\\n\";\n\n\t\tif (this._pShaderObject.usesGlobalPosFragment) {\n\t\t\tthis._pSharedRegisters.globalPositionVarying = this._pRegisterCache.getFreeVarying();\n\t\t\tthis._pVertexCode += \"mov \" + this._pSharedRegisters.globalPositionVarying + \", \" + this._pSharedRegisters.globalPositionVertex + \"\\n\";\n\t\t}\n\t}\n\n\t/**\n\t * Calculate the (possibly animated) UV coordinates.\n\t */\n\tprivate compileUVCode()\n\t{\n\t\tvar uvAttributeReg:ShaderRegisterElement = this._pRegisterCache.getFreeVertexAttribute();\n\t\tthis._pShaderObject.uvBufferIndex = uvAttributeReg.index;\n\n\t\tvar varying:ShaderRegisterElement = this._pRegisterCache.getFreeVarying();\n\n\t\tthis._pSharedRegisters.uvVarying = varying;\n\n\t\tif (this._pShaderObject.usesUVTransform) {\n\t\t\t// a, b, 0, tx\n\t\t\t// c, d, 0, ty\n\t\t\tvar uvTransform1:ShaderRegisterElement = this._pRegisterCache.getFreeVertexConstant();\n\t\t\tvar uvTransform2:ShaderRegisterElement = this._pRegisterCache.getFreeVertexConstant();\n\t\t\tthis._pShaderObject.uvTransformIndex = uvTransform1.index*4;\n\n\t\t\tthis._pVertexCode += \"dp4 \" + varying + \".x, \" + uvAttributeReg + \", \" + uvTransform1 + \"\\n\" +\n\t\t\t\t\t\t\t\t \"dp4 \" + varying + \".y, \" + uvAttributeReg + \", \" + uvTransform2 + \"\\n\" +\n\t\t\t\t\t\t\t\t \"mov \" + varying + \".zw, \" + uvAttributeReg + \".zw \\n\";\n\t\t} else {\n\t\t\tthis._pShaderObject.uvTransformIndex = -1;\n\t\t\tthis._uvTarget = varying.toString();\n\t\t\tthis._uvSource = uvAttributeReg.toString();\n\t\t}\n\t}\n\n\t/**\n\t * Provide the secondary UV coordinates.\n\t */\n\tprivate compileSecondaryUVCode()\n\t{\n\t\tvar uvAttributeReg:ShaderRegisterElement = this._pRegisterCache.getFreeVertexAttribute();\n\t\tthis._pShaderObject.secondaryUVBufferIndex = uvAttributeReg.index;\n\t\tthis._pSharedRegisters.secondaryUVVarying = this._pRegisterCache.getFreeVarying();\n\t\tthis._pVertexCode += \"mov \" + this._pSharedRegisters.secondaryUVVarying + \", \" + uvAttributeReg + \"\\n\";\n\t}\n\n\t/**\n\t * Calculate the view direction.\n\t */\n\tpublic compileViewDirCode()\n\t{\n\t\tvar cameraPositionReg:ShaderRegisterElement = this._pRegisterCache.getFreeVertexConstant();\n\t\tthis._pSharedRegisters.viewDirVarying = this._pRegisterCache.getFreeVarying();\n\t\tthis._pSharedRegisters.viewDirFragment = this._pRegisterCache.getFreeFragmentVectorTemp();\n\t\tthis._pRegisterCache.addFragmentTempUsages(this._pSharedRegisters.viewDirFragment, this._pShaderObject.viewDirDependencies);\n\n\t\tthis._pShaderObject.cameraPositionIndex = cameraPositionReg.index*4;\n\n\t\tif (this._pShaderObject.usesTangentSpace) {\n\t\t\tvar temp:ShaderRegisterElement = this._pRegisterCache.getFreeVertexVectorTemp();\n\t\t\tthis._pVertexCode += \"sub \" + temp + \", \" + cameraPositionReg + \", \" + this._pSharedRegisters.localPosition + \"\\n\" +\n\t\t\t\t\"m33 \" + this._pSharedRegisters.viewDirVarying + \".xyz, \" + temp + \", \" + this._pSharedRegisters.animatedTangent + \"\\n\" +\n\t\t\t\t\"mov \" + this._pSharedRegisters.viewDirVarying + \".w, \" + this._pSharedRegisters.localPosition + \".w\\n\";\n\t\t} else {\n\t\t\tthis._pVertexCode += \"sub \" + this._pSharedRegisters.viewDirVarying + \", \" + cameraPositionReg + \", \" + this._pSharedRegisters.globalPositionVertex + \"\\n\";\n\t\t\tthis._pRegisterCache.removeVertexTempUsage(this._pSharedRegisters.globalPositionVertex);\n\t\t}\n\n\t\t//TODO is this required in all cases? (re: distancemappass)\n\t\tthis._pFragmentCode += \"nrm \" + this._pSharedRegisters.viewDirFragment + \".xyz, \" + this._pSharedRegisters.viewDirVarying + \"\\n\" +\n\t\t\t\"mov \" + this._pSharedRegisters.viewDirFragment + \".w,   \" + this._pSharedRegisters.viewDirVarying + \".w\\n\";\n\t}\n\n\t/**\n\t * Calculate the normal.\n\t */\n\tpublic compileNormalCode()\n\t{\n\t\tthis._pSharedRegisters.normalFragment = this._pRegisterCache.getFreeFragmentVectorTemp();\n\t\tthis._pRegisterCache.addFragmentTempUsages(this._pSharedRegisters.normalFragment, this._pShaderObject.normalDependencies);\n\n\t\t//simple normal aquisition if no tangent space is being used\n\t\tif (this._pShaderObject.outputsNormals && !this._pShaderObject.outputsTangentNormals) {\n\t\t\tthis._pVertexCode += this._pRenderPass._iGetNormalVertexCode(this._pShaderObject, this._pRegisterCache, this._pSharedRegisters);\n\t\t\tthis._pFragmentCode += this._pRenderPass._iGetNormalFragmentCode(this._pShaderObject, this._pRegisterCache, this._pSharedRegisters);\n\n\t\t\treturn;\n\t\t}\n\n\t\tvar normalMatrix:Array<ShaderRegisterElement>;\n\n\t\tif (!this._pShaderObject.outputsNormals || !this._pShaderObject.usesTangentSpace) {\n\t\t\tnormalMatrix = new Array<ShaderRegisterElement>(3);\n\t\t\tnormalMatrix[0] = this._pRegisterCache.getFreeVertexConstant();\n\t\t\tnormalMatrix[1] = this._pRegisterCache.getFreeVertexConstant();\n\t\t\tnormalMatrix[2] = this._pRegisterCache.getFreeVertexConstant();\n\n\t\t\tthis._pRegisterCache.getFreeVertexConstant();\n\n\t\t\tthis._pShaderObject.sceneNormalMatrixIndex = normalMatrix[0].index*4;\n\n\t\t\tthis._pSharedRegisters.normalVarying = this._pRegisterCache.getFreeVarying();\n\t\t}\n\n\t\tif (this._pShaderObject.outputsNormals) {\n\t\t\tif (this._pShaderObject.usesTangentSpace) {\n\t\t\t\t// normalize normal + tangent vector and generate (approximated) bitangent used in m33 operation for view\n\t\t\t\tthis._pVertexCode += \"nrm \" + this._pSharedRegisters.animatedNormal + \".xyz, \" + this._pSharedRegisters.animatedNormal + \"\\n\" +\n\t\t\t\t\t\"nrm \" + this._pSharedRegisters.animatedTangent + \".xyz, \" + this._pSharedRegisters.animatedTangent + \"\\n\" +\n\t\t\t\t\t\"crs \" + this._pSharedRegisters.bitangent + \".xyz, \" + this._pSharedRegisters.animatedNormal + \", \" + this._pSharedRegisters.animatedTangent + \"\\n\";\n\n\t\t\t\tthis._pFragmentCode += this._pRenderPass._iGetNormalFragmentCode(this._pShaderObject, this._pRegisterCache, this._pSharedRegisters);\n\t\t\t} else {\n\t\t\t\t//Compiles the vertex shader code for tangent-space normal maps.\n\t\t\t\tthis._pSharedRegisters.tangentVarying = this._pRegisterCache.getFreeVarying();\n\t\t\t\tthis._pSharedRegisters.bitangentVarying = this._pRegisterCache.getFreeVarying();\n\t\t\t\tvar temp:ShaderRegisterElement = this._pRegisterCache.getFreeVertexVectorTemp();\n\n\t\t\t\tthis._pVertexCode += \"m33 \" + temp + \".xyz, \" + this._pSharedRegisters.animatedNormal + \", \" + normalMatrix[0] + \"\\n\" +\n\t\t\t\t\t\"nrm \" + this._pSharedRegisters.animatedNormal + \".xyz, \" + temp + \"\\n\" +\n\t\t\t\t\t\"m33 \" + temp + \".xyz, \" + this._pSharedRegisters.animatedTangent + \", \" + normalMatrix[0] + \"\\n\" +\n\t\t\t\t\t\"nrm \" + this._pSharedRegisters.animatedTangent + \".xyz, \" + temp + \"\\n\" +\n\t\t\t\t\t\"mov \" + this._pSharedRegisters.tangentVarying + \".x, \" + this._pSharedRegisters.animatedTangent + \".x  \\n\" +\n\t\t\t\t\t\"mov \" + this._pSharedRegisters.tangentVarying + \".z, \" + this._pSharedRegisters.animatedNormal + \".x  \\n\" +\n\t\t\t\t\t\"mov \" + this._pSharedRegisters.tangentVarying + \".w, \" + this._pSharedRegisters.normalInput + \".w  \\n\" +\n\t\t\t\t\t\"mov \" + this._pSharedRegisters.bitangentVarying + \".x, \" + this._pSharedRegisters.animatedTangent + \".y  \\n\" +\n\t\t\t\t\t\"mov \" + this._pSharedRegisters.bitangentVarying + \".z, \" + this._pSharedRegisters.animatedNormal + \".y  \\n\" +\n\t\t\t\t\t\"mov \" + this._pSharedRegisters.bitangentVarying + \".w, \" + this._pSharedRegisters.normalInput + \".w  \\n\" +\n\t\t\t\t\t\"mov \" + this._pSharedRegisters.normalVarying + \".x, \" + this._pSharedRegisters.animatedTangent + \".z  \\n\" +\n\t\t\t\t\t\"mov \" + this._pSharedRegisters.normalVarying + \".z, \" + this._pSharedRegisters.animatedNormal + \".z  \\n\" +\n\t\t\t\t\t\"mov \" + this._pSharedRegisters.normalVarying + \".w, \" + this._pSharedRegisters.normalInput + \".w  \\n\" +\n\t\t\t\t\t\"crs \" + temp + \".xyz, \" + this._pSharedRegisters.animatedNormal + \", \" + this._pSharedRegisters.animatedTangent + \"\\n\" +\n\t\t\t\t\t\"mov \" + this._pSharedRegisters.tangentVarying + \".y, \" + temp + \".x    \\n\" +\n\t\t\t\t\t\"mov \" + this._pSharedRegisters.bitangentVarying + \".y, \" + temp + \".y  \\n\" +\n\t\t\t\t\t\"mov \" + this._pSharedRegisters.normalVarying + \".y, \" + temp + \".z    \\n\";\n\n\t\t\t\tthis._pRegisterCache.removeVertexTempUsage(this._pSharedRegisters.animatedTangent);\n\n\t\t\t\t//Compiles the fragment shader code for tangent-space normal maps.\n\t\t\t\tvar t:ShaderRegisterElement;\n\t\t\t\tvar b:ShaderRegisterElement;\n\t\t\t\tvar n:ShaderRegisterElement;\n\n\t\t\t\tt = this._pRegisterCache.getFreeFragmentVectorTemp();\n\t\t\t\tthis._pRegisterCache.addFragmentTempUsages(t, 1);\n\t\t\t\tb = this._pRegisterCache.getFreeFragmentVectorTemp();\n\t\t\t\tthis._pRegisterCache.addFragmentTempUsages(b, 1);\n\t\t\t\tn = this._pRegisterCache.getFreeFragmentVectorTemp();\n\t\t\t\tthis._pRegisterCache.addFragmentTempUsages(n, 1);\n\n\t\t\t\tthis._pFragmentCode += \"nrm \" + t + \".xyz, \" + this._pSharedRegisters.tangentVarying + \"\\n\" +\n\t\t\t\t\t\"mov \" + t + \".w, \" + this._pSharedRegisters.tangentVarying + \".w\t\\n\" +\n\t\t\t\t\t\"nrm \" + b + \".xyz, \" + this._pSharedRegisters.bitangentVarying + \"\\n\" +\n\t\t\t\t\t\"nrm \" + n + \".xyz, \" + this._pSharedRegisters.normalVarying + \"\\n\";\n\n\t\t\t\t//compile custom fragment code for normal calcs\n\t\t\t\tthis._pFragmentCode += this._pRenderPass._iGetNormalFragmentCode(this._pShaderObject, this._pRegisterCache, this._pSharedRegisters) +\n\t\t\t\t\t\"m33 \" + this._pSharedRegisters.normalFragment + \".xyz, \" + this._pSharedRegisters.normalFragment + \", \" + t + \"\\n\" +\n\t\t\t\t\t\"mov \" + this._pSharedRegisters.normalFragment + \".w, \" + this._pSharedRegisters.normalVarying + \".w\\n\";\n\n\t\t\t\tthis._pRegisterCache.removeFragmentTempUsage(b);\n\t\t\t\tthis._pRegisterCache.removeFragmentTempUsage(t);\n\t\t\t\tthis._pRegisterCache.removeFragmentTempUsage(n);\n\t\t\t}\n\t\t} else {\n\t\t\t// no output, world space is enough\n\t\t\tthis._pVertexCode += \"m33 \" + this._pSharedRegisters.normalVarying + \".xyz, \" + this._pSharedRegisters.animatedNormal + \", \" + normalMatrix[0] + \"\\n\" +\n\t\t\t\t\"mov \" + this._pSharedRegisters.normalVarying + \".w, \" + this._pSharedRegisters.animatedNormal + \".w\\n\";\n\n\t\t\tthis._pFragmentCode += \"nrm \" + this._pSharedRegisters.normalFragment + \".xyz, \" + this._pSharedRegisters.normalVarying + \"\\n\" +\n\t\t\t\t\"mov \" + this._pSharedRegisters.normalFragment + \".w, \" + this._pSharedRegisters.normalVarying + \".w\\n\";\n\n\t\t\tif (this._pShaderObject.tangentDependencies > 0) {\n\t\t\t\tthis._pSharedRegisters.tangentVarying = this._pRegisterCache.getFreeVarying();\n\n\t\t\t\tthis._pVertexCode += \"m33 \" + this._pSharedRegisters.tangentVarying + \".xyz, \" + this._pSharedRegisters.animatedTangent + \", \" + normalMatrix[0] + \"\\n\" +\n\t\t\t\t\t\"mov \" + this._pSharedRegisters.tangentVarying + \".w, \" + this._pSharedRegisters.animatedTangent + \".w\\n\";\n\t\t\t}\n\t\t}\n\n\t\tif (!this._pShaderObject.usesTangentSpace)\n\t\t\tthis._pRegisterCache.removeVertexTempUsage(this._pSharedRegisters.animatedNormal);\n\t}\n\n\t/**\n\t * Reset all the indices to \"unused\".\n\t */\n\tpublic pInitRegisterIndices()\n\t{\n\t\tthis._pShaderObject.pInitRegisterIndices();\n\n\t\tthis._pAnimatableAttributes = new Array<string>(\"va0\");\n\t\tthis._pAnimationTargetRegisters = new Array<string>(\"vt0\");\n\t\tthis._pVertexCode = \"\";\n\t\tthis._pFragmentCode = \"\";\n\t\tthis._pPostAnimationFragmentCode = \"\";\n\n\t\tthis._pRegisterCache.addVertexTempUsages(this._pSharedRegisters.localPosition = this._pRegisterCache.getFreeVertexVectorTemp(), 1);\n\n\t\t//create commonly shared constant registers\n\t\tthis._pSharedRegisters.commons = this._pRegisterCache.getFreeFragmentConstant();\n\t\tthis._pShaderObject.commonsDataIndex = this._pSharedRegisters.commons.index*4;\n\n\t\t//Creates the registers to contain the tangent data.\n\t\t// need to be created FIRST and in this order (for when using tangent space)\n\t\tif (this._pShaderObject.tangentDependencies > 0 || this._pShaderObject.outputsNormals) {\n\t\t\tthis._pSharedRegisters.tangentInput = this._pRegisterCache.getFreeVertexAttribute();\n\t\t\tthis._pShaderObject.tangentBufferIndex = this._pSharedRegisters.tangentInput.index;\n\n\t\t\tthis._pSharedRegisters.animatedTangent = this._pRegisterCache.getFreeVertexVectorTemp();\n\t\t\tthis._pRegisterCache.addVertexTempUsages(this._pSharedRegisters.animatedTangent, 1);\n\n\t\t\tif (this._pShaderObject.usesTangentSpace) {\n\t\t\t\tthis._pSharedRegisters.bitangent = this._pRegisterCache.getFreeVertexVectorTemp();\n\t\t\t\tthis._pRegisterCache.addVertexTempUsages(this._pSharedRegisters.bitangent, 1);\n\t\t\t}\n\n\t\t\tthis._pAnimatableAttributes.push(this._pSharedRegisters.tangentInput.toString());\n\t\t\tthis._pAnimationTargetRegisters.push(this._pSharedRegisters.animatedTangent.toString());\n\t\t}\n\n\t\tif (this._pShaderObject.normalDependencies > 0) {\n\t\t\tthis._pSharedRegisters.normalInput = this._pRegisterCache.getFreeVertexAttribute();\n\t\t\tthis._pShaderObject.normalBufferIndex = this._pSharedRegisters.normalInput.index;\n\n\t\t\tthis._pSharedRegisters.animatedNormal = this._pRegisterCache.getFreeVertexVectorTemp();\n\t\t\tthis._pRegisterCache.addVertexTempUsages(this._pSharedRegisters.animatedNormal, 1);\n\n\t\t\tthis._pAnimatableAttributes.push(this._pSharedRegisters.normalInput.toString());\n\t\t\tthis._pAnimationTargetRegisters.push(this._pSharedRegisters.animatedNormal.toString());\n\t\t}\n\n\t\tif (this._pShaderObject.colorDependencies > 0) {\n\t\t\tthis._pSharedRegisters.colorInput = this._pRegisterCache.getFreeVertexAttribute();\n\t\t\tthis._pShaderObject.colorBufferIndex = this._pSharedRegisters.colorInput.index;\n\n\t\t\tthis._pSharedRegisters.colorVarying = this._pRegisterCache.getFreeVarying();\n\t\t\tthis._pVertexCode += \"mov \" + this._pSharedRegisters.colorVarying + \", \" + this._pSharedRegisters.colorInput + \"\\n\";\n\t\t}\n\t}\n\n\t/**\n\t * Disposes all resources used by the compiler.\n\t */\n\tpublic dispose()\n\t{\n\t\tthis._pRegisterCache.dispose();\n\t\tthis._pRegisterCache = null;\n\t\tthis._pSharedRegisters = null;\n\t}\n\n\t/**\n\t * The generated vertex code.\n\t */\n\tpublic get vertexCode():string\n\t{\n\t\treturn this._pVertexCode;\n\t}\n\n\t/**\n\t * The generated fragment code.\n\t */\n\tpublic get fragmentCode():string\n\t{\n\t\treturn this._pFragmentCode;\n\t}\n\n\t/**\n\t * The generated fragment code.\n\t */\n\tpublic get postAnimationFragmentCode():string\n\t{\n\t\treturn this._pPostAnimationFragmentCode;\n\t}\n\n\t/**\n\t * The register name containing the final shaded colour.\n\t */\n\tpublic get shadedTarget():string\n\t{\n\t\treturn this._pSharedRegisters.shadedTarget.toString();\n\t}\n}\n\nexport = ShaderCompilerBase;","import ContextGLProfile\t\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLProfile\");\n\nimport ShaderLightingObject\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderLightingObject\");\nimport ShaderCompilerBase\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderCompilerBase\");\nimport ShaderRegisterElement\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\nimport IRenderLightingPass\t\t= require(\"awayjs-renderergl/lib/passes/IRenderLightingPass\");\nimport IRenderableClass\t\t\t\t= require(\"awayjs-renderergl/lib/pool/IRenderableClass\");\n\n/**\n * ShaderCompilerBase is an abstract base class for shader compilers that use modular shader methods to assemble a\n * material. Concrete subclasses are used by the default materials.\n *\n * @see away.materials.ShadingMethodBase\n */\nclass ShaderLightingCompiler extends ShaderCompilerBase\n{\n\tprivate _shaderLightingObject:ShaderLightingObject;\n\tprivate _renderLightingPass:IRenderLightingPass;\n\tpublic _pointLightFragmentConstants:Array<ShaderRegisterElement>;\n\tpublic _pointLightVertexConstants:Array<ShaderRegisterElement>;\n\tpublic _dirLightFragmentConstants:Array<ShaderRegisterElement>;\n\tpublic _dirLightVertexConstants:Array<ShaderRegisterElement>;\n\n\tpublic _pNumProbeRegisters:number;\n\n\t/**\n\t * Creates a new ShaderCompilerBase object.\n\t * @param profile The compatibility profile of the renderer.\n\t */\n\tconstructor(renderableClass:IRenderableClass, renderLightingPass:IRenderLightingPass, shaderLightingObject:ShaderLightingObject)\n\t{\n\t\tsuper(renderableClass, renderLightingPass, shaderLightingObject);\n\n\t\tthis._shaderLightingObject = shaderLightingObject;\n\t\tthis._renderLightingPass = renderLightingPass;\n\t}\n\n\t/**\n\t * Compile the code for the methods.\n\t */\n\tpublic pCompileDependencies()\n\t{\n\t\tsuper.pCompileDependencies();\n\n\t\t//compile the lighting code\n\t\tif (this._shaderLightingObject.usesShadows)\n\t\t\tthis.pCompileShadowCode();\n\n\t\tif (this._shaderLightingObject.usesLights) {\n\t\t\tthis.initLightRegisters();\n\t\t\tthis.compileLightCode();\n\t\t}\n\n\t\tif (this._shaderLightingObject.usesProbes)\n\t\t\tthis.compileLightProbeCode();\n\n\t\tthis._pVertexCode += this._renderLightingPass._iGetPostLightingVertexCode(this._shaderLightingObject, this._pRegisterCache, this._pSharedRegisters);\n\t\tthis._pFragmentCode += this._renderLightingPass._iGetPostLightingFragmentCode(this._shaderLightingObject, this._pRegisterCache, this._pSharedRegisters);\n\t}\n\n\t/**\n\t * Provides the code to provide shadow mapping.\n\t */\n\tpublic pCompileShadowCode()\n\t{\n\t\tif (this._shaderLightingObject.normalDependencies > 0) {\n\t\t\tthis._pSharedRegisters.shadowTarget = this._pSharedRegisters.normalFragment;\n\t\t} else {\n\t\t\tthis._pSharedRegisters.shadowTarget = this._pRegisterCache.getFreeFragmentVectorTemp();\n\t\t\tthis._pRegisterCache.addFragmentTempUsages(this._pSharedRegisters.shadowTarget, 1);\n\t\t}\n\t}\n\n\t/**\n\t * Initializes constant registers to contain light data.\n\t */\n\tprivate initLightRegisters()\n\t{\n\t\t// init these first so we're sure they're in sequence\n\t\tvar i:number, len:number;\n\n\t\tif (this._dirLightVertexConstants) {\n\t\t\tlen = this._dirLightVertexConstants.length;\n\t\t\tfor (i = 0; i < len; ++i) {\n\t\t\t\tthis._dirLightVertexConstants[i] = this._pRegisterCache.getFreeVertexConstant();\n\n\t\t\t\tif (this._shaderLightingObject.lightVertexConstantIndex == -1)\n\t\t\t\t\tthis._shaderLightingObject.lightVertexConstantIndex = this._dirLightVertexConstants[i].index*4;\n\t\t\t}\n\t\t}\n\n\t\tif (this._pointLightVertexConstants) {\n\t\t\tlen = this._pointLightVertexConstants.length;\n\t\t\tfor (i = 0; i < len; ++i) {\n\t\t\t\tthis._pointLightVertexConstants[i] = this._pRegisterCache.getFreeVertexConstant();\n\n\t\t\t\tif (this._shaderLightingObject.lightVertexConstantIndex == -1)\n\t\t\t\t\tthis._shaderLightingObject.lightVertexConstantIndex = this._pointLightVertexConstants[i].index*4;\n\t\t\t}\n\t\t}\n\n\t\tlen = this._dirLightFragmentConstants.length;\n\t\tfor (i = 0; i < len; ++i) {\n\t\t\tthis._dirLightFragmentConstants[i] = this._pRegisterCache.getFreeFragmentConstant();\n\n\t\t\tif (this._shaderLightingObject.lightFragmentConstantIndex == -1)\n\t\t\t\tthis._shaderLightingObject.lightFragmentConstantIndex = this._dirLightFragmentConstants[i].index*4;\n\t\t}\n\n\t\tlen = this._pointLightFragmentConstants.length;\n\t\tfor (i = 0; i < len; ++i) {\n\t\t\tthis._pointLightFragmentConstants[i] = this._pRegisterCache.getFreeFragmentConstant();\n\n\t\t\tif (this._shaderLightingObject.lightFragmentConstantIndex == -1)\n\t\t\t\tthis._shaderLightingObject.lightFragmentConstantIndex = this._pointLightFragmentConstants[i].index*4;\n\t\t}\n\t}\n\n\t/**\n\t * Compiles the shading code for directional and point lights.\n\t */\n\tprivate compileLightCode()\n\t{\n\t\tvar diffuseColorReg:ShaderRegisterElement;\n\t\tvar specularColorReg:ShaderRegisterElement;\n\t\tvar lightPosReg:ShaderRegisterElement;\n\t\tvar lightDirReg:ShaderRegisterElement;\n\t\tvar vertexRegIndex:number = 0;\n\t\tvar fragmentRegIndex:number = 0;\n\t\tvar addSpec:boolean = this._shaderLightingObject.usesLightsForSpecular;\n\t\tvar addDiff:boolean = this._shaderLightingObject.usesLightsForDiffuse;\n\n\t\t//compile the shading code for directional lights.\n\t\tfor (var i:number = 0; i < this._shaderLightingObject.numDirectionalLights; ++i) {\n\t\t\tif (this._shaderLightingObject.usesTangentSpace) {\n\t\t\t\tlightDirReg = this._dirLightVertexConstants[vertexRegIndex++];\n\n\t\t\t\tvar lightVarying:ShaderRegisterElement = this._pRegisterCache.getFreeVarying();\n\n\t\t\t\tthis._pVertexCode += \"m33 \" + lightVarying + \".xyz, \" + lightDirReg + \", \" + this._pSharedRegisters.animatedTangent + \"\\n\" +\n\t\t\t\t\t\"mov \" + lightVarying + \".w, \" + lightDirReg + \".w\\n\";\n\n\t\t\t\tlightDirReg = this._pRegisterCache.getFreeFragmentVectorTemp();\n\t\t\t\tthis._pRegisterCache.addVertexTempUsages(lightDirReg, 1);\n\n\t\t\t\tthis._pFragmentCode += \"nrm \" + lightDirReg + \".xyz, \" + lightVarying + \"\\n\" +\n\t\t\t\t\t\"mov \" + lightDirReg + \".w, \" + lightVarying + \".w\\n\";\n\n\t\t\t} else {\n\t\t\t\tlightDirReg = this._dirLightFragmentConstants[fragmentRegIndex++];\n\t\t\t}\n\n\t\t\tdiffuseColorReg = this._dirLightFragmentConstants[fragmentRegIndex++];\n\t\t\tspecularColorReg = this._dirLightFragmentConstants[fragmentRegIndex++];\n\n\t\t\tif (addDiff)\n\t\t\t\tthis._pFragmentCode += this._renderLightingPass._iGetPerLightDiffuseFragmentCode(this._shaderLightingObject, lightDirReg, diffuseColorReg, this._pRegisterCache, this._pSharedRegisters);\n\n\t\t\tif (addSpec)\n\t\t\t\tthis._pFragmentCode += this._renderLightingPass._iGetPerLightSpecularFragmentCode(this._shaderLightingObject, lightDirReg, specularColorReg, this._pRegisterCache, this._pSharedRegisters);\n\n\t\t\tif (this._shaderLightingObject.usesTangentSpace)\n\t\t\t\tthis._pRegisterCache.removeVertexTempUsage(lightDirReg);\n\t\t}\n\n\t\tvertexRegIndex = 0;\n\t\tfragmentRegIndex = 0;\n\n\t\t//compile the shading code for point lights\n\t\tfor (var i:number = 0; i < this._shaderLightingObject.numPointLights; ++i) {\n\n\t\t\tif (this._shaderLightingObject.usesTangentSpace || !this._shaderLightingObject.usesGlobalPosFragment)\n\t\t\t\tlightPosReg = this._pointLightVertexConstants[vertexRegIndex++];\n\t\t\telse\n\t\t\t\tlightPosReg = this._pointLightFragmentConstants[fragmentRegIndex++];\n\n\t\t\tdiffuseColorReg = this._pointLightFragmentConstants[fragmentRegIndex++];\n\t\t\tspecularColorReg = this._pointLightFragmentConstants[fragmentRegIndex++];\n\n\t\t\tlightDirReg = this._pRegisterCache.getFreeFragmentVectorTemp();\n\t\t\tthis._pRegisterCache.addFragmentTempUsages(lightDirReg, 1);\n\n\t\t\tvar lightVarying:ShaderRegisterElement;\n\n\t\t\tif (this._shaderLightingObject.usesTangentSpace) {\n\t\t\t\tlightVarying = this._pRegisterCache.getFreeVarying();\n\t\t\t\tvar temp:ShaderRegisterElement = this._pRegisterCache.getFreeVertexVectorTemp();\n\t\t\t\tthis._pVertexCode += \"sub \" + temp + \", \" + lightPosReg + \", \" + this._pSharedRegisters.localPosition + \"\\n\" +\n\t\t\t\t\t\"m33 \" + lightVarying + \".xyz, \" + temp + \", \" + this._pSharedRegisters.animatedTangent + \"\\n\" +\n\t\t\t\t\t\"mov \" + lightVarying + \".w, \" + this._pSharedRegisters.localPosition + \".w\\n\";\n\t\t\t} else if (!this._shaderLightingObject.usesGlobalPosFragment) {\n\t\t\t\tlightVarying = this._pRegisterCache.getFreeVarying();\n\t\t\t\tthis._pVertexCode += \"sub \" + lightVarying + \", \" + lightPosReg + \", \" + this._pSharedRegisters.globalPositionVertex + \"\\n\";\n\t\t\t} else {\n\t\t\t\tlightVarying = lightDirReg;\n\t\t\t\tthis._pFragmentCode += \"sub \" + lightDirReg + \", \" + lightPosReg + \", \" + this._pSharedRegisters.globalPositionVarying + \"\\n\";\n\t\t\t}\n\n\t\t\tif (this._shaderLightingObject.usesLightFallOff) {\n\t\t\t\t// calculate attenuation\n\t\t\t\tthis._pFragmentCode += // attenuate\n\t\t\t\t\t\"dp3 \" + lightDirReg + \".w, \" + lightVarying + \", \" + lightVarying + \"\\n\" + // w = d - radius\n\t\t\t\t\t\"sub \" + lightDirReg + \".w, \" + lightDirReg + \".w, \" + diffuseColorReg + \".w\\n\" + // w = (d - radius)/(max-min)\n\t\t\t\t\t\"mul \" + lightDirReg + \".w, \" + lightDirReg + \".w, \" + specularColorReg + \".w\\n\" + // w = clamp(w, 0, 1)\n\t\t\t\t\t\"sat \" + lightDirReg + \".w, \" + lightDirReg + \".w\\n\" + // w = 1-w\n\t\t\t\t\t\"sub \" + lightDirReg + \".w, \" + this._pSharedRegisters.commons + \".w, \" + lightDirReg + \".w\\n\" + // normalize\n\t\t\t\t\t\"nrm \" + lightDirReg + \".xyz, \" + lightVarying + \"\\n\";\n\t\t\t} else {\n\t\t\t\tthis._pFragmentCode += \"nrm \" + lightDirReg + \".xyz, \" + lightVarying + \"\\n\" +\n\t\t\t\t\t\"mov \" + lightDirReg + \".w, \" + lightVarying + \".w\\n\";\n\t\t\t}\n\n\t\t\tif (this._shaderLightingObject.lightFragmentConstantIndex == -1)\n\t\t\t\tthis._shaderLightingObject.lightFragmentConstantIndex = lightPosReg.index*4;\n\n\t\t\tif (addDiff)\n\t\t\t\tthis._pFragmentCode += this._renderLightingPass._iGetPerLightDiffuseFragmentCode(this._shaderLightingObject, lightDirReg, diffuseColorReg, this._pRegisterCache, this._pSharedRegisters);\n\n\t\t\tif (addSpec)\n\t\t\t\tthis._pFragmentCode += this._renderLightingPass._iGetPerLightSpecularFragmentCode(this._shaderLightingObject, lightDirReg, specularColorReg, this._pRegisterCache, this._pSharedRegisters);\n\n\t\t\tthis._pRegisterCache.removeFragmentTempUsage(lightDirReg);\n\t\t}\n\t}\n\n\t/**\n\t * Compiles shading code for light probes.\n\t */\n\tprivate compileLightProbeCode()\n\t{\n\t\tvar weightReg:string;\n\t\tvar weightComponents = [ \".x\", \".y\", \".z\", \".w\" ];\n\t\tvar weightRegisters:Array<ShaderRegisterElement> = new Array<ShaderRegisterElement>();\n\t\tvar i:number;\n\t\tvar texReg:ShaderRegisterElement;\n\t\tvar addSpec:boolean = this._shaderLightingObject.usesProbesForSpecular;\n\t\tvar addDiff:boolean = this._shaderLightingObject.usesProbesForDiffuse;\n\n\t\tif (addDiff)\n\t\t\tthis._shaderLightingObject.lightProbeDiffuseIndices = new Array<number>();\n\n\t\tif (addSpec)\n\t\t\tthis._shaderLightingObject.lightProbeSpecularIndices = new Array<number>();\n\n\t\tfor (i = 0; i < this._pNumProbeRegisters; ++i) {\n\t\t\tweightRegisters[i] = this._pRegisterCache.getFreeFragmentConstant();\n\n\t\t\tif (i == 0)\n\t\t\t\tthis._shaderLightingObject.probeWeightsIndex = weightRegisters[i].index*4;\n\t\t}\n\n\t\tfor (i = 0; i < this._shaderLightingObject.numLightProbes; ++i) {\n\t\t\tweightReg = weightRegisters[Math.floor(i/4)].toString() + weightComponents[i%4];\n\n\t\t\tif (addDiff) {\n\t\t\t\ttexReg = this._pRegisterCache.getFreeTextureReg();\n\t\t\t\tthis._shaderLightingObject.lightProbeDiffuseIndices[i] = texReg.index;\n\t\t\t\tthis._pFragmentCode += this._renderLightingPass._iGetPerProbeDiffuseFragmentCode(this._shaderLightingObject, texReg, weightReg, this._pRegisterCache, this._pSharedRegisters);\n\t\t\t}\n\n\t\t\tif (addSpec) {\n\t\t\t\ttexReg = this._pRegisterCache.getFreeTextureReg();\n\t\t\t\tthis._shaderLightingObject.lightProbeSpecularIndices[i] = texReg.index;\n\t\t\t\tthis._pFragmentCode += this._renderLightingPass._iGetPerProbeSpecularFragmentCode(this._shaderLightingObject, texReg, weightReg, this._pRegisterCache, this._pSharedRegisters);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Reset all the indices to \"unused\".\n\t */\n\tpublic pInitRegisterIndices()\n\t{\n\t\tsuper.pInitRegisterIndices();\n\n\t\tthis._shaderLightingObject.lightVertexConstantIndex = -1;\n\t\tthis._shaderLightingObject.lightFragmentConstantIndex = -1;\n\t\tthis._shaderLightingObject.probeWeightsIndex = -1;\n\n\t\tthis._pNumProbeRegisters = Math.ceil(this._shaderLightingObject.numLightProbes/4);\n\n\t\t//init light data\n\t\tif (this._shaderLightingObject.usesTangentSpace || !this._shaderLightingObject.usesGlobalPosFragment) {\n\t\t\tthis._pointLightVertexConstants = new Array<ShaderRegisterElement>(this._shaderLightingObject.numPointLights);\n\t\t\tthis._pointLightFragmentConstants = new Array<ShaderRegisterElement>(this._shaderLightingObject.numPointLights*2);\n\t\t} else {\n\t\t\tthis._pointLightFragmentConstants = new Array<ShaderRegisterElement>(this._shaderLightingObject.numPointLights*3);\n\t\t}\n\n\t\tif (this._shaderLightingObject.usesTangentSpace) {\n\t\t\tthis._dirLightVertexConstants = new Array<ShaderRegisterElement>(this._shaderLightingObject.numDirectionalLights);\n\t\t\tthis._dirLightFragmentConstants = new Array<ShaderRegisterElement>(this._shaderLightingObject.numDirectionalLights*2);\n\t\t} else {\n\t\t\tthis._dirLightFragmentConstants = new Array<ShaderRegisterElement>(this._shaderLightingObject.numDirectionalLights*3);\n\t\t}\n\t}\n}\n\nexport = ShaderLightingCompiler;","import Matrix3D\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3D\");\nimport Vector3D\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport Camera\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\nimport DirectionalLight\t\t\t\t= require(\"awayjs-display/lib/entities/DirectionalLight\");\nimport LightProbe\t\t\t\t\t= require(\"awayjs-display/lib/entities/LightProbe\");\nimport PointLight\t\t\t\t\t= require(\"awayjs-display/lib/entities/PointLight\");\nimport LightPickerBase\t\t\t\t= require(\"awayjs-display/lib/materials/lightpickers/LightPickerBase\");\nimport IRenderObjectOwner\t\t\t= require(\"awayjs-display/lib/base/IRenderObjectOwner\");\nimport LightSources\t\t\t\t\t= require(\"awayjs-display/lib/materials/LightSources\");\n\nimport ContextGLProfile\t\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLProfile\");\nimport Stage\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\nimport IContextGL\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/IContextGL\");\n\nimport IRenderLightingPass\t\t\t= require(\"awayjs-renderergl/lib/passes/IRenderLightingPass\");\nimport ShaderLightingCompiler\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderLightingCompiler\");\n\nimport RenderableBase\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\nimport ShaderCompilerBase\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderCompilerBase\");\nimport ShaderObjectBase\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport IRenderableClass\t\t\t\t= require(\"awayjs-renderergl/lib/pool/IRenderableClass\");\n\n/**\n * ShaderObjectBase keeps track of the number of dependencies for \"named registers\" used across a pass.\n * Named registers are that are not necessarily limited to a single method. They are created by the compiler and\n * passed on to methods. The compiler uses the results to reserve usages through RegisterPool, which can be removed\n * each time a method has been compiled into the shader.\n *\n * @see RegisterPool.addUsage\n */\nclass ShaderLightingObject extends ShaderObjectBase\n{\n\tpublic _renderLightingPass:IRenderLightingPass;\n\n\tprivate _includeCasters:boolean = true;\n\n\t/**\n\t * The first index for the fragment constants containing the light data.\n\t */\n\tpublic lightFragmentConstantIndex:number;\n\n\t/**\n\t * The starting index if the vertex constant to which light data needs to be uploaded.\n\t */\n\tpublic lightVertexConstantIndex:number;\n\n\t/**\n\t * Indices for the light probe diffuse textures.\n\t */\n\tpublic lightProbeDiffuseIndices:Array<number> /*uint*/;\n\n\t/**\n\t * Indices for the light probe specular textures.\n\t */\n\tpublic lightProbeSpecularIndices:Array<number> /*uint*/;\n\n\t/**\n\t * The index of the fragment constant containing the weights for the light probes.\n\t */\n\tpublic probeWeightsIndex:number;\n\n\tpublic numLights:number;\n\tpublic numDirectionalLights:number;\n\tpublic numPointLights:number;\n\tpublic numLightProbes:number;\n\n\tpublic usesLightFallOff:boolean;\n\n\tpublic usesShadows:boolean;\n\n\t/**\n\t * Indicates whether the shader uses any lights.\n\t */\n\tpublic usesLights:boolean;\n\n\t/**\n\t * Indicates whether the shader uses any light probes.\n\t */\n\tpublic usesProbes:boolean;\n\n\t/**\n\t * Indicates whether the lights uses any specular components.\n\t */\n\tpublic usesLightsForSpecular:boolean;\n\n\t/**\n\t * Indicates whether the probes uses any specular components.\n\t */\n\tpublic usesProbesForSpecular:boolean;\n\n\t/**\n\t * Indicates whether the lights uses any diffuse components.\n\t */\n\tpublic usesLightsForDiffuse:boolean;\n\n\t/**\n\t * Indicates whether the probes uses any diffuse components.\n\t */\n\tpublic usesProbesForDiffuse:boolean;\n\n\t/**\n\t * Creates a new MethodCompilerVO object.\n\t */\n\tconstructor(renderableClass:IRenderableClass, renderLightingPass:IRenderLightingPass, stage:Stage)\n\t{\n\t\tsuper(renderableClass, renderLightingPass, stage);\n\n\t\tthis._renderLightingPass = renderLightingPass;\n\t}\n\n\tpublic _iIncludeDependencies()\n\t{\n\t\tthis.numPointLights = this._renderLightingPass.numPointLights;\n\t\tthis.numDirectionalLights = this._renderLightingPass.numDirectionalLights;\n\t\tthis.numLightProbes = this._renderLightingPass.numLightProbes;\n\n\t\tvar numAllLights:number = this._renderLightingPass.numPointLights + this._renderLightingPass.numDirectionalLights;\n\t\tvar numLightProbes:number = this._renderLightingPass.numLightProbes;\n\t\tvar diffuseLightSources:number = this._renderLightingPass._iUsesDiffuse(this)? this._renderLightingPass.diffuseLightSources : 0x00;\n\t\tvar specularLightSources:number = this._renderLightingPass._iUsesSpecular(this)? this._renderLightingPass.specularLightSources : 0x00;\n\t\tvar combinedLightSources:number = diffuseLightSources | specularLightSources;\n\n\t\tthis.usesLightFallOff = this._renderLightingPass.enableLightFallOff && this.profile != ContextGLProfile.BASELINE_CONSTRAINED;\n\t\tthis.numLights = numAllLights + numLightProbes;\n\t\tthis.usesLights = numAllLights > 0 && (combinedLightSources & LightSources.LIGHTS) != 0;\n\t\tthis.usesProbes = numLightProbes > 0 && (combinedLightSources & LightSources.PROBES) != 0;\n\t\tthis.usesLightsForSpecular = numAllLights > 0 && (specularLightSources & LightSources.LIGHTS) != 0;\n\t\tthis.usesProbesForSpecular = numLightProbes > 0 && (specularLightSources & LightSources.PROBES) != 0;\n\t\tthis.usesLightsForDiffuse = numAllLights > 0 && (diffuseLightSources & LightSources.LIGHTS) != 0;\n\t\tthis.usesProbesForDiffuse = numLightProbes > 0 && (diffuseLightSources & LightSources.PROBES) != 0;\n\t\tthis.usesShadows = this._renderLightingPass._iUsesShadows(this);\n\n\t\t//IMPORTANT this must occur after shader lighting initialisation above\n\t\tsuper._iIncludeDependencies();\n\t}\n\n\t/**\n\t * Factory method to create a concrete compiler object for this object\n\t *\n\t * @param materialPassVO\n\t * @returns {away.materials.ShaderLightingCompiler}\n\t */\n\tpublic createCompiler(renderableClass:IRenderableClass, renderPass:IRenderLightingPass):ShaderCompilerBase\n\t{\n\t\treturn new ShaderLightingCompiler(renderableClass, renderPass, this);\n\t}\n\n\t/**\n\t * Clears dependency counts for all registers. Called when recompiling a pass.\n\t */\n\tpublic reset()\n\t{\n\t\tsuper.reset();\n\n\t\tthis.numLights = 0;\n\t\tthis.usesLightFallOff = true;\n\t}\n\n\n\t/**\n\t *\n\t *\n\t * @param renderable\n\t * @param stage\n\t * @param camera\n\t */\n\tpublic _iRender(renderable:RenderableBase, camera:Camera, viewProjection:Matrix3D)\n\t{\n\t\tsuper._iRender(renderable, camera, viewProjection);\n\n\t\tif (this._renderLightingPass.lightPicker)\n\t\t\tthis._renderLightingPass.lightPicker.collectLights(renderable);\n\n\t\tif (this.usesLights)\n\t\t\tthis.updateLights();\n\n\t\tif (this.usesProbes)\n\t\t\tthis.updateProbes();\n\t}\n\n\t/**\n\t * Updates constant data render state used by the lights. This method is optional for subclasses to implement.\n\t */\n\tprivate updateLights()\n\t{\n\t\tvar dirLight:DirectionalLight;\n\t\tvar pointLight:PointLight;\n\t\tvar i:number = 0;\n\t\tvar k:number = 0;\n\t\tvar len:number;\n\t\tvar dirPos:Vector3D;\n\t\tvar total:number = 0;\n\t\tvar numLightTypes:number = this.usesShadows? 2 : 1;\n\t\tvar l:number;\n\t\tvar offset:number;\n\n\t\tthis.ambientR = this.ambientG = this.ambientB = 0;\n\n\t\tl = this.lightVertexConstantIndex;\n\t\tk = this.lightFragmentConstantIndex;\n\n\t\tvar cast:number = 0;\n\t\tvar dirLights:Array<DirectionalLight> = this._renderLightingPass.lightPicker.directionalLights;\n\t\toffset = this._renderLightingPass.directionalLightsOffset;\n\t\tlen = this._renderLightingPass.lightPicker.directionalLights.length;\n\n\t\tif (offset > len) {\n\t\t\tcast = 1;\n\t\t\toffset -= len;\n\t\t}\n\n\t\tfor (; cast < numLightTypes; ++cast) {\n\t\t\tif (cast)\n\t\t\t\tdirLights = this._renderLightingPass.lightPicker.castingDirectionalLights;\n\n\t\t\tlen = dirLights.length;\n\n\t\t\tif (len > this.numDirectionalLights)\n\t\t\t\tlen = this.numDirectionalLights;\n\n\t\t\tfor (i = 0; i < len; ++i) {\n\t\t\t\tdirLight = dirLights[offset + i];\n\t\t\t\tdirPos = dirLight.sceneDirection;\n\n\t\t\t\tthis.ambientR += dirLight._iAmbientR;\n\t\t\t\tthis.ambientG += dirLight._iAmbientG;\n\t\t\t\tthis.ambientB += dirLight._iAmbientB;\n\n\t\t\t\tif (this.usesTangentSpace) {\n\t\t\t\t\tvar x:number = -dirPos.x;\n\t\t\t\t\tvar y:number = -dirPos.y;\n\t\t\t\t\tvar z:number = -dirPos.z;\n\n\t\t\t\t\tthis.vertexConstantData[l++] = this._pInverseSceneMatrix[0]*x + this._pInverseSceneMatrix[4]*y + this._pInverseSceneMatrix[8]*z;\n\t\t\t\t\tthis.vertexConstantData[l++] = this._pInverseSceneMatrix[1]*x + this._pInverseSceneMatrix[5]*y + this._pInverseSceneMatrix[9]*z;\n\t\t\t\t\tthis.vertexConstantData[l++] = this._pInverseSceneMatrix[2]*x + this._pInverseSceneMatrix[6]*y + this._pInverseSceneMatrix[10]*z;\n\t\t\t\t\tthis.vertexConstantData[l++] = 1;\n\t\t\t\t} else {\n\t\t\t\t\tthis.fragmentConstantData[k++] = -dirPos.x;\n\t\t\t\t\tthis.fragmentConstantData[k++] = -dirPos.y;\n\t\t\t\t\tthis.fragmentConstantData[k++] = -dirPos.z;\n\t\t\t\t\tthis.fragmentConstantData[k++] = 1;\n\t\t\t\t}\n\n\t\t\t\tthis.fragmentConstantData[k++] = dirLight._iDiffuseR;\n\t\t\t\tthis.fragmentConstantData[k++] = dirLight._iDiffuseG;\n\t\t\t\tthis.fragmentConstantData[k++] = dirLight._iDiffuseB;\n\t\t\t\tthis.fragmentConstantData[k++] = 1;\n\n\t\t\t\tthis.fragmentConstantData[k++] = dirLight._iSpecularR;\n\t\t\t\tthis.fragmentConstantData[k++] = dirLight._iSpecularG;\n\t\t\t\tthis.fragmentConstantData[k++] = dirLight._iSpecularB;\n\t\t\t\tthis.fragmentConstantData[k++] = 1;\n\n\t\t\t\tif (++total == this.numDirectionalLights) {\n\t\t\t\t\t// break loop\n\t\t\t\t\ti = len;\n\t\t\t\t\tcast = numLightTypes;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// more directional supported than currently picked, need to clamp all to 0\n\t\tif (this.numDirectionalLights > total) {\n\t\t\ti = k + (this.numDirectionalLights - total)*12;\n\n\t\t\twhile (k < i)\n\t\t\t\tthis.fragmentConstantData[k++] = 0;\n\t\t}\n\n\t\ttotal = 0;\n\n\t\tvar pointLights:Array<PointLight> = this._renderLightingPass.lightPicker.pointLights;\n\t\toffset = this._renderLightingPass.pointLightsOffset;\n\t\tlen = this._renderLightingPass.lightPicker.pointLights.length;\n\n\t\tif (offset > len) {\n\t\t\tcast = 1;\n\t\t\toffset -= len;\n\t\t} else {\n\t\t\tcast = 0;\n\t\t}\n\n\t\tfor (; cast < numLightTypes; ++cast) {\n\t\t\tif (cast)\n\t\t\t\tpointLights = this._renderLightingPass.lightPicker.castingPointLights;\n\n\t\t\tlen = pointLights.length;\n\n\t\t\tfor (i = 0; i < len; ++i) {\n\t\t\t\tpointLight = pointLights[offset + i];\n\t\t\t\tdirPos = pointLight.scenePosition;\n\n\t\t\t\tthis.ambientR += pointLight._iAmbientR;\n\t\t\t\tthis.ambientG += pointLight._iAmbientG;\n\t\t\t\tthis.ambientB += pointLight._iAmbientB;\n\n\t\t\t\tif (this.usesTangentSpace) {\n\t\t\t\t\tx = dirPos.x;\n\t\t\t\t\ty = dirPos.y;\n\t\t\t\t\tz = dirPos.z;\n\n\t\t\t\t\tthis.vertexConstantData[l++] = this._pInverseSceneMatrix[0]*x + this._pInverseSceneMatrix[4]*y + this._pInverseSceneMatrix[8]*z + this._pInverseSceneMatrix[12];\n\t\t\t\t\tthis.vertexConstantData[l++] = this._pInverseSceneMatrix[1]*x + this._pInverseSceneMatrix[5]*y + this._pInverseSceneMatrix[9]*z + this._pInverseSceneMatrix[13];\n\t\t\t\t\tthis.vertexConstantData[l++] = this._pInverseSceneMatrix[2]*x + this._pInverseSceneMatrix[6]*y + this._pInverseSceneMatrix[10]*z + this._pInverseSceneMatrix[14];\n\t\t\t\t\tthis.vertexConstantData[l++] = 1;\n\t\t\t\t} else if (!this.usesGlobalPosFragment) {\n\t\t\t\t\tthis.vertexConstantData[l++] = dirPos.x;\n\t\t\t\t\tthis.vertexConstantData[l++] = dirPos.y;\n\t\t\t\t\tthis.vertexConstantData[l++] = dirPos.z;\n\t\t\t\t\tthis.vertexConstantData[l++] = 1;\n\t\t\t\t} else {\n\t\t\t\t\tthis.fragmentConstantData[k++] = dirPos.x;\n\t\t\t\t\tthis.fragmentConstantData[k++] = dirPos.y;\n\t\t\t\t\tthis.fragmentConstantData[k++] = dirPos.z;\n\t\t\t\t\tthis.fragmentConstantData[k++] = 1;\n\t\t\t\t}\n\n\t\t\t\tthis.fragmentConstantData[k++] = pointLight._iDiffuseR;\n\t\t\t\tthis.fragmentConstantData[k++] = pointLight._iDiffuseG;\n\t\t\t\tthis.fragmentConstantData[k++] = pointLight._iDiffuseB;\n\n\t\t\t\tvar radius:number = pointLight._pRadius;\n\t\t\t\tthis.fragmentConstantData[k++] = radius*radius;\n\n\t\t\t\tthis.fragmentConstantData[k++] = pointLight._iSpecularR;\n\t\t\t\tthis.fragmentConstantData[k++] = pointLight._iSpecularG;\n\t\t\t\tthis.fragmentConstantData[k++] = pointLight._iSpecularB;\n\t\t\t\tthis.fragmentConstantData[k++] = pointLight._pFallOffFactor;\n\n\t\t\t\tif (++total == this.numPointLights) {\n\t\t\t\t\t// break loop\n\t\t\t\t\ti = len;\n\t\t\t\t\tcast = numLightTypes;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// more directional supported than currently picked, need to clamp all to 0\n\t\tif (this.numPointLights > total) {\n\t\t\ti = k + (total - this.numPointLights)*12;\n\n\t\t\tfor (; k < i; ++k)\n\t\t\t\tthis.fragmentConstantData[k] = 0;\n\t\t}\n\t}\n\n\t/**\n\t * Updates constant data render state used by the light probes. This method is optional for subclasses to implement.\n\t */\n\tprivate updateProbes()\n\t{\n\t\tvar probe:LightProbe;\n\t\tvar lightProbes:Array<LightProbe> = this._renderLightingPass.lightPicker.lightProbes;\n\t\tvar weights:Array<number> = this._renderLightingPass.lightPicker.lightProbeWeights;\n\t\tvar len:number = lightProbes.length - this._renderLightingPass.lightProbesOffset;\n\t\tvar addDiff:boolean = this.usesProbesForDiffuse;\n\t\tvar addSpec:boolean = this.usesProbesForSpecular;\n\n\t\tif (!(addDiff || addSpec))\n\t\t\treturn;\n\n\t\tif (len > this.numLightProbes)\n\t\t\tlen = this.numLightProbes;\n\n\t\tfor (var i:number = 0; i < len; ++i) {\n\t\t\tprobe = lightProbes[ this._renderLightingPass.lightProbesOffset + i];\n\n\t\t\tif (addDiff)\n\t\t\t\tthis._stage.activateCubeTexture(this.lightProbeDiffuseIndices[i], probe.diffuseMap);\n\n\t\t\tif (addSpec)\n\t\t\t\tthis._stage.activateCubeTexture(this.lightProbeSpecularIndices[i], probe.specularMap);\n\t\t}\n\n\t\tfor (i = 0; i < len; ++i)\n\t\t\tthis.fragmentConstantData[this.probeWeightsIndex + i] = weights[this._renderLightingPass.lightProbesOffset + i];\n\t}\n}\n\nexport = ShaderLightingObject;","import Matrix\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix\");\nimport Matrix3D\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3D\");\nimport Matrix3DUtils\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3DUtils\");\nimport Rectangle\t\t\t\t\t= require(\"awayjs-core/lib/geom/Rectangle\");\nimport Vector3D\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\nimport Event\t\t\t\t\t\t= require(\"awayjs-core/lib/events/Event\");\nimport ArgumentError\t\t\t\t= require(\"awayjs-core/lib/errors/ArgumentError\");\nimport Texture2DBase\t\t\t\t= require(\"awayjs-core/lib/textures/Texture2DBase\");\n\nimport BlendMode\t\t\t\t\t= require(\"awayjs-display/lib/base/BlendMode\");\nimport LineSubGeometry\t\t\t\t= require(\"awayjs-display/lib/base/LineSubGeometry\");\nimport TriangleSubGeometry\t\t\t= require(\"awayjs-display/lib/base/TriangleSubGeometry\");\nimport Camera\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\n\nimport IContextGL\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/IContextGL\");\nimport ContextGLCompareMode\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLCompareMode\");\nimport ContextGLTriangleFace\t\t= require(\"awayjs-stagegl/lib/base/ContextGLTriangleFace\");\nimport ContextGLBlendFactor\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLBlendFactor\");\nimport Stage\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\nimport ProgramData\t\t\t\t\t= require(\"awayjs-stagegl/lib/pool/ProgramData\");\n\nimport AnimationSetBase\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimationSetBase\");\nimport AnimatorBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport AnimationRegisterCache\t\t= require(\"awayjs-renderergl/lib/animators/data/AnimationRegisterCache\");\nimport RenderableBase\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\nimport IRenderPassBase\t\t\t\t= require(\"awayjs-renderergl/lib/passes/IRenderPassBase\");\nimport ShaderCompilerBase\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderCompilerBase\");\nimport ShaderRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterCache\");\nimport IRenderableClass\t\t\t\t= require(\"awayjs-renderergl/lib/pool/IRenderableClass\");\nimport RendererBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/base/RendererBase\");\n\n/**\n * ShaderObjectBase keeps track of the number of dependencies for \"named registers\" used across a pass.\n * Named registers are that are not necessarily limited to a single method. They are created by the compiler and\n * passed on to methods. The compiler uses the results to reserve usages through RegisterPool, which can be removed\n * each time a method has been compiled into the shader.\n *\n * @see RegisterPool.addUsage\n */\nclass ShaderObjectBase\n{\n\tprivate _renderableClass:IRenderableClass;\n\tprivate _renderPass:IRenderPassBase;\n\tpublic _stage:Stage;\n\tprivate _programData:ProgramData;\n\n\tprivate _invalidShader:boolean = true;\n\tprivate _invalidProgram:boolean = true;\n\tprivate _animationVertexCode:string = \"\";\n\tprivate _animationFragmentCode:string = \"\";\n\n\tpublic get programData():ProgramData\n\t{\n\t\tif (this._invalidProgram)\n\t\t\tthis._updateProgram();\n\n\t\treturn this._programData;\n\t}\n\n\tpublic profile:string;\n\n\tpublic usesAnimation:boolean;\n\n\tprivate _defaultCulling:string = ContextGLTriangleFace.BACK;\n\n\tpublic _pInverseSceneMatrix:Array<number> = new Array<number>();\n\n\tpublic animationRegisterCache:AnimationRegisterCache;\n\n\t/**\n\t * The amount of used vertex constants in the vertex code. Used by the animation code generation to know from which index on registers are available.\n\t */\n\tpublic numUsedVertexConstants:number;\n\n\t/**\n\t * The amount of used fragment constants in the fragment code. Used by the animation code generation to know from which index on registers are available.\n\t */\n\tpublic numUsedFragmentConstants:number;\n\n\t/**\n\t * The amount of used vertex streams in the vertex code. Used by the animation code generation to know from which index on streams are available.\n\t */\n\tpublic numUsedStreams:number;\n\n\t/**\n\t *\n\t */\n\tpublic numUsedTextures:number;\n\n\t/**\n\t *\n\t */\n\tpublic numUsedVaryings:number;\n\n\tpublic animatableAttributes:Array<string>;\n\tpublic animationTargetRegisters:Array<string>;\n\tpublic uvSource:string;\n\tpublic uvTarget:string;\n\n\tpublic useAlphaPremultiplied:boolean;\n\tpublic useBothSides:boolean;\n\tpublic useMipmapping:boolean;\n\tpublic useSmoothTextures:boolean;\n\tpublic repeatTextures:boolean;\n\tpublic usesUVTransform:boolean;\n\tpublic alphaThreshold:number;\n\tpublic texture:Texture2DBase;\n\tpublic color:number;\n\n\n\t//set ambient values to default\n\tpublic ambientR:number = 0xFF;\n\tpublic ambientG:number = 0xFF;\n\tpublic ambientB:number = 0xFF;\n\n\t/**\n\t * Indicates whether the pass requires any fragment animation code.\n\t */\n\tpublic usesFragmentAnimation:boolean;\n\n\t/**\n\t * The amount of dependencies on the projected position.\n\t */\n\tpublic projectionDependencies:number;\n\n\t/**\n\t * The amount of dependencies on the normal vector.\n\t */\n\tpublic normalDependencies:number;\n\n\t/**\n\t * The amount of dependencies on the vertex color.\n\t */\n\tpublic colorDependencies:number;\n\n\t/**\n\t * The amount of dependencies on the view direction.\n\t */\n\tpublic viewDirDependencies:number;\n\n\t/**\n\t * The amount of dependencies on the primary UV coordinates.\n\t */\n\tpublic uvDependencies:number;\n\n\t/**\n\t * The amount of dependencies on the secondary UV coordinates.\n\t */\n\tpublic secondaryUVDependencies:number;\n\n\t/**\n\t * The amount of dependencies on the local position. This can be 0 while hasGlobalPosDependencies is true when\n\t * the global position is used as a temporary value (fe to calculate the view direction)\n\t */\n\tpublic localPosDependencies:number;\n\n\t/**\n\t * The amount of dependencies on the global position. This can be 0 while hasGlobalPosDependencies is true when\n\t * the global position is used as a temporary value (fe to calculate the view direction)\n\t */\n\tpublic globalPosDependencies:number;\n\n\t/**\n\t * The amount of tangent vector dependencies (fragment shader).\n\t */\n\tpublic tangentDependencies:number;\n\n\t/**\n\t *\n\t */\n\tpublic outputsNormals:boolean;\n\n\t/**\n\t *\n\t */\n\tpublic outputsColors:boolean;\n\n\t/**\n\t * Indicates whether or not normal calculations are expected in tangent space. This is only the case if no world-space\n\t * dependencies exist.\n\t */\n\tpublic usesTangentSpace:boolean;\n\n\t/**\n\t * Indicates whether or not normal calculations are output in tangent space.\n\t */\n\tpublic outputsTangentNormals:boolean;\n\n\t/**\n\t * Indicates whether there are any dependencies on the world-space position vector.\n\t */\n\tpublic usesGlobalPosFragment:boolean = false;\n\n\tpublic vertexConstantData:Array<number> = new Array<number>();\n\tpublic fragmentConstantData:Array<number> = new Array<number>();\n\n\t/**\n\t * The index for the common data register.\n\t */\n\tpublic commonsDataIndex:number;\n\n\t/**\n\t * The index for the UV vertex attribute stream.\n\t */\n\tpublic uvBufferIndex:number;\n\n\t/**\n\t * The index for the secondary UV vertex attribute stream.\n\t */\n\tpublic secondaryUVBufferIndex:number;\n\n\t/**\n\t * The index for the vertex normal attribute stream.\n\t */\n\tpublic normalBufferIndex:number;\n\n\t/**\n\t * The index for the color attribute stream.\n\t */\n\tpublic colorBufferIndex:number;\n\n\t/**\n\t * The index for the vertex tangent attribute stream.\n\t */\n\tpublic tangentBufferIndex:number;\n\n\t/**\n\t * The index of the vertex constant containing the view matrix.\n\t */\n\tpublic viewMatrixIndex:number;\n\n\t/**\n\t * The index of the vertex constant containing the scene matrix.\n\t */\n\tpublic sceneMatrixIndex:number;\n\n\t/**\n\t * The index of the vertex constant containing the uniform scene matrix (the inverse transpose).\n\t */\n\tpublic sceneNormalMatrixIndex:number;\n\n\t/**\n\t * The index of the vertex constant containing the camera position.\n\t */\n\tpublic cameraPositionIndex:number;\n\n\t/**\n\t * The index for the UV transformation matrix vertex constant.\n\t */\n\tpublic uvTransformIndex:number;\n\n\t/**\n\t * Creates a new MethodCompilerVO object.\n\t */\n\tconstructor(renderableClass:IRenderableClass, renderPass:IRenderPassBase, stage:Stage)\n\t{\n\t\tthis._renderableClass = renderableClass;\n\t\tthis._renderPass = renderPass;\n\t\tthis._stage = stage;\n\t\tthis.profile = this._stage.profile;\n\t}\n\n\tpublic _iIncludeDependencies()\n\t{\n\t\tthis._renderPass._iIncludeDependencies(this);\n\t}\n\n\t/**\n\t * Factory method to create a concrete compiler object for this object\n\t *\n\t * @param renderableClass\n\t * @param renderPass\n\t * @param stage\n\t * @returns {ShaderCompilerBase}\n\t */\n\tpublic createCompiler(renderableClass:IRenderableClass, renderPass:IRenderPassBase):ShaderCompilerBase\n\t{\n\t\treturn new ShaderCompilerBase(renderableClass, renderPass, this);\n\t}\n\n\t/**\n\t * Clears dependency counts for all registers. Called when recompiling a pass.\n\t */\n\tpublic reset()\n\t{\n\t\tthis.projectionDependencies = 0;\n\t\tthis.normalDependencies = 0;\n\t\tthis.colorDependencies = 0;\n\t\tthis.viewDirDependencies = 0;\n\t\tthis.uvDependencies = 0;\n\t\tthis.secondaryUVDependencies = 0;\n\t\tthis.globalPosDependencies = 0;\n\t\tthis.tangentDependencies = 0;\n\t\tthis.usesGlobalPosFragment = false;\n\t\tthis.usesFragmentAnimation = false;\n\t\tthis.usesTangentSpace = false;\n\t\tthis.outputsNormals = false;\n\t\tthis.outputsTangentNormals = false;\n\t}\n\n\tpublic pInitRegisterIndices()\n\t{\n\t\tthis.commonsDataIndex = -1;\n\t\tthis.cameraPositionIndex = -1;\n\t\tthis.uvBufferIndex = -1;\n\t\tthis.uvTransformIndex = -1;\n\t\tthis.secondaryUVBufferIndex = -1;\n\t\tthis.normalBufferIndex = -1;\n\t\tthis.colorBufferIndex = -1;\n\t\tthis.tangentBufferIndex = -1;\n\t\tthis.sceneMatrixIndex = -1;\n\t\tthis.sceneNormalMatrixIndex = -1;\n\t}\n\n\t/**\n\t * Initializes the unchanging constant data for this shader object.\n\t */\n\tpublic initConstantData(registerCache:ShaderRegisterCache, animatableAttributes:Array<string>, animationTargetRegisters:Array<string>, uvSource:string, uvTarget:string)\n\t{\n\t\t//Updates the amount of used register indices.\n\t\tthis.numUsedVertexConstants = registerCache.numUsedVertexConstants;\n\t\tthis.numUsedFragmentConstants = registerCache.numUsedFragmentConstants;\n\t\tthis.numUsedStreams = registerCache.numUsedStreams;\n\t\tthis.numUsedTextures = registerCache.numUsedTextures;\n\t\tthis.numUsedVaryings = registerCache.numUsedVaryings;\n\t\tthis.numUsedFragmentConstants = registerCache.numUsedFragmentConstants;\n\n\t\tthis.animatableAttributes = animatableAttributes;\n\t\tthis.animationTargetRegisters = animationTargetRegisters;\n\t\tthis.uvSource = uvSource;\n\t\tthis.uvTarget = uvTarget;\n\n\t\tthis.vertexConstantData.length = this.numUsedVertexConstants*4;\n\t\tthis.fragmentConstantData.length = this.numUsedFragmentConstants*4;\n\n\t\t//Initializes commonly required constant values.\n\t\tthis.fragmentConstantData[this.commonsDataIndex] = .5;\n\t\tthis.fragmentConstantData[this.commonsDataIndex + 1] = 0;\n\t\tthis.fragmentConstantData[this.commonsDataIndex + 2] = 1/255;\n\t\tthis.fragmentConstantData[this.commonsDataIndex + 3] = 1;\n\n\t\t//Initializes the default UV transformation matrix.\n\t\tif (this.uvTransformIndex >= 0) {\n\t\t\tthis.vertexConstantData[this.uvTransformIndex] = 1;\n\t\t\tthis.vertexConstantData[this.uvTransformIndex + 1] = 0;\n\t\t\tthis.vertexConstantData[this.uvTransformIndex + 2] = 0;\n\t\t\tthis.vertexConstantData[this.uvTransformIndex + 3] = 0;\n\t\t\tthis.vertexConstantData[this.uvTransformIndex + 4] = 0;\n\t\t\tthis.vertexConstantData[this.uvTransformIndex + 5] = 1;\n\t\t\tthis.vertexConstantData[this.uvTransformIndex + 6] = 0;\n\t\t\tthis.vertexConstantData[this.uvTransformIndex + 7] = 0;\n\t\t}\n\n\t\tif (this.cameraPositionIndex >= 0)\n\t\t\tthis.vertexConstantData[this.cameraPositionIndex + 3] = 1;\n\t}\n\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iActivate(camera:Camera)\n\t{\n\t\tif (this.usesAnimation)\n\t\t\t(<AnimationSetBase> this._renderPass.animationSet).activate(this, this._stage);\n\n\t\tthis._stage.context.setCulling(this.useBothSides? ContextGLTriangleFace.NONE : this._defaultCulling, camera.projection.coordinateSystem);\n\n\t\tif (!this.usesTangentSpace && this.cameraPositionIndex >= 0) {\n\t\t\tvar pos:Vector3D = camera.scenePosition;\n\n\t\t\tthis.vertexConstantData[this.cameraPositionIndex] = pos.x;\n\t\t\tthis.vertexConstantData[this.cameraPositionIndex + 1] = pos.y;\n\t\t\tthis.vertexConstantData[this.cameraPositionIndex + 2] = pos.z;\n\t\t}\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iDeactivate()\n\t{\n\t\tif (this.usesAnimation)\n\t\t\t(<AnimationSetBase> this._renderPass.animationSet).deactivate(this, this._stage);\n\n\t}\n\n\n\t/**\n\t *\n\t *\n\t * @param renderable\n\t * @param stage\n\t * @param camera\n\t */\n\tpublic _iRender(renderable:RenderableBase, camera:Camera, viewProjection:Matrix3D)\n\t{\n\t\tif (renderable.renderableOwner.animator)\n\t\t\t(<AnimatorBase> renderable.renderableOwner.animator).setRenderState(this, renderable, this._stage, camera, this.numUsedVertexConstants, this.numUsedStreams);\n\n\t\tif (this.uvBufferIndex >= 0)\n\t\t\tthis._stage.activateBuffer(this.uvBufferIndex, renderable.getVertexData(TriangleSubGeometry.UV_DATA), renderable.getVertexOffset(TriangleSubGeometry.UV_DATA), TriangleSubGeometry.UV_FORMAT);\n\n\t\tif (this.secondaryUVBufferIndex >= 0)\n\t\t\tthis._stage.activateBuffer(this.secondaryUVBufferIndex, renderable.getVertexData(TriangleSubGeometry.SECONDARY_UV_DATA), renderable.getVertexOffset(TriangleSubGeometry.SECONDARY_UV_DATA), TriangleSubGeometry.SECONDARY_UV_FORMAT);\n\n\t\tif (this.normalBufferIndex >= 0)\n\t\t\tthis._stage.activateBuffer(this.normalBufferIndex, renderable.getVertexData(TriangleSubGeometry.NORMAL_DATA), renderable.getVertexOffset(TriangleSubGeometry.NORMAL_DATA), TriangleSubGeometry.NORMAL_FORMAT);\n\n\t\tif (this.tangentBufferIndex >= 0)\n\t\t\tthis._stage.activateBuffer(this.tangentBufferIndex, renderable.getVertexData(TriangleSubGeometry.TANGENT_DATA), renderable.getVertexOffset(TriangleSubGeometry.TANGENT_DATA), TriangleSubGeometry.TANGENT_FORMAT);\n\n\t\tif (this.colorBufferIndex >= 0)\n\t\t\tthis._stage.activateBuffer(this.colorBufferIndex, renderable.getVertexData(LineSubGeometry.COLOR_DATA), renderable.getVertexOffset(LineSubGeometry.COLOR_DATA), LineSubGeometry.COLOR_FORMAT);\n\n\n\t\tif (this.usesUVTransform) {\n\t\t\tvar uvTransform:Matrix = renderable.renderableOwner.uvTransform.matrix;\n\n\t\t\tif (uvTransform) {\n\t\t\t\tthis.vertexConstantData[this.uvTransformIndex] = uvTransform.a;\n\t\t\t\tthis.vertexConstantData[this.uvTransformIndex + 1] = uvTransform.b;\n\t\t\t\tthis.vertexConstantData[this.uvTransformIndex + 3] = uvTransform.tx;\n\t\t\t\tthis.vertexConstantData[this.uvTransformIndex + 4] = uvTransform.c;\n\t\t\t\tthis.vertexConstantData[this.uvTransformIndex + 5] = uvTransform.d;\n\t\t\t\tthis.vertexConstantData[this.uvTransformIndex + 7] = uvTransform.ty;\n\t\t\t} else {\n\t\t\t\tthis.vertexConstantData[this.uvTransformIndex] = 1;\n\t\t\t\tthis.vertexConstantData[this.uvTransformIndex + 1] = 0;\n\t\t\t\tthis.vertexConstantData[this.uvTransformIndex + 3] = 0;\n\t\t\t\tthis.vertexConstantData[this.uvTransformIndex + 4] = 0;\n\t\t\t\tthis.vertexConstantData[this.uvTransformIndex + 5] = 1;\n\t\t\t\tthis.vertexConstantData[this.uvTransformIndex + 7] = 0;\n\t\t\t}\n\t\t}\n\n\t\tif (this.sceneNormalMatrixIndex >= 0)\n\t\t\trenderable.sourceEntity.inverseSceneTransform.copyRawDataTo(this.vertexConstantData, this.sceneNormalMatrixIndex, false);\n\n\t\tif (this.usesTangentSpace && this.cameraPositionIndex >= 0) {\n\n\t\t\trenderable.sourceEntity.inverseSceneTransform.copyRawDataTo(this._pInverseSceneMatrix);\n\t\t\tvar pos:Vector3D = camera.scenePosition;\n\t\t\tvar x:number = pos.x;\n\t\t\tvar y:number = pos.y;\n\t\t\tvar z:number = pos.z;\n\n\t\t\tthis.vertexConstantData[this.cameraPositionIndex] = this._pInverseSceneMatrix[0]*x + this._pInverseSceneMatrix[4]*y + this._pInverseSceneMatrix[8]*z + this._pInverseSceneMatrix[12];\n\t\t\tthis.vertexConstantData[this.cameraPositionIndex + 1] = this._pInverseSceneMatrix[1]*x + this._pInverseSceneMatrix[5]*y + this._pInverseSceneMatrix[9]*z + this._pInverseSceneMatrix[13];\n\t\t\tthis.vertexConstantData[this.cameraPositionIndex + 2] = this._pInverseSceneMatrix[2]*x + this._pInverseSceneMatrix[6]*y + this._pInverseSceneMatrix[10]*z + this._pInverseSceneMatrix[14];\n\t\t}\n\t}\n\t\n\tpublic invalidateProgram()\n\t{\n\t\tthis._invalidProgram = true;\n\t}\n\n\tpublic invalidateShader()\n\t{\n\t\tthis._invalidShader = true;\n\t\tthis._invalidProgram = true;\n\t}\n\n\tpublic dispose()\n\t{\n\t\tthis._programData.dispose();\n\t\tthis._programData = null;\n\t}\n\n\tprivate _updateProgram()\n\t{\n\t\tthis._invalidProgram = false;\n\n\t\tvar compiler:ShaderCompilerBase;\n\n\t\tif (this._invalidShader) {\n\t\t\tthis._invalidShader = false;\n\n\t\t\tcompiler = this.createCompiler(this._renderableClass, this._renderPass);\n\t\t\tcompiler.compile();\n\t\t}\n\n\t\tthis._calcAnimationCode(compiler.shadedTarget);\n\n\t\tvar programData:ProgramData = this._stage.getProgramData(this._animationVertexCode + compiler.vertexCode, compiler.fragmentCode + this._animationFragmentCode + compiler.postAnimationFragmentCode);\n\n\t\t//check program data hasn't changed, keep count of program usages\n\t\tif (this._programData != programData) {\n\t\t\tif (this._programData)\n\t\t\t\tthis._programData.dispose();\n\n\t\t\tthis._programData = programData;\n\n\t\t\tprogramData.usages++;\n\t\t}\n\t}\n\n\tprivate _calcAnimationCode(shadedTarget:string)\n\t{\n\t\t//reset code\n\t\tthis._animationVertexCode = \"\";\n\t\tthis._animationFragmentCode = \"\";\n\n\t\t//check to see if GPU animation is used\n\t\tif (this.usesAnimation) {\n\n\t\t\tvar animationSet:AnimationSetBase = <AnimationSetBase> this._renderPass.animationSet;\n\n\t\t\tthis._animationVertexCode += animationSet.getAGALVertexCode(this);\n\n\t\t\tif (this.uvDependencies > 0 && !this.usesUVTransform)\n\t\t\t\tthis._animationVertexCode += animationSet.getAGALUVCode(this);\n\n\t\t\tif (this.usesFragmentAnimation)\n\t\t\t\tthis._animationFragmentCode += animationSet.getAGALFragmentCode(this, shadedTarget);\n\n\t\t\tanimationSet.doneAGALCode(this);\n\n\t\t} else {\n\t\t\t// simply write attributes to targets, do not animate them\n\t\t\t// projection will pick up on targets[0] to do the projection\n\t\t\tvar len:number = this.animatableAttributes.length;\n\t\t\tfor (var i:number = 0; i < len; ++i)\n\t\t\t\tthis._animationVertexCode += \"mov \" + this.animationTargetRegisters[i] + \", \" + this.animatableAttributes[i] + \"\\n\";\n\n\t\t\tif (this.uvDependencies > 0 && !this.usesUVTransform)\n\t\t\t\tthis._animationVertexCode += \"mov \" + this.uvTarget + \",\" + this.uvSource + \"\\n\";\n\t\t}\n\t}\n}\n\nexport = ShaderObjectBase;","import RegisterPool\t\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/RegisterPool\");\nimport ShaderRegisterElement\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\n\n/**\n * ShaderRegister Cache provides the usage management system for all registers during shading compilation.\n */\nclass ShaderRegisterCache\n{\n\tprivate _fragmentTempCache:RegisterPool;\n\tprivate _vertexTempCache:RegisterPool;\n\tprivate _varyingCache:RegisterPool;\n\tprivate _fragmentConstantsCache:RegisterPool;\n\tprivate _vertexConstantsCache:RegisterPool;\n\tprivate _textureCache:RegisterPool;\n\tprivate _vertexAttributesCache:RegisterPool;\n\tprivate _vertexConstantOffset:number; //TODO: check if this should be initialised to 0\n\tprivate _vertexAttributesOffset:number;//TODO: check if this should be initialised to 0\n\tprivate _varyingsOffset:number;//TODO: check if this should be initialised to 0\n\tprivate _fragmentConstantOffset:number;//TODO: check if this should be initialised to 0\n\n\tprivate _fragmentOutputRegister:ShaderRegisterElement;\n\tprivate _vertexOutputRegister:ShaderRegisterElement;\n\tprivate _numUsedVertexConstants:number = 0;\n\tprivate _numUsedFragmentConstants:number = 0;\n\tprivate _numUsedStreams:number = 0;\n\tprivate _numUsedTextures:number = 0;\n\tprivate _numUsedVaryings:number = 0;\n\tprivate _profile:string;\n\n\t/**\n\t * Create a new ShaderRegisterCache object.\n\t *\n\t * @param profile The compatibility profile used by the renderer.\n\t */\n\tconstructor(profile:string)\n\t{\n\t\tthis._profile = profile;\n\t}\n\n\t/**\n\t * Resets all registers.\n\t */\n\tpublic reset()\n\t{\n\t\tthis._fragmentTempCache = new RegisterPool(\"ft\", 8, false);\n\t\tthis._vertexTempCache = new RegisterPool(\"vt\", 8, false);\n\t\tthis._varyingCache = new RegisterPool(\"v\", 8);\n\t\tthis._textureCache = new RegisterPool(\"fs\", 8);\n\t\tthis._vertexAttributesCache = new RegisterPool(\"va\", 8);\n\t\tthis._fragmentConstantsCache = new RegisterPool(\"fc\", 28);\n\t\tthis._vertexConstantsCache = new RegisterPool(\"vc\", 128);\n\t\tthis._fragmentOutputRegister = new ShaderRegisterElement(\"oc\", -1);\n\t\tthis._vertexOutputRegister = new ShaderRegisterElement(\"op\", -1);\n\t\tthis._numUsedVertexConstants = 0;\n\t\tthis._numUsedStreams = 0;\n\t\tthis._numUsedTextures = 0;\n\t\tthis._numUsedVaryings = 0;\n\t\tthis._numUsedFragmentConstants = 0;\n\n\t\tvar i:number;\n\n\t\tfor (i = 0; i < this._vertexAttributesOffset; ++i)\n\t\t\tthis.getFreeVertexAttribute();\n\n\t\tfor (i = 0; i < this._vertexConstantOffset; ++i)\n\t\t\tthis.getFreeVertexConstant();\n\n\t\tfor (i = 0; i < this._varyingsOffset; ++i)\n\t\t\tthis.getFreeVarying();\n\n\t\tfor (i = 0; i < this._fragmentConstantOffset; ++i)\n\t\t\tthis.getFreeFragmentConstant();\n\t}\n\n\t/**\n\t * Disposes all resources used.\n\t */\n\tpublic dispose()\n\t{\n\t\tthis._fragmentTempCache.dispose();\n\t\tthis._vertexTempCache.dispose();\n\t\tthis._varyingCache.dispose();\n\t\tthis._fragmentConstantsCache.dispose();\n\t\tthis._vertexAttributesCache.dispose();\n\n\t\tthis._fragmentTempCache = null;\n\t\tthis._vertexTempCache = null;\n\t\tthis._varyingCache = null;\n\t\tthis._fragmentConstantsCache = null;\n\t\tthis._vertexAttributesCache = null;\n\t\tthis._fragmentOutputRegister = null;\n\t\tthis._vertexOutputRegister = null;\n\t}\n\n\t/**\n\t * Marks a fragment temporary register as used, so it cannot be retrieved. The register won't be able to be used until removeUsage\n\t * has been called usageCount times again.\n\t * @param register The register to mark as used.\n\t * @param usageCount The amount of usages to add.\n\t */\n\tpublic addFragmentTempUsages(register:ShaderRegisterElement, usageCount:number)\n\t{\n\t\tthis._fragmentTempCache.addUsage(register, usageCount);\n\t}\n\n\t/**\n\t * Removes a usage from a fragment temporary register. When usages reach 0, the register is freed again.\n\t * @param register The register for which to remove a usage.\n\t */\n\tpublic removeFragmentTempUsage(register:ShaderRegisterElement)\n\t{\n\t\tthis._fragmentTempCache.removeUsage(register);\n\t}\n\n\t/**\n\t * Marks a vertex temporary register as used, so it cannot be retrieved. The register won't be able to be used\n\t * until removeUsage has been called usageCount times again.\n\t * @param register The register to mark as used.\n\t * @param usageCount The amount of usages to add.\n\t */\n\tpublic addVertexTempUsages(register:ShaderRegisterElement, usageCount:number)\n\t{\n\t\tthis._vertexTempCache.addUsage(register, usageCount);\n\t}\n\n\t/**\n\t * Removes a usage from a vertex temporary register. When usages reach 0, the register is freed again.\n\t * @param register The register for which to remove a usage.\n\t */\n\tpublic removeVertexTempUsage(register:ShaderRegisterElement)\n\t{\n\t\tthis._vertexTempCache.removeUsage(register);\n\t}\n\n\t/**\n\t * Retrieve an entire fragment temporary register that's still available. The register won't be able to be used until removeUsage\n\t * has been called usageCount times again.\n\t */\n\tpublic getFreeFragmentVectorTemp():ShaderRegisterElement\n\t{\n\t\treturn this._fragmentTempCache.requestFreeVectorReg();\n\t}\n\n\t/**\n\t * Retrieve a single component from a fragment temporary register that's still available.\n\t */\n\tpublic getFreeFragmentSingleTemp():ShaderRegisterElement\n\t{\n\t\treturn this._fragmentTempCache.requestFreeRegComponent();\n\t}\n\n\t/**\n\t * Retrieve an available varying register\n\t */\n\tpublic getFreeVarying():ShaderRegisterElement\n\t{\n\t\t++this._numUsedVaryings;\n\t\treturn this._varyingCache.requestFreeVectorReg();\n\t}\n\n\t/**\n\t * Retrieve an available fragment constant register\n\t */\n\tpublic getFreeFragmentConstant():ShaderRegisterElement\n\t{\n\t\t++this._numUsedFragmentConstants;\n\t\treturn this._fragmentConstantsCache.requestFreeVectorReg();\n\t}\n\n\t/**\n\t * Retrieve an available vertex constant register\n\t */\n\tpublic getFreeVertexConstant():ShaderRegisterElement\n\t{\n\t\t++this._numUsedVertexConstants;\n\t\treturn this._vertexConstantsCache.requestFreeVectorReg();\n\t}\n\n\t/**\n\t * Retrieve an entire vertex temporary register that's still available.\n\t */\n\tpublic getFreeVertexVectorTemp():ShaderRegisterElement\n\t{\n\t\treturn this._vertexTempCache.requestFreeVectorReg();\n\t}\n\n\t/**\n\t * Retrieve a single component from a vertex temporary register that's still available.\n\t */\n\tpublic getFreeVertexSingleTemp():ShaderRegisterElement\n\t{\n\t\treturn this._vertexTempCache.requestFreeRegComponent();\n\t}\n\n\t/**\n\t * Retrieve an available vertex attribute register\n\t */\n\tpublic getFreeVertexAttribute():ShaderRegisterElement\n\t{\n\t\t++this._numUsedStreams;\n\t\treturn this._vertexAttributesCache.requestFreeVectorReg();\n\t}\n\n\t/**\n\t * Retrieve an available texture register\n\t */\n\tpublic getFreeTextureReg():ShaderRegisterElement\n\t{\n\t\t++this._numUsedTextures;\n\t\treturn this._textureCache.requestFreeVectorReg();\n\t}\n\n\t/**\n\t * Indicates the start index from which to retrieve vertex constants.\n\t */\n\tpublic get vertexConstantOffset():number\n\t{\n\t\treturn this._vertexConstantOffset;\n\t}\n\n\tpublic set vertexConstantOffset(vertexConstantOffset:number)\n\t{\n\t\tthis._vertexConstantOffset = vertexConstantOffset;\n\t}\n\n\t/**\n\t * Indicates the start index from which to retrieve vertex attributes.\n\t */\n\tpublic get vertexAttributesOffset():number\n\t{\n\t\treturn this._vertexAttributesOffset;\n\t}\n\n\tpublic set vertexAttributesOffset(value:number)\n\t{\n\t\tthis._vertexAttributesOffset = value;\n\t}\n\n\t/**\n\t * Indicates the start index from which to retrieve varying registers.\n\t */\n\tpublic get varyingsOffset():number\n\t{\n\t\treturn this._varyingsOffset;\n\t}\n\n\tpublic set varyingsOffset(value:number)\n\t{\n\t\tthis._varyingsOffset = value;\n\t}\n\n\t/**\n\t * Indicates the start index from which to retrieve fragment constants.\n\t */\n\tpublic get fragmentConstantOffset():number\n\t{\n\t\treturn this._fragmentConstantOffset;\n\t}\n\n\tpublic set fragmentConstantOffset(value:number)\n\t{\n\t\tthis._fragmentConstantOffset = value;\n\t}\n\n\t/**\n\t * The fragment output register.\n\t */\n\tpublic get fragmentOutputRegister():ShaderRegisterElement\n\t{\n\t\treturn this._fragmentOutputRegister;\n\t}\n\n\t/**\n\t * The amount of used vertex constant registers.\n\t */\n\tpublic get numUsedVertexConstants():number\n\t{\n\t\treturn this._numUsedVertexConstants;\n\t}\n\n\t/**\n\t * The amount of used fragment constant registers.\n\t */\n\tpublic get numUsedFragmentConstants():number\n\t{\n\t\treturn this._numUsedFragmentConstants;\n\t}\n\n\t/**\n\t * The amount of used vertex streams.\n\t */\n\tpublic get numUsedStreams():number\n\t{\n\t\treturn this._numUsedStreams;\n\t}\n\n\t/**\n\t * The amount of used texture slots.\n\t */\n\tpublic get numUsedTextures():number\n\t{\n\t\treturn this._numUsedTextures;\n\t}\n\n\t/**\n\t * The amount of used varying registers.\n\t */\n\tpublic get numUsedVaryings():number\n\t{\n\t\treturn this._numUsedVaryings;\n\t}\n}\n\nexport = ShaderRegisterCache;","import ShaderRegisterElement\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\n\n/**\n * ShaderRegisterData contains the \"named\" registers, generated by the compiler and to be passed on to the methods.\n */\nclass ShaderRegisterData\n{\n\tpublic normalVarying:ShaderRegisterElement;\n\tpublic colorVarying:ShaderRegisterElement\n\tpublic tangentVarying:ShaderRegisterElement;\n\tpublic bitangentVarying:ShaderRegisterElement;\n\tpublic uvVarying:ShaderRegisterElement;\n\tpublic secondaryUVVarying:ShaderRegisterElement;\n\tpublic viewDirVarying:ShaderRegisterElement;\n\tpublic shadowTarget:ShaderRegisterElement;\n\tpublic shadedTarget:ShaderRegisterElement;\n\tpublic globalPositionVertex:ShaderRegisterElement;\n\tpublic globalPositionVarying:ShaderRegisterElement;\n\tpublic localPosition:ShaderRegisterElement;\n\tpublic normalInput:ShaderRegisterElement;\n\tpublic colorInput:ShaderRegisterElement;\n\tpublic tangentInput:ShaderRegisterElement;\n\tpublic animatedNormal:ShaderRegisterElement;\n\tpublic animatedTangent:ShaderRegisterElement;\n\tpublic commons:ShaderRegisterElement;\n\tpublic projectionFragment:ShaderRegisterElement;\n\tpublic normalFragment:ShaderRegisterElement;\n\tpublic viewDirFragment:ShaderRegisterElement;\n\tpublic bitangent:ShaderRegisterElement;\n\n\tconstructor()\n\t{\n\n\t}\n}\n\nexport = ShaderRegisterData;","/**\n * A single register element (an entire register or a single register's component) used by the RegisterPool.\n */\nclass ShaderRegisterElement\n{\n\tprivate _regName:string;\n\tprivate _index:number;\n\tprivate _toStr:string;\n\n\tprivate static COMPONENTS = [\"x\", \"y\", \"z\", \"w\"];\n\n\tpublic _component:number;\n\n\t/**\n\t * Creates a new ShaderRegisterElement object.\n\t *\n\t * @param regName The name of the register.\n\t * @param index The index of the register.\n\t * @param component The register's component, if not the entire register is represented.\n\t */\n\tconstructor(regName:string, index:number, component:number = -1)\n\t{\n\t\tthis._component = component;\n\t\tthis._regName = regName;\n\t\tthis._index = index;\n\n\t\tthis._toStr = this._regName;\n\n\t\tif (this._index >= 0)\n\t\t\tthis._toStr += this._index;\n\n\t\tif (component > -1)\n\t\t\tthis._toStr += \".\" + ShaderRegisterElement.COMPONENTS[component];\n\t}\n\n\t/**\n\t * Converts the register or the components AGAL string representation.\n\t */\n\tpublic toString():string\n\t{\n\t\treturn this._toStr;\n\t}\n\n\t/**\n\t * The register's name.\n\t */\n\tpublic get regName():string\n\t{\n\t\treturn this._regName;\n\t}\n\n\t/**\n\t * The register's index.\n\t */\n\tpublic get index():number\n\t{\n\t\treturn this._index;\n\t}\n}\n\nexport = ShaderRegisterElement;","import BlendMode\t\t\t\t\t= require(\"awayjs-display/lib/base/BlendMode\");\nimport IRenderObjectOwner\t\t\t= require(\"awayjs-display/lib/base/IRenderObjectOwner\");\n\nimport Stage\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\n\nimport RenderObjectBase\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/RenderObjectBase\");\nimport RenderObjectPool\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/RenderObjectPool\");\nimport IRenderableClass\t\t\t\t= require(\"awayjs-renderergl/lib/pool/IRenderableClass\");\nimport SkyboxPass\t\t\t\t\t= require(\"awayjs-renderergl/lib/passes/SkyboxPass\");\n\n/**\n * SkyboxRenderObject forms an abstract base class for the default shaded materials provided by Stage,\n * using material methods to define their appearance.\n */\nclass SkyboxRenderObject extends RenderObjectBase\n{\n\t/**\n\t *\n\t */\n\tpublic static id:string = \"skybox\";\n\n\tprivate _screenPass:SkyboxPass;\n\n\tconstructor(pool:RenderObjectPool, renderObjectOwner:IRenderObjectOwner, renderableClass:IRenderableClass, stage:Stage)\n\t{\n\t\tsuper(pool, renderObjectOwner, renderableClass, stage);\n\n\t\tthis._screenPass = new SkyboxPass(this, renderObjectOwner, renderableClass, this._stage);\n\n\t\tthis._pAddScreenPass(this._screenPass);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _pUpdateRenderObject()\n\t{\n\t\tsuper._pUpdateRenderObject();\n\n\t\tthis._pRequiresBlending = (this._renderObjectOwner.blendMode != BlendMode.NORMAL);\n\n\t\tthis._screenPass.setBlendMode((this._renderObjectOwner.blendMode == BlendMode.NORMAL && this._pRequiresBlending)? BlendMode.LAYER : this._renderObjectOwner.blendMode);\n\t}\n}\n\nexport = SkyboxRenderObject;","import Error\t\t\t\t\t\t= require(\"awayjs-core/lib/errors/Error\");\n\nclass AnimationSetError extends Error\n{\n\tconstructor(message:string)\n\t{\n\t\tsuper(message);\n\t}\n}\n\nexport = AnimationSetError;","import AnimationNodeBase\t\t\t\t= require(\"awayjs-display/lib/animators/nodes/AnimationNodeBase\");\n\nimport Event\t\t\t\t\t\t\t= require(\"awayjs-core/lib/events/Event\");\n\nimport AnimatorBase\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\nimport IAnimationState\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/states/IAnimationState\");\n\n/**\n * Dispatched to notify changes in an animation state's state.\n */\nclass AnimationStateEvent extends Event\n{\n\t/**\n\t * Dispatched when a non-looping clip node inside an animation state reaches the end of its timeline.\n\t */\n\tpublic static PLAYBACK_COMPLETE:string = \"playbackComplete\";\n\n\tpublic static TRANSITION_COMPLETE:string = \"transitionComplete\";\n\n\tprivate _animator:AnimatorBase;\n\tprivate _animationState:IAnimationState;\n\tprivate _animationNode:AnimationNodeBase;\n\n\t/**\n\t * Create a new <code>AnimatonStateEvent</code>\n\t *\n\t * @param type The event type.\n\t * @param animator The animation state object that is the subject of this event.\n\t * @param animationNode The animation node inside the animation state from which the event originated.\n\t */\n\tconstructor(type:string, animator:AnimatorBase, animationState:IAnimationState, animationNode:AnimationNodeBase)\n\t{\n\t\tsuper(type);\n\n\t\tthis._animator = animator;\n\t\tthis._animationState = animationState;\n\t\tthis._animationNode = animationNode;\n\t}\n\n\t/**\n\t * The animator object that is the subject of this event.\n\t */\n\tpublic get animator():AnimatorBase\n\t{\n\t\treturn this._animator;\n\t}\n\n\t/**\n\t * The animation state object that is the subject of this event.\n\t */\n\tpublic get animationState():IAnimationState\n\t{\n\t\treturn this._animationState;\n\t}\n\n\t/**\n\t * The animation node inside the animation state from which the event originated.\n\t */\n\tpublic get animationNode():AnimationNodeBase\n\t{\n\t\treturn this._animationNode;\n\t}\n\n\t/**\n\t * Clones the event.\n\t *\n\t * @return An exact duplicate of the current object.\n\t */\n\tpublic clone():Event\n\t{\n\t\treturn new AnimationStateEvent(this.type, this._animator, this._animationState, this._animationNode);\n\t}\n}\n\nexport = AnimationStateEvent;","import Event\t\t\t\t\t\t= require(\"awayjs-core/lib/events/Event\");\n\nimport AnimatorBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimatorBase\");\n\n/**\n * Dispatched to notify changes in an animator's state.\n */\nclass AnimatorEvent extends Event\n{\n\t/**\n\t * Defines the value of the type property of a start event object.\n\t */\n\tpublic static START:string = \"start\";\n\n\t/**\n\t * Defines the value of the type property of a stop event object.\n\t */\n\tpublic static STOP:string = \"stop\";\n\n\t/**\n\t * Defines the value of the type property of a cycle complete event object.\n\t */\n\tpublic static CYCLE_COMPLETE:string = \"cycle_complete\";\n\n\tprivate _animator:AnimatorBase;\n\n\t/**\n\t * Create a new <code>AnimatorEvent</code> object.\n\t *\n\t * @param type The event type.\n\t * @param animator The animator object that is the subject of this event.\n\t */\n\tconstructor(type:string, animator:AnimatorBase)\n\t{\n\t\tsuper(type);\n\t\tthis._animator = animator;\n\t}\n\n\tpublic get animator():AnimatorBase\n\t{\n\t\treturn this._animator;\n\t}\n\n\t/**\n\t * Clones the event.\n\t *\n\t * @return An exact duplicate of the current event object.\n\t */\n\tpublic clone():Event\n\t{\n\t\treturn new AnimatorEvent(this.type, this._animator);\n\t}\n}\n\nexport = AnimatorEvent;","import Event\t\t\t\t\t\t= require(\"awayjs-core/lib/events/Event\");\n\nclass ShadingMethodEvent extends Event\n{\n\tpublic static SHADER_INVALIDATED:string = \"ShaderInvalidated\";\n\n\tconstructor(type:string)\n\t{\n\n\t\tsuper(type);\n\n\t}\n}\n\nexport = ShadingMethodEvent;","import Camera\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\n\nimport Stage\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\nimport ITexture\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/ITexture\");\n\nimport Filter3DTaskBase\t\t\t\t= require(\"awayjs-renderergl/lib/filters/tasks/Filter3DTaskBase\");\n\nclass Filter3DBase\n{\n\tprivate _tasks:Array<Filter3DTaskBase>;\n\tprivate _requireDepthRender:boolean;\n\tprivate _textureWidth:number;\n\tprivate _textureHeight:number;\n\n\tconstructor()\n\t{\n\t\tthis._tasks = new Array<Filter3DTaskBase>();\n\t}\n\n\tpublic get requireDepthRender():boolean\n\t{\n\t\treturn this._requireDepthRender;\n\t}\n\n\tpublic pAddTask(filter:Filter3DTaskBase)\n\t{\n\t\tthis._tasks.push(filter);\n\n\t\tif (this._requireDepthRender == null)\n\t\t\tthis._requireDepthRender = filter.requireDepthRender;\n\t}\n\n\tpublic get tasks():Filter3DTaskBase[]\n\t{\n\t\treturn this._tasks;\n\t}\n\n\tpublic getMainInputTexture(stage:Stage):ITexture\n\t{\n\t\treturn this._tasks[0].getMainInputTexture(stage);\n\t}\n\n\tpublic get textureWidth():number\n\t{\n\t\treturn this._textureWidth;\n\t}\n\n\tpublic set textureWidth(value:number)\n\t{\n\t\tthis._textureWidth = value;\n\n\t\tfor (var i:number = 0; i < this._tasks.length; ++i)\n\t\t\tthis._tasks[i].textureWidth = value;\n\t}\n\n\tpublic get textureHeight():number\n\t{\n\t\treturn this._textureHeight;\n\t}\n\n\tpublic set textureHeight(value:number)\n\t{\n\t\tthis._textureHeight = value;\n\n\t\tfor (var i:number = 0; i < this._tasks.length; ++i)\n\t\t\tthis._tasks[i].textureHeight = value;\n\t}\n\n\t// link up the filters correctly with the next filter\n\tpublic setRenderTargets(mainTarget:ITexture, stage:Stage)\n\t{\n\t\tthis._tasks[this._tasks.length - 1].target = mainTarget;\n\t}\n\n\tpublic dispose()\n\t{\n\t\tfor (var i:number = 0; i < this._tasks.length; ++i)\n\t\t\tthis._tasks[i].dispose();\n\t}\n\n\tpublic update(stage:Stage, camera:Camera)\n\t{\n\n\t}\n}\n\nexport = Filter3DBase;","import AbstractMethodError\t\t\t= require(\"awayjs-core/lib/errors/AbstractMethodError\");\nimport ByteArray\t\t\t\t\t= require(\"awayjs-core/lib/utils/ByteArray\");\n\nimport Camera\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\n\nimport Stage\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\nimport AGALMiniAssembler\t\t\t= require(\"awayjs-stagegl/lib/aglsl/assembler/AGALMiniAssembler\");\nimport ContextGLTextureFormat\t\t= require(\"awayjs-stagegl/lib/base/ContextGLTextureFormat\");\nimport IContextGL\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/IContextGL\");\nimport IProgram\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/IProgram\");\nimport ITexture\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/ITexture\");\n\nclass Filter3DTaskBase\n{\n\tprivate _mainInputTexture:ITexture;\n\n\tprivate _scaledTextureWidth:number = -1;\n\tprivate _scaledTextureHeight:number = -1;\n\tprivate _textureWidth:number = -1;\n\tprivate _textureHeight:number = -1;\n\tprivate _textureDimensionsInvalid:boolean = true;\n\tprivate _program3DInvalid:boolean = true;\n\tprivate _program3D:IProgram;\n\tprivate _target:ITexture;\n\tprivate _requireDepthRender:boolean;\n\tprivate _textureScale:number = 0;\n\n\tconstructor(requireDepthRender:boolean = false)\n\t{\n\n\t\tthis._requireDepthRender = requireDepthRender;\n\n\t}\n\n\t/**\n\t * The texture scale for the input of this texture. This will define the output of the previous entry in the chain\n\t */\n\tpublic get textureScale():number\n\t{\n\t\treturn this._textureScale;\n\t}\n\n\tpublic set textureScale(value:number)\n\t{\n\t\tif (this._textureScale == value)\n\t\t\treturn;\n\n\t\tthis._textureScale = value;\n\t\tthis._scaledTextureWidth = this._textureWidth >> this._textureScale;\n\t\tthis._scaledTextureHeight = this._textureHeight >> this._textureScale;\n\t\tthis._textureDimensionsInvalid = true;\n\t}\n\n\tpublic get target():ITexture\n\t{\n\t\treturn this._target;\n\t}\n\n\tpublic set target(value:ITexture)\n\t{\n\t\tthis._target = value;\n\t}\n\n\tpublic get textureWidth():number\n\t{\n\t\treturn this._textureWidth;\n\t}\n\n\tpublic set textureWidth(value:number)\n\t{\n\t\tif (this._textureWidth == value)\n\t\t\treturn;\n\n\t\tthis._textureWidth = value;\n\t\tthis._scaledTextureWidth = this._textureWidth >> this._textureScale;\n\t\tthis._textureDimensionsInvalid = true;\n\t}\n\n\tpublic get textureHeight():number\n\t{\n\t\treturn this._textureHeight;\n\t}\n\n\tpublic set textureHeight(value:number)\n\t{\n\t\tif (this._textureHeight == value)\n\t\t\treturn;\n\n\t\tthis._textureHeight = value;\n\t\tthis._scaledTextureHeight = this._textureHeight >> this._textureScale;\n\t\tthis._textureDimensionsInvalid = true;\n\t}\n\n\tpublic getMainInputTexture(stage:Stage):ITexture\n\t{\n\t\tif (this._textureDimensionsInvalid)\n\t\t\tthis.pUpdateTextures(stage);\n\n\t\treturn this._mainInputTexture;\n\t}\n\n\tpublic dispose()\n\t{\n\t\tif (this._mainInputTexture)\n\t\t\tthis._mainInputTexture.dispose();\n\n\t\tif (this._program3D)\n\t\t\tthis._program3D.dispose();\n\t}\n\n\tpublic pInvalidateProgram()\n\t{\n\t\tthis._program3DInvalid = true;\n\t}\n\n\tpublic pUpdateProgram(stage:Stage)\n\t{\n\t\tif (this._program3D)\n\t\t\tthis._program3D.dispose();\n\n\t\tthis._program3D = stage.context.createProgram();\n\n\t\tvar vertexByteCode:ByteArray = (new AGALMiniAssembler().assemble(\"part vertex 1\\n\" + this.pGetVertexCode() + \"endpart\"))['vertex'].data;\n\t\tvar fragmentByteCode:ByteArray = (new AGALMiniAssembler().assemble(\"part fragment 1\\n\" + this.pGetFragmentCode() + \"endpart\"))['fragment'].data;\n\t\tthis._program3D.upload(vertexByteCode, fragmentByteCode);\n\t\tthis._program3DInvalid = false;\n\t}\n\n\tpublic pGetVertexCode():string\n\t{\n\t\t// TODO: imeplement AGAL <> GLSL\n\n\t\treturn \"mov op, va0\\n\" + \"mov v0, va1\\n\";\n\t}\n\n\tpublic pGetFragmentCode():string\n\t{\n\t\tthrow new AbstractMethodError();\n\n\t\treturn null;\n\t}\n\n\tpublic pUpdateTextures(stage:Stage)\n\t{\n\t\tif (this._mainInputTexture)\n\t\t\tthis._mainInputTexture.dispose();\n\n\t\tthis._mainInputTexture = stage.context.createTexture(this._scaledTextureWidth, this._scaledTextureHeight, ContextGLTextureFormat.BGRA, true);\n\n\t\tthis._textureDimensionsInvalid = false;\n\t}\n\n\tpublic getProgram(stage:Stage):IProgram\n\t{\n\t\tif (this._program3DInvalid)\n\t\t\tthis.pUpdateProgram(stage);\n\n\t\treturn this._program3D;\n\t}\n\n\tpublic activate(stage:Stage, camera:Camera, depthTexture:ITexture)\n\t{\n\t}\n\n\tpublic deactivate(stage:Stage)\n\t{\n\t}\n\n\tpublic get requireDepthRender():boolean\n\t{\n\t\treturn this._requireDepthRender;\n\t}\n\n}\n\nexport = Filter3DTaskBase;","import BitmapData\t\t\t\t\t= require(\"awayjs-core/lib/base/BitmapData\");\nimport AssetType\t\t\t\t\t= require(\"awayjs-core/lib/library/AssetType\");\nimport BitmapTexture\t\t\t\t= require(\"awayjs-core/lib/textures/BitmapTexture\");\n\nimport IRenderableOwner\t\t\t\t= require(\"awayjs-display/lib/base/IRenderableOwner\");\nimport BasicMaterial\t\t\t\t= require(\"awayjs-display/lib/materials/BasicMaterial\");\n\n\nclass DefaultMaterialManager\n{\n\tprivate static _defaultBitmapData:BitmapData;\n\tprivate static _defaultTriangleMaterial:BasicMaterial;\n\tprivate static _defaultLineMaterial:BasicMaterial;\n\tprivate static _defaultTexture:BitmapTexture;\n\n\tpublic static getDefaultMaterial(renderableOwner:IRenderableOwner = null):BasicMaterial\n\t{\n\t\tif (renderableOwner != null && renderableOwner.assetType == AssetType.LINE_SUB_MESH) {\n\t\t\tif (!DefaultMaterialManager._defaultLineMaterial)\n\t\t\t\tDefaultMaterialManager.createDefaultLineMaterial();\n\t\t\treturn DefaultMaterialManager._defaultLineMaterial;\n\t\t} else {\n\t\t\tif (!DefaultMaterialManager._defaultTriangleMaterial)\n\t\t\t\tDefaultMaterialManager.createDefaultTriangleMaterial();\n\t\t\treturn DefaultMaterialManager._defaultTriangleMaterial;\n\t\t}\n\t}\n\n\tpublic static getDefaultTexture(renderableOwner:IRenderableOwner = null):BitmapTexture\n\t{\n\t\tif (!DefaultMaterialManager._defaultTexture)\n\t\t\tDefaultMaterialManager.createDefaultTexture();\n\t\treturn DefaultMaterialManager._defaultTexture;\n\t}\n\n\tprivate static createDefaultTexture()\n\t{\n\t\tDefaultMaterialManager._defaultBitmapData = DefaultMaterialManager.createCheckeredBitmapData();\n\t\tDefaultMaterialManager._defaultTexture = new BitmapTexture(DefaultMaterialManager._defaultBitmapData, true);\n\t\tDefaultMaterialManager._defaultTexture.name = \"defaultTexture\";\n\t}\n\n\tpublic static createCheckeredBitmapData():BitmapData\n\t{\n\t\tvar b:BitmapData = new BitmapData(8, 8, false, 0x000000);\n\t\t//create chekerboard\n\t\tvar i:number, j:number;\n\t\tfor (i = 0; i < 8; i++) {\n\t\t\tfor (j = 0; j < 8; j++) {\n\t\t\t\tif ((j & 1) ^ (i & 1)) {\n\t\t\t\t\tb.setPixel(i, j, 0XFFFFFF);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn b;\n\t}\n\n\tprivate static createDefaultTriangleMaterial()\n\t{\n\t\tif (!DefaultMaterialManager._defaultTexture)\n\t\t\tDefaultMaterialManager.createDefaultTexture();\n\t\tDefaultMaterialManager._defaultTriangleMaterial = new BasicMaterial(DefaultMaterialManager._defaultTexture);\n\t\tDefaultMaterialManager._defaultTriangleMaterial.mipmap = false;\n\t\tDefaultMaterialManager._defaultTriangleMaterial.smooth = false;\n\t\tDefaultMaterialManager._defaultTriangleMaterial.name = \"defaultTriangleMaterial\";\n\t}\n\n\tprivate static createDefaultLineMaterial()\n\t{\n\t\tDefaultMaterialManager._defaultLineMaterial = new BasicMaterial();\n\t\tDefaultMaterialManager._defaultLineMaterial.name = \"defaultLineMaterial\";\n\t}\n}\n\nexport = DefaultMaterialManager;","import Rectangle\t\t\t\t\t= require(\"awayjs-core/lib/geom/Rectangle\");\nimport Event\t\t\t\t\t\t= require(\"awayjs-core/lib/events/Event\");\nimport EventDispatcher\t\t\t\t= require(\"awayjs-core/lib/events/EventDispatcher\");\nimport TextureUtils\t\t\t\t\t= require(\"awayjs-core/lib/utils/TextureUtils\");\n\nimport Stage\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\nimport IContextGL\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/IContextGL\");\nimport IIndexBuffer\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/IIndexBuffer\");\nimport IVertexBuffer\t\t\t\t= require(\"awayjs-stagegl/lib/base/IVertexBuffer\");\n\nclass RTTBufferManager extends EventDispatcher\n{\n\tprivate static _instances:Array<RTTBufferManagerVO>;\n\n\tprivate _renderToTextureVertexBuffer:IVertexBuffer;\n\tprivate _renderToScreenVertexBuffer:IVertexBuffer;\n\n\tprivate _indexBuffer:IIndexBuffer;\n\tprivate _stage:Stage;\n\tprivate _viewWidth:number = -1;\n\tprivate _viewHeight:number = -1;\n\tprivate _textureWidth:number = -1;\n\tprivate _textureHeight:number = -1;\n\tprivate _renderToTextureRect:Rectangle;\n\tprivate _buffersInvalid:boolean = true;\n\n\tprivate _textureRatioX:number;\n\tprivate _textureRatioY:number;\n\n\tconstructor(stage:Stage)\n\t{\n\t\tsuper();\n\n\t\tthis._renderToTextureRect = new Rectangle();\n\n\t\tthis._stage = stage;\n\n\t}\n\n\tpublic static getInstance(stage:Stage):RTTBufferManager\n\t{\n\t\tif (!stage)\n\t\t\tthrow new Error(\"stage key cannot be null!\");\n\n\t\tif (RTTBufferManager._instances == null)\n\t\t\tRTTBufferManager._instances = new Array<RTTBufferManagerVO>();\n\n\t\tvar rttBufferManager:RTTBufferManager = RTTBufferManager.getRTTBufferManagerFromStage(stage);\n\n\t\tif (rttBufferManager == null) {\n\t\t\trttBufferManager = new RTTBufferManager(stage);\n\n\t\t\tvar vo:RTTBufferManagerVO = new RTTBufferManagerVO();\n\n\t\t\tvo.stage3d = stage;\n\t\t\tvo.rttbfm = rttBufferManager;\n\n\t\t\tRTTBufferManager._instances.push(vo);\n\t\t}\n\n\t\treturn rttBufferManager;\n\n\t}\n\n\tprivate static getRTTBufferManagerFromStage(stage:Stage):RTTBufferManager\n\t{\n\n\t\tvar l:number = RTTBufferManager._instances.length;\n\t\tvar r:RTTBufferManagerVO;\n\n\t\tfor (var c:number = 0; c < l; c++) {\n\t\t\tr = RTTBufferManager._instances[ c ];\n\n\t\t\tif (r.stage3d === stage)\n\t\t\t\treturn r.rttbfm;\n\t\t}\n\n\t\treturn null;\n\t}\n\n\tprivate static deleteRTTBufferManager(stage:Stage):void\n\t{\n\t\tvar l:number = RTTBufferManager._instances.length;\n\t\tvar r:RTTBufferManagerVO;\n\n\t\tfor (var c:number = 0; c < l; c++) {\n\t\t\tr = RTTBufferManager._instances[ c ];\n\n\t\t\tif (r.stage3d === stage) {\n\t\t\t\tRTTBufferManager._instances.splice(c, 1);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic get textureRatioX():number\n\t{\n\t\tif (this._buffersInvalid)\n\t\t\tthis.updateRTTBuffers();\n\n\t\treturn this._textureRatioX;\n\t}\n\n\tpublic get textureRatioY():number\n\t{\n\t\tif (this._buffersInvalid)\n\t\t\tthis.updateRTTBuffers();\n\n\t\treturn this._textureRatioY;\n\t}\n\n\tpublic get viewWidth():number\n\t{\n\t\treturn this._viewWidth;\n\t}\n\n\tpublic set viewWidth(value:number)\n\t{\n\t\tif (value == this._viewWidth)\n\t\t\treturn;\n\n\t\tthis._viewWidth = value;\n\n\t\tthis._buffersInvalid = true;\n\n\t\tthis._textureWidth = TextureUtils.getBestPowerOf2(this._viewWidth);\n\n\t\tif (this._textureWidth > this._viewWidth) {\n\t\t\tthis._renderToTextureRect.x = Math.floor((this._textureWidth - this._viewWidth)*.5);\n\t\t\tthis._renderToTextureRect.width = this._viewWidth;\n\t\t} else {\n\t\t\tthis._renderToTextureRect.x = 0;\n\t\t\tthis._renderToTextureRect.width = this._textureWidth;\n\t\t}\n\n\t\tthis.dispatchEvent(new Event(Event.RESIZE));\n\t}\n\n\tpublic get viewHeight():number\n\t{\n\t\treturn this._viewHeight;\n\t}\n\n\tpublic set viewHeight(value:number)\n\t{\n\t\tif (value == this._viewHeight)\n\t\t\treturn;\n\n\t\tthis._viewHeight = value;\n\n\t\tthis._buffersInvalid = true;\n\n\t\tthis._textureHeight = TextureUtils.getBestPowerOf2(this._viewHeight);\n\n\t\tif (this._textureHeight > this._viewHeight) {\n\t\t\tthis._renderToTextureRect.y = Math.floor((this._textureHeight - this._viewHeight)*.5);\n\t\t\tthis._renderToTextureRect.height = this._viewHeight;\n\t\t} else {\n\t\t\tthis._renderToTextureRect.y = 0;\n\t\t\tthis._renderToTextureRect.height = this._textureHeight;\n\t\t}\n\n\t\tthis.dispatchEvent(new Event(Event.RESIZE));\n\t}\n\n\tpublic get renderToTextureVertexBuffer():IVertexBuffer\n\t{\n\t\tif (this._buffersInvalid)\n\t\t\tthis.updateRTTBuffers();\n\n\t\treturn this._renderToTextureVertexBuffer;\n\t}\n\n\tpublic get renderToScreenVertexBuffer():IVertexBuffer\n\t{\n\t\tif (this._buffersInvalid)\n\t\t\tthis.updateRTTBuffers();\n\n\t\treturn this._renderToScreenVertexBuffer;\n\n\t}\n\n\tpublic get indexBuffer():IIndexBuffer\n\t{\n\t\treturn this._indexBuffer;\n\t}\n\n\tpublic get renderToTextureRect():Rectangle\n\t{\n\t\tif (this._buffersInvalid)\n\t\t\tthis.updateRTTBuffers();\n\n\t\treturn this._renderToTextureRect;\n\t}\n\n\tpublic get textureWidth():number\n\t{\n\t\treturn this._textureWidth;\n\t}\n\n\tpublic get textureHeight():number\n\t{\n\t\treturn this._textureHeight;\n\t}\n\n\tpublic dispose()\n\t{\n\t\tRTTBufferManager.deleteRTTBufferManager(this._stage);\n\n\t\tif (this._indexBuffer) {\n\t\t\tthis._indexBuffer.dispose();\n\t\t\tthis._renderToScreenVertexBuffer.dispose();\n\t\t\tthis._renderToTextureVertexBuffer.dispose();\n\t\t\tthis._renderToScreenVertexBuffer = null;\n\t\t\tthis._renderToTextureVertexBuffer = null;\n\t\t\tthis._indexBuffer = null;\n\t\t}\n\t}\n\n\t// todo: place all this in a separate model, since it's used all over the place\n\t// maybe it even has a place in the core (together with screenRect etc)?\n\t// needs to be stored per view of course\n\tprivate updateRTTBuffers()\n\t{\n\t\tvar context:IContextGL = this._stage.context;\n\t\tvar textureVerts:number[];\n\t\tvar screenVerts:number[];\n\n\t\tvar x:number;\n\t\tvar y:number;\n\n\t\tif (this._renderToTextureVertexBuffer == null)\n\t\t\tthis._renderToTextureVertexBuffer = context.createVertexBuffer(4, 5);\n\n\t\tif (this._renderToScreenVertexBuffer == null)\n\t\t\tthis._renderToScreenVertexBuffer = context.createVertexBuffer(4, 5);\n\n\t\tif (!this._indexBuffer) {\n\t\t\tthis._indexBuffer = context.createIndexBuffer(6);\n\n\t\t\tthis._indexBuffer.uploadFromArray([2, 1, 0, 3, 2, 0], 0, 6);\n\t\t}\n\n\t\tthis._textureRatioX = x = Math.min(this._viewWidth/this._textureWidth, 1);\n\t\tthis._textureRatioY = y = Math.min(this._viewHeight/this._textureHeight, 1);\n\n\t\tvar u1:number = (1 - x)*.5;\n\t\tvar u2:number = (x + 1)*.5;\n\t\tvar v1:number = (y + 1)*.5;\n\t\tvar v2:number = (1 - y)*.5;\n\n\t\t// last element contains indices for data per vertex that can be passed to the vertex shader if necessary (ie: frustum corners for deferred rendering)\n\t\ttextureVerts = [    -x, -y, u1, v1, 0, x, -y, u2, v1, 1, x, y, u2, v2, 2, -x, y, u1, v2, 3 ];\n\n\t\tscreenVerts = [     -1, -1, u1, v1, 0, 1, -1, u2, v1, 1, 1, 1, u2, v2, 2, -1, 1, u1, v2, 3 ];\n\n\t\tthis._renderToTextureVertexBuffer.uploadFromArray(textureVerts, 0, 4);\n\t\tthis._renderToScreenVertexBuffer.uploadFromArray(screenVerts, 0, 4);\n\n\t\tthis._buffersInvalid = false;\n\t}\n}\n\nexport = RTTBufferManager;\n\nclass RTTBufferManagerVO\n{\n\tpublic stage3d:Stage;\n\n\tpublic rttbfm:RTTBufferManager;\n}","import Matrix\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix\");\nimport Matrix3D\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3D\");\nimport Matrix3DUtils\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3DUtils\");\nimport Texture2DBase\t\t\t\t= require(\"awayjs-core/lib/textures/Texture2DBase\");\n\nimport BlendMode\t\t\t\t\t= require(\"awayjs-display/lib/base/BlendMode\");\nimport Camera\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\nimport MaterialBase\t\t\t\t\t= require(\"awayjs-display/lib/materials/MaterialBase\");\nimport IRenderObjectOwner\t\t\t= require(\"awayjs-display/lib/base/IRenderObjectOwner\");\n\nimport ContextGLCompareMode\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLCompareMode\");\nimport ContextGLProgramType\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLProgramType\");\nimport ContextGLMipFilter\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLMipFilter\");\nimport ContextGLTextureFilter\t\t= require(\"awayjs-stagegl/lib/base/ContextGLTextureFilter\");\nimport ContextGLWrapMode\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLWrapMode\");\nimport IContextGL\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/IContextGL\");\nimport Stage\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\n\nimport RenderableBase\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\nimport RenderObjectBase\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/RenderObjectBase\");\nimport RenderObjectPool\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/RenderObjectPool\");\nimport ShaderObjectBase\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport ShaderRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterCache\");\nimport ShaderRegisterData\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterData\");\nimport ShaderRegisterElement\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\nimport ShaderCompilerHelper\t\t\t= require(\"awayjs-renderergl/lib/utils/ShaderCompilerHelper\");\nimport IRenderableClass\t\t\t\t= require(\"awayjs-renderergl/lib/pool/IRenderableClass\");\nimport RenderPassBase\t\t\t\t= require(\"awayjs-renderergl/lib/passes/RenderPassBase\");\n\n\n/**\n * BasicMaterialPass forms an abstract base class for the default shaded materials provided by Stage,\n * using material methods to define their appearance.\n */\nclass BasicMaterialPass extends RenderPassBase\n{\n\tprivate _diffuseR:number = 1;\n\tprivate _diffuseG:number = 1;\n\tprivate _diffuseB:number = 1;\n\tprivate _diffuseA:number = 1;\n\n\tprivate _fragmentConstantsIndex:number;\n\tprivate _texturesIndex:number;\n\n\tconstructor(renderObject:RenderObjectBase, renderObjectOwner:IRenderObjectOwner, renderableClass:IRenderableClass, stage:Stage)\n\t{\n\t\tsuper(renderObject, renderObjectOwner, renderableClass, stage);\n\n\t\tthis._shader = new ShaderObjectBase(renderableClass, this, this._stage);\n\t}\n\n\tpublic _iIncludeDependencies(shaderObject:ShaderObjectBase)\n\t{\n\t\tsuper._iIncludeDependencies(shaderObject);\n\n\t\tif (shaderObject.texture != null)\n\t\t\tshaderObject.uvDependencies++;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iGetFragmentCode(shaderObject:ShaderObjectBase, regCache:ShaderRegisterCache, sharedReg:ShaderRegisterData):string\n\t{\n\t\tvar code:string = \"\";\n\t\tvar targetReg:ShaderRegisterElement = sharedReg.shadedTarget;\n\t\tvar diffuseInputReg:ShaderRegisterElement;\n\n\t\tif (shaderObject.texture != null) {\n\t\t\tdiffuseInputReg = regCache.getFreeTextureReg();\n\n\t\t\tthis._texturesIndex = diffuseInputReg.index;\n\n\t\t\tcode += ShaderCompilerHelper.getTex2DSampleCode(targetReg, sharedReg, diffuseInputReg, shaderObject.texture, shaderObject.useSmoothTextures, shaderObject.repeatTextures, shaderObject.useMipmapping);\n\n\t\t\tif (shaderObject.alphaThreshold > 0) {\n\t\t\t\tvar cutOffReg:ShaderRegisterElement = regCache.getFreeFragmentConstant();\n\t\t\t\tthis._fragmentConstantsIndex = cutOffReg.index*4;\n\n\t\t\t\tcode += \"sub \" + targetReg + \".w, \" + targetReg + \".w, \" + cutOffReg + \".x\\n\" + \"kil \" + targetReg + \".w\\n\" + \"add \" + targetReg + \".w, \" + targetReg + \".w, \" + cutOffReg + \".x\\n\";\n\t\t\t}\n\t\t} else if (shaderObject.colorBufferIndex != -1) {\n\n\t\t\tcode += \"mov \" + targetReg + \", \" + sharedReg.colorVarying + \"\\n\";\n\t\t} else {\n\t\t\tdiffuseInputReg = regCache.getFreeFragmentConstant();\n\n\t\t\tthis._fragmentConstantsIndex = diffuseInputReg.index*4;\n\n\t\t\tcode += \"mov \" + targetReg + \", \" + diffuseInputReg + \"\\n\";\n\t\t}\n\n\t\treturn code;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iActivate(camera:Camera)\n\t{\n\t\tsuper._iActivate(camera);\n\n\t\tif (this._shader.texture != null) {\n\t\t\tthis._stage.context.setSamplerStateAt(this._texturesIndex, this._shader.repeatTextures? ContextGLWrapMode.REPEAT:ContextGLWrapMode.CLAMP, this._shader.useSmoothTextures? ContextGLTextureFilter.LINEAR : ContextGLTextureFilter.NEAREST, this._shader.useMipmapping? ContextGLMipFilter.MIPLINEAR : ContextGLMipFilter.MIPNONE);\n\t\t\tthis._stage.activateTexture(this._texturesIndex, this._shader.texture);\n\n\t\t\tif (this._shader.alphaThreshold > 0)\n\t\t\t\tthis._shader.fragmentConstantData[this._fragmentConstantsIndex] = this._shader.alphaThreshold;\n\t\t} else if (this._shader.colorBufferIndex == -1) {\n\t\t\tvar index:number = this._fragmentConstantsIndex;\n\t\t\tvar data:Array<number> = this._shader.fragmentConstantData;\n\t\t\tdata[index] = this._diffuseR;\n\t\t\tdata[index + 1] = this._diffuseG;\n\t\t\tdata[index + 2] = this._diffuseB;\n\t\t\tdata[index + 3] = this._diffuseA;\n\t\t}\n\t}\n}\n\nexport = BasicMaterialPass;","import Matrix\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix\");\nimport Matrix3D\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3D\");\nimport Matrix3DUtils\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3DUtils\");\nimport Texture2DBase\t\t\t\t= require(\"awayjs-core/lib/textures/Texture2DBase\");\n\nimport BlendMode\t\t\t\t\t= require(\"awayjs-display/lib/base/BlendMode\");\nimport TriangleSubGeometry\t\t\t= require(\"awayjs-display/lib/base/TriangleSubGeometry\");\nimport Camera\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\nimport MaterialBase\t\t\t\t\t= require(\"awayjs-display/lib/materials/MaterialBase\");\nimport IRenderObjectOwner\t\t\t= require(\"awayjs-display/lib/base/IRenderObjectOwner\");\n\nimport ContextGLCompareMode\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLCompareMode\");\nimport ContextGLProgramType\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLProgramType\");\nimport ContextGLMipFilter\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLMipFilter\");\nimport ContextGLTextureFilter\t\t= require(\"awayjs-stagegl/lib/base/ContextGLTextureFilter\");\nimport ContextGLWrapMode\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLWrapMode\");\nimport IContextGL\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/IContextGL\");\nimport Stage\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\n\nimport RenderableBase\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\nimport RenderObjectBase\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/RenderObjectBase\");\nimport RenderObjectPool\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/RenderObjectPool\");\nimport ShaderObjectBase\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport ShaderRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterCache\");\nimport ShaderRegisterData\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterData\");\nimport ShaderRegisterElement\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\nimport ShaderCompilerHelper\t\t\t= require(\"awayjs-renderergl/lib/utils/ShaderCompilerHelper\");\nimport IRenderableClass\t\t\t\t= require(\"awayjs-renderergl/lib/pool/IRenderableClass\");\nimport RenderPassBase\t\t\t\t= require(\"awayjs-renderergl/lib/passes/RenderPassBase\");\n\n/**\n * DepthRenderObject forms an abstract base class for the default shaded materials provided by Stage,\n * using material methods to define their appearance.\n */\nclass DepthPass extends RenderPassBase\n{\n\n\tprivate _fragmentConstantsIndex:number;\n\tprivate _texturesIndex:number;\n\n\tconstructor(renderObject:RenderObjectBase, renderObjectOwner:IRenderObjectOwner, renderableClass:IRenderableClass, stage:Stage)\n\t{\n\t\tsuper(renderObject, renderObjectOwner, renderableClass, stage);\n\n\t\tthis._shader = new ShaderObjectBase(renderableClass, this, this._stage);\n\t}\n\n\tpublic _iIncludeDependencies(shaderObject:ShaderObjectBase)\n\t{\n\t\tsuper._iIncludeDependencies(shaderObject);\n\n\t\tshaderObject.projectionDependencies++;\n\n\t\tif (shaderObject.alphaThreshold > 0)\n\t\t\tshaderObject.uvDependencies++;\n\t}\n\n\n\tpublic _iInitConstantData(shaderObject:ShaderObjectBase)\n\t{\n\t\tsuper._iInitConstantData(shaderObject);\n\n\t\tvar index:number = this._fragmentConstantsIndex;\n\t\tvar data:Array<number> = shaderObject.fragmentConstantData;\n\t\tdata[index] = 1.0;\n\t\tdata[index + 1] = 255.0;\n\t\tdata[index + 2] = 65025.0;\n\t\tdata[index + 3] = 16581375.0;\n\t\tdata[index + 4] = 1.0/255.0;\n\t\tdata[index + 5] = 1.0/255.0;\n\t\tdata[index + 6] = 1.0/255.0;\n\t\tdata[index + 7] = 0.0;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iGetFragmentCode(shaderObject:ShaderObjectBase, registerCache:ShaderRegisterCache, sharedRegisters:ShaderRegisterData):string\n\t{\n\t\tvar code:string = \"\";\n\t\tvar targetReg:ShaderRegisterElement = sharedRegisters.shadedTarget;\n\t\tvar diffuseInputReg:ShaderRegisterElement = registerCache.getFreeTextureReg();\n\t\tvar dataReg1:ShaderRegisterElement = registerCache.getFreeFragmentConstant();\n\t\tvar dataReg2:ShaderRegisterElement = registerCache.getFreeFragmentConstant();\n\n\t\tthis._fragmentConstantsIndex = dataReg1.index*4;\n\n\t\tvar temp1:ShaderRegisterElement = registerCache.getFreeFragmentVectorTemp();\n\t\tregisterCache.addFragmentTempUsages(temp1, 1);\n\t\tvar temp2:ShaderRegisterElement = registerCache.getFreeFragmentVectorTemp();\n\t\tregisterCache.addFragmentTempUsages(temp2, 1);\n\n\t\tcode += \"div \" + temp1 + \", \" + sharedRegisters.projectionFragment + \", \" + sharedRegisters.projectionFragment + \".w\\n\" + //\"sub ft2.z, fc0.x, ft2.z\\n\" +    //invert\n\t\t\"mul \" + temp1 + \", \" + dataReg1 + \", \" + temp1 + \".z\\n\" +\n\t\t\"frc \" + temp1 + \", \" + temp1 + \"\\n\" +\n\t\t\"mul \" + temp2 + \", \" + temp1 + \".yzww, \" + dataReg2 + \"\\n\";\n\n\t\t//codeF += \"mov ft1.w, fc1.w\t\\n\" +\n\t\t//    \"mov ft0.w, fc0.x\t\\n\";\n\n\t\tif (shaderObject.alphaThreshold > 0) {\n\t\t\tdiffuseInputReg = registerCache.getFreeTextureReg();\n\n\t\t\tthis._texturesIndex = diffuseInputReg.index;\n\n\t\t\tvar albedo:ShaderRegisterElement = registerCache.getFreeFragmentVectorTemp();\n\t\t\tcode += ShaderCompilerHelper.getTex2DSampleCode(albedo, sharedRegisters, diffuseInputReg, shaderObject.texture, shaderObject.useSmoothTextures, shaderObject.repeatTextures, shaderObject.useMipmapping);\n\n\t\t\tvar cutOffReg:ShaderRegisterElement = registerCache.getFreeFragmentConstant();\n\n\t\t\tcode += \"sub \" + albedo + \".w, \" + albedo + \".w, \" + cutOffReg + \".x\\n\" +\n\t\t\t\"kil \" + albedo + \".w\\n\";\n\t\t}\n\n\t\tcode += \"sub \" + targetReg + \", \" + temp1 + \", \" + temp2 + \"\\n\";\n\n\t\tregisterCache.removeFragmentTempUsage(temp1);\n\t\tregisterCache.removeFragmentTempUsage(temp2);\n\n\t\treturn code;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iActivate(camera:Camera)\n\t{\n\t\tsuper._iActivate(camera);\n\n\t\tvar context:IContextGL = this._stage.context;\n\n\t\tif (this._shader.alphaThreshold > 0) {\n\t\t\tcontext.setSamplerStateAt(this._texturesIndex, this._shader.repeatTextures? ContextGLWrapMode.REPEAT:ContextGLWrapMode.CLAMP, this._shader.useSmoothTextures? ContextGLTextureFilter.LINEAR : ContextGLTextureFilter.NEAREST, this._shader.useMipmapping? ContextGLMipFilter.MIPLINEAR : ContextGLMipFilter.MIPNONE);\n\t\t\tthis._stage.activateTexture(this._texturesIndex, this._shader.texture);\n\n\t\t\tthis._shader.fragmentConstantData[this._fragmentConstantsIndex + 8] = this._shader.alphaThreshold;\n\t\t}\n\t}\n\n}\n\nexport = DepthPass;","﻿import Matrix3D\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3D\");\nimport Matrix3DUtils\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3DUtils\");\nimport Texture2DBase\t\t\t\t= require(\"awayjs-core/lib/textures/Texture2DBase\");\n\nimport IRenderObjectOwner\t\t\t= require(\"awayjs-display/lib/base/IRenderObjectOwner\");\nimport MaterialBase\t\t\t\t\t= require(\"awayjs-display/lib/materials/MaterialBase\");\nimport Camera\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\n\nimport ContextGLMipFilter\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLMipFilter\");\nimport ContextGLTextureFilter\t\t= require(\"awayjs-stagegl/lib/base/ContextGLTextureFilter\");\nimport ContextGLWrapMode\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLWrapMode\");\nimport IContextGL\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/IContextGL\");\nimport Stage\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\n\nimport RenderObjectPool\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/RenderObjectPool\");\nimport RenderObjectBase\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/RenderObjectBase\");\nimport ShaderObjectBase\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport ShaderRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterCache\");\nimport ShaderRegisterData\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterData\");\nimport ShaderRegisterElement\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\nimport ShaderCompilerHelper\t\t\t= require(\"awayjs-renderergl/lib/utils/ShaderCompilerHelper\");\nimport IRenderableClass\t\t\t\t= require(\"awayjs-renderergl/lib/pool/IRenderableClass\");\nimport RenderPassBase\t\t\t\t= require(\"awayjs-renderergl/lib/passes/RenderPassBase\");\n\n/**\n * DistancePass is a pass that writes distance values to a depth map as a 32-bit value exploded over the 4 texture channels.\n * This is used to render omnidirectional shadow maps.\n */\nclass DistancePass extends RenderPassBase\n{\n\tprivate _fragmentConstantsIndex:number;\n\tprivate _texturesIndex:number;\n\n\t/**\n\t * Creates a new DistancePass object.\n\t *\n\t * @param material The material to which this pass belongs.\n\t */\n\tconstructor(renderObject:RenderObjectBase, renderObjectOwner:IRenderObjectOwner, renderableClass:IRenderableClass, stage:Stage)\n\t{\n\t\tsuper(renderObject, renderObjectOwner, renderableClass, stage);\n\n\t\tthis._shader = new ShaderObjectBase(renderableClass, this, this._stage);\n\t}\n\n\t/**\n\t * Initializes the unchanging constant data for this material.\n\t */\n\tpublic _iInitConstantData(shaderObject:ShaderObjectBase)\n\t{\n\t\tsuper._iInitConstantData(shaderObject);\n\n\t\tvar index:number = this._fragmentConstantsIndex;\n\t\tvar data:Array<number> = shaderObject.fragmentConstantData;\n\t\tdata[index + 4] = 1.0/255.0;\n\t\tdata[index + 5] = 1.0/255.0;\n\t\tdata[index + 6] = 1.0/255.0;\n\t\tdata[index + 7] = 0.0;\n\t}\n\n\tpublic _iIncludeDependencies(shaderObject:ShaderObjectBase)\n\t{\n\t\tsuper._iIncludeDependencies(shaderObject);\n\n\t\tshaderObject.projectionDependencies++;\n\t\tshaderObject.viewDirDependencies++;\n\n\t\tif (shaderObject.alphaThreshold > 0)\n\t\t\tshaderObject.uvDependencies++;\n\n\t\tif (shaderObject.viewDirDependencies > 0)\n\t\t\tshaderObject.globalPosDependencies++;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iGetFragmentCode(shaderObject:ShaderObjectBase, registerCache:ShaderRegisterCache, sharedRegisters:ShaderRegisterData):string\n\t{\n\t\tvar code:string;\n\t\tvar targetReg:ShaderRegisterElement = sharedRegisters.shadedTarget;\n\t\tvar diffuseInputReg:ShaderRegisterElement = registerCache.getFreeTextureReg();\n\t\tvar dataReg1:ShaderRegisterElement = registerCache.getFreeFragmentConstant();\n\t\tvar dataReg2:ShaderRegisterElement = registerCache.getFreeFragmentConstant()\n\n\t\tthis._fragmentConstantsIndex = dataReg1.index*4;\n\n\t\tvar temp1:ShaderRegisterElement = registerCache.getFreeFragmentVectorTemp();\n\t\tregisterCache.addFragmentTempUsages(temp1, 1);\n\t\tvar temp2:ShaderRegisterElement = registerCache.getFreeFragmentVectorTemp();\n\t\tregisterCache.addFragmentTempUsages(temp2, 1);\n\n\t\t// squared distance to view\n\t\tcode = \"dp3 \" + temp1 + \".z, \" + sharedRegisters.viewDirVarying + \".xyz, \" + sharedRegisters.viewDirVarying + \".xyz\\n\" +\n\t\t\t   \"mul \" + temp1 + \", \" + dataReg1 + \", \" + temp1 + \".z\\n\" +\n\t\t\t   \"frc \" + temp1 + \", \" + temp1 + \"\\n\" +\n\t\t\t   \"mul \" + temp2 + \", \" + temp1 + \".yzww, \" + dataReg2 + \"\\n\";\n\n\t\tif (shaderObject.alphaThreshold > 0) {\n\t\t\tdiffuseInputReg = registerCache.getFreeTextureReg();\n\n\t\t\tthis._texturesIndex = diffuseInputReg.index;\n\n\t\t\tvar albedo:ShaderRegisterElement = registerCache.getFreeFragmentVectorTemp();\n\t\t\tcode += ShaderCompilerHelper.getTex2DSampleCode(albedo, sharedRegisters, diffuseInputReg, shaderObject.texture, shaderObject.useSmoothTextures, shaderObject.repeatTextures, shaderObject.useMipmapping);\n\n\t\t\tvar cutOffReg:ShaderRegisterElement = registerCache.getFreeFragmentConstant();\n\n\t\t\tcode += \"sub \" + albedo + \".w, \" + albedo + \".w, \" + cutOffReg + \".x\\n\" +\n\t\t\t\t\"kil \" + albedo + \".w\\n\";\n\t\t}\n\n\t\tcode += \"sub \" + targetReg + \", \" + temp1 + \", \" + temp2 + \"\\n\";\n\n\t\treturn code;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iActivate(camera:Camera)\n\t{\n\t\tsuper._iActivate(camera);\n\n\t\tvar context:IContextGL = this._stage.context;\n\n\t\tvar f:number = camera.projection.far;\n\n\t\tf = 1/(2*f*f);\n\t\t// sqrt(f*f+f*f) is largest possible distance for any frustum, so we need to divide by it. Rarely a tight fit, but with 32 bits precision, it's enough.\n\t\tvar index:number = this._fragmentConstantsIndex;\n\t\tvar data:Array<number> = this._shader.fragmentConstantData;\n\t\tdata[index] = 1.0*f;\n\t\tdata[index + 1] = 255.0*f;\n\t\tdata[index + 2] = 65025.0*f;\n\t\tdata[index + 3] = 16581375.0*f;\n\n\t\tif (this._shader.alphaThreshold > 0) {\n\t\t\tcontext.setSamplerStateAt(this._texturesIndex, this._shader.repeatTextures? ContextGLWrapMode.REPEAT:ContextGLWrapMode.CLAMP, this._shader.useSmoothTextures? ContextGLTextureFilter.LINEAR : ContextGLTextureFilter.NEAREST, this._shader.useMipmapping? ContextGLMipFilter.MIPLINEAR : ContextGLMipFilter.MIPNONE);\n\t\t\tthis._stage.activateTexture(this._texturesIndex, this._shader.texture);\n\n\t\t\tdata[index + 8] = this._shader.alphaThreshold;\n\t\t}\n\t}\n}\n\nexport = DistancePass;","import Matrix3D\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3D\");\nimport Matrix3DUtils\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3DUtils\");\nimport NamedAssetBase\t\t\t\t= require(\"awayjs-core/lib/library/NamedAssetBase\");\nimport ArgumentError\t\t\t\t= require(\"awayjs-core/lib/errors/ArgumentError\");\nimport Event\t\t\t\t\t\t= require(\"awayjs-core/lib/events/Event\");\nimport EventDispatcher\t\t\t\t= require(\"awayjs-core/lib/events/EventDispatcher\");\n\nimport BlendMode\t\t\t\t\t= require(\"awayjs-display/lib/base/BlendMode\");\nimport Camera\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\nimport LightPickerBase\t\t\t\t= require(\"awayjs-display/lib/materials/lightpickers/LightPickerBase\");\nimport IRenderObjectOwner\t\t\t= require(\"awayjs-display/lib/base/IRenderObjectOwner\");\n\nimport Stage\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\")\nimport ContextGLBlendFactor\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLBlendFactor\");\nimport ContextGLCompareMode\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLCompareMode\");\n\nimport AnimationSetBase\t\t\t\t= require(\"awayjs-renderergl/lib/animators/AnimationSetBase\");\nimport RendererBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/base/RendererBase\");\nimport RenderableBase\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\nimport ShaderObjectBase\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport ShaderRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterCache\");\nimport ShaderRegisterData\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterData\");\nimport IRenderableClass\t\t\t\t= require(\"awayjs-renderergl/lib/pool/IRenderableClass\");\nimport IRenderPassBase\t\t\t\t= require(\"awayjs-renderergl/lib/passes/IRenderPassBase\");\nimport RenderObjectBase\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/RenderObjectBase\");\n\n/**\n * RenderPassBase provides an abstract base class for material shader passes. A material pass constitutes at least\n * a render call per required renderable.\n */\nclass RenderPassBase extends EventDispatcher implements IRenderPassBase\n{\n\tprivate _renderObject:RenderObjectBase;\n\tpublic _renderObjectOwner:IRenderObjectOwner;\n\tpublic _renderableClass:IRenderableClass;\n\tpublic _stage:Stage;\n\t\n\tpublic _shader:ShaderObjectBase;\n\n\tprivate _preserveAlpha:boolean = true;\n\tprivate _forceSeparateMVP:boolean = false;\n\n\tprivate _depthCompareMode:string = ContextGLCompareMode.LESS_EQUAL;\n\n\tprivate _blendFactorSource:string = ContextGLBlendFactor.ONE;\n\tprivate _blendFactorDest:string = ContextGLBlendFactor.ZERO;\n\n\tpublic _pEnableBlending:boolean = false;\n\n\tprivate _writeDepth:boolean = true;\n\n\tpublic get shader():ShaderObjectBase\n\t{\n\t\treturn this._shader;\n\t}\n\n\tpublic get animationSet():AnimationSetBase\n\t{\n\t\treturn <AnimationSetBase> this._renderObjectOwner.animationSet;\n\t}\n\n\t/**\n\t * Indicates whether the output alpha value should remain unchanged compared to the material's original alpha.\n\t */\n\tpublic get preserveAlpha():boolean\n\t{\n\t\treturn this._preserveAlpha;\n\t}\n\n\tpublic set preserveAlpha(value:boolean)\n\t{\n\t\tif (this._preserveAlpha == value)\n\t\t\treturn;\n\n\t\tthis._preserveAlpha = value;\n\n\t\tthis.invalidatePass();\n\t}\n\n\t/**\n\t * Indicates whether the screen projection should be calculated by forcing a separate scene matrix and\n\t * view-projection matrix. This is used to prevent rounding errors when using multiple passes with different\n\t * projection code.\n\t */\n\tpublic get forceSeparateMVP():boolean\n\t{\n\t\treturn this._forceSeparateMVP;\n\t}\n\n\tpublic set forceSeparateMVP(value:boolean)\n\t{\n\t\tif (this._forceSeparateMVP == value)\n\t\t\treturn;\n\n\t\tthis._forceSeparateMVP = value;\n\n\t\tthis.invalidatePass();\n\t}\n\n\t/**\n\t * Creates a new RenderPassBase object.\n\t */\n\tconstructor(renderObject:RenderObjectBase, renderObjectOwner:IRenderObjectOwner, renderableClass:IRenderableClass, stage:Stage)\n\t{\n\t\tsuper();\n\n\t\tthis._renderObject = renderObject;\n\t\tthis._renderObjectOwner = renderObjectOwner;\n\t\tthis._renderableClass = renderableClass;\n\t\tthis._stage = stage;\n\t}\n\t\n\n\t/**\n\t * Indicate whether this pass should write to the depth buffer or not. Ignored when blending is enabled.\n\t */\n\tpublic get writeDepth():boolean\n\t{\n\t\treturn this._writeDepth;\n\t}\n\n\tpublic set writeDepth(value:boolean)\n\t{\n\t\tthis._writeDepth = value;\n\t}\n\n\t/**\n\t * The depth compare mode used to render the renderables using this material.\n\t *\n\t * @see away.stagegl.ContextGLCompareMode\n\t */\n\tpublic get depthCompareMode():string\n\t{\n\t\treturn this._depthCompareMode;\n\t}\n\n\tpublic set depthCompareMode(value:string)\n\t{\n\t\tthis._depthCompareMode = value;\n\t}\n\n\t/**\n\t * Cleans up any resources used by the current object.\n\t * @param deep Indicates whether other resources should be cleaned up, that could potentially be shared across different instances.\n\t */\n\tpublic dispose()\n\t{\n\t\tthis._shader.dispose();\n\n\t\tthis._shader = null;\n\t}\n\n\t/**\n\t * Renders the current pass. Before calling renderPass, activatePass needs to be called with the same index.\n\t * @param pass The pass used to render the renderable.\n\t * @param renderable The IRenderable object to draw.\n\t * @param stage The Stage object used for rendering.\n\t * @param entityCollector The EntityCollector object that contains the visible scene data.\n\t * @param viewProjection The view-projection matrix used to project to the screen. This is not the same as\n\t * camera.viewProjection as it includes the scaling factors when rendering to textures.\n\t *\n\t * @internal\n\t */\n\tpublic _iRender(renderable:RenderableBase, camera:Camera, viewProjection:Matrix3D)\n\t{\n\t\tthis._shader._iRender(renderable, camera, viewProjection);\n\t}\n\t/**\n\t * The blend mode to use when drawing this renderable. The following blend modes are supported:\n\t * <ul>\n\t * <li>BlendMode.NORMAL: No blending, unless the material inherently needs it</li>\n\t * <li>BlendMode.LAYER: Force blending. This will draw the object the same as NORMAL, but without writing depth writes.</li>\n\t * <li>BlendMode.MULTIPLY</li>\n\t * <li>BlendMode.ADD</li>\n\t * <li>BlendMode.ALPHA</li>\n\t * </ul>\n\t */\n\tpublic setBlendMode(value:string)\n\t{\n\t\tswitch (value) {\n\t\t\tcase BlendMode.NORMAL:\n\t\t\t\tthis._blendFactorSource = ContextGLBlendFactor.ONE;\n\t\t\t\tthis._blendFactorDest = ContextGLBlendFactor.ZERO;\n\t\t\t\tthis._pEnableBlending = false;\n\t\t\t\tbreak;\n\n\t\t\tcase BlendMode.LAYER:\n\t\t\t\tthis._blendFactorSource = ContextGLBlendFactor.SOURCE_ALPHA;\n\t\t\t\tthis._blendFactorDest = ContextGLBlendFactor.ONE_MINUS_SOURCE_ALPHA;\n\t\t\t\tthis._pEnableBlending = true;\n\t\t\t\tbreak;\n\n\t\t\tcase BlendMode.MULTIPLY:\n\t\t\t\tthis._blendFactorSource = ContextGLBlendFactor.ZERO;\n\t\t\t\tthis._blendFactorDest = ContextGLBlendFactor.SOURCE_COLOR;\n\t\t\t\tthis._pEnableBlending = true;\n\t\t\t\tbreak;\n\n\t\t\tcase BlendMode.ADD:\n\t\t\t\tthis._blendFactorSource = ContextGLBlendFactor.SOURCE_ALPHA;\n\t\t\t\tthis._blendFactorDest = ContextGLBlendFactor.ONE;\n\t\t\t\tthis._pEnableBlending = true;\n\t\t\t\tbreak;\n\n\t\t\tcase BlendMode.ALPHA:\n\t\t\t\tthis._blendFactorSource = ContextGLBlendFactor.ZERO;\n\t\t\t\tthis._blendFactorDest = ContextGLBlendFactor.SOURCE_ALPHA;\n\t\t\t\tthis._pEnableBlending = true;\n\t\t\t\tbreak;\n\n\t\t\tdefault:\n\t\t\t\tthrow new ArgumentError(\"Unsupported blend mode!\");\n\t\t}\n\t}\n\n\t/**\n\t * Sets the render state for the pass that is independent of the rendered object. This needs to be called before\n\t * calling renderPass. Before activating a pass, the previously used pass needs to be deactivated.\n\t * @param stage The Stage object which is currently used for rendering.\n\t * @param camera The camera from which the scene is viewed.\n\t * @private\n\t */\n\tpublic _iActivate(camera:Camera)\n\t{\n\t\tthis._stage.context.setDepthTest(( this._writeDepth && !this._pEnableBlending ), this._depthCompareMode);\n\n\t\tif (this._pEnableBlending)\n\t\t\tthis._stage.context.setBlendFactors(this._blendFactorSource, this._blendFactorDest);\n\n\t\tthis._shader._iActivate(camera);\n\t}\n\n\t/**\n\t * Clears the render state for the pass. This needs to be called before activating another pass.\n\t * @param stage The Stage used for rendering\n\t *\n\t * @private\n\t */\n\tpublic _iDeactivate()\n\t{\n\t\tthis._shader._iDeactivate();\n\n\t\t//For the love of god don't remove this if you want your multi-material shadows to not flicker like shit\n\t\tthis._stage.context.setDepthTest(true, ContextGLCompareMode.LESS_EQUAL);\n\t}\n\n\t/**\n\t * Marks the shader program as invalid, so it will be recompiled before the next render.\n\t *\n\t * @param updateMaterial Indicates whether the invalidation should be performed on the entire material. Should always pass \"true\" unless it's called from the material itself.\n\t */\n\tpublic invalidatePass()\n\t{\n\t\tthis._shader.invalidateShader();\n\n\t\tthis.dispatchEvent(new Event(Event.CHANGE));\n\t}\n\n\tpublic _iIncludeDependencies(shaderObject:ShaderObjectBase)\n\t{\n\t\tthis._renderObject._iIncludeDependencies(shaderObject);\n\t\t\n\t\tif (this._forceSeparateMVP)\n\t\t\tshaderObject.globalPosDependencies++;\n\t}\n\n\n\tpublic _iInitConstantData(shaderObject:ShaderObjectBase)\n\t{\n\n\t}\n\n\tpublic _iGetPreLightingVertexCode(shaderObject:ShaderObjectBase, registerCache:ShaderRegisterCache, sharedRegisters:ShaderRegisterData):string\n\t{\n\t\treturn \"\";\n\t}\n\n\tpublic _iGetPreLightingFragmentCode(shaderObject:ShaderObjectBase, registerCache:ShaderRegisterCache, sharedRegisters:ShaderRegisterData):string\n\t{\n\t\treturn \"\";\n\t}\n\n\tpublic _iGetVertexCode(shaderObject:ShaderObjectBase, registerCache:ShaderRegisterCache, sharedRegisters:ShaderRegisterData):string\n\t{\n\t\treturn \"\";\n\t}\n\n\tpublic _iGetFragmentCode(shaderObject:ShaderObjectBase, registerCache:ShaderRegisterCache, sharedRegisters:ShaderRegisterData):string\n\t{\n\t\treturn \"\";\n\t}\n\n\tpublic _iGetNormalVertexCode(shaderObject:ShaderObjectBase, registerCache:ShaderRegisterCache, sharedRegisters:ShaderRegisterData):string\n\t{\n\t\treturn \"\";\n\t}\n\n\tpublic _iGetNormalFragmentCode(shaderObject:ShaderObjectBase, registerCache:ShaderRegisterCache, sharedRegisters:ShaderRegisterData):string\n\t{\n\t\treturn \"\";\n\t}\n\n\t/**\n\t * Indicates whether or not normals are calculated at all.\n\t */\n\tpublic _pOutputsNormals(shaderObject:ShaderObjectBase):boolean\n\t{\n\t\treturn false;\n\t}\n\n\t/**\n\t * Indicates whether or not normals are calculated in tangent space.\n\t */\n\tpublic _pOutputsTangentNormals(shaderObject:ShaderObjectBase):boolean\n\t{\n\t\treturn false;\n\t}\n\n\t/**\n\t * Indicates whether or not normals are allowed in tangent space. This is only the case if no object-space\n\t * dependencies exist.\n\t */\n\tpublic _pUsesTangentSpace(shaderObject:ShaderObjectBase):boolean\n\t{\n\t\treturn false;\n\t}\n}\n\nexport = RenderPassBase;","import Matrix\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix\");\nimport Matrix3D\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3D\");\nimport Matrix3DUtils\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3DUtils\");\nimport Texture2DBase\t\t\t\t= require(\"awayjs-core/lib/textures/Texture2DBase\");\n\nimport BlendMode\t\t\t\t\t= require(\"awayjs-display/lib/base/BlendMode\");\nimport Camera\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\nimport Skybox\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Skybox\");\nimport IRenderObjectOwner\t\t\t= require(\"awayjs-display/lib/base/IRenderObjectOwner\");\n\nimport ContextGLCompareMode\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLCompareMode\");\nimport ContextGLProgramType\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLProgramType\");\nimport ContextGLMipFilter\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLMipFilter\");\nimport ContextGLTextureFilter\t\t= require(\"awayjs-stagegl/lib/base/ContextGLTextureFilter\");\nimport ContextGLWrapMode\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLWrapMode\");\nimport IContextGL\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/IContextGL\");\nimport Stage\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\n\nimport RenderableBase\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\nimport RenderPassBase\t\t\t\t= require(\"awayjs-renderergl/lib/passes/RenderPassBase\");\nimport RenderObjectBase\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/RenderObjectBase\");\nimport RenderObjectPool\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/RenderObjectPool\");\nimport ShaderObjectBase\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport ShaderRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterCache\");\nimport ShaderRegisterData\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterData\");\nimport ShaderRegisterElement\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\nimport ShaderCompilerHelper\t\t\t= require(\"awayjs-renderergl/lib/utils/ShaderCompilerHelper\");\nimport IRenderableClass\t\t\t\t= require(\"awayjs-renderergl/lib/pool/IRenderableClass\");\n\n/**\n * SkyboxPass forms an abstract base class for the default shaded materials provided by Stage,\n * using material methods to define their appearance.\n */\nclass SkyboxPass extends RenderPassBase\n{\n\tpublic _skybox:Skybox;\n\n\tconstructor(renderObject:RenderObjectBase, renderObjectOwner:IRenderObjectOwner, renderableClass:IRenderableClass, stage:Stage)\n\t{\n\t\tsuper(renderObject, renderObjectOwner, renderableClass, stage);\n\n\t\tthis._skybox = <Skybox> renderObjectOwner;\n\n\t\tthis._shader = new ShaderObjectBase(renderableClass, this, this._stage);\n\t}\n\n\n\t/**\n\t* @inheritDoc\n\t*/\n\tpublic _iGetFragmentCode(shaderObject:ShaderObjectBase, registerCache:ShaderRegisterCache, sharedRegisters:ShaderRegisterData):string\n\t{\n\t\t//var cubeMapReg:ShaderRegisterElement = registerCache.getFreeTextureReg();\n\n\t\t//this._texturesIndex = cubeMapReg.index;\n\n\t\t//ShaderCompilerHelper.getTexCubeSampleCode(sharedRegisters.shadedTarget, cubeMapReg, this._cubeTexture, shaderObject.useSmoothTextures, shaderObject.useMipmapping);\n\n\t\tvar mip:string = \",mipnone\";\n\n\t\tif (this._skybox.cubeMap.hasMipmaps)\n\t\t\tmip = \",miplinear\";\n\n\t\treturn \"tex ft0, v0, fs0 <cube,\" + ShaderCompilerHelper.getFormatStringForTexture(this._skybox.cubeMap) + \"linear,clamp\" + mip + \">\\n\";\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iActivate(camera:Camera)\n\t{\n\t\tsuper._iActivate(camera);\n\n\t\tvar context:IContextGL = this._stage.context;\n\t\tcontext.setSamplerStateAt(0, ContextGLWrapMode.CLAMP, ContextGLTextureFilter.LINEAR, this._skybox.cubeMap.hasMipmaps? ContextGLMipFilter.MIPLINEAR : ContextGLMipFilter.MIPNONE);\n\t\tcontext.setDepthTest(false, ContextGLCompareMode.LESS);\n\t\tthis._stage.activateCubeTexture(0, this._skybox.cubeMap);\n\t}\n}\n\nexport = SkyboxPass;","import Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport TriangleSubGeometry\t\t\t\t= require(\"awayjs-display/lib/base/TriangleSubGeometry\");\nimport PickingCollisionVO\t\t\t\t= require(\"awayjs-display/lib/pick/PickingCollisionVO\");\nimport IPickingCollider\t\t\t\t\t= require(\"awayjs-display/lib/pick/IPickingCollider\");\nimport MaterialBase\t\t\t\t\t\t= require(\"awayjs-display/lib/materials/MaterialBase\");\n\nimport Stage\t\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\n\nimport PickingColliderBase\t\t\t\t= require(\"awayjs-renderergl/lib/pick/PickingColliderBase\");\nimport RenderableBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\n\n/**\n * Pure JS picking collider for display objects. Used with the <code>RaycastPicker</code> picking object.\n *\n * @see away.base.DisplayObject#pickingCollider\n * @see away.pick.RaycastPicker\n *\n * @class away.pick.JSPickingCollider\n */\nclass JSPickingCollider extends PickingColliderBase implements IPickingCollider\n{\n\tprivate _findClosestCollision:boolean;\n\n\t/**\n\t * Creates a new <code>JSPickingCollider</code> object.\n\t *\n\t * @param findClosestCollision Determines whether the picking collider searches for the closest collision along the ray. Defaults to false.\n\t */\n\tconstructor(stage:Stage, findClosestCollision:boolean = false)\n\t{\n\t\tsuper(stage);\n\n\t\tthis._findClosestCollision = findClosestCollision;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _pTestRenderableCollision(renderable:RenderableBase, pickingCollisionVO:PickingCollisionVO, shortestCollisionDistance:number):boolean\n\t{\n\t\tvar t:number;\n\t\tvar i0:number, i1:number, i2:number;\n\t\tvar rx:number, ry:number, rz:number;\n\t\tvar nx:number, ny:number, nz:number;\n\t\tvar cx:number, cy:number, cz:number;\n\t\tvar coeff:number, u:number, v:number, w:number;\n\t\tvar p0x:number, p0y:number, p0z:number;\n\t\tvar p1x:number, p1y:number, p1z:number;\n\t\tvar p2x:number, p2y:number, p2z:number;\n\t\tvar s0x:number, s0y:number, s0z:number;\n\t\tvar s1x:number, s1y:number, s1z:number;\n\t\tvar nl:number, nDotV:number, D:number, disToPlane:number;\n\t\tvar Q1Q2:number, Q1Q1:number, Q2Q2:number, RQ1:number, RQ2:number;\n\t\tvar indexData:Array<number> = renderable.getIndexData().data;\n\t\tvar collisionTriangleIndex:number = -1;\n\t\tvar bothSides:boolean = (<MaterialBase> renderable.renderObjectOwner).bothSides;\n\n\t\tvar positionData:Array<number> = renderable.getVertexData(TriangleSubGeometry.POSITION_DATA).data;\n\t\tvar positionStride:number = renderable.getVertexData(TriangleSubGeometry.POSITION_DATA).dataPerVertex;\n\t\tvar positionOffset:number = renderable.getVertexOffset(TriangleSubGeometry.POSITION_DATA);\n\t\tvar uvData:Array<number> = renderable.getVertexData(TriangleSubGeometry.UV_DATA).data;\n\t\tvar uvStride:number = renderable.getVertexData(TriangleSubGeometry.UV_DATA).dataPerVertex;\n\t\tvar uvOffset:number = renderable.getVertexOffset(TriangleSubGeometry.UV_DATA);\n\t\tvar numIndices:number = indexData.length;\n\n\t\tfor (var index:number = 0; index < numIndices; index += 3) { // sweep all triangles\n\t\t\t// evaluate triangle indices\n\t\t\ti0 = positionOffset + indexData[ index ]*positionStride;\n\t\t\ti1 = positionOffset + indexData[ (index + 1) ]*positionStride;\n\t\t\ti2 = positionOffset + indexData[ (index + 2) ]*positionStride;\n\n\t\t\t// evaluate triangle positions\n\t\t\tp0x = positionData[ i0 ];\n\t\t\tp0y = positionData[ (i0 + 1) ];\n\t\t\tp0z = positionData[ (i0 + 2) ];\n\t\t\tp1x = positionData[ i1 ];\n\t\t\tp1y = positionData[ (i1 + 1) ];\n\t\t\tp1z = positionData[ (i1 + 2) ];\n\t\t\tp2x = positionData[ i2 ];\n\t\t\tp2y = positionData[ (i2 + 1) ];\n\t\t\tp2z = positionData[ (i2 + 2) ];\n\n\t\t\t// evaluate sides and triangle normal\n\t\t\ts0x = p1x - p0x; // s0 = p1 - p0\n\t\t\ts0y = p1y - p0y;\n\t\t\ts0z = p1z - p0z;\n\t\t\ts1x = p2x - p0x; // s1 = p2 - p0\n\t\t\ts1y = p2y - p0y;\n\t\t\ts1z = p2z - p0z;\n\t\t\tnx = s0y*s1z - s0z*s1y; // n = s0 x s1\n\t\t\tny = s0z*s1x - s0x*s1z;\n\t\t\tnz = s0x*s1y - s0y*s1x;\n\t\t\tnl = 1/Math.sqrt(nx*nx + ny*ny + nz*nz); // normalize n\n\t\t\tnx *= nl;\n\t\t\tny *= nl;\n\t\t\tnz *= nl;\n\n\t\t\t// -- plane intersection test --\n\t\t\tnDotV = nx*this.rayDirection.x + ny* +this.rayDirection.y + nz*this.rayDirection.z; // rayDirection . normal\n\t\t\tif (( !bothSides && nDotV < 0.0 ) || ( bothSides && nDotV != 0.0 )) { // an intersection must exist\n\t\t\t\t// find collision t\n\t\t\t\tD = -( nx*p0x + ny*p0y + nz*p0z );\n\t\t\t\tdisToPlane = -( nx*this.rayPosition.x + ny*this.rayPosition.y + nz*this.rayPosition.z + D );\n\t\t\t\tt = disToPlane/nDotV;\n\t\t\t\t// find collision point\n\t\t\t\tcx = this.rayPosition.x + t*this.rayDirection.x;\n\t\t\t\tcy = this.rayPosition.y + t*this.rayDirection.y;\n\t\t\t\tcz = this.rayPosition.z + t*this.rayDirection.z;\n\t\t\t\t// collision point inside triangle? ( using barycentric coordinates )\n\t\t\t\tQ1Q2 = s0x*s1x + s0y*s1y + s0z*s1z;\n\t\t\t\tQ1Q1 = s0x*s0x + s0y*s0y + s0z*s0z;\n\t\t\t\tQ2Q2 = s1x*s1x + s1y*s1y + s1z*s1z;\n\t\t\t\trx = cx - p0x;\n\t\t\t\try = cy - p0y;\n\t\t\t\trz = cz - p0z;\n\t\t\t\tRQ1 = rx*s0x + ry*s0y + rz*s0z;\n\t\t\t\tRQ2 = rx*s1x + ry*s1y + rz*s1z;\n\t\t\t\tcoeff = 1/( Q1Q1*Q2Q2 - Q1Q2*Q1Q2 );\n\t\t\t\tv = coeff*( Q2Q2*RQ1 - Q1Q2*RQ2 );\n\t\t\t\tw = coeff*( -Q1Q2*RQ1 + Q1Q1*RQ2 );\n\t\t\t\tif (v < 0)\n\t\t\t\t\tcontinue;\n\t\t\t\tif (w < 0)\n\t\t\t\t\tcontinue;\n\t\t\t\tu = 1 - v - w;\n\t\t\t\tif (!( u < 0 ) && t > 0 && t < shortestCollisionDistance) { // all tests passed\n\t\t\t\t\tshortestCollisionDistance = t;\n\t\t\t\t\tcollisionTriangleIndex = index/3;\n\t\t\t\t\tpickingCollisionVO.rayEntryDistance = t;\n\t\t\t\t\tpickingCollisionVO.localPosition = new Vector3D(cx, cy, cz);\n\t\t\t\t\tpickingCollisionVO.localNormal = new Vector3D(nx, ny, nz);\n\t\t\t\t\tpickingCollisionVO.uv = this._pGetCollisionUV(indexData, uvData, index, v, w, u, uvOffset, uvStride);\n\t\t\t\t\tpickingCollisionVO.index = index;\n//\t\t\t\t\t\tpickingCollisionVO.subGeometryIndex = this.pGetMeshSubMeshIndex(renderable);\n\n\t\t\t\t\t// if not looking for best hit, first found will do...\n\t\t\t\t\tif (!this._findClosestCollision)\n\t\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\n\t\tif (collisionTriangleIndex >= 0)\n\t\t\treturn true;\n\n\t\treturn false;\n\t}\n}\n\nexport = JSPickingCollider;","import Point\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Point\");\nimport Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\nimport AbstractMethodError\t\t\t\t= require(\"awayjs-core/lib/errors/AbstractMethodError\");\n\nimport ISubMesh\t\t\t\t\t\t\t= require(\"awayjs-display/lib/base/ISubMesh\");\nimport PickingCollisionVO\t\t\t\t= require(\"awayjs-display/lib/pick/PickingCollisionVO\");\nimport Billboard\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Billboard\");\nimport Mesh\t\t\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Mesh\");\n\nimport Stage\t\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\n\nimport BillboardRenderable\t\t\t\t= require(\"awayjs-renderergl/lib/pool/BillboardRenderable\");\nimport RenderableBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\nimport TriangleSubMeshRenderable\t\t= require(\"awayjs-renderergl/lib/pool/TriangleSubMeshRenderable\");\nimport RenderablePoolBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderablePoolBase\");\n\n/**\n * An abstract base class for all picking collider classes. It should not be instantiated directly.\n *\n * @class away.pick.PickingColliderBase\n */\nclass PickingColliderBase\n{\n\tprivate _billboardRenderablePool:RenderablePoolBase;\n\tprivate _subMeshRenderablePool:RenderablePoolBase;\n\n\tpublic rayPosition:Vector3D;\n\tpublic rayDirection:Vector3D;\n\n\tconstructor(stage:Stage)\n\t{\n\t\t//TODO\n\t\tthis._billboardRenderablePool = RenderablePoolBase.getPool(BillboardRenderable, stage);\n\t\tthis._subMeshRenderablePool = RenderablePoolBase.getPool(TriangleSubMeshRenderable, stage);\n\t}\n\n\tpublic _pPetCollisionNormal(indexData:Array<number> /*uint*/, vertexData:Array<number>, triangleIndex:number):Vector3D // PROTECTED\n\t{\n\t\tvar normal:Vector3D = new Vector3D();\n\t\tvar i0:number = indexData[ triangleIndex ]*3;\n\t\tvar i1:number = indexData[ triangleIndex + 1 ]*3;\n\t\tvar i2:number = indexData[ triangleIndex + 2 ]*3;\n\t\tvar p0:Vector3D = new Vector3D(vertexData[ i0 ], vertexData[ i0 + 1 ], vertexData[ i0 + 2 ]);\n\t\tvar p1:Vector3D = new Vector3D(vertexData[ i1 ], vertexData[ i1 + 1 ], vertexData[ i1 + 2 ]);\n\t\tvar p2:Vector3D = new Vector3D(vertexData[ i2 ], vertexData[ i2 + 1 ], vertexData[ i2 + 2 ]);\n\t\tvar side0:Vector3D = p1.subtract(p0);\n\t\tvar side1:Vector3D = p2.subtract(p0);\n\t\tnormal = side0.crossProduct(side1);\n\t\tnormal.normalize();\n\t\treturn normal;\n\t}\n\n\tpublic _pGetCollisionUV(indexData:Array<number> /*uint*/, uvData:Array<number>, triangleIndex:number, v:number, w:number, u:number, uvOffset:number, uvStride:number):Point // PROTECTED\n\t{\n\t\tvar uv:Point = new Point();\n\t\tvar uIndex:number = indexData[ triangleIndex ]*uvStride + uvOffset;\n\t\tvar uv0:Vector3D = new Vector3D(uvData[ uIndex ], uvData[ uIndex + 1 ]);\n\t\tuIndex = indexData[ triangleIndex + 1 ]*uvStride + uvOffset;\n\t\tvar uv1:Vector3D = new Vector3D(uvData[ uIndex ], uvData[ uIndex + 1 ]);\n\t\tuIndex = indexData[ triangleIndex + 2 ]*uvStride + uvOffset;\n\t\tvar uv2:Vector3D = new Vector3D(uvData[ uIndex ], uvData[ uIndex + 1 ]);\n\t\tuv.x = u*uv0.x + v*uv1.x + w*uv2.x;\n\t\tuv.y = u*uv0.y + v*uv1.y + w*uv2.y;\n\t\treturn uv;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _pTestRenderableCollision(renderable:RenderableBase, pickingCollisionVO:PickingCollisionVO, shortestCollisionDistance:number):boolean\n\t{\n\t\tthrow new AbstractMethodError();\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic setLocalRay(localPosition:Vector3D, localDirection:Vector3D)\n\t{\n\t\tthis.rayPosition = localPosition;\n\t\tthis.rayDirection = localDirection;\n\t}\n\n\t/**\n\t * Tests a <code>Billboard</code> object for a collision with the picking ray.\n\t *\n\t * @param billboard The billboard instance to be tested.\n\t * @param pickingCollisionVO The collision object used to store the collision results\n\t * @param shortestCollisionDistance The current value of the shortest distance to a detected collision along the ray.\n\t * @param findClosest\n\t */\n\tpublic testBillboardCollision(billboard:Billboard, pickingCollisionVO:PickingCollisionVO, shortestCollisionDistance:number)\n\t{\n\t\tthis.setLocalRay(pickingCollisionVO.localRayPosition, pickingCollisionVO.localRayDirection);\n\t\tpickingCollisionVO.renderableOwner = null;\n\n\t\tif (this._pTestRenderableCollision(<RenderableBase> this._billboardRenderablePool.getItem(billboard), pickingCollisionVO, shortestCollisionDistance)) {\n\t\t\tshortestCollisionDistance = pickingCollisionVO.rayEntryDistance;\n\n\t\t\tpickingCollisionVO.renderableOwner = billboard;\n\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\t/**\n\t * Tests a <code>Mesh</code> object for a collision with the picking ray.\n\t *\n\t * @param mesh The mesh instance to be tested.\n\t * @param pickingCollisionVO The collision object used to store the collision results\n\t * @param shortestCollisionDistance The current value of the shortest distance to a detected collision along the ray.\n\t * @param findClosest\n\t */\n\tpublic testMeshCollision(mesh:Mesh, pickingCollisionVO:PickingCollisionVO, shortestCollisionDistance:number, findClosest:boolean):boolean\n\t{\n\t\tthis.setLocalRay(pickingCollisionVO.localRayPosition, pickingCollisionVO.localRayDirection);\n\t\tpickingCollisionVO.renderableOwner = null;\n\n\t\tvar subMesh:ISubMesh;\n\n\t\tvar len:number = mesh.subMeshes.length;\n\t\tfor (var i:number = 0; i < len; ++i) {\n\t\t\tsubMesh = mesh.subMeshes[i];\n\n\t\t\tif (this._pTestRenderableCollision(<RenderableBase> this._subMeshRenderablePool.getItem(subMesh), pickingCollisionVO, shortestCollisionDistance)) {\n\t\t\t\tshortestCollisionDistance = pickingCollisionVO.rayEntryDistance;\n\n\t\t\t\tpickingCollisionVO.renderableOwner = subMesh;\n\n\t\t\t\tif (!findClosest)\n\t\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\n\t\treturn pickingCollisionVO.renderableOwner != null;\n\t}\n}\n\nexport = PickingColliderBase;","import Debug\t\t\t\t\t\t\t= require(\"awayjs-core/lib/utils/Debug\");\nimport BitmapData\t\t\t\t\t\t= require(\"awayjs-core/lib/base/BitmapData\");\nimport Box\t\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Box\");\nimport Matrix3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3D\");\nimport Matrix3DUtils\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3DUtils\");\nimport Point\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Point\");\nimport Rectangle\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Rectangle\");\nimport Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\nimport ByteArray\t\t\t\t\t\t= require(\"awayjs-core/lib/utils/ByteArray\");\n\nimport TriangleSubGeometry\t\t\t\t= require(\"awayjs-display/lib/base/TriangleSubGeometry\");\nimport Scene\t\t\t\t\t\t\t= require(\"awayjs-display/lib/containers/Scene\");\nimport View\t\t\t\t\t\t\t\t= require(\"awayjs-display/lib/containers/View\");\nimport IPicker\t\t\t\t\t\t\t= require(\"awayjs-display/lib/pick/IPicker\");\nimport PickingCollisionVO\t\t\t\t= require(\"awayjs-display/lib/pick/PickingCollisionVO\");\nimport EntityCollector\t\t\t\t\t= require(\"awayjs-display/lib/traverse/EntityCollector\");\nimport Camera\t\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\nimport IEntity\t\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/IEntity\");\nimport MaterialBase\t\t\t\t\t\t= require(\"awayjs-display/lib/materials/MaterialBase\");\n\nimport AGALMiniAssembler\t\t\t\t= require(\"awayjs-stagegl/lib/aglsl/assembler/AGALMiniAssembler\");\nimport Stage\t\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\nimport ContextGLBlendFactor\t\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLBlendFactor\");\nimport ContextGLClearMask\t\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLClearMask\");\nimport ContextGLCompareMode\t\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLCompareMode\");\nimport ContextGLProgramType\t\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLProgramType\");\nimport ContextGLTriangleFace\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLTriangleFace\");\nimport IContextGL\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/IContextGL\");\nimport IProgram\t\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/IProgram\");\nimport ITextureBase\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/ITextureBase\");\n\nimport DefaultRenderer\t\t\t\t\t= require(\"awayjs-renderergl/lib/DefaultRenderer\");\nimport RenderableBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\n\n/**\n * Picks a 3d object from a view or scene by performing a separate render pass on the scene around the area being picked using key color values,\n * then reading back the color value of the pixel in the render representing the picking ray. Requires multiple passes and readbacks for retriving details\n * on an entity that has its shaderPickingDetails property set to true.\n *\n * A read-back operation from any GPU is not a very efficient process, and the amount of processing used can vary significantly between different hardware.\n *\n * @see away.entities.Entity#shaderPickingDetails\n *\n * @class away.pick.ShaderPicker\n */\nclass ShaderPicker implements IPicker\n{\n\tprivate _opaqueRenderableHead:RenderableBase;\n\tprivate _blendedRenderableHead:RenderableBase;\n\n\tprivate _stage:Stage;\n\tprivate _context:IContextGL;\n\tprivate _onlyMouseEnabled:boolean = true;\n\n\tprivate _objectProgram:IProgram;\n\tprivate _triangleProgram:IProgram;\n\tprivate _bitmapData:BitmapData;\n\tprivate _viewportData:Array<number>;\n\tprivate _boundOffsetScale:Array<number>;\n\tprivate _id:Array<number>;\n\n\tprivate _interactives:Array<RenderableBase> = new Array<RenderableBase>();\n\tprivate _interactiveId:number;\n\tprivate _hitColor:number;\n\tprivate _projX:number;\n\tprivate _projY:number;\n\n\tprivate _hitRenderable:RenderableBase;\n\tprivate _hitEntity:IEntity;\n\tprivate _localHitPosition:Vector3D = new Vector3D();\n\tprivate _hitUV:Point = new Point();\n\tprivate _faceIndex:number;\n\tprivate _subGeometryIndex:number;\n\n\tprivate _localHitNormal:Vector3D = new Vector3D();\n\n\tprivate _rayPos:Vector3D = new Vector3D();\n\tprivate _rayDir:Vector3D = new Vector3D();\n\tprivate _potentialFound:boolean;\n\tprivate static MOUSE_SCISSOR_RECT:Rectangle = new Rectangle(0, 0, 1, 1);\n\n\tprivate _shaderPickingDetails:boolean;\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic get onlyMouseEnabled():boolean\n\t{\n\t\treturn this._onlyMouseEnabled;\n\t}\n\n\tpublic set onlyMouseEnabled(value:boolean)\n\t{\n\t\tthis._onlyMouseEnabled = value;\n\t}\n\n\t/**\n\t * Creates a new <code>ShaderPicker</code> object.\n\t *\n\t * @param shaderPickingDetails Determines whether the picker includes a second pass to calculate extra\n\t * properties such as uv and normal coordinates.\n\t */\n\tconstructor(shaderPickingDetails:boolean = false)\n\t{\n\t\tthis._shaderPickingDetails = shaderPickingDetails;\n\n\t\tthis._id = new Array<number>(4);\n\t\tthis._viewportData = new Array<number>(4); // first 2 contain scale, last 2 translation\n\t\tthis._boundOffsetScale = new Array<number>(8); // first 2 contain scale, last 2 translation\n\t\tthis._boundOffsetScale[3] = 0;\n\t\tthis._boundOffsetScale[7] = 1;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getViewCollision(x:number, y:number, view:View):PickingCollisionVO\n\t{\n\t\tvar collector:EntityCollector = <EntityCollector> view.iEntityCollector;\n\n\t\tthis._stage = (<DefaultRenderer> view.renderer).stage;\n\n\t\tif (!this._stage)\n\t\t\treturn null;\n\n\t\tthis._context = <IContextGL> this._stage.context;\n\n\t\tthis._viewportData[0] = view.width;\n\t\tthis._viewportData[1] = view.height;\n\t\tthis._viewportData[2] = -(this._projX = 2*x/view.width - 1);\n\t\tthis._viewportData[3] = this._projY = 2*y/view.height - 1;\n\n\t\t// _potentialFound will be set to true if any object is actually rendered\n\t\tthis._potentialFound = false;\n\n\t\t//reset head values\n\t\tthis._blendedRenderableHead = null;\n\t\tthis._opaqueRenderableHead = null;\n\n\t\tthis.pDraw(collector, null);\n\n\t\t// clear buffers\n\t\tthis._context.setVertexBufferAt(0, null);\n\n\t\tif (!this._context || !this._potentialFound)\n\t\t\treturn null;\n\n\t\tif (!this._bitmapData)\n\t\t\tthis._bitmapData = new BitmapData(1, 1, false, 0);\n\n\t\tthis._context.drawToBitmapData(this._bitmapData);\n\t\tthis._hitColor = this._bitmapData.getPixel(0, 0);\n\n\t\tif (!this._hitColor) {\n\t\t\tthis._context.present();\n\t\t\treturn null;\n\t\t}\n\n\t\tthis._hitRenderable = this._interactives[this._hitColor - 1];\n\t\tthis._hitEntity = this._hitRenderable.sourceEntity;\n\n\t\tif (this._onlyMouseEnabled && !this._hitEntity._iIsMouseEnabled())\n\t\t\treturn null;\n\n\t\tvar _collisionVO:PickingCollisionVO = this._hitEntity._iPickingCollisionVO;\n\t\tif (this._shaderPickingDetails) {\n\t\t\tthis.getHitDetails(view.camera);\n\t\t\t_collisionVO.localPosition = this._localHitPosition;\n\t\t\t_collisionVO.localNormal = this._localHitNormal;\n\t\t\t_collisionVO.uv = this._hitUV;\n\t\t\t_collisionVO.index = this._faceIndex;\n\t\t\t//_collisionVO.subGeometryIndex = this._subGeometryIndex;\n\n\t\t} else {\n\t\t\t_collisionVO.localPosition = null;\n\t\t\t_collisionVO.localNormal = null;\n\t\t\t_collisionVO.uv = null;\n\t\t\t_collisionVO.index = 0;\n\t\t\t//_collisionVO.subGeometryIndex = 0;\n\t\t}\n\n\t\treturn _collisionVO;\n\t}\n\n\t//*/\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic getSceneCollision(position:Vector3D, direction:Vector3D, scene:Scene):PickingCollisionVO\n\t{\n\t\treturn null;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic pDraw(entityCollector:EntityCollector, target:ITextureBase)\n\t{\n\n\t\tvar camera:Camera = entityCollector.camera;\n\n\t\tthis._context.clear(0, 0, 0, 1);\n\t\tthis._stage.scissorRect = ShaderPicker.MOUSE_SCISSOR_RECT;\n\n\t\tthis._interactives.length = this._interactiveId = 0;\n\n\t\tif (!this._objectProgram)\n\t\t\tthis.initObjectProgram();\n\n\t\tthis._context.setBlendFactors(ContextGLBlendFactor.ONE, ContextGLBlendFactor.ZERO);\n\t\tthis._context.setDepthTest(true, ContextGLCompareMode.LESS);\n\t\tthis._context.setProgram(this._objectProgram);\n\t\tthis._context.setProgramConstantsFromArray(ContextGLProgramType.VERTEX, 4, this._viewportData, 1);\n\t\t//this.drawRenderables(entityCollector.opaqueRenderableHead, camera);\n\t\t//this.drawRenderables(entityCollector.blendedRenderableHead, camera);\n\t\t//TODO: reimplement ShaderPicker inheriting from RendererBase\n\t}\n\n\t/**\n\t * Draw a list of renderables.\n\t * @param renderables The renderables to draw.\n\t * @param camera The camera for which to render.\n\t */\n\tprivate drawRenderables(renderable:RenderableBase, camera:Camera)\n\t{\n\t\tvar matrix:Matrix3D = Matrix3DUtils.CALCULATION_MATRIX;\n\t\tvar viewProjection:Matrix3D = camera.viewProjection;\n\n\t\twhile (renderable) {\n\t\t\t// it's possible that the renderable was already removed from the scene\n\t\t\tif (!renderable.sourceEntity.scene || !renderable.sourceEntity._iIsMouseEnabled()) {\n\t\t\t\trenderable = renderable.next;\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tthis._potentialFound = true;\n\n\t\t\tthis._context.setCulling((<MaterialBase> renderable.renderObjectOwner).bothSides? ContextGLTriangleFace.NONE : ContextGLTriangleFace.BACK, camera.projection.coordinateSystem);\n\n\t\t\tthis._interactives[this._interactiveId++] = renderable;\n\t\t\t// color code so that reading from bitmapdata will contain the correct value\n\t\t\tthis._id[1] = (this._interactiveId >> 8)/255; // on green channel\n\t\t\tthis._id[2] = (this._interactiveId & 0xff)/255; // on blue channel\n\n\t\t\tmatrix.copyFrom(renderable.sourceEntity.getRenderSceneTransform(camera));\n\t\t\tmatrix.append(viewProjection);\n\t\t\tthis._context.setProgramConstantsFromMatrix(ContextGLProgramType.VERTEX, 0, matrix, true);\n\t\t\tthis._context.setProgramConstantsFromArray(ContextGLProgramType.FRAGMENT, 0, this._id, 1);\n\t\t\tthis._stage.activateBuffer(0, renderable.getVertexData(TriangleSubGeometry.POSITION_DATA), renderable.getVertexOffset(TriangleSubGeometry.POSITION_DATA), TriangleSubGeometry.POSITION_FORMAT);\n\t\t\tthis._context.drawTriangles(this._stage.getIndexBuffer(renderable.getIndexData()), 0, renderable.numTriangles);\n\n\t\t\trenderable = renderable.next;\n\t\t}\n\n\t}\n\n\tprivate updateRay(camera:Camera)\n\t{\n\t\tthis._rayPos = camera.scenePosition;\n\n\t\tthis._rayDir = camera.getRay(this._projX, this._projY, 1);\n\t\tthis._rayDir.normalize();\n\t}\n\n\t/**\n\t * Creates the Program that color-codes objects.\n\t */\n\tprivate initObjectProgram()\n\t{\n\t\tvar vertexCode:string;\n\t\tvar fragmentCode:string;\n\n\t\tthis._objectProgram = this._context.createProgram();\n\n\t\tvertexCode = \"m44 vt0, va0, vc0\t\t\t\\n\" + \"mul vt1.xy, vt0.w, vc4.zw\t\\n\" + \"add vt0.xy, vt0.xy, vt1.xy\t\\n\" + \"mul vt0.xy, vt0.xy, vc4.xy\t\\n\" + \"mov op, vt0\t\\n\";\n\t\tfragmentCode = \"mov oc, fc0\"; // write identifier\n\n\t\tDebug.throwPIR('ShaderPicker', 'initTriangleProgram', 'Dependency: initObjectProgram')\n\t\t//_objectProgram.upload(new AGALMiniAssembler().assemble(ContextGLProgramType.VERTEX, vertexCode),new AGALMiniAssembler().assemble(ContextGLProgramType.FRAGMENT, fragmentCode));\n\t}\n\n\t/**\n\t * Creates the Program that renders positions.\n\t */\n\n\tprivate initTriangleProgram()\n\t{\n\t\tvar vertexCode:string;\n\t\tvar fragmentCode:string;\n\n\t\tthis._triangleProgram = this._context.createProgram();\n\n\t\t// todo: add animation code\n\t\tvertexCode = \"add vt0, va0, vc5 \t\t\t\\n\" + \"mul vt0, vt0, vc6 \t\t\t\\n\" + \"mov v0, vt0\t\t\t\t\\n\" + \"m44 vt0, va0, vc0\t\t\t\\n\" + \"mul vt1.xy, vt0.w, vc4.zw\t\\n\" + \"add vt0.xy, vt0.xy, vt1.xy\t\\n\" + \"mul vt0.xy, vt0.xy, vc4.xy\t\\n\" + \"mov op, vt0\t\\n\";\n\t\tfragmentCode = \"mov oc, v0\"; // write identifier\n\n\t\tvar vertexByteCode:ByteArray = (new AGALMiniAssembler().assemble(\"part vertex 1\\n\" + vertexCode + \"endpart\"))['vertex'].data;\n\t\tvar fragmentByteCode:ByteArray = (new AGALMiniAssembler().assemble(\"part fragment 1\\n\" + fragmentCode + \"endpart\"))['fragment'].data;\n\t\tthis._triangleProgram.upload(vertexByteCode, fragmentByteCode);\n\t}\n\n\t/**\n\t * Gets more detailed information about the hir position, if required.\n\t * @param camera The camera used to view the hit object.\n\t */\n\tprivate getHitDetails(camera:Camera)\n\t{\n\t\tthis.getApproximatePosition(camera);\n\t\tthis.getPreciseDetails(camera);\n\t}\n\n\t/**\n\t * Finds a first-guess approximate position about the hit position.\n\t *\n\t * @param camera The camera used to view the hit object.\n\t */\n\tprivate getApproximatePosition(camera:Camera)\n\t{\n\t\tvar bounds:Box = this._hitRenderable.sourceEntity.bounds.aabb;\n\t\tvar col:number;\n\t\tvar scX:number, scY:number, scZ:number;\n\t\tvar offsX:number, offsY:number, offsZ:number;\n\t\tvar localViewProjection:Matrix3D = Matrix3DUtils.CALCULATION_MATRIX;\n\n\t\tlocalViewProjection.copyFrom(this._hitRenderable.sourceEntity.getRenderSceneTransform(camera));\n\t\tlocalViewProjection.append(camera.viewProjection);\n\t\tif (!this._triangleProgram) {\n\t\t\tthis.initTriangleProgram();\n\t\t}\n\n\t\tthis._boundOffsetScale[4] = 1/(scX = bounds.width);\n\t\tthis._boundOffsetScale[5] = 1/(scY = bounds.height);\n\t\tthis._boundOffsetScale[6] = 1/(scZ = bounds.depth);\n\t\tthis._boundOffsetScale[0] = offsX = -bounds.x;\n\t\tthis._boundOffsetScale[1] = offsY = -bounds.y;\n\t\tthis._boundOffsetScale[2] = offsZ = -bounds.z;\n\n\t\tthis._context.setProgram(this._triangleProgram);\n\t\tthis._context.clear(0, 0, 0, 0, 1, 0, ContextGLClearMask.DEPTH);\n\t\tthis._context.setScissorRectangle(ShaderPicker.MOUSE_SCISSOR_RECT);\n\t\tthis._context.setProgramConstantsFromMatrix(ContextGLProgramType.VERTEX, 0, localViewProjection, true);\n\t\tthis._context.setProgramConstantsFromArray(ContextGLProgramType.VERTEX, 5, this._boundOffsetScale, 2);\n\n\t\tthis._stage.activateBuffer(0, this._hitRenderable.getVertexData(TriangleSubGeometry.POSITION_DATA), this._hitRenderable.getVertexOffset(TriangleSubGeometry.POSITION_DATA), TriangleSubGeometry.POSITION_FORMAT);\n\t\tthis._context.drawTriangles(this._stage.getIndexBuffer(this._hitRenderable.getIndexData()), 0, this._hitRenderable.numTriangles);\n\n\t\tthis._context.drawToBitmapData(this._bitmapData);\n\n\t\tcol = this._bitmapData.getPixel(0, 0);\n\n\t\tthis._localHitPosition.x = ((col >> 16) & 0xff)*scX/255 - offsX;\n\t\tthis._localHitPosition.y = ((col >> 8) & 0xff)*scY/255 - offsY;\n\t\tthis._localHitPosition.z = (col & 0xff)*scZ/255 - offsZ;\n\t}\n\n\t/**\n\t * Use the approximate position info to find the face under the mouse position from which we can derive the precise\n\t * ray-face intersection point, then use barycentric coordinates to figure out the uv coordinates, etc.\n\t * @param camera The camera used to view the hit object.\n\t */\n\tprivate getPreciseDetails(camera:Camera)\n\t{\n\t\tvar len:number = indices.length;\n\t\tvar x1:number, y1:number, z1:number;\n\t\tvar x2:number, y2:number, z2:number;\n\t\tvar x3:number, y3:number, z3:number;\n\t\tvar i:number = 0, j:number = 1, k:number = 2;\n\t\tvar t1:number, t2:number, t3:number;\n\t\tvar v0x:number, v0y:number, v0z:number;\n\t\tvar v1x:number, v1y:number, v1z:number;\n\t\tvar v2x:number, v2y:number, v2z:number;\n\t\tvar ni1:number, ni2:number, ni3:number;\n\t\tvar n1:number, n2:number, n3:number, nLength:number;\n\t\tvar dot00:number, dot01:number, dot02:number, dot11:number, dot12:number;\n\t\tvar s:number, t:number, invDenom:number;\n\t\tvar x:number = this._localHitPosition.x, y:number = this._localHitPosition.y, z:number = this._localHitPosition.z;\n\t\tvar u:number, v:number;\n\t\tvar ui1:number, ui2:number, ui3:number;\n\t\tvar s0x:number, s0y:number, s0z:number;\n\t\tvar s1x:number, s1y:number, s1z:number;\n\t\tvar nl:number;\n\t\tvar indices:Array<number> = this._hitRenderable.getIndexData().data;\n\n\t\tvar positions:Array<number> = this._hitRenderable.getVertexData(TriangleSubGeometry.POSITION_DATA).data;\n\t\tvar positionStride:number = this._hitRenderable.getVertexData(TriangleSubGeometry.POSITION_DATA).dataPerVertex;\n\t\tvar positionOffset:number = this._hitRenderable.getVertexOffset(TriangleSubGeometry.POSITION_DATA);\n\n\t\tvar uvs:Array<number> = this._hitRenderable.getVertexData(TriangleSubGeometry.UV_DATA).data;\n\t\tvar uvStride:number = this._hitRenderable.getVertexData(TriangleSubGeometry.UV_DATA).dataPerVertex;\n\t\tvar uvOffset:number = this._hitRenderable.getVertexOffset(TriangleSubGeometry.UV_DATA);\n\n\t\tvar normals:Array<number> = this._hitRenderable.getVertexData(TriangleSubGeometry.NORMAL_DATA).data;\n\t\tvar normalStride:number = this._hitRenderable.getVertexData(TriangleSubGeometry.NORMAL_DATA).dataPerVertex;\n\t\tvar normalOffset:number = this._hitRenderable.getVertexOffset(TriangleSubGeometry.NORMAL_DATA);\n\n\t\tthis.updateRay(camera);\n\n\t\twhile (i < len) {\n\t\t\tt1 = positionOffset + indices[i]*positionStride;\n\t\t\tt2 = positionOffset + indices[j]*positionStride;\n\t\t\tt3 = positionOffset + indices[k]*positionStride;\n\t\t\tx1 = positions[t1];\n\t\t\ty1 = positions[t1 + 1];\n\t\t\tz1 = positions[t1 + 2];\n\t\t\tx2 = positions[t2];\n\t\t\ty2 = positions[t2 + 1];\n\t\t\tz2 = positions[t2 + 2];\n\t\t\tx3 = positions[t3];\n\t\t\ty3 = positions[t3 + 1];\n\t\t\tz3 = positions[t3 + 2];\n\n\t\t\t// if within bounds\n\t\t\tif (!(    (x < x1 && x < x2 && x < x3) || (y < y1 && y < y2 && y < y3) || (z < z1 && z < z2 && z < z3) || (x > x1 && x > x2 && x > x3) || (y > y1 && y > y2 && y > y3) || (z > z1 && z > z2 && z > z3))) {\n\n\t\t\t\t// calculate barycentric coords for approximated position\n\t\t\t\tv0x = x3 - x1;\n\t\t\t\tv0y = y3 - y1;\n\t\t\t\tv0z = z3 - z1;\n\t\t\t\tv1x = x2 - x1;\n\t\t\t\tv1y = y2 - y1;\n\t\t\t\tv1z = z2 - z1;\n\t\t\t\tv2x = x - x1;\n\t\t\t\tv2y = y - y1;\n\t\t\t\tv2z = z - z1;\n\t\t\t\tdot00 = v0x*v0x + v0y*v0y + v0z*v0z;\n\t\t\t\tdot01 = v0x*v1x + v0y*v1y + v0z*v1z;\n\t\t\t\tdot02 = v0x*v2x + v0y*v2y + v0z*v2z;\n\t\t\t\tdot11 = v1x*v1x + v1y*v1y + v1z*v1z;\n\t\t\t\tdot12 = v1x*v2x + v1y*v2y + v1z*v2z;\n\t\t\t\tinvDenom = 1/(dot00*dot11 - dot01*dot01);\n\t\t\t\ts = (dot11*dot02 - dot01*dot12)*invDenom;\n\t\t\t\tt = (dot00*dot12 - dot01*dot02)*invDenom;\n\n\t\t\t\t// if inside the current triangle, fetch details hit information\n\t\t\t\tif (s >= 0 && t >= 0 && (s + t) <= 1) {\n\n\t\t\t\t\tni1 = normalOffset + indices[i]*normalStride;\n\t\t\t\t\tni2 = normalOffset + indices[j]*normalStride;\n\t\t\t\t\tni3 = normalOffset + indices[k]*normalStride;\n\n\t\t\t\t\tn1 = indices[ni1] + indices[ni2] + indices[ni3];\n\t\t\t\t\tn2 = indices[ni1 + 1] + indices[ni2 + 1] + indices[ni3 + 1];\n\t\t\t\t\tn3 = indices[ni1 + 2] + indices[ni2 + 2] + indices[ni3 + 2];\n\n\t\t\t\t\tnLength = Math.sqrt(n1*n1 + n2*n2 + n3*n3);\n\n\t\t\t\t\tn1 /= nLength;\n\t\t\t\t\tn2 /= nLength;\n\t\t\t\t\tn3 /= nLength;\n\n\t\t\t\t\t// this is def the triangle, now calculate precise coords\n\t\t\t\t\tthis.getPrecisePosition(this._hitRenderable.sourceEntity.inverseSceneTransform, n1, n2, n3, x1, y1, z1);\n\n\t\t\t\t\tv2x = this._localHitPosition.x - x1;\n\t\t\t\t\tv2y = this._localHitPosition.y - y1;\n\t\t\t\t\tv2z = this._localHitPosition.z - z1;\n\n\t\t\t\t\ts0x = x2 - x1; // s0 = p1 - p0\n\t\t\t\t\ts0y = y2 - y1;\n\t\t\t\t\ts0z = z2 - z1;\n\t\t\t\t\ts1x = x3 - x1; // s1 = p2 - p0\n\t\t\t\t\ts1y = y3 - y1;\n\t\t\t\t\ts1z = z3 - z1;\n\t\t\t\t\tthis._localHitNormal.x = s0y*s1z - s0z*s1y; // n = s0 x s1\n\t\t\t\t\tthis._localHitNormal.y = s0z*s1x - s0x*s1z;\n\t\t\t\t\tthis._localHitNormal.z = s0x*s1y - s0y*s1x;\n\t\t\t\t\tnl = 1/Math.sqrt(this._localHitNormal.x*this._localHitNormal.x + this._localHitNormal.y*this._localHitNormal.y + this._localHitNormal.z*this._localHitNormal.z); // normalize n\n\t\t\t\t\tthis._localHitNormal.x *= nl;\n\t\t\t\t\tthis._localHitNormal.y *= nl;\n\t\t\t\t\tthis._localHitNormal.z *= nl;\n\n\t\t\t\t\tdot02 = v0x*v2x + v0y*v2y + v0z*v2z;\n\t\t\t\t\tdot12 = v1x*v2x + v1y*v2y + v1z*v2z;\n\t\t\t\t\ts = (dot11*dot02 - dot01*dot12)*invDenom;\n\t\t\t\t\tt = (dot00*dot12 - dot01*dot02)*invDenom;\n\n\t\t\t\t\tui1 = uvOffset + indices[i]*uvStride\n\t\t\t\t\tui2 = uvOffset + indices[j]*uvStride\n\t\t\t\t\tui3 = uvOffset + indices[k]*uvStride\n\n\t\t\t\t\tu = uvs[ui1];\n\t\t\t\t\tv = uvs[ui1 + 1];\n\t\t\t\t\tthis._hitUV.x = u + t*(uvs[ui2] - u) + s*(uvs[ui3] - u);\n\t\t\t\t\tthis._hitUV.y = v + t*(uvs[ui2 + 1] - v) + s*(uvs[ui3 + 1] - v);\n\n\t\t\t\t\tthis._faceIndex = i;\n\t\t\t\t\t//TODO add back subGeometryIndex value\n\t\t\t\t\t//this._subGeometryIndex = away.utils.GeometryUtils.getMeshSubGeometryIndex(subGeom);\n\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\ti += 3;\n\t\t\tj += 3;\n\t\t\tk += 3;\n\t\t}\n\t}\n\n\t/**\n\t * Finds the precise hit position by unprojecting the screen coordinate back unto the hit face's plane and\n\t * calculating the intersection point.\n\t * @param camera The camera used to render the object.\n\t * @param invSceneTransform The inverse scene transformation of the hit object.\n\t * @param nx The x-coordinate of the face's plane normal.\n\t * @param ny The y-coordinate of the face plane normal.\n\t * @param nz The z-coordinate of the face plane normal.\n\t * @param px The x-coordinate of a point on the face's plane (ie a face vertex)\n\t * @param py The y-coordinate of a point on the face's plane (ie a face vertex)\n\t * @param pz The z-coordinate of a point on the face's plane (ie a face vertex)\n\t */\n\n\tprivate getPrecisePosition(invSceneTransform:Matrix3D, nx:number, ny:number, nz:number, px:number, py:number, pz:number)\n\t{\n\t\t// calculate screen ray and find exact intersection position with triangle\n\t\tvar rx:number, ry:number, rz:number;\n\t\tvar ox:number, oy:number, oz:number;\n\t\tvar t:number;\n\t\tvar raw:Array<number> = Matrix3DUtils.RAW_DATA_CONTAINER;\n\t\tvar cx:number = this._rayPos.x, cy:number = this._rayPos.y, cz:number = this._rayPos.z;\n\n\t\t// unprojected projection point, gives ray dir in cam space\n\t\tox = this._rayDir.x;\n\t\toy = this._rayDir.y;\n\t\toz = this._rayDir.z;\n\n\t\t// transform ray dir and origin (cam pos) to object space\n\t\t//invSceneTransform.copyRawDataTo( raw  );\n\t\tinvSceneTransform.copyRawDataTo(raw);\n\t\trx = raw[0]*ox + raw[4]*oy + raw[8]*oz;\n\t\try = raw[1]*ox + raw[5]*oy + raw[9]*oz;\n\t\trz = raw[2]*ox + raw[6]*oy + raw[10]*oz;\n\n\t\tox = raw[0]*cx + raw[4]*cy + raw[8]*cz + raw[12];\n\t\toy = raw[1]*cx + raw[5]*cy + raw[9]*cz + raw[13];\n\t\toz = raw[2]*cx + raw[6]*cy + raw[10]*cz + raw[14];\n\n\t\tt = ((px - ox)*nx + (py - oy)*ny + (pz - oz)*nz)/(rx*nx + ry*ny + rz*nz);\n\n\t\tthis._localHitPosition.x = ox + rx*t;\n\t\tthis._localHitPosition.y = oy + ry*t;\n\t\tthis._localHitPosition.z = oz + rz*t;\n\t}\n\n\tpublic dispose()\n\t{\n\t\tthis._bitmapData.dispose();\n\t\tif (this._triangleProgram)\n\t\t\tthis._triangleProgram.dispose();\n\n\t\tif (this._objectProgram)\n\t\t\tthis._objectProgram.dispose();\n\n\t\tthis._triangleProgram = null;\n\t\tthis._objectProgram = null;\n\t\tthis._bitmapData = null;\n\t\tthis._hitRenderable = null;\n\t\tthis._hitEntity = null;\n\t}\n}\n\nexport = ShaderPicker;","import Matrix3D\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3D\");\nimport Matrix3DUtils\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3DUtils\");\n\nimport SubGeometryBase\t\t\t\t= require(\"awayjs-display/lib/base/SubGeometryBase\");\nimport TriangleSubGeometry\t\t\t= require(\"awayjs-display/lib/base/TriangleSubGeometry\");\nimport Billboard\t\t\t\t\t= require(\"awayjs-display/lib/entities/Billboard\");\nimport MaterialBase\t\t\t\t\t= require(\"awayjs-display/lib/materials/MaterialBase\");\nimport Camera\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\n\nimport Stage\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\nimport IContextGL\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/IContextGL\");\nimport ContextGLProgramType\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLProgramType\");\n\nimport ShaderObjectBase\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport ShaderRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterCache\");\nimport ShaderRegisterData\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterData\");\nimport ShaderRegisterElement\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\nimport RenderableBase\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\nimport RenderablePoolBase\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderablePoolBase\");\nimport RenderPassBase\t\t\t\t= require(\"awayjs-renderergl/lib/passes/RenderPassBase\");\n\n/**\n * @class away.pool.RenderableListItem\n */\nclass BillboardRenderable extends RenderableBase\n{\n\tprivate static _materialGeometry:Object = new Object();\n\n\t/**\n\t *\n\t */\n\tpublic static id:string = \"billboard\";\n\n\tpublic static vertexAttributesOffset:number = 1;\n\n\t/**\n\t *\n\t */\n\tprivate _billboard:Billboard;\n\n\t/**\n\t * //TODO\n\t *\n\t * @param pool\n\t * @param billboard\n\t */\n\tconstructor(pool:RenderablePoolBase, billboard:Billboard, stage:Stage)\n\t{\n\t\tsuper(pool, billboard, billboard, billboard.material, stage);\n\n\t\tthis._billboard = billboard;\n\t}\n\n\t/**\n\t * //TODO\n\t *\n\t * @returns {away.base.TriangleSubGeometry}\n\t */\n\tpublic _pGetSubGeometry():SubGeometryBase\n\t{\n\t\tvar material:MaterialBase = this._billboard.material;\n\n\t\tvar geometry:TriangleSubGeometry = BillboardRenderable._materialGeometry[material.id];\n\n\t\tif (!geometry) {\n\t\t\tgeometry = BillboardRenderable._materialGeometry[material.id] = new TriangleSubGeometry(true);\n\t\t\tgeometry.autoDeriveNormals = false;\n\t\t\tgeometry.autoDeriveTangents = false;\n\t\t\tgeometry.updateIndices(Array<number>(0, 1, 2, 0, 2, 3));\n\t\t\tgeometry.updatePositions(Array<number>(0, material.height, 0, material.width, material.height, 0, material.width, 0, 0, 0, 0, 0));\n\t\t\tgeometry.updateVertexNormals(Array<number>(1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0));\n\t\t\tgeometry.updateVertexTangents(Array<number>(0, 0, -1, 0, 0, -1, 0, 0, -1, 0, 0, -1));\n\t\t\tgeometry.updateUVs(Array<number>(0, 0, 1, 0, 1, 1, 0, 1));\n\t\t} else {\n\t\t\tgeometry.updatePositions(Array<number>(0, material.height, 0, material.width, material.height, 0, material.width, 0, 0, 0, 0, 0));\n\t\t}\n\n\t\tthis._pVertexDataDirty[TriangleSubGeometry.POSITION_DATA] = true;\n\t\tthis._pVertexDataDirty[TriangleSubGeometry.NORMAL_DATA] = true;\n\t\tthis._pVertexDataDirty[TriangleSubGeometry.TANGENT_DATA] = true;\n\t\tthis._pVertexDataDirty[TriangleSubGeometry.UV_DATA] = true;\n\n\t\treturn geometry;\n\t}\n\n\tpublic static _iIncludeDependencies(shaderObject:ShaderObjectBase)\n\t{\n\n\t}\n\n\tpublic static _iGetVertexCode(shaderObject:ShaderObjectBase, registerCache:ShaderRegisterCache, sharedRegisters:ShaderRegisterData):string\n\t{\n\t\tvar code:string = \"\";\n\n\t\t//get the projection coordinates\n\t\tvar position:ShaderRegisterElement = (shaderObject.globalPosDependencies > 0)? sharedRegisters.globalPositionVertex : sharedRegisters.localPosition;\n\n\t\t//reserving vertex constants for projection matrix\n\t\tvar viewMatrixReg:ShaderRegisterElement = registerCache.getFreeVertexConstant();\n\t\tregisterCache.getFreeVertexConstant();\n\t\tregisterCache.getFreeVertexConstant();\n\t\tregisterCache.getFreeVertexConstant();\n\t\tshaderObject.viewMatrixIndex = viewMatrixReg.index*4;\n\n\t\tif (shaderObject.projectionDependencies > 0) {\n\t\t\tsharedRegisters.projectionFragment = registerCache.getFreeVarying();\n\t\t\tvar temp:ShaderRegisterElement = registerCache.getFreeVertexVectorTemp();\n\t\t\tcode += \"m44 \" + temp + \", \" + position + \", \" + viewMatrixReg + \"\\n\" +\n\t\t\t\"mov \" + sharedRegisters.projectionFragment + \", \" + temp + \"\\n\" +\n\t\t\t\"mov op, \" + temp + \"\\n\";\n\t\t} else {\n\t\t\tcode += \"m44 op, \" + position + \", \" + viewMatrixReg + \"\\n\";\n\t\t}\n\n\t\treturn code;\n\t}\n\n\tpublic _iActivate(pass:RenderPassBase, camera:Camera)\n\t{\n\t\tsuper._iActivate(pass, camera);\n\n\t\t//buffer the same for all materials, so can set here\n\t\tthis._stage.activateBuffer(0, this.getVertexData(TriangleSubGeometry.POSITION_DATA), this.getVertexOffset(TriangleSubGeometry.POSITION_DATA), TriangleSubGeometry.POSITION_FORMAT);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iRender(pass:RenderPassBase, camera:Camera, viewProjection:Matrix3D)\n\t{\n\t\tsuper._iRender(pass, camera, viewProjection);\n\n\t\tvar shader:ShaderObjectBase = pass.shader;\n\n\t\tif (shader.sceneMatrixIndex >= 0) {\n\t\t\tthis.sourceEntity.getRenderSceneTransform(camera).copyRawDataTo(shader.vertexConstantData, shader.sceneMatrixIndex, true);\n\t\t\tviewProjection.copyRawDataTo(shader.vertexConstantData, shader.viewMatrixIndex, true);\n\t\t} else {\n\t\t\tvar matrix3D:Matrix3D = Matrix3DUtils.CALCULATION_MATRIX;\n\n\t\t\tmatrix3D.copyFrom(this.sourceEntity.getRenderSceneTransform(camera));\n\t\t\tmatrix3D.append(viewProjection);\n\n\t\t\tmatrix3D.copyRawDataTo(shader.vertexConstantData, shader.viewMatrixIndex, true);\n\t\t}\n\n\t\tvar context:IContextGL = this._stage.context;\n\t\tcontext.setProgramConstantsFromArray(ContextGLProgramType.VERTEX, 0, shader.vertexConstantData, shader.numUsedVertexConstants);\n\t\tcontext.setProgramConstantsFromArray(ContextGLProgramType.FRAGMENT, 0, shader.fragmentConstantData, shader.numUsedFragmentConstants);\n\n\t\tthis._stage.context.drawTriangles(this._stage.getIndexBuffer(this.getIndexData()), 0, this.numTriangles);\n\t}\n}\n\nexport = BillboardRenderable;","import Matrix3D\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3D\");\nimport Vector3D\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport IRenderableOwner\t\t\t\t= require(\"awayjs-display/lib/base/IRenderableOwner\");\nimport LineSubGeometry\t\t\t\t= require(\"awayjs-display/lib/base/LineSubGeometry\");\nimport SubGeometryEvent\t\t\t\t= require(\"awayjs-display/lib/events/SubGeometryEvent\");\nimport Camera\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\nimport LineSegment\t\t\t\t\t= require(\"awayjs-display/lib/entities/LineSegment\");\nimport DefaultMaterialManager\t\t= require(\"awayjs-display/lib/managers/DefaultMaterialManager\");\n\nimport IContextGL\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/IContextGL\");\nimport ContextGLProgramType\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLProgramType\");\nimport Stage\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\n\nimport ShaderObjectBase\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport ShaderRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterCache\");\nimport ShaderRegisterData\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterData\");\nimport ShaderRegisterElement\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\nimport RenderableBase\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\nimport RenderablePoolBase\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderablePoolBase\");\nimport RenderPassBase\t\t\t\t= require(\"awayjs-renderergl/lib/passes/RenderPassBase\");\n\n/**\n * @class away.pool.LineSubMeshRenderable\n */\nclass LineSegmentRenderable extends RenderableBase\n{\n\tprivate static _lineGeometry:Object = new Object();\n\n\tpublic static pONE_VECTOR:Array<number> = Array<number>(1, 1, 1, 1);\n\tpublic static pFRONT_VECTOR:Array<number> = Array<number>(0, 0, -1, 0);\n\n\tprivate _constants:Array<number> = new Array<number>(0, 0, 0, 0);\n\tprivate _calcMatrix:Matrix3D;\n\tprivate _thickness:number = 1.25;\n\n\t/**\n\t *\n\t */\n\tpublic static id:string = \"linesegment\";\n\n\tpublic static vertexAttributesOffset:number = 3;\n\n\t/**\n\t *\n\t */\n\tprivate _lineSegment:LineSegment;\n\n\t/**\n\t * //TODO\n\t *\n\t * @param pool\n\t * @param subMesh\n\t * @param level\n\t * @param dataOffset\n\t */\n\tconstructor(pool:RenderablePoolBase, lineSegment:LineSegment, stage:Stage, level:number = 0, indexOffset:number = 0)\n\t{\n\t\tsuper(pool, lineSegment, lineSegment, lineSegment.material, stage, level, indexOffset);\n\n\t\tthis._lineSegment = lineSegment;\n\n\t\tthis._calcMatrix = new Matrix3D();\n\n\t\tthis._constants[1] = 1/255;\n\t}\n\n\t/**\n\t * //TODO\n\t *\n\t * @returns {base.LineSubGeometry}\n\t * @protected\n\t */\n\tpublic _pGetSubGeometry():LineSubGeometry\n\t{\n\t\tvar geometry:LineSubGeometry = LineSegmentRenderable._lineGeometry[this._lineSegment.id] || (LineSegmentRenderable._lineGeometry[this._lineSegment.id] = new LineSubGeometry());\n\n\t\tthis._pVertexDataDirty[LineSubGeometry.START_POSITION_DATA] = true;\n\t\tthis._pVertexDataDirty[LineSubGeometry.END_POSITION_DATA] = true;\n\t\tthis._pVertexDataDirty[LineSubGeometry.THICKNESS_DATA] = true;\n\t\tthis._pVertexDataDirty[LineSubGeometry.COLOR_DATA] = true;\n\n\t\tvar start:Vector3D = this._lineSegment.startPostion;\n\t\tvar end:Vector3D = this._lineSegment.endPosition;\n\n\t\tvar startPositions:Array<number>;\n\t\tvar endPositions:Array<number>;\n\t\tvar thickness:Array<number>;\n\n\t\tif (geometry.indices != null) {\n\t\t\tstartPositions = geometry.startPositions;\n\t\t\tendPositions = geometry.endPositions;\n\t\t\tthickness = geometry.thickness;\n\t\t} else {\n\t\t\tstartPositions = new Array<number>(3);\n\t\t\tendPositions = new Array<number>(3);\n\t\t\tthickness = new Array<number>(1);\n\t\t}\n\n\t\tstartPositions[0] = start.x;\n\t\tstartPositions[1] = start.y;\n\t\tstartPositions[2] = start.z;\n\t\tendPositions[0] = end.x;\n\t\tendPositions[1] = end.y;\n\t\tendPositions[2] = end.z;\n\t\tthickness[0] = this._lineSegment.thickness;\n\n\t\tgeometry.updatePositions(startPositions, endPositions);\n\t\tgeometry.updateThickness(thickness);\n\n\t\treturn geometry;\n\t}\n\n\tpublic static _iIncludeDependencies(shaderObject:ShaderObjectBase)\n\t{\n\t\tshaderObject.colorDependencies++;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic static _iGetVertexCode(shader:ShaderObjectBase, regCache:ShaderRegisterCache, sharedReg:ShaderRegisterData):string\n\t{\n\t\treturn \"m44 vt0, va0, vc8\t\t\t\\n\" + // transform Q0 to eye space\n\t\t\t\"m44 vt1, va1, vc8\t\t\t\\n\" + // transform Q1 to eye space\n\t\t\t\"sub vt2, vt1, vt0 \t\t\t\\n\" + // L = Q1 - Q0\n\n\t\t\t\t// test if behind camera near plane\n\t\t\t\t// if 0 - Q0.z < Camera.near then the point needs to be clipped\n\t\t\t\t//\"neg vt5.x, vt0.z\t\t\t\t\\n\" + // 0 - Q0.z\n\t\t\t\"slt vt5.x, vt0.z, vc7.z\t\t\t\\n\" + // behind = ( 0 - Q0.z < -Camera.near ) ? 1 : 0\n\t\t\t\"sub vt5.y, vc5.x, vt5.x\t\t\t\\n\" + // !behind = 1 - behind\n\n\t\t\t\t// p = point on the plane (0,0,-near)\n\t\t\t\t// n = plane normal (0,0,-1)\n\t\t\t\t// D = Q1 - Q0\n\t\t\t\t// t = ( dot( n, ( p - Q0 ) ) / ( dot( n, d )\n\n\t\t\t\t// solve for t where line crosses Camera.near\n\t\t\t\"add vt4.x, vt0.z, vc7.z\t\t\t\\n\" + // Q0.z + ( -Camera.near )\n\t\t\t\"sub vt4.y, vt0.z, vt1.z\t\t\t\\n\" + // Q0.z - Q1.z\n\n\t\t\t\t// fix divide by zero for horizontal lines\n\t\t\t\"seq vt4.z, vt4.y vc6.x\t\t\t\\n\" + // offset = (Q0.z - Q1.z)==0 ? 1 : 0\n\t\t\t\"add vt4.y, vt4.y, vt4.z\t\t\t\\n\" + // ( Q0.z - Q1.z ) + offset\n\n\t\t\t\"div vt4.z, vt4.x, vt4.y\t\t\t\\n\" + // t = ( Q0.z - near ) / ( Q0.z - Q1.z )\n\n\t\t\t\"mul vt4.xyz, vt4.zzz, vt2.xyz\t\\n\" + // t(L)\n\t\t\t\"add vt3.xyz, vt0.xyz, vt4.xyz\t\\n\" + // Qclipped = Q0 + t(L)\n\t\t\t\"mov vt3.w, vc5.x\t\t\t\\n\" + // Qclipped.w = 1\n\n\t\t\t\t// If necessary, replace Q0 with new Qclipped\n\t\t\t\"mul vt0, vt0, vt5.yyyy\t\t\t\\n\" + // !behind * Q0\n\t\t\t\"mul vt3, vt3, vt5.xxxx\t\t\t\\n\" + // behind * Qclipped\n\t\t\t\"add vt0, vt0, vt3\t\t\t\t\\n\" + // newQ0 = Q0 + Qclipped\n\n\t\t\t\t// calculate side vector for line\n\t\t\t\"sub vt2, vt1, vt0 \t\t\t\\n\" + // L = Q1 - Q0\n\t\t\t\"nrm vt2.xyz, vt2.xyz\t\t\t\\n\" + // normalize( L )\n\t\t\t\"nrm vt5.xyz, vt0.xyz\t\t\t\\n\" + // D = normalize( Q1 )\n\t\t\t\"mov vt5.w, vc5.x\t\t\t\t\\n\" + // D.w = 1\n\t\t\t\"crs vt3.xyz, vt2, vt5\t\t\t\\n\" + // S = L x D\n\t\t\t\"nrm vt3.xyz, vt3.xyz\t\t\t\\n\" + // normalize( S )\n\n\t\t\t\t// face the side vector properly for the given point\n\t\t\t\"mul vt3.xyz, vt3.xyz, va2.xxx\t\\n\" + // S *= weight\n\t\t\t\"mov vt3.w, vc5.x\t\t\t\\n\" + // S.w = 1\n\n\t\t\t\t// calculate the amount required to move at the point's distance to correspond to the line's pixel width\n\t\t\t\t// scale the side vector by that amount\n\t\t\t\"dp3 vt4.x, vt0, vc6\t\t\t\\n\" + // distance = dot( view )\n\t\t\t\"mul vt4.x, vt4.x, vc7.x\t\t\t\\n\" + // distance *= vpsod\n\t\t\t\"mul vt3.xyz, vt3.xyz, vt4.xxx\t\\n\" + // S.xyz *= pixelScaleFactor\n\n\t\t\t\t// add scaled side vector to Q0 and transform to clip space\n\t\t\t\"add vt0.xyz, vt0.xyz, vt3.xyz\t\\n\" + // Q0 + S\n\n\t\t\t\"m44 op, vt0, vc0\t\t\t\\n\"  // transform Q0 to clip space\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iActivate(pass:RenderPassBase, camera:Camera)\n\t{\n\t\tsuper._iActivate(pass, camera);\n\n\t\tthis._constants[0] = this._thickness/((this._stage.scissorRect)? Math.min(this._stage.scissorRect.width, this._stage.scissorRect.height) : Math.min(this._stage.width, this._stage.height));\n\n\t\t// value to convert distance from camera to model length per pixel width\n\t\tthis._constants[2] = camera.projection.near;\n\n\t\tvar context:IContextGL = this._stage.context;\n\n\t\tcontext.setProgramConstantsFromArray(ContextGLProgramType.VERTEX, 5, LineSegmentRenderable.pONE_VECTOR, 1);\n\t\tcontext.setProgramConstantsFromArray(ContextGLProgramType.VERTEX, 6, LineSegmentRenderable.pFRONT_VECTOR, 1);\n\t\tcontext.setProgramConstantsFromArray(ContextGLProgramType.VERTEX, 7, this._constants, 1);\n\n\t\t// projection matrix\n\t\tcontext.setProgramConstantsFromMatrix(ContextGLProgramType.VERTEX, 0, camera.projection.matrix, true);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iRender(pass:RenderPassBase, camera:Camera, viewProjection:Matrix3D)\n\t{\n\t\tsuper._iRender(pass, camera, viewProjection);\n\n\t\tvar context:IContextGL = this._stage.context;\n\t\tthis._calcMatrix.copyFrom(this.sourceEntity.sceneTransform);\n\t\tthis._calcMatrix.append(camera.inverseSceneTransform);\n\n\t\tcontext.setProgramConstantsFromMatrix(ContextGLProgramType.VERTEX, 8, this._calcMatrix, true);\n\n\t\tthis._stage.activateBuffer(0, this.getVertexData(LineSubGeometry.START_POSITION_DATA), this.getVertexOffset(LineSubGeometry.START_POSITION_DATA), LineSubGeometry.POSITION_FORMAT);\n\t\tthis._stage.activateBuffer(1, this.getVertexData(LineSubGeometry.END_POSITION_DATA), this.getVertexOffset(LineSubGeometry.END_POSITION_DATA), LineSubGeometry.POSITION_FORMAT);\n\t\tthis._stage.activateBuffer(2, this.getVertexData(LineSubGeometry.THICKNESS_DATA), this.getVertexOffset(LineSubGeometry.THICKNESS_DATA), LineSubGeometry.THICKNESS_FORMAT);\n\n\t\tcontext.drawTriangles(this._stage.getIndexBuffer(this.getIndexData()), 0, this.numTriangles);\n\t}\n\n\t/**\n\t * //TODO\n\t *\n\t * @param pool\n\t * @param renderableOwner\n\t * @param level\n\t * @param indexOffset\n\t * @returns {away.pool.LineSubMeshRenderable}\n\t * @private\n\t */\n\tpublic _pGetOverflowRenderable(indexOffset:number):RenderableBase\n\t{\n\t\treturn new LineSegmentRenderable(this._pool, <LineSegment> this.renderableOwner, this._stage, this._level + 1, indexOffset);\n\t}\n}\n\nexport = LineSegmentRenderable;","import Matrix3D\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3D\");\n\nimport IRenderableOwner\t\t\t\t= require(\"awayjs-display/lib/base/IRenderableOwner\");\nimport LineSubMesh\t\t\t\t\t= require(\"awayjs-display/lib/base/LineSubMesh\");\nimport LineSubGeometry\t\t\t\t= require(\"awayjs-display/lib/base/LineSubGeometry\");\nimport SubGeometryEvent\t\t\t\t= require(\"awayjs-display/lib/events/SubGeometryEvent\");\nimport Camera\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\nimport DefaultMaterialManager\t\t= require(\"awayjs-display/lib/managers/DefaultMaterialManager\");\n\nimport IContextGL\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/IContextGL\");\nimport ContextGLProgramType\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLProgramType\");\nimport Stage\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\n\nimport ShaderObjectBase\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport ShaderRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterCache\");\nimport ShaderRegisterData\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterData\");\nimport ShaderRegisterElement\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\nimport RenderableBase\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\nimport RenderablePoolBase\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderablePoolBase\");\nimport RenderPassBase\t\t\t\t= require(\"awayjs-renderergl/lib/passes/RenderPassBase\");\n\n/**\n * @class away.pool.LineSubMeshRenderable\n */\nclass LineSubMeshRenderable extends RenderableBase\n{\n\tpublic static pONE_VECTOR:Array<number> = Array<number>(1, 1, 1, 1);\n\tpublic static pFRONT_VECTOR:Array<number> = Array<number>(0, 0, -1, 0);\n\n\tprivate _constants:Array<number> = new Array<number>(0, 0, 0, 0);\n\tprivate _calcMatrix:Matrix3D;\n\tprivate _thickness:number = 1.25;\n\n\t/**\n\t *\n\t */\n\tpublic static id:string = \"linesubmesh\";\n\n\tpublic static vertexAttributesOffset:number = 3;\n\n\t/**\n\t *\n\t */\n\tpublic subMesh:LineSubMesh;\n\n\t/**\n\t * //TODO\n\t *\n\t * @param pool\n\t * @param subMesh\n\t * @param level\n\t * @param dataOffset\n\t */\n\tconstructor(pool:RenderablePoolBase, subMesh:LineSubMesh, stage:Stage, level:number = 0, indexOffset:number = 0)\n\t{\n\t\tsuper(pool, subMesh.parentMesh, subMesh, subMesh.material, stage, level, indexOffset);\n\n\t\tthis.subMesh = subMesh;\n\n\t\tthis._calcMatrix = new Matrix3D();\n\n\t\tthis._constants[1] = 1/255;\n\t}\n\n\t/**\n\t * //TODO\n\t *\n\t * @returns {base.LineSubGeometry}\n\t * @protected\n\t */\n\tpublic _pGetSubGeometry():LineSubGeometry\n\t{\n\t\tvar subGeometry:LineSubGeometry = this.subMesh.subGeometry;\n\n\t\tthis._pVertexDataDirty[LineSubGeometry.START_POSITION_DATA] = true;\n\t\tthis._pVertexDataDirty[LineSubGeometry.END_POSITION_DATA] = true;\n\n\t\tif (subGeometry.thickness)\n\t\t\tthis._pVertexDataDirty[LineSubGeometry.THICKNESS_DATA] = true;\n\n\t\tif (subGeometry.startColors)\n\t\t\tthis._pVertexDataDirty[LineSubGeometry.COLOR_DATA] = true;\n\n\t\treturn subGeometry;\n\t}\n\n\tpublic static _iIncludeDependencies(shaderObject:ShaderObjectBase)\n\t{\n\t\tshaderObject.colorDependencies++;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic static _iGetVertexCode(shader:ShaderObjectBase, regCache:ShaderRegisterCache, sharedReg:ShaderRegisterData):string\n\t{\n\t\treturn \"m44 vt0, va0, vc8\t\t\t\\n\" + // transform Q0 to eye space\n\t\t\t\"m44 vt1, va1, vc8\t\t\t\\n\" + // transform Q1 to eye space\n\t\t\t\"sub vt2, vt1, vt0 \t\t\t\\n\" + // L = Q1 - Q0\n\n\t\t\t\t// test if behind camera near plane\n\t\t\t\t// if 0 - Q0.z < Camera.near then the point needs to be clipped\n\t\t\t\t//\"neg vt5.x, vt0.z\t\t\t\t\\n\" + // 0 - Q0.z\n\t\t\t\"slt vt5.x, vt0.z, vc7.z\t\t\t\\n\" + // behind = ( 0 - Q0.z < -Camera.near ) ? 1 : 0\n\t\t\t\"sub vt5.y, vc5.x, vt5.x\t\t\t\\n\" + // !behind = 1 - behind\n\n\t\t\t\t// p = point on the plane (0,0,-near)\n\t\t\t\t// n = plane normal (0,0,-1)\n\t\t\t\t// D = Q1 - Q0\n\t\t\t\t// t = ( dot( n, ( p - Q0 ) ) / ( dot( n, d )\n\n\t\t\t\t// solve for t where line crosses Camera.near\n\t\t\t\"add vt4.x, vt0.z, vc7.z\t\t\t\\n\" + // Q0.z + ( -Camera.near )\n\t\t\t\"sub vt4.y, vt0.z, vt1.z\t\t\t\\n\" + // Q0.z - Q1.z\n\n\t\t\t\t// fix divide by zero for horizontal lines\n\t\t\t\"seq vt4.z, vt4.y vc6.x\t\t\t\\n\" + // offset = (Q0.z - Q1.z)==0 ? 1 : 0\n\t\t\t\"add vt4.y, vt4.y, vt4.z\t\t\t\\n\" + // ( Q0.z - Q1.z ) + offset\n\n\t\t\t\"div vt4.z, vt4.x, vt4.y\t\t\t\\n\" + // t = ( Q0.z - near ) / ( Q0.z - Q1.z )\n\n\t\t\t\"mul vt4.xyz, vt4.zzz, vt2.xyz\t\\n\" + // t(L)\n\t\t\t\"add vt3.xyz, vt0.xyz, vt4.xyz\t\\n\" + // Qclipped = Q0 + t(L)\n\t\t\t\"mov vt3.w, vc5.x\t\t\t\\n\" + // Qclipped.w = 1\n\n\t\t\t\t// If necessary, replace Q0 with new Qclipped\n\t\t\t\"mul vt0, vt0, vt5.yyyy\t\t\t\\n\" + // !behind * Q0\n\t\t\t\"mul vt3, vt3, vt5.xxxx\t\t\t\\n\" + // behind * Qclipped\n\t\t\t\"add vt0, vt0, vt3\t\t\t\t\\n\" + // newQ0 = Q0 + Qclipped\n\n\t\t\t\t// calculate side vector for line\n\t\t\t\"sub vt2, vt1, vt0 \t\t\t\\n\" + // L = Q1 - Q0\n\t\t\t\"nrm vt2.xyz, vt2.xyz\t\t\t\\n\" + // normalize( L )\n\t\t\t\"nrm vt5.xyz, vt0.xyz\t\t\t\\n\" + // D = normalize( Q1 )\n\t\t\t\"mov vt5.w, vc5.x\t\t\t\t\\n\" + // D.w = 1\n\t\t\t\"crs vt3.xyz, vt2, vt5\t\t\t\\n\" + // S = L x D\n\t\t\t\"nrm vt3.xyz, vt3.xyz\t\t\t\\n\" + // normalize( S )\n\n\t\t\t\t// face the side vector properly for the given point\n\t\t\t\"mul vt3.xyz, vt3.xyz, va2.xxx\t\\n\" + // S *= weight\n\t\t\t\"mov vt3.w, vc5.x\t\t\t\\n\" + // S.w = 1\n\n\t\t\t\t// calculate the amount required to move at the point's distance to correspond to the line's pixel width\n\t\t\t\t// scale the side vector by that amount\n\t\t\t\"dp3 vt4.x, vt0, vc6\t\t\t\\n\" + // distance = dot( view )\n\t\t\t\"mul vt4.x, vt4.x, vc7.x\t\t\t\\n\" + // distance *= vpsod\n\t\t\t\"mul vt3.xyz, vt3.xyz, vt4.xxx\t\\n\" + // S.xyz *= pixelScaleFactor\n\n\t\t\t\t// add scaled side vector to Q0 and transform to clip space\n\t\t\t\"add vt0.xyz, vt0.xyz, vt3.xyz\t\\n\" + // Q0 + S\n\n\t\t\t\"m44 op, vt0, vc0\t\t\t\\n\"  // transform Q0 to clip space\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iActivate(pass:RenderPassBase, camera:Camera)\n\t{\n\t\tsuper._iActivate(pass, camera);\n\n\t\tthis._constants[0] = this._thickness/((this._stage.scissorRect)? Math.min(this._stage.scissorRect.width, this._stage.scissorRect.height) : Math.min(this._stage.width, this._stage.height));\n\n\t\t// value to convert distance from camera to model length per pixel width\n\t\tthis._constants[2] = camera.projection.near;\n\n\t\tvar context:IContextGL = this._stage.context;\n\n\t\tcontext.setProgramConstantsFromArray(ContextGLProgramType.VERTEX, 5, LineSubMeshRenderable.pONE_VECTOR, 1);\n\t\tcontext.setProgramConstantsFromArray(ContextGLProgramType.VERTEX, 6, LineSubMeshRenderable.pFRONT_VECTOR, 1);\n\t\tcontext.setProgramConstantsFromArray(ContextGLProgramType.VERTEX, 7, this._constants, 1);\n\n\t\t// projection matrix\n\t\tcontext.setProgramConstantsFromMatrix(ContextGLProgramType.VERTEX, 0, camera.projection.matrix, true);\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iRender(pass:RenderPassBase, camera:Camera, viewProjection:Matrix3D)\n\t{\n\t\tsuper._iRender(pass, camera, viewProjection);\n\n\t\tvar context:IContextGL = this._stage.context;\n\t\tthis._calcMatrix.copyFrom(this.sourceEntity.sceneTransform);\n\t\tthis._calcMatrix.append(camera.inverseSceneTransform);\n\n\t\tcontext.setProgramConstantsFromMatrix(ContextGLProgramType.VERTEX, 8, this._calcMatrix, true);\n\n\t\tthis._stage.activateBuffer(0, this.getVertexData(LineSubGeometry.START_POSITION_DATA), this.getVertexOffset(LineSubGeometry.START_POSITION_DATA), LineSubGeometry.POSITION_FORMAT);\n\t\tthis._stage.activateBuffer(1, this.getVertexData(LineSubGeometry.END_POSITION_DATA), this.getVertexOffset(LineSubGeometry.END_POSITION_DATA), LineSubGeometry.POSITION_FORMAT);\n\t\tthis._stage.activateBuffer(2, this.getVertexData(LineSubGeometry.THICKNESS_DATA), this.getVertexOffset(LineSubGeometry.THICKNESS_DATA), LineSubGeometry.THICKNESS_FORMAT);\n\n\t\tcontext.drawTriangles(this._stage.getIndexBuffer(this.getIndexData()), 0, this.numTriangles);\n\t}\n\n\t/**\n\t * //TODO\n\t *\n\t * @param pool\n\t * @param renderableOwner\n\t * @param level\n\t * @param indexOffset\n\t * @returns {away.pool.LineSubMeshRenderable}\n\t * @private\n\t */\n\tpublic _pGetOverflowRenderable(indexOffset:number):RenderableBase\n\t{\n\t\treturn new LineSubMeshRenderable(this._pool, <LineSubMesh> this.renderableOwner, this._stage, this._level + 1, indexOffset);\n\t}\n}\n\nexport = LineSubMeshRenderable;","import Matrix3D\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3D\");\nimport AbstractMethodError\t\t\t= require(\"awayjs-core/lib/errors/AbstractMethodError\");\n\nimport IRenderableOwner\t\t\t\t= require(\"awayjs-display/lib/base/IRenderableOwner\");\nimport IRenderObjectOwner\t\t\t= require(\"awayjs-display/lib/base/IRenderObjectOwner\");\nimport SubGeometryBase\t\t\t\t= require(\"awayjs-display/lib/base/SubGeometryBase\");\nimport TriangleSubGeometry\t\t\t= require(\"awayjs-display/lib/base/TriangleSubGeometry\");\nimport IRenderable\t\t\t\t\t= require(\"awayjs-display/lib/pool/IRenderable\");\nimport IEntity\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/IEntity\");\nimport Camera\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\nimport RenderableOwnerEvent\t\t\t= require(\"awayjs-display/lib/events/RenderableOwnerEvent\");\nimport SubGeometryEvent\t\t\t\t= require(\"awayjs-display/lib/events/SubGeometryEvent\");\nimport IRenderer\t\t\t\t\t= require(\"awayjs-display/lib/render/IRenderer\");\nimport MaterialBase\t\t\t\t\t= require(\"awayjs-display/lib/materials/MaterialBase\");\n\nimport IndexData\t\t\t\t\t= require(\"awayjs-stagegl/lib/pool/IndexData\");\nimport IndexDataPool\t\t\t\t= require(\"awayjs-stagegl/lib/pool/IndexDataPool\");\nimport VertexData\t\t\t\t\t= require(\"awayjs-stagegl/lib/pool/VertexData\");\nimport VertexDataPool\t\t\t\t= require(\"awayjs-stagegl/lib/pool/VertexDataPool\");\nimport Stage\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\n\nimport ShaderObjectBase\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport ShaderRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterCache\");\nimport ShaderRegisterData\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterData\");\nimport RenderablePoolBase\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderablePoolBase\");\nimport RenderObjectBase\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/RenderObjectBase\");\nimport RenderPassBase\t\t\t\t= require(\"awayjs-renderergl/lib/passes/RenderPassBase\");\n\n/**\n * @class RenderableListItem\n */\nclass RenderableBase implements IRenderable\n{\n\n\tprivate _onIndicesUpdatedDelegate:(event:SubGeometryEvent) => void;\n\tprivate _onVerticesUpdatedDelegate:(event:SubGeometryEvent) => void;\n\tprivate _onRenderObjectOwnerUpdatedDelegate:(event:RenderableOwnerEvent) => void;\n\n\tprivate _subGeometry:SubGeometryBase;\n\tprivate _geometryDirty:boolean = true;\n\tprivate _indexData:IndexData;\n\tprivate _indexDataDirty:boolean = true;\n\tprivate _vertexData:Object = new Object();\n\tpublic _pVertexDataDirty:Object = new Object();\n\tprivate _vertexOffset:Object = new Object();\n\n\tpublic _level:number;\n\tprivate _indexOffset:number;\n\tprivate _overflow:RenderableBase;\n\tprivate _numTriangles:number;\n\tprivate _concatenateArrays:boolean;\n\n\tpublic JOINT_INDEX_FORMAT:string;\n\tpublic JOINT_WEIGHT_FORMAT:string;\n\n\t/**\n\t *\n\t */\n\tpublic _pool:RenderablePoolBase;\n\n\tpublic _stage:Stage;\n\n\t/**\n\t *\n\t */\n\tpublic get overflow():RenderableBase\n\t{\n\t\tif (this._indexDataDirty)\n\t\t\tthis._updateIndexData();\n\n\t\treturn this._overflow;\n\t}\n\n\t/**\n\t *\n\t */\n\tpublic get numTriangles():number\n\t{\n\t\treturn this._numTriangles;\n\t}\n\n\t/**\n\t *\n\t */\n\tpublic next:RenderableBase;\n\n\tpublic id:number;\n\n\t/**\n\t *\n\t */\n\tpublic renderObjectId:number;\n\n\t/**\n\t *\n\t */\n\tpublic renderOrderId:number;\n\n\t/**\n\t *\n\t */\n\tpublic zIndex:number;\n\n\t/**\n\t *\n\t */\n\tpublic cascaded:boolean;\n\n\t/**\n\t *\n\t */\n\tpublic renderSceneTransform:Matrix3D;\n\n\t/**\n\t *\n\t */\n\tpublic sourceEntity:IEntity;\n\n\t/**\n\t *\n\t */\n\tpublic renderableOwner:IRenderableOwner;\n\n\n\t/**\n\t *\n\t */\n\tpublic renderObjectOwner:IRenderObjectOwner;\n\n\t/**\n\t *\n\t */\n\tpublic renderObject:RenderObjectBase;\n\n\t/**\n\t *\n\t */\n\tpublic getIndexData():IndexData\n\t{\n\t\tif (this._indexDataDirty)\n\t\t\tthis._updateIndexData();\n\n\t\treturn this._indexData;\n\t}\n\n\t/**\n\t *\n\t */\n\tpublic getVertexData(dataType:string):VertexData\n\t{\n\t\tif (this._indexDataDirty)\n\t\t\tthis._updateIndexData();\n\n\t\tif (this._pVertexDataDirty[dataType])\n\t\t\tthis._updateVertexData(dataType);\n\n\t\treturn this._vertexData[this._concatenateArrays? TriangleSubGeometry.VERTEX_DATA : dataType]\n\t}\n\n\t/**\n\t *\n\t */\n\tpublic getVertexOffset(dataType:string):number\n\t{\n\t\tif (this._indexDataDirty)\n\t\t\tthis._updateIndexData();\n\n\t\tif (this._pVertexDataDirty[dataType])\n\t\t\tthis._updateVertexData(dataType);\n\n\t\treturn this._vertexOffset[dataType];\n\t}\n\n\t/**\n\t *\n\t * @param sourceEntity\n\t * @param renderableOwner\n\t * @param subGeometry\n\t * @param animationSubGeometry\n\t */\n\tconstructor(pool:RenderablePoolBase, sourceEntity:IEntity, renderableOwner:IRenderableOwner, renderObjectOwner:IRenderObjectOwner, stage:Stage, level:number = 0, indexOffset:number = 0)\n\t{\n\t\tthis._onIndicesUpdatedDelegate = (event:SubGeometryEvent) => this._onIndicesUpdated(event);\n\t\tthis._onVerticesUpdatedDelegate = (event:SubGeometryEvent) => this._onVerticesUpdated(event);\n\t\tthis._onRenderObjectOwnerUpdatedDelegate = (event:RenderableOwnerEvent) => this._onRenderObjectOwnerUpdated(event);\n\n\t\t//store a reference to the pool for later disposal\n\t\tthis._pool = pool;\n\t\tthis._stage = stage;\n\n\t\t//reference to level of overflow\n\t\tthis._level = level;\n\n\t\t//reference to the offset on indices (if this is an overflow renderable)\n\t\tthis._indexOffset = indexOffset;\n\n\t\tthis.sourceEntity = sourceEntity;\n\n\t\tthis.renderableOwner = renderableOwner;\n\n\t\tthis.renderableOwner.addEventListener(RenderableOwnerEvent.RENDER_OBJECT_OWNER_UPDATED, this._onRenderObjectOwnerUpdatedDelegate)\n\n\t\tthis.renderObjectOwner = renderObjectOwner;\n\t}\n\n\tpublic dispose()\n\t{\n\t\tthis._pool.disposeItem(this.renderableOwner);\n\n\t\tthis._indexData.dispose();\n\t\tthis._indexData = null;\n\n\t\tfor (var dataType in this._vertexData) {\n\t\t\t(<VertexData> this._vertexData[dataType]).dispose();\n\t\t\tthis._vertexData[dataType] = null;\n\t\t}\n\n\t\tif (this._overflow) {\n\t\t\tthis._overflow.dispose();\n\t\t\tthis._overflow = null;\n\t\t}\n\t}\n\n\tpublic invalidateGeometry()\n\t{\n\t\tthis._geometryDirty = true;\n\n\t\t//invalidate indices\n\t\tif (this._level == 0)\n\t\t\tthis._indexDataDirty = true;\n\n\t\tif (this._overflow)\n\t\t\tthis._overflow.invalidateGeometry();\n\t}\n\n\t/**\n\t *\n\t */\n\tpublic invalidateIndexData()\n\t{\n\t\tthis._indexDataDirty = true;\n\t}\n\n\t/**\n\t * //TODO\n\t *\n\t * @param dataType\n\t */\n\tpublic invalidateVertexData(dataType:string)\n\t{\n\t\tthis._pVertexDataDirty[dataType] = true;\n\t}\n\n\tpublic _pGetSubGeometry():SubGeometryBase\n\t{\n\t\tthrow new AbstractMethodError();\n\t}\n\n\tpublic static _iGetVertexCode(shaderObject:ShaderObjectBase, registerCache:ShaderRegisterCache, sharedRegisters:ShaderRegisterData):string\n\t{\n\t\treturn \"\";\n\t}\n\n\tpublic static _iGetFragmentCode(shaderObject:ShaderObjectBase, registerCache:ShaderRegisterCache, sharedRegisters:ShaderRegisterData):string\n\t{\n\t\treturn \"\";\n\t}\n\n\t/**\n\t * //TODO\n\t *\n\t * @param subGeometry\n\t * @param offset\n\t * @internal\n\t */\n\tpublic _iFillIndexData(indexOffset:number)\n\t{\n\t\tif (this._geometryDirty)\n\t\t\tthis._updateGeometry();\n\n\t\tthis._indexData = IndexDataPool.getItem(this._subGeometry, this._level, indexOffset);\n\n\t\tthis._numTriangles = this._indexData.data.length/3;\n\n\t\tindexOffset = this._indexData.offset;\n\n\t\t//check if there is more to split\n\t\tif (indexOffset < this._subGeometry.indices.length) {\n\t\t\tif (!this._overflow)\n\t\t\t\tthis._overflow = this._pGetOverflowRenderable(indexOffset);\n\n\t\t\tthis._overflow._iFillIndexData(indexOffset);\n\t\t} else if (this._overflow) {\n\t\t\tthis._overflow.dispose();\n\t\t\tthis._overflow = null;\n\t\t}\n\t}\n\n\tpublic _pGetOverflowRenderable(indexOffset:number):RenderableBase\n\t{\n\t\tthrow new AbstractMethodError();\n\t}\n\n\t/**\n\t * Sets the render state for the pass that is independent of the rendered object. This needs to be called before\n\t * calling renderPass. Before activating a pass, the previously used pass needs to be deactivated.\n\t * @param stage The Stage object which is currently used for rendering.\n\t * @param camera The camera from which the scene is viewed.\n\t * @private\n\t */\n\tpublic _iActivate(pass:RenderPassBase, camera:Camera)\n\t{\n\t\tpass._iActivate(camera);\n\t}\n\n\t/**\n\t * Renders an object to the current render target.\n\t *\n\t * @private\n\t */\n\tpublic _iRender(pass:RenderPassBase, camera:Camera, viewProjection:Matrix3D)\n\t{\n\t\tpass._iRender(this, camera, viewProjection);\n\t}\n\n\t/**\n\t * Clears the render state for the pass. This needs to be called before activating another pass.\n\t * @param stage The Stage used for rendering\n\t *\n\t * @private\n\t */\n\tpublic _iDeactivate(pass:RenderPassBase)\n\t{\n\t\tpass._iDeactivate();\n\t}\n\n\t/**\n\t * //TODO\n\t *\n\t * @private\n\t */\n\tprivate _updateGeometry()\n\t{\n\t\tif (this._subGeometry) {\n\t\t\tif (this._level == 0)\n\t\t\t\tthis._subGeometry.removeEventListener(SubGeometryEvent.INDICES_UPDATED, this._onIndicesUpdatedDelegate);\n\t\t\tthis._subGeometry.removeEventListener(SubGeometryEvent.VERTICES_UPDATED, this._onVerticesUpdatedDelegate);\n\t\t}\n\n\t\tthis._subGeometry = this._pGetSubGeometry();\n\n\t\tthis._concatenateArrays = this._subGeometry.concatenateArrays;\n\n\t\tif (this._subGeometry) {\n\t\t\tif (this._level == 0)\n\t\t\t\tthis._subGeometry.addEventListener(SubGeometryEvent.INDICES_UPDATED, this._onIndicesUpdatedDelegate);\n\t\t\tthis._subGeometry.addEventListener(SubGeometryEvent.VERTICES_UPDATED, this._onVerticesUpdatedDelegate);\n\t\t}\n\n\t\t//dispose\n//\t\t\tif (this._indexData) {\n//\t\t\t\tthis._indexData.dispose(); //TODO where is a good place to dispose?\n//\t\t\t\tthis._indexData = null;\n//\t\t\t}\n\n//\t\t\tfor (var dataType in this._vertexData) {\n//\t\t\t\t(<VertexData> this._vertexData[dataType]).dispose(); //TODO where is a good place to dispose?\n//\t\t\t\tthis._vertexData[dataType] = null;\n//\t\t\t}\n\n\t\tthis._geometryDirty = false;\n\n\t\t//specific vertex data types have to be invalidated in the specific renderable\n\t}\n\n\t/**\n\t * //TODO\n\t *\n\t * @private\n\t */\n\tprivate _updateIndexData()\n\t{\n\t\tthis._iFillIndexData(this._indexOffset);\n\n\t\tthis._indexDataDirty = false;\n\t}\n\n\t/**\n\t * //TODO\n\t *\n\t * @param dataType\n\t * @private\n\t */\n\tprivate _updateVertexData(dataType:string)\n\t{\n\t\tthis._vertexOffset[dataType] = this._subGeometry.getOffset(dataType);\n\n\t\tif (this._subGeometry.concatenateArrays)\n\t\t\tdataType = SubGeometryBase.VERTEX_DATA;\n\n\t\tthis._vertexData[dataType] = VertexDataPool.getItem(this._subGeometry, this.getIndexData(), dataType);\n\n\t\tthis._pVertexDataDirty[dataType] = false;\n\t}\n\n\t/**\n\t * //TODO\n\t *\n\t * @param event\n\t * @private\n\t */\n\tprivate _onIndicesUpdated(event:SubGeometryEvent)\n\t{\n\t\tthis.invalidateIndexData();\n\t}\n\n\t/**\n\t * //TODO\n\t *\n\t * @param event\n\t * @private\n\t */\n\tprivate _onVerticesUpdated(event:SubGeometryEvent)\n\t{\n\t\tthis._concatenateArrays = (<SubGeometryBase> event.target).concatenateArrays;\n\n\t\tthis.invalidateVertexData(event.dataType);\n\t}\n\n\tprivate _onRenderObjectOwnerUpdated(event:RenderableOwnerEvent)\n\t{\n\t\t//TODO flag unused renderObjects for deletion\n\t\tthis.renderObjectOwner = event.renderObjectOwner;\n\t}\n}\n\nexport = RenderableBase;","import IRenderObjectOwner\t\t\t= require(\"awayjs-display/lib/base/IRenderObjectOwner\");\nimport IRenderableOwner\t\t\t\t= require(\"awayjs-display/lib/base/IRenderableOwner\");\nimport MaterialBase\t\t\t\t\t= require(\"awayjs-display/lib/materials/MaterialBase\");\nimport IRenderablePool\t\t\t\t= require(\"awayjs-display/lib/pool/IRenderablePool\");\nimport IRenderObject\t\t\t\t= require(\"awayjs-display/lib/pool/IRenderObject\");\n\nimport Stage\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\n\nimport RendererBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/base/RendererBase\");\nimport RenderableBase\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\nimport IRenderableClass\t\t\t\t= require(\"awayjs-renderergl/lib/pool/IRenderableClass\");\nimport RenderObjectPool\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/RenderObjectPool\");\nimport RenderBasicMaterialObject\t= require(\"awayjs-renderergl/lib/compilation/RenderBasicMaterialObject\");\nimport SkyboxRenderObject\t\t\t= require(\"awayjs-renderergl/lib/compilation/SkyboxRenderObject\");\nimport DepthRenderObject\t\t\t= require(\"awayjs-renderergl/lib/compilation/DepthRenderObject\");\nimport DistanceRenderObject\t\t\t= require(\"awayjs-renderergl/lib/compilation/DistanceRenderObject\");\nimport RenderObjectBase\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/RenderObjectBase\");\n\n/**\n * @class away.pool.RenderablePoolBase\n */\nclass RenderablePoolBase implements IRenderablePool\n{\n\tpublic static _pools:Object = new Object();\n\n\tpublic _stage:Stage;\n\tpublic _renderablePool:Object = new Object();\n\tpublic _renderableClass:IRenderableClass;\n\n\tprivate _materialRenderObjectPool:RenderObjectPool;\n\tprivate _skyboxRenderObjectPool:RenderObjectPool;\n\tprivate _depthRenderObjectPool:RenderObjectPool;\n\tprivate _distanceRenderObjectPool:RenderObjectPool;\n\n\t/**\n\t * //TODO\n\t *\n\t * @param renderableClass\n\t */\n\tconstructor(renderableClass:IRenderableClass, stage:Stage)\n\t{\n\t\tthis._renderableClass = renderableClass;\n\t\tthis._stage = stage;\n\n\t\tthis._materialRenderObjectPool = new RenderObjectPool(RenderBasicMaterialObject, this._renderableClass, this._stage);\n\t\tthis._skyboxRenderObjectPool = new RenderObjectPool(SkyboxRenderObject, this._renderableClass, this._stage);\n\t\tthis._depthRenderObjectPool = new RenderObjectPool(DepthRenderObject, this._renderableClass, this._stage);\n\t\tthis._distanceRenderObjectPool = new RenderObjectPool(DistanceRenderObject, this._renderableClass, this._stage);\n\t}\n\n\t/**\n\t * //TODO\n\t *\n\t * @param renderableOwner\n\t * @returns IRenderable\n\t */\n\tpublic getItem(renderableOwner:IRenderableOwner):RenderableBase\n\t{\n\t\treturn (this._renderablePool[renderableOwner.id] || (this._renderablePool[renderableOwner.id] = renderableOwner._iAddRenderable(new this._renderableClass(this, renderableOwner, this._stage))))\n\t}\n\n\t/**\n\t *\n\t * @param material\n\t * @param renderable\n\t */\n\tpublic getMaterialRenderObject(renderObjectOwner:IRenderObjectOwner):RenderObjectBase\n\t{\n\t\treturn this._materialRenderObjectPool.getItem(renderObjectOwner);\n\t}\n\n\t/**\n\t *\n\t * @param material\n\t * @param renderable\n\t */\n\tpublic getSkyboxRenderObject(renderObjectOwner:IRenderObjectOwner):RenderObjectBase\n\t{\n\t\treturn this._skyboxRenderObjectPool.getItem(renderObjectOwner);\n\t}\n\n\t/**\n\t *\n\t * @param material\n\t * @param renderable\n\t */\n\tpublic getDepthRenderObject(renderObjectOwner:IRenderObjectOwner):RenderObjectBase\n\t{\n\t\treturn this._depthRenderObjectPool.getItem(renderObjectOwner);\n\t}\n\n\t/**\n\t *\n\t * @param material\n\t * @param renderable\n\t */\n\tpublic getDistanceRenderObject(renderObjectOwner:IRenderObjectOwner):RenderObjectBase\n\t{\n\t\treturn this._distanceRenderObjectPool.getItem(renderObjectOwner);\n\t}\n\n\t/**\n\t * //TODO\n\t *\n\t * @param renderableOwner\n\t */\n\tpublic disposeItem(renderableOwner:IRenderableOwner)\n\t{\n\t\trenderableOwner._iRemoveRenderable(this._renderablePool[renderableOwner.id]);\n\n\t\tthis._renderablePool[renderableOwner.id] = null;\n\t}\n\n\tpublic dispose()\n\t{\n\t\tfor (var id in this._renderablePool)\n\t\t\tthis._renderablePool[id].dispose();\n\n\t\tRenderablePoolBase.disposePool(this._renderableClass, this._stage);\n\t}\n\n\t/**\n\t * //TODO\n\t *\n\t * @param renderableClass\n\t * @returns RenderablePoolBase\n\t */\n\tpublic static getPool(renderableClass:IRenderableClass, stage:Stage):RenderablePoolBase\n\t{\n\t\tvar pools:Object = (RenderablePoolBase._pools[stage.stageIndex] || (RenderablePoolBase._pools[stage.stageIndex] = new Object()));\n\n\t\treturn (pools[renderableClass.id] || (pools[renderableClass.id] = new RenderablePoolBase(renderableClass, stage)));\n\t}\n\n\t/**\n\t * //TODO\n\t *\n\t * @param renderableClass\n\t */\n\tpublic static disposePool(renderableClass:IRenderableClass, stage:Stage)\n\t{\n\t\tvar pools:Object = RenderablePoolBase._pools[stage.stageIndex];\n\n\t\tif (pools == undefined)\n\t\t\treturn;\n\n\t\tif (pools[renderableClass.id])\n\t\t\tpools[renderableClass.id] = undefined;\n\t}\n}\n\nexport = RenderablePoolBase;","\nimport LineSubMesh\t\t\t\t\t= require(\"awayjs-display/lib/base/LineSubMesh\");\nimport TriangleSubMesh\t\t\t\t= require(\"awayjs-display/lib/base/TriangleSubMesh\");\nimport IRendererPool\t\t\t\t= require(\"awayjs-display/lib/pool/IRendererPool\");\nimport Billboard\t\t\t\t\t= require(\"awayjs-display/lib/entities/Billboard\");\nimport LineSegment\t\t\t\t\t= require(\"awayjs-display/lib/entities/LineSegment\");\nimport Skybox\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Skybox\");\n\nimport Stage\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\n\nimport BillboardRenderable\t\t\t= require(\"awayjs-renderergl/lib/pool/BillboardRenderable\");\nimport LineSegmentRenderable\t\t= require(\"awayjs-renderergl/lib/pool/LineSegmentRenderable\");\nimport LineSubMeshRenderable\t\t= require(\"awayjs-renderergl/lib/pool/LineSubMeshRenderable\");\nimport TriangleSubMeshRenderable\t= require(\"awayjs-renderergl/lib/pool/TriangleSubMeshRenderable\");\nimport RenderablePoolBase\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderablePoolBase\");\nimport RendererBase\t\t\t\t\t= require(\"awayjs-renderergl/lib/base/RendererBase\");\n\n/**\n * RendererPoolBase forms an abstract base class for classes that are used in the rendering pipeline to render the\n * contents of a partition\n *\n * @class away.render.RendererPoolBase\n */\nclass RendererPoolBase implements IRendererPool\n{\n\tpublic _billboardRenderablePool:RenderablePoolBase;\n\tpublic _lineSegmentRenderablePool:RenderablePoolBase;\n\tpublic _triangleSubMeshRenderablePool:RenderablePoolBase;\n\tpublic _lineSubMeshRenderablePool:RenderablePoolBase;\n\n\tpublic _pStage:Stage;\n\n\n\tprivate _renderer:RendererBase;\n\t\n\t/**\n\t * Creates a new RendererPoolBase object.\n\t */\n\tconstructor(renderer:RendererBase)\n\t{\n\t\tthis._renderer = renderer;\n\t}\n\n\t/**\n\t * The Stage that will provide the ContextGL used for rendering.\n\t */\n\tpublic get stage():Stage\n\t{\n\t\treturn this._pStage;\n\t}\n\n\tpublic set stage(value:Stage)\n\t{\n\t\tif (this._pStage == value)\n\t\t\treturn;\n\n\t\tif (this._pStage)\n\t\t\tthis.dispose();\n\n\t\tthis._pStage = value;\n\n\t\tif (this._pStage)\n\t\t\tthis._pUpdatePool();\n\t}\n\n\tpublic _pUpdatePool()\n\t{\n\t\tthis._billboardRenderablePool = RenderablePoolBase.getPool(BillboardRenderable, this._pStage);\n\t\tthis._lineSegmentRenderablePool = RenderablePoolBase.getPool(LineSegmentRenderable, this._pStage);\n\t\tthis._triangleSubMeshRenderablePool = RenderablePoolBase.getPool(TriangleSubMeshRenderable, this._pStage);\n\t\tthis._lineSubMeshRenderablePool = RenderablePoolBase.getPool(LineSubMeshRenderable, this._pStage);\n\t}\n\n\t/**\n\t * Disposes the resources used by the RendererPoolBase.\n\t */\n\tpublic dispose()\n\t{\n\t\tthis._billboardRenderablePool.dispose();\n\t\tthis._billboardRenderablePool = null;\n\n\t\tthis._lineSegmentRenderablePool.dispose();\n\t\tthis._lineSegmentRenderablePool = null;\n\n\t\tthis._triangleSubMeshRenderablePool.dispose();\n\t\tthis._triangleSubMeshRenderablePool = null;\n\n\t\tthis._lineSubMeshRenderablePool.dispose();\n\t\tthis._lineSubMeshRenderablePool = null;\n\t}\n\n\t/**\n\t *\n\t * @param billboard\n\t * @protected\n\t */\n\tpublic applyBillboard(billboard:Billboard)\n\t{\n\t\tthis._renderer.applyRenderable(this._billboardRenderablePool.getItem(billboard));\n\t}\n\n\t/**\n\t *\n\t * @param lineSubMesh\n\t */\n\tpublic applyLineSegment(lineSegment:LineSegment)\n\t{\n\t\tthis._renderer.applyRenderable(this._lineSegmentRenderablePool.getItem(lineSegment));\n\t}\n\n\t/**\n\t *\n\t * @param triangleSubMesh\n\t */\n\tpublic applyTriangleSubMesh(triangleSubMesh:TriangleSubMesh)\n\t{\n\t\tthis._renderer.applyRenderable(this._triangleSubMeshRenderablePool.getItem(triangleSubMesh));\n\t}\n\n\t/**\n\t *\n\t * @param lineSubMesh\n\t */\n\tpublic applyLineSubMesh(lineSubMesh:LineSubMesh)\n\t{\n\t\tthis._renderer.applyRenderable(this._lineSubMeshRenderablePool.getItem(lineSubMesh));\n\t}\n}\n\nexport = RendererPoolBase;","import Matrix3D\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3D\");\nimport Vector3D\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\nimport CubeTextureBase\t\t\t\t= require(\"awayjs-core/lib/textures/CubeTextureBase\");\n\nimport TriangleSubGeometry\t\t\t= require(\"awayjs-display/lib/base/TriangleSubGeometry\");\nimport Skybox\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Skybox\");\nimport Camera\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\n\nimport IContextGL\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/IContextGL\");\nimport ContextGLCompareMode\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLCompareMode\");\nimport ContextGLMipFilter\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLMipFilter\");\nimport ContextGLProgramType\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLProgramType\");\nimport ContextGLTextureFilter\t\t= require(\"awayjs-stagegl/lib/base/ContextGLTextureFilter\");\nimport ContextGLWrapMode\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLWrapMode\");\nimport Stage\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\n\nimport ShaderObjectBase\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport ShaderRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterCache\");\nimport ShaderRegisterData\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterData\");\nimport ShaderRegisterElement\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\nimport RenderableBase\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\nimport RenderablePoolBase\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderablePoolBase\");\nimport ShaderCompilerHelper\t\t\t= require(\"awayjs-renderergl/lib/utils/ShaderCompilerHelper\");\nimport RenderPassBase\t\t\t\t= require(\"awayjs-renderergl/lib/passes/RenderPassBase\");\n\n/**\n * @class away.pool.SkyboxRenderable\n */\nclass SkyboxRenderable extends RenderableBase\n{\n\tprivate _vertexArray:Array<number>;\n\n\t/**\n\t *\n\t */\n\tpublic static id:string = \"skybox\";\n\n\tpublic static vertexAttributesOffset:number = 1;\n\n\t/**\n\t *\n\t */\n\tprivate static _geometry:TriangleSubGeometry;\n\n\t/**\n\t * //TODO\n\t *\n\t * @param pool\n\t * @param skybox\n\t */\n\tconstructor(pool:RenderablePoolBase, skybox:Skybox, stage:Stage)\n\t{\n\t\tsuper(pool, skybox, skybox, skybox, stage);\n\n\t\tthis._vertexArray = new Array<number>(0, 0, 0, 0, 1, 1, 1, 1);\n\t}\n\n\t/**\n\t * //TODO\n\t *\n\t * @returns {away.base.TriangleSubGeometry}\n\t * @private\n\t */\n\tpublic _pGetSubGeometry():TriangleSubGeometry\n\t{\n\t\tvar geometry:TriangleSubGeometry = SkyboxRenderable._geometry;\n\n\t\tif (!geometry) {\n\t\t\tgeometry = SkyboxRenderable._geometry = new TriangleSubGeometry(true);\n\t\t\tgeometry.autoDeriveNormals = false;\n\t\t\tgeometry.autoDeriveTangents = false;\n\t\t\tgeometry.updateIndices(Array<number>(0, 1, 2, 2, 3, 0, 6, 5, 4, 4, 7, 6, 2, 6, 7, 7, 3, 2, 4, 5, 1, 1, 0, 4, 4, 0, 3, 3, 7, 4, 2, 1, 5, 5, 6, 2));\n\t\t\tgeometry.updatePositions(Array<number>(-1, 1, -1, 1, 1, -1, 1, 1, 1, -1, 1, 1, -1, -1, -1, 1, -1, -1, 1, -1, 1, -1, -1, 1));\n\t\t}\n\n\t\tthis._pVertexDataDirty[TriangleSubGeometry.POSITION_DATA] = true;\n\n\t\treturn geometry;\n\t}\n\n\tpublic static _iIncludeDependencies(shaderObject:ShaderObjectBase)\n\t{\n\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic static _iGetVertexCode(shaderObject:ShaderObjectBase, registerCache:ShaderRegisterCache, sharedRegisters:ShaderRegisterData):string\n\t{\n\t\treturn \"mul vt0, va0, vc5\\n\" +\n\t\t\t\"add vt0, vt0, vc4\\n\" +\n\t\t\t\"m44 op, vt0, vc0\\n\" +\n\t\t\t\"mov v0, va0\\n\";\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iRender(pass:RenderPassBase, camera:Camera, viewProjection:Matrix3D)\n\t{\n\t\tsuper._iRender(pass, camera, viewProjection);\n\n\t\tvar context:IContextGL = this._stage.context;\n\t\tvar pos:Vector3D = camera.scenePosition;\n\t\tthis._vertexArray[0] = pos.x;\n\t\tthis._vertexArray[1] = pos.y;\n\t\tthis._vertexArray[2] = pos.z;\n\t\tthis._vertexArray[4] = this._vertexArray[5] = this._vertexArray[6] = camera.projection.far/Math.sqrt(3);\n\t\tcontext.setProgramConstantsFromMatrix(ContextGLProgramType.VERTEX, 0, viewProjection, true);\n\t\tcontext.setProgramConstantsFromArray(ContextGLProgramType.VERTEX, 4, this._vertexArray, 2);\n\n\t\tthis._stage.activateBuffer(0, this.getVertexData(TriangleSubGeometry.POSITION_DATA), this.getVertexOffset(TriangleSubGeometry.POSITION_DATA), TriangleSubGeometry.POSITION_FORMAT);\n\t\tcontext.drawTriangles(this._stage.getIndexBuffer(this.getIndexData()), 0, this.numTriangles);\n\t}\n}\n\nexport = SkyboxRenderable;","import Matrix3D\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3D\");\nimport Matrix3DUtils\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3DUtils\");\n\nimport IRenderableOwner\t\t\t\t= require(\"awayjs-display/lib/base/IRenderableOwner\");\nimport TriangleSubMesh\t\t\t\t= require(\"awayjs-display/lib/base/TriangleSubMesh\");\nimport TriangleSubGeometry\t\t\t= require(\"awayjs-display/lib/base/TriangleSubGeometry\");\nimport Camera\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Camera\");\n\nimport ContextGLVertexBufferFormat\t= require(\"awayjs-stagegl/lib/base/ContextGLVertexBufferFormat\");\nimport IContextGL\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/IContextGL\");\nimport Stage\t\t\t\t\t\t= require(\"awayjs-stagegl/lib/base/Stage\");\nimport ContextGLProgramType\t\t\t= require(\"awayjs-stagegl/lib/base/ContextGLProgramType\");\n\nimport ShaderObjectBase\t\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderObjectBase\");\nimport ShaderRegisterCache\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterCache\");\nimport ShaderRegisterData\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterData\");\nimport ShaderRegisterElement\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\nimport RenderableBase\t\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderableBase\");\nimport RenderablePoolBase\t\t\t= require(\"awayjs-renderergl/lib/pool/RenderablePoolBase\");\nimport RenderPassBase\t\t\t\t= require(\"awayjs-renderergl/lib/passes/RenderPassBase\");\n\n/**\n * @class away.pool.TriangleSubMeshRenderable\n */\nclass TriangleSubMeshRenderable extends RenderableBase\n{\n\t/**\n\t *\n\t */\n\tpublic static id:string = \"trianglesubmesh\";\n\n\tpublic static vertexAttributesOffset:number = 1;\n\n\t/**\n\t *\n\t */\n\tpublic subMesh:TriangleSubMesh;\n\n\n\t/**\n\t * //TODO\n\t *\n\t * @param pool\n\t * @param subMesh\n\t * @param level\n\t * @param indexOffset\n\t */\n\tconstructor(pool:RenderablePoolBase, subMesh:TriangleSubMesh, stage:Stage, level:number = 0, indexOffset:number = 0)\n\t{\n\t\tsuper(pool, subMesh.parentMesh, subMesh, subMesh.material, stage, level, indexOffset);\n\n\t\tthis.subMesh = subMesh;\n\t}\n\n\t/**\n\t *\n\t * @returns {SubGeometryBase}\n\t * @protected\n\t */\n\tpublic _pGetSubGeometry():TriangleSubGeometry\n\t{\n\t\tvar subGeometry:TriangleSubGeometry;\n\n\t\tif (this.subMesh.animator)\n\t\t\tsubGeometry = <TriangleSubGeometry> this.subMesh.animator.getRenderableSubGeometry(this, this.subMesh.subGeometry);\n\t\telse\n\t\t\tsubGeometry = this.subMesh.subGeometry;\n\n\t\tthis._pVertexDataDirty[TriangleSubGeometry.POSITION_DATA] = true;\n\n\t\tif (subGeometry.vertexNormals)\n\t\t\tthis._pVertexDataDirty[TriangleSubGeometry.NORMAL_DATA] = true;\n\n\t\tif (subGeometry.vertexTangents)\n\t\t\tthis._pVertexDataDirty[TriangleSubGeometry.TANGENT_DATA] = true;\n\n\t\tif (subGeometry.uvs)\n\t\t\tthis._pVertexDataDirty[TriangleSubGeometry.UV_DATA] = true;\n\n\t\tif (subGeometry.secondaryUVs)\n\t\t\tthis._pVertexDataDirty[TriangleSubGeometry.SECONDARY_UV_DATA] = true;\n\n\t\tif (subGeometry.jointIndices)\n\t\t\tthis._pVertexDataDirty[TriangleSubGeometry.JOINT_INDEX_DATA] = true;\n\n\t\tif (subGeometry.jointWeights)\n\t\t\tthis._pVertexDataDirty[TriangleSubGeometry.JOINT_WEIGHT_DATA] = true;\n\n\t\tswitch(subGeometry.jointsPerVertex) {\n\t\t\tcase 1:\n\t\t\t\tthis.JOINT_INDEX_FORMAT = this.JOINT_WEIGHT_FORMAT = ContextGLVertexBufferFormat.FLOAT_1;\n\t\t\t\tbreak;\n\t\t\tcase 2:\n\t\t\t\tthis.JOINT_INDEX_FORMAT = this.JOINT_WEIGHT_FORMAT = ContextGLVertexBufferFormat.FLOAT_2;\n\t\t\t\tbreak;\n\t\t\tcase 3:\n\t\t\t\tthis.JOINT_INDEX_FORMAT = this.JOINT_WEIGHT_FORMAT = ContextGLVertexBufferFormat.FLOAT_3;\n\t\t\t\tbreak;\n\t\t\tcase 4:\n\t\t\t\tthis.JOINT_INDEX_FORMAT = this.JOINT_WEIGHT_FORMAT = ContextGLVertexBufferFormat.FLOAT_4;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t}\n\n\t\treturn subGeometry;\n\t}\n\n\n\tpublic static _iIncludeDependencies(shaderObject:ShaderObjectBase)\n\t{\n\n\t}\n\n\tpublic static _iGetVertexCode(shaderObject:ShaderObjectBase, registerCache:ShaderRegisterCache, sharedRegisters:ShaderRegisterData):string\n\t{\n\t\tvar code:string = \"\";\n\n\t\t//get the projection coordinates\n\t\tvar position:ShaderRegisterElement = (shaderObject.globalPosDependencies > 0)? sharedRegisters.globalPositionVertex : sharedRegisters.localPosition;\n\n\t\t//reserving vertex constants for projection matrix\n\t\tvar viewMatrixReg:ShaderRegisterElement = registerCache.getFreeVertexConstant();\n\t\tregisterCache.getFreeVertexConstant();\n\t\tregisterCache.getFreeVertexConstant();\n\t\tregisterCache.getFreeVertexConstant();\n\t\tshaderObject.viewMatrixIndex = viewMatrixReg.index*4;\n\n\t\tif (shaderObject.projectionDependencies > 0) {\n\t\t\tsharedRegisters.projectionFragment = registerCache.getFreeVarying();\n\t\t\tvar temp:ShaderRegisterElement = registerCache.getFreeVertexVectorTemp();\n\t\t\tcode += \"m44 \" + temp + \", \" + position + \", \" + viewMatrixReg + \"\\n\" +\n\t\t\t\"mov \" + sharedRegisters.projectionFragment + \", \" + temp + \"\\n\" +\n\t\t\t\"mov op, \" + temp + \"\\n\";\n\t\t} else {\n\t\t\tcode += \"m44 op, \" + position + \", \" + viewMatrixReg + \"\\n\";\n\t\t}\n\n\t\treturn code;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tpublic _iRender(pass:RenderPassBase, camera:Camera, viewProjection:Matrix3D)\n\t{\n\t\tsuper._iRender(pass, camera, viewProjection);\n\n\t\tvar shader:ShaderObjectBase = pass.shader;\n\n\t\tif (shader.sceneMatrixIndex >= 0) {\n\t\t\tthis.sourceEntity.getRenderSceneTransform(camera).copyRawDataTo(shader.vertexConstantData, shader.sceneMatrixIndex, true);\n\t\t\tviewProjection.copyRawDataTo(shader.vertexConstantData, shader.viewMatrixIndex, true);\n\t\t} else {\n\t\t\tvar matrix3D:Matrix3D = Matrix3DUtils.CALCULATION_MATRIX;\n\n\t\t\tmatrix3D.copyFrom(this.sourceEntity.getRenderSceneTransform(camera));\n\t\t\tmatrix3D.append(viewProjection);\n\n\t\t\tmatrix3D.copyRawDataTo(shader.vertexConstantData, shader.viewMatrixIndex, true);\n\t\t}\n\n\t\tvar context:IContextGL = this._stage.context;\n\t\tcontext.setProgramConstantsFromArray(ContextGLProgramType.VERTEX, 0, shader.vertexConstantData, shader.numUsedVertexConstants);\n\t\tcontext.setProgramConstantsFromArray(ContextGLProgramType.FRAGMENT, 0, shader.fragmentConstantData, shader.numUsedFragmentConstants);\n\n\t\tthis._stage.activateBuffer(0, this.getVertexData(TriangleSubGeometry.POSITION_DATA), this.getVertexOffset(TriangleSubGeometry.POSITION_DATA), TriangleSubGeometry.POSITION_FORMAT);\n\t\tthis._stage.context.drawTriangles(this._stage.getIndexBuffer(this.getIndexData()), 0, this.numTriangles);\n\t}\n\n\t/**\n\t * //TODO\n\t *\n\t * @param pool\n\t * @param renderableOwner\n\t * @param level\n\t * @param indexOffset\n\t * @returns {away.pool.TriangleSubMeshRenderable}\n\t * @protected\n\t */\n\tpublic _pGetOverflowRenderable(indexOffset:number):RenderableBase\n\t{\n\t\treturn new TriangleSubMeshRenderable(this._pool, <TriangleSubMesh> this.renderableOwner, this._stage, this._level + 1, indexOffset);\n\t}\n}\n\nexport = TriangleSubMeshRenderable;","import Matrix3DUtils\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3DUtils\");\n\nimport DisplayObjectContainer\t\t\t= require(\"awayjs-display/lib/containers/DisplayObjectContainer\");\nimport Geometry\t\t\t\t\t\t\t= require(\"awayjs-display/lib/base/Geometry\");\nimport TriangleSubGeometry\t\t\t\t= require(\"awayjs-display/lib/base/TriangleSubGeometry\");\nimport Mesh\t\t\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Mesh\");\nimport MaterialBase\t\t\t\t\t\t= require(\"awayjs-display/lib/materials/MaterialBase\");\n\n/**\n *  Class Merge merges two or more static meshes into one.<code>Merge</code>\n */\nclass Merge\n{\n\n\t//private const LIMIT:uint = 196605;\n\tprivate _objectSpace:boolean;\n\tprivate _keepMaterial:boolean;\n\tprivate _disposeSources:boolean;\n\tprivate _geomVOs:Array<GeometryVO>;\n\tprivate _toDispose:Array<Mesh>;\n\n\t/**\n\t * @param    keepMaterial    [optional]    Determines if the merged object uses the recevier mesh material information or keeps its source material(s). Defaults to false.\n\t * If false and receiver object has multiple materials, the last material found in receiver submeshes is applied to the merged submesh(es).\n\t * @param    disposeSources  [optional]    Determines if the mesh and geometry source(s) used for the merging are disposed. Defaults to false.\n\t * If true, only receiver geometry and resulting mesh are kept in  memory.\n\t * @param    objectSpace     [optional]    Determines if source mesh(es) is/are merged using objectSpace or worldspace. Defaults to false.\n\t */\n\tconstructor(keepMaterial:boolean = false, disposeSources:boolean = false, objectSpace:boolean = false)\n\t{\n\t\tthis._keepMaterial = keepMaterial;\n\t\tthis._disposeSources = disposeSources;\n\t\tthis._objectSpace = objectSpace;\n\t}\n\n\t/**\n\t * Determines if the mesh and geometry source(s) used for the merging are disposed. Defaults to false.\n\t */\n\tpublic set disposeSources(b:boolean)\n\t{\n\t\tthis._disposeSources = b;\n\t}\n\n\tpublic get disposeSources():boolean\n\t{\n\t\treturn this._disposeSources;\n\t}\n\n\t/**\n\t * Determines if the material source(s) used for the merging are disposed. Defaults to false.\n\t */\n\tpublic set keepMaterial(b:boolean)\n\t{\n\t\tthis._keepMaterial = b;\n\t}\n\n\tpublic get keepMaterial():boolean\n\t{\n\t\treturn this._keepMaterial;\n\t}\n\n\t/**\n\t * Determines if source mesh(es) is/are merged using objectSpace or worldspace. Defaults to false.\n\t */\n\tpublic set objectSpace(b:boolean)\n\t{\n\t\tthis._objectSpace = b;\n\t}\n\n\tpublic get objectSpace():boolean\n\t{\n\t\treturn this._objectSpace;\n\t}\n\n\t/**\n\t * Merges all the children of a container into a single Mesh. If no Mesh object is found, method returns the receiver without modification.\n\t *\n\t * @param    receiver           The Mesh to receive the merged contents of the container.\n\t * @param    objectContainer    The DisplayObjectContainer holding the meshes to be mergd.\n\t *\n\t * @return The merged Mesh instance.\n\t */\n\tpublic applyToContainer(receiver:Mesh, objectContainer:DisplayObjectContainer)\n\t{\n\t\tthis.reset();\n\n\t\t//collect container meshes\n\t\tthis.parseContainer(receiver, objectContainer);\n\n\t\t//collect receiver\n\t\tthis.collect(receiver, false);\n\n\t\t//merge to receiver\n\t\tthis.merge(receiver, this._disposeSources);\n\t}\n\n\t/**\n\t * Merges all the meshes found in the Array&lt;Mesh&gt; into a single Mesh.\n\t *\n\t * @param    receiver    The Mesh to receive the merged contents of the meshes.\n\t * @param    meshes      A series of Meshes to be merged with the reciever mesh.\n\t */\n\tpublic applyToMeshes(receiver:Mesh, meshes:Array<Mesh>)\n\t{\n\t\tthis.reset();\n\n\t\tif (!meshes.length)\n\t\t\treturn;\n\n\t\t//collect meshes in vector\n\t\tfor (var i:number /*uint*/ = 0; i < meshes.length; i++)\n\t\t\tif (meshes[i] != receiver)\n\t\t\t\tthis.collect(meshes[i], this._disposeSources);\n\n\t\t//collect receiver\n\t\tthis.collect(receiver, false);\n\n\t\t//merge to receiver\n\t\tthis.merge(receiver, this._disposeSources);\n\t}\n\n\t/**\n\t *  Merges 2 meshes into one. It is recommand to use apply when 2 meshes are to be merged. If more need to be merged, use either applyToMeshes or applyToContainer methods.\n\t *\n\t * @param    receiver    The Mesh to receive the merged contents of both meshes.\n\t * @param    mesh        The Mesh to be merged with the receiver mesh\n\t */\n\tpublic apply(receiver:Mesh, mesh:Mesh)\n\t{\n\t\tthis.reset();\n\n\t\t//collect mesh\n\t\tthis.collect(mesh, this._disposeSources);\n\n\t\t//collect receiver\n\t\tthis.collect(receiver, false);\n\n\t\t//merge to receiver\n\t\tthis.merge(receiver, this._disposeSources);\n\t}\n\n\tprivate reset()\n\t{\n\t\tthis._toDispose  = new Array<Mesh>();\n\t\tthis._geomVOs = new Array<GeometryVO>();\n\t}\n\n\tprivate merge(destMesh:Mesh, dispose:boolean)\n\t{\n\t\tvar i:number /*uint*/;\n\t\tvar subIdx:number /*uint*/;\n\t\tvar oldGeom:Geometry;\n\t\tvar destGeom:Geometry;\n\t\tvar useSubMaterials:boolean;\n\n\t\toldGeom = destMesh.geometry;\n\t\tdestGeom = destMesh.geometry = new Geometry();\n\t\tsubIdx = destMesh.subMeshes.length;\n\n\t\t// Only apply materials directly to sub-meshes if necessary,\n\t\t// i.e. if there is more than one material available.\n\t\tuseSubMaterials = (this._geomVOs.length > 1);\n\n\t\tfor (i = 0; i < this._geomVOs.length; i++) {\n\t\t\tvar s:number /*uint*/;\n\t\t\tvar data:GeometryVO;\n\t\t\tvar sub:TriangleSubGeometry = new TriangleSubGeometry(true);\n\t\t\tsub.autoDeriveNormals = false;\n\t\t\tsub.autoDeriveTangents = false;\n\n\t\t\tdata = this._geomVOs[i];\n\t\t\tsub.updateIndices(data.indices);\n\t\t\tsub.updatePositions(data.vertices);\n\t\t\tsub.updateVertexNormals(data.normals);\n\t\t\tsub.updateVertexTangents(data.tangents);\n\t\t\tsub.updateUVs(data.uvs);\n\n\t\t\tdestGeom.addSubGeometry(sub);\n\n\t\t\tif (this._keepMaterial && useSubMaterials)\n\t\t\t\tdestMesh.subMeshes[subIdx].material = data.material;\n\t\t}\n\n\t\tif (this._keepMaterial && !useSubMaterials && this._geomVOs.length)\n\t\t\tdestMesh.material = this._geomVOs[0].material;\n\n\t\tif (dispose) {\n\t\t\tvar m:Mesh;\n\t\t\tvar len:number = this._toDispose.length;\n\t\t\tfor (var i:number; i < len; i++) {\n\t\t\t\tm = this._toDispose[i];\n\t\t\t\tm.geometry.dispose();\n\t\t\t\tm.dispose();\n\t\t\t}\n\n\t\t\t//dispose of the original receiver geometry\n\t\t\toldGeom.dispose();\n\t\t}\n\n\t\tthis._toDispose = null;\n\t}\n\n\tprivate collect(mesh:Mesh, dispose:boolean)\n\t{\n\t\tif (mesh.geometry) {\n\t\t\tvar subIdx:number /*uint*/;\n\t\t\tvar subGeometries:Array<TriangleSubGeometry> = <Array<TriangleSubGeometry>> mesh.geometry.subGeometries;\n\t\t\tvar calc:number /*uint*/;\n\t\t\tfor (subIdx = 0; subIdx < subGeometries.length; subIdx++) {\n\t\t\t\tvar i:number /*uint*/;\n\t\t\t\tvar len:number /*uint*/;\n\t\t\t\tvar iIdx:number /*uint*/, vIdx:number /*uint*/, nIdx:number /*uint*/, tIdx:number /*uint*/, uIdx:number /*uint*/;\n\t\t\t\tvar indexOffset:number /*uint*/;\n\t\t\t\tvar subGeom:TriangleSubGeometry;\n\t\t\t\tvar vo:GeometryVO;\n\t\t\t\tvar vertices:Array<number>;\n\t\t\t\tvar normals:Array<number>;\n\t\t\t\tvar tangents:Array<number>;\n\t\t\t\tvar pd:Array<number>, nd:Array<number>, td:Array<number>, ud:Array<number>;\n\n\t\t\t\tsubGeom = subGeometries[subIdx];\n\t\t\t\tpd = subGeom.positions;\n\t\t\t\tnd = subGeom.vertexNormals;\n\t\t\t\ttd = subGeom.vertexTangents;\n\t\t\t\tud = subGeom.uvs;\n\n\t\t\t\t// Get (or create) a VO for this material\n\t\t\t\tvo = this.getSubGeomData(mesh.subMeshes[subIdx].material || mesh.material);\n\n\t\t\t\t// Vertices and normals are copied to temporary vectors, to be transformed\n\t\t\t\t// before concatenated onto those of the data. This is unnecessary if no\n\t\t\t\t// transformation will be performed, i.e. for object space merging.\n\t\t\t\tvertices = (this._objectSpace)? vo.vertices : new Array<number>();\n\t\t\t\tnormals = (this._objectSpace)? vo.normals : new Array<number>();\n\t\t\t\ttangents = (this._objectSpace)? vo.tangents : new Array<number>();\n\n\t\t\t\t// Copy over vertex attributes\n\t\t\t\tvIdx = vertices.length;\n\t\t\t\tnIdx = normals.length;\n\t\t\t\ttIdx = tangents.length;\n\t\t\t\tuIdx = vo.uvs.length;\n\t\t\t\tlen = subGeom.numVertices;\n\t\t\t\tfor (i = 0; i < len; i++) {\n\t\t\t\t\tcalc = i*3;\n\n\t\t\t\t\t// Position\n\t\t\t\t\tvertices[vIdx++] = pd[calc];\n\t\t\t\t\tvertices[vIdx++] = pd[calc + 1];\n\t\t\t\t\tvertices[vIdx++] = pd[calc + 2];\n\n\t\t\t\t\t// Normal\n\t\t\t\t\tnormals[nIdx++] = nd[calc];\n\t\t\t\t\tnormals[nIdx++] = nd[calc + 1];\n\t\t\t\t\tnormals[nIdx++] = nd[calc + 2];\n\n\t\t\t\t\t// Tangent\n\t\t\t\t\ttangents[tIdx++] = td[calc];\n\t\t\t\t\ttangents[tIdx++] = td[calc + 1];\n\t\t\t\t\ttangents[tIdx++] = td[calc + 2];\n\n\t\t\t\t\t// UV\n\t\t\t\t\tvo.uvs[uIdx++] = ud[i*2];\n\t\t\t\t\tvo.uvs[uIdx++] = ud[i*2 + 1];\n\t\t\t\t}\n\n\t\t\t\t// Copy over triangle indices\n\t\t\t\tindexOffset = (!this._objectSpace)? vo.vertices.length/3 :0;\n\t\t\t\tiIdx = vo.indices.length;\n\t\t\t\tlen = subGeom.numTriangles;\n\t\t\t\tfor (i = 0; i < len; i++) {\n\t\t\t\t\tcalc = i*3;\n\t\t\t\t\tvo.indices[iIdx++] = subGeom.indices[calc] + indexOffset;\n\t\t\t\t\tvo.indices[iIdx++] = subGeom.indices[calc + 1] + indexOffset;\n\t\t\t\t\tvo.indices[iIdx++] = subGeom.indices[calc + 2] + indexOffset;\n\t\t\t\t}\n\n\t\t\t\tif (!this._objectSpace) {\n\t\t\t\t\tmesh.sceneTransform.transformVectors(vertices, vertices);\n\t\t\t\t\tMatrix3DUtils.deltaTransformVectors(mesh.sceneTransform, normals, normals);\n\t\t\t\t\tMatrix3DUtils.deltaTransformVectors(mesh.sceneTransform, tangents, tangents);\n\n\t\t\t\t\t// Copy vertex data from temporary (transformed) vectors\n\t\t\t\t\tvIdx = vo.vertices.length;\n\t\t\t\t\tnIdx = vo.normals.length;\n\t\t\t\t\ttIdx = vo.tangents.length;\n\t\t\t\t\tlen = vertices.length;\n\t\t\t\t\tfor (i = 0; i < len; i++) {\n\t\t\t\t\t\tvo.vertices[vIdx++] = vertices[i];\n\t\t\t\t\t\tvo.normals[nIdx++] = normals[i];\n\t\t\t\t\t\tvo.tangents[tIdx++] = tangents[i];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (dispose)\n\t\t\t\tthis._toDispose.push(mesh);\n\t\t}\n\t}\n\n\tprivate getSubGeomData(material:MaterialBase):GeometryVO\n\t{\n\t\tvar data:GeometryVO;\n\n\t\tif (this._keepMaterial) {\n\t\t\tvar i:number /*uint*/;\n\t\t\tvar len:number /*uint*/;\n\n\t\t\tlen = this._geomVOs.length;\n\t\t\tfor (i = 0; i < len; i++) {\n\t\t\t\tif (this._geomVOs[i].material == material) {\n\t\t\t\t\tdata = this._geomVOs[i];\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t} else if (this._geomVOs.length) {\n\t\t\t// If materials are not to be kept, all data can be\n\t\t\t// put into a single VO, so return that one.\n\t\t\tdata = this._geomVOs[0];\n\t\t}\n\n\t\t// No data (for this material) found, create new.\n\t\tif (!data) {\n\t\t\tdata = new GeometryVO();\n\t\t\tdata.vertices = new Array<number>();\n\t\t\tdata.normals = new Array<number>();\n\t\t\tdata.tangents = new Array<number>();\n\t\t\tdata.uvs = new Array<number>();\n\t\t\tdata.indices = new Array<number /*uint*/>();\n\t\t\tdata.material = material;\n\n\t\t\tthis._geomVOs.push(data);\n\t\t}\n\n\t\treturn data;\n\t}\n\n\tprivate parseContainer(receiver:Mesh, object:DisplayObjectContainer)\n\t{\n\t\tvar child:DisplayObjectContainer;\n\t\tvar i:number /*uint*/;\n\n\t\tif (object instanceof Mesh && object != (<DisplayObjectContainer> receiver))\n\t\t\tthis.collect(<Mesh> object, this._disposeSources);\n\n\t\tfor (i = 0; i < object.numChildren; ++i) {\n\t\t\tchild = <DisplayObjectContainer> object.getChildAt(i);\n\t\t\tthis.parseContainer(receiver, child);\n\t\t}\n\t}\n}\n\nexport = Merge;\n\nclass GeometryVO\n{\n\tpublic uvs:Array<number>;\n\tpublic vertices:Array<number>;\n\tpublic normals:Array<number>;\n\tpublic tangents:Array<number>;\n\tpublic indices:Array<number /*uint*/>;\n\tpublic material:MaterialBase;\n}\n","import Matrix\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix\");\nimport Matrix3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3D\");\n\n/**\n * ...\n */\nclass ParticleGeometryTransform\n{\n\tprivate _defaultVertexTransform:Matrix3D;\n\tprivate _defaultInvVertexTransform:Matrix3D;\n\tprivate _defaultUVTransform:Matrix;\n\n\tpublic set vertexTransform(value:Matrix3D)\n\t{\n\t\tthis._defaultVertexTransform = value;\n\t\tthis._defaultInvVertexTransform = value.clone();\n\t\tthis._defaultInvVertexTransform.invert();\n\t\tthis._defaultInvVertexTransform.transpose();\n\t}\n\n\tpublic set UVTransform(value:Matrix)\n\t{\n\t\tthis._defaultUVTransform = value;\n\t}\n\n\tpublic get UVTransform():Matrix\n\t{\n\t\treturn this._defaultUVTransform;\n\t}\n\n\tpublic get vertexTransform():Matrix3D\n\t{\n\t\treturn this._defaultVertexTransform;\n\t}\n\n\tpublic get invVertexTransform():Matrix3D\n\t{\n\t\treturn this._defaultInvVertexTransform;\n\t}\n}\n\nexport = ParticleGeometryTransform;","import Matrix\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix\");\nimport Matrix3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3D\");\nimport Point\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Point\");\nimport Vector3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Vector3D\");\n\nimport Geometry\t\t\t\t\t\t\t= require(\"awayjs-display/lib/base/Geometry\");\nimport TriangleSubGeometry\t\t\t\t= require(\"awayjs-display/lib/base/TriangleSubGeometry\");\nimport Mesh\t\t\t\t\t\t\t\t= require(\"awayjs-display/lib/entities/Mesh\");\nimport MaterialBase\t\t\t\t\t\t= require(\"awayjs-display/lib/materials/MaterialBase\");\n\nimport ParticleData\t\t\t\t\t\t= require(\"awayjs-renderergl/lib/animators/data/ParticleData\");\nimport ParticleGeometry\t\t\t\t\t= require(\"awayjs-renderergl/lib/base/ParticleGeometry\");\nimport ParticleGeometryTransform\t\t= require(\"awayjs-renderergl/lib/tools/data/ParticleGeometryTransform\");\n\n/**\n * ...\n */\nclass ParticleGeometryHelper\n{\n\tpublic static MAX_VERTEX:number /*int*/ = 65535;\n\n\tpublic static generateGeometry(geometries:Array<Geometry>, transforms:Array<ParticleGeometryTransform> = null):ParticleGeometry\n\t{\n\t\tvar indicesVector:Array<Array<number>> /*uint*/ = new Array<Array<number>>() /*uint*/;\n\t\tvar positionsVector:Array<Array<number>> = new Array<Array<number>>();\n\t\tvar normalsVector:Array<Array<number>> = new Array<Array<number>>();\n\t\tvar tangentsVector:Array<Array<number>> = new Array<Array<number>>();\n\t\tvar uvsVector:Array<Array<number>> = new Array<Array<number>>();\n\t\tvar vertexCounters:Array<number> /*uint*/ = new Array<number>() /*uint*/;\n\t\tvar particles:Array<ParticleData> = new Array<ParticleData>();\n\t\tvar subGeometries:Array<TriangleSubGeometry> = new Array<TriangleSubGeometry>();\n\t\tvar numParticles:number /*uint*/ = geometries.length;\n\n\t\tvar sourceSubGeometries:Array<TriangleSubGeometry>;\n\t\tvar sourceSubGeometry:TriangleSubGeometry;\n\t\tvar numSubGeometries:number /*uint*/;\n\t\tvar indices:Array<number> /*uint*/;\n\t\tvar positions:Array<number>;\n\t\tvar normals:Array<number>;\n\t\tvar tangents:Array<number>;\n\t\tvar uvs:Array<number>;\n\t\tvar vertexCounter:number /*uint*/;\n\t\tvar subGeometry:TriangleSubGeometry;\n\t\tvar i:number /*int*/;\n\t\tvar j:number /*int*/;\n\t\tvar sub2SubMap:Array<number> /*int*/ = new Array<number>() /*int*/;\n\n\t\tvar tempVertex:Vector3D = new Vector3D;\n\t\tvar tempNormal:Vector3D = new Vector3D;\n\t\tvar tempTangents:Vector3D = new Vector3D;\n\t\tvar tempUV:Point = new Point;\n\n\t\tfor (i = 0; i < numParticles; i++) {\n\t\t\tsourceSubGeometries = <Array<TriangleSubGeometry>> geometries[i].subGeometries;\n\t\t\tnumSubGeometries = sourceSubGeometries.length;\n\t\t\tfor (var srcIndex:number /*int*/ = 0; srcIndex < numSubGeometries; srcIndex++) {\n\t\t\t\t//create a different particle subgeometry group for each source subgeometry in a particle.\n\t\t\t\tif (sub2SubMap.length <= srcIndex) {\n\t\t\t\t\tsub2SubMap.push(subGeometries.length);\n\t\t\t\t\tindicesVector.push(new Array<number>() /*uint*/);\n\t\t\t\t\tpositionsVector.push(new Array<number>());\n\t\t\t\t\tnormalsVector.push(new Array<number>());\n\t\t\t\t\ttangentsVector.push(new Array<number>());\n\t\t\t\t\tuvsVector.push(new Array<number>());\n\t\t\t\t\tsubGeometries.push(new TriangleSubGeometry(true));\n\t\t\t\t\tvertexCounters.push(0);\n\t\t\t\t}\n\n\t\t\t\tsourceSubGeometry = sourceSubGeometries[srcIndex];\n\n\t\t\t\t//add a new particle subgeometry if this source subgeometry will take us over the maxvertex limit\n\t\t\t\tif (sourceSubGeometry.numVertices + vertexCounters[sub2SubMap[srcIndex]] > ParticleGeometryHelper.MAX_VERTEX) {\n\t\t\t\t\t//update submap and add new subgeom vectors\n\t\t\t\t\tsub2SubMap[srcIndex] = subGeometries.length;\n\t\t\t\t\tindicesVector.push(new Array<number>() /*uint*/);\n\t\t\t\t\tpositionsVector.push(new Array<number>());\n\t\t\t\t\tnormalsVector.push(new Array<number>());\n\t\t\t\t\ttangentsVector.push(new Array<number>());\n\t\t\t\t\tuvsVector.push(new Array<number>());\n\t\t\t\t\tsubGeometries.push(new TriangleSubGeometry(true));\n\t\t\t\t\tvertexCounters.push(0);\n\t\t\t\t}\n\n\t\t\t\tj = sub2SubMap[srcIndex];\n\n\t\t\t\t//select the correct vector\n\t\t\t\tindices = indicesVector[j];\n\t\t\t\tpositions = positionsVector[j];\n\t\t\t\tnormals = normalsVector[j];\n\t\t\t\ttangents = tangentsVector[j];\n\t\t\t\tuvs = uvsVector[j];\n\t\t\t\tvertexCounter = vertexCounters[j];\n\t\t\t\tsubGeometry = subGeometries[j];\n\n\t\t\t\tvar particleData:ParticleData = new ParticleData();\n\t\t\t\tparticleData.numVertices = sourceSubGeometry.numVertices;\n\t\t\t\tparticleData.startVertexIndex = vertexCounter;\n\t\t\t\tparticleData.particleIndex = i;\n\t\t\t\tparticleData.subGeometry = subGeometry;\n\t\t\t\tparticles.push(particleData);\n\n\t\t\t\tvertexCounters[j] += sourceSubGeometry.numVertices;\n\n\t\t\t\tvar k:number /*int*/;\n\t\t\t\tvar tempLen:number /*int*/;\n\t\t\t\tvar compact:TriangleSubGeometry = sourceSubGeometry;\n\t\t\t\tvar product:number /*uint*/;\n\t\t\t\tvar sourcePositions:Array<number>;\n\t\t\t\tvar sourceNormals:Array<number>;\n\t\t\t\tvar sourceTangents:Array<number>;\n\t\t\t\tvar sourceUVs:Array<number>;\n\n\t\t\t\tif (compact) {\n\t\t\t\t\ttempLen = compact.numVertices;\n\t\t\t\t\tcompact.numTriangles;\n\t\t\t\t\tsourcePositions = compact.positions;\n\t\t\t\t\tsourceNormals = compact.vertexNormals;\n\t\t\t\t\tsourceTangents = compact.vertexTangents;\n\t\t\t\t\tsourceUVs = compact.uvs;\n\n\t\t\t\t\tif (transforms) {\n\t\t\t\t\t\tvar particleGeometryTransform:ParticleGeometryTransform = transforms[i];\n\t\t\t\t\t\tvar vertexTransform:Matrix3D = particleGeometryTransform.vertexTransform;\n\t\t\t\t\t\tvar invVertexTransform:Matrix3D = particleGeometryTransform.invVertexTransform;\n\t\t\t\t\t\tvar UVTransform:Matrix = particleGeometryTransform.UVTransform;\n\n\t\t\t\t\t\tfor (k = 0; k < tempLen; k++) {\n\t\t\t\t\t\t\t/*\n\t\t\t\t\t\t\t * 0 - 2: vertex position X, Y, Z\n\t\t\t\t\t\t\t * 3 - 5: normal X, Y, Z\n\t\t\t\t\t\t\t * 6 - 8: tangent X, Y, Z\n\t\t\t\t\t\t\t * 9 - 10: U V\n\t\t\t\t\t\t\t * 11 - 12: Secondary U V*/\n\t\t\t\t\t\t\tproduct = k*3;\n\t\t\t\t\t\t\ttempVertex.x = sourcePositions[product];\n\t\t\t\t\t\t\ttempVertex.y = sourcePositions[product + 1];\n\t\t\t\t\t\t\ttempVertex.z = sourcePositions[product + 2];\n\t\t\t\t\t\t\ttempNormal.x = sourceNormals[product];\n\t\t\t\t\t\t\ttempNormal.y = sourceNormals[product + 1];\n\t\t\t\t\t\t\ttempNormal.z = sourceNormals[product + 2];\n\t\t\t\t\t\t\ttempTangents.x = sourceTangents[product];\n\t\t\t\t\t\t\ttempTangents.y = sourceTangents[product + 1];\n\t\t\t\t\t\t\ttempTangents.z = sourceTangents[product + 2];\n\t\t\t\t\t\t\ttempUV.x = sourceUVs[k*2];\n\t\t\t\t\t\t\ttempUV.y = sourceUVs[k*2 + 1];\n\t\t\t\t\t\t\tif (vertexTransform) {\n\t\t\t\t\t\t\t\ttempVertex = vertexTransform.transformVector(tempVertex);\n\t\t\t\t\t\t\t\ttempNormal = invVertexTransform.deltaTransformVector(tempNormal);\n\t\t\t\t\t\t\t\ttempTangents = invVertexTransform.deltaTransformVector(tempNormal);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (UVTransform)\n\t\t\t\t\t\t\t\ttempUV = UVTransform.transformPoint(tempUV);\n\t\t\t\t\t\t\t//this is faster than that only push one data\n\t\t\t\t\t\t\tsourcePositions.push(tempVertex.x, tempVertex.y, tempVertex.z);\n\t\t\t\t\t\t\tsourceNormals.push(tempNormal.x, tempNormal.y, tempNormal.z);\n\t\t\t\t\t\t\tsourceTangents.push(tempTangents.x, tempTangents.y, tempTangents.z);\n\t\t\t\t\t\t\tsourceUVs.push(tempUV.x, tempUV.y);\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tfor (k = 0; k < tempLen; k++) {\n\t\t\t\t\t\t\tproduct = k*3;\n\t\t\t\t\t\t\t//this is faster than that only push one data\n\t\t\t\t\t\t\tpositions.push(sourcePositions[product], sourcePositions[product + 1], sourcePositions[product + 2]);\n\t\t\t\t\t\t\tnormals.push(sourceNormals[product], sourceNormals[product + 1], sourceNormals[product + 2]);\n\t\t\t\t\t\t\ttangents.push(sourceTangents[product], sourceTangents[product + 1], sourceTangents[product + 2]);\n\t\t\t\t\t\t\tuvs.push(sourceUVs[k*2], sourceUVs[k*2 + 1]);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t//Todo\n\t\t\t\t}\n\n\t\t\t\tvar sourceIndices:Array<number> /*uint*/ = sourceSubGeometry.indices;\n\t\t\t\ttempLen = sourceSubGeometry.numTriangles;\n\t\t\t\tfor (k = 0; k < tempLen; k++) {\n\t\t\t\t\tproduct = k*3;\n\t\t\t\t\tindices.push(sourceIndices[product] + vertexCounter, sourceIndices[product + 1] + vertexCounter, sourceIndices[product + 2] + vertexCounter);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tvar particleGeometry:ParticleGeometry = new ParticleGeometry();\n\t\tparticleGeometry.particles = particles;\n\t\tparticleGeometry.numParticles = numParticles;\n\n\t\tnumParticles = subGeometries.length;\n\t\tfor (i = 0; i < numParticles; i++) {\n\t\t\tsubGeometry = subGeometries[i];\n\t\t\tsubGeometry.autoDeriveNormals = false;\n\t\t\tsubGeometry.autoDeriveTangents = false;\n\t\t\tsubGeometry.updateIndices(indicesVector[i]);\n\t\t\tsubGeometry.updatePositions(positionsVector[i]);\n\t\t\tsubGeometry.updateVertexNormals(normalsVector[i]);\n\t\t\tsubGeometry.updateVertexTangents(tangentsVector[i]);\n\t\t\tsubGeometry.updateUVs(uvsVector[i]);\n\t\t\tparticleGeometry.addSubGeometry(subGeometry);\n\t\t}\n\n\t\treturn particleGeometry;\n\t}\n}\n\nexport = ParticleGeometryHelper;","import Matrix3D\t\t\t\t\t\t\t= require(\"awayjs-core/lib/geom/Matrix3D\");\n\n/**\n *\n */\nclass PerspectiveMatrix3D extends Matrix3D\n{\n\tconstructor(v:Array<number> = null)\n\t{\n\t\tsuper(v);\n\t}\n\n\tpublic perspectiveFieldOfViewLH(fieldOfViewY:number, aspectRatio:number, zNear:number, zFar:number)\n\t{\n\t\tvar yScale:number = 1/Math.tan(fieldOfViewY/2);\n\t\tvar xScale:number = yScale/aspectRatio;\n\n\t\tthis.copyRawDataFrom([xScale, 0.0, 0.0, 0.0, 0.0, yScale, 0.0, 0.0, 0.0, 0.0, zFar/(zFar - zNear), 1.0, 0.0, 0.0, (zNear*zFar)/(zNear - zFar), 0.0]);\n\t}\n}\n\nexport = PerspectiveMatrix3D;","import TextureProxyBase\t\t\t\t= require(\"awayjs-core/lib/textures/TextureProxyBase\");\n\nimport ContextGLTextureFormat\t\t= require(\"awayjs-stagegl/lib/base/ContextGLTextureFormat\");\n\nimport ShaderRegisterData\t\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterData\");\nimport ShaderRegisterElement\t\t= require(\"awayjs-renderergl/lib/compilation/ShaderRegisterElement\");\n\nclass ShaderCompilerHelper\n{\n\t/**\n\t * A helper method that generates standard code for sampling from a texture using the normal uv coordinates.\n\t * @param vo The MethodVO object linking this method with the pass currently being compiled.\n\t * @param sharedReg The shared register object for the shader.\n\t * @param inputReg The texture stream register.\n\t * @param texture The texture which will be assigned to the given slot.\n\t * @param uvReg An optional uv register if coordinates different from the primary uv coordinates are to be used.\n\t * @param forceWrap If true, texture wrapping is enabled regardless of the material setting.\n\t * @return The fragment code that performs the sampling.\n\t *\n\t * @protected\n\t */\n\tpublic static getTex2DSampleCode(targetReg:ShaderRegisterElement, sharedReg:ShaderRegisterData, inputReg:ShaderRegisterElement, texture:TextureProxyBase, smooth:boolean, repeat:boolean, mipmaps:boolean, uvReg:ShaderRegisterElement = null, forceWrap:string = null):string\n\t{\n\t\tvar wrap:string = forceWrap || (repeat? \"wrap\":\"clamp\");\n\t\tvar format:string = ShaderCompilerHelper.getFormatStringForTexture(texture);\n\t\tvar enableMipMaps:boolean = mipmaps && texture.hasMipmaps;\n\t\tvar filter:string = (smooth)? (enableMipMaps? \"linear,miplinear\" : \"linear\") : (enableMipMaps? \"nearest,mipnearest\" : \"nearest\");\n\n\t\tif (uvReg == null)\n\t\t\tuvReg = sharedReg.uvVarying;\n\n\t\treturn \"tex \" + targetReg + \", \" + uvReg + \", \" + inputReg + \" <2d,\" + filter + \",\" + format + wrap + \">\\n\";\n\n\t}\n\n\n\t/**\n\t * A helper method that generates standard code for sampling from a cube texture.\n\t * @param vo The MethodVO object linking this method with the pass currently being compiled.\n\t * @param targetReg The register in which to store the sampled colour.\n\t * @param inputReg The texture stream register.\n\t * @param texture The cube map which will be assigned to the given slot.\n\t * @param uvReg The direction vector with which to sample the cube map.\n\t *\n\t * @protected\n\t */\n\tpublic static getTexCubeSampleCode(targetReg:ShaderRegisterElement, inputReg:ShaderRegisterElement, texture:TextureProxyBase, smooth:boolean, mipmaps:boolean, uvReg:ShaderRegisterElement):string\n\t{\n\t\tvar filter:string;\n\t\tvar format:string = ShaderCompilerHelper.getFormatStringForTexture(texture);\n\t\tvar enableMipMaps:boolean = mipmaps && texture.hasMipmaps;\n\t\tvar filter:string = (smooth)? (enableMipMaps? \"linear,miplinear\" : \"linear\") : (enableMipMaps? \"nearest,mipnearest\" : \"nearest\");\n\n\t\treturn \"tex \" + targetReg + \", \" + uvReg + \", \" + inputReg + \" <cube,\" + format + filter + \">\\n\";\n\t}\n\n\t/**\n\t * Generates a texture format string for the sample instruction.\n\t * @param texture The texture for which to get the format string.\n\t * @return\n\t *\n\t * @protected\n\t */\n\tpublic static getFormatStringForTexture(texture:TextureProxyBase):string\n\t{\n\t\tswitch (texture.format) {\n\t\t\tcase ContextGLTextureFormat.COMPRESSED:\n\t\t\t\treturn \"dxt1,\";\n\t\t\t\tbreak;\n\t\t\tcase ContextGLTextureFormat.COMPRESSED_ALPHA:\n\t\t\t\treturn \"dxt5,\";\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\treturn \"\";\n\t\t}\n\t}\n}\n\nexport = ShaderCompilerHelper;"],"sourceRoot":"./"}