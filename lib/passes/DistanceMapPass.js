var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var ContextGLMipFilter = require("awayjs-stagegl/lib/base/ContextGLMipFilter");
var ContextGLTextureFilter = require("awayjs-stagegl/lib/base/ContextGLTextureFilter");
var ContextGLWrapMode = require("awayjs-stagegl/lib/base/ContextGLWrapMode");
var MaterialPassGLBase = require("awayjs-renderergl/lib/passes/MaterialPassGLBase");
var ShaderCompilerHelper = require("awayjs-renderergl/lib/utils/ShaderCompilerHelper");
/**
 * DistanceMapPass is a pass that writes distance values to a depth map as a 32-bit value exploded over the 4 texture channels.
 * This is used to render omnidirectional shadow maps.
 */
var DistanceMapPass = (function (_super) {
    __extends(DistanceMapPass, _super);
    /**
     * Creates a new DistanceMapPass object.
     *
     * @param material The material to which this pass belongs.
     */
    function DistanceMapPass() {
        _super.call(this);
    }
    /**
     * Initializes the unchanging constant data for this material.
     */
    DistanceMapPass.prototype._iInitConstantData = function (shaderObject) {
        _super.prototype._iInitConstantData.call(this, shaderObject);
        var index = this._fragmentConstantsIndex;
        var data = shaderObject.fragmentConstantData;
        data[index + 4] = 1.0 / 255.0;
        data[index + 5] = 1.0 / 255.0;
        data[index + 6] = 1.0 / 255.0;
        data[index + 7] = 0.0;
    };
    DistanceMapPass.prototype._iIncludeDependencies = function (shaderObject) {
        shaderObject.projectionDependencies++;
        shaderObject.viewDirDependencies++;
        if (shaderObject.alphaThreshold > 0)
            shaderObject.uvDependencies++;
        if (shaderObject.viewDirDependencies > 0)
            shaderObject.globalPosDependencies++;
    };
    /**
     * @inheritDoc
     */
    DistanceMapPass.prototype._iGetFragmentCode = function (shaderObject, registerCache, sharedRegisters) {
        var code;
        var targetReg = sharedRegisters.shadedTarget;
        var diffuseInputReg = registerCache.getFreeTextureReg();
        var dataReg1 = registerCache.getFreeFragmentConstant();
        var dataReg2 = registerCache.getFreeFragmentConstant();
        this._fragmentConstantsIndex = dataReg1.index * 4;
        var temp1 = registerCache.getFreeFragmentVectorTemp();
        registerCache.addFragmentTempUsages(temp1, 1);
        var temp2 = registerCache.getFreeFragmentVectorTemp();
        registerCache.addFragmentTempUsages(temp2, 1);
        // squared distance to view
        code = "dp3 " + temp1 + ".z, " + sharedRegisters.viewDirVarying + ".xyz, " + sharedRegisters.viewDirVarying + ".xyz\n" + "mul " + temp1 + ", " + dataReg1 + ", " + temp1 + ".z\n" + "frc " + temp1 + ", " + temp1 + "\n" + "mul " + temp2 + ", " + temp1 + ".yzww, " + dataReg2 + "\n";
        if (shaderObject.alphaThreshold > 0) {
            diffuseInputReg = registerCache.getFreeTextureReg();
            this._texturesIndex = diffuseInputReg.index;
            var albedo = registerCache.getFreeFragmentVectorTemp();
            code += ShaderCompilerHelper.getTex2DSampleCode(albedo, sharedRegisters, diffuseInputReg, shaderObject.texture, shaderObject.useSmoothTextures, shaderObject.repeatTextures, shaderObject.useMipmapping);
            var cutOffReg = registerCache.getFreeFragmentConstant();
            code += "sub " + albedo + ".w, " + albedo + ".w, " + cutOffReg + ".x\n" + "kil " + albedo + ".w\n";
        }
        code += "sub " + targetReg + ", " + temp1 + ", " + temp2 + "\n";
        return code;
    };
    /**
     * @inheritDoc
     */
    DistanceMapPass.prototype._iActivate = function (pass, renderer, camera) {
        _super.prototype._iActivate.call(this, pass, renderer, camera);
        var context = renderer.context;
        var shaderObject = pass.shaderObject;
        var f = camera.projection.far;
        f = 1 / (2 * f * f);
        // sqrt(f*f+f*f) is largest possible distance for any frustum, so we need to divide by it. Rarely a tight fit, but with 32 bits precision, it's enough.
        var index = this._fragmentConstantsIndex;
        var data = shaderObject.fragmentConstantData;
        data[index] = 1.0 * f;
        data[index + 1] = 255.0 * f;
        data[index + 2] = 65025.0 * f;
        data[index + 3] = 16581375.0 * f;
        if (shaderObject.alphaThreshold > 0) {
            context.setSamplerStateAt(this._texturesIndex, shaderObject.repeatTextures ? ContextGLWrapMode.REPEAT : ContextGLWrapMode.CLAMP, shaderObject.useSmoothTextures ? ContextGLTextureFilter.LINEAR : ContextGLTextureFilter.NEAREST, shaderObject.useMipmapping ? ContextGLMipFilter.MIPLINEAR : ContextGLMipFilter.MIPNONE);
            renderer.stage.activateTexture(this._texturesIndex, shaderObject.texture);
            data[index + 8] = pass.shaderObject.alphaThreshold;
        }
    };
    return DistanceMapPass;
})(MaterialPassGLBase);
module.exports = DistanceMapPass;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9wYXNzZXMvZGlzdGFuY2VtYXBwYXNzLnRzIl0sIm5hbWVzIjpbIkRpc3RhbmNlTWFwUGFzcyIsIkRpc3RhbmNlTWFwUGFzcy5jb25zdHJ1Y3RvciIsIkRpc3RhbmNlTWFwUGFzcy5faUluaXRDb25zdGFudERhdGEiLCJEaXN0YW5jZU1hcFBhc3MuX2lJbmNsdWRlRGVwZW5kZW5jaWVzIiwiRGlzdGFuY2VNYXBQYXNzLl9pR2V0RnJhZ21lbnRDb2RlIiwiRGlzdGFuY2VNYXBQYXNzLl9pQWN0aXZhdGUiXSwibWFwcGluZ3MiOiI7Ozs7OztBQU1BLElBQU8sa0JBQWtCLFdBQWEsNENBQTRDLENBQUMsQ0FBQztBQUNwRixJQUFPLHNCQUFzQixXQUFZLGdEQUFnRCxDQUFDLENBQUM7QUFDM0YsSUFBTyxpQkFBaUIsV0FBYSwyQ0FBMkMsQ0FBQyxDQUFDO0FBV2xGLElBQU8sa0JBQWtCLFdBQWEsaURBQWlELENBQUMsQ0FBQztBQUN6RixJQUFPLG9CQUFvQixXQUFhLGtEQUFrRCxDQUFDLENBQUM7QUFFNUYsQUFJQTs7O0dBREc7SUFDRyxlQUFlO0lBQVNBLFVBQXhCQSxlQUFlQSxVQUEyQkE7SUFLL0NBOzs7O09BSUdBO0lBQ0hBLFNBVktBLGVBQWVBO1FBWW5CQyxpQkFBT0EsQ0FBQ0E7SUFDVEEsQ0FBQ0E7SUFFREQ7O09BRUdBO0lBQ0lBLDRDQUFrQkEsR0FBekJBLFVBQTBCQSxZQUE2QkE7UUFFdERFLGdCQUFLQSxDQUFDQSxrQkFBa0JBLFlBQUNBLFlBQVlBLENBQUNBLENBQUNBO1FBRXZDQSxJQUFJQSxLQUFLQSxHQUFVQSxJQUFJQSxDQUFDQSx1QkFBdUJBLENBQUNBO1FBQ2hEQSxJQUFJQSxJQUFJQSxHQUFpQkEsWUFBWUEsQ0FBQ0Esb0JBQW9CQSxDQUFDQTtRQUMzREEsSUFBSUEsQ0FBQ0EsS0FBS0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsR0FBR0EsR0FBQ0EsS0FBS0EsQ0FBQ0E7UUFDNUJBLElBQUlB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R0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsY0FBY0EsQ0FBQ0E7UUFDcERBLENBQUNBO0lBQ0ZBLENBQUNBO0lBQ0ZMLHNCQUFDQTtBQUFEQSxDQWpIQSxBQWlIQ0EsRUFqSDZCLGtCQUFrQixFQWlIL0M7QUFFRCxBQUF5QixpQkFBaEIsZUFBZSxDQUFDIiwiZmlsZSI6InBhc3Nlcy9EaXN0YW5jZU1hcFBhc3MuanMiLCJzb3VyY2VSb290IjoiLi4vIiwic291cmNlc0NvbnRlbnQiOlsi77u/aW1wb3J0IE1hdHJpeDNEXHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2dlb20vTWF0cml4M0RcIik7XG5pbXBvcnQgTWF0cml4M0RVdGlsc1x0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2dlb20vTWF0cml4M0RVdGlsc1wiKTtcbmltcG9ydCBUZXh0dXJlMkRCYXNlXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvdGV4dHVyZXMvVGV4dHVyZTJEQmFzZVwiKTtcblxuaW1wb3J0IENhbWVyYVx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9lbnRpdGllcy9DYW1lcmFcIik7XG5cbmltcG9ydCBDb250ZXh0R0xNaXBGaWx0ZXJcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYmFzZS9Db250ZXh0R0xNaXBGaWx0ZXJcIik7XG5pbXBvcnQgQ29udGV4dEdMVGV4dHVyZUZpbHRlclx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYmFzZS9Db250ZXh0R0xUZXh0dXJlRmlsdGVyXCIpO1xuaW1wb3J0IENvbnRleHRHTFdyYXBNb2RlXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2Jhc2UvQ29udGV4dEdMV3JhcE1vZGVcIik7XG5pbXBvcnQgSUNvbnRleHRHTFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYmFzZS9JQ29udGV4dEdMXCIpO1xuaW1wb3J0IFN0YWdlXHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2Jhc2UvU3RhZ2VcIik7XG5cbmltcG9ydCBSZW5kZXJlckJhc2VcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2Jhc2UvUmVuZGVyZXJCYXNlXCIpO1xuaW1wb3J0IE1hdGVyaWFsUGFzc0RhdGFcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9wb29sL01hdGVyaWFsUGFzc0RhdGFcIik7XG5pbXBvcnQgUmVuZGVyYWJsZUJhc2VcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9wb29sL1JlbmRlcmFibGVCYXNlXCIpO1xuaW1wb3J0IFNoYWRlck9iamVjdEJhc2VcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9jb21waWxhdGlvbi9TaGFkZXJPYmplY3RCYXNlXCIpO1xuaW1wb3J0IFNoYWRlclJlZ2lzdGVyQ2FjaGVcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvY29tcGlsYXRpb24vU2hhZGVyUmVnaXN0ZXJDYWNoZVwiKTtcbmltcG9ydCBTaGFkZXJSZWdpc3RlckRhdGFcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvY29tcGlsYXRpb24vU2hhZGVyUmVnaXN0ZXJEYXRhXCIpO1xuaW1wb3J0IFNoYWRlclJlZ2lzdGVyRWxlbWVudFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvY29tcGlsYXRpb24vU2hhZGVyUmVnaXN0ZXJFbGVtZW50XCIpO1xuaW1wb3J0IE1hdGVyaWFsUGFzc0dMQmFzZVx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9wYXNzZXMvTWF0ZXJpYWxQYXNzR0xCYXNlXCIpO1xuaW1wb3J0IFNoYWRlckNvbXBpbGVySGVscGVyXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL3V0aWxzL1NoYWRlckNvbXBpbGVySGVscGVyXCIpO1xuXG4vKipcbiAqIERpc3RhbmNlTWFwUGFzcyBpcyBhIHBhc3MgdGhhdCB3cml0ZXMgZGlzdGFuY2UgdmFsdWVzIHRvIGEgZGVwdGggbWFwIGFzIGEgMzItYml0IHZhbHVlIGV4cGxvZGVkIG92ZXIgdGhlIDQgdGV4dHVyZSBjaGFubmVscy5cbiAqIFRoaXMgaXMgdXNlZCB0byByZW5kZXIgb21uaWRpcmVjdGlvbmFsIHNoYWRvdyBtYXBzLlxuICovXG5jbGFzcyBEaXN0YW5jZU1hcFBhc3MgZXh0ZW5kcyBNYXRlcmlhbFBhc3NHTEJhc2Vcbntcblx0cHJpdmF0ZSBfZnJhZ21lbnRDb25zdGFudHNJbmRleDpudW1iZXI7XG5cdHByaXZhdGUgX3RleHR1cmVzSW5kZXg6bnVtYmVyO1xuXG5cdC8qKlxuXHQgKiBDcmVhdGVzIGEgbmV3IERpc3RhbmNlTWFwUGFzcyBvYmplY3QuXG5cdCAqXG5cdCAqIEBwYXJhbSBtYXRlcmlhbCBUaGUgbWF0ZXJpYWwgdG8gd2hpY2ggdGhpcyBwYXNzIGJlbG9uZ3MuXG5cdCAqL1xuXHRjb25zdHJ1Y3RvcigpXG5cdHtcblx0XHRzdXBlcigpO1xuXHR9XG5cblx0LyoqXG5cdCAqIEluaXRpYWxpemVzIHRoZSB1bmNoYW5naW5nIGNvbnN0YW50IGRhdGEgZm9yIHRoaXMgbWF0ZXJpYWwuXG5cdCAqL1xuXHRwdWJsaWMgX2lJbml0Q29uc3RhbnREYXRhKHNoYWRlck9iamVjdDpTaGFkZXJPYmplY3RCYXNlKVxuXHR7XG5cdFx0c3VwZXIuX2lJbml0Q29uc3RhbnREYXRhKHNoYWRlck9iamVjdCk7XG5cblx0XHR2YXIgaW5kZXg6bnVtYmVyID0gdGhpcy5fZnJhZ21lbnRDb25zdGFudHNJbmRleDtcblx0XHR2YXIgZGF0YTpBcnJheTxudW1iZXI+ID0gc2hhZGVyT2JqZWN0LmZyYWdtZW50Q29uc3RhbnREYXRhO1xuXHRcdGRhdGFbaW5kZXggKyA0XSA9IDEuMC8yNTUuMDtcblx0XHRkYXRhW2luZGV4ICsgNV0gPSAxLjAvMjU1LjA7XG5cdFx0ZGF0YVtpbmRleCArIDZdID0gMS4wLzI1NS4wO1xuXHRcdGRhdGFbaW5kZXggKyA3XSA9IDAuMDtcblx0fVxuXG5cdHB1YmxpYyBfaUluY2x1ZGVEZXBlbmRlbmNpZXMoc2hhZGVyT2JqZWN0OlNoYWRlck9iamVjdEJhc2UpXG5cdHtcblx0XHRzaGFkZXJPYmplY3QucHJvamVjdGlvbkRlcGVuZGVuY2llcysrO1xuXHRcdHNoYWRlck9iamVjdC52aWV3RGlyRGVwZW5kZW5jaWVzKys7XG5cblx0XHRpZiAoc2hhZGVyT2JqZWN0LmFscGhhVGhyZXNob2xkID4gMClcblx0XHRcdHNoYWRlck9iamVjdC51dkRlcGVuZGVuY2llcysrO1xuXG5cdFx0aWYgKHNoYWRlck9iamVjdC52aWV3RGlyRGVwZW5kZW5jaWVzID4gMClcblx0XHRcdHNoYWRlck9iamVjdC5nbG9iYWxQb3NEZXBlbmRlbmNpZXMrKztcblx0fVxuXG5cdC8qKlxuXHQgKiBAaW5oZXJpdERvY1xuXHQgKi9cblx0cHVibGljIF9pR2V0RnJhZ21lbnRDb2RlKHNoYWRlck9iamVjdDpTaGFkZXJPYmplY3RCYXNlLCByZWdpc3RlckNhY2hlOlNoYWRlclJlZ2lzdGVyQ2FjaGUsIHNoYXJlZFJlZ2lzdGVyczpTaGFkZXJSZWdpc3RlckRhdGEpOnN0cmluZ1xuXHR7XG5cdFx0dmFyIGNvZGU6c3RyaW5nO1xuXHRcdHZhciB0YXJnZXRSZWc6U2hhZGVyUmVnaXN0ZXJFbGVtZW50ID0gc2hhcmVkUmVnaXN0ZXJzLnNoYWRlZFRhcmdldDtcblx0XHR2YXIgZGlmZnVzZUlucHV0UmVnOlNoYWRlclJlZ2lzdGVyRWxlbWVudCA9IHJlZ2lzdGVyQ2FjaGUuZ2V0RnJlZVRleHR1cmVSZWcoKTtcblx0XHR2YXIgZGF0YVJlZzE6U2hhZGVyUmVnaXN0ZXJFbGVtZW50ID0gcmVnaXN0ZXJDYWNoZS5nZXRGcmVlRnJhZ21lbnRDb25zdGFudCgpO1xuXHRcdHZhciBkYXRhUmVnMjpTaGFkZXJSZWdpc3RlckVsZW1lbnQgPSByZWdpc3RlckNhY2hlLmdldEZyZWVGcmFnbWVudENvbnN0YW50KClcblxuXHRcdHRoaXMuX2ZyYWdtZW50Q29uc3RhbnRzSW5kZXggPSBkYXRhUmVnMS5pbmRleCo0O1xuXG5cdFx0dmFyIHRlbXAxOlNoYWRlclJlZ2lzdGVyRWxlbWVudCA9IHJlZ2lzdGVyQ2FjaGUuZ2V0RnJlZUZyYWdtZW50VmVjdG9yVGVtcCgpO1xuXHRcdHJlZ2lzdGVyQ2FjaGUuYWRkRnJhZ21lbnRUZW1wVXNhZ2VzKHRlbXAxLCAxKTtcblx0XHR2YXIgdGVtcDI6U2hhZGVyUmVnaXN0ZXJFbGVtZW50ID0gcmVnaXN0ZXJDYWNoZS5nZXRGcmVlRnJhZ21lbnRWZWN0b3JUZW1wKCk7XG5cdFx0cmVnaXN0ZXJDYWNoZS5hZGRGcmFnbWVudFRlbXBVc2FnZXModGVtcDIsIDEpO1xuXG5cdFx0Ly8gc3F1YXJlZCBkaXN0YW5jZSB0byB2aWV3XG5cdFx0Y29kZSA9IFwiZHAzIFwiICsgdGVtcDEgKyBcIi56LCBcIiArIHNoYXJlZFJlZ2lzdGVycy52aWV3RGlyVmFyeWluZyArIFwiLnh5eiwgXCIgKyBzaGFyZWRSZWdpc3RlcnMudmlld0RpclZhcnlpbmcgKyBcIi54eXpcXG5cIiArXG5cdFx0XHQgICBcIm11bCBcIiArIHRlbXAxICsgXCIsIFwiICsgZGF0YVJlZzEgKyBcIiwgXCIgKyB0ZW1wMSArIFwiLnpcXG5cIiArXG5cdFx0XHQgICBcImZyYyBcIiArIHRlbXAxICsgXCIsIFwiICsgdGVtcDEgKyBcIlxcblwiICtcblx0XHRcdCAgIFwibXVsIFwiICsgdGVtcDIgKyBcIiwgXCIgKyB0ZW1wMSArIFwiLnl6d3csIFwiICsgZGF0YVJlZzIgKyBcIlxcblwiO1xuXG5cdFx0aWYgKHNoYWRlck9iamVjdC5hbHBoYVRocmVzaG9sZCA+IDApIHtcblx0XHRcdGRpZmZ1c2VJbnB1dFJlZyA9IHJlZ2lzdGVyQ2FjaGUuZ2V0RnJlZVRleHR1cmVSZWcoKTtcblxuXHRcdFx0dGhpcy5fdGV4dHVyZXNJbmRleCA9IGRpZmZ1c2VJbnB1dFJlZy5pbmRleDtcblxuXHRcdFx0dmFyIGFsYmVkbzpTaGFkZXJSZWdpc3RlckVsZW1lbnQgPSByZWdpc3RlckNhY2hlLmdldEZyZWVGcmFnbWVudFZlY3RvclRlbXAoKTtcblx0XHRcdGNvZGUgKz0gU2hhZGVyQ29tcGlsZXJIZWxwZXIuZ2V0VGV4MkRTYW1wbGVDb2RlKGFsYmVkbywgc2hhcmVkUmVnaXN0ZXJzLCBkaWZmdXNlSW5wdXRSZWcsIHNoYWRlck9iamVjdC50ZXh0dXJlLCBzaGFkZXJPYmplY3QudXNlU21vb3RoVGV4dHVyZXMsIHNoYWRlck9iamVjdC5yZXBlYXRUZXh0dXJlcywgc2hhZGVyT2JqZWN0LnVzZU1pcG1hcHBpbmcpO1xuXG5cdFx0XHR2YXIgY3V0T2ZmUmVnOlNoYWRlclJlZ2lzdGVyRWxlbWVudCA9IHJlZ2lzdGVyQ2FjaGUuZ2V0RnJlZUZyYWdtZW50Q29uc3RhbnQoKTtcblxuXHRcdFx0Y29kZSArPSBcInN1YiBcIiArIGFsYmVkbyArIFwiLncsIFwiICsgYWxiZWRvICsgXCIudywgXCIgKyBjdXRPZmZSZWcgKyBcIi54XFxuXCIgK1xuXHRcdFx0XHRcImtpbCBcIiArIGFsYmVkbyArIFwiLndcXG5cIjtcblx0XHR9XG5cblx0XHRjb2RlICs9IFwic3ViIFwiICsgdGFyZ2V0UmVnICsgXCIsIFwiICsgdGVtcDEgKyBcIiwgXCIgKyB0ZW1wMiArIFwiXFxuXCI7XG5cblx0XHRyZXR1cm4gY29kZTtcblx0fVxuXG5cdC8qKlxuXHQgKiBAaW5oZXJpdERvY1xuXHQgKi9cblx0cHVibGljIF9pQWN0aXZhdGUocGFzczpNYXRlcmlhbFBhc3NEYXRhLCByZW5kZXJlcjpSZW5kZXJlckJhc2UsIGNhbWVyYTpDYW1lcmEpXG5cdHtcblx0XHRzdXBlci5faUFjdGl2YXRlKHBhc3MsIHJlbmRlcmVyLCBjYW1lcmEpO1xuXG5cdFx0dmFyIGNvbnRleHQ6SUNvbnRleHRHTCA9IHJlbmRlcmVyLmNvbnRleHQ7XG5cdFx0dmFyIHNoYWRlck9iamVjdDpTaGFkZXJPYmplY3RCYXNlID0gcGFzcy5zaGFkZXJPYmplY3Q7XG5cblx0XHR2YXIgZjpudW1iZXIgPSBjYW1lcmEucHJvamVjdGlvbi5mYXI7XG5cblx0XHRmID0gMS8oMipmKmYpO1xuXHRcdC8vIHNxcnQoZipmK2YqZikgaXMgbGFyZ2VzdCBwb3NzaWJsZSBkaXN0YW5jZSBmb3IgYW55IGZydXN0dW0sIHNvIHdlIG5lZWQgdG8gZGl2aWRlIGJ5IGl0LiBSYXJlbHkgYSB0aWdodCBmaXQsIGJ1dCB3aXRoIDMyIGJpdHMgcHJlY2lzaW9uLCBpdCdzIGVub3VnaC5cblx0XHR2YXIgaW5kZXg6bnVtYmVyID0gdGhpcy5fZnJhZ21lbnRDb25zdGFudHNJbmRleDtcblx0XHR2YXIgZGF0YTpBcnJheTxudW1iZXI+ID0gc2hhZGVyT2JqZWN0LmZyYWdtZW50Q29uc3RhbnREYXRhO1xuXHRcdGRhdGFbaW5kZXhdID0gMS4wKmY7XG5cdFx0ZGF0YVtpbmRleCArIDFdID0gMjU1LjAqZjtcblx0XHRkYXRhW2luZGV4ICsgMl0gPSA2NTAyNS4wKmY7XG5cdFx0ZGF0YVtpbmRleCArIDNdID0gMTY1ODEzNzUuMCpmO1xuXG5cdFx0aWYgKHNoYWRlck9iamVjdC5hbHBoYVRocmVzaG9sZCA+IDApIHtcblx0XHRcdGNvbnRleHQuc2V0U2FtcGxlclN0YXRlQXQodGhpcy5fdGV4dHVyZXNJbmRleCwgc2hhZGVyT2JqZWN0LnJlcGVhdFRleHR1cmVzPyBDb250ZXh0R0xXcmFwTW9kZS5SRVBFQVQ6Q29udGV4dEdMV3JhcE1vZGUuQ0xBTVAsIHNoYWRlck9iamVjdC51c2VTbW9vdGhUZXh0dXJlcz8gQ29udGV4dEdMVGV4dHVyZUZpbHRlci5MSU5FQVIgOiBDb250ZXh0R0xUZXh0dXJlRmlsdGVyLk5FQVJFU1QsIHNoYWRlck9iamVjdC51c2VNaXBtYXBwaW5nPyBDb250ZXh0R0xNaXBGaWx0ZXIuTUlQTElORUFSIDogQ29udGV4dEdMTWlwRmlsdGVyLk1JUE5PTkUpO1xuXHRcdFx0cmVuZGVyZXIuc3RhZ2UuYWN0aXZhdGVUZXh0dXJlKHRoaXMuX3RleHR1cmVzSW5kZXgsIHNoYWRlck9iamVjdC50ZXh0dXJlKTtcblxuXHRcdFx0ZGF0YVtpbmRleCArIDhdID0gcGFzcy5zaGFkZXJPYmplY3QuYWxwaGFUaHJlc2hvbGQ7XG5cdFx0fVxuXHR9XG59XG5cbmV4cG9ydCA9IERpc3RhbmNlTWFwUGFzczsiXX0=