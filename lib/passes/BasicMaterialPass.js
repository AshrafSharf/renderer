var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var ShaderObjectBase = require("awayjs-renderergl/lib/compilation/ShaderObjectBase");
var ShaderCompilerHelper = require("awayjs-renderergl/lib/utils/ShaderCompilerHelper");
var RenderPassBase = require("awayjs-renderergl/lib/passes/RenderPassBase");
/**
 * BasicMaterialPass forms an abstract base class for the default shaded materials provided by Stage,
 * using material methods to define their appearance.
 */
var BasicMaterialPass = (function (_super) {
    __extends(BasicMaterialPass, _super);
    function BasicMaterialPass(renderObject, renderObjectOwner, renderableClass, stage) {
        _super.call(this, renderObject, renderObjectOwner, renderableClass, stage);
        this._diffuseR = 1;
        this._diffuseG = 1;
        this._diffuseB = 1;
        this._diffuseA = 1;
        this._shader = new ShaderObjectBase(renderableClass, this, this._stage);
    }
    BasicMaterialPass.prototype._iIncludeDependencies = function (shaderObject) {
        _super.prototype._iIncludeDependencies.call(this, shaderObject);
        if (shaderObject.texture != null)
            shaderObject.uvDependencies++;
    };
    /**
     * @inheritDoc
     */
    BasicMaterialPass.prototype._iGetFragmentCode = function (shaderObject, regCache, sharedReg) {
        var code = "";
        var alphaReg;
        if (this.preserveAlpha) {
            alphaReg = regCache.getFreeFragmentSingleTemp();
            regCache.addFragmentTempUsages(alphaReg, 1);
            code += "mov " + alphaReg + ", " + sharedReg.shadedTarget + ".w\n";
        }
        var targetReg = sharedReg.shadedTarget;
        var diffuseInputReg;
        if (shaderObject.texture != null) {
            diffuseInputReg = regCache.getFreeTextureReg();
            this._texturesIndex = diffuseInputReg.index;
            code += ShaderCompilerHelper.getTex2DSampleCode(targetReg, sharedReg, diffuseInputReg, shaderObject.texture, shaderObject.useSmoothTextures, shaderObject.repeatTextures, shaderObject.useMipmapping);
            if (shaderObject.alphaThreshold > 0) {
                var cutOffReg = regCache.getFreeFragmentConstant();
                this._fragmentConstantsIndex = cutOffReg.index * 4;
                code += "sub " + targetReg + ".w, " + targetReg + ".w, " + cutOffReg + ".x\n" + "kil " + targetReg + ".w\n" + "add " + targetReg + ".w, " + targetReg + ".w, " + cutOffReg + ".x\n";
            }
        }
        else if (shaderObject.colorBufferIndex != -1) {
            code += "mov " + targetReg + ", " + sharedReg.colorVarying + "\n";
        }
        else {
            diffuseInputReg = regCache.getFreeFragmentConstant();
            this._fragmentConstantsIndex = diffuseInputReg.index * 4;
            code += "mov " + targetReg + ", " + diffuseInputReg + "\n";
        }
        if (this.preserveAlpha) {
            code += "mov " + sharedReg.shadedTarget + ".w, " + alphaReg + "\n";
            regCache.removeFragmentTempUsage(alphaReg);
        }
        return code;
    };
    /**
     * @inheritDoc
     */
    BasicMaterialPass.prototype._iActivate = function (camera) {
        _super.prototype._iActivate.call(this, camera);
        if (this._shader.texture != null) {
            this._stage.activateTexture(this._texturesIndex, this._shader.texture, this._shader.repeatTextures, this._shader.useSmoothTextures, this._shader.useMipmapping);
            if (this._shader.alphaThreshold > 0)
                this._shader.fragmentConstantData[this._fragmentConstantsIndex] = this._shader.alphaThreshold;
        }
        else if (this._shader.colorBufferIndex == -1) {
            var index = this._fragmentConstantsIndex;
            var data = this._shader.fragmentConstantData;
            data[index] = this._diffuseR;
            data[index + 1] = this._diffuseG;
            data[index + 2] = this._diffuseB;
            data[index + 3] = this._diffuseA;
        }
    };
    return BasicMaterialPass;
})(RenderPassBase);
module.exports = BasicMaterialPass;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9wYXNzZXMvQmFzaWNNYXRlcmlhbFBhc3MudHMiXSwibmFtZXMiOlsiQmFzaWNNYXRlcmlhbFBhc3MiLCJCYXNpY01hdGVyaWFsUGFzcy5jb25zdHJ1Y3RvciIsIkJhc2ljTWF0ZXJpYWxQYXNzLl9pSW5jbHVkZURlcGVuZGVuY2llcyIsIkJhc2ljTWF0ZXJpYWxQYXNzLl9pR2V0RnJhZ21lbnRDb2RlIiwiQmFzaWNNYXRlcmlhbFBhc3MuX2lBY3RpdmF0ZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBcUJBLElBQU8sZ0JBQWdCLFdBQWMsb0RBQW9ELENBQUMsQ0FBQztBQUkzRixJQUFPLG9CQUFvQixXQUFhLGtEQUFrRCxDQUFDLENBQUM7QUFFNUYsSUFBTyxjQUFjLFdBQWMsNkNBQTZDLENBQUMsQ0FBQztBQUdsRixBQUlBOzs7R0FERztJQUNHLGlCQUFpQjtJQUFTQSxVQUExQkEsaUJBQWlCQSxVQUF1QkE7SUFVN0NBLFNBVktBLGlCQUFpQkEsQ0FVVkEsWUFBNkJBLEVBQUVBLGlCQUFvQ0EsRUFBRUEsZUFBZ0NBLEVBQUVBLEtBQVdBO1FBRTdIQyxrQkFBTUEsWUFBWUEsRUFBRUEsaUJBQWlCQSxFQUFFQSxlQUFlQSxFQUFFQSxLQUFLQSxDQUFDQSxDQUFDQTtRQVZ4REEsY0FBU0EsR0FBVUEsQ0FBQ0EsQ0FBQ0E7UUFDckJBLGNBQVNBLEdBQVVBLENBQUNBLENBQUNBO1FBQ3JCQSxjQUFTQSxHQUFVQSxDQUFDQSxDQUFDQTtRQUNyQkEsY0FBU0EsR0FBVUEsQ0FBQ0EsQ0FBQ0E7UUFTNUJBLElBQUlBLENBQUNBLE9BQU9BLEdBQUdBLElBQUlBLGdCQUFnQkEsQ0FBQ0EsZUFBZUEsRUFBRUEsSUFBSUEsRUFBRUEsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0E7SUFDekVBLENBQUNBO0lBRU1ELGlEQUFxQkEsR0FBNUJBLFVBQTZCQSxZQUE2QkE7UUFFekRFLGdCQUFLQSxDQUFDQSxxQkFBcUJBLFlBQUNBLFlB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Y0EsQ0FBQ0E7UUFDaEdBLENBQUNBO1FBQUNBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLGdCQUFnQkEsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDaERBLElBQUlBLEtBQUtBLEdBQVVBLElBQUlBLENBQUNBLHVCQUF1QkEsQ0FBQ0E7WUFDaERBLElBQUlBLElBQUlBLEdBQWlCQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxvQkFBb0JBLENBQUNBO1lBQzNEQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQTtZQUM3QkEsSUFBSUEsQ0FBQ0EsS0FBS0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0E7WUFDakNBLElBQUlBLENBQUNBLEtBQUtBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBO1lBQ2pDQSxJQUFJQSxDQUFDQSxLQUFLQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQTtRQUNsQ0EsQ0FBQ0E7SUFDRkEsQ0FBQ0E7SUFDRkosd0JBQUNBO0FBQURBLENBakdBLEFBaUdDQSxFQWpHK0IsY0FBYyxFQWlHN0M7QUFFRCxBQUEyQixpQkFBbEIsaUJBQWlCLENBQUMiLCJmaWxlIjoicGFzc2VzL0Jhc2ljTWF0ZXJpYWxQYXNzLmpzIiwic291cmNlUm9vdCI6Ii4uLyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBCbGVuZE1vZGVcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2Jhc2UvQmxlbmRNb2RlXCIpO1xyXG5pbXBvcnQgTWF0cml4XHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2dlb20vTWF0cml4XCIpO1xyXG5pbXBvcnQgTWF0cml4M0RcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvZ2VvbS9NYXRyaXgzRFwiKTtcclxuaW1wb3J0IE1hdHJpeDNEVXRpbHNcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9nZW9tL01hdHJpeDNEVXRpbHNcIik7XHJcbmltcG9ydCBUZXh0dXJlMkRCYXNlXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvdGV4dHVyZXMvVGV4dHVyZTJEQmFzZVwiKTtcclxuXHJcbmltcG9ydCBDYW1lcmFcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvZW50aXRpZXMvQ2FtZXJhXCIpO1xyXG5pbXBvcnQgTWF0ZXJpYWxCYXNlXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9tYXRlcmlhbHMvTWF0ZXJpYWxCYXNlXCIpO1xyXG5pbXBvcnQgSVJlbmRlck9iamVjdE93bmVyXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL2Jhc2UvSVJlbmRlck9iamVjdE93bmVyXCIpO1xyXG5cclxuaW1wb3J0IENvbnRleHRHTENvbXBhcmVNb2RlXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2Jhc2UvQ29udGV4dEdMQ29tcGFyZU1vZGVcIik7XHJcbmltcG9ydCBDb250ZXh0R0xQcm9ncmFtVHlwZVx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9iYXNlL0NvbnRleHRHTFByb2dyYW1UeXBlXCIpO1xyXG5pbXBvcnQgQ29udGV4dEdMTWlwRmlsdGVyXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2Jhc2UvQ29udGV4dEdMTWlwRmlsdGVyXCIpO1xyXG5pbXBvcnQgQ29udGV4dEdMVGV4dHVyZUZpbHRlclx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYmFzZS9Db250ZXh0R0xUZXh0dXJlRmlsdGVyXCIpO1xyXG5pbXBvcnQgQ29udGV4dEdMV3JhcE1vZGVcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYmFzZS9Db250ZXh0R0xXcmFwTW9kZVwiKTtcclxuaW1wb3J0IElDb250ZXh0R0xcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2Jhc2UvSUNvbnRleHRHTFwiKTtcclxuaW1wb3J0IFN0YWdlXHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2Jhc2UvU3RhZ2VcIik7XHJcblxyXG5pbXBvcnQgUmVuZGVyYWJsZUJhc2VcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9wb29sL1JlbmRlcmFibGVCYXNlXCIpO1xyXG5pbXBvcnQgUmVuZGVyT2JqZWN0QmFzZVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2NvbXBpbGF0aW9uL1JlbmRlck9iamVjdEJhc2VcIik7XHJcbmltcG9ydCBSZW5kZXJPYmplY3RQb29sXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvY29tcGlsYXRpb24vUmVuZGVyT2JqZWN0UG9vbFwiKTtcclxuaW1wb3J0IFNoYWRlck9iamVjdEJhc2VcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9jb21waWxhdGlvbi9TaGFkZXJPYmplY3RCYXNlXCIpO1xyXG5pbXBvcnQgU2hhZGVyUmVnaXN0ZXJDYWNoZVx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9jb21waWxhdGlvbi9TaGFkZXJSZWdpc3RlckNhY2hlXCIpO1xyXG5pbXBvcnQgU2hhZGVyUmVnaXN0ZXJEYXRhXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2NvbXBpbGF0aW9uL1NoYWRlclJlZ2lzdGVyRGF0YVwiKTtcclxuaW1wb3J0IFNoYWRlclJlZ2lzdGVyRWxlbWVudFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvY29tcGlsYXRpb24vU2hhZGVyUmVnaXN0ZXJFbGVtZW50XCIpO1xyXG5pbXBvcnQgU2hhZGVyQ29tcGlsZXJIZWxwZXJcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvdXRpbHMvU2hhZGVyQ29tcGlsZXJIZWxwZXJcIik7XHJcbmltcG9ydCBJUmVuZGVyYWJsZUNsYXNzXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvcG9vbC9JUmVuZGVyYWJsZUNsYXNzXCIpO1xyXG5pbXBvcnQgUmVuZGVyUGFzc0Jhc2VcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9wYXNzZXMvUmVuZGVyUGFzc0Jhc2VcIik7XHJcblxyXG5cclxuLyoqXHJcbiAqIEJhc2ljTWF0ZXJpYWxQYXNzIGZvcm1zIGFuIGFic3RyYWN0IGJhc2UgY2xhc3MgZm9yIHRoZSBkZWZhdWx0IHNoYWRlZCBtYXRlcmlhbHMgcHJvdmlkZWQgYnkgU3RhZ2UsXHJcbiAqIHVzaW5nIG1hdGVyaWFsIG1ldGhvZHMgdG8gZGVmaW5lIHRoZWlyIGFwcGVhcmFuY2UuXHJcbiAqL1xyXG5jbGFzcyBCYXNpY01hdGVyaWFsUGFzcyBleHRlbmRzIFJlbmRlclBhc3NCYXNlXHJcbntcclxuXHRwcml2YXRlIF9kaWZmdXNlUjpudW1iZXIgPSAxO1xyXG5cdHByaXZhdGUgX2RpZmZ1c2VHOm51bWJlciA9IDE7XHJcblx0cHJpdmF0ZSBfZGlmZnVzZUI6bnVtYmVyID0gMTtcclxuXHRwcml2YXRlIF9kaWZmdXNlQTpudW1iZXIgPSAxO1xyXG5cclxuXHRwcml2YXRlIF9mcmFnbWVudENvbnN0YW50c0luZGV4Om51bWJlcjtcclxuXHRwcml2YXRlIF90ZXh0dXJlc0luZGV4Om51bWJlcjtcclxuXHJcblx0Y29uc3RydWN0b3IocmVuZGVyT2JqZWN0OlJlbmRlck9iamVjdEJhc2UsIHJlbmRlck9iamVjdE93bmVyOklSZW5kZXJPYmplY3RPd25lciwgcmVuZGVyYWJsZUNsYXNzOklSZW5kZXJhYmxlQ2xhc3MsIHN0YWdlOlN0YWdlKVxyXG5cdHtcclxuXHRcdHN1cGVyKHJlbmRlck9iamVjdCwgcmVuZGVyT2JqZWN0T3duZXIsIHJlbmRlcmFibGVDbGFzcywgc3RhZ2UpO1xyXG5cclxuXHRcdHRoaXMuX3NoYWRlciA9IG5ldyBTaGFkZXJPYmplY3RCYXNlKHJlbmRlcmFibGVDbGFzcywgdGhpcywgdGhpcy5fc3RhZ2UpO1xyXG5cdH1cclxuXHJcblx0cHVibGljIF9pSW5jbHVkZURlcGVuZGVuY2llcyhzaGFkZXJPYmplY3Q6U2hhZGVyT2JqZWN0QmFzZSlcclxuXHR7XHJcblx0XHRzdXBlci5faUluY2x1ZGVEZXBlbmRlbmNpZXMoc2hhZGVyT2JqZWN0KTtcclxuXHJcblx0XHRpZiAoc2hhZGVyT2JqZWN0LnRleHR1cmUgIT0gbnVsbClcclxuXHRcdFx0c2hhZGVyT2JqZWN0LnV2RGVwZW5kZW5jaWVzKys7XHJcblxyXG4gICAgfVxyXG5cclxuXHQvKipcclxuXHQgKiBAaW5oZXJpdERvY1xyXG5cdCAqL1xyXG5cdHB1YmxpYyBfaUdldEZyYWdtZW50Q29kZShzaGFkZXJPYmplY3Q6U2hhZGVyT2JqZWN0QmFzZSwgcmVnQ2FjaGU6U2hhZGVyUmVnaXN0ZXJDYWNoZSwgc2hhcmVkUmVnOlNoYWRlclJlZ2lzdGVyRGF0YSk6c3RyaW5nXHJcblx0e1xyXG5cdFx0dmFyIGNvZGU6c3RyaW5nID0gXCJcIjtcclxuXHJcbiAgICAgICAgdmFyIGFscGhhUmVnOlNoYWRlclJlZ2lzdGVyRWxlbWVudDtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMucHJlc2VydmVBbHBoYSkge1xyXG4gICAgICAgICAgICBhbHBoYVJlZyA9IHJlZ0NhY2hlLmdldEZyZWVGcmFnbWVudFNpbmdsZVRlbXAoKTtcclxuICAgICAgICAgICAgcmVnQ2FjaGUuYWRkRnJhZ21lbnRUZW1wVXNhZ2VzKGFscGhhUmVnLCAxKTtcclxuICAgICAgICAgICAgY29kZSArPSBcIm1vdiBcIiArIGFscGhhUmVnICsgXCIsIFwiICsgc2hhcmVkUmVnLnNoYWRlZFRhcmdldCArIFwiLndcXG5cIjtcclxuICAgICAgICB9XHJcblxyXG5cdFx0dmFyIHRhcmdldFJlZzpTaGFkZXJSZWdpc3RlckVsZW1lbnQgPSBzaGFyZWRSZWcuc2hhZGVkVGFyZ2V0O1xyXG5cdFx0dmFyIGRpZmZ1c2VJbnB1dFJlZzpTaGFkZXJSZWdpc3RlckVsZW1lbnQ7XHJcblxyXG5cdFx0aWYgKHNoYWRlck9iamVjdC50ZXh0dXJlICE9IG51bGwpIHtcclxuXHRcdFx0ZGlmZnVzZUlucHV0UmVnID0gcmVnQ2FjaGUuZ2V0RnJlZVRleHR1cmVSZWcoKTtcclxuXHJcblx0XHRcdHRoaXMuX3RleHR1cmVzSW5kZXggPSBkaWZmdXNlSW5wdXRSZWcuaW5kZXg7XHJcblxyXG5cdFx0XHRjb2RlICs9IFNoYWRlckNvbXBpbGVySGVscGVyLmdldFRleDJEU2FtcGxlQ29kZSh0YXJnZXRSZWcsIHNoYXJlZFJlZywgZGlmZnVzZUlucHV0UmVnLCBzaGFkZXJPYmplY3QudGV4dHVyZSwgc2hhZGVyT2JqZWN0LnVzZVNtb290aFRleHR1cmVzLCBzaGFkZXJPYmplY3QucmVwZWF0VGV4dHVyZXMsIHNoYWRlck9iamVjdC51c2VNaXBtYXBwaW5nKTtcclxuXHJcblx0XHRcdGlmIChzaGFkZXJPYmplY3QuYWxwaGFUaHJlc2hvbGQgPiAwKSB7XHJcblx0XHRcdFx0dmFyIGN1dE9mZlJlZzpTaGFkZXJSZWdpc3RlckVsZW1lbnQgPSByZWdDYWNoZS5nZXRGcmVlRnJhZ21lbnRDb25zdGFudCgpO1xyXG5cdFx0XHRcdHRoaXMuX2ZyYWdtZW50Q29uc3RhbnRzSW5kZXggPSBjdXRPZmZSZWcuaW5kZXgqNDtcclxuXHJcblx0XHRcdFx0Y29kZSArPSBcInN1YiBcIiArIHRhcmdldFJlZyArIFwiLncsIFwiICsgdGFyZ2V0UmVnICsgXCIudywgXCIgKyBjdXRPZmZSZWcgKyBcIi54XFxuXCIgKyBcImtpbCBcIiArIHRhcmdldFJlZyArIFwiLndcXG5cIiArIFwiYWRkIFwiICsgdGFyZ2V0UmVnICsgXCIudywgXCIgKyB0YXJnZXRSZWcgKyBcIi53LCBcIiArIGN1dE9mZlJlZyArIFwiLnhcXG5cIjtcclxuXHRcdFx0fVxyXG5cdFx0fSBlbHNlIGlmIChzaGFkZXJPYmplY3QuY29sb3JCdWZmZXJJbmRleCAhPSAtMSkge1xyXG5cclxuXHRcdFx0Y29kZSArPSBcIm1vdiBcIiArIHRhcmdldFJlZyArIFwiLCBcIiArIHNoYXJlZFJlZy5jb2xvclZhcnlpbmcgKyBcIlxcblwiO1xyXG5cdFx0fSBlbHNlIHtcclxuXHRcdFx0ZGlmZnVzZUlucHV0UmVnID0gcmVnQ2FjaGUuZ2V0RnJlZUZyYWdtZW50Q29uc3RhbnQoKTtcclxuXHJcblx0XHRcdHRoaXMuX2ZyYWdtZW50Q29uc3RhbnRzSW5kZXggPSBkaWZmdXNlSW5wdXRSZWcuaW5kZXgqNDtcclxuXHJcblx0XHRcdGNvZGUgKz0gXCJtb3YgXCIgKyB0YXJnZXRSZWcgKyBcIiwgXCIgKyBkaWZmdXNlSW5wdXRSZWcgKyBcIlxcblwiO1xyXG5cdFx0fVxyXG5cclxuICAgICAgICBpZiAodGhpcy5wcmVzZXJ2ZUFscGhhKSB7XHJcbiAgICAgICAgICAgIGNvZGUgKz0gXCJtb3YgXCIgKyBzaGFyZWRSZWcuc2hhZGVkVGFyZ2V0ICsgXCIudywgXCIgKyBhbHBoYVJlZyArIFwiXFxuXCI7XHJcbiAgICAgICAgICAgIHJlZ0NhY2hlLnJlbW92ZUZyYWdtZW50VGVtcFVzYWdlKGFscGhhUmVnKTtcclxuICAgICAgICB9XHJcblxyXG5cdFx0cmV0dXJuIGNvZGU7XHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiBAaW5oZXJpdERvY1xyXG5cdCAqL1xyXG5cdHB1YmxpYyBfaUFjdGl2YXRlKGNhbWVyYTpDYW1lcmEpXHJcblx0e1xyXG5cdFx0c3VwZXIuX2lBY3RpdmF0ZShjYW1lcmEpO1xyXG5cclxuXHRcdGlmICh0aGlzLl9zaGFkZXIudGV4dHVyZSAhPSBudWxsKSB7XHJcblx0XHRcdHRoaXMuX3N0YWdlLmFjdGl2YXRlVGV4dHVyZSh0aGlzLl90ZXh0dXJlc0luZGV4LCB0aGlzLl9zaGFkZXIudGV4dHVyZSwgdGhpcy5fc2hhZGVyLnJlcGVhdFRleHR1cmVzLCB0aGlzLl9zaGFkZXIudXNlU21vb3RoVGV4dHVyZXMsIHRoaXMuX3NoYWRlci51c2VNaXBtYXBwaW5nKTtcclxuXHJcblx0XHRcdGlmICh0aGlzLl9zaGFkZXIuYWxwaGFUaHJlc2hvbGQgPiAwKVxyXG5cdFx0XHRcdHRoaXMuX3NoYWRlci5mcmFnbWVudENvbnN0YW50RGF0YVt0aGlzLl9mcmFnbWVudENvbnN0YW50c0luZGV4XSA9IHRoaXMuX3NoYWRlci5hbHBoYVRocmVzaG9sZDtcclxuXHRcdH0gZWxzZSBpZiAodGhpcy5fc2hhZGVyLmNvbG9yQnVmZmVySW5kZXggPT0gLTEpIHtcclxuXHRcdFx0dmFyIGluZGV4Om51bWJlciA9IHRoaXMuX2ZyYWdtZW50Q29uc3RhbnRzSW5kZXg7XHJcblx0XHRcdHZhciBkYXRhOkFycmF5PG51bWJlcj4gPSB0aGlzLl9zaGFkZXIuZnJhZ21lbnRDb25zdGFudERhdGE7XHJcblx0XHRcdGRhdGFbaW5kZXhdID0gdGhpcy5fZGlmZnVzZVI7XHJcblx0XHRcdGRhdGFbaW5kZXggKyAxXSA9IHRoaXMuX2RpZmZ1c2VHO1xyXG5cdFx0XHRkYXRhW2luZGV4ICsgMl0gPSB0aGlzLl9kaWZmdXNlQjtcclxuXHRcdFx0ZGF0YVtpbmRleCArIDNdID0gdGhpcy5fZGlmZnVzZUE7XHJcblx0XHR9XHJcblx0fVxyXG59XHJcblxyXG5leHBvcnQgPSBCYXNpY01hdGVyaWFsUGFzczsiXX0=