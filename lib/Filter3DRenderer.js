var Event = require("awayjs-core/lib/events/Event");
var ContextGLBlendFactor = require("awayjs-stagegl/lib/base/ContextGLBlendFactor");
var ContextGLVertexBufferFormat = require("awayjs-stagegl/lib/base/ContextGLVertexBufferFormat");
var RTTBufferManager = require("awayjs-renderergl/lib/managers/RTTBufferManager");
/**
 * @class away.render.Filter3DRenderer
 */
var Filter3DRenderer = (function () {
    function Filter3DRenderer(stage) {
        var _this = this;
        this._filterSizesInvalid = true;
        this._onRTTResizeDelegate = function (event) { return _this.onRTTResize(event); };
        this._stage = stage;
        this._rttManager = RTTBufferManager.getInstance(stage);
        this._rttManager.addEventListener(Event.RESIZE, this._onRTTResizeDelegate);
    }
    Filter3DRenderer.prototype.onRTTResize = function (event) {
        this._filterSizesInvalid = true;
    };
    Object.defineProperty(Filter3DRenderer.prototype, "requireDepthRender", {
        get: function () {
            return this._requireDepthRender;
        },
        enumerable: true,
        configurable: true
    });
    Filter3DRenderer.prototype.getMainInputTexture = function (stage) {
        if (this._filterTasksInvalid) {
            this.updateFilterTasks(stage);
        }
        return this._mainInputTexture;
    };
    Object.defineProperty(Filter3DRenderer.prototype, "filters", {
        get: function () {
            return this._filters;
        },
        set: function (value) {
            this._filters = value;
            this._filterTasksInvalid = true;
            this._requireDepthRender = false;
            if (!this._filters) {
                return;
            }
            for (var i = 0; i < this._filters.length; ++i) {
                // TODO: check logic:
                // this._requireDepthRender ||=  Boolean ( this._filters[i].requireDepthRender )
                var s = this._filters[i];
                var b = (s.requireDepthRender == null) ? false : s.requireDepthRender;
                this._requireDepthRender = this._requireDepthRender || b;
            }
            this._filterSizesInvalid = true;
        },
        enumerable: true,
        configurable: true
    });
    Filter3DRenderer.prototype.updateFilterTasks = function (stage) {
        var len;
        if (this._filterSizesInvalid) {
            this.updateFilterSizes();
        }
        if (!this._filters) {
            this._tasks = null;
            return;
        }
        this._tasks = new Array();
        len = this._filters.length - 1;
        var filter;
        for (var i = 0; i <= len; ++i) {
            // make sure all internal tasks are linked together
            filter = this._filters[i];
            // TODO: check logic
            // filter.setRenderTargets(i == len? null : Filter3DBase(_filters[i + 1]).getMainInputTexture(stage), stage);
            filter.setRenderTargets(i == len ? null : this._filters[i + 1].getMainInputTexture(stage), stage);
            this._tasks = this._tasks.concat(filter.tasks);
        }
        this._mainInputTexture = this._filters[0].getMainInputTexture(stage);
    };
    Filter3DRenderer.prototype.render = function (stage, camera, depthTexture) {
        var len;
        var i;
        var task;
        var context = stage.context;
        var indexBuffer = this._rttManager.indexBuffer;
        var vertexBuffer = this._rttManager.renderToTextureVertexBuffer;
        if (!this._filters) {
            return;
        }
        if (this._filterSizesInvalid) {
            this.updateFilterSizes();
        }
        if (this._filterTasksInvalid) {
            this.updateFilterTasks(stage);
        }
        len = this._filters.length;
        for (i = 0; i < len; ++i) {
            this._filters[i].update(stage, camera);
        }
        len = this._tasks.length;
        if (len > 1) {
            context.setVertexBufferAt(0, vertexBuffer, 0, ContextGLVertexBufferFormat.FLOAT_2);
            context.setVertexBufferAt(1, vertexBuffer, 2, ContextGLVertexBufferFormat.FLOAT_2);
        }
        for (i = 0; i < len; ++i) {
            task = this._tasks[i];
            //stage.setRenderTarget(task.target); //TODO
            if (!task.target) {
                stage.scissorRect = null;
                vertexBuffer = this._rttManager.renderToScreenVertexBuffer;
                context.setVertexBufferAt(0, vertexBuffer, 0, ContextGLVertexBufferFormat.FLOAT_2);
                context.setVertexBufferAt(1, vertexBuffer, 2, ContextGLVertexBufferFormat.FLOAT_2);
            }
            context.setTextureAt(0, task.getMainInputTexture(stage));
            context.setProgram(task.getProgram(stage));
            context.clear(0.0, 0.0, 0.0, 0.0);
            task.activate(stage, camera, depthTexture);
            context.setBlendFactors(ContextGLBlendFactor.ONE, ContextGLBlendFactor.ZERO);
            context.drawTriangles(indexBuffer, 0, 2);
            task.deactivate(stage);
        }
        context.setTextureAt(0, null);
        context.setVertexBufferAt(0, null);
        context.setVertexBufferAt(1, null);
    };
    Filter3DRenderer.prototype.updateFilterSizes = function () {
        for (var i = 0; i < this._filters.length; ++i) {
            this._filters[i].textureWidth = this._rttManager.textureWidth;
            this._filters[i].textureHeight = this._rttManager.textureHeight;
        }
        this._filterSizesInvalid = true;
    };
    Filter3DRenderer.prototype.dispose = function () {
        this._rttManager.removeEventListener(Event.RESIZE, this._onRTTResizeDelegate);
        this._rttManager = null;
        this._stage = null;
    };
    return Filter3DRenderer;
})();
module.exports = Filter3DRenderer;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9GaWx0ZXIzRFJlbmRlcmVyLnRzIl0sIm5hbWVzIjpbIkZpbHRlcjNEUmVuZGVyZXIiLCJGaWx0ZXIzRFJlbmRlcmVyLmNvbnN0cnVjdG9yIiwiRmlsdGVyM0RSZW5kZXJlci5vblJUVFJlc2l6ZSIsIkZpbHRlcjNEUmVuZGVyZXIucmVxdWlyZURlcHRoUmVuZGVyIiwiRmlsdGVyM0RSZW5kZXJlci5nZXRNYWluSW5wdXRUZXh0dXJlIiwiRmlsdGVyM0RSZW5kZXJlci5maWx0ZXJzIiwiRmlsdGVyM0RSZW5kZXJlci51cGRhdGVGaWx0ZXJUYXNrcyIsIkZpbHRlcjNEUmVuZGVyZXIucmVuZGVyIiwiRmlsdGVyM0RSZW5kZXJlci51cGRhdGVGaWx0ZXJTaXplcyIsIkZpbHRlcjNEUmVuZGVyZXIuZGlzcG9zZSJdLCJtYXBwaW5ncyI6IkFBQUEsSUFBTyxLQUFLLFdBQWdCLDhCQUE4QixDQUFDLENBQUM7QUFLNUQsSUFBTyxvQkFBb0IsV0FBYSw4Q0FBOEMsQ0FBQyxDQUFDO0FBQ3hGLElBQU8sMkJBQTJCLFdBQVcscURBQXFELENBQUMsQ0FBQztBQU1wRyxJQUFPLGdCQUFnQixXQUFjLGlEQUFpRCxDQUFDLENBQUM7QUFJeEYsQUFHQTs7R0FERztJQUNHLGdCQUFnQjtJQVlyQkEsU0FaS0EsZ0JBQWdCQSxDQVlUQSxLQUFXQTtRQVp4QkMsaUJBME1DQTtRQWpNUUEsd0JBQW1CQSxHQUFXQSxJQUFJQSxDQUFDQTtRQUsxQ0EsSUFBSUEsQ0FBQ0Esb0JBQW9CQSxHQUFHQSxVQUFDQSxLQUFXQSxJQUFLQSxPQUFBQSxLQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxLQUFLQSxDQUFDQSxFQUF2QkEsQ0FBdUJBLENBQUNBO1FBRXJFQSxJQUFJQSxDQUFDQSxNQUFNQSxHQUFHQSxLQUFLQSxDQUFDQTtRQUNwQkEsSUFBSUEsQ0FBQ0EsV0FBV0EsR0FBR0EsZ0JBQWdCQSxDQUFDQSxXQUFXQSxDQUFDQSxLQUFLQSxDQUFDQSxDQUFDQTtRQUN2REEsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxLQUFLQSxDQUFDQSxNQUFNQSxFQUFFQSxJQUFJQSxDQUFDQSxvQkFBb0JBLENBQUNBLENBQUNBO0lBRTVFQSxDQUFDQTtJQUVPRCxzQ0FBV0EsR0FBbkJBLFVBQW9CQSxLQUFXQTtRQUU5QkUsSUFBSUEsQ0FBQ0EsbUJBQW1CQSxHQUFHQSxJQUFJQSxDQUFDQTtJQUNqQ0EsQ0FBQ0E7SUFFREYsc0JBQVdBLGdEQUFrQkE7YUFBN0JBO1lBRUNHLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLG1CQUFtQkEsQ0FBQ0E7UUFDakNBLENBQUNBOzs7T0FBQUg7SUFFTUEsOENBQW1CQSxHQUExQkEsVUFBMkJBLEtBQVdBO1FBRXJDSSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxtQkFBbUJBLENBQUNBLENBQUNBLENBQUNBO1lBRTlCQSxJQUFJQSxDQUFDQSxpQkFBaUJBLENBQUNBLEtBQUtBLENBQUNBLENBQUNBO1FBRS9CQSxDQUFDQTtRQUVEQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxpQkFBaUJBLENBQUNBO0lBQy9CQSxDQUFDQTtJQUVESixzQkFBV0EscUNBQU9BO2FBQWxCQTtZQUVDSyxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQTtRQUN0QkEsQ0FBQ0E7YUFFREwsVUFBbUJBLEtBQW9CQTtZQUV0Q0ssSUFBSUEsQ0FBQ0EsUUFBUUEsR0FBR0EsS0FBS0EsQ0FBQ0E7WUFFdEJBLElBQUlBLENBQUNBLG1CQUFtQkEsR0FBR0EsSUFBSUEsQ0FBQ0E7WUFFaENBLElBQUlBLENBQUNBLG1CQUFtQkEsR0FBR0EsS0FBS0EsQ0FBQ0E7WUFFakNBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLFFBQVFBLENBQUNBLENBQUNBLENBQUNBO2dCQUVwQkEsTUFBTUEsQ0FBQ0E7WUFFUkEsQ0FBQ0E7WUFFREEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBVUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsTUFBTUEsRUFBRUEsRUFBRUEsQ0FBQ0EsRUFBRUEsQ0FBQ0E7Z0JBRXREQSxBQUdBQSxxQkFIcUJBO2dCQUNyQkEsZ0ZBQWdGQTtvQkFFNUVBLENBQUNBLEdBQU9BLElBQUlBLENBQUNBLFFBQVFBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO2dCQUM3QkEsSUFBSUEsQ0FBQ0EsR0FBcUJBLENBQUVBLENBQUNBLENBQUNBLGtCQUFrQkEsSUFBSUEsSUFBSUEsQ0FBRUEsR0FBRUEsS0FBS0EsR0FBR0EsQ0FBQ0EsQ0FBQ0Esa0JBQWtCQSxDQUFDQTtnQkFFekZBLElBQUlBLENBQUNBLG1CQUFtQkEsR0FBR0EsSUFBSUEsQ0FBQ0EsbUJBQW1CQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUUxREEsQ0FBQ0E7WUFFREEsSUFBSUEsQ0FBQ0EsbUJBQW1CQSxHQUFHQSxJQUFJQSxDQUFDQTtRQUVqQ0EsQ0FBQ0E7OztPQTlCQUw7SUFnQ09BLDRDQUFpQkEsR0FBekJBLFVBQTBCQSxLQUFXQTtRQUVwQ00sSUFBSUEsR0FBVUEsQ0FBQ0E7UUFFZkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsbUJBQW1CQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUU5QkEsSUFBSUEsQ0FBQ0EsaUJBQWlCQSxFQUFFQSxDQUFDQTtRQUUxQkEsQ0FBQ0E7UUFFREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDcEJBLElBQUlBLENBQUNBLE1BQU1BLEdBQUdBLElBQUlBLENBQUNBO1lBQ25CQSxNQUFNQSxDQUFDQTtRQUNSQSxDQUFDQTtRQUVEQSxJQUFJQSxDQUFDQSxNQUFNQSxHQUFHQSxJQUFJQSxLQUFLQSxFQUFvQkEsQ0FBQ0E7UUFFNUNBLEdBQUdBLEdBQUdBLElBQUlBLENBQUNBLFFBQVFBLENBQUNBLE1BQU1BLEdBQUdBLENBQUNBLENBQUNBO1FBRS9CQSxJQUFJQSxNQUFtQkEsQ0FBQ0E7UUFFeEJBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEdBQVVBLENBQUNBLEVBQUVBLENBQUNBLElBQUlBLEdBQUdBLEVBQUVBLEVBQUVBLENBQUNBLEVBQUVBLENBQUNBO1lBRXRDQSxBQUNBQSxtREFEbURBO1lBQ25EQSxNQUFNQSxHQUFHQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUUxQkEsQUFHQUEsb0JBSG9CQTtZQUNwQkEsNkdBQTZHQTtZQUU3R0EsTUFBTUEsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxDQUFDQSxJQUFJQSxHQUFHQSxHQUFFQSxJQUFJQSxHQUFHQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQSxtQkFBbUJBLENBQUNBLEtBQUtBLENBQUNBLEVBQUVBLEtBQUtBLENBQUNBLENBQUNBO1lBRWpHQSxJQUFJQSxDQUFDQSxNQUFNQSxHQUFHQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxNQUFNQSxDQUFDQSxNQUFNQSxDQUFDQSxLQUFLQSxDQUFDQSxDQUFDQTtRQUVoREEsQ0FBQ0E7UUFFREEsSUFBSUEsQ0FBQ0EsaUJBQWlCQSxHQUFHQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxtQkFBbUJBLENBQUNBLEtBQUtBLENBQUNBLENBQUNBO0lBRXRFQSxDQUFDQTtJQUVNTixpQ0FBTUEsR0FBYkEsVUFBY0EsS0FBV0EsRUFBRUEsTUFBYUEsRUFBRUEsWUFBcUJBO1FBRTlETyxJQUFJQSxHQUFVQSxDQUFDQTtRQUNmQSxJQUFJQSxDQUFRQSxDQUFDQTtRQUNiQSxJQUFJQSxJQUFxQkEsQ0FBQ0E7UUFDMUJBLElBQUlBLE9BQU9BLEdBQTJCQSxLQUFLQSxDQUFDQSxPQUFPQSxDQUFDQTtRQUVwREEsSUFBSUEsV0FBV0EsR0FBZ0JBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLFdBQVdBLENBQUNBO1FBRTVEQSxJQUFJQSxZQUFZQSxHQUFpQkEsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsMkJBQTJCQSxDQUFDQTtRQUU5RUEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDcEJBLE1BQU1BLENBQUNBO1FBQ1JBLENBQUNBO1FBRURBLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLG1CQUFtQkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDOUJBLElBQUlBLENBQUNBLGlCQUFpQkEsRUFBRUEsQ0FBQ0E7UUFDMUJBLENBQUNBO1FBRURBLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLG1CQUFtQkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDOUJBLElBQUlBLENBQUNBLGlCQUFpQkEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0E7UUFDL0JBLENBQUNBO1FBRURBLEdBQUdBLEdBQUdBLElBQUlBLENBQUNBLFFBQVFBLENBQUNBLE1BQU1BLENBQUNBO1FBRTNCQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxFQUFFQSxDQUFDQSxHQUFHQSxHQUFHQSxFQUFFQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQTtZQUMxQkEsSUFBSUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsS0FBS0EsRUFBRUEsTUFBTUEsQ0FBQ0EsQ0FBQ0E7UUFDeENBLENBQUNBO1FBRURBLEdBQUdBLEdBQUdBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLE1BQU1BLENBQUNBO1FBRXpCQSxFQUFFQSxDQUFDQSxDQUFDQSxHQUFHQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNiQSxPQUFPQSxDQUFDQSxpQkFBaUJBLENBQUNBLENBQUNBLEVBQUVBLFlBQVlBLEVBQUVBLENBQUNBLEVBQUVBLDJCQUEyQkEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0E7WUFDbkZBLE9BQU9BLENBQUNBLGlCQUFpQkEsQ0FBQ0EsQ0FBQ0EsRUFBRUEsWUFBWUEsRUFBRUEsQ0FBQ0EsRUFBRUEsMkJBQTJCQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQTtRQUNwRkEsQ0FBQ0E7UUFFREEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsR0FBR0EsRUFBRUEsRUFBRUEsQ0FBQ0EsRUFBRUEsQ0FBQ0E7WUFFMUJBLElBQUlBLEdBQUdBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1lBRXRCQSxBQUVBQSw0Q0FGNENBO1lBRTVDQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFFbEJBLEtBQUtBLENBQUNBLFdBQVdBLEdBQUdBLElBQUlBLENBQUNBO2dCQUN6QkEsWUFBWUEsR0FBR0EsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsMEJBQTBCQSxDQUFDQTtnQkFDM0RBLE9BQU9BLENBQUNBLGlCQUFpQkEsQ0FBQ0EsQ0FBQ0EsRUFBRUEsWUFBWUEsRUFBRUEsQ0FBQ0EsRUFBRUEsMkJBQTJCQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQTtnQkFDbkZBLE9BQU9BLENBQUNBLGlCQUFpQkEsQ0FBQ0EsQ0FBQ0EsRUFBRUEsWUFBWUEsRUFBRUEsQ0FBQ0EsRUFBRUEsMkJBQTJCQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQTtZQUVwRkEsQ0FBQ0E7WUFFREEsT0FBT0EsQ0FBQ0EsWUFBWUEsQ0FBQ0EsQ0FBQ0EsRUFBRUEsSUFBSUEsQ0FBQ0EsbUJBQW1CQSxDQUFDQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUN6REEsT0FBT0EsQ0FBQ0EsVUFBVUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDM0NBLE9BQU9BLENBQUNBLEtBQUtBLENBQUNBLEdBQUdBLEVBQUVBLEdBQUdBLEVBQUVBLEdBQUdBLEVBQUVBLEdBQUdBLENBQUNBLENBQUNBO1lBRWxDQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQSxLQUFLQSxFQUFFQSxNQUFNQSxFQUFFQSxZQUFZQSxDQUFDQSxDQUFDQTtZQUUzQ0EsT0FBT0EsQ0FBQ0EsZUFBZUEsQ0FBQ0Esb0JBQW9CQSxDQUFDQSxHQUFHQSxFQUFFQSxvQkFBb0JBLENBQUNBLElBQUlBLENBQUNBLENBQUNBO1lBQzdFQSxPQUFPQSxDQUFDQSxhQUFhQSxDQUFDQSxXQUFXQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUV6Q0EsSUFBSUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0E7UUFDeEJBLENBQUNBO1FBRURBLE9BQU9BLENBQUNBLFlBQVlBLENBQUNBLENBQUNBLEVBQUVBLElBQUlBLENBQUNBLENBQUNBO1FBQzlCQSxPQUFPQSxDQUFDQSxpQkFBaUJBLENBQUNBLENBQUNBLEVBQUVBLElBQUlBLENBQUNBLENBQUNBO1FBQ25DQSxPQUFPQSxDQUFDQSxpQkFBaUJBLENBQUNBLENBQUNBLEVBQUVBLElBQUlBLENBQUNBLENBQUNBO0lBQ3BDQSxDQUFDQTtJQUVPUCw0Q0FBaUJBLEdBQXpCQTtRQUVDUSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFVQSxDQUFDQSxFQUFFQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQSxNQUFNQSxFQUFFQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQTtZQUN0REEsSUFBSUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsWUFBWUEsR0FBR0EsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsWUFBWUEsQ0FBQ0E7WUFDOURBLElBQUlBLENBQUNBLFFBQVFBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLGFBQWFBLEdBQUdBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLGFBQWFBLENBQUNBO1FBQ2pFQSxDQUFDQTtRQUVEQSxJQUFJQSxDQUFDQSxtQkFBbUJBLEdBQUdBLElBQUlBLENBQUNBO0lBRWpDQSxDQUFDQTtJQUVNUixrQ0FBT0EsR0FBZEE7UUFFQ1MsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsbUJBQW1CQSxDQUFDQSxLQUFLQSxDQUFDQSxNQUFNQSxFQUFFQSxJQUFJQSxDQUFDQSxvQkFBb0JBLENBQUNBLENBQUNBO1FBQzlFQSxJQUFJQSxDQUFDQSxXQUFXQSxHQUFHQSxJQUFJQSxDQUFDQTtRQUN4QkEsSUFBSUEsQ0FBQ0EsTUFBTUEsR0FBR0EsSUFBSUEsQ0FBQ0E7SUFDcEJBLENBQUNBO0lBQ0ZULHVCQUFDQTtBQUFEQSxDQTFNQSxBQTBNQ0EsSUFBQTtBQUVELEFBQTBCLGlCQUFqQixnQkFBZ0IsQ0FBQyIsImZpbGUiOiJGaWx0ZXIzRFJlbmRlcmVyLmpzIiwic291cmNlUm9vdCI6Ii4uLyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBFdmVudFx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9ldmVudHMvRXZlbnRcIik7XHJcblxyXG5pbXBvcnQgQ2FtZXJhXHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL2VudGl0aWVzL0NhbWVyYVwiKTtcclxuXHJcbmltcG9ydCBTdGFnZVx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9iYXNlL1N0YWdlXCIpO1xyXG5pbXBvcnQgQ29udGV4dEdMQmxlbmRGYWN0b3JcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYmFzZS9Db250ZXh0R0xCbGVuZEZhY3RvclwiKTtcclxuaW1wb3J0IENvbnRleHRHTFZlcnRleEJ1ZmZlckZvcm1hdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2Jhc2UvQ29udGV4dEdMVmVydGV4QnVmZmVyRm9ybWF0XCIpO1xyXG5pbXBvcnQgSUNvbnRleHRHTFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYmFzZS9JQ29udGV4dEdMXCIpO1xyXG5pbXBvcnQgSUluZGV4QnVmZmVyXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9iYXNlL0lJbmRleEJ1ZmZlclwiKTtcclxuaW1wb3J0IElUZXh0dXJlXHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2Jhc2UvSVRleHR1cmVcIik7XHJcbmltcG9ydCBJVmVydGV4QnVmZmVyXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYmFzZS9JVmVydGV4QnVmZmVyXCIpO1xyXG5cclxuaW1wb3J0IFJUVEJ1ZmZlck1hbmFnZXJcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9tYW5hZ2Vycy9SVFRCdWZmZXJNYW5hZ2VyXCIpO1xyXG5pbXBvcnQgRmlsdGVyM0RCYXNlXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9maWx0ZXJzL0ZpbHRlcjNEQmFzZVwiKTtcclxuaW1wb3J0IEZpbHRlcjNEVGFza0Jhc2VcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9maWx0ZXJzL3Rhc2tzL0ZpbHRlcjNEVGFza0Jhc2VcIik7XHJcblxyXG4vKipcclxuICogQGNsYXNzIGF3YXkucmVuZGVyLkZpbHRlcjNEUmVuZGVyZXJcclxuICovXHJcbmNsYXNzIEZpbHRlcjNEUmVuZGVyZXJcclxue1xyXG5cdHByaXZhdGUgX2ZpbHRlcnM6QXJyYXk8RmlsdGVyM0RCYXNlPjtcclxuXHRwcml2YXRlIF90YXNrczpBcnJheTxGaWx0ZXIzRFRhc2tCYXNlPjtcclxuXHRwcml2YXRlIF9maWx0ZXJUYXNrc0ludmFsaWQ6Ym9vbGVhbjtcclxuXHRwcml2YXRlIF9tYWluSW5wdXRUZXh0dXJlOklUZXh0dXJlO1xyXG5cdHByaXZhdGUgX3JlcXVpcmVEZXB0aFJlbmRlcjpib29sZWFuO1xyXG5cdHByaXZhdGUgX3J0dE1hbmFnZXI6UlRUQnVmZmVyTWFuYWdlcjtcclxuXHRwcml2YXRlIF9zdGFnZTpTdGFnZTtcclxuXHRwcml2YXRlIF9maWx0ZXJTaXplc0ludmFsaWQ6Ym9vbGVhbiA9IHRydWU7XHJcblx0cHJpdmF0ZSBfb25SVFRSZXNpemVEZWxlZ2F0ZTooZXZlbnQ6RXZlbnQpID0+IHZvaWQ7XHJcblxyXG5cdGNvbnN0cnVjdG9yKHN0YWdlOlN0YWdlKVxyXG5cdHtcclxuXHRcdHRoaXMuX29uUlRUUmVzaXplRGVsZWdhdGUgPSAoZXZlbnQ6RXZlbnQpID0+IHRoaXMub25SVFRSZXNpemUoZXZlbnQpO1xyXG5cclxuXHRcdHRoaXMuX3N0YWdlID0gc3RhZ2U7XHJcblx0XHR0aGlzLl9ydHRNYW5hZ2VyID0gUlRUQnVmZmVyTWFuYWdlci5nZXRJbnN0YW5jZShzdGFnZSk7XHJcblx0XHR0aGlzLl9ydHRNYW5hZ2VyLmFkZEV2ZW50TGlzdGVuZXIoRXZlbnQuUkVTSVpFLCB0aGlzLl9vblJUVFJlc2l6ZURlbGVnYXRlKTtcclxuXHJcblx0fVxyXG5cclxuXHRwcml2YXRlIG9uUlRUUmVzaXplKGV2ZW50OkV2ZW50KVxyXG5cdHtcclxuXHRcdHRoaXMuX2ZpbHRlclNpemVzSW52YWxpZCA9IHRydWU7XHJcblx0fVxyXG5cclxuXHRwdWJsaWMgZ2V0IHJlcXVpcmVEZXB0aFJlbmRlcigpOmJvb2xlYW5cclxuXHR7XHJcblx0XHRyZXR1cm4gdGhpcy5fcmVxdWlyZURlcHRoUmVuZGVyO1xyXG5cdH1cclxuXHJcblx0cHVibGljIGdldE1haW5JbnB1dFRleHR1cmUoc3RhZ2U6U3RhZ2UpOklUZXh0dXJlXHJcblx0e1xyXG5cdFx0aWYgKHRoaXMuX2ZpbHRlclRhc2tzSW52YWxpZCkge1xyXG5cclxuXHRcdFx0dGhpcy51cGRhdGVGaWx0ZXJUYXNrcyhzdGFnZSk7XHJcblxyXG5cdFx0fVxyXG5cclxuXHRcdHJldHVybiB0aGlzLl9tYWluSW5wdXRUZXh0dXJlO1xyXG5cdH1cclxuXHJcblx0cHVibGljIGdldCBmaWx0ZXJzKCk6RmlsdGVyM0RCYXNlW11cclxuXHR7XHJcblx0XHRyZXR1cm4gdGhpcy5fZmlsdGVycztcclxuXHR9XHJcblxyXG5cdHB1YmxpYyBzZXQgZmlsdGVycyh2YWx1ZTpGaWx0ZXIzREJhc2VbXSlcclxuXHR7XHJcblx0XHR0aGlzLl9maWx0ZXJzID0gdmFsdWU7XHJcblxyXG5cdFx0dGhpcy5fZmlsdGVyVGFza3NJbnZhbGlkID0gdHJ1ZTtcclxuXHJcblx0XHR0aGlzLl9yZXF1aXJlRGVwdGhSZW5kZXIgPSBmYWxzZTtcclxuXHJcblx0XHRpZiAoIXRoaXMuX2ZpbHRlcnMpIHtcclxuXHJcblx0XHRcdHJldHVybjtcclxuXHJcblx0XHR9XHJcblxyXG5cdFx0Zm9yICh2YXIgaTpudW1iZXIgPSAwOyBpIDwgdGhpcy5fZmlsdGVycy5sZW5ndGg7ICsraSkge1xyXG5cclxuXHRcdFx0Ly8gVE9ETzogY2hlY2sgbG9naWM6XHJcblx0XHRcdC8vIHRoaXMuX3JlcXVpcmVEZXB0aFJlbmRlciB8fD0gIEJvb2xlYW4gKCB0aGlzLl9maWx0ZXJzW2ldLnJlcXVpcmVEZXB0aFJlbmRlciApXHJcblxyXG5cdFx0XHR2YXIgczphbnkgPSB0aGlzLl9maWx0ZXJzW2ldO1xyXG5cdFx0XHR2YXIgYjpib29sZWFuID0gPGJvb2xlYW4+ICggcy5yZXF1aXJlRGVwdGhSZW5kZXIgPT0gbnVsbCApPyBmYWxzZSA6IHMucmVxdWlyZURlcHRoUmVuZGVyO1xyXG5cclxuXHRcdFx0dGhpcy5fcmVxdWlyZURlcHRoUmVuZGVyID0gdGhpcy5fcmVxdWlyZURlcHRoUmVuZGVyIHx8IGI7XHJcblxyXG5cdFx0fVxyXG5cclxuXHRcdHRoaXMuX2ZpbHRlclNpemVzSW52YWxpZCA9IHRydWU7XHJcblxyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSB1cGRhdGVGaWx0ZXJUYXNrcyhzdGFnZTpTdGFnZSlcclxuXHR7XHJcblx0XHR2YXIgbGVuOm51bWJlcjtcclxuXHJcblx0XHRpZiAodGhpcy5fZmlsdGVyU2l6ZXNJbnZhbGlkKSB7XHJcblxyXG5cdFx0XHR0aGlzLnVwZGF0ZUZpbHRlclNpemVzKCk7XHJcblxyXG5cdFx0fVxyXG5cclxuXHRcdGlmICghdGhpcy5fZmlsdGVycykge1xyXG5cdFx0XHR0aGlzLl90YXNrcyA9IG51bGw7XHJcblx0XHRcdHJldHVybjtcclxuXHRcdH1cclxuXHJcblx0XHR0aGlzLl90YXNrcyA9IG5ldyBBcnJheTxGaWx0ZXIzRFRhc2tCYXNlPigpO1xyXG5cclxuXHRcdGxlbiA9IHRoaXMuX2ZpbHRlcnMubGVuZ3RoIC0gMTtcclxuXHJcblx0XHR2YXIgZmlsdGVyOkZpbHRlcjNEQmFzZTtcclxuXHJcblx0XHRmb3IgKHZhciBpOm51bWJlciA9IDA7IGkgPD0gbGVuOyArK2kpIHtcclxuXHJcblx0XHRcdC8vIG1ha2Ugc3VyZSBhbGwgaW50ZXJuYWwgdGFza3MgYXJlIGxpbmtlZCB0b2dldGhlclxyXG5cdFx0XHRmaWx0ZXIgPSB0aGlzLl9maWx0ZXJzW2ldO1xyXG5cclxuXHRcdFx0Ly8gVE9ETzogY2hlY2sgbG9naWNcclxuXHRcdFx0Ly8gZmlsdGVyLnNldFJlbmRlclRhcmdldHMoaSA9PSBsZW4/IG51bGwgOiBGaWx0ZXIzREJhc2UoX2ZpbHRlcnNbaSArIDFdKS5nZXRNYWluSW5wdXRUZXh0dXJlKHN0YWdlKSwgc3RhZ2UpO1xyXG5cclxuXHRcdFx0ZmlsdGVyLnNldFJlbmRlclRhcmdldHMoaSA9PSBsZW4/IG51bGwgOiB0aGlzLl9maWx0ZXJzW2kgKyAxXS5nZXRNYWluSW5wdXRUZXh0dXJlKHN0YWdlKSwgc3RhZ2UpO1xyXG5cclxuXHRcdFx0dGhpcy5fdGFza3MgPSB0aGlzLl90YXNrcy5jb25jYXQoZmlsdGVyLnRhc2tzKTtcclxuXHJcblx0XHR9XHJcblxyXG5cdFx0dGhpcy5fbWFpbklucHV0VGV4dHVyZSA9IHRoaXMuX2ZpbHRlcnNbMF0uZ2V0TWFpbklucHV0VGV4dHVyZShzdGFnZSk7XHJcblxyXG5cdH1cclxuXHJcblx0cHVibGljIHJlbmRlcihzdGFnZTpTdGFnZSwgY2FtZXJhOkNhbWVyYSwgZGVwdGhUZXh0dXJlOklUZXh0dXJlKVxyXG5cdHtcclxuXHRcdHZhciBsZW46bnVtYmVyO1xyXG5cdFx0dmFyIGk6bnVtYmVyO1xyXG5cdFx0dmFyIHRhc2s6RmlsdGVyM0RUYXNrQmFzZTtcclxuXHRcdHZhciBjb250ZXh0OklDb250ZXh0R0wgPSA8SUNvbnRleHRHTD4gc3RhZ2UuY29udGV4dDtcclxuXHJcblx0XHR2YXIgaW5kZXhCdWZmZXI6SUluZGV4QnVmZmVyID0gdGhpcy5fcnR0TWFuYWdlci5pbmRleEJ1ZmZlcjtcclxuXHJcblx0XHR2YXIgdmVydGV4QnVmZmVyOklWZXJ0ZXhCdWZmZXIgPSB0aGlzLl9ydHRNYW5hZ2VyLnJlbmRlclRvVGV4dHVyZVZlcnRleEJ1ZmZlcjtcclxuXHJcblx0XHRpZiAoIXRoaXMuX2ZpbHRlcnMpIHtcclxuXHRcdFx0cmV0dXJuO1xyXG5cdFx0fVxyXG5cclxuXHRcdGlmICh0aGlzLl9maWx0ZXJTaXplc0ludmFsaWQpIHtcclxuXHRcdFx0dGhpcy51cGRhdGVGaWx0ZXJTaXplcygpO1xyXG5cdFx0fVxyXG5cclxuXHRcdGlmICh0aGlzLl9maWx0ZXJUYXNrc0ludmFsaWQpIHtcclxuXHRcdFx0dGhpcy51cGRhdGVGaWx0ZXJUYXNrcyhzdGFnZSk7XHJcblx0XHR9XHJcblxyXG5cdFx0bGVuID0gdGhpcy5fZmlsdGVycy5sZW5ndGg7XHJcblxyXG5cdFx0Zm9yIChpID0gMDsgaSA8IGxlbjsgKytpKSB7XHJcblx0XHRcdHRoaXMuX2ZpbHRlcnNbaV0udXBkYXRlKHN0YWdlLCBjYW1lcmEpO1xyXG5cdFx0fVxyXG5cclxuXHRcdGxlbiA9IHRoaXMuX3Rhc2tzLmxlbmd0aDtcclxuXHJcblx0XHRpZiAobGVuID4gMSkge1xyXG5cdFx0XHRjb250ZXh0LnNldFZlcnRleEJ1ZmZlckF0KDAsIHZlcnRleEJ1ZmZlciwgMCwgQ29udGV4dEdMVmVydGV4QnVmZmVyRm9ybWF0LkZMT0FUXzIpO1xyXG5cdFx0XHRjb250ZXh0LnNldFZlcnRleEJ1ZmZlckF0KDEsIHZlcnRleEJ1ZmZlciwgMiwgQ29udGV4dEdMVmVydGV4QnVmZmVyRm9ybWF0LkZMT0FUXzIpO1xyXG5cdFx0fVxyXG5cclxuXHRcdGZvciAoaSA9IDA7IGkgPCBsZW47ICsraSkge1xyXG5cclxuXHRcdFx0dGFzayA9IHRoaXMuX3Rhc2tzW2ldO1xyXG5cclxuXHRcdFx0Ly9zdGFnZS5zZXRSZW5kZXJUYXJnZXQodGFzay50YXJnZXQpOyAvL1RPRE9cclxuXHJcblx0XHRcdGlmICghdGFzay50YXJnZXQpIHtcclxuXHJcblx0XHRcdFx0c3RhZ2Uuc2Npc3NvclJlY3QgPSBudWxsO1xyXG5cdFx0XHRcdHZlcnRleEJ1ZmZlciA9IHRoaXMuX3J0dE1hbmFnZXIucmVuZGVyVG9TY3JlZW5WZXJ0ZXhCdWZmZXI7XHJcblx0XHRcdFx0Y29udGV4dC5zZXRWZXJ0ZXhCdWZmZXJBdCgwLCB2ZXJ0ZXhCdWZmZXIsIDAsIENvbnRleHRHTFZlcnRleEJ1ZmZlckZvcm1hdC5GTE9BVF8yKTtcclxuXHRcdFx0XHRjb250ZXh0LnNldFZlcnRleEJ1ZmZlckF0KDEsIHZlcnRleEJ1ZmZlciwgMiwgQ29udGV4dEdMVmVydGV4QnVmZmVyRm9ybWF0LkZMT0FUXzIpO1xyXG5cclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0Y29udGV4dC5zZXRUZXh0dXJlQXQoMCwgdGFzay5nZXRNYWluSW5wdXRUZXh0dXJlKHN0YWdlKSk7XHJcblx0XHRcdGNvbnRleHQuc2V0UHJvZ3JhbSh0YXNrLmdldFByb2dyYW0oc3RhZ2UpKTtcclxuXHRcdFx0Y29udGV4dC5jbGVhcigwLjAsIDAuMCwgMC4wLCAwLjApO1xyXG5cclxuXHRcdFx0dGFzay5hY3RpdmF0ZShzdGFnZSwgY2FtZXJhLCBkZXB0aFRleHR1cmUpO1xyXG5cclxuXHRcdFx0Y29udGV4dC5zZXRCbGVuZEZhY3RvcnMoQ29udGV4dEdMQmxlbmRGYWN0b3IuT05FLCBDb250ZXh0R0xCbGVuZEZhY3Rvci5aRVJPKTtcclxuXHRcdFx0Y29udGV4dC5kcmF3VHJpYW5nbGVzKGluZGV4QnVmZmVyLCAwLCAyKTtcclxuXHJcblx0XHRcdHRhc2suZGVhY3RpdmF0ZShzdGFnZSk7XHJcblx0XHR9XHJcblxyXG5cdFx0Y29udGV4dC5zZXRUZXh0dXJlQXQoMCwgbnVsbCk7XHJcblx0XHRjb250ZXh0LnNldFZlcnRleEJ1ZmZlckF0KDAsIG51bGwpO1xyXG5cdFx0Y29udGV4dC5zZXRWZXJ0ZXhCdWZmZXJBdCgxLCBudWxsKTtcclxuXHR9XHJcblxyXG5cdHByaXZhdGUgdXBkYXRlRmlsdGVyU2l6ZXMoKVxyXG5cdHtcclxuXHRcdGZvciAodmFyIGk6bnVtYmVyID0gMDsgaSA8IHRoaXMuX2ZpbHRlcnMubGVuZ3RoOyArK2kpIHtcclxuXHRcdFx0dGhpcy5fZmlsdGVyc1tpXS50ZXh0dXJlV2lkdGggPSB0aGlzLl9ydHRNYW5hZ2VyLnRleHR1cmVXaWR0aDtcclxuXHRcdFx0dGhpcy5fZmlsdGVyc1tpXS50ZXh0dXJlSGVpZ2h0ID0gdGhpcy5fcnR0TWFuYWdlci50ZXh0dXJlSGVpZ2h0O1xyXG5cdFx0fVxyXG5cclxuXHRcdHRoaXMuX2ZpbHRlclNpemVzSW52YWxpZCA9IHRydWU7XHJcblxyXG5cdH1cclxuXHJcblx0cHVibGljIGRpc3Bvc2UoKVxyXG5cdHtcclxuXHRcdHRoaXMuX3J0dE1hbmFnZXIucmVtb3ZlRXZlbnRMaXN0ZW5lcihFdmVudC5SRVNJWkUsIHRoaXMuX29uUlRUUmVzaXplRGVsZWdhdGUpO1xyXG5cdFx0dGhpcy5fcnR0TWFuYWdlciA9IG51bGw7XHJcblx0XHR0aGlzLl9zdGFnZSA9IG51bGw7XHJcblx0fVxyXG59XHJcblxyXG5leHBvcnQgPSBGaWx0ZXIzRFJlbmRlcmVyOyJdfQ==