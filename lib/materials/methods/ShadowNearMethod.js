var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var ShadingMethodEvent = require("awayjs-stagegl/lib/events/ShadingMethodEvent");
var ShadowMethodBase = require("awayjs-stagegl/lib/materials/methods/ShadowMethodBase");
// TODO: shadow mappers references in materials should be an interface so that this class should NOT extend ShadowMapMethodBase just for some delegation work
/**
 * ShadowNearMethod provides a shadow map method that restricts the shadowed area near the camera to optimize
 * shadow map usage. This method needs to be used in conjunction with a NearDirectionalShadowMapper.
 *
 * @see away.lights.NearDirectionalShadowMapper
 */
var ShadowNearMethod = (function (_super) {
    __extends(ShadowNearMethod, _super);
    /**
     * Creates a new ShadowNearMethod object.
     * @param baseMethod The shadow map sampling method used to sample individual cascades (fe: ShadowHardMethod, ShadowSoftMethod)
     * @param fadeRatio The amount of shadow fading to the outer shadow area. A value of 1 would mean the shadows start fading from the camera's near plane.
     */
    function ShadowNearMethod(baseMethod, fadeRatio) {
        var _this = this;
        if (fadeRatio === void 0) { fadeRatio = .1; }
        _super.call(this, baseMethod.castingLight);
        this._onShaderInvalidatedDelegate = function (event) { return _this.onShaderInvalidated(event); };
        this._baseMethod = baseMethod;
        this._fadeRatio = fadeRatio;
        this._nearShadowMapper = this._pCastingLight.shadowMapper;
        if (!this._nearShadowMapper)
            throw new Error("ShadowNearMethod requires a light that has a NearDirectionalShadowMapper instance assigned to shadowMapper.");
        this._baseMethod.addEventListener(ShadingMethodEvent.SHADER_INVALIDATED, this._onShaderInvalidatedDelegate);
    }
    Object.defineProperty(ShadowNearMethod.prototype, "baseMethod", {
        /**
         * The base shadow map method on which this method's shading is based.
         */
        get: function () {
            return this._baseMethod;
        },
        set: function (value) {
            if (this._baseMethod == value)
                return;
            this._baseMethod.removeEventListener(ShadingMethodEvent.SHADER_INVALIDATED, this._onShaderInvalidatedDelegate);
            this._baseMethod = value;
            this._baseMethod.addEventListener(ShadingMethodEvent.SHADER_INVALIDATED, this._onShaderInvalidatedDelegate);
            this.iInvalidateShaderProgram();
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @inheritDoc
     */
    ShadowNearMethod.prototype.iInitConstants = function (shaderObject, methodVO) {
        _super.prototype.iInitConstants.call(this, shaderObject, methodVO);
        this._baseMethod.iInitConstants(shaderObject, methodVO);
        var fragmentData = shaderObject.fragmentConstantData;
        var index = methodVO.secondaryFragmentConstantsIndex;
        fragmentData[index + 2] = 0;
        fragmentData[index + 3] = 1;
    };
    /**
     * @inheritDoc
     */
    ShadowNearMethod.prototype.iInitVO = function (shaderObject, methodVO) {
        this._baseMethod.iInitVO(shaderObject, methodVO);
        methodVO.needsProjection = true;
    };
    /**
     * @inheritDoc
     */
    ShadowNearMethod.prototype.dispose = function () {
        this._baseMethod.removeEventListener(ShadingMethodEvent.SHADER_INVALIDATED, this._onShaderInvalidatedDelegate);
    };
    Object.defineProperty(ShadowNearMethod.prototype, "alpha", {
        /**
         * @inheritDoc
         */
        get: function () {
            return this._baseMethod.alpha;
        },
        set: function (value) {
            this._baseMethod.alpha = value;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ShadowNearMethod.prototype, "epsilon", {
        /**
         * @inheritDoc
         */
        get: function () {
            return this._baseMethod.epsilon;
        },
        set: function (value) {
            this._baseMethod.epsilon = value;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ShadowNearMethod.prototype, "fadeRatio", {
        /**
         * The amount of shadow fading to the outer shadow area. A value of 1 would mean the shadows start fading from the camera's near plane.
         */
        get: function () {
            return this._fadeRatio;
        },
        set: function (value) {
            this._fadeRatio = value;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @inheritDoc
     */
    ShadowNearMethod.prototype.iGetFragmentCode = function (shaderObject, methodVO, targetReg, registerCache, sharedRegisters) {
        var code = this._baseMethod.iGetFragmentCode(shaderObject, methodVO, targetReg, registerCache, sharedRegisters);
        var dataReg = registerCache.getFreeFragmentConstant();
        var temp = registerCache.getFreeFragmentSingleTemp();
        methodVO.secondaryFragmentConstantsIndex = dataReg.index * 4;
        code += "abs " + temp + ", " + sharedRegisters.projectionFragment + ".w\n" + "sub " + temp + ", " + temp + ", " + dataReg + ".x\n" + "mul " + temp + ", " + temp + ", " + dataReg + ".y\n" + "sat " + temp + ", " + temp + "\n" + "sub " + temp + ", " + dataReg + ".w," + temp + "\n" + "sub " + targetReg + ".w, " + dataReg + ".w," + targetReg + ".w\n" + "mul " + targetReg + ".w, " + targetReg + ".w, " + temp + "\n" + "sub " + targetReg + ".w, " + dataReg + ".w," + targetReg + ".w\n";
        return code;
    };
    /**
     * @inheritDoc
     */
    ShadowNearMethod.prototype.iActivate = function (shaderObject, methodVO, stage) {
        this._baseMethod.iActivate(shaderObject, methodVO, stage);
    };
    /**
     * @inheritDoc
     */
    ShadowNearMethod.prototype.iDeactivate = function (shaderObject, methodVO, stage) {
        this._baseMethod.iDeactivate(shaderObject, methodVO, stage);
    };
    /**
     * @inheritDoc
     */
    ShadowNearMethod.prototype.iSetRenderState = function (shaderObject, methodVO, renderable, stage, camera) {
        // todo: move this to activate (needs camera)
        var near = camera.projection.near;
        var d = camera.projection.far - near;
        var maxDistance = this._nearShadowMapper.coverageRatio;
        var minDistance = maxDistance * (1 - this._fadeRatio);
        maxDistance = near + maxDistance * d;
        minDistance = near + minDistance * d;
        var fragmentData = shaderObject.fragmentConstantData;
        var index = methodVO.secondaryFragmentConstantsIndex;
        fragmentData[index] = minDistance;
        fragmentData[index + 1] = 1 / (maxDistance - minDistance);
        this._baseMethod.iSetRenderState(shaderObject, methodVO, renderable, stage, camera);
    };
    /**
     * @inheritDoc
     */
    ShadowNearMethod.prototype.iGetVertexCode = function (shaderObject, methodVO, registerCache, sharedRegisters) {
        return this._baseMethod.iGetVertexCode(shaderObject, methodVO, registerCache, sharedRegisters);
    };
    /**
     * @inheritDoc
     */
    ShadowNearMethod.prototype.iReset = function () {
        this._baseMethod.iReset();
    };
    /**
     * @inheritDoc
     */
    ShadowNearMethod.prototype.iCleanCompilationData = function () {
        _super.prototype.iCleanCompilationData.call(this);
        this._baseMethod.iCleanCompilationData();
    };
    /**
     * Called when the base method's shader code is invalidated.
     */
    ShadowNearMethod.prototype.onShaderInvalidated = function (event) {
        this.iInvalidateShaderProgram();
    };
    return ShadowNearMethod;
})(ShadowMethodBase);
module.exports = ShadowNearMethod;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1hdGVyaWFscy9tZXRob2RzL3NoYWRvd25lYXJtZXRob2QudHMiXSwibmFtZXMiOlsiU2hhZG93TmVhck1ldGhvZCIsIlNoYWRvd05lYXJNZXRob2QuY29uc3RydWN0b3IiLCJTaGFkb3dOZWFyTWV0aG9kLmJhc2VNZXRob2QiLCJTaGFkb3dOZWFyTWV0aG9kLmlJbml0Q29uc3RhbnRzIiwiU2hhZG93TmVhck1ldGhvZC5pSW5pdFZPIiwiU2hhZG93TmVhck1ldGhvZC5kaXNwb3NlIiwiU2hhZG93TmVhck1ldGhvZC5hbHBoYSIsIlNoYWRvd05lYXJNZXRob2QuZXBzaWxvbiIsIlNoYWRvd05lYXJNZXRob2QuZmFkZVJhdGlvIiwiU2hhZG93TmVhck1ldGhvZC5pR2V0RnJhZ21lbnRDb2RlIiwiU2hhZG93TmVhck1ldGhvZC5pQWN0aXZhdGUiLCJTaGFkb3dOZWFyTWV0aG9kLmlEZWFjdGl2YXRlIiwiU2hhZG93TmVhck1ldGhvZC5pU2V0UmVuZGVyU3RhdGUiLCJTaGFkb3dOZWFyTWV0aG9kLmlHZXRWZXJ0ZXhDb2RlIiwiU2hhZG93TmVhck1ldGhvZC5pUmVzZXQiLCJTaGFkb3dOZWFyTWV0aG9kLmlDbGVhbkNvbXBpbGF0aW9uRGF0YSIsIlNoYWRvd05lYXJNZXRob2Qub25TaGFkZXJJbnZhbGlkYXRlZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBS0EsSUFBTyxrQkFBa0IsV0FBYyw4Q0FBOEMsQ0FBQyxDQUFDO0FBT3ZGLElBQU8sZ0JBQWdCLFdBQWUsdURBQXVELENBQUMsQ0FBQztBQUUvRixBQU9BLDZKQVA2SjtBQUM3Sjs7Ozs7R0FLRztJQUNHLGdCQUFnQjtJQUFTQSxVQUF6QkEsZ0JBQWdCQSxVQUF5QkE7SUFTOUNBOzs7O09BSUdBO0lBQ0hBLFNBZEtBLGdCQUFnQkEsQ0FjVEEsVUFBMkJBLEVBQUVBLFNBQXFCQTtRQWQvREMsaUJBc05DQTtRQXhNeUNBLHlCQUFxQkEsR0FBckJBLGNBQXFCQTtRQUU3REEsa0JBQU1BLFVBQVVBLENBQUNBLFlB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ZXJzL3JvYmJhdGVtYW4vV2Vic3Rvcm1Qcm9qZWN0cy9hd2F5anMtcmVuZGVyZXJnbC8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgTmVhckRpcmVjdGlvbmFsU2hhZG93TWFwcGVyXHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9tYXRlcmlhbHMvc2hhZG93bWFwcGVycy9OZWFyRGlyZWN0aW9uYWxTaGFkb3dNYXBwZXJcIik7XG5pbXBvcnQgQ2FtZXJhXHRcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvZW50aXRpZXMvQ2FtZXJhXCIpO1xuXG5pbXBvcnQgU3RhZ2VcdFx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9jb3JlL2Jhc2UvU3RhZ2VcIik7XG5pbXBvcnQgUmVuZGVyYWJsZUJhc2VcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2NvcmUvcG9vbC9SZW5kZXJhYmxlQmFzZVwiKTtcbmltcG9ydCBTaGFkaW5nTWV0aG9kRXZlbnRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9ldmVudHMvU2hhZGluZ01ldGhvZEV2ZW50XCIpO1xuaW1wb3J0IE1ldGhvZFZPXHRcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvbWF0ZXJpYWxzL2NvbXBpbGF0aW9uL01ldGhvZFZPXCIpO1xuaW1wb3J0IFNoYWRlckxpZ2h0aW5nT2JqZWN0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvbWF0ZXJpYWxzL2NvbXBpbGF0aW9uL1NoYWRlckxpZ2h0aW5nT2JqZWN0XCIpO1xuaW1wb3J0IFNoYWRlck9iamVjdEJhc2VcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL21hdGVyaWFscy9jb21waWxhdGlvbi9TaGFkZXJPYmplY3RCYXNlXCIpO1xuaW1wb3J0IFNoYWRlclJlZ2lzdGVyQ2FjaGVcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9tYXRlcmlhbHMvY29tcGlsYXRpb24vU2hhZGVyUmVnaXN0ZXJDYWNoZVwiKTtcbmltcG9ydCBTaGFkZXJSZWdpc3RlckRhdGFcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9tYXRlcmlhbHMvY29tcGlsYXRpb24vU2hhZGVyUmVnaXN0ZXJEYXRhXCIpO1xuaW1wb3J0IFNoYWRlclJlZ2lzdGVyRWxlbWVudFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9tYXRlcmlhbHMvY29tcGlsYXRpb24vU2hhZGVyUmVnaXN0ZXJFbGVtZW50XCIpO1xuaW1wb3J0IFNoYWRvd01ldGhvZEJhc2VcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL21hdGVyaWFscy9tZXRob2RzL1NoYWRvd01ldGhvZEJhc2VcIik7XG5cbi8vIFRPRE86IHNoYWRvdyBtYXBwZXJzIHJlZmVyZW5jZXMgaW4gbWF0ZXJpYWxzIHNob3VsZCBiZSBhbiBpbnRlcmZhY2Ugc28gdGhhdCB0aGlzIGNsYXNzIHNob3VsZCBOT1QgZXh0ZW5kIFNoYWRvd01hcE1ldGhvZEJhc2UganVzdCBmb3Igc29tZSBkZWxlZ2F0aW9uIHdvcmtcbi8qKlxuICogU2hhZG93TmVhck1ldGhvZCBwcm92aWRlcyBhIHNoYWRvdyBtYXAgbWV0aG9kIHRoYXQgcmVzdHJpY3RzIHRoZSBzaGFkb3dlZCBhcmVhIG5lYXIgdGhlIGNhbWVyYSB0byBvcHRpbWl6ZVxuICogc2hhZG93IG1hcCB1c2FnZS4gVGhpcyBtZXRob2QgbmVlZHMgdG8gYmUgdXNlZCBpbiBjb25qdW5jdGlvbiB3aXRoIGEgTmVhckRpcmVjdGlvbmFsU2hhZG93TWFwcGVyLlxuICpcbiAqIEBzZWUgYXdheS5saWdodHMuTmVhckRpcmVjdGlvbmFsU2hhZG93TWFwcGVyXG4gKi9cbmNsYXNzIFNoYWRvd05lYXJNZXRob2QgZXh0ZW5kcyBTaGFkb3dNZXRob2RCYXNlXG57XG5cdHByaXZhdGUgX2Jhc2VNZXRob2Q6U2hhZG93TWV0aG9kQmFzZTtcblxuXHRwcml2YXRlIF9mYWRlUmF0aW86bnVtYmVyO1xuXHRwcml2YXRlIF9uZWFyU2hhZG93TWFwcGVyOk5lYXJEaXJlY3Rpb25hbFNoYWRvd01hcHBlcjtcblxuXHRwcml2YXRlIF9vblNoYWRlckludmFsaWRhdGVkRGVsZWdhdGU6RnVuY3Rpb247XG5cblx0LyoqXG5cdCAqIENyZWF0ZXMgYSBuZXcgU2hhZG93TmVhck1ldGhvZCBvYmplY3QuXG5cdCAqIEBwYXJhbSBiYXNlTWV0aG9kIFRoZSBzaGFkb3cgbWFwIHNhbXBsaW5nIG1ldGhvZCB1c2VkIHRvIHNhbXBsZSBpbmRpdmlkdWFsIGNhc2NhZGVzIChmZTogU2hhZG93SGFyZE1ldGhvZCwgU2hhZG93U29mdE1ldGhvZClcblx0ICogQHBhcmFtIGZhZGVSYXRpbyBUaGUgYW1vdW50IG9mIHNoYWRvdyBmYWRpbmcgdG8gdGhlIG91dGVyIHNoYWRvdyBhcmVhLiBBIHZhbHVlIG9mIDEgd291bGQgbWVhbiB0aGUgc2hhZG93cyBzdGFydCBmYWRpbmcgZnJvbSB0aGUgY2FtZXJhJ3MgbmVhciBwbGFuZS5cblx0ICovXG5cdGNvbnN0cnVjdG9yKGJhc2VNZXRob2Q6U2hhZG93TWV0aG9kQmFzZSwgZmFkZVJhdGlvOm51bWJlciA9IC4xKVxuXHR7XG5cdFx0c3VwZXIoYmFzZU1ldGhvZC5jYXN0aW5nTGlnaHQpO1xuXG5cdFx0dGhpcy5fb25TaGFkZXJJbnZhbGlkYXRlZERlbGVnYXRlID0gKGV2ZW50OlNoYWRpbmdNZXRob2RFdmVudCkgPT4gdGhpcy5vblNoYWRlckludmFsaWRhdGVkKGV2ZW50KTtcblxuXHRcdHRoaXMuX2Jhc2VNZXRob2QgPSBiYXNlTWV0aG9kO1xuXHRcdHRoaXMuX2ZhZGVSYXRpbyA9IGZhZGVSYXRpbztcblx0XHR0aGlzLl9uZWFyU2hhZG93TWFwcGVyID0gPE5lYXJEaXJlY3Rpb25hbFNoYWRvd01hcHBlcj4gdGhpcy5fcENhc3RpbmdMaWdodC5zaGFkb3dNYXBwZXI7XG5cdFx0aWYgKCF0aGlzLl9uZWFyU2hhZG93TWFwcGVyKVxuXHRcdFx0dGhyb3cgbmV3IEVycm9yKFwiU2hhZG93TmVhck1ldGhvZCByZXF1aXJlcyBhIGxpZ2h0IHRoYXQgaGFzIGEgTmVhckRpcmVjdGlvbmFsU2hhZG93TWFwcGVyIGluc3RhbmNlIGFzc2lnbmVkIHRvIHNoYWRvd01hcHBlci5cIik7XG5cdFx0dGhpcy5fYmFzZU1ldGhvZC5hZGRFdmVudExpc3RlbmVyKFNoYWRpbmdNZXRob2RFdmVudC5TSEFERVJfSU5WQUxJREFURUQsIHRoaXMuX29uU2hhZGVySW52YWxpZGF0ZWREZWxlZ2F0ZSk7XG5cdH1cblxuXHQvKipcblx0ICogVGhlIGJhc2Ugc2hhZG93IG1hcCBtZXRob2Qgb24gd2hpY2ggdGhpcyBtZXRob2QncyBzaGFkaW5nIGlzIGJhc2VkLlxuXHQgKi9cblx0cHVibGljIGdldCBiYXNlTWV0aG9kKCk6U2hhZG93TWV0aG9kQmFzZVxuXHR7XG5cdFx0cmV0dXJuIHRoaXMuX2Jhc2VNZXRob2Q7XG5cdH1cblxuXHRwdWJsaWMgc2V0IGJhc2VNZXRob2QodmFsdWU6U2hhZG93TWV0aG9kQmFzZSlcblx0e1xuXHRcdGlmICh0aGlzLl9iYXNlTWV0aG9kID09IHZhbHVlKVxuXHRcdFx0cmV0dXJuO1xuXG5cdFx0dGhpcy5fYmFzZU1ldGhvZC5yZW1vdmVFdmVudExpc3RlbmVyKFNoYWRpbmdNZXRob2RFdmVudC5TSEFERVJfSU5WQUxJREFURUQsIHRoaXMuX29uU2hhZGVySW52YWxpZGF0ZWREZWxlZ2F0ZSk7XG5cblx0XHR0aGlzLl9iYXNlTWV0aG9kID0gdmFsdWU7XG5cblx0XHR0aGlzLl9iYXNlTWV0aG9kLmFkZEV2ZW50TGlzdGVuZXIoU2hhZGluZ01ldGhvZEV2ZW50LlNIQURFUl9JTlZBTElEQVRFRCwgdGhpcy5fb25TaGFkZXJJbnZhbGlkYXRlZERlbGVnYXRlKTtcblxuXHRcdHRoaXMuaUludmFsaWRhdGVTaGFkZXJQcm9ncmFtKCk7XG5cdH1cblxuXHQvKipcblx0ICogQGluaGVyaXREb2Ncblx0ICovXG5cdHB1YmxpYyBpSW5pdENvbnN0YW50cyhzaGFkZXJPYmplY3Q6U2hhZGVyT2JqZWN0QmFzZSwgbWV0aG9kVk86TWV0aG9kVk8pXG5cdHtcblx0XHRzdXBlci5pSW5pdENvbnN0YW50cyhzaGFkZXJPYmplY3QsIG1ldGhvZFZPKTtcblx0XHR0aGlzLl9iYXNlTWV0aG9kLmlJbml0Q29uc3RhbnRzKHNoYWRlck9iamVjdCwgbWV0aG9kVk8pO1xuXG5cdFx0dmFyIGZyYWdtZW50RGF0YTpBcnJheTxudW1iZXI+ID0gc2hhZGVyT2JqZWN0LmZyYWdtZW50Q29uc3RhbnREYXRhO1xuXHRcdHZhciBpbmRleDpudW1iZXIgLyppbnQqLyA9IG1ldGhvZFZPLnNlY29uZGFyeUZyYWdtZW50Q29uc3RhbnRzSW5kZXg7XG5cdFx0ZnJhZ21lbnREYXRhW2luZGV4ICsgMl0gPSAwO1xuXHRcdGZyYWdtZW50RGF0YVtpbmRleCArIDNdID0gMTtcblx0fVxuXG5cdC8qKlxuXHQgKiBAaW5oZXJpdERvY1xuXHQgKi9cblx0cHVibGljIGlJbml0Vk8oc2hhZGVyT2JqZWN0OlNoYWRlckxpZ2h0aW5nT2JqZWN0LCBtZXRob2RWTzpNZXRob2RWTylcblx0e1xuXHRcdHRoaXMuX2Jhc2VNZXRob2QuaUluaXRWTyhzaGFkZXJPYmplY3QsIG1ldGhvZFZPKTtcblxuXHRcdG1ldGhvZFZPLm5lZWRzUHJvamVjdGlvbiA9IHRydWU7XG5cdH1cblxuXHQvKipcblx0ICogQGluaGVyaXREb2Ncblx0ICovXG5cdHB1YmxpYyBkaXNwb3NlKClcblx0e1xuXHRcdHRoaXMuX2Jhc2VNZXRob2QucmVtb3ZlRXZlbnRMaXN0ZW5lcihTaGFkaW5nTWV0aG9kRXZlbnQuU0hBREVSX0lOVkFMSURBVEVELCB0aGlzLl9vblNoYWRlckludmFsaWRhdGVkRGVsZWdhdGUpO1xuXHR9XG5cblx0LyoqXG5cdCAqIEBpbmhlcml0RG9jXG5cdCAqL1xuXHRwdWJsaWMgZ2V0IGFscGhhKCk6bnVtYmVyXG5cdHtcblx0XHRyZXR1cm4gdGhpcy5fYmFzZU1ldGhvZC5hbHBoYTtcblx0fVxuXG5cdHB1YmxpYyBzZXQgYWxwaGEodmFsdWU6bnVtYmVyKVxuXHR7XG5cdFx0dGhpcy5fYmFzZU1ldGhvZC5hbHBoYSA9IHZhbHVlO1xuXHR9XG5cblx0LyoqXG5cdCAqIEBpbmhlcml0RG9jXG5cdCAqL1xuXHRwdWJsaWMgZ2V0IGVwc2lsb24oKTpudW1iZXJcblx0e1xuXHRcdHJldHVybiB0aGlzLl9iYXNlTWV0aG9kLmVwc2lsb247XG5cdH1cblxuXHRwdWJsaWMgc2V0IGVwc2lsb24odmFsdWU6bnVtYmVyKVxuXHR7XG5cdFx0dGhpcy5fYmFzZU1ldGhvZC5lcHNpbG9uID0gdmFsdWU7XG5cdH1cblxuXHQvKipcblx0ICogVGhlIGFtb3VudCBvZiBzaGFkb3cgZmFkaW5nIHRvIHRoZSBvdXRlciBzaGFkb3cgYXJlYS4gQSB2YWx1ZSBvZiAxIHdvdWxkIG1lYW4gdGhlIHNoYWRvd3Mgc3RhcnQgZmFkaW5nIGZyb20gdGhlIGNhbWVyYSdzIG5lYXIgcGxhbmUuXG5cdCAqL1xuXHRwdWJsaWMgZ2V0IGZhZGVSYXRpbygpOm51bWJlclxuXHR7XG5cdFx0cmV0dXJuIHRoaXMuX2ZhZGVSYXRpbztcblx0fVxuXG5cdHB1YmxpYyBzZXQgZmFkZVJhdGlvKHZhbHVlOm51bWJlcilcblx0e1xuXHRcdHRoaXMuX2ZhZGVSYXRpbyA9IHZhbHVlO1xuXHR9XG5cblx0LyoqXG5cdCAqIEBpbmhlcml0RG9jXG5cdCAqL1xuXHRwdWJsaWMgaUdldEZyYWdtZW50Q29kZShzaGFkZXJPYmplY3Q6U2hhZGVyT2JqZWN0QmFzZSwgbWV0aG9kVk86TWV0aG9kVk8sIHRhcmdldFJlZzpTaGFkZXJSZWdpc3RlckVsZW1lbnQsIHJlZ2lzdGVyQ2FjaGU6U2hhZGVyUmVnaXN0ZXJDYWNoZSwgc2hhcmVkUmVnaXN0ZXJzOlNoYWRlclJlZ2lzdGVyRGF0YSk6c3RyaW5nXG5cdHtcblx0XHR2YXIgY29kZTpzdHJpbmcgPSB0aGlzLl9iYXNlTWV0aG9kLmlHZXRGcmFnbWVudENvZGUoc2hhZGVyT2JqZWN0LCBtZXRob2RWTywgdGFyZ2V0UmVnLCByZWdpc3RlckNhY2hlLCBzaGFyZWRSZWdpc3RlcnMpO1xuXG5cdFx0dmFyIGRhdGFSZWc6U2hhZGVyUmVnaXN0ZXJFbGVtZW50ID0gcmVnaXN0ZXJDYWNoZS5nZXRGcmVlRnJhZ21lbnRDb25zdGFudCgpO1xuXHRcdHZhciB0ZW1wOlNoYWRlclJlZ2lzdGVyRWxlbWVudCA9IHJlZ2lzdGVyQ2FjaGUuZ2V0RnJlZUZyYWdtZW50U2luZ2xlVGVtcCgpO1xuXHRcdG1ldGhvZFZPLnNlY29uZGFyeUZyYWdtZW50Q29uc3RhbnRzSW5kZXggPSBkYXRhUmVnLmluZGV4KjQ7XG5cblx0XHRjb2RlICs9IFwiYWJzIFwiICsgdGVtcCArIFwiLCBcIiArIHNoYXJlZFJlZ2lzdGVycy5wcm9qZWN0aW9uRnJhZ21lbnQgKyBcIi53XFxuXCIgK1xuXHRcdFx0XCJzdWIgXCIgKyB0ZW1wICsgXCIsIFwiICsgdGVtcCArIFwiLCBcIiArIGRhdGFSZWcgKyBcIi54XFxuXCIgK1xuXHRcdFx0XCJtdWwgXCIgKyB0ZW1wICsgXCIsIFwiICsgdGVtcCArIFwiLCBcIiArIGRhdGFSZWcgKyBcIi55XFxuXCIgK1xuXHRcdFx0XCJzYXQgXCIgKyB0ZW1wICsgXCIsIFwiICsgdGVtcCArIFwiXFxuXCIgK1xuXHRcdFx0XCJzdWIgXCIgKyB0ZW1wICsgXCIsIFwiICsgZGF0YVJlZyArIFwiLncsXCIgKyB0ZW1wICsgXCJcXG5cIiArXG5cdFx0XHRcInN1YiBcIiArIHRhcmdldFJlZyArIFwiLncsIFwiICsgZGF0YVJlZyArIFwiLncsXCIgKyB0YXJnZXRSZWcgKyBcIi53XFxuXCIgK1xuXHRcdFx0XCJtdWwgXCIgKyB0YXJnZXRSZWcgKyBcIi53LCBcIiArIHRhcmdldFJlZyArIFwiLncsIFwiICsgdGVtcCArIFwiXFxuXCIgK1xuXHRcdFx0XCJzdWIgXCIgKyB0YXJnZXRSZWcgKyBcIi53LCBcIiArIGRhdGFSZWcgKyBcIi53LFwiICsgdGFyZ2V0UmVnICsgXCIud1xcblwiO1xuXG5cdFx0cmV0dXJuIGNvZGU7XG5cdH1cblxuXHQvKipcblx0ICogQGluaGVyaXREb2Ncblx0ICovXG5cdHB1YmxpYyBpQWN0aXZhdGUoc2hhZGVyT2JqZWN0OlNoYWRlck9iamVjdEJhc2UsIG1ldGhvZFZPOk1ldGhvZFZPLCBzdGFnZTpTdGFnZSlcblx0e1xuXHRcdHRoaXMuX2Jhc2VNZXRob2QuaUFjdGl2YXRlKHNoYWRlck9iamVjdCwgbWV0aG9kVk8sIHN0YWdlKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBAaW5oZXJpdERvY1xuXHQgKi9cblx0cHVibGljIGlEZWFjdGl2YXRlKHNoYWRlck9iamVjdDpTaGFkZXJPYmplY3RCYXNlLCBtZXRob2RWTzpNZXRob2RWTywgc3RhZ2U6U3RhZ2UpXG5cdHtcblx0XHR0aGlzLl9iYXNlTWV0aG9kLmlEZWFjdGl2YXRlKHNoYWRlck9iamVjdCwgbWV0aG9kVk8sIHN0YWdlKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBAaW5oZXJpdERvY1xuXHQgKi9cblx0cHVibGljIGlTZXRSZW5kZXJTdGF0ZShzaGFkZXJPYmplY3Q6U2hhZGVyT2JqZWN0QmFzZSwgbWV0aG9kVk86TWV0aG9kVk8sIHJlbmRlcmFibGU6UmVuZGVyYWJsZUJhc2UsIHN0YWdlOlN0YWdlLCBjYW1lcmE6Q2FtZXJhKVxuXHR7XG5cdFx0Ly8gdG9kbzogbW92ZSB0aGlzIHRvIGFjdGl2YXRlIChuZWVkcyBjYW1lcmEpXG5cdFx0dmFyIG5lYXI6bnVtYmVyID0gY2FtZXJhLnByb2plY3Rpb24ubmVhcjtcblx0XHR2YXIgZDpudW1iZXIgPSBjYW1lcmEucHJvamVjdGlvbi5mYXIgLSBuZWFyO1xuXHRcdHZhciBtYXhEaXN0YW5jZTpudW1iZXIgPSB0aGlzLl9uZWFyU2hhZG93TWFwcGVyLmNvdmVyYWdlUmF0aW87XG5cdFx0dmFyIG1pbkRpc3RhbmNlOm51bWJlciA9IG1heERpc3RhbmNlKigxIC0gdGhpcy5fZmFkZVJhdGlvKTtcblxuXHRcdG1heERpc3RhbmNlID0gbmVhciArIG1heERpc3RhbmNlKmQ7XG5cdFx0bWluRGlzdGFuY2UgPSBuZWFyICsgbWluRGlzdGFuY2UqZDtcblxuXHRcdHZhciBmcmFnbWVudERhdGE6QXJyYXk8bnVtYmVyPiA9IHNoYWRlck9iamVjdC5mcmFnbWVudENvbnN0YW50RGF0YTtcblx0XHR2YXIgaW5kZXg6bnVtYmVyIC8qaW50Ki8gPSBtZXRob2RWTy5zZWNvbmRhcnlGcmFnbWVudENvbnN0YW50c0luZGV4O1xuXHRcdGZyYWdtZW50RGF0YVtpbmRleF0gPSBtaW5EaXN0YW5jZTtcblx0XHRmcmFnbWVudERhdGFbaW5kZXggKyAxXSA9IDEvKG1heERpc3RhbmNlIC0gbWluRGlzdGFuY2UpO1xuXG5cdFx0dGhpcy5fYmFzZU1ldGhvZC5pU2V0UmVuZGVyU3RhdGUoc2hhZGVyT2JqZWN0LCBtZXRob2RWTywgcmVuZGVyYWJsZSwgc3RhZ2UsIGNhbWVyYSk7XG5cdH1cblxuXHQvKipcblx0ICogQGluaGVyaXREb2Ncblx0ICovXG5cdHB1YmxpYyBpR2V0VmVydGV4Q29kZShzaGFkZXJPYmplY3Q6U2hhZGVyT2JqZWN0QmFzZSwgbWV0aG9kVk86TWV0aG9kVk8sIHJlZ2lzdGVyQ2FjaGU6U2hhZGVyUmVnaXN0ZXJDYWNoZSwgc2hhcmVkUmVnaXN0ZXJzOlNoYWRlclJlZ2lzdGVyRGF0YSk6c3RyaW5nXG5cdHtcblx0XHRyZXR1cm4gdGhpcy5fYmFzZU1ldGhvZC5pR2V0VmVydGV4Q29kZShzaGFkZXJPYmplY3QsIG1ldGhvZFZPLCByZWdpc3RlckNhY2hlLCBzaGFyZWRSZWdpc3RlcnMpO1xuXHR9XG5cblx0LyoqXG5cdCAqIEBpbmhlcml0RG9jXG5cdCAqL1xuXHRwdWJsaWMgaVJlc2V0KClcblx0e1xuXHRcdHRoaXMuX2Jhc2VNZXRob2QuaVJlc2V0KCk7XG5cdH1cblxuXHQvKipcblx0ICogQGluaGVyaXREb2Ncblx0ICovXG5cdHB1YmxpYyBpQ2xlYW5Db21waWxhdGlvbkRhdGEoKVxuXHR7XG5cdFx0c3VwZXIuaUNsZWFuQ29tcGlsYXRpb25EYXRhKCk7XG5cdFx0dGhpcy5fYmFzZU1ldGhvZC5pQ2xlYW5Db21waWxhdGlvbkRhdGEoKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBDYWxsZWQgd2hlbiB0aGUgYmFzZSBtZXRob2QncyBzaGFkZXIgY29kZSBpcyBpbnZhbGlkYXRlZC5cblx0ICovXG5cdHByaXZhdGUgb25TaGFkZXJJbnZhbGlkYXRlZChldmVudDpTaGFkaW5nTWV0aG9kRXZlbnQpXG5cdHtcblx0XHR0aGlzLmlJbnZhbGlkYXRlU2hhZGVyUHJvZ3JhbSgpO1xuXHR9XG59XG5cbmV4cG9ydCA9IFNoYWRvd05lYXJNZXRob2Q7Il19