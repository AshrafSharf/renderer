var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var PoissonLookup = require("awayjs-core/lib/geom/PoissonLookup");
var ShadowMethodBase = require("awayjs-renderergl/lib/materials/methods/ShadowMethodBase");
/**
 * ShadowSoftMethod provides a soft shadowing technique by randomly distributing sample points.
 */
var ShadowSoftMethod = (function (_super) {
    __extends(ShadowSoftMethod, _super);
    /**
     * Creates a new DiffuseBasicMethod object.
     *
     * @param castingLight The light casting the shadows
     * @param numSamples The amount of samples to take for dithering. Minimum 1, maximum 32.
     */
    function ShadowSoftMethod(castingLight, numSamples, range) {
        if (numSamples === void 0) { numSamples = 5; }
        if (range === void 0) { range = 1; }
        _super.call(this, castingLight);
        this._range = 1;
        this.numSamples = numSamples;
        this.range = range;
    }
    Object.defineProperty(ShadowSoftMethod.prototype, "numSamples", {
        /**
         * The amount of samples to take for dithering. Minimum 1, maximum 32. The actual maximum may depend on the
         * complexity of the shader.
         */
        get: function () {
            return this._numSamples;
        },
        set: function (value /*int*/) {
            this._numSamples = value;
            if (this._numSamples < 1)
                this._numSamples = 1;
            else if (this._numSamples > 32)
                this._numSamples = 32;
            this._offsets = PoissonLookup.getDistribution(this._numSamples);
            this.iInvalidateShaderProgram();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ShadowSoftMethod.prototype, "range", {
        /**
         * The range in the shadow map in which to distribute the samples.
         */
        get: function () {
            return this._range;
        },
        set: function (value) {
            this._range = value;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @inheritDoc
     */
    ShadowSoftMethod.prototype.iInitConstants = function (shaderObject, methodVO) {
        _super.prototype.iInitConstants.call(this, shaderObject, methodVO);
        shaderObject.fragmentConstantData[methodVO.fragmentConstantsIndex + 8] = 1 / this._numSamples;
        shaderObject.fragmentConstantData[methodVO.fragmentConstantsIndex + 9] = 0;
    };
    /**
     * @inheritDoc
     */
    ShadowSoftMethod.prototype.iActivate = function (shaderObject, methodVO, stage) {
        _super.prototype.iActivate.call(this, shaderObject, methodVO, stage);
        var texRange = .5 * this._range / this._pCastingLight.shadowMapper.depthMapSize;
        var data = shaderObject.fragmentConstantData;
        var index = methodVO.fragmentConstantsIndex + 10;
        var len = this._numSamples << 1;
        for (var i = 0; i < len; ++i)
            data[index + i] = this._offsets[i] * texRange;
    };
    /**
     * @inheritDoc
     */
    ShadowSoftMethod.prototype._pGetPlanarFragmentCode = function (methodVO, targetReg, regCache, sharedRegisters) {
        // todo: move some things to super
        var depthMapRegister = regCache.getFreeTextureReg();
        var decReg = regCache.getFreeFragmentConstant();
        var dataReg = regCache.getFreeFragmentConstant();
        var customDataReg = regCache.getFreeFragmentConstant();
        methodVO.fragmentConstantsIndex = decReg.index * 4;
        methodVO.texturesIndex = depthMapRegister.index;
        return this.getSampleCode(regCache, depthMapRegister, decReg, targetReg, customDataReg);
    };
    /**
     * Adds the code for another tap to the shader code.
     * @param uv The uv register for the tap.
     * @param texture The texture register containing the depth map.
     * @param decode The register containing the depth map decoding data.
     * @param target The target register to add the tap comparison result.
     * @param regCache The register cache managing the registers.
     * @return
     */
    ShadowSoftMethod.prototype.addSample = function (uv, texture, decode, target, regCache) {
        var temp = regCache.getFreeFragmentVectorTemp();
        return "tex " + temp + ", " + uv + ", " + texture + " <2d,nearest,clamp>\n" + "dp4 " + temp + ".z, " + temp + ", " + decode + "\n" + "slt " + uv + ".w, " + this._pDepthMapCoordReg + ".z, " + temp + ".z\n" + "add " + target + ".w, " + target + ".w, " + uv + ".w\n";
    };
    /**
     * @inheritDoc
     */
    ShadowSoftMethod.prototype.iActivateForCascade = function (shaderObject, methodVO, stage) {
        _super.prototype.iActivate.call(this, shaderObject, methodVO, stage);
        var texRange = this._range / this._pCastingLight.shadowMapper.depthMapSize;
        var data = shaderObject.fragmentConstantData;
        var index = methodVO.secondaryFragmentConstantsIndex;
        var len = this._numSamples << 1;
        data[index] = 1 / this._numSamples;
        data[index + 1] = 0;
        index += 2;
        for (var i = 0; i < len; ++i)
            data[index + i] = this._offsets[i] * texRange;
        if (len % 4 == 0) {
            data[index + len] = 0;
            data[index + len + 1] = 0;
        }
    };
    /**
     * @inheritDoc
     */
    ShadowSoftMethod.prototype._iGetCascadeFragmentCode = function (shaderObject, methodVO, decodeRegister, depthTexture, depthProjection, targetRegister, registerCache, sharedRegisters) {
        this._pDepthMapCoordReg = depthProjection;
        var dataReg = registerCache.getFreeFragmentConstant();
        methodVO.secondaryFragmentConstantsIndex = dataReg.index * 4;
        return this.getSampleCode(registerCache, depthTexture, decodeRegister, targetRegister, dataReg);
    };
    /**
     * Get the actual shader code for shadow mapping
     * @param regCache The register cache managing the registers.
     * @param depthTexture The texture register containing the depth map.
     * @param decodeRegister The register containing the depth map decoding data.
     * @param targetReg The target register to add the shadow coverage.
     * @param dataReg The register containing additional data.
     */
    ShadowSoftMethod.prototype.getSampleCode = function (regCache, depthTexture, decodeRegister, targetRegister, dataReg) {
        var uvReg;
        var code;
        var offsets = new Array(dataReg + ".zw");
        uvReg = regCache.getFreeFragmentVectorTemp();
        regCache.addFragmentTempUsages(uvReg, 1);
        var temp = regCache.getFreeFragmentVectorTemp();
        var numRegs = this._numSamples >> 1;
        for (var i = 0; i < numRegs; ++i) {
            var reg = regCache.getFreeFragmentConstant();
            offsets.push(reg + ".xy");
            offsets.push(reg + ".zw");
        }
        for (i = 0; i < this._numSamples; ++i) {
            if (i == 0) {
                code = "add " + uvReg + ", " + this._pDepthMapCoordReg + ", " + dataReg + ".zwyy\n" + "tex " + temp + ", " + uvReg + ", " + depthTexture + " <2d,nearest,clamp>\n" + "dp4 " + temp + ".z, " + temp + ", " + decodeRegister + "\n" + "slt " + targetRegister + ".w, " + this._pDepthMapCoordReg + ".z, " + temp + ".z\n"; // 0 if in shadow;
            }
            else {
                code += "add " + uvReg + ".xy, " + this._pDepthMapCoordReg + ".xy, " + offsets[i] + "\n" + this.addSample(uvReg, depthTexture, decodeRegister, targetRegister, regCache);
            }
        }
        regCache.removeFragmentTempUsage(uvReg);
        code += "mul " + targetRegister + ".w, " + targetRegister + ".w, " + dataReg + ".x\n"; // average
        return code;
    };
    return ShadowSoftMethod;
})(ShadowMethodBase);
module.exports = ShadowSoftMethod;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9tYXRlcmlhbHMvbWV0aG9kcy9zaGFkb3dzb2Z0bWV0aG9kLnRzIl0sIm5hbWVzIjpbIlNoYWRvd1NvZnRNZXRob2QiLCJTaGFkb3dTb2Z0TWV0aG9kLmNvbnN0cnVjdG9yIiwiU2hhZG93U29mdE1ldGhvZC5udW1TYW1wbGVzIiwiU2hhZG93U29mdE1ldGhvZC5yYW5nZSIsIlNoYWRvd1NvZnRNZXRob2QuaUluaXRDb25zdGFudHMiLCJTaGFkb3dTb2Z0TWV0aG9kLmlBY3RpdmF0ZSIsIlNoYWRvd1NvZnRNZXRob2QuX3BHZXRQbGFuYXJGcmFnbWVudENvZGUiLCJTaGFkb3dTb2Z0TWV0aG9kLmFkZFNhbXBsZSIsIlNoYWRvd1NvZnRNZXRob2QuaUFjdGl2YXRlRm9yQ2FzY2FkZSIsIlNoYWRvd1NvZnRNZXRob2QuX2lHZXRDYXNjYWRlRnJhZ21lbnRDb2RlIiwiU2hhZG93U29mdE1ldGhvZC5nZXRTYW1wbGVDb2RlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxJQUFPLGFBQWEsV0FBZSxvQ0FBb0MsQ0FBQyxDQUFDO0FBV3pFLElBQU8sZ0JBQWdCLFdBQWUsMERBQTBELENBQUMsQ0FBQztBQUVsRyxBQUdBOztHQURHO0lBQ0csZ0JBQWdCO0lBQVNBLFVBQXpCQSxnQkFBZ0JBLFVBQXlCQTtJQU05Q0E7Ozs7O09BS0dBO0lBQ0hBLFNBWktBLGdCQUFnQkEsQ0FZVEEsWUFBNkJBLEVBQUVBLFVBQTZCQSxFQUFFQSxLQUFnQkE7UUFBL0NDLDBCQUE2QkEsR0FBN0JBLGNBQTZCQTtRQUFFQSxxQkFBZ0JBLEdBQWhCQSxTQUFnQkE7UUFFekZBLGtCQUFNQSxZQUFZQSxDQUFDQSxDQUFDQTtRQVpiQSxXQUFNQSxHQUFVQSxDQUFDQSxDQUFDQTtRQWN6QkEsSUFBSUEsQ0FBQ0EsVUFBVUEsR0FBR0EsVUFBVUEsQ0FBQ0E7UUFDN0JBLElBQUlBLENBQUNBLEtBQUtBLEdBQUdBLEtBQUtBLENBQUNBO0lBQ3BCQSxDQUFDQTtJ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R0FBR0EsdUJBQXVCQSxHQUM1RUEsTUFBTUEsR0FBR0EsSUFBSUEsR0FBR0EsTUFBTUEsR0FBR0EsSUFBSUEsR0FBR0EsSUFBSUEsR0FBR0EsY0FBY0EsR0FBR0EsSUFBSUEsR0FDNURBLE1BQU1BLEdBQUdBLGNBQWNBLEdBQUdBLE1BQU1BLEdBQUdBLElBQUlBLENBQUNBLGtCQUFrQkEsR0FBR0EsTUFBTUEsR0FBR0EsSUFBSUEsR0FBR0EsTUFBTUEsRUFBRUEsa0JBQWtCQTtZQUN6R0EsQ0FBQ0EsR0FEcUZBO1lBQ3BGQSxJQUFJQSxDQUFDQSxDQUFDQTtnQkFDUEEsSUFBSUEsSUFBSUEsTUFBTUEsR0FBR0EsS0FBS0EsR0FBR0EsT0FBT0EsR0FBR0EsSUFBSUEsQ0FBQ0Esa0JBQWtCQSxHQUFHQSxPQUFPQSxHQUFHQSxPQUFPQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxJQUFJQSxHQUN2RkEsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsS0FBS0EsRUFBRUEsWUFBWUEsRUFBRUEsY0FBY0EsRUFBRUEsY0FBY0EsRUFBRUEsUUFBUUEsQ0FBQ0EsQ0FBQ0E7WUFDaEZBLENBQUNBO1FBQ0ZBLENBQUNBO1FBRURBLFFBQVFBLENBQUNBLHVCQUF1QkEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0E7UUFFeENBLElBQUlBLElBQUlBLE1BQU1BLEdBQUdBLGNBQWNBLEdBQUdBLE1BQU1BLEdBQUdBLGNBQWNBLEdBQUdBLE1BQU1BLEdBQUdBLE9BQU9BLEdBQUdBLE1BQU1BLEVBQUVBLFVBQVVBO1FBRWpHQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQTtJQUNiQSxDQUFDQTtJQUNGVix1QkFBQ0E7QUFBREEsQ0F0TUEsQUFzTUNBLEVBdE04QixnQkFBZ0IsRUFzTTlDO0FBRUQsQUFBMEIsaUJBQWpCLGdCQUFnQixDQUFDIiwiZmlsZSI6Im1hdGVyaWFscy9tZXRob2RzL1NoYWRvd1NvZnRNZXRob2QuanMiLCJzb3VyY2VSb290IjoiLi4vIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFBvaXNzb25Mb29rdXBcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2dlb20vUG9pc3Nvbkxvb2t1cFwiKTtcblxuaW1wb3J0IERpcmVjdGlvbmFsTGlnaHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL2VudGl0aWVzL0RpcmVjdGlvbmFsTGlnaHRcIik7XG5cbmltcG9ydCBTdGFnZVx0XHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2Jhc2UvU3RhZ2VcIik7XG5cbmltcG9ydCBNZXRob2RWT1x0XHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL21hdGVyaWFscy9jb21waWxhdGlvbi9NZXRob2RWT1wiKTtcbmltcG9ydCBTaGFkZXJPYmplY3RCYXNlXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9tYXRlcmlhbHMvY29tcGlsYXRpb24vU2hhZGVyT2JqZWN0QmFzZVwiKTtcbmltcG9ydCBTaGFkZXJSZWdpc3RlckNhY2hlXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvbWF0ZXJpYWxzL2NvbXBpbGF0aW9uL1NoYWRlclJlZ2lzdGVyQ2FjaGVcIik7XG5pbXBvcnQgU2hhZGVyUmVnaXN0ZXJEYXRhXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvbWF0ZXJpYWxzL2NvbXBpbGF0aW9uL1NoYWRlclJlZ2lzdGVyRGF0YVwiKTtcbmltcG9ydCBTaGFkZXJSZWdpc3RlckVsZW1lbnRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvbWF0ZXJpYWxzL2NvbXBpbGF0aW9uL1NoYWRlclJlZ2lzdGVyRWxlbWVudFwiKTtcbmltcG9ydCBTaGFkb3dNZXRob2RCYXNlXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9tYXRlcmlhbHMvbWV0aG9kcy9TaGFkb3dNZXRob2RCYXNlXCIpO1xuXG4vKipcbiAqIFNoYWRvd1NvZnRNZXRob2QgcHJvdmlkZXMgYSBzb2Z0IHNoYWRvd2luZyB0ZWNobmlxdWUgYnkgcmFuZG9tbHkgZGlzdHJpYnV0aW5nIHNhbXBsZSBwb2ludHMuXG4gKi9cbmNsYXNzIFNoYWRvd1NvZnRNZXRob2QgZXh0ZW5kcyBTaGFkb3dNZXRob2RCYXNlXG57XG5cdHByaXZhdGUgX3JhbmdlOm51bWJlciA9IDE7XG5cdHByaXZhdGUgX251bVNhbXBsZXM6bnVtYmVyIC8qaW50Ki87XG5cdHByaXZhdGUgX29mZnNldHM6QXJyYXk8bnVtYmVyPjtcblxuXHQvKipcblx0ICogQ3JlYXRlcyBhIG5ldyBEaWZmdXNlQmFzaWNNZXRob2Qgb2JqZWN0LlxuXHQgKlxuXHQgKiBAcGFyYW0gY2FzdGluZ0xpZ2h0IFRoZSBsaWdodCBjYXN0aW5nIHRoZSBzaGFkb3dzXG5cdCAqIEBwYXJhbSBudW1TYW1wbGVzIFRoZSBhbW91bnQgb2Ygc2FtcGxlcyB0byB0YWtlIGZvciBkaXRoZXJpbmcuIE1pbmltdW0gMSwgbWF4aW11bSAzMi5cblx0ICovXG5cdGNvbnN0cnVjdG9yKGNhc3RpbmdMaWdodDpEaXJlY3Rpb25hbExpZ2h0LCBudW1TYW1wbGVzOm51bWJlciAvKmludCovID0gNSwgcmFuZ2U6bnVtYmVyID0gMSlcblx0e1xuXHRcdHN1cGVyKGNhc3RpbmdMaWdodCk7XG5cblx0XHR0aGlzLm51bVNhbXBsZXMgPSBudW1TYW1wbGVzO1xuXHRcdHRoaXMucmFuZ2UgPSByYW5nZTtcblx0fVxuXG5cdC8qKlxuXHQgKiBUaGUgYW1vdW50IG9mIHNhbXBsZXMgdG8gdGFrZSBmb3IgZGl0aGVyaW5nLiBNaW5pbXVtIDEsIG1heGltdW0gMzIuIFRoZSBhY3R1YWwgbWF4aW11bSBtYXkgZGVwZW5kIG9uIHRoZVxuXHQgKiBjb21wbGV4aXR5IG9mIHRoZSBzaGFkZXIuXG5cdCAqL1xuXHRwdWJsaWMgZ2V0IG51bVNhbXBsZXMoKTpudW1iZXIgLyppbnQqL1xuXHR7XG5cdFx0cmV0dXJuIHRoaXMuX251bVNhbXBsZXM7XG5cdH1cblxuXHRwdWJsaWMgc2V0IG51bVNhbXBsZXModmFsdWU6bnVtYmVyIC8qaW50Ki8pXG5cdHtcblx0XHR0aGlzLl9udW1TYW1wbGVzID0gdmFsdWU7XG5cdFx0XG5cdFx0aWYgKHRoaXMuX251bVNhbXBsZXMgPCAxKVxuXHRcdFx0dGhpcy5fbnVtU2FtcGxlcyA9IDE7XG5cdFx0ZWxzZSBpZiAodGhpcy5fbnVtU2FtcGxlcyA+IDMyKVxuXHRcdFx0dGhpcy5fbnVtU2FtcGxlcyA9IDMyO1xuXG5cdFx0dGhpcy5fb2Zmc2V0cyA9IFBvaXNzb25Mb29rdXAuZ2V0RGlzdHJpYnV0aW9uKHRoaXMuX251bVNhbXBsZXMpO1xuXHRcdFxuXHRcdHRoaXMuaUludmFsaWRhdGVTaGFkZXJQcm9ncmFtKCk7XG5cdH1cblxuXHQvKipcblx0ICogVGhlIHJhbmdlIGluIHRoZSBzaGFkb3cgbWFwIGluIHdoaWNoIHRvIGRpc3RyaWJ1dGUgdGhlIHNhbXBsZXMuXG5cdCAqL1xuXHRwdWJsaWMgZ2V0IHJhbmdlKCk6bnVtYmVyXG5cdHtcblx0XHRyZXR1cm4gdGhpcy5fcmFuZ2U7XG5cdH1cblxuXHRwdWJsaWMgc2V0IHJhbmdlKHZhbHVlOm51bWJlcilcblx0e1xuXHRcdHRoaXMuX3JhbmdlID0gdmFsdWU7XG5cdH1cblxuXHQvKipcblx0ICogQGluaGVyaXREb2Ncblx0ICovXG5cdHB1YmxpYyBpSW5pdENvbnN0YW50cyhzaGFkZXJPYmplY3Q6U2hhZGVyT2JqZWN0QmFzZSwgbWV0aG9kVk86TWV0aG9kVk8pXG5cdHtcblx0XHRzdXBlci5pSW5pdENvbnN0YW50cyhzaGFkZXJPYmplY3QsIG1ldGhvZFZPKTtcblxuXHRcdHNoYWRlck9iamVjdC5mcmFnbWVudENvbnN0YW50RGF0YVttZXRob2RWTy5mcmFnbWVudENvbnN0YW50c0luZGV4ICsgOF0gPSAxL3RoaXMuX251bVNhbXBsZXM7XG5cdFx0c2hhZGVyT2JqZWN0LmZyYWdtZW50Q29uc3RhbnREYXRhW21ldGhvZFZPLmZyYWdtZW50Q29uc3RhbnRzSW5kZXggKyA5XSA9IDA7XG5cdH1cblxuXHQvKipcblx0ICogQGluaGVyaXREb2Ncblx0ICovXG5cdHB1YmxpYyBpQWN0aXZhdGUoc2hhZGVyT2JqZWN0OlNoYWRlck9iamVjdEJhc2UsIG1ldGhvZFZPOk1ldGhvZFZPLCBzdGFnZTpTdGFnZSlcblx0e1xuXHRcdHN1cGVyLmlBY3RpdmF0ZShzaGFkZXJPYmplY3QsIG1ldGhvZFZPLCBzdGFnZSk7XG5cblx0XHR2YXIgdGV4UmFuZ2U6bnVtYmVyID0gLjUqdGhpcy5fcmFuZ2UvdGhpcy5fcENhc3RpbmdMaWdodC5zaGFkb3dNYXBwZXIuZGVwdGhNYXBTaXplO1xuXHRcdHZhciBkYXRhOkFycmF5PG51bWJlcj4gPSBzaGFkZXJPYmplY3QuZnJhZ21lbnRDb25zdGFudERhdGE7XG5cdFx0dmFyIGluZGV4Om51bWJlciAvKnVpbnQqLyA9IG1ldGhvZFZPLmZyYWdtZW50Q29uc3RhbnRzSW5kZXggKyAxMDtcblx0XHR2YXIgbGVuOm51bWJlciAvKnVpbnQqLyA9IHRoaXMuX251bVNhbXBsZXMgPDwgMTtcblxuXHRcdGZvciAodmFyIGk6bnVtYmVyIC8qaW50Ki8gPSAwOyBpIDwgbGVuOyArK2kpXG5cdFx0XHRkYXRhW2luZGV4ICsgaV0gPSB0aGlzLl9vZmZzZXRzW2ldKnRleFJhbmdlO1xuXHR9XG5cblx0LyoqXG5cdCAqIEBpbmhlcml0RG9jXG5cdCAqL1xuXHRwdWJsaWMgX3BHZXRQbGFuYXJGcmFnbWVudENvZGUobWV0aG9kVk86TWV0aG9kVk8sIHRhcmdldFJlZzpTaGFkZXJSZWdpc3RlckVsZW1lbnQsIHJlZ0NhY2hlOlNoYWRlclJlZ2lzdGVyQ2FjaGUsIHNoYXJlZFJlZ2lzdGVyczpTaGFkZXJSZWdpc3RlckRhdGEpOnN0cmluZ1xuXHR7XG5cdFx0Ly8gdG9kbzogbW92ZSBzb21lIHRoaW5ncyB0byBzdXBlclxuXHRcdHZhciBkZXB0aE1hcFJlZ2lzdGVyOlNoYWRlclJlZ2lzdGVyRWxlbWVudCA9IHJlZ0NhY2hlLmdldEZyZWVUZXh0dXJlUmVnKCk7XG5cdFx0dmFyIGRlY1JlZzpTaGFkZXJSZWdpc3RlckVsZW1lbnQgPSByZWdDYWNoZS5nZXRGcmVlRnJhZ21lbnRDb25zdGFudCgpO1xuXHRcdHZhciBkYXRhUmVnOlNoYWRlclJlZ2lzdGVyRWxlbWVudCA9IHJlZ0NhY2hlLmdldEZyZWVGcmFnbWVudENvbnN0YW50KCk7XG5cdFx0dmFyIGN1c3RvbURhdGFSZWc6U2hhZGVyUmVnaXN0ZXJFbGVtZW50ID0gcmVnQ2FjaGUuZ2V0RnJlZUZyYWdtZW50Q29uc3RhbnQoKTtcblxuXHRcdG1ldGhvZFZPLmZyYWdtZW50Q29uc3RhbnRzSW5kZXggPSBkZWNSZWcuaW5kZXgqNDtcblx0XHRtZXRob2RWTy50ZXh0dXJlc0luZGV4ID0gZGVwdGhNYXBSZWdpc3Rlci5pbmRleDtcblxuXHRcdHJldHVybiB0aGlzLmdldFNhbXBsZUNvZGUocmVnQ2FjaGUsIGRlcHRoTWFwUmVnaXN0ZXIsIGRlY1JlZywgdGFyZ2V0UmVnLCBjdXN0b21EYXRhUmVnKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBBZGRzIHRoZSBjb2RlIGZvciBhbm90aGVyIHRhcCB0byB0aGUgc2hhZGVyIGNvZGUuXG5cdCAqIEBwYXJhbSB1diBUaGUgdXYgcmVnaXN0ZXIgZm9yIHRoZSB0YXAuXG5cdCAqIEBwYXJhbSB0ZXh0dXJlIFRoZSB0ZXh0dXJlIHJlZ2lzdGVyIGNvbnRhaW5pbmcgdGhlIGRlcHRoIG1hcC5cblx0ICogQHBhcmFtIGRlY29kZSBUaGUgcmVnaXN0ZXIgY29udGFpbmluZyB0aGUgZGVwdGggbWFwIGRlY29kaW5nIGRhdGEuXG5cdCAqIEBwYXJhbSB0YXJnZXQgVGhlIHRhcmdldCByZWdpc3RlciB0byBhZGQgdGhlIHRhcCBjb21wYXJpc29uIHJlc3VsdC5cblx0ICogQHBhcmFtIHJlZ0NhY2hlIFRoZSByZWdpc3RlciBjYWNoZSBtYW5hZ2luZyB0aGUgcmVnaXN0ZXJzLlxuXHQgKiBAcmV0dXJuXG5cdCAqL1xuXHRwcml2YXRlIGFkZFNhbXBsZSh1djpTaGFkZXJSZWdpc3RlckVsZW1lbnQsIHRleHR1cmU6U2hhZGVyUmVnaXN0ZXJFbGVtZW50LCBkZWNvZGU6U2hhZGVyUmVnaXN0ZXJFbGVtZW50LCB0YXJnZXQ6U2hhZGVyUmVnaXN0ZXJFbGVtZW50LCByZWdDYWNoZTpTaGFkZXJSZWdpc3RlckNhY2hlKTpzdHJpbmdcblx0e1xuXHRcdHZhciB0ZW1wOlNoYWRlclJlZ2lzdGVyRWxlbWVudCA9IHJlZ0NhY2hlLmdldEZyZWVGcmFnbWVudFZlY3RvclRlbXAoKTtcblx0XHRyZXR1cm4gXCJ0ZXggXCIgKyB0ZW1wICsgXCIsIFwiICsgdXYgKyBcIiwgXCIgKyB0ZXh0dXJlICsgXCIgPDJkLG5lYXJlc3QsY2xhbXA+XFxuXCIgK1xuXHRcdFx0XCJkcDQgXCIgKyB0ZW1wICsgXCIueiwgXCIgKyB0ZW1wICsgXCIsIFwiICsgZGVjb2RlICsgXCJcXG5cIiArXG5cdFx0XHRcInNsdCBcIiArIHV2ICsgXCIudywgXCIgKyB0aGlzLl9wRGVwdGhNYXBDb29yZFJlZyArIFwiLnosIFwiICsgdGVtcCArIFwiLnpcXG5cIiArIC8vIDAgaWYgaW4gc2hhZG93XG5cdFx0XHRcImFkZCBcIiArIHRhcmdldCArIFwiLncsIFwiICsgdGFyZ2V0ICsgXCIudywgXCIgKyB1diArIFwiLndcXG5cIjtcblx0fVxuXG5cdC8qKlxuXHQgKiBAaW5oZXJpdERvY1xuXHQgKi9cblx0cHVibGljIGlBY3RpdmF0ZUZvckNhc2NhZGUoc2hhZGVyT2JqZWN0OlNoYWRlck9iamVjdEJhc2UsIG1ldGhvZFZPOk1ldGhvZFZPLCBzdGFnZTpTdGFnZSlcblx0e1xuXHRcdHN1cGVyLmlBY3RpdmF0ZShzaGFkZXJPYmplY3QsIG1ldGhvZFZPLCBzdGFnZSk7XG5cblx0XHR2YXIgdGV4UmFuZ2U6bnVtYmVyID0gdGhpcy5fcmFuZ2UvdGhpcy5fcENhc3RpbmdMaWdodC5zaGFkb3dNYXBwZXIuZGVwdGhNYXBTaXplO1xuXHRcdHZhciBkYXRhOkFycmF5PG51bWJlcj4gPSBzaGFkZXJPYmplY3QuZnJhZ21lbnRDb25zdGFudERhdGE7XG5cdFx0dmFyIGluZGV4Om51bWJlciAvKnVpbnQqLyA9IG1ldGhvZFZPLnNlY29uZGFyeUZyYWdtZW50Q29uc3RhbnRzSW5kZXg7XG5cdFx0dmFyIGxlbjpudW1iZXIgLyp1aW50Ki8gPSB0aGlzLl9udW1TYW1wbGVzIDw8IDE7XG5cdFx0ZGF0YVtpbmRleF0gPSAxL3RoaXMuX251bVNhbXBsZXM7XG5cdFx0ZGF0YVtpbmRleCArIDFdID0gMDtcblx0XHRpbmRleCArPSAyO1xuXG5cdFx0Zm9yICh2YXIgaTpudW1iZXIgLyppbnQqLyA9IDA7IGkgPCBsZW47ICsraSlcblx0XHRcdGRhdGFbaW5kZXggKyBpXSA9IHRoaXMuX29mZnNldHNbaV0qdGV4UmFuZ2U7XG5cblx0XHRpZiAobGVuJTQgPT0gMCkge1xuXHRcdFx0ZGF0YVtpbmRleCArIGxlbl0gPSAwO1xuXHRcdFx0ZGF0YVtpbmRleCArIGxlbiArIDFdID0gMDtcblx0XHR9XG5cdH1cblxuXHQvKipcblx0ICogQGluaGVyaXREb2Ncblx0ICovXG5cdHB1YmxpYyBfaUdldENhc2NhZGVGcmFnbWVudENvZGUoc2hhZGVyT2JqZWN0OlNoYWRlck9iamVjdEJhc2UsIG1ldGhvZFZPOk1ldGhvZFZPLCBkZWNvZGVSZWdpc3RlcjpTaGFkZXJSZWdpc3RlckVsZW1lbnQsIGRlcHRoVGV4dHVyZTpTaGFkZXJSZWdpc3RlckVsZW1lbnQsIGRlcHRoUHJvamVjdGlvbjpTaGFkZXJSZWdpc3RlckVsZW1lbnQsIHRhcmdldFJlZ2lzdGVyOlNoYWRlclJlZ2lzdGVyRWxlbWVudCwgcmVnaXN0ZXJDYWNoZTpTaGFkZXJSZWdpc3RlckNhY2hlLCBzaGFyZWRSZWdpc3RlcnM6U2hhZGVyUmVnaXN0ZXJEYXRhKTpzdHJpbmdcblx0e1xuXHRcdHRoaXMuX3BEZXB0aE1hcENvb3JkUmVnID0gZGVwdGhQcm9qZWN0aW9uO1xuXG5cdFx0dmFyIGRhdGFSZWc6U2hhZGVyUmVnaXN0ZXJFbGVtZW50ID0gcmVnaXN0ZXJDYWNoZS5nZXRGcmVlRnJhZ21lbnRDb25zdGFudCgpO1xuXHRcdG1ldGhvZFZPLnNlY29uZGFyeUZyYWdtZW50Q29uc3RhbnRzSW5kZXggPSBkYXRhUmVnLmluZGV4KjQ7XG5cblx0XHRyZXR1cm4gdGhpcy5nZXRTYW1wbGVDb2RlKHJlZ2lzdGVyQ2FjaGUsIGRlcHRoVGV4dHVyZSwgZGVjb2RlUmVnaXN0ZXIsIHRhcmdldFJlZ2lzdGVyLCBkYXRhUmVnKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBHZXQgdGhlIGFjdHVhbCBzaGFkZXIgY29kZSBmb3Igc2hhZG93IG1hcHBpbmdcblx0ICogQHBhcmFtIHJlZ0NhY2hlIFRoZSByZWdpc3RlciBjYWNoZSBtYW5hZ2luZyB0aGUgcmVnaXN0ZXJzLlxuXHQgKiBAcGFyYW0gZGVwdGhUZXh0dXJlIFRoZSB0ZXh0dXJlIHJlZ2lzdGVyIGNvbnRhaW5pbmcgdGhlIGRlcHRoIG1hcC5cblx0ICogQHBhcmFtIGRlY29kZVJlZ2lzdGVyIFRoZSByZWdpc3RlciBjb250YWluaW5nIHRoZSBkZXB0aCBtYXAgZGVjb2RpbmcgZGF0YS5cblx0ICogQHBhcmFtIHRhcmdldFJlZyBUaGUgdGFyZ2V0IHJlZ2lzdGVyIHRvIGFkZCB0aGUgc2hhZG93IGNvdmVyYWdlLlxuXHQgKiBAcGFyYW0gZGF0YVJlZyBUaGUgcmVnaXN0ZXIgY29udGFpbmluZyBhZGRpdGlvbmFsIGRhdGEuXG5cdCAqL1xuXHRwcml2YXRlIGdldFNhbXBsZUNvZGUocmVnQ2FjaGU6U2hhZGVyUmVnaXN0ZXJDYWNoZSwgZGVwdGhUZXh0dXJlOlNoYWRlclJlZ2lzdGVyRWxlbWVudCwgZGVjb2RlUmVnaXN0ZXI6U2hhZGVyUmVnaXN0ZXJFbGVtZW50LCB0YXJnZXRSZWdpc3RlcjpTaGFkZXJSZWdpc3RlckVsZW1lbnQsIGRhdGFSZWc6U2hhZGVyUmVnaXN0ZXJFbGVtZW50KTpzdHJpbmdcblx0e1xuXHRcdHZhciB1dlJlZzpTaGFkZXJSZWdpc3RlckVsZW1lbnQ7XG5cdFx0dmFyIGNvZGU6c3RyaW5nO1xuXHRcdHZhciBvZmZzZXRzOkFycmF5PHN0cmluZz4gPSBuZXcgQXJyYXk8c3RyaW5nPihkYXRhUmVnICsgXCIuendcIik7XG5cdFx0dXZSZWcgPSByZWdDYWNoZS5nZXRGcmVlRnJhZ21lbnRWZWN0b3JUZW1wKCk7XG5cdFx0cmVnQ2FjaGUuYWRkRnJhZ21lbnRUZW1wVXNhZ2VzKHV2UmVnLCAxKTtcblxuXHRcdHZhciB0ZW1wOlNoYWRlclJlZ2lzdGVyRWxlbWVudCA9IHJlZ0NhY2hlLmdldEZyZWVGcmFnbWVudFZlY3RvclRlbXAoKTtcblxuXHRcdHZhciBudW1SZWdzOm51bWJlciAvKmludCovID0gdGhpcy5fbnVtU2FtcGxlcyA+PiAxO1xuXHRcdGZvciAodmFyIGk6bnVtYmVyIC8qaW50Ki8gPSAwOyBpIDwgbnVtUmVnczsgKytpKSB7XG5cdFx0XHR2YXIgcmVnOlNoYWRlclJlZ2lzdGVyRWxlbWVudCA9IHJlZ0NhY2hlLmdldEZyZWVGcmFnbWVudENvbnN0YW50KCk7XG5cdFx0XHRvZmZzZXRzLnB1c2gocmVnICsgXCIueHlcIik7XG5cdFx0XHRvZmZzZXRzLnB1c2gocmVnICsgXCIuendcIik7XG5cdFx0fVxuXG5cdFx0Zm9yIChpID0gMDsgaSA8IHRoaXMuX251bVNhbXBsZXM7ICsraSkge1xuXHRcdFx0aWYgKGkgPT0gMCkge1xuXHRcdFx0XHRjb2RlID0gXCJhZGQgXCIgKyB1dlJlZyArIFwiLCBcIiArIHRoaXMuX3BEZXB0aE1hcENvb3JkUmVnICsgXCIsIFwiICsgZGF0YVJlZyArIFwiLnp3eXlcXG5cIiArXG5cdFx0XHRcdFx0XCJ0ZXggXCIgKyB0ZW1wICsgXCIsIFwiICsgdXZSZWcgKyBcIiwgXCIgKyBkZXB0aFRleHR1cmUgKyBcIiA8MmQsbmVhcmVzdCxjbGFtcD5cXG5cIiArXG5cdFx0XHRcdFx0XCJkcDQgXCIgKyB0ZW1wICsgXCIueiwgXCIgKyB0ZW1wICsgXCIsIFwiICsgZGVjb2RlUmVnaXN0ZXIgKyBcIlxcblwiICtcblx0XHRcdFx0XHRcInNsdCBcIiArIHRhcmdldFJlZ2lzdGVyICsgXCIudywgXCIgKyB0aGlzLl9wRGVwdGhNYXBDb29yZFJlZyArIFwiLnosIFwiICsgdGVtcCArIFwiLnpcXG5cIjsgLy8gMCBpZiBpbiBzaGFkb3c7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRjb2RlICs9IFwiYWRkIFwiICsgdXZSZWcgKyBcIi54eSwgXCIgKyB0aGlzLl9wRGVwdGhNYXBDb29yZFJlZyArIFwiLnh5LCBcIiArIG9mZnNldHNbaV0gKyBcIlxcblwiICtcblx0XHRcdFx0XHR0aGlzLmFkZFNhbXBsZSh1dlJlZywgZGVwdGhUZXh0dXJlLCBkZWNvZGVSZWdpc3RlciwgdGFyZ2V0UmVnaXN0ZXIsIHJlZ0NhY2hlKTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZWdDYWNoZS5yZW1vdmVGcmFnbWVudFRlbXBVc2FnZSh1dlJlZyk7XG5cblx0XHRjb2RlICs9IFwibXVsIFwiICsgdGFyZ2V0UmVnaXN0ZXIgKyBcIi53LCBcIiArIHRhcmdldFJlZ2lzdGVyICsgXCIudywgXCIgKyBkYXRhUmVnICsgXCIueFxcblwiOyAvLyBhdmVyYWdlXG5cblx0XHRyZXR1cm4gY29kZTtcblx0fVxufVxuXG5leHBvcnQgPSBTaGFkb3dTb2Z0TWV0aG9kOyJdfQ==