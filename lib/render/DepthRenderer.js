var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var ContextGLBlendFactor = require("awayjs-stagegl/lib/base/ContextGLBlendFactor");
var ContextGLCompareMode = require("awayjs-stagegl/lib/base/ContextGLCompareMode");
var RendererBase = require("awayjs-renderergl/lib/render/RendererBase");
/**
 * The DepthRenderer class renders 32-bit depth information encoded as RGBA
 *
 * @class away.render.DepthRenderer
 */
var DepthRenderer = (function (_super) {
    __extends(DepthRenderer, _super);
    /**
     * Creates a new DepthRenderer object.
     * @param renderBlended Indicates whether semi-transparent objects should be rendered.
     * @param distanceBased Indicates whether the written depth value is distance-based or projected depth-based
     */
    function DepthRenderer(pass, renderBlended) {
        if (renderBlended === void 0) { renderBlended = false; }
        _super.call(this);
        this._pass = pass;
        this._renderBlended = renderBlended;
        this._iBackgroundR = 1;
        this._iBackgroundG = 1;
        this._iBackgroundB = 1;
    }
    Object.defineProperty(DepthRenderer.prototype, "disableColor", {
        get: function () {
            return this._disableColor;
        },
        set: function (value) {
            this._disableColor = value;
        },
        enumerable: true,
        configurable: true
    });
    DepthRenderer.prototype._iRenderCascades = function (entityCollector, target, numCascades, scissorRects, cameras) {
        this.pCollectRenderables(entityCollector);
        this._pContext.setRenderTarget(target, true, 0);
        this._pContext.clear(1, 1, 1, 1, 1, 0);
        this._pContext.setBlendFactors(ContextGLBlendFactor.ONE, ContextGLBlendFactor.ZERO);
        this._pContext.setDepthTest(true, ContextGLCompareMode.LESS);
        var head = this._pOpaqueRenderableHead;
        var first = true;
        for (var i = numCascades - 1; i >= 0; --i) {
            this._pStage.scissorRect = scissorRects[i];
            this.drawCascadeRenderables(head, cameras[i], first ? null : cameras[i].frustumPlanes);
            first = false;
        }
        //line required for correct rendering when using away3d with starling. DO NOT REMOVE UNLESS STARLING INTEGRATION IS RETESTED!
        this._pContext.setDepthTest(false, ContextGLCompareMode.LESS_EQUAL);
        this._pStage.scissorRect = null;
    };
    DepthRenderer.prototype.drawCascadeRenderables = function (renderable, camera, cullPlanes) {
        var activePass;
        var activeMaterial;
        var context = this._pStage.context;
        var renderable2;
        while (renderable) {
            activeMaterial = this.getMaterial(renderable.material, this._pStage.profile);
            renderable2 = renderable;
            activePass = activeMaterial.getMaterialPass(this._pass, this._pStage.profile);
            //TODO: generalise this test
            if (activePass.key == "")
                this.calcAnimationCode(renderable.material, activePass);
            renderable.material._iActivatePass(activePass, this, camera);
            do {
                // if completely in front, it will fall in a different cascade
                // do not use near and far planes
                if (!cullPlanes || renderable2.sourceEntity.worldBounds.isInFrustum(cullPlanes, 4)) {
                    renderable2.material._iRenderPass(activePass, renderable2, this._pStage, camera, this._pRttViewProjectionMatrix);
                }
                else {
                    renderable2.cascaded = true;
                }
                renderable2 = renderable2.next;
            } while (renderable2 && renderable2.material == renderable.material && !renderable2.cascaded);
            renderable.material._iDeactivatePass(activePass, this);
            renderable = renderable2;
        }
    };
    /**
     * @inheritDoc
     */
    DepthRenderer.prototype.pDraw = function (entityCollector, target) {
        this.pCollectRenderables(entityCollector);
        this._pContext.setBlendFactors(ContextGLBlendFactor.ONE, ContextGLBlendFactor.ZERO);
        this._pContext.setDepthTest(true, ContextGLCompareMode.LESS);
        this.drawRenderables(this._pOpaqueRenderableHead, entityCollector);
        if (this._disableColor)
            this._pContext.setColorMask(false, false, false, false);
        if (this._renderBlended)
            this.drawRenderables(this._pBlendedRenderableHead, entityCollector);
        if (this._disableColor)
            this._pContext.setColorMask(true, true, true, true);
    };
    /**
     * Draw a list of renderables.
     * @param renderables The renderables to draw.
     * @param entityCollector The EntityCollector containing all potentially visible information.
     */
    DepthRenderer.prototype.drawRenderables = function (renderable, entityCollector) {
        var activePass;
        var activeMaterial;
        var context = this._pStage.context;
        var camera = entityCollector.camera;
        var renderable2;
        while (renderable) {
            activeMaterial = this.getMaterial(renderable.material, this._pStage.profile);
            // otherwise this would result in depth rendered anyway because fragment shader kil is ignored
            if (this._disableColor && renderable.material.alphaThreshold != 0) {
                renderable2 = renderable;
                do {
                    renderable2 = renderable2.next;
                } while (renderable2 && renderable2.material == renderable.material);
            }
            else {
                renderable2 = renderable;
                activePass = activeMaterial.getMaterialPass(this._pass, this._pStage.profile);
                //TODO: generalise this test
                if (activePass.key == "")
                    this.calcAnimationCode(renderable.material, activePass);
                renderable.material._iActivatePass(activePass, this, camera);
                do {
                    renderable2.material._iRenderPass(activePass, renderable2, this._pStage, camera, this._pRttViewProjectionMatrix);
                    renderable2 = renderable2.next;
                } while (renderable2 && renderable2.material == renderable.material);
                renderable.material._iDeactivatePass(activePass, this);
            }
            renderable = renderable2;
        }
    };
    return DepthRenderer;
})(RendererBase);
module.exports = DepthRenderer;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9yZW5kZXIvZGVwdGhyZW5kZXJlci50cyJdLCJuYW1lcyI6WyJEZXB0aFJlbmRlcmVyIiwiRGVwdGhSZW5kZXJlci5jb25zdHJ1Y3RvciIsIkRlcHRoUmVuZGVyZXIuZGlzYWJsZUNvbG9yIiwiRGVwdGhSZW5kZXJlci5faVJlbmRlckNhc2NhZGVzIiwiRGVwdGhSZW5kZXJlci5kcmF3Q2FzY2FkZVJlbmRlcmFibGVzIiwiRGVwdGhSZW5kZXJlci5wRHJhdyIsIkRlcHRoUmVuZGVyZXIuZHJhd1JlbmRlcmFibGVzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFTQSxJQUFPLG9CQUFvQixXQUFhLDhDQUE4QyxDQUFDLENBQUM7QUFDeEYsSUFBTyxvQkFBb0IsV0FBYSw4Q0FBOEMsQ0FBQyxDQUFDO0FBTXhGLElBQU8sWUFBWSxXQUFlLDJDQUEyQyxDQUFDLENBQUM7QUFJL0UsQUFLQTs7OztHQURHO0lBQ0csYUFBYTtJQUFTQSxVQUF0QkEsYUFBYUEsVUFBcUJBO0lBTXZDQTs7OztPQUlHQTtJQUNIQSxTQVhLQSxhQUFhQSxDQVdOQSxJQUFxQkEsRUFBRUEsYUFBNkJBO1FBQTdCQyw2QkFBNkJBLEdBQTdCQSxxQkFBNkJBO1FBRS9EQSxpQkFBT0EsQ0FBQ0E7UUFFUkEsSUFBSUEsQ0FBQ0EsS0FBS0EsR0FBR0EsSUFBSUEsQ0FBQ0E7UUFFbEJBLElBQUlBLENBQUNBLGNBQWNBLEdBQUdBLGFBQWFBLENBQUNBO1FBQ3BDQSxJQUFJQSxDQUFDQSxhQUFhQSxHQUFHQSxDQUFDQSxDQUFDQTtRQUN2QkEsSUFBSUEsQ0FBQ0EsYUFBYUEsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFDdkJBLElBQUlBLENBQUNBLGFBQWFBLEdBQUdBLENBQUNBLENBQUNBO0lBRXhCQSxDQUFDQTtJQUVERCxzQkFBV0EsdUNBQVlBO2FBQXZCQTtZQUVDRSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxhQUFhQSxDQUFDQTtRQUMzQkEsQ0FBQ0E7YUFFREYsVUFB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QUFVQSxDQUFDQSxDQUFDQTtnQkFFekRBLFVBQVVBLENBQUNBLFFBQVFBLENBQUNBLGNBQWNBLENBQUNBLFVBQVVBLEVBQUVBLElBQUlBLEVBQUVBLE1BQU1BLENBQUNBLENBQUNBO2dCQUU3REEsR0FBR0EsQ0FBQ0E7b0JBQ0hBLFdBQVdBLENBQUNBLFFBQVFBLENBQUNBLFlBQVlBLENBQUNBLFVBQVVBLEVBQUVBLFdBQVdBLEVBQUVBLElBQUlBLENBQUNBLE9BQU9BLEVBQUVBLE1BQU1BLEVBQUVBLElBQUlBLENBQUNBLHlCQUF5QkEsQ0FBQ0EsQ0FBQ0E7b0JBRWpIQSxXQUFXQSxHQUFHQSxXQUFXQSxDQUFDQSxJQUFJQSxDQUFDQTtnQkFFaENBLENBQUNBLFFBQVFBLFdBQVdBLElBQUlBLFdBQVdBLENBQUNBLFFBQVFBLElBQUlBLFVBQVVBLENBQUNBLFFBQVFBLEVBQUVBO2dCQUVyRUEsVUFBVUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxVQUFVQSxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUN4REEsQ0FBQ0E7WUFFREEsVUFBVUEsR0FBR0EsV0FBV0EsQ0FBQ0E7UUFDMUJBLENBQUNBO0lBQ0ZBLENBQUNBO0lBQ0ZOLG9CQUFDQTtBQUFEQSxDQTNLQSxBQTJLQ0EsRUEzSzJCLFlBQVksRUEyS3ZDO0FBRUQsQUFBdUIsaUJBQWQsYUFBYSxDQUFDIiwiZmlsZSI6InJlbmRlci9EZXB0aFJlbmRlcmVyLmpzIiwic291cmNlUm9vdCI6Ii4uLyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBQbGFuZTNEXHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2dlb20vUGxhbmUzRFwiKTtcbmltcG9ydCBSZWN0YW5nbGVcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2dlb20vUmVjdGFuZ2xlXCIpO1xuaW1wb3J0IFRleHR1cmVQcm94eUJhc2VcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi90ZXh0dXJlcy9UZXh0dXJlUHJveHlCYXNlXCIpO1xuXG5pbXBvcnQgQ2FtZXJhXHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL2VudGl0aWVzL0NhbWVyYVwiKTtcbmltcG9ydCBJRW50aXR5XHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL2VudGl0aWVzL0lFbnRpdHlcIik7XG5pbXBvcnQgRW50aXR5Q29sbGVjdG9yXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvdHJhdmVyc2UvRW50aXR5Q29sbGVjdG9yXCIpO1xuaW1wb3J0IFNoYWRvd0Nhc3RlckNvbGxlY3Rvclx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvdHJhdmVyc2UvU2hhZG93Q2FzdGVyQ29sbGVjdG9yXCIpO1xuXG5pbXBvcnQgQ29udGV4dEdMQmxlbmRGYWN0b3JcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYmFzZS9Db250ZXh0R0xCbGVuZEZhY3RvclwiKTtcbmltcG9ydCBDb250ZXh0R0xDb21wYXJlTW9kZVx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9iYXNlL0NvbnRleHRHTENvbXBhcmVNb2RlXCIpO1xuaW1wb3J0IElDb250ZXh0U3RhZ2VHTFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2Jhc2UvSUNvbnRleHRTdGFnZUdMXCIpO1xuXG5pbXBvcnQgTWF0ZXJpYWxEYXRhXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9wb29sL01hdGVyaWFsRGF0YVwiKTtcbmltcG9ydCBNYXRlcmlhbFBhc3NEYXRhXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvcG9vbC9NYXRlcmlhbFBhc3NEYXRhXCIpO1xuaW1wb3J0IFJlbmRlcmFibGVCYXNlXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvcG9vbC9SZW5kZXJhYmxlQmFzZVwiKTtcbmltcG9ydCBSZW5kZXJlckJhc2VcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL3JlbmRlci9SZW5kZXJlckJhc2VcIik7XG5pbXBvcnQgTWF0ZXJpYWxQYXNzQmFzZVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL21hdGVyaWFscy9wYXNzZXMvTWF0ZXJpYWxQYXNzQmFzZVwiKTtcblxuXG4vKipcbiAqIFRoZSBEZXB0aFJlbmRlcmVyIGNsYXNzIHJlbmRlcnMgMzItYml0IGRlcHRoIGluZm9ybWF0aW9uIGVuY29kZWQgYXMgUkdCQVxuICpcbiAqIEBjbGFzcyBhd2F5LnJlbmRlci5EZXB0aFJlbmRlcmVyXG4gKi9cbmNsYXNzIERlcHRoUmVuZGVyZXIgZXh0ZW5kcyBSZW5kZXJlckJhc2Vcbntcblx0cHJpdmF0ZSBfcGFzczpNYXRlcmlhbFBhc3NCYXNlO1xuXHRwcml2YXRlIF9yZW5kZXJCbGVuZGVkOmJvb2xlYW47XG5cdHByaXZhdGUgX2Rpc2FibGVDb2xvcjpib29sZWFuO1xuXG5cdC8qKlxuXHQgKiBDcmVhdGVzIGEgbmV3IERlcHRoUmVuZGVyZXIgb2JqZWN0LlxuXHQgKiBAcGFyYW0gcmVuZGVyQmxlbmRlZCBJbmRpY2F0ZXMgd2hldGhlciBzZW1pLXRyYW5zcGFyZW50IG9iamVjdHMgc2hvdWxkIGJlIHJlbmRlcmVkLlxuXHQgKiBAcGFyYW0gZGlzdGFuY2VCYXNlZCBJbmRpY2F0ZXMgd2hldGhlciB0aGUgd3JpdHRlbiBkZXB0aCB2YWx1ZSBpcyBkaXN0YW5jZS1iYXNlZCBvciBwcm9qZWN0ZWQgZGVwdGgtYmFzZWRcblx0ICovXG5cdGNvbnN0cnVjdG9yKHBhc3M6TWF0ZXJpYWxQYXNzQmFzZSwgcmVuZGVyQmxlbmRlZDpib29sZWFuID0gZmFsc2UpXG5cdHtcblx0XHRzdXBlcigpO1xuXG5cdFx0dGhpcy5fcGFzcyA9IHBhc3M7XG5cblx0XHR0aGlzLl9yZW5kZXJCbGVuZGVkID0gcmVuZGVyQmxlbmRlZDtcblx0XHR0aGlzLl9pQmFja2dyb3VuZFIgPSAxO1xuXHRcdHRoaXMuX2lCYWNrZ3JvdW5kRyA9IDE7XG5cdFx0dGhpcy5faUJhY2tncm91bmRCID0gMTtcblxuXHR9XG5cblx0cHVibGljIGdldCBkaXNhYmxlQ29sb3IoKTpib29sZWFuXG5cdHtcblx0XHRyZXR1cm4gdGhpcy5fZGlzYWJsZUNvbG9yO1xuXHR9XG5cblx0cHVibGljIHNldCBkaXNhYmxlQ29sb3IodmFsdWU6Ym9vbGVhbilcblx0e1xuXHRcdHRoaXMuX2Rpc2FibGVDb2xvciA9IHZhbHVlO1xuXHR9XG5cblx0cHVibGljIF9pUmVuZGVyQ2FzY2FkZXMoZW50aXR5Q29sbGVjdG9yOlNoYWRvd0Nhc3RlckNvbGxlY3RvciwgdGFyZ2V0OlRleHR1cmVQcm94eUJhc2UsIG51bUNhc2NhZGVzOm51bWJlciwgc2Npc3NvclJlY3RzOkFycmF5PFJlY3RhbmdsZT4sIGNhbWVyYXM6QXJyYXk8Q2FtZXJhPilcblx0e1xuXHRcdHRoaXMucENvbGxlY3RSZW5kZXJhYmxlcyhlbnRpdHlDb2xsZWN0b3IpO1xuXG5cdFx0dGhpcy5fcENvbnRleHQuc2V0UmVuZGVyVGFyZ2V0KHRhcmdldCwgdHJ1ZSwgMCk7XG5cdFx0dGhpcy5fcENvbnRleHQuY2xlYXIoMSwgMSwgMSwgMSwgMSwgMCk7XG5cblx0XHR0aGlzLl9wQ29udGV4dC5zZXRCbGVuZEZhY3RvcnMoQ29udGV4dEdMQmxlbmRGYWN0b3IuT05FLCBDb250ZXh0R0xCbGVuZEZhY3Rvci5aRVJPKTtcblx0XHR0aGlzLl9wQ29udGV4dC5zZXREZXB0aFRlc3QodHJ1ZSwgQ29udGV4dEdMQ29tcGFyZU1vZGUuTEVTUyk7XG5cblx0XHR2YXIgaGVhZDpSZW5kZXJhYmxlQmFzZSA9IHRoaXMuX3BPcGFxdWVSZW5kZXJhYmxlSGVhZDtcblxuXHRcdHZhciBmaXJzdDpib29sZWFuID0gdHJ1ZTtcblxuXHRcdGZvciAodmFyIGk6bnVtYmVyID0gbnVtQ2FzY2FkZXMgLSAxOyBpID49IDA7IC0taSkge1xuXHRcdFx0dGhpcy5fcFN0YWdlLnNjaXNzb3JSZWN0ID0gc2Npc3NvclJlY3RzW2ldO1xuXHRcdFx0dGhpcy5kcmF3Q2FzY2FkZVJlbmRlcmFibGVzKGhlYWQsIGNhbWVyYXNbaV0sIGZpcnN0PyBudWxsIDogY2FtZXJhc1tpXS5mcnVzdHVtUGxhbmVzKTtcblx0XHRcdGZpcnN0ID0gZmFsc2U7XG5cdFx0fVxuXG5cdFx0Ly9saW5lIHJlcXVpcmVkIGZvciBjb3JyZWN0IHJlbmRlcmluZyB3aGVuIHVzaW5nIGF3YXkzZCB3aXRoIHN0YXJsaW5nLiBETyBOT1QgUkVNT1ZFIFVOTEVTUyBTVEFSTElORyBJTlRFR1JBVElPTiBJUyBSRVRFU1RFRCFcblx0XHR0aGlzLl9wQ29udGV4dC5zZXREZXB0aFRlc3QoZmFsc2UsIENvbnRleHRHTENvbXBhcmVNb2RlLkxFU1NfRVFVQUwpO1xuXG5cdFx0dGhpcy5fcFN0YWdlLnNjaXNzb3JSZWN0ID0gbnVsbDtcblxuXHR9XG5cblx0cHJpdmF0ZSBkcmF3Q2FzY2FkZVJlbmRlcmFibGVzKHJlbmRlcmFibGU6UmVuZGVyYWJsZUJhc2UsIGNhbWVyYTpDYW1lcmEsIGN1bGxQbGFuZXM6QXJyYXk8UGxhbmUzRD4pXG5cdHtcblx0XHR2YXIgYWN0aXZlUGFzczpNYXRlcmlhbFBhc3NEYXRhO1xuXHRcdHZhciBhY3RpdmVNYXRlcmlhbDpNYXRlcmlhbERhdGE7XG5cdFx0dmFyIGNvbnRleHQ6SUNvbnRleHRTdGFnZUdMID0gdGhpcy5fcFN0YWdlLmNvbnRleHQ7XG5cdFx0dmFyIHJlbmRlcmFibGUyOlJlbmRlcmFibGVCYXNlO1xuXG5cdFx0d2hpbGUgKHJlbmRlcmFibGUpIHtcblx0XHRcdGFjdGl2ZU1hdGVyaWFsID0gdGhpcy5nZXRNYXRlcmlhbChyZW5kZXJhYmxlLm1hdGVyaWFsLCB0aGlzLl9wU3RhZ2UucHJvZmlsZSk7XG5cblx0XHRcdHJlbmRlcmFibGUyID0gcmVuZGVyYWJsZTtcblxuXHRcdFx0YWN0aXZlUGFzcyA9IGFjdGl2ZU1hdGVyaWFsLmdldE1hdGVyaWFsUGFzcyh0aGlzLl9wYXNzLCB0aGlzLl9wU3RhZ2UucHJvZmlsZSk7XG5cblx0XHRcdC8vVE9ETzogZ2VuZXJhbGlzZSB0aGlzIHRlc3Rcblx0XHRcdGlmIChhY3RpdmVQYXNzLmtleSA9PSBcIlwiKVxuXHRcdFx0XHR0aGlzLmNhbGNBbmltYXRpb25Db2RlKHJlbmRlcmFibGUubWF0ZXJpYWwsIGFjdGl2ZVBhc3MpO1xuXG5cdFx0XHRyZW5kZXJhYmxlLm1hdGVyaWFsLl9pQWN0aXZhdGVQYXNzKGFjdGl2ZVBhc3MsIHRoaXMsIGNhbWVyYSk7XG5cblx0XHRcdGRvIHtcblx0XHRcdFx0Ly8gaWYgY29tcGxldGVseSBpbiBmcm9udCwgaXQgd2lsbCBmYWxsIGluIGEgZGlmZmVyZW50IGNhc2NhZGVcblx0XHRcdFx0Ly8gZG8gbm90IHVzZSBuZWFyIGFuZCBmYXIgcGxhbmVzXG5cdFx0XHRcdGlmICghY3VsbFBsYW5lcyB8fCByZW5kZXJhYmxlMi5zb3VyY2VFbnRpdHkud29ybGRCb3VuZHMuaXNJbkZydXN0dW0oY3VsbFBsYW5lcywgNCkpIHtcblx0XHRcdFx0XHRyZW5kZXJhYmxlMi5tYXRlcmlhbC5faVJlbmRlclBhc3MoYWN0aXZlUGFzcywgcmVuZGVyYWJsZTIsIHRoaXMuX3BTdGFnZSwgY2FtZXJhLCB0aGlzLl9wUnR0Vmlld1Byb2plY3Rpb25NYXRyaXgpO1xuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdHJlbmRlcmFibGUyLmNhc2NhZGVkID0gdHJ1ZTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdHJlbmRlcmFibGUyID0gcmVuZGVyYWJsZTIubmV4dDtcblxuXHRcdFx0fSB3aGlsZSAocmVuZGVyYWJsZTIgJiYgcmVuZGVyYWJsZTIubWF0ZXJpYWwgPT0gcmVuZGVyYWJsZS5tYXRlcmlhbCAmJiAhcmVuZGVyYWJsZTIuY2FzY2FkZWQpO1xuXG5cdFx0XHRyZW5kZXJhYmxlLm1hdGVyaWFsLl9pRGVhY3RpdmF0ZVBhc3MoYWN0aXZlUGFzcywgdGhpcyk7XG5cblx0XHRcdHJlbmRlcmFibGUgPSByZW5kZXJhYmxlMjtcblx0XHR9XG5cdH1cblxuXHQvKipcblx0ICogQGluaGVyaXREb2Ncblx0ICovXG5cdHB1YmxpYyBwRHJhdyhlbnRpdHlDb2xsZWN0b3I6RW50aXR5Q29sbGVjdG9yLCB0YXJnZXQ6VGV4dHVyZVByb3h5QmFzZSlcblx0e1xuXHRcdHRoaXMucENvbGxlY3RSZW5kZXJhYmxlcyhlbnRpdHlDb2xsZWN0b3IpO1xuXG5cdFx0dGhpcy5fcENvbnRleHQuc2V0QmxlbmRGYWN0b3JzKENvbnRleHRHTEJsZW5kRmFjdG9yLk9ORSwgQ29udGV4dEdMQmxlbmRGYWN0b3IuWkVSTyk7XG5cblx0XHR0aGlzLl9wQ29udGV4dC5zZXREZXB0aFRlc3QodHJ1ZSwgQ29udGV4dEdMQ29tcGFyZU1vZGUuTEVTUyk7XG5cblx0XHR0aGlzLmRyYXdSZW5kZXJhYmxlcyh0aGlzLl9wT3BhcXVlUmVuZGVyYWJsZUhlYWQsIGVudGl0eUNvbGxlY3Rvcik7XG5cblx0XHRpZiAodGhpcy5fZGlzYWJsZUNvbG9yKVxuXHRcdFx0dGhpcy5fcENvbnRleHQuc2V0Q29sb3JNYXNrKGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlKTtcblxuXHRcdGlmICh0aGlzLl9yZW5kZXJCbGVuZGVkKVxuXHRcdFx0dGhpcy5kcmF3UmVuZGVyYWJsZXModGhpcy5fcEJsZW5kZWRSZW5kZXJhYmxlSGVhZCwgZW50aXR5Q29sbGVjdG9yKTtcblxuXHRcdGlmICh0aGlzLl9kaXNhYmxlQ29sb3IpXG5cdFx0XHR0aGlzLl9wQ29udGV4dC5zZXRDb2xvck1hc2sodHJ1ZSwgdHJ1ZSwgdHJ1ZSwgdHJ1ZSk7XG5cdH1cblxuXHQvKipcblx0ICogRHJhdyBhIGxpc3Qgb2YgcmVuZGVyYWJsZXMuXG5cdCAqIEBwYXJhbSByZW5kZXJhYmxlcyBUaGUgcmVuZGVyYWJsZXMgdG8gZHJhdy5cblx0ICogQHBhcmFtIGVudGl0eUNvbGxlY3RvciBUaGUgRW50aXR5Q29sbGVjdG9yIGNvbnRhaW5pbmcgYWxsIHBvdGVudGlhbGx5IHZpc2libGUgaW5mb3JtYXRpb24uXG5cdCAqL1xuXHRwcml2YXRlIGRyYXdSZW5kZXJhYmxlcyhyZW5kZXJhYmxlOlJlbmRlcmFibGVCYXNlLCBlbnRpdHlDb2xsZWN0b3I6RW50aXR5Q29sbGVjdG9yKVxuXHR7XG5cdFx0dmFyIGFjdGl2ZVBhc3M6TWF0ZXJpYWxQYXNzRGF0YTtcblx0XHR2YXIgYWN0aXZlTWF0ZXJpYWw6TWF0ZXJpYWxEYXRhO1xuXHRcdHZhciBjb250ZXh0OklDb250ZXh0U3RhZ2VHTCA9IHRoaXMuX3BTdGFnZS5jb250ZXh0O1xuXHRcdHZhciBjYW1lcmE6Q2FtZXJhID0gZW50aXR5Q29sbGVjdG9yLmNhbWVyYTtcblx0XHR2YXIgcmVuZGVyYWJsZTI6UmVuZGVyYWJsZUJhc2U7XG5cblx0XHR3aGlsZSAocmVuZGVyYWJsZSkge1xuXHRcdFx0YWN0aXZlTWF0ZXJpYWwgPSB0aGlzLmdldE1hdGVyaWFsKHJlbmRlcmFibGUubWF0ZXJpYWwsIHRoaXMuX3BTdGFnZS5wcm9maWxlKTtcblxuXHRcdFx0Ly8gb3RoZXJ3aXNlIHRoaXMgd291bGQgcmVzdWx0IGluIGRlcHRoIHJlbmRlcmVkIGFueXdheSBiZWNhdXNlIGZyYWdtZW50IHNoYWRlciBraWwgaXMgaWdub3JlZFxuXHRcdFx0aWYgKHRoaXMuX2Rpc2FibGVDb2xvciAmJiByZW5kZXJhYmxlLm1hdGVyaWFsLmFscGhhVGhyZXNob2xkICE9IDApIHtcblx0XHRcdFx0cmVuZGVyYWJsZTIgPSByZW5kZXJhYmxlO1xuXHRcdFx0XHQvLyBmYXN0IGZvcndhcmRcblx0XHRcdFx0ZG8ge1xuXHRcdFx0XHRcdHJlbmRlcmFibGUyID0gcmVuZGVyYWJsZTIubmV4dDtcblxuXHRcdFx0XHR9IHdoaWxlIChyZW5kZXJhYmxlMiAmJiByZW5kZXJhYmxlMi5tYXRlcmlhbCA9PSByZW5kZXJhYmxlLm1hdGVyaWFsKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdHJlbmRlcmFibGUyID0gcmVuZGVyYWJsZTtcblxuXHRcdFx0XHRhY3RpdmVQYXNzID0gYWN0aXZlTWF0ZXJpYWwuZ2V0TWF0ZXJpYWxQYXNzKHRoaXMuX3Bhc3MsIHRoaXMuX3BTdGFnZS5wcm9maWxlKTtcblxuXHRcdFx0XHQvL1RPRE86IGdlbmVyYWxpc2UgdGhpcyB0ZXN0XG5cdFx0XHRcdGlmIChhY3RpdmVQYXNzLmtleSA9PSBcIlwiKVxuXHRcdFx0XHRcdHRoaXMuY2FsY0FuaW1hdGlvbkNvZGUocmVuZGVyYWJsZS5tYXRlcmlhbCwgYWN0aXZlUGFzcyk7XG5cblx0XHRcdFx0cmVuZGVyYWJsZS5tYXRlcmlhbC5faUFjdGl2YXRlUGFzcyhhY3RpdmVQYXNzLCB0aGlzLCBjYW1lcmEpO1xuXG5cdFx0XHRcdGRvIHtcblx0XHRcdFx0XHRyZW5kZXJhYmxlMi5tYXRlcmlhbC5faVJlbmRlclBhc3MoYWN0aXZlUGFzcywgcmVuZGVyYWJsZTIsIHRoaXMuX3BTdGFnZSwgY2FtZXJhLCB0aGlzLl9wUnR0Vmlld1Byb2plY3Rpb25NYXRyaXgpO1xuXG5cdFx0XHRcdFx0cmVuZGVyYWJsZTIgPSByZW5kZXJhYmxlMi5uZXh0O1xuXG5cdFx0XHRcdH0gd2hpbGUgKHJlbmRlcmFibGUyICYmIHJlbmRlcmFibGUyLm1hdGVyaWFsID09IHJlbmRlcmFibGUubWF0ZXJpYWwpO1xuXG5cdFx0XHRcdHJlbmRlcmFibGUubWF0ZXJpYWwuX2lEZWFjdGl2YXRlUGFzcyhhY3RpdmVQYXNzLCB0aGlzKTtcblx0XHRcdH1cblxuXHRcdFx0cmVuZGVyYWJsZSA9IHJlbmRlcmFibGUyO1xuXHRcdH1cblx0fVxufVxuXG5leHBvcnQgPSBEZXB0aFJlbmRlcmVyOyJdfQ==