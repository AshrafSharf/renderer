var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var TriangleSubGeometry = require("awayjs-display/lib/base/TriangleSubGeometry");
var ContextGLProgramType = require("awayjs-stagegl/lib/base/ContextGLProgramType");
var VertexDataPool = require("awayjs-stagegl/lib/pool/VertexDataPool");
var AnimatorBase = require("awayjs-renderergl/lib/animators/AnimatorBase");
var VertexAnimationMode = require("awayjs-renderergl/lib/animators/data/VertexAnimationMode");
/**
 * Provides an interface for assigning vertex-based animation data sets to mesh-based entity objects
 * and controlling the various available states of animation through an interative playhead that can be
 * automatically updated or manually triggered.
 */
var VertexAnimator = (function (_super) {
    __extends(VertexAnimator, _super);
    /**
     * Creates a new <code>VertexAnimator</code> object.
     *
     * @param vertexAnimationSet The animation data set containing the vertex animations used by the animator.
     */
    function VertexAnimator(vertexAnimationSet) {
        _super.call(this, vertexAnimationSet);
        this._poses = new Array();
        this._weights = Array(1, 0, 0, 0);
        this._vertexAnimationSet = vertexAnimationSet;
        this._numPoses = vertexAnimationSet.numPoses;
        this._blendMode = vertexAnimationSet.blendMode;
    }
    /**
     * @inheritDoc
     */
    VertexAnimator.prototype.clone = function () {
        return new VertexAnimator(this._vertexAnimationSet);
    };
    /**
     * Plays a sequence with a given name. If the sequence is not found, it may not be loaded yet, and it will retry every frame.
     * @param sequenceName The name of the clip to be played.
     */
    VertexAnimator.prototype.play = function (name, transition, offset) {
        if (transition === void 0) { transition = null; }
        if (offset === void 0) { offset = NaN; }
        if (this._pActiveAnimationName == name)
            return;
        this._pActiveAnimationName = name;
        //TODO: implement transitions in vertex animator
        if (!this._pAnimationSet.hasAnimation(name))
            throw new Error("Animation root node " + name + " not found!");
        this._pActiveNode = this._pAnimationSet.getAnimation(name);
        this._pActiveState = this.getAnimationState(this._pActiveNode);
        if (this.updatePosition) {
            //update straight away to reset position deltas
            this._pActiveState.update(this._pAbsoluteTime);
            this._pActiveState.positionDelta;
        }
        this._activeVertexState = this._pActiveState;
        this.start();
        //apply a time offset if specified
        if (!isNaN(offset))
            this.reset(name, offset);
    };
    /**
     * @inheritDoc
     */
    VertexAnimator.prototype._pUpdateDeltaTime = function (dt) {
        _super.prototype._pUpdateDeltaTime.call(this, dt);
        var geometryFlag = false;
        if (this._poses[0] != this._activeVertexState.currentGeometry) {
            this._poses[0] = this._activeVertexState.currentGeometry;
            geometryFlag = true;
        }
        if (this._poses[1] != this._activeVertexState.nextGeometry) {
            this._poses[1] = this._activeVertexState.nextGeometry;
            geometryFlag = true;
        }
        this._weights[0] = 1 - (this._weights[1] = this._activeVertexState.blendWeight);
        if (geometryFlag) {
            //invalidate meshes
            var mesh;
            var len = this._pOwners.length;
            for (var i = 0; i < len; i++) {
                mesh = this._pOwners[i];
                mesh._iInvalidateRenderableGeometries();
            }
        }
    };
    /**
     * @inheritDoc
     */
    VertexAnimator.prototype.setRenderState = function (shaderObject, renderable, stage, camera, vertexConstantOffset /*int*/, vertexStreamOffset /*int*/) {
        // todo: add code for when running on cpu
        // if no poses defined, set temp data
        if (!this._poses.length) {
            this.setNullPose(shaderObject, renderable, stage, vertexConstantOffset, vertexStreamOffset);
            return;
        }
        // this type of animation can only be SubMesh
        var subMesh = renderable.subMesh;
        var subGeom;
        var i /*uint*/;
        var len = this._numPoses;
        stage.context.setProgramConstantsFromArray(ContextGLProgramType.VERTEX, vertexConstantOffset, this._weights, 1);
        if (this._blendMode == VertexAnimationMode.ABSOLUTE)
            i = 1;
        else
            i = 0;
        for (; i < len; ++i) {
            subGeom = this._poses[i].subGeometries[subMesh._iIndex] || subMesh.subGeometry;
            stage.activateBuffer(vertexStreamOffset++, VertexDataPool.getItem(subGeom, renderable.getIndexData(), TriangleSubGeometry.POSITION_DATA), subGeom.getOffset(TriangleSubGeometry.POSITION_DATA), TriangleSubGeometry.POSITION_FORMAT);
            if (shaderObject.normalDependencies > 0)
                stage.activateBuffer(vertexStreamOffset++, VertexDataPool.getItem(subGeom, renderable.getIndexData(), TriangleSubGeometry.NORMAL_DATA), subGeom.getOffset(TriangleSubGeometry.NORMAL_DATA), TriangleSubGeometry.NORMAL_FORMAT);
        }
    };
    VertexAnimator.prototype.setNullPose = function (shaderObject, renderable, stage, vertexConstantOffset /*int*/, vertexStreamOffset /*int*/) {
        stage.context.setProgramConstantsFromArray(ContextGLProgramType.VERTEX, vertexConstantOffset, this._weights, 1);
        if (this._blendMode == VertexAnimationMode.ABSOLUTE) {
            var len = this._numPoses;
            for (var i = 1; i < len; ++i) {
                stage.activateBuffer(vertexStreamOffset++, renderable.getVertexData(TriangleSubGeometry.POSITION_DATA), renderable.getVertexOffset(TriangleSubGeometry.POSITION_DATA), TriangleSubGeometry.POSITION_FORMAT);
                if (shaderObject.normalDependencies > 0)
                    stage.activateBuffer(vertexStreamOffset++, renderable.getVertexData(TriangleSubGeometry.NORMAL_DATA), renderable.getVertexOffset(TriangleSubGeometry.NORMAL_DATA), TriangleSubGeometry.NORMAL_FORMAT);
            }
        }
        // todo: set temp data for additive?
    };
    /**
     * Verifies if the animation will be used on cpu. Needs to be true for all passes for a material to be able to use it on gpu.
     * Needs to be called if gpu code is potentially required.
     */
    VertexAnimator.prototype.testGPUCompatibility = function (shaderObject) {
    };
    VertexAnimator.prototype.getRenderableSubGeometry = function (renderable, sourceSubGeometry) {
        if (this._blendMode == VertexAnimationMode.ABSOLUTE && this._poses.length)
            return this._poses[0].subGeometries[renderable.subMesh._iIndex] || sourceSubGeometry;
        //nothing to do here
        return sourceSubGeometry;
    };
    return VertexAnimator;
})(AnimatorBase);
module.exports = VertexAnimator;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9hbmltYXRvcnMvVmVydGV4QW5pbWF0b3IudHMiXSwibmFtZXMiOlsiVmVydGV4QW5pbWF0b3IiLCJWZXJ0ZXhBbmltYXRvci5jb25zdHJ1Y3RvciIsIlZlcnRleEFuaW1hdG9yLmNsb25lIiwiVmVydGV4QW5pbWF0b3IucGxheSIsIlZlcnRleEFuaW1hdG9yLl9wVXBkYXRlRGVsdGFUaW1lIiwiVmVydGV4QW5pbWF0b3Iuc2V0UmVuZGVyU3RhdGUiLCJWZXJ0ZXhBbmltYXRvci5zZXROdWxsUG9zZSIsIlZlcnRleEFuaW1hdG9yLnRlc3RHUFVDb21wYXRpYmlsaXR5IiwiVmVydGV4QW5pbWF0b3IuZ2V0UmVuZGVyYWJsZVN1Ykdlb21ldHJ5Il0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFFQSxJQUFPLG1CQUFtQixXQUFjLDZDQUE2QyxDQUFDLENBQUM7QUFNdkYsSUFBTyxvQkFBb0IsV0FBYyw4Q0FBOEMsQ0FBQyxDQUFDO0FBQ3pGLElBQU8sY0FBYyxXQUFlLHdDQUF3QyxDQUFDLENBQUM7QUFFOUUsSUFBTyxZQUFZLFdBQWdCLDhDQUE4QyxDQUFDLENBQUM7QUFFbkYsSUFBTyxtQkFBbUIsV0FBYywwREFBMEQsQ0FBQyxDQUFDO0FBT3BHLEFBS0E7Ozs7R0FERztJQUNHLGNBQWM7SUFBU0EsVUFBdkJBLGNBQWNBLFVBQXFCQTtJQVN4Q0E7Ozs7T0FJR0E7SUFDSEEsU0FkS0EsY0FBY0EsQ0FjUEEsa0JBQXFDQTtRQUVoREMsa0JBQU1BLGtCQUFrQkEsQ0FBQ0EsQ0FBQ0E7UUFibkJBLFdBQU1BLEdBQW1CQSxJQUFJQSxLQUFLQSxFQUFZQSxDQUFDQTtRQUMvQ0EsYUFBUUEsR0FBaUJBLEtBQUtBLENBQVNBLENBQUNBLEVBQUVBLENBQUNBLEVBQUVBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBO1FBYzFEQSxJQUFJQSxDQUFDQSxtQkFBbUJBLEdBQUdBLGtCQUFrQkEsQ0FBQ0E7UUFDOUNBLElBQUlBLENBQUNB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QUNBLE9BQU9BLENBQUNBLE9BQU9BLENBQUNBLElBQUlBLGlCQUFpQkEsQ0FBQ0E7UUFFNUdBLEFBQ0FBLG9CQURvQkE7UUFDcEJBLE1BQU1BLENBQUNBLGlCQUFpQkEsQ0FBQ0E7SUFDMUJBLENBQUNBO0lBQ0ZSLHFCQUFDQTtBQUFEQSxDQXRLQSxBQXNLQ0EsRUF0SzRCLFlBQVksRUFzS3hDO0FBRUQsQUFBd0IsaUJBQWYsY0FBYyxDQUFDIiwiZmlsZSI6ImFuaW1hdG9ycy9WZXJ0ZXhBbmltYXRvci5qcyIsInNvdXJjZVJvb3QiOiIuLi8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgR2VvbWV0cnlcdFx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9iYXNlL0dlb21ldHJ5XCIpO1xyXG5pbXBvcnQgU3ViR2VvbWV0cnlCYXNlXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9iYXNlL1N1Ykdlb21ldHJ5QmFzZVwiKTtcclxuaW1wb3J0IFRyaWFuZ2xlU3ViR2VvbWV0cnlcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9iYXNlL1RyaWFuZ2xlU3ViR2VvbWV0cnlcIik7XHJcbmltcG9ydCBUcmlhbmdsZVN1Yk1lc2hcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL2Jhc2UvVHJpYW5nbGVTdWJNZXNoXCIpO1xyXG5pbXBvcnQgQ2FtZXJhXHRcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvZW50aXRpZXMvQ2FtZXJhXCIpO1xyXG5pbXBvcnQgTWVzaFx0XHRcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvZW50aXRpZXMvTWVzaFwiKTtcclxuXHJcbmltcG9ydCBTdGFnZVx0XHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2Jhc2UvU3RhZ2VcIik7XHJcbmltcG9ydCBDb250ZXh0R0xQcm9ncmFtVHlwZVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2Jhc2UvQ29udGV4dEdMUHJvZ3JhbVR5cGVcIik7XHJcbmltcG9ydCBWZXJ0ZXhEYXRhUG9vbFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvcG9vbC9WZXJ0ZXhEYXRhUG9vbFwiKTtcclxuXHJcbmltcG9ydCBBbmltYXRvckJhc2VcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvYW5pbWF0b3JzL0FuaW1hdG9yQmFzZVwiKTtcclxuaW1wb3J0IFZlcnRleEFuaW1hdGlvblNldFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2FuaW1hdG9ycy9WZXJ0ZXhBbmltYXRpb25TZXRcIik7XHJcbmltcG9ydCBWZXJ0ZXhBbmltYXRpb25Nb2RlXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvYW5pbWF0b3JzL2RhdGEvVmVydGV4QW5pbWF0aW9uTW9kZVwiKTtcclxuaW1wb3J0IElWZXJ0ZXhBbmltYXRpb25TdGF0ZVx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9hbmltYXRvcnMvc3RhdGVzL0lWZXJ0ZXhBbmltYXRpb25TdGF0ZVwiKTtcclxuaW1wb3J0IElBbmltYXRpb25UcmFuc2l0aW9uXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvYW5pbWF0b3JzL3RyYW5zaXRpb25zL0lBbmltYXRpb25UcmFuc2l0aW9uXCIpO1xyXG5pbXBvcnQgVHJpYW5nbGVTdWJNZXNoUmVuZGVyYWJsZVx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvcG9vbC9UcmlhbmdsZVN1Yk1lc2hSZW5kZXJhYmxlXCIpO1xyXG5pbXBvcnQgUmVuZGVyYWJsZUJhc2VcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL3Bvb2wvUmVuZGVyYWJsZUJhc2VcIik7XHJcbmltcG9ydCBTaGFkZXJPYmplY3RCYXNlXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9jb21waWxhdGlvbi9TaGFkZXJPYmplY3RCYXNlXCIpO1xyXG5cclxuLyoqXHJcbiAqIFByb3ZpZGVzIGFuIGludGVyZmFjZSBmb3IgYXNzaWduaW5nIHZlcnRleC1iYXNlZCBhbmltYXRpb24gZGF0YSBzZXRzIHRvIG1lc2gtYmFzZWQgZW50aXR5IG9iamVjdHNcclxuICogYW5kIGNvbnRyb2xsaW5nIHRoZSB2YXJpb3VzIGF2YWlsYWJsZSBzdGF0ZXMgb2YgYW5pbWF0aW9uIHRocm91Z2ggYW4gaW50ZXJhdGl2ZSBwbGF5aGVhZCB0aGF0IGNhbiBiZVxyXG4gKiBhdXRvbWF0aWNhbGx5IHVwZGF0ZWQgb3IgbWFudWFsbHkgdHJpZ2dlcmVkLlxyXG4gKi9cclxuY2xhc3MgVmVydGV4QW5pbWF0b3IgZXh0ZW5kcyBBbmltYXRvckJhc2Vcclxue1xyXG5cdHByaXZhdGUgX3ZlcnRleEFuaW1hdGlvblNldDpWZXJ0ZXhBbmltYXRpb25TZXQ7XHJcblx0cHJpdmF0ZSBfcG9zZXM6QXJyYXk8R2VvbWV0cnk+ID0gbmV3IEFycmF5PEdlb21ldHJ5PigpO1xyXG5cdHByaXZhdGUgX3dlaWdodHM6QXJyYXk8bnVtYmVyPiA9IEFycmF5PG51bWJlcj4oMSwgMCwgMCwgMCk7XHJcblx0cHJpdmF0ZSBfbnVtUG9zZXM6bnVtYmVyIC8qdWludCovO1xyXG5cdHByaXZhdGUgX2JsZW5kTW9kZTpzdHJpbmc7XHJcblx0cHJpdmF0ZSBfYWN0aXZlVmVydGV4U3RhdGU6SVZlcnRleEFuaW1hdGlvblN0YXRlO1xyXG5cclxuXHQvKipcclxuXHQgKiBDcmVhdGVzIGEgbmV3IDxjb2RlPlZlcnRleEFuaW1hdG9yPC9jb2RlPiBvYmplY3QuXHJcblx0ICpcclxuXHQgKiBAcGFyYW0gdmVydGV4QW5pbWF0aW9uU2V0IFRoZSBhbmltYXRpb24gZGF0YSBzZXQgY29udGFpbmluZyB0aGUgdmVydGV4IGFuaW1hdGlvbnMgdXNlZCBieSB0aGUgYW5pbWF0b3IuXHJcblx0ICovXHJcblx0Y29uc3RydWN0b3IodmVydGV4QW5pbWF0aW9uU2V0OlZlcnRleEFuaW1hdGlvblNldClcclxuXHR7XHJcblx0XHRzdXBlcih2ZXJ0ZXhBbmltYXRpb25TZXQpO1xyXG5cclxuXHRcdHRoaXMuX3ZlcnRleEFuaW1hdGlvblNldCA9IHZlcnRleEFuaW1hdGlvblNldDtcclxuXHRcdHRoaXMuX251bVBvc2VzID0gdmVydGV4QW5pbWF0aW9uU2V0Lm51bVBvc2VzO1xyXG5cdFx0dGhpcy5fYmxlbmRNb2RlID0gdmVydGV4QW5pbWF0aW9uU2V0LmJsZW5kTW9kZTtcclxuXHR9XHJcblxyXG5cdC8qKlxyXG5cdCAqIEBpbmhlcml0RG9jXHJcblx0ICovXHJcblx0cHVibGljIGNsb25lKCk6QW5pbWF0b3JCYXNlXHJcblx0e1xyXG5cdFx0cmV0dXJuIG5ldyBWZXJ0ZXhBbmltYXRvcih0aGlzLl92ZXJ0ZXhBbmltYXRpb25TZXQpO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogUGxheXMgYSBzZXF1ZW5jZSB3aXRoIGEgZ2l2ZW4gbmFtZS4gSWYgdGhlIHNlcXVlbmNlIGlzIG5vdCBmb3VuZCwgaXQgbWF5IG5vdCBiZSBsb2FkZWQgeWV0LCBhbmQgaXQgd2lsbCByZXRyeSBldmVyeSBmcmFtZS5cclxuXHQgKiBAcGFyYW0gc2VxdWVuY2VOYW1lIFRoZSBuYW1lIG9mIHRoZSBjbGlwIHRvIGJlIHBsYXllZC5cclxuXHQgKi9cclxuXHRwdWJsaWMgcGxheShuYW1lOnN0cmluZywgdHJhbnNpdGlvbjpJQW5pbWF0aW9uVHJhbnNpdGlvbiA9IG51bGwsIG9mZnNldDpudW1iZXIgPSBOYU4pXHJcblx0e1xyXG5cdFx0aWYgKHRoaXMuX3BBY3RpdmVBbmltYXRpb25OYW1lID09IG5hbWUpXHJcblx0XHRcdHJldHVybjtcclxuXHJcblx0XHR0aGlzLl9wQWN0aXZlQW5pbWF0aW9uTmFtZSA9IG5hbWU7XHJcblxyXG5cdFx0Ly9UT0RPOiBpbXBsZW1lbnQgdHJhbnNpdGlvbnMgaW4gdmVydGV4IGFuaW1hdG9yXHJcblxyXG5cdFx0aWYgKCF0aGlzLl9wQW5pbWF0aW9uU2V0Lmhhc0FuaW1hdGlvbihuYW1lKSlcclxuXHRcdFx0dGhyb3cgbmV3IEVycm9yKFwiQW5pbWF0aW9uIHJvb3Qgbm9kZSBcIiArIG5hbWUgKyBcIiBub3QgZm91bmQhXCIpO1xyXG5cclxuXHRcdHRoaXMuX3BBY3RpdmVOb2RlID0gdGhpcy5fcEFuaW1hdGlvblNldC5nZXRBbmltYXRpb24obmFtZSk7XHJcblxyXG5cdFx0dGhpcy5fcEFjdGl2ZVN0YXRlID0gdGhpcy5nZXRBbmltYXRpb25TdGF0ZSh0aGlzLl9wQWN0aXZlTm9kZSk7XHJcblxyXG5cdFx0aWYgKHRoaXMudXBkYXRlUG9zaXRpb24pIHtcclxuXHRcdFx0Ly91cGRhdGUgc3RyYWlnaHQgYXdheSB0byByZXNldCBwb3NpdGlvbiBkZWx0YXNcclxuXHRcdFx0dGhpcy5fcEFjdGl2ZVN0YXRlLnVwZGF0ZSh0aGlzLl9wQWJzb2x1dGVUaW1lKTtcclxuXHRcdFx0dGhpcy5fcEFjdGl2ZVN0YXRlLnBvc2l0aW9uRGVsdGE7XHJcblx0XHR9XHJcblxyXG5cdFx0dGhpcy5fYWN0aXZlVmVydGV4U3RhdGUgPSA8SVZlcnRleEFuaW1hdGlvblN0YXRlPiB0aGlzLl9wQWN0aXZlU3RhdGU7XHJcblxyXG5cdFx0dGhpcy5zdGFydCgpO1xyXG5cclxuXHRcdC8vYXBwbHkgYSB0aW1lIG9mZnNldCBpZiBzcGVjaWZpZWRcclxuXHRcdGlmICghaXNOYU4ob2Zmc2V0KSlcclxuXHRcdFx0dGhpcy5yZXNldChuYW1lLCBvZmZzZXQpO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogQGluaGVyaXREb2NcclxuXHQgKi9cclxuXHRwdWJsaWMgX3BVcGRhdGVEZWx0YVRpbWUoZHQ6bnVtYmVyKVxyXG5cdHtcclxuXHRcdHN1cGVyLl9wVXBkYXRlRGVsdGFUaW1lKGR0KTtcclxuXHJcblx0XHR2YXIgZ2VvbWV0cnlGbGFnOmJvb2xlYW4gPSBmYWxzZTtcclxuXHJcblx0XHRpZiAodGhpcy5fcG9zZXNbMF0gIT0gdGhpcy5fYWN0aXZlVmVydGV4U3RhdGUuY3VycmVudEdlb21ldHJ5KSB7XHJcblx0XHRcdHRoaXMuX3Bvc2VzWzBdID0gdGhpcy5fYWN0aXZlVmVydGV4U3RhdGUuY3VycmVudEdlb21ldHJ5O1xyXG5cdFx0XHRnZW9tZXRyeUZsYWcgPSB0cnVlO1xyXG5cdFx0fVxyXG5cclxuXHRcdGlmICh0aGlzLl9wb3Nlc1sxXSAhPSB0aGlzLl9hY3RpdmVWZXJ0ZXhTdGF0ZS5uZXh0R2VvbWV0cnkpIHtcclxuXHRcdFx0dGhpcy5fcG9zZXNbMV0gPSB0aGlzLl9hY3RpdmVWZXJ0ZXhTdGF0ZS5uZXh0R2VvbWV0cnk7XHJcblx0XHRcdGdlb21ldHJ5RmxhZyA9IHRydWU7XHJcblx0XHR9XHJcblxyXG5cdFx0dGhpcy5fd2VpZ2h0c1swXSA9IDEgLSAodGhpcy5fd2VpZ2h0c1sxXSA9IHRoaXMuX2FjdGl2ZVZlcnRleFN0YXRlLmJsZW5kV2VpZ2h0KTtcclxuXHJcblx0XHRpZiAoZ2VvbWV0cnlGbGFnKSB7XHJcblx0XHRcdC8vaW52YWxpZGF0ZSBtZXNoZXNcclxuXHRcdFx0dmFyIG1lc2g6TWVzaDtcclxuXHRcdFx0dmFyIGxlbjpudW1iZXIgPSB0aGlzLl9wT3duZXJzLmxlbmd0aDtcclxuXHRcdFx0Zm9yICh2YXIgaTpudW1iZXIgPSAwOyBpIDwgbGVuOyBpKyspIHtcclxuXHRcdFx0XHRtZXNoID0gdGhpcy5fcE93bmVyc1tpXTtcclxuXHRcdFx0XHRtZXNoLl9pSW52YWxpZGF0ZVJlbmRlcmFibGVHZW9tZXRyaWVzKCk7XHJcblx0XHRcdH1cclxuXHRcdH1cclxuXHR9XHJcblxyXG5cdC8qKlxyXG5cdCAqIEBpbmhlcml0RG9jXHJcblx0ICovXHJcblx0cHVibGljIHNldFJlbmRlclN0YXRlKHNoYWRlck9iamVjdDpTaGFkZXJPYmplY3RCYXNlLCByZW5kZXJhYmxlOlJlbmRlcmFibGVCYXNlLCBzdGFnZTpTdGFnZSwgY2FtZXJhOkNhbWVyYSwgdmVydGV4Q29uc3RhbnRPZmZzZXQ6bnVtYmVyIC8qaW50Ki8sIHZlcnRleFN0cmVhbU9mZnNldDpudW1iZXIgLyppbnQqLylcclxuXHR7XHJcblx0XHQvLyB0b2RvOiBhZGQgY29kZSBmb3Igd2hlbiBydW5uaW5nIG9uIGNwdVxyXG5cclxuXHRcdC8vIGlmIG5vIHBvc2VzIGRlZmluZWQsIHNldCB0ZW1wIGRhdGFcclxuXHRcdGlmICghdGhpcy5fcG9zZXMubGVuZ3RoKSB7XHJcblx0XHRcdHRoaXMuc2V0TnVsbFBvc2Uoc2hhZGVyT2JqZWN0LCByZW5kZXJhYmxlLCBzdGFnZSwgdmVydGV4Q29uc3RhbnRPZmZzZXQsIHZlcnRleFN0cmVhbU9mZnNldCk7XHJcblx0XHRcdHJldHVybjtcclxuXHRcdH1cclxuXHJcblx0XHQvLyB0aGlzIHR5cGUgb2YgYW5pbWF0aW9uIGNhbiBvbmx5IGJlIFN1Yk1lc2hcclxuXHRcdHZhciBzdWJNZXNoOlRyaWFuZ2xlU3ViTWVzaCA9IDxUcmlhbmdsZVN1Yk1lc2g+ICg8VHJpYW5nbGVTdWJNZXNoUmVuZGVyYWJsZT4gcmVuZGVyYWJsZSkuc3ViTWVzaDtcclxuXHRcdHZhciBzdWJHZW9tOlN1Ykdlb21ldHJ5QmFzZTtcclxuXHRcdHZhciBpOm51bWJlciAvKnVpbnQqLztcclxuXHRcdHZhciBsZW46bnVtYmVyIC8qdWludCovID0gdGhpcy5fbnVtUG9zZXM7XHJcblxyXG5cdFx0c3RhZ2UuY29udGV4dC5zZXRQcm9ncmFtQ29uc3RhbnRzRnJvbUFycmF5KENvbnRleHRHTFByb2dyYW1UeXBlLlZFUlRFWCwgdmVydGV4Q29uc3RhbnRPZmZzZXQsIHRoaXMuX3dlaWdodHMsIDEpO1xyXG5cclxuXHRcdGlmICh0aGlzLl9ibGVuZE1vZGUgPT0gVmVydGV4QW5pbWF0aW9uTW9kZS5BQlNPTFVURSlcclxuXHRcdFx0aSA9IDE7XHJcblx0XHRlbHNlXHJcblx0XHRcdGkgPSAwO1xyXG5cclxuXHRcdGZvciAoOyBpIDwgbGVuOyArK2kpIHtcclxuXHRcdFx0c3ViR2VvbSA9IHRoaXMuX3Bvc2VzW2ldLnN1Ykdlb21ldHJpZXNbc3ViTWVzaC5faUluZGV4XSB8fCBzdWJNZXNoLnN1Ykdlb21ldHJ5O1xyXG5cclxuXHRcdFx0c3RhZ2UuYWN0aXZhdGVCdWZmZXIodmVydGV4U3RyZWFtT2Zmc2V0KyssIFZlcnRleERhdGFQb29sLmdldEl0ZW0oc3ViR2VvbSwgcmVuZGVyYWJsZS5nZXRJbmRleERhdGEoKSwgVHJpYW5nbGVTdWJHZW9tZXRyeS5QT1NJVElPTl9EQVRBKSwgc3ViR2VvbS5nZXRPZmZzZXQoVHJpYW5nbGVTdWJHZW9tZXRyeS5QT1NJVElPTl9EQVRBKSwgVHJpYW5nbGVTdWJHZW9tZXRyeS5QT1NJVElPTl9GT1JNQVQpO1xyXG5cclxuXHRcdFx0aWYgKHNoYWRlck9iamVjdC5ub3JtYWxEZXBlbmRlbmNpZXMgPiAwKVxyXG5cdFx0XHRcdHN0YWdlLmFjdGl2YXRlQnVmZmVyKHZlcnRleFN0cmVhbU9mZnNldCsrLCBWZXJ0ZXhEYXRhUG9vbC5nZXRJdGVtKHN1Ykdlb20sIHJlbmRlcmFibGUuZ2V0SW5kZXhEYXRhKCksIFRyaWFuZ2xlU3ViR2VvbWV0cnkuTk9STUFMX0RBVEEpLCBzdWJHZW9tLmdldE9mZnNldChUcmlhbmdsZVN1Ykdlb21ldHJ5Lk5PUk1BTF9EQVRBKSwgVHJpYW5nbGVTdWJHZW9tZXRyeS5OT1JNQUxfRk9STUFUKTtcclxuXHRcdH1cclxuXHR9XHJcblxyXG5cdHByaXZhdGUgc2V0TnVsbFBvc2Uoc2hhZGVyT2JqZWN0OlNoYWRlck9iamVjdEJhc2UsIHJlbmRlcmFibGU6UmVuZGVyYWJsZUJhc2UsIHN0YWdlOlN0YWdlLCB2ZXJ0ZXhDb25zdGFudE9mZnNldDpudW1iZXIgLyppbnQqLywgdmVydGV4U3RyZWFtT2Zmc2V0Om51bWJlciAvKmludCovKVxyXG5cdHtcclxuXHRcdHN0YWdlLmNvbnRleHQuc2V0UHJvZ3JhbUNvbnN0YW50c0Zyb21BcnJheShDb250ZXh0R0xQcm9ncmFtVHlwZS5WRVJURVgsIHZlcnRleENvbnN0YW50T2Zmc2V0LCB0aGlzLl93ZWlnaHRzLCAxKTtcclxuXHJcblx0XHRpZiAodGhpcy5fYmxlbmRNb2RlID09IFZlcnRleEFuaW1hdGlvbk1vZGUuQUJTT0xVVEUpIHtcclxuXHRcdFx0dmFyIGxlbjpudW1iZXIgLyp1aW50Ki8gPSB0aGlzLl9udW1Qb3NlcztcclxuXHRcdFx0Zm9yICh2YXIgaTpudW1iZXIgLyp1aW50Ki8gPSAxOyBpIDwgbGVuOyArK2kpIHtcclxuXHRcdFx0XHRzdGFnZS5hY3RpdmF0ZUJ1ZmZlcih2ZXJ0ZXhTdHJlYW1PZmZzZXQrKywgcmVuZGVyYWJsZS5nZXRWZXJ0ZXhEYXRhKFRyaWFuZ2xlU3ViR2VvbWV0cnkuUE9TSVRJT05fREFUQSksIHJlbmRlcmFibGUuZ2V0VmVydGV4T2Zmc2V0KFRyaWFuZ2xlU3ViR2VvbWV0cnkuUE9TSVRJT05fREFUQSksIFRyaWFuZ2xlU3ViR2VvbWV0cnkuUE9TSVRJT05fRk9STUFUKTtcclxuXHJcblx0XHRcdFx0aWYgKHNoYWRlck9iamVjdC5ub3JtYWxEZXBlbmRlbmNpZXMgPiAwKVxyXG5cdFx0XHRcdFx0c3RhZ2UuYWN0aXZhdGVCdWZmZXIodmVydGV4U3RyZWFtT2Zmc2V0KyssIHJlbmRlcmFibGUuZ2V0VmVydGV4RGF0YShUcmlhbmdsZVN1Ykdlb21ldHJ5Lk5PUk1BTF9EQVRBKSwgcmVuZGVyYWJsZS5nZXRWZXJ0ZXhPZmZzZXQoVHJpYW5nbGVTdWJHZW9tZXRyeS5OT1JNQUxfREFUQSksIFRyaWFuZ2xlU3ViR2VvbWV0cnkuTk9STUFMX0ZPUk1BVCk7XHJcblx0XHRcdH1cclxuXHRcdH1cclxuXHRcdC8vIHRvZG86IHNldCB0ZW1wIGRhdGEgZm9yIGFkZGl0aXZlP1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogVmVyaWZpZXMgaWYgdGhlIGFuaW1hdGlvbiB3aWxsIGJlIHVzZWQgb24gY3B1LiBOZWVkcyB0byBiZSB0cnVlIGZvciBhbGwgcGFzc2VzIGZvciBhIG1hdGVyaWFsIHRvIGJlIGFibGUgdG8gdXNlIGl0IG9uIGdwdS5cclxuXHQgKiBOZWVkcyB0byBiZSBjYWxsZWQgaWYgZ3B1IGNvZGUgaXMgcG90ZW50aWFsbHkgcmVxdWlyZWQuXHJcblx0ICovXHJcblx0cHVibGljIHRlc3RHUFVDb21wYXRpYmlsaXR5KHNoYWRlck9iamVjdDpTaGFkZXJPYmplY3RCYXNlKVxyXG5cdHtcclxuXHR9XHJcblxyXG5cdHB1YmxpYyBnZXRSZW5kZXJhYmxlU3ViR2VvbWV0cnkocmVuZGVyYWJsZTpUcmlhbmdsZVN1Yk1lc2hSZW5kZXJhYmxlLCBzb3VyY2VTdWJHZW9tZXRyeTpUcmlhbmdsZVN1Ykdlb21ldHJ5KTpUcmlhbmdsZVN1Ykdlb21ldHJ5XHJcblx0e1xyXG5cdFx0aWYgKHRoaXMuX2JsZW5kTW9kZSA9PSBWZXJ0ZXhBbmltYXRpb25Nb2RlLkFCU09MVVRFICYmIHRoaXMuX3Bvc2VzLmxlbmd0aClcclxuXHRcdFx0cmV0dXJuIDxUcmlhbmdsZVN1Ykdlb21ldHJ5PiB0aGlzLl9wb3Nlc1swXS5zdWJHZW9tZXRyaWVzW3JlbmRlcmFibGUuc3ViTWVzaC5faUluZGV4XSB8fCBzb3VyY2VTdWJHZW9tZXRyeTtcclxuXHJcblx0XHQvL25vdGhpbmcgdG8gZG8gaGVyZVxyXG5cdFx0cmV0dXJuIHNvdXJjZVN1Ykdlb21ldHJ5O1xyXG5cdH1cclxufVxyXG5cclxuZXhwb3J0ID0gVmVydGV4QW5pbWF0b3I7Il19