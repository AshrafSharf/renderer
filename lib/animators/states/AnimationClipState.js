var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var AnimationStateBase = require("awayjs-renderergl/lib/animators/states/AnimationStateBase");
var AnimationStateEvent = require("awayjs-renderergl/lib/events/AnimationStateEvent");
/**
 *
 */
var AnimationClipState = (function (_super) {
    __extends(AnimationClipState, _super);
    function AnimationClipState(animator, animationClipNode) {
        _super.call(this, animator, animationClipNode);
        this._pFramesDirty = true;
        this._animationClipNode = animationClipNode;
    }
    Object.defineProperty(AnimationClipState.prototype, "blendWeight", {
        /**
         * Returns a fractional value between 0 and 1 representing the blending ratio of the current playhead position
         * between the current frame (0) and next frame (1) of the animation.
         *
         * @see #currentFrame
         * @see #nextFrame
         */
        get: function () {
            if (this._pFramesDirty)
                this._pUpdateFrames();
            return this._pBlendWeight;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(AnimationClipState.prototype, "currentFrame", {
        /**
         * Returns the current frame of animation in the clip based on the internal playhead position.
         */
        get: function () {
            if (this._pFramesDirty)
                this._pUpdateFrames();
            return this._pCurrentFrame;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(AnimationClipState.prototype, "nextFrame", {
        /**
         * Returns the next frame of animation in the clip based on the internal playhead position.
         */
        get: function () {
            if (this._pFramesDirty)
                this._pUpdateFrames();
            return this._pNextFrame;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @inheritDoc
     */
    AnimationClipState.prototype.update = function (time /*int*/) {
        if (!this._animationClipNode.looping) {
            if (time > this._pStartTime + this._animationClipNode.totalDuration)
                time = this._pStartTime + this._animationClipNode.totalDuration;
            else if (time < this._pStartTime)
                time = this._pStartTime;
        }
        if (this._pTime == time - this._pStartTime)
            return;
        this._pUpdateTime(time);
    };
    /**
     * @inheritDoc
     */
    AnimationClipState.prototype.phase = function (value) {
        var time = value * this._animationClipNode.totalDuration + this._pStartTime;
        if (this._pTime == time - this._pStartTime)
            return;
        this._pUpdateTime(time);
    };
    /**
     * @inheritDoc
     */
    AnimationClipState.prototype._pUpdateTime = function (time /*int*/) {
        this._pFramesDirty = true;
        this._pTimeDir = (time - this._pStartTime > this._pTime) ? 1 : -1;
        _super.prototype._pUpdateTime.call(this, time);
    };
    /**
     * Updates the nodes internal playhead to determine the current and next animation frame, and the blendWeight between the two.
     *
     * @see #currentFrame
     * @see #nextFrame
     * @see #blendWeight
     */
    AnimationClipState.prototype._pUpdateFrames = function () {
        this._pFramesDirty = false;
        var looping = this._animationClipNode.looping;
        var totalDuration = this._animationClipNode.totalDuration;
        var lastFrame = this._animationClipNode.lastFrame;
        var time = this._pTime;
        //trace("time", time, totalDuration)
        if (looping && (time >= totalDuration || time < 0)) {
            time %= totalDuration;
            if (time < 0)
                time += totalDuration;
        }
        if (!looping && time >= totalDuration) {
            this.notifyPlaybackComplete();
            this._pCurrentFrame = lastFrame;
            this._pNextFrame = lastFrame;
            this._pBlendWeight = 0;
        }
        else if (!looping && time <= 0) {
            this._pCurrentFrame = 0;
            this._pNextFrame = 0;
            this._pBlendWeight = 0;
        }
        else if (this._animationClipNode.fixedFrameRate) {
            var t = time / totalDuration * lastFrame;
            this._pCurrentFrame = Math.floor(t);
            this._pBlendWeight = t - this._pCurrentFrame;
            this._pNextFrame = this._pCurrentFrame + 1;
        }
        else {
            this._pCurrentFrame = 0;
            this._pNextFrame = 0;
            var dur = 0, frameTime /*uint*/;
            var durations = this._animationClipNode.durations;
            do {
                frameTime = dur;
                dur += durations[this._pNextFrame];
                this._pCurrentFrame = this._pNextFrame++;
            } while (time > dur);
            if (this._pCurrentFrame == lastFrame) {
                this._pCurrentFrame = 0;
                this._pNextFrame = 1;
            }
            this._pBlendWeight = (time - frameTime) / durations[this._pCurrentFrame];
        }
    };
    AnimationClipState.prototype.notifyPlaybackComplete = function () {
        if (this._animationStatePlaybackComplete == null)
            this._animationStatePlaybackComplete = new AnimationStateEvent(AnimationStateEvent.PLAYBACK_COMPLETE, this._pAnimator, this, this._animationClipNode);
        this._animationClipNode.dispatchEvent(this._animationStatePlaybackComplete);
    };
    return AnimationClipState;
})(AnimationStateBase);
module.exports = AnimationClipState;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9hbmltYXRvcnMvc3RhdGVzL0FuaW1hdGlvbkNsaXBTdGF0ZS50cyJdLCJuYW1lcyI6WyJBbmltYXRpb25DbGlwU3RhdGUiLCJBbmltYXRpb25DbGlwU3RhdGUuY29uc3RydWN0b3IiLCJBbmltYXRpb25DbGlwU3RhdGUuYmxlbmRXZWlnaHQiLCJBbmltYXRpb25DbGlwU3RhdGUuY3VycmVudEZyYW1lIiwiQW5pbWF0aW9uQ2xpcFN0YXRlLm5leHRGcmFtZSIsIkFuaW1hdGlvbkNsaXBTdGF0ZS51cGRhdGUiLCJBbmltYXRpb25DbGlwU3RhdGUucGhhc2UiLCJBbmltYXRpb25DbGlwU3RhdGUuX3BVcGRhdGVUaW1lIiwiQW5pbWF0aW9uQ2xpcFN0YXRlLl9wVXBkYXRlRnJhbWVzIiwiQW5pbWF0aW9uQ2xpcFN0YXRlLm5vdGlmeVBsYXliYWNrQ29tcGxldGUiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUdBLElBQU8sa0JBQWtCLFdBQWMsMkRBQTJELENBQUMsQ0FBQztBQUNwRyxJQUFPLG1CQUFtQixXQUFjLGtEQUFrRCxDQUFDLENBQUM7QUFFNUYsQUFHQTs7R0FERztJQUNHLGtCQUFrQjtJQUFTQSxVQUEzQkEsa0JBQWtCQSxVQUEyQkE7SUFpRGxEQSxTQWpES0Esa0JBQWtCQSxDQWlEWEEsUUFBcUJBLEVBQUVBLGlCQUF1Q0E7UUFFekVDLGtCQUFNQSxRQUFRQSxFQUFFQSxpQkFBaUJBLENBQUNBLENBQUNBO1FBekM3QkEsa0JBQWFBLEdBQVdBLElBQUlBLENBQUNBO1FBMkNuQ0EsSUFBSUEsQ0FBQ0Esa0JBQWtCQSxHQUFHQSxpQkFBaUJBLENBQUNBO0lBQzdDQSxDQUFDQTtJQW5DREQsc0JBQVdBLDJDQUFXQTtRQVB0QkE7Ozs7OztXQU1HQTthQUNIQTtZQUVDRSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxhQUFhQSxDQUFDQTtnQkFDdEJBLElBQUlBLENBQUNBLGNBQWNBLEVBQUVBLENBQUNBO1lBRXZC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LElBQUlBLFNBQVNBLENBQUNBLENBQUNBLENBQUNBO2dCQUN0Q0EsSUFBSUEsQ0FBQ0EsY0FBY0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ3hCQSxJQUFJQSxDQUFDQSxXQUFXQSxHQUFHQSxDQUFDQSxDQUFDQTtZQUN0QkEsQ0FBQ0E7WUFFREEsSUFBSUEsQ0FBQ0EsYUFBYUEsR0FBR0EsQ0FBQ0EsSUFBSUEsR0FBR0EsU0FBU0EsQ0FBQ0EsR0FBQ0EsU0FBU0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsY0FBY0EsQ0FBQ0EsQ0FBQ0E7UUFDeEVBLENBQUNBO0lBQ0ZBLENBQUNBO0lBRU9SLG1EQUFzQkEsR0FBOUJBO1FBRUNTLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLCtCQUErQkEsSUFBSUEsSUFBSUEsQ0FBQ0E7WUFDaERBLElBQUlBLENBQUNBLCtCQUErQkEsR0FBR0EsSUFBSUEsbUJBQW1CQSxDQUFDQSxtQkFBbUJBLENBQUNBLGlCQUFpQkEsRUFBRUEsSUFBSUEsQ0FBQ0EsVUFBVUEsRUFBRUEsSUFBSUEsRUFBRUEsSUFBSUEsQ0FBQ0Esa0JBQWtCQSxDQUFDQSxDQUFDQTtRQUV2SkEsSUFBSUEsQ0FBQ0Esa0JBQWtCQSxDQUFDQSxhQUFhQSxDQUFDQSxJQUFJQSxDQUFDQSwrQkFBK0JBLENBQUNBLENBQUNBO0lBQzdFQSxDQUFDQTtJQUNGVCx5QkFBQ0E7QUFBREEsQ0FwS0EsQUFvS0NBLEVBcEtnQyxrQkFBa0IsRUFvS2xEO0FBRUQsQUFBNEIsaUJBQW5CLGtCQUFrQixDQUFDIiwiZmlsZSI6ImFuaW1hdG9ycy9zdGF0ZXMvQW5pbWF0aW9uQ2xpcFN0YXRlLmpzIiwic291cmNlUm9vdCI6Ii4uLyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBBbmltYXRvckJhc2VcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvYW5pbWF0b3JzL0FuaW1hdG9yQmFzZVwiKTtcblxuaW1wb3J0IEFuaW1hdGlvbkNsaXBOb2RlQmFzZVx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9hbmltYXRvcnMvbm9kZXMvQW5pbWF0aW9uQ2xpcE5vZGVCYXNlXCIpO1xuaW1wb3J0IEFuaW1hdGlvblN0YXRlQmFzZVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2FuaW1hdG9ycy9zdGF0ZXMvQW5pbWF0aW9uU3RhdGVCYXNlXCIpO1xuaW1wb3J0IEFuaW1hdGlvblN0YXRlRXZlbnRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9ldmVudHMvQW5pbWF0aW9uU3RhdGVFdmVudFwiKTtcblxuLyoqXG4gKlxuICovXG5jbGFzcyBBbmltYXRpb25DbGlwU3RhdGUgZXh0ZW5kcyBBbmltYXRpb25TdGF0ZUJhc2Vcbntcblx0cHJpdmF0ZSBfYW5pbWF0aW9uQ2xpcE5vZGU6QW5pbWF0aW9uQ2xpcE5vZGVCYXNlO1xuXHRwcml2YXRlIF9hbmltYXRpb25TdGF0ZVBsYXliYWNrQ29tcGxldGU6QW5pbWF0aW9uU3RhdGVFdmVudDtcblx0cHVibGljIF9wQmxlbmRXZWlnaHQ6bnVtYmVyO1xuXHRwdWJsaWMgX3BDdXJyZW50RnJhbWU6bnVtYmVyIC8qdWludCovO1xuXHRwdWJsaWMgX3BOZXh0RnJhbWU6bnVtYmVyIC8qdWludCovO1xuXG5cdHB1YmxpYyBfcE9sZEZyYW1lOm51bWJlciAvKnVpbnQqLztcblx0cHVibGljIF9wVGltZURpcjpudW1iZXIgLyppbnQqLztcblx0cHVibGljIF9wRnJhbWVzRGlydHk6Ym9vbGVhbiA9IHRydWU7XG5cblx0LyoqXG5cdCAqIFJldHVybnMgYSBmcmFjdGlvbmFsIHZhbHVlIGJldHdlZW4gMCBhbmQgMSByZXByZXNlbnRpbmcgdGhlIGJsZW5kaW5nIHJhdGlvIG9mIHRoZSBjdXJyZW50IHBsYXloZWFkIHBvc2l0aW9uXG5cdCAqIGJldHdlZW4gdGhlIGN1cnJlbnQgZnJhbWUgKDApIGFuZCBuZXh0IGZyYW1lICgxKSBvZiB0aGUgYW5pbWF0aW9uLlxuXHQgKlxuXHQgKiBAc2VlICNjdXJyZW50RnJhbWVcblx0ICogQHNlZSAjbmV4dEZyYW1lXG5cdCAqL1xuXHRwdWJsaWMgZ2V0IGJsZW5kV2VpZ2h0KCk6bnVtYmVyXG5cdHtcblx0XHRpZiAodGhpcy5fcEZyYW1lc0RpcnR5KVxuXHRcdFx0dGhpcy5fcFVwZGF0ZUZyYW1lcygpO1xuXG5cdFx0cmV0dXJuIHRoaXMuX3BCbGVuZFdlaWdodDtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIHRoZSBjdXJyZW50IGZyYW1lIG9mIGFuaW1hdGlvbiBpbiB0aGUgY2xpcCBiYXNlZCBvbiB0aGUgaW50ZXJuYWwgcGxheWhlYWQgcG9zaXRpb24uXG5cdCAqL1xuXHRwdWJsaWMgZ2V0IGN1cnJlbnRGcmFtZSgpOm51bWJlciAvKnVpbnQqL1xuXHR7XG5cdFx0aWYgKHRoaXMuX3BGcmFtZXNEaXJ0eSlcblx0XHRcdHRoaXMuX3BVcGRhdGVGcmFtZXMoKTtcblxuXHRcdHJldHVybiB0aGlzLl9wQ3VycmVudEZyYW1lO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJldHVybnMgdGhlIG5leHQgZnJhbWUgb2YgYW5pbWF0aW9uIGluIHRoZSBjbGlwIGJhc2VkIG9uIHRoZSBpbnRlcm5hbCBwbGF5aGVhZCBwb3NpdGlvbi5cblx0ICovXG5cdHB1YmxpYyBnZXQgbmV4dEZyYW1lKCk6bnVtYmVyIC8qdWludCovXG5cdHtcblx0XHRpZiAodGhpcy5fcEZyYW1lc0RpcnR5KVxuXHRcdFx0dGhpcy5fcFVwZGF0ZUZyYW1lcygpO1xuXG5cdFx0cmV0dXJuIHRoaXMuX3BOZXh0RnJhbWU7XG5cdH1cblxuXHRjb25zdHJ1Y3RvcihhbmltYXRvcjpBbmltYXRvckJhc2UsIGFuaW1hdGlvbkNsaXBOb2RlOkFuaW1hdGlvbkNsaXBOb2RlQmFzZSlcblx0e1xuXHRcdHN1cGVyKGFuaW1hdG9yLCBhbmltYXRpb25DbGlwTm9kZSk7XG5cblx0XHR0aGlzLl9hbmltYXRpb25DbGlwTm9kZSA9IGFuaW1hdGlvbkNsaXBOb2RlO1xuXHR9XG5cblx0LyoqXG5cdCAqIEBpbmhlcml0RG9jXG5cdCAqL1xuXHRwdWJsaWMgdXBkYXRlKHRpbWU6bnVtYmVyIC8qaW50Ki8pXG5cdHtcblx0XHRpZiAoIXRoaXMuX2FuaW1hdGlvbkNsaXBOb2RlLmxvb3BpbmcpIHtcblx0XHRcdGlmICh0aW1lID4gdGhpcy5fcFN0YXJ0VGltZSArIHRoaXMuX2FuaW1hdGlvbkNsaXBOb2RlLnRvdGFsRHVyYXRpb24pXG5cdFx0XHRcdHRpbWUgPSB0aGlzLl9wU3RhcnRUaW1lICsgdGhpcy5fYW5pbWF0aW9uQ2xpcE5vZGUudG90YWxEdXJhdGlvbjsgZWxzZSBpZiAodGltZSA8IHRoaXMuX3BTdGFydFRpbWUpXG5cdFx0XHRcdHRpbWUgPSB0aGlzLl9wU3RhcnRUaW1lO1xuXHRcdH1cblxuXHRcdGlmICh0aGlzLl9wVGltZSA9PSB0aW1lIC0gdGhpcy5fcFN0YXJ0VGltZSlcblx0XHRcdHJldHVybjtcblxuXHRcdHRoaXMuX3BVcGRhdGVUaW1lKHRpbWUpO1xuXHR9XG5cblx0LyoqXG5cdCAqIEBpbmhlcml0RG9jXG5cdCAqL1xuXHRwdWJsaWMgcGhhc2UodmFsdWU6bnVtYmVyKVxuXHR7XG5cdFx0dmFyIHRpbWU6bnVtYmVyIC8qaW50Ki8gPSB2YWx1ZSp0aGlzLl9hbmltYXRpb25DbGlwTm9kZS50b3RhbER1cmF0aW9uICsgdGhpcy5fcFN0YXJ0VGltZTtcblxuXHRcdGlmICh0aGlzLl9wVGltZSA9PSB0aW1lIC0gdGhpcy5fcFN0YXJ0VGltZSlcblx0XHRcdHJldHVybjtcblxuXHRcdHRoaXMuX3BVcGRhdGVUaW1lKHRpbWUpO1xuXHR9XG5cblx0LyoqXG5cdCAqIEBpbmhlcml0RG9jXG5cdCAqL1xuXHRwdWJsaWMgX3BVcGRhdGVUaW1lKHRpbWU6bnVtYmVyIC8qaW50Ki8pXG5cdHtcblx0XHR0aGlzLl9wRnJhbWVzRGlydHkgPSB0cnVlO1xuXG5cdFx0dGhpcy5fcFRpbWVEaXIgPSAodGltZSAtIHRoaXMuX3BTdGFydFRpbWUgPiB0aGlzLl9wVGltZSk/IDEgOiAtMTtcblxuXHRcdHN1cGVyLl9wVXBkYXRlVGltZSh0aW1lKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBVcGRhdGVzIHRoZSBub2RlcyBpbnRlcm5hbCBwbGF5aGVhZCB0byBkZXRlcm1pbmUgdGhlIGN1cnJlbnQgYW5kIG5leHQgYW5pbWF0aW9uIGZyYW1lLCBhbmQgdGhlIGJsZW5kV2VpZ2h0IGJldHdlZW4gdGhlIHR3by5cblx0ICpcblx0ICogQHNlZSAjY3VycmVudEZyYW1lXG5cdCAqIEBzZWUgI25leHRGcmFtZVxuXHQgKiBAc2VlICNibGVuZFdlaWdodFxuXHQgKi9cblx0cHVibGljIF9wVXBkYXRlRnJhbWVzKClcblx0e1xuXHRcdHRoaXMuX3BGcmFtZXNEaXJ0eSA9IGZhbHNlO1xuXG5cdFx0dmFyIGxvb3Bpbmc6Ym9vbGVhbiA9IHRoaXMuX2FuaW1hdGlvbkNsaXBOb2RlLmxvb3Bpbmc7XG5cdFx0dmFyIHRvdGFsRHVyYXRpb246bnVtYmVyIC8qdWludCovID0gdGhpcy5fYW5pbWF0aW9uQ2xpcE5vZGUudG90YWxEdXJhdGlvbjtcblx0XHR2YXIgbGFzdEZyYW1lOm51bWJlciAvKnVpbnQqLyA9IHRoaXMuX2FuaW1hdGlvbkNsaXBOb2RlLmxhc3RGcmFtZTtcblx0XHR2YXIgdGltZTpudW1iZXIgLyppbnQqLyA9IHRoaXMuX3BUaW1lO1xuXG5cdFx0Ly90cmFjZShcInRpbWVcIiwgdGltZSwgdG90YWxEdXJhdGlvbilcblx0XHRpZiAobG9vcGluZyAmJiAodGltZSA+PSB0b3RhbER1cmF0aW9uIHx8IHRpbWUgPCAwKSkge1xuXHRcdFx0dGltZSAlPSB0b3RhbER1cmF0aW9uO1xuXHRcdFx0aWYgKHRpbWUgPCAwKVxuXHRcdFx0XHR0aW1lICs9IHRvdGFsRHVyYXRpb247XG5cdFx0fVxuXG5cdFx0aWYgKCFsb29waW5nICYmIHRpbWUgPj0gdG90YWxEdXJhdGlvbikge1xuXHRcdFx0dGhpcy5ub3RpZnlQbGF5YmFja0NvbXBsZXRlKCk7XG5cdFx0XHR0aGlzLl9wQ3VycmVudEZyYW1lID0gbGFzdEZyYW1lO1xuXHRcdFx0dGhpcy5fcE5leHRGcmFtZSA9IGxhc3RGcmFtZTtcblx0XHRcdHRoaXMuX3BCbGVuZFdlaWdodCA9IDA7XG5cdFx0fSBlbHNlIGlmICghbG9vcGluZyAmJiB0aW1lIDw9IDApIHtcblx0XHRcdHRoaXMuX3BDdXJyZW50RnJhbWUgPSAwO1xuXHRcdFx0dGhpcy5fcE5leHRGcmFtZSA9IDA7XG5cdFx0XHR0aGlzLl9wQmxlbmRXZWlnaHQgPSAwO1xuXHRcdH0gZWxzZSBpZiAodGhpcy5fYW5pbWF0aW9uQ2xpcE5vZGUuZml4ZWRGcmFtZVJhdGUpIHtcblx0XHRcdHZhciB0Om51bWJlciA9IHRpbWUvdG90YWxEdXJhdGlvbipsYXN0RnJhbWU7XG5cdFx0XHR0aGlzLl9wQ3VycmVudEZyYW1lID0gTWF0aC5mbG9vcih0KTtcblx0XHRcdHRoaXMuX3BCbGVuZFdlaWdodCA9IHQgLSB0aGlzLl9wQ3VycmVudEZyYW1lO1xuXHRcdFx0dGhpcy5fcE5leHRGcmFtZSA9IHRoaXMuX3BDdXJyZW50RnJhbWUgKyAxO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHR0aGlzLl9wQ3VycmVudEZyYW1lID0gMDtcblx0XHRcdHRoaXMuX3BOZXh0RnJhbWUgPSAwO1xuXG5cdFx0XHR2YXIgZHVyOm51bWJlciAvKnVpbnQqLyA9IDAsIGZyYW1lVGltZTpudW1iZXIgLyp1aW50Ki87XG5cdFx0XHR2YXIgZHVyYXRpb25zOkFycmF5PG51bWJlcj4gLyp1aW50Ki8gPSB0aGlzLl9hbmltYXRpb25DbGlwTm9kZS5kdXJhdGlvbnM7XG5cblx0XHRcdGRvIHtcblx0XHRcdFx0ZnJhbWVUaW1lID0gZHVyO1xuXHRcdFx0XHRkdXIgKz0gZHVyYXRpb25zW3RoaXMuX3BOZXh0RnJhbWVdO1xuXHRcdFx0XHR0aGlzLl9wQ3VycmVudEZyYW1lID0gdGhpcy5fcE5leHRGcmFtZSsrO1xuXHRcdFx0fSB3aGlsZSAodGltZSA+IGR1cik7XG5cblx0XHRcdGlmICh0aGlzLl9wQ3VycmVudEZyYW1lID09IGxhc3RGcmFtZSkge1xuXHRcdFx0XHR0aGlzLl9wQ3VycmVudEZyYW1lID0gMDtcblx0XHRcdFx0dGhpcy5fcE5leHRGcmFtZSA9IDE7XG5cdFx0XHR9XG5cblx0XHRcdHRoaXMuX3BCbGVuZFdlaWdodCA9ICh0aW1lIC0gZnJhbWVUaW1lKS9kdXJhdGlvbnNbdGhpcy5fcEN1cnJlbnRGcmFtZV07XG5cdFx0fVxuXHR9XG5cblx0cHJpdmF0ZSBub3RpZnlQbGF5YmFja0NvbXBsZXRlKClcblx0e1xuXHRcdGlmICh0aGlzLl9hbmltYXRpb25TdGF0ZVBsYXliYWNrQ29tcGxldGUgPT0gbnVsbClcblx0XHRcdHRoaXMuX2FuaW1hdGlvblN0YXRlUGxheWJhY2tDb21wbGV0ZSA9IG5ldyBBbmltYXRpb25TdGF0ZUV2ZW50KEFuaW1hdGlvblN0YXRlRXZlbnQuUExBWUJBQ0tfQ09NUExFVEUsIHRoaXMuX3BBbmltYXRvciwgdGhpcywgdGhpcy5fYW5pbWF0aW9uQ2xpcE5vZGUpO1xuXG5cdFx0dGhpcy5fYW5pbWF0aW9uQ2xpcE5vZGUuZGlzcGF0Y2hFdmVudCh0aGlzLl9hbmltYXRpb25TdGF0ZVBsYXliYWNrQ29tcGxldGUpO1xuXHR9XG59XG5cbmV4cG9ydCA9IEFuaW1hdGlvbkNsaXBTdGF0ZTsiXX0=