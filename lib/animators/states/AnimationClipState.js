var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var AnimationStateBase = require("awayjs-renderergl/lib/animators/states/AnimationStateBase");
var AnimationStateEvent = require("awayjs-renderergl/lib/events/AnimationStateEvent");
/**
 *
 */
var AnimationClipState = (function (_super) {
    __extends(AnimationClipState, _super);
    function AnimationClipState(animator, animationClipNode) {
        _super.call(this, animator, animationClipNode);
        this._pFramesDirty = true;
        this._animationClipNode = animationClipNode;
    }
    Object.defineProperty(AnimationClipState.prototype, "blendWeight", {
        /**
         * Returns a fractional value between 0 and 1 representing the blending ratio of the current playhead position
         * between the current frame (0) and next frame (1) of the animation.
         *
         * @see #currentFrame
         * @see #nextFrame
         */
        get: function () {
            if (this._pFramesDirty)
                this._pUpdateFrames();
            return this._pBlendWeight;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(AnimationClipState.prototype, "currentFrame", {
        /**
         * Returns the current frame of animation in the clip based on the internal playhead position.
         */
        get: function () {
            if (this._pFramesDirty)
                this._pUpdateFrames();
            return this._pCurrentFrame;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(AnimationClipState.prototype, "nextFrame", {
        /**
         * Returns the next frame of animation in the clip based on the internal playhead position.
         */
        get: function () {
            if (this._pFramesDirty)
                this._pUpdateFrames();
            return this._pNextFrame;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @inheritDoc
     */
    AnimationClipState.prototype.update = function (time /*int*/) {
        if (!this._animationClipNode.looping) {
            if (time > this._pStartTime + this._animationClipNode.totalDuration)
                time = this._pStartTime + this._animationClipNode.totalDuration;
            else if (time < this._pStartTime)
                time = this._pStartTime;
        }
        if (this._pTime == time - this._pStartTime)
            return;
        this._pUpdateTime(time);
    };
    /**
     * @inheritDoc
     */
    AnimationClipState.prototype.phase = function (value) {
        var time = value * this._animationClipNode.totalDuration + this._pStartTime;
        if (this._pTime == time - this._pStartTime)
            return;
        this._pUpdateTime(time);
    };
    /**
     * @inheritDoc
     */
    AnimationClipState.prototype._pUpdateTime = function (time /*int*/) {
        this._pFramesDirty = true;
        this._pTimeDir = (time - this._pStartTime > this._pTime) ? 1 : -1;
        _super.prototype._pUpdateTime.call(this, time);
    };
    /**
     * Updates the nodes internal playhead to determine the current and next animation frame, and the blendWeight between the two.
     *
     * @see #currentFrame
     * @see #nextFrame
     * @see #blendWeight
     */
    AnimationClipState.prototype._pUpdateFrames = function () {
        this._pFramesDirty = false;
        var looping = this._animationClipNode.looping;
        var totalDuration = this._animationClipNode.totalDuration;
        var lastFrame = this._animationClipNode.lastFrame;
        var time = this._pTime;
        //trace("time", time, totalDuration)
        if (looping && (time >= totalDuration || time < 0)) {
            time %= totalDuration;
            if (time < 0)
                time += totalDuration;
        }
        if (!looping && time >= totalDuration) {
            this.notifyPlaybackComplete();
            this._pCurrentFrame = lastFrame;
            this._pNextFrame = lastFrame;
            this._pBlendWeight = 0;
        }
        else if (!looping && time <= 0) {
            this._pCurrentFrame = 0;
            this._pNextFrame = 0;
            this._pBlendWeight = 0;
        }
        else if (this._animationClipNode.fixedFrameRate) {
            var t = time / totalDuration * lastFrame;
            this._pCurrentFrame = Math.floor(t);
            this._pBlendWeight = t - this._pCurrentFrame;
            this._pNextFrame = this._pCurrentFrame + 1;
        }
        else {
            this._pCurrentFrame = 0;
            this._pNextFrame = 0;
            var dur = 0, frameTime /*uint*/;
            var durations = this._animationClipNode.durations;
            do {
                frameTime = dur;
                dur += durations[this._pNextFrame];
                this._pCurrentFrame = this._pNextFrame++;
            } while (time > dur);
            if (this._pCurrentFrame == lastFrame) {
                this._pCurrentFrame = 0;
                this._pNextFrame = 1;
            }
            this._pBlendWeight = (time - frameTime) / durations[this._pCurrentFrame];
        }
    };
    AnimationClipState.prototype.notifyPlaybackComplete = function () {
        if (this._animationStatePlaybackComplete == null)
            this._animationStatePlaybackComplete = new AnimationStateEvent(AnimationStateEvent.PLAYBACK_COMPLETE, this._pAnimator, this, this._animationClipNode);
        this._animationClipNode.dispatchEvent(this._animationStatePlaybackComplete);
    };
    return AnimationClipState;
})(AnimationStateBase);
module.exports = AnimationClipState;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9hbmltYXRvcnMvc3RhdGVzL0FuaW1hdGlvbkNsaXBTdGF0ZS50cyJdLCJuYW1lcyI6WyJBbmltYXRpb25DbGlwU3RhdGUiLCJBbmltYXRpb25DbGlwU3RhdGUuY29uc3RydWN0b3IiLCJBbmltYXRpb25DbGlwU3RhdGUuYmxlbmRXZWlnaHQiLCJBbmltYXRpb25DbGlwU3RhdGUuY3VycmVudEZyYW1lIiwiQW5pbWF0aW9uQ2xpcFN0YXRlLm5leHRGcmFtZSIsIkFuaW1hdGlvbkNsaXBTdGF0ZS51cGRhdGUiLCJBbmltYXRpb25DbGlwU3RhdGUucGhhc2UiLCJBbmltYXRpb25DbGlwU3RhdGUuX3BVcGRhdGVUaW1lIiwiQW5pbWF0aW9uQ2xpcFN0YXRlLl9wVXBkYXRlRnJhbWVzIiwiQW5pbWF0aW9uQ2xpcFN0YXRlLm5vdGlmeVBsYXliYWNrQ29tcGxldGUiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUdBLElBQU8sa0JBQWtCLFdBQWMsMkRBQTJELENBQUMsQ0FBQztBQUNwRyxJQUFPLG1CQUFtQixXQUFjLGtEQUFrRCxDQUFDLENBQUM7QUFFNUYsQUFHQTs7R0FERztJQUNHLGtCQUFrQjtJQUFTQSxVQUEzQkEsa0JBQWtCQSxVQUEyQkE7SUFpRGxEQSxTQWpES0Esa0JBQWtCQSxDQWlEWEEsUUFBcUJBLEVBQUVBLGlCQUF1Q0E7UUFFekVDLGtCQUFNQSxRQUFRQSxFQUFFQSxpQkFBaUJBLENBQUNBLENBQUNBO1FBekM3QkEsa0JBQWFBLEdBQVdBLElBQUlBLENBQUNBO1FBMkNuQ0EsSUFBSUEsQ0FBQ0Esa0JBQWtCQSxHQUFHQSxpQkFBaUJBLENBQUNBO0lBQzdDQSxDQUFDQTtJQW5DREQsc0JBQVdBLDJDQUFXQTtRQVB0QkE7Ozs7OztXQU1HQTthQUNIQTtZQUVDRSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxhQUFhQSxDQUFDQTtnQkFDdEJBLElBQUlBLENBQUNBLGNBQWNBLEVBQUVBLENBQUNBO1lBRXZC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LElBQUlBLFNBQVNBLENBQUNBLENBQUNBLENBQUNBO2dCQUN0Q0EsSUFBSUEsQ0FBQ0EsY0FBY0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ3hCQSxJQUFJQSxDQUFDQSxXQUFXQSxHQUFHQSxDQUFDQSxDQUFDQTtZQUN0QkEsQ0FBQ0E7WUFFREEsSUFBSUEsQ0FBQ0EsYUFBYUEsR0FBR0EsQ0FBQ0EsSUFBSUEsR0FBR0EsU0FBU0EsQ0FBQ0EsR0FBQ0EsU0FBU0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsY0FBY0EsQ0FBQ0EsQ0FBQ0E7UUFDeEVBLENBQUNBO0lBQ0ZBLENBQUNBO0lBRU9SLG1EQUFzQkEsR0FBOUJBO1FBRUNTLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLCtCQUErQkEsSUFBSUEsSUFBSUEsQ0FBQ0E7WUFDaERBLElBQUlBLENBQUNBLCtCQUErQkEsR0FBR0EsSUFBSUEsbUJBQW1CQSxDQUFDQSxtQkFBbUJBLENBQUNBLGlCQUFpQkEsRUFBRUEsSUFBSUEsQ0FBQ0EsVUFBVUEsRUFBRUEsSUFBSUEsRUFBRUEsSUFBSUEsQ0FBQ0Esa0JBQWtCQSxDQUFDQSxDQUFDQTtRQUV2SkEsSUFBSUEsQ0FBQ0Esa0JBQWtCQSxDQUFDQSxhQUFhQSxDQUFDQSxJQUFJQSxDQUFDQSwrQkFBK0JBLENBQUNBLENBQUNBO0lBQzdFQSxDQUFDQTtJQUNGVCx5QkFBQ0E7QUFBREEsQ0FwS0EsQUFvS0NBLEVBcEtnQyxrQkFBa0IsRUFvS2xEO0FBRUQsQUFBNEIsaUJBQW5CLGtCQUFrQixDQUFDIiwiZmlsZSI6ImFuaW1hdG9ycy9zdGF0ZXMvQW5pbWF0aW9uQ2xpcFN0YXRlLmpzIiwic291cmNlUm9vdCI6Ii4uLyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBBbmltYXRvckJhc2VcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvYW5pbWF0b3JzL0FuaW1hdG9yQmFzZVwiKTtcclxuXHJcbmltcG9ydCBBbmltYXRpb25DbGlwTm9kZUJhc2VcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvYW5pbWF0b3JzL25vZGVzL0FuaW1hdGlvbkNsaXBOb2RlQmFzZVwiKTtcclxuaW1wb3J0IEFuaW1hdGlvblN0YXRlQmFzZVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2FuaW1hdG9ycy9zdGF0ZXMvQW5pbWF0aW9uU3RhdGVCYXNlXCIpO1xyXG5pbXBvcnQgQW5pbWF0aW9uU3RhdGVFdmVudFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2V2ZW50cy9BbmltYXRpb25TdGF0ZUV2ZW50XCIpO1xyXG5cclxuLyoqXHJcbiAqXHJcbiAqL1xyXG5jbGFzcyBBbmltYXRpb25DbGlwU3RhdGUgZXh0ZW5kcyBBbmltYXRpb25TdGF0ZUJhc2Vcclxue1xyXG5cdHByaXZhdGUgX2FuaW1hdGlvbkNsaXBOb2RlOkFuaW1hdGlvbkNsaXBOb2RlQmFzZTtcclxuXHRwcml2YXRlIF9hbmltYXRpb25TdGF0ZVBsYXliYWNrQ29tcGxldGU6QW5pbWF0aW9uU3RhdGVFdmVudDtcclxuXHRwdWJsaWMgX3BCbGVuZFdlaWdodDpudW1iZXI7XHJcblx0cHVibGljIF9wQ3VycmVudEZyYW1lOm51bWJlciAvKnVpbnQqLztcclxuXHRwdWJsaWMgX3BOZXh0RnJhbWU6bnVtYmVyIC8qdWludCovO1xyXG5cclxuXHRwdWJsaWMgX3BPbGRGcmFtZTpudW1iZXIgLyp1aW50Ki87XHJcblx0cHVibGljIF9wVGltZURpcjpudW1iZXIgLyppbnQqLztcclxuXHRwdWJsaWMgX3BGcmFtZXNEaXJ0eTpib29sZWFuID0gdHJ1ZTtcclxuXHJcblx0LyoqXHJcblx0ICogUmV0dXJucyBhIGZyYWN0aW9uYWwgdmFsdWUgYmV0d2VlbiAwIGFuZCAxIHJlcHJlc2VudGluZyB0aGUgYmxlbmRpbmcgcmF0aW8gb2YgdGhlIGN1cnJlbnQgcGxheWhlYWQgcG9zaXRpb25cclxuXHQgKiBiZXR3ZWVuIHRoZSBjdXJyZW50IGZyYW1lICgwKSBhbmQgbmV4dCBmcmFtZSAoMSkgb2YgdGhlIGFuaW1hdGlvbi5cclxuXHQgKlxyXG5cdCAqIEBzZWUgI2N1cnJlbnRGcmFtZVxyXG5cdCAqIEBzZWUgI25leHRGcmFtZVxyXG5cdCAqL1xyXG5cdHB1YmxpYyBnZXQgYmxlbmRXZWlnaHQoKTpudW1iZXJcclxuXHR7XHJcblx0XHRpZiAodGhpcy5fcEZyYW1lc0RpcnR5KVxyXG5cdFx0XHR0aGlzLl9wVXBkYXRlRnJhbWVzKCk7XHJcblxyXG5cdFx0cmV0dXJuIHRoaXMuX3BCbGVuZFdlaWdodDtcclxuXHR9XHJcblxyXG5cdC8qKlxyXG5cdCAqIFJldHVybnMgdGhlIGN1cnJlbnQgZnJhbWUgb2YgYW5pbWF0aW9uIGluIHRoZSBjbGlwIGJhc2VkIG9uIHRoZSBpbnRlcm5hbCBwbGF5aGVhZCBwb3NpdGlvbi5cclxuXHQgKi9cclxuXHRwdWJsaWMgZ2V0IGN1cnJlbnRGcmFtZSgpOm51bWJlciAvKnVpbnQqL1xyXG5cdHtcclxuXHRcdGlmICh0aGlzLl9wRnJhbWVzRGlydHkpXHJcblx0XHRcdHRoaXMuX3BVcGRhdGVGcmFtZXMoKTtcclxuXHJcblx0XHRyZXR1cm4gdGhpcy5fcEN1cnJlbnRGcmFtZTtcclxuXHR9XHJcblxyXG5cdC8qKlxyXG5cdCAqIFJldHVybnMgdGhlIG5leHQgZnJhbWUgb2YgYW5pbWF0aW9uIGluIHRoZSBjbGlwIGJhc2VkIG9uIHRoZSBpbnRlcm5hbCBwbGF5aGVhZCBwb3NpdGlvbi5cclxuXHQgKi9cclxuXHRwdWJsaWMgZ2V0IG5leHRGcmFtZSgpOm51bWJlciAvKnVpbnQqL1xyXG5cdHtcclxuXHRcdGlmICh0aGlzLl9wRnJhbWVzRGlydHkpXHJcblx0XHRcdHRoaXMuX3BVcGRhdGVGcmFtZXMoKTtcclxuXHJcblx0XHRyZXR1cm4gdGhpcy5fcE5leHRGcmFtZTtcclxuXHR9XHJcblxyXG5cdGNvbnN0cnVjdG9yKGFuaW1hdG9yOkFuaW1hdG9yQmFzZSwgYW5pbWF0aW9uQ2xpcE5vZGU6QW5pbWF0aW9uQ2xpcE5vZGVCYXNlKVxyXG5cdHtcclxuXHRcdHN1cGVyKGFuaW1hdG9yLCBhbmltYXRpb25DbGlwTm9kZSk7XHJcblxyXG5cdFx0dGhpcy5fYW5pbWF0aW9uQ2xpcE5vZGUgPSBhbmltYXRpb25DbGlwTm9kZTtcclxuXHR9XHJcblxyXG5cdC8qKlxyXG5cdCAqIEBpbmhlcml0RG9jXHJcblx0ICovXHJcblx0cHVibGljIHVwZGF0ZSh0aW1lOm51bWJlciAvKmludCovKVxyXG5cdHtcclxuXHRcdGlmICghdGhpcy5fYW5pbWF0aW9uQ2xpcE5vZGUubG9vcGluZykge1xyXG5cdFx0XHRpZiAodGltZSA+IHRoaXMuX3BTdGFydFRpbWUgKyB0aGlzLl9hbmltYXRpb25DbGlwTm9kZS50b3RhbER1cmF0aW9uKVxyXG5cdFx0XHRcdHRpbWUgPSB0aGlzLl9wU3RhcnRUaW1lICsgdGhpcy5fYW5pbWF0aW9uQ2xpcE5vZGUudG90YWxEdXJhdGlvbjsgZWxzZSBpZiAodGltZSA8IHRoaXMuX3BTdGFydFRpbWUpXHJcblx0XHRcdFx0dGltZSA9IHRoaXMuX3BTdGFydFRpbWU7XHJcblx0XHR9XHJcblxyXG5cdFx0aWYgKHRoaXMuX3BUaW1lID09IHRpbWUgLSB0aGlzLl9wU3RhcnRUaW1lKVxyXG5cdFx0XHRyZXR1cm47XHJcblxyXG5cdFx0dGhpcy5fcFVwZGF0ZVRpbWUodGltZSk7XHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiBAaW5oZXJpdERvY1xyXG5cdCAqL1xyXG5cdHB1YmxpYyBwaGFzZSh2YWx1ZTpudW1iZXIpXHJcblx0e1xyXG5cdFx0dmFyIHRpbWU6bnVtYmVyIC8qaW50Ki8gPSB2YWx1ZSp0aGlzLl9hbmltYXRpb25DbGlwTm9kZS50b3RhbER1cmF0aW9uICsgdGhpcy5fcFN0YXJ0VGltZTtcclxuXHJcblx0XHRpZiAodGhpcy5fcFRpbWUgPT0gdGltZSAtIHRoaXMuX3BTdGFydFRpbWUpXHJcblx0XHRcdHJldHVybjtcclxuXHJcblx0XHR0aGlzLl9wVXBkYXRlVGltZSh0aW1lKTtcclxuXHR9XHJcblxyXG5cdC8qKlxyXG5cdCAqIEBpbmhlcml0RG9jXHJcblx0ICovXHJcblx0cHVibGljIF9wVXBkYXRlVGltZSh0aW1lOm51bWJlciAvKmludCovKVxyXG5cdHtcclxuXHRcdHRoaXMuX3BGcmFtZXNEaXJ0eSA9IHRydWU7XHJcblxyXG5cdFx0dGhpcy5fcFRpbWVEaXIgPSAodGltZSAtIHRoaXMuX3BTdGFydFRpbWUgPiB0aGlzLl9wVGltZSk/IDEgOiAtMTtcclxuXHJcblx0XHRzdXBlci5fcFVwZGF0ZVRpbWUodGltZSk7XHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiBVcGRhdGVzIHRoZSBub2RlcyBpbnRlcm5hbCBwbGF5aGVhZCB0byBkZXRlcm1pbmUgdGhlIGN1cnJlbnQgYW5kIG5leHQgYW5pbWF0aW9uIGZyYW1lLCBhbmQgdGhlIGJsZW5kV2VpZ2h0IGJldHdlZW4gdGhlIHR3by5cclxuXHQgKlxyXG5cdCAqIEBzZWUgI2N1cnJlbnRGcmFtZVxyXG5cdCAqIEBzZWUgI25leHRGcmFtZVxyXG5cdCAqIEBzZWUgI2JsZW5kV2VpZ2h0XHJcblx0ICovXHJcblx0cHVibGljIF9wVXBkYXRlRnJhbWVzKClcclxuXHR7XHJcblx0XHR0aGlzLl9wRnJhbWVzRGlydHkgPSBmYWxzZTtcclxuXHJcblx0XHR2YXIgbG9vcGluZzpib29sZWFuID0gdGhpcy5fYW5pbWF0aW9uQ2xpcE5vZGUubG9vcGluZztcclxuXHRcdHZhciB0b3RhbER1cmF0aW9uOm51bWJlciAvKnVpbnQqLyA9IHRoaXMuX2FuaW1hdGlvbkNsaXBOb2RlLnRvdGFsRHVyYXRpb247XHJcblx0XHR2YXIgbGFzdEZyYW1lOm51bWJlciAvKnVpbnQqLyA9IHRoaXMuX2FuaW1hdGlvbkNsaXBOb2RlLmxhc3RGcmFtZTtcclxuXHRcdHZhciB0aW1lOm51bWJlciAvKmludCovID0gdGhpcy5fcFRpbWU7XHJcblxyXG5cdFx0Ly90cmFjZShcInRpbWVcIiwgdGltZSwgdG90YWxEdXJhdGlvbilcclxuXHRcdGlmIChsb29waW5nICYmICh0aW1lID49IHRvdGFsRHVyYXRpb24gfHwgdGltZSA8IDApKSB7XHJcblx0XHRcdHRpbWUgJT0gdG90YWxEdXJhdGlvbjtcclxuXHRcdFx0aWYgKHRpbWUgPCAwKVxyXG5cdFx0XHRcdHRpbWUgKz0gdG90YWxEdXJhdGlvbjtcclxuXHRcdH1cclxuXHJcblx0XHRpZiAoIWxvb3BpbmcgJiYgdGltZSA+PSB0b3RhbER1cmF0aW9uKSB7XHJcblx0XHRcdHRoaXMubm90aWZ5UGxheWJhY2tDb21wbGV0ZSgpO1xyXG5cdFx0XHR0aGlzLl9wQ3VycmVudEZyYW1lID0gbGFzdEZyYW1lO1xyXG5cdFx0XHR0aGlzLl9wTmV4dEZyYW1lID0gbGFzdEZyYW1lO1xyXG5cdFx0XHR0aGlzLl9wQmxlbmRXZWlnaHQgPSAwO1xyXG5cdFx0fSBlbHNlIGlmICghbG9vcGluZyAmJiB0aW1lIDw9IDApIHtcclxuXHRcdFx0dGhpcy5fcEN1cnJlbnRGcmFtZSA9IDA7XHJcblx0XHRcdHRoaXMuX3BOZXh0RnJhbWUgPSAwO1xyXG5cdFx0XHR0aGlzLl9wQmxlbmRXZWlnaHQgPSAwO1xyXG5cdFx0fSBlbHNlIGlmICh0aGlzLl9hbmltYXRpb25DbGlwTm9kZS5maXhlZEZyYW1lUmF0ZSkge1xyXG5cdFx0XHR2YXIgdDpudW1iZXIgPSB0aW1lL3RvdGFsRHVyYXRpb24qbGFzdEZyYW1lO1xyXG5cdFx0XHR0aGlzLl9wQ3VycmVudEZyYW1lID0gTWF0aC5mbG9vcih0KTtcclxuXHRcdFx0dGhpcy5fcEJsZW5kV2VpZ2h0ID0gdCAtIHRoaXMuX3BDdXJyZW50RnJhbWU7XHJcblx0XHRcdHRoaXMuX3BOZXh0RnJhbWUgPSB0aGlzLl9wQ3VycmVudEZyYW1lICsgMTtcclxuXHRcdH0gZWxzZSB7XHJcblx0XHRcdHRoaXMuX3BDdXJyZW50RnJhbWUgPSAwO1xyXG5cdFx0XHR0aGlzLl9wTmV4dEZyYW1lID0gMDtcclxuXHJcblx0XHRcdHZhciBkdXI6bnVtYmVyIC8qdWludCovID0gMCwgZnJhbWVUaW1lOm51bWJlciAvKnVpbnQqLztcclxuXHRcdFx0dmFyIGR1cmF0aW9uczpBcnJheTxudW1iZXI+IC8qdWludCovID0gdGhpcy5fYW5pbWF0aW9uQ2xpcE5vZGUuZHVyYXRpb25zO1xyXG5cclxuXHRcdFx0ZG8ge1xyXG5cdFx0XHRcdGZyYW1lVGltZSA9IGR1cjtcclxuXHRcdFx0XHRkdXIgKz0gZHVyYXRpb25zW3RoaXMuX3BOZXh0RnJhbWVdO1xyXG5cdFx0XHRcdHRoaXMuX3BDdXJyZW50RnJhbWUgPSB0aGlzLl9wTmV4dEZyYW1lKys7XHJcblx0XHRcdH0gd2hpbGUgKHRpbWUgPiBkdXIpO1xyXG5cclxuXHRcdFx0aWYgKHRoaXMuX3BDdXJyZW50RnJhbWUgPT0gbGFzdEZyYW1lKSB7XHJcblx0XHRcdFx0dGhpcy5fcEN1cnJlbnRGcmFtZSA9IDA7XHJcblx0XHRcdFx0dGhpcy5fcE5leHRGcmFtZSA9IDE7XHJcblx0XHRcdH1cclxuXHJcblx0XHRcdHRoaXMuX3BCbGVuZFdlaWdodCA9ICh0aW1lIC0gZnJhbWVUaW1lKS9kdXJhdGlvbnNbdGhpcy5fcEN1cnJlbnRGcmFtZV07XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHRwcml2YXRlIG5vdGlmeVBsYXliYWNrQ29tcGxldGUoKVxyXG5cdHtcclxuXHRcdGlmICh0aGlzLl9hbmltYXRpb25TdGF0ZVBsYXliYWNrQ29tcGxldGUgPT0gbnVsbClcclxuXHRcdFx0dGhpcy5fYW5pbWF0aW9uU3RhdGVQbGF5YmFja0NvbXBsZXRlID0gbmV3IEFuaW1hdGlvblN0YXRlRXZlbnQoQW5pbWF0aW9uU3RhdGVFdmVudC5QTEFZQkFDS19DT01QTEVURSwgdGhpcy5fcEFuaW1hdG9yLCB0aGlzLCB0aGlzLl9hbmltYXRpb25DbGlwTm9kZSk7XHJcblxyXG5cdFx0dGhpcy5fYW5pbWF0aW9uQ2xpcE5vZGUuZGlzcGF0Y2hFdmVudCh0aGlzLl9hbmltYXRpb25TdGF0ZVBsYXliYWNrQ29tcGxldGUpO1xyXG5cdH1cclxufVxyXG5cclxuZXhwb3J0ID0gQW5pbWF0aW9uQ2xpcFN0YXRlOyJdfQ==