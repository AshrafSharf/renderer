var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var ContextGLVertexBufferFormat = require("awayjs-stagegl/lib/core/stagegl/ContextGLVertexBufferFormat");
var ParticlePropertiesMode = require("awayjs-renderergl/lib/animators/data/ParticlePropertiesMode");
var ParticleStateBase = require("awayjs-renderergl/lib/animators/states/ParticleStateBase");
/**
 * ...
 */
var ParticleSpriteSheetState = (function (_super) {
    __extends(ParticleSpriteSheetState, _super);
    function ParticleSpriteSheetState(animator, particleSpriteSheetNode) {
        _super.call(this, animator, particleSpriteSheetNode);
        this._particleSpriteSheetNode = particleSpriteSheetNode;
        this._usesCycle = this._particleSpriteSheetNode._iUsesCycle;
        this._usesPhase = this._particleSpriteSheetNode._iUsesCycle;
        this._totalFrames = this._particleSpriteSheetNode._iTotalFrames;
        this._numColumns = this._particleSpriteSheetNode._iNumColumns;
        this._numRows = this._particleSpriteSheetNode._iNumRows;
        this._cycleDuration = this._particleSpriteSheetNode._iCycleDuration;
        this._cyclePhase = this._particleSpriteSheetNode._iCyclePhase;
        this.updateSpriteSheetData();
    }
    Object.defineProperty(ParticleSpriteSheetState.prototype, "cyclePhase", {
        /**
         * Defines the cycle phase, when in global mode. Defaults to zero.
         */
        get: function () {
            return this._cyclePhase;
        },
        set: function (value) {
            this._cyclePhase = value;
            this.updateSpriteSheetData();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ParticleSpriteSheetState.prototype, "cycleDuration", {
        /**
         * Defines the cycle duration in seconds, when in global mode. Defaults to 1.
         */
        get: function () {
            return this._cycleDuration;
        },
        set: function (value) {
            this._cycleDuration = value;
            this.updateSpriteSheetData();
        },
        enumerable: true,
        configurable: true
    });
    ParticleSpriteSheetState.prototype.setRenderState = function (stage, renderable, animationSubGeometry, animationRegisterCache, camera) {
        if (animationRegisterCache.needUVAnimation) {
            animationRegisterCache.setVertexConst(animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleSpriteSheetState.UV_INDEX_0), this._spriteSheetData[0], this._spriteSheetData[1], this._spriteSheetData[2], this._spriteSheetData[3]);
            if (this._usesCycle) {
                var index = animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleSpriteSheetState.UV_INDEX_1);
                if (this._particleSpriteSheetNode.mode == ParticlePropertiesMode.LOCAL_STATIC) {
                    if (this._usesPhase)
                        animationSubGeometry.activateVertexBuffer(index, this._particleSpriteSheetNode._iDataOffset, stage, ContextGLVertexBufferFormat.FLOAT_3);
                    else
                        animationSubGeometry.activateVertexBuffer(index, this._particleSpriteSheetNode._iDataOffset, stage, ContextGLVertexBufferFormat.FLOAT_2);
                }
                else
                    animationRegisterCache.setVertexConst(index, this._spriteSheetData[4], this._spriteSheetData[5]);
            }
        }
    };
    ParticleSpriteSheetState.prototype.updateSpriteSheetData = function () {
        this._spriteSheetData = new Array(8);
        var uTotal = this._totalFrames / this._numColumns;
        this._spriteSheetData[0] = uTotal;
        this._spriteSheetData[1] = 1 / this._numColumns;
        this._spriteSheetData[2] = 1 / this._numRows;
        if (this._usesCycle) {
            if (this._cycleDuration <= 0)
                throw (new Error("the cycle duration must be greater than zero"));
            this._spriteSheetData[4] = uTotal / this._cycleDuration;
            this._spriteSheetData[5] = this._cycleDuration;
            if (this._usesPhase)
                this._spriteSheetData[6] = this._cyclePhase;
        }
    };
    /** @private */
    ParticleSpriteSheetState.UV_INDEX_0 = 0;
    /** @private */
    ParticleSpriteSheetState.UV_INDEX_1 = 1;
    return ParticleSpriteSheetState;
})(ParticleStateBase);
module.exports = ParticleSpriteSheetState;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFuaW1hdG9ycy9zdGF0ZXMvcGFydGljbGVzcHJpdGVzaGVldHN0YXRlLnRzIl0sIm5hbWVzIjpbIlBhcnRpY2xlU3ByaXRlU2hlZXRTdGF0ZSIsIlBhcnRpY2xlU3ByaXRlU2hlZXRTdGF0ZS5jb25zdHJ1Y3RvciIsIlBhcnRpY2xlU3ByaXRlU2hlZXRTdGF0ZS5jeWNsZVBoYXNlIiwiUGFydGljbGVTcHJpdGVTaGVldFN0YXRlLmN5Y2xlRHVyYXRpb24iLCJQYXJ0aWNsZVNwcml0ZVNoZWV0U3RhdGUuc2V0UmVuZGVyU3RhdGUiLCJQYXJ0aWNsZVNwcml0ZVNoZWV0U3RhdGUudXBkYXRlU3ByaXRlU2hlZXREYXRhIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFNQSxJQUFPLDJCQUEyQixXQUFZLDZEQUE2RCxDQUFDLENBQUM7QUFJN0csSUFBTyxzQkFBc0IsV0FBYSw2REFBNkQsQ0FBQyxDQUFDO0FBRXpHLElBQU8saUJBQWlCLFdBQWMsMERBQTBELENBQUMsQ0FBQztBQUVsRyxBQUdBOztHQURHO0lBQ0csd0JBQXdCO0lBQVNBLFVBQWpDQSx3QkFBd0JBLFVBQTBCQTtJQWdEdkRBLFNBaERLQSx3QkFBd0JBLENBZ0RqQkEsUUFBeUJBLEVBQUVBLHVCQUErQ0E7UUFFckZDLGtCQUFNQSxRQUFRQSxFQUFFQSx1QkFBdUJBLENBQUNBLENBQUNBO1FBRXpDQSxJQUFJQSxDQUFDQSx3QkFBd0JBLEdBQUdBLHVCQUF1QkEsQ0FBQ0E7UUFFeERBLElBQUlBLENBQUNBLFVBQVVBLEdBQUdBLElBQUlBLENBQUNBLHdCQUF3QkEsQ0FBQ0EsV0FBV0EsQ0FBQ0E7UUFDNURBLElBQUlBLENBQUNBLFVBQVVBLEdBQUdBLElBQUlBLENBQUNBLHdCQUF3QkEsQ0FBQ0EsV0FBV0EsQ0FBQ0E7UUFDNURBLElBQUlBLENBQUNBLFlBQVlBLEdBQUdBLElBQUlBLENBQUNBLHdCQUF3QkEsQ0FBQ0EsYUFBYUEsQ0FBQ0E7UUFDaEVBLElBQUlBLENBQUNBLFdBQVdBLEdBQUdBLElBQUlBLENBQUNBLHdCQUF3QkEsQ0FBQ0EsWUFBWUEsQ0FBQ0E7UUFDOURBLElBQUlBLENBQUNBLFFBQVFBLEdBQUdBLElBQUlBLENBQUNBLHdCQUF3QkEsQ0FBQ0EsU0FBU0EsQ0FBQ0E7UUFDeERBLElBQUlBLENBQUNBLGNBQWNBLEdBQUdBLElBQUlBLENBQUNBLHdCQUF3QkEsQ0FBQ0EsZUFBZUEsQ0FBQ0E7UUFDcEVBLElBQUlBLENBQUNBLFdBQVdBLEdBQUdBLElBQUlBLENBQUNBLHdCQUF3QkEsQ0FBQ0EsWUFBWUEsQ0FBQ0E7UUFFOURBLElBQUlBLENBQUNBLHFCQUFxQkEsRUFBRUEsQ0FBQ0E7SUFDOUJBLENBQUNBO0lBMUNERCxzQkFBV0EsZ0RBQVVBO1FBSHJCQTs7V0FFR0E7YUFDSEE7WUFFQ0UsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0E7UUFDekJBLENBQUNBO2FBRURGLFVBQXNCQSxLQUFZQTtZQUVqQ0UsSUFBSUEsQ0FBQ0EsV0FBV0EsR0FBR0EsS0FBS0EsQ0FBQ0E7WUFFekJBLElBQUlBLENBQUNBLHFCQUFxQkEsRUFBRUEsQ0FBQ0E7UUFDOUJBLENBQUNBOzs7T0FQQUY7SUFZREEsc0JBQVdBLG1EQUFhQTtRQUh4QkE7O1dBRUdBO2FBQ0hBO1lBRUNHLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLGNBQWNBLENBQUNBO1FBQzVCQSxDQUFDQTthQUVESCxVQUF5QkEsS0FBWUE7WUFFcENHLElBQUlBLENBQUNBLGNBQWNBLEdBQUdBLEtBQUtBLENBQUNBO1lBRTVCQSxJQUFJQSxDQUFDQSxxQkFBcUJBLEVBQUVBLENBQUNBO1FBQzlCQSxDQUFDQTs7O09BUEFIO0lBMEJNQSxpREFBY0EsR0FBckJBLFVBQXNCQSxLQUFXQSxFQUFFQSxVQUF5QkEsRUFBRUEsb0JBQXlDQSxFQUFFQSxzQkFBNkNBLEVBQUVBLE1BQWFBO1FBRXBLSSxFQUFFQSxDQUFDQSxDQUFDQSxzQkFBc0JBLENBQUNBLGVBQWVBLENBQUNBLENBQUNBLENBQUNBO1lBQzVDQSxzQkFBc0JBLENBQUNBLGNBQWNBLENBQUNBLHNCQUFzQkEsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxJQUFJQSxDQUFDQSxlQUFlQSxFQUFFQSx3QkFBd0JBLENBQUNBLFVBQVVBLENBQUNBLEVBQUVBLElBQUlBLENBQUNBLGdCQUFnQkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsRUFBRUEsSUFBSUEsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxDQUFDQSxDQUFDQSxFQUFFQSxJQUFJQSxDQUFDQSxnQkFBZ0JBLENBQUNBLENBQUNBLENBQUNBLEVBQUVBLElBQUlBLENBQUNBLGdCQUFnQkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDbFBBLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLFVBQVVBLENBQUNBLENBQUNBLENBQUNBO2dCQUNyQkEsSUFBSUEsS0FBS0EsR0FBa0JBLHNCQUFzQkEsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxJQUFJQSxDQUFDQSxlQUFlQSxFQUFFQSx3QkFBd0JBLENBQUNBLFVBQVVBLENBQUNBLENBQUNBO2dCQUM5SEEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0Esd0JBQXdCQSxDQUFDQSxJQUFJQSxJQUFJQSxzQkFBc0JBLENBQUNBLFlBQVlBLENBQUNBLENBQUNBLENBQUNBO29CQUMvRUEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsVUFBVUEsQ0FBQ0E7d0JBQ25CQSxvQkFBb0JBLENBQUNBLG9CQUFvQkEsQ0FBQ0EsS0FBS0EsRUFBRUEsSUFBSUEsQ0FBQ0Esd0JBQXdCQSxDQUFDQSxZQUFZQSxFQUFFQSxLQUFLQSxFQUFFQSwyQkFBMkJBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBO29CQUMxSUEsSUFBSUE7d0JBQ0hBLG9CQUFvQkEsQ0FBQ0Esb0JBQW9CQSxDQUFDQSxLQUFLQSxFQUFFQSxJQUFJQSxDQUFDQSx3QkFBd0JBLENBQUNBLFlBQVlBLEVBQUVBLEtBQUtBLEVBQUVBLDJCQUEyQkEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0E7Z0JBQzNJQSxDQUFDQTtnQkFBQ0EsSUFBSUE7b0JBQ0xBLHNCQUFzQkEsQ0FBQ0EsY0FBY0EsQ0FBQ0EsS0FBS0EsRUFBRUEsSUFBSUEsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxDQUFDQSxDQUFDQSxFQUFFQSxJQUFJQSxDQUFDQSxnQkFBZ0JBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1lBQ25HQSxDQUFDQTtRQUNGQSxDQUFDQTtJQUNGQSxDQUFDQTtJQUVPSix3REFBcUJBLEdBQTdCQTtRQUVDSyxJQUFJQSxDQUFDQSxnQkFBZ0JBLEdBQUdBLElBQUlBLEtBQUtBLENBQVNBLENBQUNBLENBQUNBLENBQUNBO1FBRTdDQSxJQUFJQSxNQUFNQSxHQUFVQSxJQUFJQSxDQUFDQSxZQUFZQSxHQUFDQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQTtRQUV2REEsSUFBSUEsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxNQUFNQSxDQUFDQTtRQUNsQ0EsSUFBSUEsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxHQUFDQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQTtRQUM5Q0EsSUFBSUEsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxHQUFDQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQTtRQUUzQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDckJBLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLGNBQWNBLElBQUlBLENBQUNBLENBQUNBO2dCQUM1QkEsTUFBS0EsQ0FBQ0EsSUFBSUEsS0FBS0EsQ0FBQ0EsOENBQThDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNsRUEsSUFBSUEsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxNQUFNQSxHQUFDQSxJQUFJQSxDQUFDQSxjQUFjQSxDQUFDQTtZQUN0REEsSUFBSUEsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQSxjQUFjQSxDQUFDQTtZQUMvQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsVUFBVUEsQ0FBQ0E7Z0JBQ25CQSxJQUFJQSxDQUFDQSxnQkFBZ0JBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBO1FBQzlDQSxDQUFDQTtJQUNGQSxDQUFDQTtJQWxHREwsZUFBZUE7SUFDREEsbUNBQVVBLEdBQW1CQSxDQUFDQSxDQUFDQTtJQUU3Q0EsZUFBZUE7SUFDREEsbUNBQVVBLEdBQW1CQSxDQUFDQSxDQUFDQTtJQStGOUNBLCtCQUFDQTtBQUFEQSxDQXJHQSxBQXFHQ0EsRUFyR3NDLGlCQUFpQixFQXFHdkQ7QUFFRCxBQUFrQyxpQkFBekIsd0JBQXdCLENBQUMiLCJmaWxlIjoiYW5pbWF0b3JzL3N0YXRlcy9QYXJ0aWNsZVNwcml0ZVNoZWV0U3RhdGUuanMiLCJzb3VyY2VSb290IjoiL1VzZXJzL3JvYmJhdGVtYW4vV2Vic3Rvcm1Qcm9qZWN0cy9hd2F5anMtcmVuZGVyZXJnbC8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgVmVjdG9yM0RcdFx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9jb3JlL2dlb20vVmVjdG9yM0RcIik7XG5pbXBvcnQgQ2FtZXJhXHRcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvZW50aXRpZXMvQ2FtZXJhXCIpO1xuXG5pbXBvcnQgQW5pbWF0aW9uUmVnaXN0ZXJDYWNoZVx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9hbmltYXRvcnMvZGF0YS9BbmltYXRpb25SZWdpc3RlckNhY2hlXCIpO1xuaW1wb3J0IFN0YWdlXHRcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvY29yZS9iYXNlL1N0YWdlXCIpO1xuaW1wb3J0IFJlbmRlcmFibGVCYXNlXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9jb3JlL3Bvb2wvUmVuZGVyYWJsZUJhc2VcIik7XG5pbXBvcnQgQ29udGV4dEdMVmVydGV4QnVmZmVyRm9ybWF0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9jb3JlL3N0YWdlZ2wvQ29udGV4dEdMVmVydGV4QnVmZmVyRm9ybWF0XCIpO1xuXG5pbXBvcnQgUGFydGljbGVBbmltYXRvclx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvYW5pbWF0b3JzL1BhcnRpY2xlQW5pbWF0b3JcIik7XG5pbXBvcnQgQW5pbWF0aW9uU3ViR2VvbWV0cnlcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9hbmltYXRvcnMvZGF0YS9BbmltYXRpb25TdWJHZW9tZXRyeVwiKTtcbmltcG9ydCBQYXJ0aWNsZVByb3BlcnRpZXNNb2RlXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2FuaW1hdG9ycy9kYXRhL1BhcnRpY2xlUHJvcGVydGllc01vZGVcIik7XG5pbXBvcnQgUGFydGljbGVTcHJpdGVTaGVldE5vZGVcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvYW5pbWF0b3JzL25vZGVzL1BhcnRpY2xlU3ByaXRlU2hlZXROb2RlXCIpO1xuaW1wb3J0IFBhcnRpY2xlU3RhdGVCYXNlXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvYW5pbWF0b3JzL3N0YXRlcy9QYXJ0aWNsZVN0YXRlQmFzZVwiKTtcblxuLyoqXG4gKiAuLi5cbiAqL1xuY2xhc3MgUGFydGljbGVTcHJpdGVTaGVldFN0YXRlIGV4dGVuZHMgUGFydGljbGVTdGF0ZUJhc2Vcbntcblx0LyoqIEBwcml2YXRlICovXG5cdHB1YmxpYyBzdGF0aWMgVVZfSU5ERVhfMDpudW1iZXIgLyp1aW50Ki8gPSAwO1xuXG5cdC8qKiBAcHJpdmF0ZSAqL1xuXHRwdWJsaWMgc3RhdGljIFVWX0lOREVYXzE6bnVtYmVyIC8qdWludCovID0gMTtcblxuXHRwcml2YXRlIF9wYXJ0aWNsZVNwcml0ZVNoZWV0Tm9kZTpQYXJ0aWNsZVNwcml0ZVNoZWV0Tm9kZTtcblx0cHJpdmF0ZSBfdXNlc0N5Y2xlOmJvb2xlYW47XG5cdHByaXZhdGUgX3VzZXNQaGFzZTpib29sZWFuO1xuXHRwcml2YXRlIF90b3RhbEZyYW1lczpudW1iZXIgLyppbnQqLztcblx0cHJpdmF0ZSBfbnVtQ29sdW1uczpudW1iZXIgLyppbnQqLztcblx0cHJpdmF0ZSBfbnVtUm93czpudW1iZXIgLyppbnQqLztcblx0cHJpdmF0ZSBfY3ljbGVEdXJhdGlvbjpudW1iZXI7XG5cdHByaXZhdGUgX2N5Y2xlUGhhc2U6bnVtYmVyO1xuXHRwcml2YXRlIF9zcHJpdGVTaGVldERhdGE6QXJyYXk8bnVtYmVyPjtcblxuXHQvKipcblx0ICogRGVmaW5lcyB0aGUgY3ljbGUgcGhhc2UsIHdoZW4gaW4gZ2xvYmFsIG1vZGUuIERlZmF1bHRzIHRvIHplcm8uXG5cdCAqL1xuXHRwdWJsaWMgZ2V0IGN5Y2xlUGhhc2UoKTpudW1iZXJcblx0e1xuXHRcdHJldHVybiB0aGlzLl9jeWNsZVBoYXNlO1xuXHR9XG5cblx0cHVibGljIHNldCBjeWNsZVBoYXNlKHZhbHVlOm51bWJlcilcblx0e1xuXHRcdHRoaXMuX2N5Y2xlUGhhc2UgPSB2YWx1ZTtcblxuXHRcdHRoaXMudXBkYXRlU3ByaXRlU2hlZXREYXRhKCk7XG5cdH1cblxuXHQvKipcblx0ICogRGVmaW5lcyB0aGUgY3ljbGUgZHVyYXRpb24gaW4gc2Vjb25kcywgd2hlbiBpbiBnbG9iYWwgbW9kZS4gRGVmYXVsdHMgdG8gMS5cblx0ICovXG5cdHB1YmxpYyBnZXQgY3ljbGVEdXJhdGlvbigpOm51bWJlclxuXHR7XG5cdFx0cmV0dXJuIHRoaXMuX2N5Y2xlRHVyYXRpb247XG5cdH1cblxuXHRwdWJsaWMgc2V0IGN5Y2xlRHVyYXRpb24odmFsdWU6bnVtYmVyKVxuXHR7XG5cdFx0dGhpcy5fY3ljbGVEdXJhdGlvbiA9IHZhbHVlO1xuXG5cdFx0dGhpcy51cGRhdGVTcHJpdGVTaGVldERhdGEoKTtcblx0fVxuXG5cdGNvbnN0cnVjdG9yKGFuaW1hdG9yOlBhcnRpY2xlQW5pbWF0b3IsIHBhcnRpY2xlU3ByaXRlU2hlZXROb2RlOlBhcnRpY2xlU3ByaXRlU2hlZXROb2RlKVxuXHR7XG5cdFx0c3VwZXIoYW5pbWF0b3IsIHBhcnRpY2xlU3ByaXRlU2hlZXROb2RlKTtcblxuXHRcdHRoaXMuX3BhcnRpY2xlU3ByaXRlU2hlZXROb2RlID0gcGFydGljbGVTcHJpdGVTaGVldE5vZGU7XG5cblx0XHR0aGlzLl91c2VzQ3ljbGUgPSB0aGlzLl9wYXJ0aWNsZVNwcml0ZVNoZWV0Tm9kZS5faVVzZXNDeWNsZTtcblx0XHR0aGlzLl91c2VzUGhhc2UgPSB0aGlzLl9wYXJ0aWNsZVNwcml0ZVNoZWV0Tm9kZS5faVVzZXNDeWNsZTtcblx0XHR0aGlzLl90b3RhbEZyYW1lcyA9IHRoaXMuX3BhcnRpY2xlU3ByaXRlU2hlZXROb2RlLl9pVG90YWxGcmFtZXM7XG5cdFx0dGhpcy5fbnVtQ29sdW1ucyA9IHRoaXMuX3BhcnRpY2xlU3ByaXRlU2hlZXROb2RlLl9pTnVtQ29sdW1ucztcblx0XHR0aGlzLl9udW1Sb3dzID0gdGhpcy5fcGFydGljbGVTcHJpdGVTaGVldE5vZGUuX2lOdW1Sb3dzO1xuXHRcdHRoaXMuX2N5Y2xlRHVyYXRpb24gPSB0aGlzLl9wYXJ0aWNsZVNwcml0ZVNoZWV0Tm9kZS5faUN5Y2xlRHVyYXRpb247XG5cdFx0dGhpcy5fY3ljbGVQaGFzZSA9IHRoaXMuX3BhcnRpY2xlU3ByaXRlU2hlZXROb2RlLl9pQ3ljbGVQaGFzZTtcblxuXHRcdHRoaXMudXBkYXRlU3ByaXRlU2hlZXREYXRhKCk7XG5cdH1cblxuXHRwdWJsaWMgc2V0UmVuZGVyU3RhdGUoc3RhZ2U6U3RhZ2UsIHJlbmRlcmFibGU6UmVuZGVyYWJsZUJhc2UsIGFuaW1hdGlvblN1Ykdlb21ldHJ5OkFuaW1hdGlvblN1Ykdlb21ldHJ5LCBhbmltYXRpb25SZWdpc3RlckNhY2hlOkFuaW1hdGlvblJlZ2lzdGVyQ2FjaGUsIGNhbWVyYTpDYW1lcmEpXG5cdHtcblx0XHRpZiAoYW5pbWF0aW9uUmVnaXN0ZXJDYWNoZS5uZWVkVVZBbmltYXRpb24pIHtcblx0XHRcdGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGUuc2V0VmVydGV4Q29uc3QoYW5pbWF0aW9uUmVnaXN0ZXJDYWNoZS5nZXRSZWdpc3RlckluZGV4KHRoaXMuX3BBbmltYXRpb25Ob2RlLCBQYXJ0aWNsZVNwcml0ZVNoZWV0U3RhdGUuVVZfSU5ERVhfMCksIHRoaXMuX3Nwcml0ZVNoZWV0RGF0YVswXSwgdGhpcy5fc3ByaXRlU2hlZXREYXRhWzFdLCB0aGlzLl9zcHJpdGVTaGVldERhdGFbMl0sIHRoaXMuX3Nwcml0ZVNoZWV0RGF0YVszXSk7XG5cdFx0XHRpZiAodGhpcy5fdXNlc0N5Y2xlKSB7XG5cdFx0XHRcdHZhciBpbmRleDpudW1iZXIgLyppbnQqLyA9IGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGUuZ2V0UmVnaXN0ZXJJbmRleCh0aGlzLl9wQW5pbWF0aW9uTm9kZSwgUGFydGljbGVTcHJpdGVTaGVldFN0YXRlLlVWX0lOREVYXzEpO1xuXHRcdFx0XHRpZiAodGhpcy5fcGFydGljbGVTcHJpdGVTaGVldE5vZGUubW9kZSA9PSBQYXJ0aWNsZVByb3BlcnRpZXNNb2RlLkxPQ0FMX1NUQVRJQykge1xuXHRcdFx0XHRcdGlmICh0aGlzLl91c2VzUGhhc2UpXG5cdFx0XHRcdFx0XHRhbmltYXRpb25TdWJHZW9tZXRyeS5hY3RpdmF0ZVZlcnRleEJ1ZmZlcihpbmRleCwgdGhpcy5fcGFydGljbGVTcHJpdGVTaGVldE5vZGUuX2lEYXRhT2Zmc2V0LCBzdGFnZSwgQ29udGV4dEdMVmVydGV4QnVmZmVyRm9ybWF0LkZMT0FUXzMpO1xuXHRcdFx0XHRcdGVsc2Vcblx0XHRcdFx0XHRcdGFuaW1hdGlvblN1Ykdlb21ldHJ5LmFjdGl2YXRlVmVydGV4QnVmZmVyKGluZGV4LCB0aGlzLl9wYXJ0aWNsZVNwcml0ZVNoZWV0Tm9kZS5faURhdGFPZmZzZXQsIHN0YWdlLCBDb250ZXh0R0xWZXJ0ZXhCdWZmZXJGb3JtYXQuRkxPQVRfMik7XG5cdFx0XHRcdH0gZWxzZVxuXHRcdFx0XHRcdGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGUuc2V0VmVydGV4Q29uc3QoaW5kZXgsIHRoaXMuX3Nwcml0ZVNoZWV0RGF0YVs0XSwgdGhpcy5fc3ByaXRlU2hlZXREYXRhWzVdKTtcblx0XHRcdH1cblx0XHR9XG5cdH1cblxuXHRwcml2YXRlIHVwZGF0ZVNwcml0ZVNoZWV0RGF0YSgpXG5cdHtcblx0XHR0aGlzLl9zcHJpdGVTaGVldERhdGEgPSBuZXcgQXJyYXk8bnVtYmVyPig4KTtcblxuXHRcdHZhciB1VG90YWw6bnVtYmVyID0gdGhpcy5fdG90YWxGcmFtZXMvdGhpcy5fbnVtQ29sdW1ucztcblxuXHRcdHRoaXMuX3Nwcml0ZVNoZWV0RGF0YVswXSA9IHVUb3RhbDtcblx0XHR0aGlzLl9zcHJpdGVTaGVldERhdGFbMV0gPSAxL3RoaXMuX251bUNvbHVtbnM7XG5cdFx0dGhpcy5fc3ByaXRlU2hlZXREYXRhWzJdID0gMS90aGlzLl9udW1Sb3dzO1xuXG5cdFx0aWYgKHRoaXMuX3VzZXNDeWNsZSkge1xuXHRcdFx0aWYgKHRoaXMuX2N5Y2xlRHVyYXRpb24gPD0gMClcblx0XHRcdFx0dGhyb3cobmV3IEVycm9yKFwidGhlIGN5Y2xlIGR1cmF0aW9uIG11c3QgYmUgZ3JlYXRlciB0aGFuIHplcm9cIikpO1xuXHRcdFx0dGhpcy5fc3ByaXRlU2hlZXREYXRhWzRdID0gdVRvdGFsL3RoaXMuX2N5Y2xlRHVyYXRpb247XG5cdFx0XHR0aGlzLl9zcHJpdGVTaGVldERhdGFbNV0gPSB0aGlzLl9jeWNsZUR1cmF0aW9uO1xuXHRcdFx0aWYgKHRoaXMuX3VzZXNQaGFzZSlcblx0XHRcdFx0dGhpcy5fc3ByaXRlU2hlZXREYXRhWzZdID0gdGhpcy5fY3ljbGVQaGFzZTtcblx0XHR9XG5cdH1cbn1cblxuZXhwb3J0ID0gUGFydGljbGVTcHJpdGVTaGVldFN0YXRlOyJdfQ==