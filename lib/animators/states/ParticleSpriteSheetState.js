var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var ContextGLVertexBufferFormat = require("awayjs-stagegl/lib/base/ContextGLVertexBufferFormat");
var ParticlePropertiesMode = require("awayjs-renderergl/lib/animators/data/ParticlePropertiesMode");
var ParticleStateBase = require("awayjs-renderergl/lib/animators/states/ParticleStateBase");
/**
 * ...
 */
var ParticleSpriteSheetState = (function (_super) {
    __extends(ParticleSpriteSheetState, _super);
    function ParticleSpriteSheetState(animator, particleSpriteSheetNode) {
        _super.call(this, animator, particleSpriteSheetNode);
        this._particleSpriteSheetNode = particleSpriteSheetNode;
        this._usesCycle = this._particleSpriteSheetNode._iUsesCycle;
        this._usesPhase = this._particleSpriteSheetNode._iUsesCycle;
        this._totalFrames = this._particleSpriteSheetNode._iTotalFrames;
        this._numColumns = this._particleSpriteSheetNode._iNumColumns;
        this._numRows = this._particleSpriteSheetNode._iNumRows;
        this._cycleDuration = this._particleSpriteSheetNode._iCycleDuration;
        this._cyclePhase = this._particleSpriteSheetNode._iCyclePhase;
        this.updateSpriteSheetData();
    }
    Object.defineProperty(ParticleSpriteSheetState.prototype, "cyclePhase", {
        /**
         * Defines the cycle phase, when in global mode. Defaults to zero.
         */
        get: function () {
            return this._cyclePhase;
        },
        set: function (value) {
            this._cyclePhase = value;
            this.updateSpriteSheetData();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ParticleSpriteSheetState.prototype, "cycleDuration", {
        /**
         * Defines the cycle duration in seconds, when in global mode. Defaults to 1.
         */
        get: function () {
            return this._cycleDuration;
        },
        set: function (value) {
            this._cycleDuration = value;
            this.updateSpriteSheetData();
        },
        enumerable: true,
        configurable: true
    });
    ParticleSpriteSheetState.prototype.setRenderState = function (stage, renderable, animationSubGeometry, animationRegisterCache, camera) {
        if (animationRegisterCache.needUVAnimation) {
            animationRegisterCache.setVertexConst(animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleSpriteSheetState.UV_INDEX_0), this._spriteSheetData[0], this._spriteSheetData[1], this._spriteSheetData[2], this._spriteSheetData[3]);
            if (this._usesCycle) {
                var index = animationRegisterCache.getRegisterIndex(this._pAnimationNode, ParticleSpriteSheetState.UV_INDEX_1);
                if (this._particleSpriteSheetNode.mode == ParticlePropertiesMode.LOCAL_STATIC) {
                    if (this._usesPhase)
                        animationSubGeometry.activateVertexBuffer(index, this._particleSpriteSheetNode._iDataOffset, stage, ContextGLVertexBufferFormat.FLOAT_3);
                    else
                        animationSubGeometry.activateVertexBuffer(index, this._particleSpriteSheetNode._iDataOffset, stage, ContextGLVertexBufferFormat.FLOAT_2);
                }
                else
                    animationRegisterCache.setVertexConst(index, this._spriteSheetData[4], this._spriteSheetData[5]);
            }
        }
    };
    ParticleSpriteSheetState.prototype.updateSpriteSheetData = function () {
        this._spriteSheetData = new Array(8);
        var uTotal = this._totalFrames / this._numColumns;
        this._spriteSheetData[0] = uTotal;
        this._spriteSheetData[1] = 1 / this._numColumns;
        this._spriteSheetData[2] = 1 / this._numRows;
        if (this._usesCycle) {
            if (this._cycleDuration <= 0)
                throw (new Error("the cycle duration must be greater than zero"));
            this._spriteSheetData[4] = uTotal / this._cycleDuration;
            this._spriteSheetData[5] = this._cycleDuration;
            if (this._usesPhase)
                this._spriteSheetData[6] = this._cyclePhase;
        }
    };
    /** @private */
    ParticleSpriteSheetState.UV_INDEX_0 = 0;
    /** @private */
    ParticleSpriteSheetState.UV_INDEX_1 = 1;
    return ParticleSpriteSheetState;
})(ParticleStateBase);
module.exports = ParticleSpriteSheetState;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9hbmltYXRvcnMvc3RhdGVzL3BhcnRpY2xlc3ByaXRlc2hlZXRzdGF0ZS50cyJdLCJuYW1lcyI6WyJQYXJ0aWNsZVNwcml0ZVNoZWV0U3RhdGUiLCJQYXJ0aWNsZVNwcml0ZVNoZWV0U3RhdGUuY29uc3RydWN0b3IiLCJQYXJ0aWNsZVNwcml0ZVNoZWV0U3RhdGUuY3ljbGVQaGFzZSIsIlBhcnRpY2xlU3ByaXRlU2hlZXRTdGF0ZS5jeWNsZUR1cmF0aW9uIiwiUGFydGljbGVTcHJpdGVTaGVldFN0YXRlLnNldFJlbmRlclN0YXRlIiwiUGFydGljbGVTcHJpdGVTaGVldFN0YXRlLnVwZGF0ZVNwcml0ZVNoZWV0RGF0YSJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBT0EsSUFBTywyQkFBMkIsV0FBWSxxREFBcUQsQ0FBQyxDQUFDO0FBSXJHLElBQU8sc0JBQXNCLFdBQWEsNkRBQTZELENBQUMsQ0FBQztBQUV6RyxJQUFPLGlCQUFpQixXQUFjLDBEQUEwRCxDQUFDLENBQUM7QUFFbEcsQUFHQTs7R0FERztJQUNHLHdCQUF3QjtJQUFTQSxVQUFqQ0Esd0JBQXdCQSxVQUEwQkE7SUFnRHZEQSxTQWhES0Esd0JBQXdCQSxDQWdEakJBLFFBQXlCQSxFQUFFQSx1QkFBK0NBO1FBRXJGQyxrQkFBTUEsUUFBUUEsRUFBRUEsdUJBQXVCQSxDQUFDQSxDQUFDQTtRQUV6Q0EsSUFBSUEsQ0FBQ0Esd0JBQXdCQSxHQUFHQSx1QkFBdUJBLENBQUNBO1FBRXhEQSxJQUFJQSxDQUFDQSxVQUFVQSxHQUFHQSxJQUFJQSxDQUFDQSx3QkFBd0JBLENBQUNBLFdBQVdBLENBQUNBO1FBQzVEQSxJQUFJQSxDQUFDQSxVQUFVQSxHQUFHQSxJQUFJQSxDQUFDQSx3QkFBd0JBLENBQUNBLFdBQVdBLENBQUNBO1FBQzVEQSxJQUFJQSxDQUFDQSxZQUFZQSxHQUFHQSxJQUFJQSxDQUFDQSx3QkFBd0JBLENBQUNBLGFBQWFBLENBQUNBO1FBQ2hFQSxJQUFJQSxD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Q0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsY0FBY0EsQ0FBQ0E7WUFDL0NBLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLFVBQVVBLENBQUNBO2dCQUNuQkEsSUFBSUEsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQTtRQUM5Q0EsQ0FBQ0E7SUFDRkEsQ0FBQ0E7SUFsR0RMLGVBQWVBO0lBQ0RBLG1DQUFVQSxHQUFtQkEsQ0FBQ0EsQ0FBQ0E7SUFFN0NBLGVBQWVBO0lBQ0RBLG1DQUFVQSxHQUFtQkEsQ0FBQ0EsQ0FBQ0E7SUErRjlDQSwrQkFBQ0E7QUFBREEsQ0FyR0EsQUFxR0NBLEVBckdzQyxpQkFBaUIsRUFxR3ZEO0FBRUQsQUFBa0MsaUJBQXpCLHdCQUF3QixDQUFDIiwiZmlsZSI6ImFuaW1hdG9ycy9zdGF0ZXMvUGFydGljbGVTcHJpdGVTaGVldFN0YXRlLmpzIiwic291cmNlUm9vdCI6Ii4uLyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBWZWN0b3IzRFx0XHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2dlb20vVmVjdG9yM0RcIik7XG5cbmltcG9ydCBDYW1lcmFcdFx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9lbnRpdGllcy9DYW1lcmFcIik7XG5cbmltcG9ydCBBbmltYXRpb25SZWdpc3RlckNhY2hlXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2FuaW1hdG9ycy9kYXRhL0FuaW1hdGlvblJlZ2lzdGVyQ2FjaGVcIik7XG5pbXBvcnQgU3RhZ2VcdFx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9iYXNlL1N0YWdlXCIpO1xuaW1wb3J0IFJlbmRlcmFibGVCYXNlXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9wb29sL1JlbmRlcmFibGVCYXNlXCIpO1xuaW1wb3J0IENvbnRleHRHTFZlcnRleEJ1ZmZlckZvcm1hdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYmFzZS9Db250ZXh0R0xWZXJ0ZXhCdWZmZXJGb3JtYXRcIik7XG5cbmltcG9ydCBQYXJ0aWNsZUFuaW1hdG9yXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9hbmltYXRvcnMvUGFydGljbGVBbmltYXRvclwiKTtcbmltcG9ydCBBbmltYXRpb25TdWJHZW9tZXRyeVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2FuaW1hdG9ycy9kYXRhL0FuaW1hdGlvblN1Ykdlb21ldHJ5XCIpO1xuaW1wb3J0IFBhcnRpY2xlUHJvcGVydGllc01vZGVcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvYW5pbWF0b3JzL2RhdGEvUGFydGljbGVQcm9wZXJ0aWVzTW9kZVwiKTtcbmltcG9ydCBQYXJ0aWNsZVNwcml0ZVNoZWV0Tm9kZVx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9hbmltYXRvcnMvbm9kZXMvUGFydGljbGVTcHJpdGVTaGVldE5vZGVcIik7XG5pbXBvcnQgUGFydGljbGVTdGF0ZUJhc2VcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9hbmltYXRvcnMvc3RhdGVzL1BhcnRpY2xlU3RhdGVCYXNlXCIpO1xuXG4vKipcbiAqIC4uLlxuICovXG5jbGFzcyBQYXJ0aWNsZVNwcml0ZVNoZWV0U3RhdGUgZXh0ZW5kcyBQYXJ0aWNsZVN0YXRlQmFzZVxue1xuXHQvKiogQHByaXZhdGUgKi9cblx0cHVibGljIHN0YXRpYyBVVl9JTkRFWF8wOm51bWJlciAvKnVpbnQqLyA9IDA7XG5cblx0LyoqIEBwcml2YXRlICovXG5cdHB1YmxpYyBzdGF0aWMgVVZfSU5ERVhfMTpudW1iZXIgLyp1aW50Ki8gPSAxO1xuXG5cdHByaXZhdGUgX3BhcnRpY2xlU3ByaXRlU2hlZXROb2RlOlBhcnRpY2xlU3ByaXRlU2hlZXROb2RlO1xuXHRwcml2YXRlIF91c2VzQ3ljbGU6Ym9vbGVhbjtcblx0cHJpdmF0ZSBfdXNlc1BoYXNlOmJvb2xlYW47XG5cdHByaXZhdGUgX3RvdGFsRnJhbWVzOm51bWJlciAvKmludCovO1xuXHRwcml2YXRlIF9udW1Db2x1bW5zOm51bWJlciAvKmludCovO1xuXHRwcml2YXRlIF9udW1Sb3dzOm51bWJlciAvKmludCovO1xuXHRwcml2YXRlIF9jeWNsZUR1cmF0aW9uOm51bWJlcjtcblx0cHJpdmF0ZSBfY3ljbGVQaGFzZTpudW1iZXI7XG5cdHByaXZhdGUgX3Nwcml0ZVNoZWV0RGF0YTpBcnJheTxudW1iZXI+O1xuXG5cdC8qKlxuXHQgKiBEZWZpbmVzIHRoZSBjeWNsZSBwaGFzZSwgd2hlbiBpbiBnbG9iYWwgbW9kZS4gRGVmYXVsdHMgdG8gemVyby5cblx0ICovXG5cdHB1YmxpYyBnZXQgY3ljbGVQaGFzZSgpOm51bWJlclxuXHR7XG5cdFx0cmV0dXJuIHRoaXMuX2N5Y2xlUGhhc2U7XG5cdH1cblxuXHRwdWJsaWMgc2V0IGN5Y2xlUGhhc2UodmFsdWU6bnVtYmVyKVxuXHR7XG5cdFx0dGhpcy5fY3ljbGVQaGFzZSA9IHZhbHVlO1xuXG5cdFx0dGhpcy51cGRhdGVTcHJpdGVTaGVldERhdGEoKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBEZWZpbmVzIHRoZSBjeWNsZSBkdXJhdGlvbiBpbiBzZWNvbmRzLCB3aGVuIGluIGdsb2JhbCBtb2RlLiBEZWZhdWx0cyB0byAxLlxuXHQgKi9cblx0cHVibGljIGdldCBjeWNsZUR1cmF0aW9uKCk6bnVtYmVyXG5cdHtcblx0XHRyZXR1cm4gdGhpcy5fY3ljbGVEdXJhdGlvbjtcblx0fVxuXG5cdHB1YmxpYyBzZXQgY3ljbGVEdXJhdGlvbih2YWx1ZTpudW1iZXIpXG5cdHtcblx0XHR0aGlzLl9jeWNsZUR1cmF0aW9uID0gdmFsdWU7XG5cblx0XHR0aGlzLnVwZGF0ZVNwcml0ZVNoZWV0RGF0YSgpO1xuXHR9XG5cblx0Y29uc3RydWN0b3IoYW5pbWF0b3I6UGFydGljbGVBbmltYXRvciwgcGFydGljbGVTcHJpdGVTaGVldE5vZGU6UGFydGljbGVTcHJpdGVTaGVldE5vZGUpXG5cdHtcblx0XHRzdXBlcihhbmltYXRvciwgcGFydGljbGVTcHJpdGVTaGVldE5vZGUpO1xuXG5cdFx0dGhpcy5fcGFydGljbGVTcHJpdGVTaGVldE5vZGUgPSBwYXJ0aWNsZVNwcml0ZVNoZWV0Tm9kZTtcblxuXHRcdHRoaXMuX3VzZXNDeWNsZSA9IHRoaXMuX3BhcnRpY2xlU3ByaXRlU2hlZXROb2RlLl9pVXNlc0N5Y2xlO1xuXHRcdHRoaXMuX3VzZXNQaGFzZSA9IHRoaXMuX3BhcnRpY2xlU3ByaXRlU2hlZXROb2RlLl9pVXNlc0N5Y2xlO1xuXHRcdHRoaXMuX3RvdGFsRnJhbWVzID0gdGhpcy5fcGFydGljbGVTcHJpdGVTaGVldE5vZGUuX2lUb3RhbEZyYW1lcztcblx0XHR0aGlzLl9udW1Db2x1bW5zID0gdGhpcy5fcGFydGljbGVTcHJpdGVTaGVldE5vZGUuX2lOdW1Db2x1bW5zO1xuXHRcdHRoaXMuX251bVJvd3MgPSB0aGlzLl9wYXJ0aWNsZVNwcml0ZVNoZWV0Tm9kZS5faU51bVJvd3M7XG5cdFx0dGhpcy5fY3ljbGVEdXJhdGlvbiA9IHRoaXMuX3BhcnRpY2xlU3ByaXRlU2hlZXROb2RlLl9pQ3ljbGVEdXJhdGlvbjtcblx0XHR0aGlzLl9jeWNsZVBoYXNlID0gdGhpcy5fcGFydGljbGVTcHJpdGVTaGVldE5vZGUuX2lDeWNsZVBoYXNlO1xuXG5cdFx0dGhpcy51cGRhdGVTcHJpdGVTaGVldERhdGEoKTtcblx0fVxuXG5cdHB1YmxpYyBzZXRSZW5kZXJTdGF0ZShzdGFnZTpTdGFnZSwgcmVuZGVyYWJsZTpSZW5kZXJhYmxlQmFzZSwgYW5pbWF0aW9uU3ViR2VvbWV0cnk6QW5pbWF0aW9uU3ViR2VvbWV0cnksIGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGU6QW5pbWF0aW9uUmVnaXN0ZXJDYWNoZSwgY2FtZXJhOkNhbWVyYSlcblx0e1xuXHRcdGlmIChhbmltYXRpb25SZWdpc3RlckNhY2hlLm5lZWRVVkFuaW1hdGlvbikge1xuXHRcdFx0YW5pbWF0aW9uUmVnaXN0ZXJDYWNoZS5zZXRWZXJ0ZXhDb25zdChhbmltYXRpb25SZWdpc3RlckNhY2hlLmdldFJlZ2lzdGVySW5kZXgodGhpcy5fcEFuaW1hdGlvbk5vZGUsIFBhcnRpY2xlU3ByaXRlU2hlZXRTdGF0ZS5VVl9JTkRFWF8wKSwgdGhpcy5fc3ByaXRlU2hlZXREYXRhWzBdLCB0aGlzLl9zcHJpdGVTaGVldERhdGFbMV0sIHRoaXMuX3Nwcml0ZVNoZWV0RGF0YVsyXSwgdGhpcy5fc3ByaXRlU2hlZXREYXRhWzNdKTtcblx0XHRcdGlmICh0aGlzLl91c2VzQ3ljbGUpIHtcblx0XHRcdFx0dmFyIGluZGV4Om51bWJlciAvKmludCovID0gYW5pbWF0aW9uUmVnaXN0ZXJDYWNoZS5nZXRSZWdpc3RlckluZGV4KHRoaXMuX3BBbmltYXRpb25Ob2RlLCBQYXJ0aWNsZVNwcml0ZVNoZWV0U3RhdGUuVVZfSU5ERVhfMSk7XG5cdFx0XHRcdGlmICh0aGlzLl9wYXJ0aWNsZVNwcml0ZVNoZWV0Tm9kZS5tb2RlID09IFBhcnRpY2xlUHJvcGVydGllc01vZGUuTE9DQUxfU1RBVElDKSB7XG5cdFx0XHRcdFx0aWYgKHRoaXMuX3VzZXNQaGFzZSlcblx0XHRcdFx0XHRcdGFuaW1hdGlvblN1Ykdlb21ldHJ5LmFjdGl2YXRlVmVydGV4QnVmZmVyKGluZGV4LCB0aGlzLl9wYXJ0aWNsZVNwcml0ZVNoZWV0Tm9kZS5faURhdGFPZmZzZXQsIHN0YWdlLCBDb250ZXh0R0xWZXJ0ZXhCdWZmZXJGb3JtYXQuRkxPQVRfMyk7XG5cdFx0XHRcdFx0ZWxzZVxuXHRcdFx0XHRcdFx0YW5pbWF0aW9uU3ViR2VvbWV0cnkuYWN0aXZhdGVWZXJ0ZXhCdWZmZXIoaW5kZXgsIHRoaXMuX3BhcnRpY2xlU3ByaXRlU2hlZXROb2RlLl9pRGF0YU9mZnNldCwgc3RhZ2UsIENvbnRleHRHTFZlcnRleEJ1ZmZlckZvcm1hdC5GTE9BVF8yKTtcblx0XHRcdFx0fSBlbHNlXG5cdFx0XHRcdFx0YW5pbWF0aW9uUmVnaXN0ZXJDYWNoZS5zZXRWZXJ0ZXhDb25zdChpbmRleCwgdGhpcy5fc3ByaXRlU2hlZXREYXRhWzRdLCB0aGlzLl9zcHJpdGVTaGVldERhdGFbNV0pO1xuXHRcdFx0fVxuXHRcdH1cblx0fVxuXG5cdHByaXZhdGUgdXBkYXRlU3ByaXRlU2hlZXREYXRhKClcblx0e1xuXHRcdHRoaXMuX3Nwcml0ZVNoZWV0RGF0YSA9IG5ldyBBcnJheTxudW1iZXI+KDgpO1xuXG5cdFx0dmFyIHVUb3RhbDpudW1iZXIgPSB0aGlzLl90b3RhbEZyYW1lcy90aGlzLl9udW1Db2x1bW5zO1xuXG5cdFx0dGhpcy5fc3ByaXRlU2hlZXREYXRhWzBdID0gdVRvdGFsO1xuXHRcdHRoaXMuX3Nwcml0ZVNoZWV0RGF0YVsxXSA9IDEvdGhpcy5fbnVtQ29sdW1ucztcblx0XHR0aGlzLl9zcHJpdGVTaGVldERhdGFbMl0gPSAxL3RoaXMuX251bVJvd3M7XG5cblx0XHRpZiAodGhpcy5fdXNlc0N5Y2xlKSB7XG5cdFx0XHRpZiAodGhpcy5fY3ljbGVEdXJhdGlvbiA8PSAwKVxuXHRcdFx0XHR0aHJvdyhuZXcgRXJyb3IoXCJ0aGUgY3ljbGUgZHVyYXRpb24gbXVzdCBiZSBncmVhdGVyIHRoYW4gemVyb1wiKSk7XG5cdFx0XHR0aGlzLl9zcHJpdGVTaGVldERhdGFbNF0gPSB1VG90YWwvdGhpcy5fY3ljbGVEdXJhdGlvbjtcblx0XHRcdHRoaXMuX3Nwcml0ZVNoZWV0RGF0YVs1XSA9IHRoaXMuX2N5Y2xlRHVyYXRpb247XG5cdFx0XHRpZiAodGhpcy5fdXNlc1BoYXNlKVxuXHRcdFx0XHR0aGlzLl9zcHJpdGVTaGVldERhdGFbNl0gPSB0aGlzLl9jeWNsZVBoYXNlO1xuXHRcdH1cblx0fVxufVxuXG5leHBvcnQgPSBQYXJ0aWNsZVNwcml0ZVNoZWV0U3RhdGU7Il19