var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var Quaternion = require("awayjs-core/lib/core/geom/Quaternion");
var JointPose = require("awayjs-renderergl/lib/animators/data/JointPose");
var SkeletonPose = require("awayjs-renderergl/lib/animators/data/SkeletonPose");
var AnimationStateBase = require("awayjs-renderergl/lib/animators/states/AnimationStateBase");
/**
 *
 */
var SkeletonDifferenceState = (function (_super) {
    __extends(SkeletonDifferenceState, _super);
    function SkeletonDifferenceState(animator, skeletonAnimationNode) {
        _super.call(this, animator, skeletonAnimationNode);
        this._blendWeight = 0;
        this._skeletonPose = new SkeletonPose();
        this._skeletonPoseDirty = true;
        this._skeletonAnimationNode = skeletonAnimationNode;
        this._baseInput = animator.getAnimationState(this._skeletonAnimationNode.baseInput);
        this._differenceInput = animator.getAnimationState(this._skeletonAnimationNode.differenceInput);
    }
    Object.defineProperty(SkeletonDifferenceState.prototype, "blendWeight", {
        /**
         * Defines a fractional value between 0 and 1 representing the blending ratio between the base input (0) and difference input (1),
         * used to produce the skeleton pose output.
         *
         * @see #baseInput
         * @see #differenceInput
         */
        get: function () {
            return this._blendWeight;
        },
        set: function (value) {
            this._blendWeight = value;
            this._pPositionDeltaDirty = true;
            this._skeletonPoseDirty = true;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @inheritDoc
     */
    SkeletonDifferenceState.prototype.phase = function (value) {
        this._skeletonPoseDirty = true;
        this._pPositionDeltaDirty = true;
        this._baseInput.phase(value);
        this._baseInput.phase(value);
    };
    /**
     * @inheritDoc
     */
    SkeletonDifferenceState.prototype._pUpdateTime = function (time /*int*/) {
        this._skeletonPoseDirty = true;
        this._baseInput.update(time);
        this._differenceInput.update(time);
        _super.prototype._pUpdateTime.call(this, time);
    };
    /**
     * Returns the current skeleton pose of the animation in the clip based on the internal playhead position.
     */
    SkeletonDifferenceState.prototype.getSkeletonPose = function (skeleton) {
        if (this._skeletonPoseDirty)
            this.updateSkeletonPose(skeleton);
        return this._skeletonPose;
    };
    /**
     * @inheritDoc
     */
    SkeletonDifferenceState.prototype._pUpdatePositionDelta = function () {
        this._pPositionDeltaDirty = false;
        var deltA = this._baseInput.positionDelta;
        var deltB = this._differenceInput.positionDelta;
        this.positionDelta.x = deltA.x + this._blendWeight * deltB.x;
        this.positionDelta.y = deltA.y + this._blendWeight * deltB.y;
        this.positionDelta.z = deltA.z + this._blendWeight * deltB.z;
    };
    /**
     * Updates the output skeleton pose of the node based on the blendWeight value between base input and difference input nodes.
     *
     * @param skeleton The skeleton used by the animator requesting the ouput pose.
     */
    SkeletonDifferenceState.prototype.updateSkeletonPose = function (skeleton) {
        this._skeletonPoseDirty = false;
        var endPose;
        var endPoses = this._skeletonPose.jointPoses;
        var basePoses = this._baseInput.getSkeletonPose(skeleton).jointPoses;
        var diffPoses = this._differenceInput.getSkeletonPose(skeleton).jointPoses;
        var base, diff;
        var basePos, diffPos;
        var tr;
        var numJoints = skeleton.numJoints;
        // :s
        if (endPoses.length != numJoints)
            endPoses.length = numJoints;
        for (var i = 0; i < numJoints; ++i) {
            endPose = endPoses[i];
            if (endPose == null)
                endPose = endPoses[i] = new JointPose();
            base = basePoses[i];
            diff = diffPoses[i];
            basePos = base.translation;
            diffPos = diff.translation;
            SkeletonDifferenceState._tempQuat.multiply(diff.orientation, base.orientation);
            endPose.orientation.lerp(base.orientation, SkeletonDifferenceState._tempQuat, this._blendWeight);
            tr = endPose.translation;
            tr.x = basePos.x + this._blendWeight * diffPos.x;
            tr.y = basePos.y + this._blendWeight * diffPos.y;
            tr.z = basePos.z + this._blendWeight * diffPos.z;
        }
    };
    SkeletonDifferenceState._tempQuat = new Quaternion();
    return SkeletonDifferenceState;
})(AnimationStateBase);
module.exports = SkeletonDifferenceState;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFuaW1hdG9ycy9zdGF0ZXMvc2tlbGV0b25kaWZmZXJlbmNlc3RhdGUudHMiXSwibmFtZXMiOlsiU2tlbGV0b25EaWZmZXJlbmNlU3RhdGUiLCJTa2VsZXRvbkRpZmZlcmVuY2VTdGF0ZS5jb25zdHJ1Y3RvciIsIlNrZWxldG9uRGlmZmVyZW5jZVN0YXRlLmJsZW5kV2VpZ2h0IiwiU2tlbGV0b25EaWZmZXJlbmNlU3RhdGUucGhhc2UiLCJTa2VsZXRvbkRpZmZlcmVuY2VTdGF0ZS5fcFVwZGF0ZVRpbWUiLCJTa2VsZXRvbkRpZmZlcmVuY2VTdGF0ZS5nZXRTa2VsZXRvblBvc2UiLCJTa2VsZXRvbkRpZmZlcmVuY2VTdGF0ZS5fcFVwZGF0ZVBvc2l0aW9uRGVsdGEiLCJTa2VsZXRvbkRpZmZlcmVuY2VTdGF0ZS51cGRhdGVTa2VsZXRvblBvc2UiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLElBQU8sVUFBVSxXQUFnQixzQ0FBc0MsQ0FBQyxDQUFDO0FBS3pFLElBQU8sU0FBUyxXQUFnQixnREFBZ0QsQ0FBQyxDQUFDO0FBRWxGLElBQU8sWUFBWSxXQUFnQixtREFBbUQsQ0FBQyxDQUFDO0FBRXhGLElBQU8sa0JBQWtCLFdBQWMsMkRBQTJELENBQUMsQ0FBQztBQUdwRyxBQUdBOztHQURHO0lBQ0csdUJBQXVCO0lBQVNBLFVBQWhDQSx1QkFBdUJBLFVBQTJCQTtJQThCdkRBLFNBOUJLQSx1QkFBdUJBLENBOEJoQkEsUUFBcUJBLEVBQUVBLHFCQUE0Q0E7UUFFOUVDLGtCQUFNQSxRQUFRQSxFQUFFQSxxQkFBcUJBLENBQUNBLENBQUNBO1FBOUJoQ0EsaUJBQVlBLEdBQVVBLENBQUNBLENBQUNBO1FBR3hCQSxrQkFBYUEsR0FBZ0JBLElBQUlBLFlBQVlBLEVBQUVBLENBQUNBO1FBQ2hEQSx1QkFBa0JBLEdBQVdBLElBQUlBLENBQUNBO1FBNEJ6Q0EsSUFBSUEsQ0FBQ0Esc0JBQXNCQSxHQUFHQSxxQkFBcUJBLENBQUNBO1FBRXBEQSxJQUFJQSxDQUFDQSxVQUFV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QXNJdkQ7QUFFRCxBQUFpQyxpQkFBeEIsdUJBQXVCLENBQUMiLCJmaWxlIjoiYW5pbWF0b3JzL3N0YXRlcy9Ta2VsZXRvbkRpZmZlcmVuY2VTdGF0ZS5qcyIsInNvdXJjZVJvb3QiOiIvVXNlcnMvcm9iYmF0ZW1hbi9XZWJzdG9ybVByb2plY3RzL2F3YXlqcy1yZW5kZXJlcmdsLyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBRdWF0ZXJuaW9uXHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2NvcmUvZ2VvbS9RdWF0ZXJuaW9uXCIpO1xuaW1wb3J0IFZlY3RvcjNEXHRcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvY29yZS9nZW9tL1ZlY3RvcjNEXCIpO1xuXG5pbXBvcnQgQW5pbWF0b3JCYXNlXHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2FuaW1hdG9ycy9BbmltYXRvckJhc2VcIik7XG5cbmltcG9ydCBKb2ludFBvc2VcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvYW5pbWF0b3JzL2RhdGEvSm9pbnRQb3NlXCIpO1xuaW1wb3J0IFNrZWxldG9uXHRcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvYW5pbWF0b3JzL2RhdGEvU2tlbGV0b25cIik7XG5pbXBvcnQgU2tlbGV0b25Qb3NlXHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2FuaW1hdG9ycy9kYXRhL1NrZWxldG9uUG9zZVwiKTtcbmltcG9ydCBTa2VsZXRvbkRpZmZlcmVuY2VOb2RlXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2FuaW1hdG9ycy9ub2Rlcy9Ta2VsZXRvbkRpZmZlcmVuY2VOb2RlXCIpO1xuaW1wb3J0IEFuaW1hdGlvblN0YXRlQmFzZVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2FuaW1hdG9ycy9zdGF0ZXMvQW5pbWF0aW9uU3RhdGVCYXNlXCIpO1xuaW1wb3J0IElTa2VsZXRvbkFuaW1hdGlvblN0YXRlXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2FuaW1hdG9ycy9zdGF0ZXMvSVNrZWxldG9uQW5pbWF0aW9uU3RhdGVcIik7XG5cbi8qKlxuICpcbiAqL1xuY2xhc3MgU2tlbGV0b25EaWZmZXJlbmNlU3RhdGUgZXh0ZW5kcyBBbmltYXRpb25TdGF0ZUJhc2UgaW1wbGVtZW50cyBJU2tlbGV0b25BbmltYXRpb25TdGF0ZVxue1xuXHRwcml2YXRlIF9ibGVuZFdlaWdodDpudW1iZXIgPSAwO1xuXHRwcml2YXRlIHN0YXRpYyBfdGVtcFF1YXQ6UXVhdGVybmlvbiA9IG5ldyBRdWF0ZXJuaW9uKCk7XG5cdHByaXZhdGUgX3NrZWxldG9uQW5pbWF0aW9uTm9kZTpTa2VsZXRvbkRpZmZlcmVuY2VOb2RlO1xuXHRwcml2YXRlIF9za2VsZXRvblBvc2U6U2tlbGV0b25Qb3NlID0gbmV3IFNrZWxldG9uUG9zZSgpO1xuXHRwcml2YXRlIF9za2VsZXRvblBvc2VEaXJ0eTpib29sZWFuID0gdHJ1ZTtcblx0cHJpdmF0ZSBfYmFzZUlucHV0OklTa2VsZXRvbkFuaW1hdGlvblN0YXRlO1xuXHRwcml2YXRlIF9kaWZmZXJlbmNlSW5wdXQ6SVNrZWxldG9uQW5pbWF0aW9uU3RhdGU7XG5cblx0LyoqXG5cdCAqIERlZmluZXMgYSBmcmFjdGlvbmFsIHZhbHVlIGJldHdlZW4gMCBhbmQgMSByZXByZXNlbnRpbmcgdGhlIGJsZW5kaW5nIHJhdGlvIGJldHdlZW4gdGhlIGJhc2UgaW5wdXQgKDApIGFuZCBkaWZmZXJlbmNlIGlucHV0ICgxKSxcblx0ICogdXNlZCB0byBwcm9kdWNlIHRoZSBza2VsZXRvbiBwb3NlIG91dHB1dC5cblx0ICpcblx0ICogQHNlZSAjYmFzZUlucHV0XG5cdCAqIEBzZWUgI2RpZmZlcmVuY2VJbnB1dFxuXHQgKi9cblx0cHVibGljIGdldCBibGVuZFdlaWdodCgpOm51bWJlclxuXHR7XG5cdFx0cmV0dXJuIHRoaXMuX2JsZW5kV2VpZ2h0O1xuXHR9XG5cblx0cHVibGljIHNldCBibGVuZFdlaWdodCh2YWx1ZTpudW1iZXIpXG5cdHtcblx0XHR0aGlzLl9ibGVuZFdlaWdodCA9IHZhbHVlO1xuXG5cdFx0dGhpcy5fcFBvc2l0aW9uRGVsdGFEaXJ0eSA9IHRydWU7XG5cdFx0dGhpcy5fc2tlbGV0b25Qb3NlRGlydHkgPSB0cnVlO1xuXHR9XG5cblx0Y29uc3RydWN0b3IoYW5pbWF0b3I6QW5pbWF0b3JCYXNlLCBza2VsZXRvbkFuaW1hdGlvbk5vZGU6U2tlbGV0b25EaWZmZXJlbmNlTm9kZSlcblx0e1xuXHRcdHN1cGVyKGFuaW1hdG9yLCBza2VsZXRvbkFuaW1hdGlvbk5vZGUpO1xuXG5cdFx0dGhpcy5fc2tlbGV0b25BbmltYXRpb25Ob2RlID0gc2tlbGV0b25BbmltYXRpb25Ob2RlO1xuXG5cdFx0dGhpcy5fYmFzZUlucHV0ID0gPElTa2VsZXRvbkFuaW1hdGlvblN0YXRlPiBhbmltYXRvci5nZXRBbmltYXRpb25TdGF0ZSh0aGlzLl9za2VsZXRvbkFuaW1hdGlvbk5vZGUuYmFzZUlucHV0KTtcblx0XHR0aGlzLl9kaWZmZXJlbmNlSW5wdXQgPSA8SVNrZWxldG9uQW5pbWF0aW9uU3RhdGU+IGFuaW1hdG9yLmdldEFuaW1hdGlvblN0YXRlKHRoaXMuX3NrZWxldG9uQW5pbWF0aW9uTm9kZS5kaWZmZXJlbmNlSW5wdXQpO1xuXHR9XG5cblx0LyoqXG5cdCAqIEBpbmhlcml0RG9jXG5cdCAqL1xuXHRwdWJsaWMgcGhhc2UodmFsdWU6bnVtYmVyKVxuXHR7XG5cdFx0dGhpcy5fc2tlbGV0b25Qb3NlRGlydHkgPSB0cnVlO1xuXG5cdFx0dGhpcy5fcFBvc2l0aW9uRGVsdGFEaXJ0eSA9IHRydWU7XG5cblx0XHR0aGlzLl9iYXNlSW5wdXQucGhhc2UodmFsdWUpO1xuXHRcdHRoaXMuX2Jhc2VJbnB1dC5waGFzZSh2YWx1ZSk7XG5cdH1cblxuXHQvKipcblx0ICogQGluaGVyaXREb2Ncblx0ICovXG5cdHB1YmxpYyBfcFVwZGF0ZVRpbWUodGltZTpudW1iZXIgLyppbnQqLylcblx0e1xuXHRcdHRoaXMuX3NrZWxldG9uUG9zZURpcnR5ID0gdHJ1ZTtcblxuXHRcdHRoaXMuX2Jhc2VJbnB1dC51cGRhdGUodGltZSk7XG5cdFx0dGhpcy5fZGlmZmVyZW5jZUlucHV0LnVwZGF0ZSh0aW1lKTtcblxuXHRcdHN1cGVyLl9wVXBkYXRlVGltZSh0aW1lKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIHRoZSBjdXJyZW50IHNrZWxldG9uIHBvc2Ugb2YgdGhlIGFuaW1hdGlvbiBpbiB0aGUgY2xpcCBiYXNlZCBvbiB0aGUgaW50ZXJuYWwgcGxheWhlYWQgcG9zaXRpb24uXG5cdCAqL1xuXHRwdWJsaWMgZ2V0U2tlbGV0b25Qb3NlKHNrZWxldG9uOlNrZWxldG9uKTpTa2VsZXRvblBvc2Vcblx0e1xuXHRcdGlmICh0aGlzLl9za2VsZXRvblBvc2VEaXJ0eSlcblx0XHRcdHRoaXMudXBkYXRlU2tlbGV0b25Qb3NlKHNrZWxldG9uKTtcblxuXHRcdHJldHVybiB0aGlzLl9za2VsZXRvblBvc2U7XG5cdH1cblxuXHQvKipcblx0ICogQGluaGVyaXREb2Ncblx0ICovXG5cdHB1YmxpYyBfcFVwZGF0ZVBvc2l0aW9uRGVsdGEoKVxuXHR7XG5cdFx0dGhpcy5fcFBvc2l0aW9uRGVsdGFEaXJ0eSA9IGZhbHNlO1xuXG5cdFx0dmFyIGRlbHRBOlZlY3RvcjNEID0gdGhpcy5fYmFzZUlucHV0LnBvc2l0aW9uRGVsdGE7XG5cdFx0dmFyIGRlbHRCOlZlY3RvcjNEID0gdGhpcy5fZGlmZmVyZW5jZUlucHV0LnBvc2l0aW9uRGVsdGE7XG5cblx0XHR0aGlzLnBvc2l0aW9uRGVsdGEueCA9IGRlbHRBLnggKyB0aGlzLl9ibGVuZFdlaWdodCpkZWx0Qi54O1xuXHRcdHRoaXMucG9zaXRpb25EZWx0YS55ID0gZGVsdEEueSArIHRoaXMuX2JsZW5kV2VpZ2h0KmRlbHRCLnk7XG5cdFx0dGhpcy5wb3NpdGlvbkRlbHRhLnogPSBkZWx0QS56ICsgdGhpcy5fYmxlbmRXZWlnaHQqZGVsdEIuejtcblx0fVxuXG5cdC8qKlxuXHQgKiBVcGRhdGVzIHRoZSBvdXRwdXQgc2tlbGV0b24gcG9zZSBvZiB0aGUgbm9kZSBiYXNlZCBvbiB0aGUgYmxlbmRXZWlnaHQgdmFsdWUgYmV0d2VlbiBiYXNlIGlucHV0IGFuZCBkaWZmZXJlbmNlIGlucHV0IG5vZGVzLlxuXHQgKlxuXHQgKiBAcGFyYW0gc2tlbGV0b24gVGhlIHNrZWxldG9uIHVzZWQgYnkgdGhlIGFuaW1hdG9yIHJlcXVlc3RpbmcgdGhlIG91cHV0IHBvc2UuXG5cdCAqL1xuXHRwcml2YXRlIHVwZGF0ZVNrZWxldG9uUG9zZShza2VsZXRvbjpTa2VsZXRvbilcblx0e1xuXHRcdHRoaXMuX3NrZWxldG9uUG9zZURpcnR5ID0gZmFsc2U7XG5cblx0XHR2YXIgZW5kUG9zZTpKb2ludFBvc2U7XG5cdFx0dmFyIGVuZFBvc2VzOkFycmF5PEpvaW50UG9zZT4gPSB0aGlzLl9za2VsZXRvblBvc2Uuam9pbnRQb3Nlcztcblx0XHR2YXIgYmFzZVBvc2VzOkFycmF5PEpvaW50UG9zZT4gPSB0aGlzLl9iYXNlSW5wdXQuZ2V0U2tlbGV0b25Qb3NlKHNrZWxldG9uKS5qb2ludFBvc2VzO1xuXHRcdHZhciBkaWZmUG9zZXM6QXJyYXk8Sm9pbnRQb3NlPiA9IHRoaXMuX2RpZmZlcmVuY2VJbnB1dC5nZXRTa2VsZXRvblBvc2Uoc2tlbGV0b24pLmpvaW50UG9zZXM7XG5cdFx0dmFyIGJhc2U6Sm9pbnRQb3NlLCBkaWZmOkpvaW50UG9zZTtcblx0XHR2YXIgYmFzZVBvczpWZWN0b3IzRCwgZGlmZlBvczpWZWN0b3IzRDtcblx0XHR2YXIgdHI6VmVjdG9yM0Q7XG5cdFx0dmFyIG51bUpvaW50czpudW1iZXIgLyp1aW50Ki8gPSBza2VsZXRvbi5udW1Kb2ludHM7XG5cblx0XHQvLyA6c1xuXHRcdGlmIChlbmRQb3Nlcy5sZW5ndGggIT0gbnVtSm9pbnRzKVxuXHRcdFx0ZW5kUG9zZXMubGVuZ3RoID0gbnVtSm9pbnRzO1xuXG5cdFx0Zm9yICh2YXIgaTpudW1iZXIgLyp1aW50Ki8gPSAwOyBpIDwgbnVtSm9pbnRzOyArK2kpIHtcblx0XHRcdGVuZFBvc2UgPSBlbmRQb3Nlc1tpXTtcblxuXHRcdFx0aWYgKGVuZFBvc2UgPT0gbnVsbClcblx0XHRcdFx0ZW5kUG9zZSA9IGVuZFBvc2VzW2ldID0gbmV3IEpvaW50UG9zZSgpO1xuXG5cdFx0XHRiYXNlID0gYmFzZVBvc2VzW2ldO1xuXHRcdFx0ZGlmZiA9IGRpZmZQb3Nlc1tpXTtcblx0XHRcdGJhc2VQb3MgPSBiYXNlLnRyYW5zbGF0aW9uO1xuXHRcdFx0ZGlmZlBvcyA9IGRpZmYudHJhbnNsYXRpb247XG5cblx0XHRcdFNrZWxldG9uRGlmZmVyZW5jZVN0YXRlLl90ZW1wUXVhdC5tdWx0aXBseShkaWZmLm9yaWVudGF0aW9uLCBiYXNlLm9yaWVudGF0aW9uKTtcblx0XHRcdGVuZFBvc2Uub3JpZW50YXRpb24ubGVycChiYXNlLm9yaWVudGF0aW9uLCBTa2VsZXRvbkRpZmZlcmVuY2VTdGF0ZS5fdGVtcFF1YXQsIHRoaXMuX2JsZW5kV2VpZ2h0KTtcblxuXHRcdFx0dHIgPSBlbmRQb3NlLnRyYW5zbGF0aW9uO1xuXHRcdFx0dHIueCA9IGJhc2VQb3MueCArIHRoaXMuX2JsZW5kV2VpZ2h0KmRpZmZQb3MueDtcblx0XHRcdHRyLnkgPSBiYXNlUG9zLnkgKyB0aGlzLl9ibGVuZFdlaWdodCpkaWZmUG9zLnk7XG5cdFx0XHR0ci56ID0gYmFzZVBvcy56ICsgdGhpcy5fYmxlbmRXZWlnaHQqZGlmZlBvcy56O1xuXHRcdH1cblx0fVxufVxuXG5leHBvcnQgPSBTa2VsZXRvbkRpZmZlcmVuY2VTdGF0ZTsiXX0=