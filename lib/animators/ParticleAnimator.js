var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var ContextGLProgramType = require("awayjs-stagegl/lib/base/ContextGLProgramType");
var AnimatorBase = require("awayjs-renderergl/lib/animators/AnimatorBase");
var AnimationSubGeometry = require("awayjs-renderergl/lib/animators/data/AnimationSubGeometry");
var ParticlePropertiesMode = require("awayjs-renderergl/lib/animators/data/ParticlePropertiesMode");
/**
 * Provides an interface for assigning paricle-based animation data sets to mesh-based entity objects
 * and controlling the various available states of animation through an interative playhead that can be
 * automatically updated or manually triggered.
 *
 * Requires that the containing geometry of the parent mesh is particle geometry
 *
 * @see away.base.ParticleGeometry
 */
var ParticleAnimator = (function (_super) {
    __extends(ParticleAnimator, _super);
    /**
     * Creates a new <code>ParticleAnimator</code> object.
     *
     * @param particleAnimationSet The animation data set containing the particle animations used by the animator.
     */
    function ParticleAnimator(particleAnimationSet) {
        _super.call(this, particleAnimationSet);
        this._animationParticleStates = new Array();
        this._animatorParticleStates = new Array();
        this._timeParticleStates = new Array();
        this._totalLenOfOneVertex = 0;
        this._animatorSubGeometries = new Object();
        this._particleAnimationSet = particleAnimationSet;
        var state;
        var node;
        for (var i = 0; i < this._particleAnimationSet.particleNodes.length; i++) {
            node = this._particleAnimationSet.particleNodes[i];
            state = this.getAnimationState(node);
            if (node.mode == ParticlePropertiesMode.LOCAL_DYNAMIC) {
                this._animatorParticleStates.push(state);
                node._iDataOffset = this._totalLenOfOneVertex;
                this._totalLenOfOneVertex += node.dataLength;
            }
            else {
                this._animationParticleStates.push(state);
            }
            if (state.needUpdateTime)
                this._timeParticleStates.push(state);
        }
    }
    /**
     * @inheritDoc
     */
    ParticleAnimator.prototype.clone = function () {
        return new ParticleAnimator(this._particleAnimationSet);
    };
    /**
     * @inheritDoc
     */
    ParticleAnimator.prototype.setRenderState = function (shaderObject, renderable, stage, camera, vertexConstantOffset /*int*/, vertexStreamOffset /*int*/) {
        var animationRegisterCache = this._particleAnimationSet._iAnimationRegisterCache;
        var subMesh = renderable.subMesh;
        var state;
        var i;
        if (!subMesh)
            throw (new Error("Must be subMesh"));
        //process animation sub geometries
        var animationSubGeometry = this._particleAnimationSet.getAnimationSubGeometry(subMesh);
        for (i = 0; i < this._animationParticleStates.length; i++)
            this._animationParticleStates[i].setRenderState(stage, renderable, animationSubGeometry, animationRegisterCache, camera);
        //process animator subgeometries
        var animatorSubGeometry = this.getAnimatorSubGeometry(subMesh);
        for (i = 0; i < this._animatorParticleStates.length; i++)
            this._animatorParticleStates[i].setRenderState(stage, renderable, animatorSubGeometry, animationRegisterCache, camera);
        stage.context.setProgramConstantsFromArray(ContextGLProgramType.VERTEX, animationRegisterCache.vertexConstantOffset, animationRegisterCache.vertexConstantData, animationRegisterCache.numVertexConstant);
        if (animationRegisterCache.numFragmentConstant > 0)
            stage.context.setProgramConstantsFromArray(ContextGLProgramType.FRAGMENT, animationRegisterCache.fragmentConstantOffset, animationRegisterCache.fragmentConstantData, animationRegisterCache.numFragmentConstant);
    };
    /**
     * @inheritDoc
     */
    ParticleAnimator.prototype.testGPUCompatibility = function (shaderObject) {
    };
    /**
     * @inheritDoc
     */
    ParticleAnimator.prototype.start = function () {
        _super.prototype.start.call(this);
        for (var i = 0; i < this._timeParticleStates.length; i++)
            this._timeParticleStates[i].offset(this._pAbsoluteTime);
    };
    /**
     * @inheritDoc
     */
    ParticleAnimator.prototype._pUpdateDeltaTime = function (dt) {
        this._pAbsoluteTime += dt;
        for (var i = 0; i < this._timeParticleStates.length; i++)
            this._timeParticleStates[i].update(this._pAbsoluteTime);
    };
    /**
     * @inheritDoc
     */
    ParticleAnimator.prototype.resetTime = function (offset) {
        if (offset === void 0) { offset = 0; }
        for (var i = 0; i < this._timeParticleStates.length; i++)
            this._timeParticleStates[i].offset(this._pAbsoluteTime + offset);
        this.update(this.time);
    };
    ParticleAnimator.prototype.dispose = function () {
        for (var key in this._animatorSubGeometries)
            this._animatorSubGeometries[key].dispose();
    };
    ParticleAnimator.prototype.getAnimatorSubGeometry = function (subMesh) {
        if (!this._animatorParticleStates.length)
            return;
        var subGeometry = subMesh.subGeometry;
        var animatorSubGeometry = this._animatorSubGeometries[subGeometry.id] = new AnimationSubGeometry();
        //create the vertexData vector that will be used for local state data
        animatorSubGeometry.createVertexData(subGeometry.numVertices, this._totalLenOfOneVertex);
        //pass the particles data to the animator subGeometry
        animatorSubGeometry.animationParticles = this._particleAnimationSet.getAnimationSubGeometry(subMesh).animationParticles;
    };
    return ParticleAnimator;
})(AnimatorBase);
module.exports = ParticleAnimator;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9hbmltYXRvcnMvUGFydGljbGVBbmltYXRvci50cyJdLCJuYW1lcyI6WyJQYXJ0aWNsZUFuaW1hdG9yIiwiUGFydGljbGVBbmltYXRvci5jb25zdHJ1Y3RvciIsIlBhcnRpY2xlQW5pbWF0b3IuY2xvbmUiLCJQYXJ0aWNsZUFuaW1hdG9yLnNldFJlbmRlclN0YXRlIiwiUGFydGljbGVBbmltYXRvci50ZXN0R1BVQ29tcGF0aWJpbGl0eSIsIlBhcnRpY2xlQW5pbWF0b3Iuc3RhcnQiLCJQYXJ0aWNsZUFuaW1hdG9yLl9wVXBkYXRlRGVsdGFUaW1lIiwiUGFydGljbGVBbmltYXRvci5yZXNldFRpbWUiLCJQYXJ0aWNsZUFuaW1hdG9yLmRpc3Bvc2UiLCJQYXJ0aWNsZUFuaW1hdG9yLmdldEFuaW1hdG9yU3ViR2VvbWV0cnkiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUlBLElBQU8sb0JBQW9CLFdBQWMsOENBQThDLENBQUMsQ0FBQztBQUd6RixJQUFPLFlBQVksV0FBZ0IsOENBQThDLENBQUMsQ0FBQztBQUduRixJQUFPLG9CQUFvQixXQUFjLDJEQUEyRCxDQUFDLENBQUM7QUFFdEcsSUFBTyxzQkFBc0IsV0FBYSw2REFBNkQsQ0FBQyxDQUFDO0FBT3pHLEFBU0E7Ozs7Ozs7O0dBREc7SUFDRyxnQkFBZ0I7SUFBU0EsVUFBekJBLGdCQUFnQkEsVUFBcUJBO0lBVTFDQTs7OztPQUlHQTtJQUNIQSxTQWZLQSxnQkFBZ0JBLENBZVRBLG9CQUF5Q0E7UUFFcERDLGtCQUFNQSxvQkFBb0JBLENBQUNBLENBQUNBO1FBYnJCQSw2QkFBd0JBLEdBQTRCQSxJQUFJQSxLQUFLQSxFQUFxQkEsQ0FBQ0E7UUFDbkZBLDRCQUF1QkEsR0FBNEJBLElBQUlBLEtBQUtBLEVBQXFCQSxDQUFDQTtRQUNsRkEsd0JBQW1CQSxHQUE0QkEsSUFBSUEsS0FBS0EsRUFBcUJBLENBQUNBO1FBQzlFQSx5QkFBb0JBLEdBQW1CQSxDQUFDQSxDQUFDQTtRQUN6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eEJBLENBQUNBO0lBRU1QLGtDQUFPQSxHQUFkQTtRQUVDUSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxHQUFHQSxJQUFJQSxJQUFJQSxDQUFDQSxzQkFBc0JBLENBQUNBO1lBQ25CQSxJQUFJQSxDQUFDQSxzQkFBc0JBLENBQUNBLEdBQUdBLENBQUVBLENBQUNBLE9BQU9BLEVBQUVBLENBQUNBO0lBQ3RFQSxDQUFDQTtJQUVPUixpREFBc0JBLEdBQTlCQSxVQUErQkEsT0FBZ0JBO1FBRTlDUyxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSx1QkFBdUJBLENBQUNBLE1BQU1BLENBQUNBO1lBQ3hDQSxNQUFNQSxDQUFDQTtRQUVSQSxJQUFJQSxXQUFXQSxHQUFtQkEsT0FBT0EsQ0FBQ0EsV0FBV0EsQ0FBQ0E7UUFDdERBLElBQUlBLG1CQUFtQkEsR0FBd0JBLElBQUlBLENBQUNBLHNCQUFzQkEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsSUFBSUEsb0JBQW9CQSxFQUFFQSxDQUFDQTtRQUV4SEEsQUFDQUEscUVBRHFFQTtRQUNyRUEsbUJBQW1CQSxDQUFDQSxnQkFBZ0JBLENBQUNBLFdBQVdBLENBQUNBLFdBQVdBLEVBQUVBLElBQUlBLENBQUNBLG9CQUFvQkEsQ0FBQ0EsQ0FBQ0E7UUFFekZBLEFBQ0FBLHFEQURxREE7UUFDckRBLG1CQUFtQkEsQ0FBQ0Esa0JBQWtCQSxHQUFHQSxJQUFJQSxDQUFDQSxxQkFBcUJBLENBQUNBLHVCQUF1QkEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0Esa0JBQWtCQSxDQUFDQTtJQUN6SEEsQ0FBQ0E7SUFDRlQsdUJBQUNBO0FBQURBLENBMUlBLEFBMElDQSxFQTFJOEIsWUFBWSxFQTBJMUM7QUFFRCxBQUEwQixpQkFBakIsZ0JBQWdCLENBQUMiLCJmaWxlIjoiYW5pbWF0b3JzL1BhcnRpY2xlQW5pbWF0b3IuanMiLCJzb3VyY2VSb290IjoiLi4vIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IElTdWJNZXNoXHRcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvYmFzZS9JU3ViTWVzaFwiKTtcclxuaW1wb3J0IFN1Ykdlb21ldHJ5QmFzZVx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvYmFzZS9TdWJHZW9tZXRyeUJhc2VcIik7XHJcbmltcG9ydCBDYW1lcmFcdFx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9lbnRpdGllcy9DYW1lcmFcIik7XHJcblxyXG5pbXBvcnQgQ29udGV4dEdMUHJvZ3JhbVR5cGVcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9iYXNlL0NvbnRleHRHTFByb2dyYW1UeXBlXCIpO1xyXG5pbXBvcnQgU3RhZ2VcdFx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9iYXNlL1N0YWdlXCIpO1xyXG5cclxuaW1wb3J0IEFuaW1hdG9yQmFzZVx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9hbmltYXRvcnMvQW5pbWF0b3JCYXNlXCIpO1xyXG5pbXBvcnQgQW5pbWF0aW9uUmVnaXN0ZXJDYWNoZVx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9hbmltYXRvcnMvZGF0YS9BbmltYXRpb25SZWdpc3RlckNhY2hlXCIpO1xyXG5pbXBvcnQgUGFydGljbGVBbmltYXRpb25TZXRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9hbmltYXRvcnMvUGFydGljbGVBbmltYXRpb25TZXRcIik7XHJcbmltcG9ydCBBbmltYXRpb25TdWJHZW9tZXRyeVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2FuaW1hdG9ycy9kYXRhL0FuaW1hdGlvblN1Ykdlb21ldHJ5XCIpO1xyXG5pbXBvcnQgUGFydGljbGVBbmltYXRpb25EYXRhXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2FuaW1hdG9ycy9kYXRhL1BhcnRpY2xlQW5pbWF0aW9uRGF0YVwiKTtcclxuaW1wb3J0IFBhcnRpY2xlUHJvcGVydGllc01vZGVcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvYW5pbWF0b3JzL2RhdGEvUGFydGljbGVQcm9wZXJ0aWVzTW9kZVwiKTtcclxuaW1wb3J0IFBhcnRpY2xlTm9kZUJhc2VcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2FuaW1hdG9ycy9ub2Rlcy9QYXJ0aWNsZU5vZGVCYXNlXCIpO1xyXG5pbXBvcnQgUGFydGljbGVTdGF0ZUJhc2VcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9hbmltYXRvcnMvc3RhdGVzL1BhcnRpY2xlU3RhdGVCYXNlXCIpO1xyXG5pbXBvcnQgU2hhZGVyT2JqZWN0QmFzZVx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvY29tcGlsYXRpb24vU2hhZGVyT2JqZWN0QmFzZVwiKTtcclxuaW1wb3J0IFJlbmRlcmFibGVCYXNlXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9wb29sL1JlbmRlcmFibGVCYXNlXCIpO1xyXG5pbXBvcnQgVHJpYW5nbGVTdWJNZXNoUmVuZGVyYWJsZVx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvcG9vbC9UcmlhbmdsZVN1Yk1lc2hSZW5kZXJhYmxlXCIpO1xyXG5cclxuLyoqXHJcbiAqIFByb3ZpZGVzIGFuIGludGVyZmFjZSBmb3IgYXNzaWduaW5nIHBhcmljbGUtYmFzZWQgYW5pbWF0aW9uIGRhdGEgc2V0cyB0byBtZXNoLWJhc2VkIGVudGl0eSBvYmplY3RzXHJcbiAqIGFuZCBjb250cm9sbGluZyB0aGUgdmFyaW91cyBhdmFpbGFibGUgc3RhdGVzIG9mIGFuaW1hdGlvbiB0aHJvdWdoIGFuIGludGVyYXRpdmUgcGxheWhlYWQgdGhhdCBjYW4gYmVcclxuICogYXV0b21hdGljYWxseSB1cGRhdGVkIG9yIG1hbnVhbGx5IHRyaWdnZXJlZC5cclxuICpcclxuICogUmVxdWlyZXMgdGhhdCB0aGUgY29udGFpbmluZyBnZW9tZXRyeSBvZiB0aGUgcGFyZW50IG1lc2ggaXMgcGFydGljbGUgZ2VvbWV0cnlcclxuICpcclxuICogQHNlZSBhd2F5LmJhc2UuUGFydGljbGVHZW9tZXRyeVxyXG4gKi9cclxuY2xhc3MgUGFydGljbGVBbmltYXRvciBleHRlbmRzIEFuaW1hdG9yQmFzZVxyXG57XHJcblxyXG5cdHByaXZhdGUgX3BhcnRpY2xlQW5pbWF0aW9uU2V0OlBhcnRpY2xlQW5pbWF0aW9uU2V0O1xyXG5cdHByaXZhdGUgX2FuaW1hdGlvblBhcnRpY2xlU3RhdGVzOkFycmF5PFBhcnRpY2xlU3RhdGVCYXNlPiA9IG5ldyBBcnJheTxQYXJ0aWNsZVN0YXRlQmFzZT4oKTtcclxuXHRwcml2YXRlIF9hbmltYXRvclBhcnRpY2xlU3RhdGVzOkFycmF5PFBhcnRpY2xlU3RhdGVCYXNlPiA9IG5ldyBBcnJheTxQYXJ0aWNsZVN0YXRlQmFzZT4oKTtcclxuXHRwcml2YXRlIF90aW1lUGFydGljbGVTdGF0ZXM6QXJyYXk8UGFydGljbGVTdGF0ZUJhc2U+ID0gbmV3IEFycmF5PFBhcnRpY2xlU3RhdGVCYXNlPigpO1xyXG5cdHByaXZhdGUgX3RvdGFsTGVuT2ZPbmVWZXJ0ZXg6bnVtYmVyIC8qdWludCovID0gMDtcclxuXHRwcml2YXRlIF9hbmltYXRvclN1Ykdlb21ldHJpZXM6T2JqZWN0ID0gbmV3IE9iamVjdCgpO1xyXG5cclxuXHQvKipcclxuXHQgKiBDcmVhdGVzIGEgbmV3IDxjb2RlPlBhcnRpY2xlQW5pbWF0b3I8L2NvZGU+IG9iamVjdC5cclxuXHQgKlxyXG5cdCAqIEBwYXJhbSBwYXJ0aWNsZUFuaW1hdGlvblNldCBUaGUgYW5pbWF0aW9uIGRhdGEgc2V0IGNvbnRhaW5pbmcgdGhlIHBhcnRpY2xlIGFuaW1hdGlvbnMgdXNlZCBieSB0aGUgYW5pbWF0b3IuXHJcblx0ICovXHJcblx0Y29uc3RydWN0b3IocGFydGljbGVBbmltYXRpb25TZXQ6UGFydGljbGVBbmltYXRpb25TZXQpXHJcblx0e1xyXG5cdFx0c3VwZXIocGFydGljbGVBbmltYXRpb25TZXQpO1xyXG5cdFx0dGhpcy5fcGFydGljbGVBbmltYXRpb25TZXQgPSBwYXJ0aWNsZUFuaW1hdGlvblNldDtcclxuXHJcblx0XHR2YXIgc3RhdGU6UGFydGljbGVTdGF0ZUJhc2U7XHJcblx0XHR2YXIgbm9kZTpQYXJ0aWNsZU5vZGVCYXNlO1xyXG5cclxuXHRcdGZvciAodmFyIGk6bnVtYmVyID0gMDsgaSA8IHRoaXMuX3BhcnRpY2xlQW5pbWF0aW9uU2V0LnBhcnRpY2xlTm9kZXMubGVuZ3RoOyBpKyspIHtcclxuXHRcdFx0bm9kZSA9IHRoaXMuX3BhcnRpY2xlQW5pbWF0aW9uU2V0LnBhcnRpY2xlTm9kZXNbaV07XHJcblx0XHRcdHN0YXRlID0gPFBhcnRpY2xlU3RhdGVCYXNlPiB0aGlzLmdldEFuaW1hdGlvblN0YXRlKG5vZGUpO1xyXG5cdFx0XHRpZiAobm9kZS5tb2RlID09IFBhcnRpY2xlUHJvcGVydGllc01vZGUuTE9DQUxfRFlOQU1JQykge1xyXG5cdFx0XHRcdHRoaXMuX2FuaW1hdG9yUGFydGljbGVTdGF0ZXMucHVzaChzdGF0ZSk7XHJcblx0XHRcdFx0bm9kZS5faURhdGFPZmZzZXQgPSB0aGlzLl90b3RhbExlbk9mT25lVmVydGV4O1xyXG5cdFx0XHRcdHRoaXMuX3RvdGFsTGVuT2ZPbmVWZXJ0ZXggKz0gbm9kZS5kYXRhTGVuZ3RoO1xyXG5cdFx0XHR9IGVsc2Uge1xyXG5cdFx0XHRcdHRoaXMuX2FuaW1hdGlvblBhcnRpY2xlU3RhdGVzLnB1c2goc3RhdGUpO1xyXG5cdFx0XHR9XHJcblx0XHRcdGlmIChzdGF0ZS5uZWVkVXBkYXRlVGltZSlcclxuXHRcdFx0XHR0aGlzLl90aW1lUGFydGljbGVTdGF0ZXMucHVzaChzdGF0ZSk7XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiBAaW5oZXJpdERvY1xyXG5cdCAqL1xyXG5cdHB1YmxpYyBjbG9uZSgpOkFuaW1hdG9yQmFzZVxyXG5cdHtcclxuXHRcdHJldHVybiBuZXcgUGFydGljbGVBbmltYXRvcih0aGlzLl9wYXJ0aWNsZUFuaW1hdGlvblNldCk7XHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiBAaW5oZXJpdERvY1xyXG5cdCAqL1xyXG5cdHB1YmxpYyBzZXRSZW5kZXJTdGF0ZShzaGFkZXJPYmplY3Q6U2hhZGVyT2JqZWN0QmFzZSwgcmVuZGVyYWJsZTpSZW5kZXJhYmxlQmFzZSwgc3RhZ2U6U3RhZ2UsIGNhbWVyYTpDYW1lcmEsIHZlcnRleENvbnN0YW50T2Zmc2V0Om51bWJlciAvKmludCovLCB2ZXJ0ZXhTdHJlYW1PZmZzZXQ6bnVtYmVyIC8qaW50Ki8pXHJcblx0e1xyXG5cdFx0dmFyIGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGU6QW5pbWF0aW9uUmVnaXN0ZXJDYWNoZSA9IHRoaXMuX3BhcnRpY2xlQW5pbWF0aW9uU2V0Ll9pQW5pbWF0aW9uUmVnaXN0ZXJDYWNoZTtcclxuXHJcblx0XHR2YXIgc3ViTWVzaDpJU3ViTWVzaCA9ICg8VHJpYW5nbGVTdWJNZXNoUmVuZGVyYWJsZT4gcmVuZGVyYWJsZSkuc3ViTWVzaDtcclxuXHRcdHZhciBzdGF0ZTpQYXJ0aWNsZVN0YXRlQmFzZTtcclxuXHRcdHZhciBpOm51bWJlcjtcclxuXHJcblx0XHRpZiAoIXN1Yk1lc2gpXHJcblx0XHRcdHRocm93KG5ldyBFcnJvcihcIk11c3QgYmUgc3ViTWVzaFwiKSk7XHJcblxyXG5cdFx0Ly9wcm9jZXNzIGFuaW1hdGlvbiBzdWIgZ2VvbWV0cmllc1xyXG5cdFx0dmFyIGFuaW1hdGlvblN1Ykdlb21ldHJ5OkFuaW1hdGlvblN1Ykdlb21ldHJ5ID0gdGhpcy5fcGFydGljbGVBbmltYXRpb25TZXQuZ2V0QW5pbWF0aW9uU3ViR2VvbWV0cnkoc3ViTWVzaCk7XHJcblxyXG5cdFx0Zm9yIChpID0gMDsgaSA8IHRoaXMuX2FuaW1hdGlvblBhcnRpY2xlU3RhdGVzLmxlbmd0aDsgaSsrKVxyXG5cdFx0XHR0aGlzLl9hbmltYXRpb25QYXJ0aWNsZVN0YXRlc1tpXS5zZXRSZW5kZXJTdGF0ZShzdGFnZSwgcmVuZGVyYWJsZSwgYW5pbWF0aW9uU3ViR2VvbWV0cnksIGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGUsIGNhbWVyYSk7XHJcblxyXG5cdFx0Ly9wcm9jZXNzIGFuaW1hdG9yIHN1Ymdlb21ldHJpZXNcclxuXHRcdHZhciBhbmltYXRvclN1Ykdlb21ldHJ5OkFuaW1hdGlvblN1Ykdlb21ldHJ5ID0gdGhpcy5nZXRBbmltYXRvclN1Ykdlb21ldHJ5KHN1Yk1lc2gpO1xyXG5cclxuXHRcdGZvciAoaSA9IDA7IGkgPCB0aGlzLl9hbmltYXRvclBhcnRpY2xlU3RhdGVzLmxlbmd0aDsgaSsrKVxyXG5cdFx0XHR0aGlzLl9hbmltYXRvclBhcnRpY2xlU3RhdGVzW2ldLnNldFJlbmRlclN0YXRlKHN0YWdlLCByZW5kZXJhYmxlLCBhbmltYXRvclN1Ykdlb21ldHJ5LCBhbmltYXRpb25SZWdpc3RlckNhY2hlLCBjYW1lcmEpO1xyXG5cclxuXHRcdHN0YWdlLmNvbnRleHQuc2V0UHJvZ3JhbUNvbnN0YW50c0Zyb21BcnJheShDb250ZXh0R0xQcm9ncmFtVHlwZS5WRVJURVgsIGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGUudmVydGV4Q29uc3RhbnRPZmZzZXQsIGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGUudmVydGV4Q29uc3RhbnREYXRhLCBhbmltYXRpb25SZWdpc3RlckNhY2hlLm51bVZlcnRleENvbnN0YW50KTtcclxuXHJcblx0XHRpZiAoYW5pbWF0aW9uUmVnaXN0ZXJDYWNoZS5udW1GcmFnbWVudENvbnN0YW50ID4gMClcclxuXHRcdFx0c3RhZ2UuY29udGV4dC5zZXRQcm9ncmFtQ29uc3RhbnRzRnJvbUFycmF5KENvbnRleHRHTFByb2dyYW1UeXBlLkZSQUdNRU5ULCBhbmltYXRpb25SZWdpc3RlckNhY2hlLmZyYWdtZW50Q29uc3RhbnRPZmZzZXQsIGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGUuZnJhZ21lbnRDb25zdGFudERhdGEsIGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGUubnVtRnJhZ21lbnRDb25zdGFudCk7XHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiBAaW5oZXJpdERvY1xyXG5cdCAqL1xyXG5cdHB1YmxpYyB0ZXN0R1BVQ29tcGF0aWJpbGl0eShzaGFkZXJPYmplY3Q6U2hhZGVyT2JqZWN0QmFzZSlcclxuXHR7XHJcblxyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogQGluaGVyaXREb2NcclxuXHQgKi9cclxuXHRwdWJsaWMgc3RhcnQoKVxyXG5cdHtcclxuXHRcdHN1cGVyLnN0YXJ0KCk7XHJcblxyXG5cdFx0Zm9yICh2YXIgaTpudW1iZXIgPSAwOyBpIDwgdGhpcy5fdGltZVBhcnRpY2xlU3RhdGVzLmxlbmd0aDsgaSsrKVxyXG5cdFx0XHR0aGlzLl90aW1lUGFydGljbGVTdGF0ZXNbaV0ub2Zmc2V0KHRoaXMuX3BBYnNvbHV0ZVRpbWUpO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogQGluaGVyaXREb2NcclxuXHQgKi9cclxuXHRwdWJsaWMgX3BVcGRhdGVEZWx0YVRpbWUoZHQ6bnVtYmVyKVxyXG5cdHtcclxuXHRcdHRoaXMuX3BBYnNvbHV0ZVRpbWUgKz0gZHQ7XHJcblxyXG5cdFx0Zm9yICh2YXIgaTpudW1iZXIgPSAwOyBpIDwgdGhpcy5fdGltZVBhcnRpY2xlU3RhdGVzLmxlbmd0aDsgaSsrKVxyXG5cdFx0XHR0aGlzLl90aW1lUGFydGljbGVTdGF0ZXNbaV0udXBkYXRlKHRoaXMuX3BBYnNvbHV0ZVRpbWUpO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogQGluaGVyaXREb2NcclxuXHQgKi9cclxuXHRwdWJsaWMgcmVzZXRUaW1lKG9mZnNldDpudW1iZXIgLyppbnQqLyA9IDApXHJcblx0e1xyXG5cdFx0Zm9yICh2YXIgaTpudW1iZXIgPSAwOyBpIDwgdGhpcy5fdGltZVBhcnRpY2xlU3RhdGVzLmxlbmd0aDsgaSsrKVxyXG5cdFx0XHR0aGlzLl90aW1lUGFydGljbGVTdGF0ZXNbaV0ub2Zmc2V0KHRoaXMuX3BBYnNvbHV0ZVRpbWUgKyBvZmZzZXQpO1xyXG5cdFx0dGhpcy51cGRhdGUodGhpcy50aW1lKTtcclxuXHR9XHJcblxyXG5cdHB1YmxpYyBkaXNwb3NlKClcclxuXHR7XHJcblx0XHRmb3IgKHZhciBrZXkgaW4gdGhpcy5fYW5pbWF0b3JTdWJHZW9tZXRyaWVzKVxyXG5cdFx0XHQoPEFuaW1hdGlvblN1Ykdlb21ldHJ5PiB0aGlzLl9hbmltYXRvclN1Ykdlb21ldHJpZXNba2V5XSkuZGlzcG9zZSgpO1xyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSBnZXRBbmltYXRvclN1Ykdlb21ldHJ5KHN1Yk1lc2g6SVN1Yk1lc2gpOkFuaW1hdGlvblN1Ykdlb21ldHJ5XHJcblx0e1xyXG5cdFx0aWYgKCF0aGlzLl9hbmltYXRvclBhcnRpY2xlU3RhdGVzLmxlbmd0aClcclxuXHRcdFx0cmV0dXJuO1xyXG5cclxuXHRcdHZhciBzdWJHZW9tZXRyeTpTdWJHZW9tZXRyeUJhc2UgPSBzdWJNZXNoLnN1Ykdlb21ldHJ5O1xyXG5cdFx0dmFyIGFuaW1hdG9yU3ViR2VvbWV0cnk6QW5pbWF0aW9uU3ViR2VvbWV0cnkgPSB0aGlzLl9hbmltYXRvclN1Ykdlb21ldHJpZXNbc3ViR2VvbWV0cnkuaWRdID0gbmV3IEFuaW1hdGlvblN1Ykdlb21ldHJ5KCk7XHJcblxyXG5cdFx0Ly9jcmVhdGUgdGhlIHZlcnRleERhdGEgdmVjdG9yIHRoYXQgd2lsbCBiZSB1c2VkIGZvciBsb2NhbCBzdGF0ZSBkYXRhXHJcblx0XHRhbmltYXRvclN1Ykdlb21ldHJ5LmNyZWF0ZVZlcnRleERhdGEoc3ViR2VvbWV0cnkubnVtVmVydGljZXMsIHRoaXMuX3RvdGFsTGVuT2ZPbmVWZXJ0ZXgpO1xyXG5cclxuXHRcdC8vcGFzcyB0aGUgcGFydGljbGVzIGRhdGEgdG8gdGhlIGFuaW1hdG9yIHN1Ykdlb21ldHJ5XHJcblx0XHRhbmltYXRvclN1Ykdlb21ldHJ5LmFuaW1hdGlvblBhcnRpY2xlcyA9IHRoaXMuX3BhcnRpY2xlQW5pbWF0aW9uU2V0LmdldEFuaW1hdGlvblN1Ykdlb21ldHJ5KHN1Yk1lc2gpLmFuaW1hdGlvblBhcnRpY2xlcztcclxuXHR9XHJcbn1cclxuXHJcbmV4cG9ydCA9IFBhcnRpY2xlQW5pbWF0b3I7Il19