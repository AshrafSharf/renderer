var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var ShaderRegisterElement = require("awayjs-stagegl/lib/materials/compilation/ShaderRegisterElement");
var ParticleAnimationSet = require("awayjs-renderergl/lib/animators/ParticleAnimationSet");
var ParticlePropertiesMode = require("awayjs-renderergl/lib/animators/data/ParticlePropertiesMode");
var ParticleNodeBase = require("awayjs-renderergl/lib/animators/nodes/ParticleNodeBase");
var ParticleSegmentedColorState = require("awayjs-renderergl/lib/animators/states/ParticleSegmentedColorState");
/**
 *
 */
var ParticleSegmentedColorNode = (function (_super) {
    __extends(ParticleSegmentedColorNode, _super);
    function ParticleSegmentedColorNode(usesMultiplier, usesOffset, numSegmentPoint /*int*/, startColor, endColor, segmentPoints) {
        //because of the stage3d register limitation, it only support the global mode
        _super.call(this, "ParticleSegmentedColor", ParticlePropertiesMode.GLOBAL, 0, ParticleAnimationSet.COLOR_PRIORITY);
        this._pStateClass = ParticleSegmentedColorState;
        if (numSegmentPoint > 4)
            throw (new Error("the numSegmentPoint must be less or equal 4"));
        this._iUsesMultiplier = usesMultiplier;
        this._iUsesOffset = usesOffset;
        this._iNumSegmentPoint = numSegmentPoint;
        this._iStartColor = startColor;
        this._iEndColor = endColor;
        this._iSegmentPoints = segmentPoints;
    }
    /**
     * @inheritDoc
     */
    ParticleSegmentedColorNode.prototype._iProcessAnimationSetting = function (particleAnimationSet) {
        if (this._iUsesMultiplier)
            particleAnimationSet.hasColorMulNode = true;
        if (this._iUsesOffset)
            particleAnimationSet.hasColorAddNode = true;
    };
    /**
     * @inheritDoc
     */
    ParticleSegmentedColorNode.prototype.getAGALVertexCode = function (shaderObject, animationRegisterCache) {
        var code = "";
        if (animationRegisterCache.needFragmentAnimation) {
            var accMultiplierColor;
            //var accOffsetColor:ShaderRegisterElement;
            if (this._iUsesMultiplier) {
                accMultiplierColor = animationRegisterCache.getFreeVertexVectorTemp();
                animationRegisterCache.addVertexTempUsages(accMultiplierColor, 1);
            }
            var tempColor = animationRegisterCache.getFreeVertexVectorTemp();
            animationRegisterCache.addVertexTempUsages(tempColor, 1);
            var temp = animationRegisterCache.getFreeVertexVectorTemp();
            var accTime = new ShaderRegisterElement(temp.regName, temp.index, 0);
            var tempTime = new ShaderRegisterElement(temp.regName, temp.index, 1);
            if (this._iUsesMultiplier)
                animationRegisterCache.removeVertexTempUsage(accMultiplierColor);
            animationRegisterCache.removeVertexTempUsage(tempColor);
            //for saving all the life values (at most 4)
            var lifeTimeRegister = animationRegisterCache.getFreeVertexConstant();
            animationRegisterCache.setRegisterIndex(this, ParticleSegmentedColorState.TIME_DATA_INDEX, lifeTimeRegister.index);
            var i /*int*/;
            var startMulValue;
            var deltaMulValues;
            if (this._iUsesMultiplier) {
                startMulValue = animationRegisterCache.getFreeVertexConstant();
                animationRegisterCache.setRegisterIndex(this, ParticleSegmentedColorState.START_MULTIPLIER_INDEX, startMulValue.index);
                deltaMulValues = new Array();
                for (i = 0; i < this._iNumSegmentPoint + 1; i++)
                    deltaMulValues.push(animationRegisterCache.getFreeVertexConstant());
            }
            var startOffsetValue;
            var deltaOffsetValues;
            if (this._iUsesOffset) {
                startOffsetValue = animationRegisterCache.getFreeVertexConstant();
                animationRegisterCache.setRegisterIndex(this, ParticleSegmentedColorState.START_OFFSET_INDEX, startOffsetValue.index);
                deltaOffsetValues = new Array();
                for (i = 0; i < this._iNumSegmentPoint + 1; i++)
                    deltaOffsetValues.push(animationRegisterCache.getFreeVertexConstant());
            }
            if (this._iUsesMultiplier)
                code += "mov " + accMultiplierColor + "," + startMulValue + "\n";
            if (this._iUsesOffset)
                code += "add " + animationRegisterCache.colorAddTarget + "," + animationRegisterCache.colorAddTarget + "," + startOffsetValue + "\n";
            for (i = 0; i < this._iNumSegmentPoint; i++) {
                switch (i) {
                    case 0:
                        code += "min " + tempTime + "," + animationRegisterCache.vertexLife + "," + lifeTimeRegister + ".x\n";
                        break;
                    case 1:
                        code += "sub " + accTime + "," + animationRegisterCache.vertexLife + "," + lifeTimeRegister + ".x\n";
                        code += "max " + tempTime + "," + accTime + "," + animationRegisterCache.vertexZeroConst + "\n";
                        code += "min " + tempTime + "," + tempTime + "," + lifeTimeRegister + ".y\n";
                        break;
                    case 2:
                        code += "sub " + accTime + "," + accTime + "," + lifeTimeRegister + ".y\n";
                        code += "max " + tempTime + "," + accTime + "," + animationRegisterCache.vertexZeroConst + "\n";
                        code += "min " + tempTime + "," + tempTime + "," + lifeTimeRegister + ".z\n";
                        break;
                    case 3:
                        code += "sub " + accTime + "," + accTime + "," + lifeTimeRegister + ".z\n";
                        code += "max " + tempTime + "," + accTime + "," + animationRegisterCache.vertexZeroConst + "\n";
                        code += "min " + tempTime + "," + tempTime + "," + lifeTimeRegister + ".w\n";
                        break;
                }
                if (this._iUsesMultiplier) {
                    code += "mul " + tempColor + "," + tempTime + "," + deltaMulValues[i] + "\n";
                    code += "add " + accMultiplierColor + "," + accMultiplierColor + "," + tempColor + "\n";
                }
                if (this._iUsesOffset) {
                    code += "mul " + tempColor + "," + tempTime + "," + deltaOffsetValues[i] + "\n";
                    code += "add " + animationRegisterCache.colorAddTarget + "," + animationRegisterCache.colorAddTarget + "," + tempColor + "\n";
                }
            }
            //for the last segment:
            if (this._iNumSegmentPoint == 0)
                tempTime = animationRegisterCache.vertexLife;
            else {
                switch (this._iNumSegmentPoint) {
                    case 1:
                        code += "sub " + accTime + "," + animationRegisterCache.vertexLife + "," + lifeTimeRegister + ".x\n";
                        break;
                    case 2:
                        code += "sub " + accTime + "," + accTime + "," + lifeTimeRegister + ".y\n";
                        break;
                    case 3:
                        code += "sub " + accTime + "," + accTime + "," + lifeTimeRegister + ".z\n";
                        break;
                    case 4:
                        code += "sub " + accTime + "," + accTime + "," + lifeTimeRegister + ".w\n";
                        break;
                }
                code += "max " + tempTime + "," + accTime + "," + animationRegisterCache.vertexZeroConst + "\n";
            }
            if (this._iUsesMultiplier) {
                code += "mul " + tempColor + "," + tempTime + "," + deltaMulValues[this._iNumSegmentPoint] + "\n";
                code += "add " + accMultiplierColor + "," + accMultiplierColor + "," + tempColor + "\n";
                code += "mul " + animationRegisterCache.colorMulTarget + "," + animationRegisterCache.colorMulTarget + "," + accMultiplierColor + "\n";
            }
            if (this._iUsesOffset) {
                code += "mul " + tempColor + "," + tempTime + "," + deltaOffsetValues[this._iNumSegmentPoint] + "\n";
                code += "add " + animationRegisterCache.colorAddTarget + "," + animationRegisterCache.colorAddTarget + "," + tempColor + "\n";
            }
        }
        return code;
    };
    return ParticleSegmentedColorNode;
})(ParticleNodeBase);
module.exports = ParticleSegmentedColorNode;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9hbmltYXRvcnMvbm9kZXMvcGFydGljbGVzZWdtZW50ZWRjb2xvcm5vZGUudHMiXSwibmFtZXMiOlsiUGFydGljbGVTZWdtZW50ZWRDb2xvck5vZGUiLCJQYXJ0aWNsZVNlZ21lbnRlZENvbG9yTm9kZS5jb25zdHJ1Y3RvciIsIlBhcnRpY2xlU2VnbWVudGVkQ29sb3JOb2RlLl9pUHJvY2Vzc0FuaW1hdGlvblNldHRpbmciLCJQYXJ0aWNsZVNlZ21lbnRlZENvbG9yTm9kZS5nZXRBR0FMVmVydGV4Q29kZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBTUEsSUFBTyxxQkFBcUIsV0FBYSxnRUFBZ0UsQ0FBQyxDQUFDO0FBRTNHLElBQU8sb0JBQW9CLFdBQWMsc0RBQXNELENBQUMsQ0FBQztBQUdqRyxJQUFPLHNCQUFzQixXQUFhLDZEQUE2RCxDQUFDLENBQUM7QUFDekcsSUFBTyxnQkFBZ0IsV0FBZSx3REFBd0QsQ0FBQyxDQUFDO0FBQ2hHLElBQU8sMkJBQTJCLFdBQVksb0VBQW9FLENBQUMsQ0FBQztBQUVwSCxBQUdBOztHQURHO0lBQ0csMEJBQTBCO0lBQVNBLFVBQW5DQSwwQkFBMEJBLFVBQXlCQTtJQWV4REEsU0FmS0EsMEJBQTBCQSxDQWVuQkEsY0FBc0JBLEVBQUVBLFVBQWtCQSxFQUFFQSxlQUFlQSxDQUFRQSxPQUFEQSxBQUFRQSxFQUFFQSxVQUF5QkEsRUFBRUEsUUFBdUJBLEVBQUVBLGFBQXNDQTtRQUVqTEMsQUFDQUEsNkVBRDZFQTtRQUM3RUEsa0JBQU1BLHdCQUF3QkEsRUFBRUEsc0JBQXNCQSxDQUFDQSxNQUFNQSxFQUFFQSxDQUFDQSxFQUFFQSxvQkFBb0JBLENBQUNBLGNBQWNBLENBQUNBLENBQUNBO1FBRXZHQSxJQUFJQSxDQUFDQSxZQUFZQSxHQUFHQSwyQkFBMkJBLENBQUNBO1FBRWhEQSxFQUFFQSxDQUFDQSxDQUFDQSxlQUFlQSxHQUFHQSxDQUFDQSxDQUFDQTtZQUN2QkEsTUFBS0EsQ0FBQ0Es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Q0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsaUJBQWlCQSxDQUFDQSxDQUFDQSxDQUFDQTtvQkFDaENBLEtBQUtBLENBQUNBO3dCQUNMQSxJQUFJQSxJQUFJQSxNQUFNQSxHQUFHQSxPQUFPQSxHQUFHQSxHQUFHQSxHQUFHQSxzQkFBc0JBLENBQUNBLFVBQVVBLEdBQUdBLEdBQUdBLEdBQUdBLGdCQUFnQkEsR0FBR0EsTUFBTUEsQ0FBQ0E7d0JBQ3JHQSxLQUFLQSxDQUFDQTtvQkFDUEEsS0FBS0EsQ0FBQ0E7d0JBQ0xBLElBQUlBLElBQUlBLE1BQU1BLEdBQUdBLE9BQU9BLEdBQUdBLEdBQUdBLEdBQUdBLE9BQU9BLEdBQUdBLEdBQUdBLEdBQUdBLGdCQUFnQkEsR0FBR0EsTUFBTUEsQ0FBQ0E7d0JBQzNFQSxLQUFLQSxDQUFDQTtvQkFDUEEsS0FBS0EsQ0FBQ0E7d0JBQ0xBLElBQUlBLElBQUlBLE1BQU1BLEdBQUdBLE9BQU9BLEdBQUdBLEdBQUdBLEdBQUdBLE9BQU9BLEdBQUdBLEdBQUdBLEdBQUdBLGdCQUFnQkEsR0FBR0EsTUFBTUEsQ0FBQ0E7d0JBQzNFQSxLQUFLQSxDQUFDQTtvQkFDUEEsS0FBS0EsQ0FBQ0E7d0JBQ0xBLElBQUlBLElBQUlBLE1BQU1BLEdBQUdBLE9BQU9BLEdBQUdBLEdBQUdBLEdBQUdBLE9BQU9BLEdBQUdBLEdBQUdBLEdBQUdBLGdCQUFnQkEsR0FBR0EsTUFBTUEsQ0FBQ0E7d0JBQzNFQSxLQUFLQSxDQUFDQTtnQkFDUkEsQ0FBQ0E7Z0JBQ0RBLElBQUlBLElBQUlBLE1BQU1BLEdBQUdBLFFBQVFBLEdBQUdBLEdBQUdBLEdBQUdBLE9BQU9BLEdBQUdBLEdBQUdBLEdBQUdBLHNCQUFzQkEsQ0FBQ0EsZUFBZUEsR0FBR0EsSUFBSUEsQ0FBQ0E7WUFDakdBLENBQUNBO1lBQ0RBLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLGdCQUFnQkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQzNCQSxJQUFJQSxJQUFJQSxNQUFNQSxHQUFHQSxTQUFTQSxHQUFHQSxHQUFHQSxHQUFHQSxRQUFRQSxHQUFHQSxHQUFHQSxHQUFHQSxjQUFjQSxDQUFDQSxJQUFJQSxDQUFDQSxpQkFBaUJBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBO2dCQUNsR0EsSUFBSUEsSUFBSUEsTUFBTUEsR0FBR0Esa0JBQWtCQSxHQUFHQSxHQUFHQSxHQUFHQSxrQkFBa0JBLEdBQUdBLEdBQUdBLEdBQUdBLFNBQVNBLEdBQUdBLElBQUlBLENBQUNBO2dCQUN4RkEsSUFBSUEsSUFBSUEsTUFBTUEsR0FBR0Esc0JBQXNCQSxDQUFDQSxjQUFjQSxHQUFHQSxHQUFHQSxHQUFHQSxzQkFBc0JBLENBQUNBLGNBQWNBLEdBQUdBLEdBQUdBLEdBQUdBLGtCQUFrQkEsR0FBR0EsSUFBSUEsQ0FBQ0E7WUFDeElBLENBQUNBO1lBQ0RBLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLFlBQVlBLENBQUNBLENBQUNBLENBQUNBO2dCQUN2QkEsSUFBSUEsSUFBSUEsTUFBTUEsR0FBR0EsU0FBU0EsR0FBR0EsR0FBR0EsR0FBR0EsUUFBUUEsR0FBR0EsR0FBR0EsR0FBR0EsaUJBQWlCQSxDQUFDQSxJQUFJQSxDQUFDQSxpQkFBaUJBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBO2dCQUNyR0EsSUFBSUEsSUFBSUEsTUFBTUEsR0FBR0Esc0JBQXNCQSxDQUFDQSxjQUFjQSxHQUFHQSxHQUFHQSxHQUFHQSxzQkFBc0JBLENBQUNBLGNBQWNBLEdBQUdBLEdBQUdBLEdBQUdBLFNBQVNBLEdBQUdBLElBQUlBLENBQUNBO1lBQy9IQSxDQUFDQTtRQUVGQSxDQUFDQTtRQUNEQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQTtJQUNiQSxDQUFDQTtJQUVGSCxpQ0FBQ0E7QUFBREEsQ0FyS0EsQUFxS0NBLEVBckt3QyxnQkFBZ0IsRUFxS3hEO0FBRUQsQUFBb0MsaUJBQTNCLDBCQUEwQixDQUFDIiwiZmlsZSI6ImFuaW1hdG9ycy9ub2Rlcy9QYXJ0aWNsZVNlZ21lbnRlZENvbG9yTm9kZS5qcyIsInNvdXJjZVJvb3QiOiIuLi8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQ29sb3JUcmFuc2Zvcm1cdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2dlb20vQ29sb3JUcmFuc2Zvcm1cIik7XG5pbXBvcnQgVmVjdG9yM0RcdFx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9nZW9tL1ZlY3RvcjNEXCIpO1xuXG5pbXBvcnQgQW5pbWF0b3JCYXNlXHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2FuaW1hdG9ycy9BbmltYXRvckJhc2VcIik7XG5pbXBvcnQgQW5pbWF0aW9uUmVnaXN0ZXJDYWNoZVx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9hbmltYXRvcnMvZGF0YS9BbmltYXRpb25SZWdpc3RlckNhY2hlXCIpO1xuaW1wb3J0IFNoYWRlck9iamVjdEJhc2VcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL21hdGVyaWFscy9jb21waWxhdGlvbi9TaGFkZXJPYmplY3RCYXNlXCIpO1xuaW1wb3J0IFNoYWRlclJlZ2lzdGVyRWxlbWVudFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9tYXRlcmlhbHMvY29tcGlsYXRpb24vU2hhZGVyUmVnaXN0ZXJFbGVtZW50XCIpO1xuXG5pbXBvcnQgUGFydGljbGVBbmltYXRpb25TZXRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9hbmltYXRvcnMvUGFydGljbGVBbmltYXRpb25TZXRcIik7XG5pbXBvcnQgQ29sb3JTZWdtZW50UG9pbnRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9hbmltYXRvcnMvZGF0YS9Db2xvclNlZ21lbnRQb2ludFwiKTtcbmltcG9ydCBQYXJ0aWNsZVByb3BlcnRpZXNcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9hbmltYXRvcnMvZGF0YS9QYXJ0aWNsZVByb3BlcnRpZXNcIik7XG5pbXBvcnQgUGFydGljbGVQcm9wZXJ0aWVzTW9kZVx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9hbmltYXRvcnMvZGF0YS9QYXJ0aWNsZVByb3BlcnRpZXNNb2RlXCIpO1xuaW1wb3J0IFBhcnRpY2xlTm9kZUJhc2VcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2FuaW1hdG9ycy9ub2Rlcy9QYXJ0aWNsZU5vZGVCYXNlXCIpO1xuaW1wb3J0IFBhcnRpY2xlU2VnbWVudGVkQ29sb3JTdGF0ZVx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvYW5pbWF0b3JzL3N0YXRlcy9QYXJ0aWNsZVNlZ21lbnRlZENvbG9yU3RhdGVcIik7XG5cbi8qKlxuICpcbiAqL1xuY2xhc3MgUGFydGljbGVTZWdtZW50ZWRDb2xvck5vZGUgZXh0ZW5kcyBQYXJ0aWNsZU5vZGVCYXNlXG57XG5cdC8qKiBAcHJpdmF0ZSAqL1xuXHRwdWJsaWMgX2lVc2VzTXVsdGlwbGllcjpib29sZWFuO1xuXHQvKiogQHByaXZhdGUgKi9cblx0cHVibGljIF9pVXNlc09mZnNldDpib29sZWFuO1xuXHQvKiogQHByaXZhdGUgKi9cblx0cHVibGljIF9pU3RhcnRDb2xvcjpDb2xvclRyYW5zZm9ybTtcblx0LyoqIEBwcml2YXRlICovXG5cdHB1YmxpYyBfaUVuZENvbG9yOkNvbG9yVHJhbnNmb3JtO1xuXHQvKiogQHByaXZhdGUgKi9cblx0cHVibGljIF9pTnVtU2VnbWVudFBvaW50Om51bWJlciAvKmludCovO1xuXHQvKiogQHByaXZhdGUgKi9cblx0cHVibGljIF9pU2VnbWVudFBvaW50czpBcnJheTxDb2xvclNlZ21lbnRQb2ludD47XG5cblx0Y29uc3RydWN0b3IodXNlc011bHRpcGxpZXI6Ym9vbGVhbiwgdXNlc09mZnNldDpib29sZWFuLCBudW1TZWdtZW50UG9pbnQ6bnVtYmVyIC8qaW50Ki8sIHN0YXJ0Q29sb3I6Q29sb3JUcmFuc2Zvcm0sIGVuZENvbG9yOkNvbG9yVHJhbnNmb3JtLCBzZWdtZW50UG9pbnRzOkFycmF5PENvbG9yU2VnbWVudFBvaW50Pilcblx0e1xuXHRcdC8vYmVjYXVzZSBvZiB0aGUgc3RhZ2UzZCByZWdpc3RlciBsaW1pdGF0aW9uLCBpdCBvbmx5IHN1cHBvcnQgdGhlIGdsb2JhbCBtb2RlXG5cdFx0c3VwZXIoXCJQYXJ0aWNsZVNlZ21lbnRlZENvbG9yXCIsIFBhcnRpY2xlUHJvcGVydGllc01vZGUuR0xPQkFMLCAwLCBQYXJ0aWNsZUFuaW1hdGlvblNldC5DT0xPUl9QUklPUklUWSk7XG5cblx0XHR0aGlzLl9wU3RhdGVDbGFzcyA9IFBhcnRpY2xlU2VnbWVudGVkQ29sb3JTdGF0ZTtcblxuXHRcdGlmIChudW1TZWdtZW50UG9pbnQgPiA0KVxuXHRcdFx0dGhyb3cobmV3IEVycm9yKFwidGhlIG51bVNlZ21lbnRQb2ludCBtdXN0IGJlIGxlc3Mgb3IgZXF1YWwgNFwiKSk7XG5cdFx0dGhpcy5faVVzZXNNdWx0aXBsaWVyID0gdXNlc011bHRpcGxpZXI7XG5cdFx0dGhpcy5faVVzZXNPZmZzZXQgPSB1c2VzT2Zmc2V0O1xuXHRcdHRoaXMuX2lOdW1TZWdtZW50UG9pbnQgPSBudW1TZWdtZW50UG9pbnQ7XG5cdFx0dGhpcy5faVN0YXJ0Q29sb3IgPSBzdGFydENvbG9yO1xuXHRcdHRoaXMuX2lFbmRDb2xvciA9IGVuZENvbG9yO1xuXHRcdHRoaXMuX2lTZWdtZW50UG9pbnRzID0gc2VnbWVudFBvaW50cztcblx0fVxuXG5cdC8qKlxuXHQgKiBAaW5oZXJpdERvY1xuXHQgKi9cblx0cHVibGljIF9pUHJvY2Vzc0FuaW1hdGlvblNldHRpbmcocGFydGljbGVBbmltYXRpb25TZXQ6UGFydGljbGVBbmltYXRpb25TZXQpXG5cdHtcblx0XHRpZiAodGhpcy5faVVzZXNNdWx0aXBsaWVyKVxuXHRcdFx0cGFydGljbGVBbmltYXRpb25TZXQuaGFzQ29sb3JNdWxOb2RlID0gdHJ1ZTtcblx0XHRpZiAodGhpcy5faVVzZXNPZmZzZXQpXG5cdFx0XHRwYXJ0aWNsZUFuaW1hdGlvblNldC5oYXNDb2xvckFkZE5vZGUgPSB0cnVlO1xuXHR9XG5cblx0LyoqXG5cdCAqIEBpbmhlcml0RG9jXG5cdCAqL1xuXHRwdWJsaWMgZ2V0QUdBTFZlcnRleENvZGUoc2hhZGVyT2JqZWN0OlNoYWRlck9iamVjdEJhc2UsIGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGU6QW5pbWF0aW9uUmVnaXN0ZXJDYWNoZSk6c3RyaW5nXG5cdHtcblx0XHR2YXIgY29kZTpzdHJpbmcgPSBcIlwiO1xuXHRcdGlmIChhbmltYXRpb25SZWdpc3RlckNhY2hlLm5lZWRGcmFnbWVudEFuaW1hdGlvbikge1xuXHRcdFx0dmFyIGFjY011bHRpcGxpZXJDb2xvcjpTaGFkZXJSZWdpc3RlckVsZW1lbnQ7XG5cdFx0XHQvL3ZhciBhY2NPZmZzZXRDb2xvcjpTaGFkZXJSZWdpc3RlckVsZW1lbnQ7XG5cdFx0XHRpZiAodGhpcy5faVVzZXNNdWx0aXBsaWVyKSB7XG5cdFx0XHRcdGFjY011bHRpcGxpZXJDb2xvciA9IGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGUuZ2V0RnJlZVZlcnRleFZlY3RvclRlbXAoKTtcblx0XHRcdFx0YW5pbWF0aW9uUmVnaXN0ZXJDYWNoZS5hZGRWZXJ0ZXhUZW1wVXNhZ2VzKGFjY011bHRpcGxpZXJDb2xvciwgMSk7XG5cdFx0XHR9XG5cblx0XHRcdHZhciB0ZW1wQ29sb3I6U2hhZGVyUmVnaXN0ZXJFbGVtZW50ID0gYW5pbWF0aW9uUmVnaXN0ZXJDYWNoZS5nZXRGcmVlVmVydGV4VmVjdG9yVGVtcCgpO1xuXHRcdFx0YW5pbWF0aW9uUmVnaXN0ZXJDYWNoZS5hZGRWZXJ0ZXhUZW1wVXNhZ2VzKHRlbXBDb2xvciwgMSk7XG5cblx0XHRcdHZhciB0ZW1wOlNoYWRlclJlZ2lzdGVyRWxlbWVudCA9IGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGUuZ2V0RnJlZVZlcnRleFZlY3RvclRlbXAoKTtcblx0XHRcdHZhciBhY2NUaW1lOlNoYWRlclJlZ2lzdGVyRWxlbWVudCA9IG5ldyBTaGFkZXJSZWdpc3RlckVsZW1lbnQodGVtcC5yZWdOYW1lLCB0ZW1wLmluZGV4LCAwKTtcblx0XHRcdHZhciB0ZW1wVGltZTpTaGFkZXJSZWdpc3RlckVsZW1lbnQgPSBuZXcgU2hhZGVyUmVnaXN0ZXJFbGVtZW50KHRlbXAucmVnTmFtZSwgdGVtcC5pbmRleCwgMSk7XG5cblx0XHRcdGlmICh0aGlzLl9pVXNlc011bHRpcGxpZXIpXG5cdFx0XHRcdGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGUucmVtb3ZlVmVydGV4VGVtcFVzYWdlKGFjY011bHRpcGxpZXJDb2xvcik7XG5cblx0XHRcdGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGUucmVtb3ZlVmVydGV4VGVtcFVzYWdlKHRlbXBDb2xvcik7XG5cblx0XHRcdC8vZm9yIHNhdmluZyBhbGwgdGhlIGxpZmUgdmFsdWVzIChhdCBtb3N0IDQpXG5cdFx0XHR2YXIgbGlmZVRpbWVSZWdpc3RlcjpTaGFkZXJSZWdpc3RlckVsZW1lbnQgPSBhbmltYXRpb25SZWdpc3RlckNhY2hlLmdldEZyZWVWZXJ0ZXhDb25zdGFudCgpO1xuXHRcdFx0YW5pbWF0aW9uUmVnaXN0ZXJDYWNoZS5zZXRSZWdpc3RlckluZGV4KHRoaXMsIFBhcnRpY2xlU2VnbWVudGVkQ29sb3JTdGF0ZS5USU1FX0RBVEFfSU5ERVgsIGxpZmVUaW1lUmVnaXN0ZXIuaW5kZXgpO1xuXG5cdFx0XHR2YXIgaTpudW1iZXIgLyppbnQqLztcblxuXHRcdFx0dmFyIHN0YXJ0TXVsVmFsdWU6U2hhZGVyUmVnaXN0ZXJFbGVtZW50O1xuXHRcdFx0dmFyIGRlbHRhTXVsVmFsdWVzOkFycmF5PFNoYWRlclJlZ2lzdGVyRWxlbWVudD47XG5cdFx0XHRpZiAodGhpcy5faVVzZXNNdWx0aXBsaWVyKSB7XG5cdFx0XHRcdHN0YXJ0TXVsVmFsdWUgPSBhbmltYXRpb25SZWdpc3RlckNhY2hlLmdldEZyZWVWZXJ0ZXhDb25zdGFudCgpO1xuXHRcdFx0XHRhbmltYXRpb25SZWdpc3RlckNhY2hlLnNldFJlZ2lzdGVySW5kZXgodGhpcywgUGFydGljbGVTZWdtZW50ZWRDb2xvclN0YXRlLlNUQVJUX01VTFRJUExJRVJfSU5ERVgsIHN0YXJ0TXVsVmFsdWUuaW5kZXgpO1xuXHRcdFx0XHRkZWx0YU11bFZhbHVlcyA9IG5ldyBBcnJheTxTaGFkZXJSZWdpc3RlckVsZW1lbnQ+KCk7XG5cdFx0XHRcdGZvciAoaSA9IDA7IGkgPCB0aGlzLl9pTnVtU2VnbWVudFBvaW50ICsgMTsgaSsrKVxuXHRcdFx0XHRcdGRlbHRhTXVsVmFsdWVzLnB1c2goYW5pbWF0aW9uUmVnaXN0ZXJDYWNoZS5nZXRGcmVlVmVydGV4Q29uc3RhbnQoKSk7XG5cdFx0XHR9XG5cblx0XHRcdHZhciBzdGFydE9mZnNldFZhbHVlOlNoYWRlclJlZ2lzdGVyRWxlbWVudDtcblx0XHRcdHZhciBkZWx0YU9mZnNldFZhbHVlczpBcnJheTxTaGFkZXJSZWdpc3RlckVsZW1lbnQ+O1xuXHRcdFx0aWYgKHRoaXMuX2lVc2VzT2Zmc2V0KSB7XG5cdFx0XHRcdHN0YXJ0T2Zmc2V0VmFsdWUgPSBhbmltYXRpb25SZWdpc3RlckNhY2hlLmdldEZyZWVWZXJ0ZXhDb25zdGFudCgpO1xuXHRcdFx0XHRhbmltYXRpb25SZWdpc3RlckNhY2hlLnNldFJlZ2lzdGVySW5kZXgodGhpcywgUGFydGljbGVTZWdtZW50ZWRDb2xvclN0YXRlLlNUQVJUX09GRlNFVF9JTkRFWCwgc3RhcnRPZmZzZXRWYWx1ZS5pbmRleCk7XG5cdFx0XHRcdGRlbHRhT2Zmc2V0VmFsdWVzID0gbmV3IEFycmF5PFNoYWRlclJlZ2lzdGVyRWxlbWVudD4oKTtcblx0XHRcdFx0Zm9yIChpID0gMDsgaSA8IHRoaXMuX2lOdW1TZWdtZW50UG9pbnQgKyAxOyBpKyspXG5cdFx0XHRcdFx0ZGVsdGFPZmZzZXRWYWx1ZXMucHVzaChhbmltYXRpb25SZWdpc3RlckNhY2hlLmdldEZyZWVWZXJ0ZXhDb25zdGFudCgpKTtcblx0XHRcdH1cblxuXHRcdFx0aWYgKHRoaXMuX2lVc2VzTXVsdGlwbGllcilcblx0XHRcdFx0Y29kZSArPSBcIm1vdiBcIiArIGFjY011bHRpcGxpZXJDb2xvciArIFwiLFwiICsgc3RhcnRNdWxWYWx1ZSArIFwiXFxuXCI7XG5cdFx0XHRpZiAodGhpcy5faVVzZXNPZmZzZXQpXG5cdFx0XHRcdGNvZGUgKz0gXCJhZGQgXCIgKyBhbmltYXRpb25SZWdpc3RlckNhY2hlLmNvbG9yQWRkVGFyZ2V0ICsgXCIsXCIgKyBhbmltYXRpb25SZWdpc3RlckNhY2hlLmNvbG9yQWRkVGFyZ2V0ICsgXCIsXCIgKyBzdGFydE9mZnNldFZhbHVlICsgXCJcXG5cIjtcblxuXHRcdFx0Zm9yIChpID0gMDsgaSA8IHRoaXMuX2lOdW1TZWdtZW50UG9pbnQ7IGkrKykge1xuXHRcdFx0XHRzd2l0Y2ggKGkpIHtcblx0XHRcdFx0XHRjYXNlIDA6XG5cdFx0XHRcdFx0XHRjb2RlICs9IFwibWluIFwiICsgdGVtcFRpbWUgKyBcIixcIiArIGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGUudmVydGV4TGlmZSArIFwiLFwiICsgbGlmZVRpbWVSZWdpc3RlciArIFwiLnhcXG5cIjtcblx0XHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRcdGNhc2UgMTpcblx0XHRcdFx0XHRcdGNvZGUgKz0gXCJzdWIgXCIgKyBhY2NUaW1lICsgXCIsXCIgKyBhbmltYXRpb25SZWdpc3RlckNhY2hlLnZlcnRleExpZmUgKyBcIixcIiArIGxpZmVUaW1lUmVnaXN0ZXIgKyBcIi54XFxuXCI7XG5cdFx0XHRcdFx0XHRjb2RlICs9IFwibWF4IFwiICsgdGVtcFRpbWUgKyBcIixcIiArIGFjY1RpbWUgKyBcIixcIiArIGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGUudmVydGV4WmVyb0NvbnN0ICsgXCJcXG5cIjtcblx0XHRcdFx0XHRcdGNvZGUgKz0gXCJtaW4gXCIgKyB0ZW1wVGltZSArIFwiLFwiICsgdGVtcFRpbWUgKyBcIixcIiArIGxpZmVUaW1lUmVnaXN0ZXIgKyBcIi55XFxuXCI7XG5cdFx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0XHRjYXNlIDI6XG5cdFx0XHRcdFx0XHRjb2RlICs9IFwic3ViIFwiICsgYWNjVGltZSArIFwiLFwiICsgYWNjVGltZSArIFwiLFwiICsgbGlmZVRpbWVSZWdpc3RlciArIFwiLnlcXG5cIjtcblx0XHRcdFx0XHRcdGNvZGUgKz0gXCJtYXggXCIgKyB0ZW1wVGltZSArIFwiLFwiICsgYWNjVGltZSArIFwiLFwiICsgYW5pbWF0aW9uUmVnaXN0ZXJDYWNoZS52ZXJ0ZXhaZXJvQ29uc3QgKyBcIlxcblwiO1xuXHRcdFx0XHRcdFx0Y29kZSArPSBcIm1pbiBcIiArIHRlbXBUaW1lICsgXCIsXCIgKyB0ZW1wVGltZSArIFwiLFwiICsgbGlmZVRpbWVSZWdpc3RlciArIFwiLnpcXG5cIjtcblx0XHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRcdGNhc2UgMzpcblx0XHRcdFx0XHRcdGNvZGUgKz0gXCJzdWIgXCIgKyBhY2NUaW1lICsgXCIsXCIgKyBhY2NUaW1lICsgXCIsXCIgKyBsaWZlVGltZVJlZ2lzdGVyICsgXCIuelxcblwiO1xuXHRcdFx0XHRcdFx0Y29kZSArPSBcIm1heCBcIiArIHRlbXBUaW1lICsgXCIsXCIgKyBhY2NUaW1lICsgXCIsXCIgKyBhbmltYXRpb25SZWdpc3RlckNhY2hlLnZlcnRleFplcm9Db25zdCArIFwiXFxuXCI7XG5cdFx0XHRcdFx0XHRjb2RlICs9IFwibWluIFwiICsgdGVtcFRpbWUgKyBcIixcIiArIHRlbXBUaW1lICsgXCIsXCIgKyBsaWZlVGltZVJlZ2lzdGVyICsgXCIud1xcblwiO1xuXHRcdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdH1cblx0XHRcdFx0aWYgKHRoaXMuX2lVc2VzTXVsdGlwbGllcikge1xuXHRcdFx0XHRcdGNvZGUgKz0gXCJtdWwgXCIgKyB0ZW1wQ29sb3IgKyBcIixcIiArIHRlbXBUaW1lICsgXCIsXCIgKyBkZWx0YU11bFZhbHVlc1tpXSArIFwiXFxuXCI7XG5cdFx0XHRcdFx0Y29kZSArPSBcImFkZCBcIiArIGFjY011bHRpcGxpZXJDb2xvciArIFwiLFwiICsgYWNjTXVsdGlwbGllckNvbG9yICsgXCIsXCIgKyB0ZW1wQ29sb3IgKyBcIlxcblwiO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGlmICh0aGlzLl9pVXNlc09mZnNldCkge1xuXHRcdFx0XHRcdGNvZGUgKz0gXCJtdWwgXCIgKyB0ZW1wQ29sb3IgKyBcIixcIiArIHRlbXBUaW1lICsgXCIsXCIgKyBkZWx0YU9mZnNldFZhbHVlc1tpXSArIFwiXFxuXCI7XG5cdFx0XHRcdFx0Y29kZSArPSBcImFkZCBcIiArIGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGUuY29sb3JBZGRUYXJnZXQgKyBcIixcIiArIGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGUuY29sb3JBZGRUYXJnZXQgKyBcIixcIiArIHRlbXBDb2xvciArIFwiXFxuXCI7XG5cdFx0XHRcdH1cblx0XHRcdH1cblxuXHRcdFx0Ly9mb3IgdGhlIGxhc3Qgc2VnbWVudDpcblx0XHRcdGlmICh0aGlzLl9pTnVtU2VnbWVudFBvaW50ID09IDApXG5cdFx0XHRcdHRlbXBUaW1lID0gYW5pbWF0aW9uUmVnaXN0ZXJDYWNoZS52ZXJ0ZXhMaWZlO1xuXHRcdFx0ZWxzZSB7XG5cdFx0XHRcdHN3aXRjaCAodGhpcy5faU51bVNlZ21lbnRQb2ludCkge1xuXHRcdFx0XHRcdGNhc2UgMTpcblx0XHRcdFx0XHRcdGNvZGUgKz0gXCJzdWIgXCIgKyBhY2NUaW1lICsgXCIsXCIgKyBhbmltYXRpb25SZWdpc3RlckNhY2hlLnZlcnRleExpZmUgKyBcIixcIiArIGxpZmVUaW1lUmVnaXN0ZXIgKyBcIi54XFxuXCI7XG5cdFx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0XHRjYXNlIDI6XG5cdFx0XHRcdFx0XHRjb2RlICs9IFwic3ViIFwiICsgYWNjVGltZSArIFwiLFwiICsgYWNjVGltZSArIFwiLFwiICsgbGlmZVRpbWVSZWdpc3RlciArIFwiLnlcXG5cIjtcblx0XHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRcdGNhc2UgMzpcblx0XHRcdFx0XHRcdGNvZGUgKz0gXCJzdWIgXCIgKyBhY2NUaW1lICsgXCIsXCIgKyBhY2NUaW1lICsgXCIsXCIgKyBsaWZlVGltZVJlZ2lzdGVyICsgXCIuelxcblwiO1xuXHRcdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdFx0Y2FzZSA0OlxuXHRcdFx0XHRcdFx0Y29kZSArPSBcInN1YiBcIiArIGFjY1RpbWUgKyBcIixcIiArIGFjY1RpbWUgKyBcIixcIiArIGxpZmVUaW1lUmVnaXN0ZXIgKyBcIi53XFxuXCI7XG5cdFx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0fVxuXHRcdFx0XHRjb2RlICs9IFwibWF4IFwiICsgdGVtcFRpbWUgKyBcIixcIiArIGFjY1RpbWUgKyBcIixcIiArIGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGUudmVydGV4WmVyb0NvbnN0ICsgXCJcXG5cIjtcblx0XHRcdH1cblx0XHRcdGlmICh0aGlzLl9pVXNlc011bHRpcGxpZXIpIHtcblx0XHRcdFx0Y29kZSArPSBcIm11bCBcIiArIHRlbXBDb2xvciArIFwiLFwiICsgdGVtcFRpbWUgKyBcIixcIiArIGRlbHRhTXVsVmFsdWVzW3RoaXMuX2lOdW1TZWdtZW50UG9pbnRdICsgXCJcXG5cIjtcblx0XHRcdFx0Y29kZSArPSBcImFkZCBcIiArIGFjY011bHRpcGxpZXJDb2xvciArIFwiLFwiICsgYWNjTXVsdGlwbGllckNvbG9yICsgXCIsXCIgKyB0ZW1wQ29sb3IgKyBcIlxcblwiO1xuXHRcdFx0XHRjb2RlICs9IFwibXVsIFwiICsgYW5pbWF0aW9uUmVnaXN0ZXJDYWNoZS5jb2xvck11bFRhcmdldCArIFwiLFwiICsgYW5pbWF0aW9uUmVnaXN0ZXJDYWNoZS5jb2xvck11bFRhcmdldCArIFwiLFwiICsgYWNjTXVsdGlwbGllckNvbG9yICsgXCJcXG5cIjtcblx0XHRcdH1cblx0XHRcdGlmICh0aGlzLl9pVXNlc09mZnNldCkge1xuXHRcdFx0XHRjb2RlICs9IFwibXVsIFwiICsgdGVtcENvbG9yICsgXCIsXCIgKyB0ZW1wVGltZSArIFwiLFwiICsgZGVsdGFPZmZzZXRWYWx1ZXNbdGhpcy5faU51bVNlZ21lbnRQb2ludF0gKyBcIlxcblwiO1xuXHRcdFx0XHRjb2RlICs9IFwiYWRkIFwiICsgYW5pbWF0aW9uUmVnaXN0ZXJDYWNoZS5jb2xvckFkZFRhcmdldCArIFwiLFwiICsgYW5pbWF0aW9uUmVnaXN0ZXJDYWNoZS5jb2xvckFkZFRhcmdldCArIFwiLFwiICsgdGVtcENvbG9yICsgXCJcXG5cIjtcblx0XHRcdH1cblxuXHRcdH1cblx0XHRyZXR1cm4gY29kZTtcblx0fVxuXG59XG5cbmV4cG9ydCA9IFBhcnRpY2xlU2VnbWVudGVkQ29sb3JOb2RlOyJdfQ==