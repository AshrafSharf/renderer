var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var ShaderRegisterElement = require("awayjs-stagegl/lib/materials/compilation/ShaderRegisterElement");
var ParticleAnimationSet = require("awayjs-renderergl/lib/animators/ParticleAnimationSet");
var ParticlePropertiesMode = require("awayjs-renderergl/lib/animators/data/ParticlePropertiesMode");
var ParticleNodeBase = require("awayjs-renderergl/lib/animators/nodes/ParticleNodeBase");
var ParticleSegmentedColorState = require("awayjs-renderergl/lib/animators/states/ParticleSegmentedColorState");
/**
 *
 */
var ParticleSegmentedColorNode = (function (_super) {
    __extends(ParticleSegmentedColorNode, _super);
    function ParticleSegmentedColorNode(usesMultiplier, usesOffset, numSegmentPoint /*int*/, startColor, endColor, segmentPoints) {
        //because of the stage3d register limitation, it only support the global mode
        _super.call(this, "ParticleSegmentedColor", ParticlePropertiesMode.GLOBAL, 0, ParticleAnimationSet.COLOR_PRIORITY);
        this._pStateClass = ParticleSegmentedColorState;
        if (numSegmentPoint > 4)
            throw (new Error("the numSegmentPoint must be less or equal 4"));
        this._iUsesMultiplier = usesMultiplier;
        this._iUsesOffset = usesOffset;
        this._iNumSegmentPoint = numSegmentPoint;
        this._iStartColor = startColor;
        this._iEndColor = endColor;
        this._iSegmentPoints = segmentPoints;
    }
    /**
     * @inheritDoc
     */
    ParticleSegmentedColorNode.prototype._iProcessAnimationSetting = function (particleAnimationSet) {
        if (this._iUsesMultiplier)
            particleAnimationSet.hasColorMulNode = true;
        if (this._iUsesOffset)
            particleAnimationSet.hasColorAddNode = true;
    };
    /**
     * @inheritDoc
     */
    ParticleSegmentedColorNode.prototype.getAGALVertexCode = function (shaderObject, animationRegisterCache) {
        var code = "";
        if (animationRegisterCache.needFragmentAnimation) {
            var accMultiplierColor;
            //var accOffsetColor:ShaderRegisterElement;
            if (this._iUsesMultiplier) {
                accMultiplierColor = animationRegisterCache.getFreeVertexVectorTemp();
                animationRegisterCache.addVertexTempUsages(accMultiplierColor, 1);
            }
            var tempColor = animationRegisterCache.getFreeVertexVectorTemp();
            animationRegisterCache.addVertexTempUsages(tempColor, 1);
            var temp = animationRegisterCache.getFreeVertexVectorTemp();
            var accTime = new ShaderRegisterElement(temp.regName, temp.index, 0);
            var tempTime = new ShaderRegisterElement(temp.regName, temp.index, 1);
            if (this._iUsesMultiplier)
                animationRegisterCache.removeVertexTempUsage(accMultiplierColor);
            animationRegisterCache.removeVertexTempUsage(tempColor);
            //for saving all the life values (at most 4)
            var lifeTimeRegister = animationRegisterCache.getFreeVertexConstant();
            animationRegisterCache.setRegisterIndex(this, ParticleSegmentedColorState.TIME_DATA_INDEX, lifeTimeRegister.index);
            var i /*int*/;
            var startMulValue;
            var deltaMulValues;
            if (this._iUsesMultiplier) {
                startMulValue = animationRegisterCache.getFreeVertexConstant();
                animationRegisterCache.setRegisterIndex(this, ParticleSegmentedColorState.START_MULTIPLIER_INDEX, startMulValue.index);
                deltaMulValues = new Array();
                for (i = 0; i < this._iNumSegmentPoint + 1; i++)
                    deltaMulValues.push(animationRegisterCache.getFreeVertexConstant());
            }
            var startOffsetValue;
            var deltaOffsetValues;
            if (this._iUsesOffset) {
                startOffsetValue = animationRegisterCache.getFreeVertexConstant();
                animationRegisterCache.setRegisterIndex(this, ParticleSegmentedColorState.START_OFFSET_INDEX, startOffsetValue.index);
                deltaOffsetValues = new Array();
                for (i = 0; i < this._iNumSegmentPoint + 1; i++)
                    deltaOffsetValues.push(animationRegisterCache.getFreeVertexConstant());
            }
            if (this._iUsesMultiplier)
                code += "mov " + accMultiplierColor + "," + startMulValue + "\n";
            if (this._iUsesOffset)
                code += "add " + animationRegisterCache.colorAddTarget + "," + animationRegisterCache.colorAddTarget + "," + startOffsetValue + "\n";
            for (i = 0; i < this._iNumSegmentPoint; i++) {
                switch (i) {
                    case 0:
                        code += "min " + tempTime + "," + animationRegisterCache.vertexLife + "," + lifeTimeRegister + ".x\n";
                        break;
                    case 1:
                        code += "sub " + accTime + "," + animationRegisterCache.vertexLife + "," + lifeTimeRegister + ".x\n";
                        code += "max " + tempTime + "," + accTime + "," + animationRegisterCache.vertexZeroConst + "\n";
                        code += "min " + tempTime + "," + tempTime + "," + lifeTimeRegister + ".y\n";
                        break;
                    case 2:
                        code += "sub " + accTime + "," + accTime + "," + lifeTimeRegister + ".y\n";
                        code += "max " + tempTime + "," + accTime + "," + animationRegisterCache.vertexZeroConst + "\n";
                        code += "min " + tempTime + "," + tempTime + "," + lifeTimeRegister + ".z\n";
                        break;
                    case 3:
                        code += "sub " + accTime + "," + accTime + "," + lifeTimeRegister + ".z\n";
                        code += "max " + tempTime + "," + accTime + "," + animationRegisterCache.vertexZeroConst + "\n";
                        code += "min " + tempTime + "," + tempTime + "," + lifeTimeRegister + ".w\n";
                        break;
                }
                if (this._iUsesMultiplier) {
                    code += "mul " + tempColor + "," + tempTime + "," + deltaMulValues[i] + "\n";
                    code += "add " + accMultiplierColor + "," + accMultiplierColor + "," + tempColor + "\n";
                }
                if (this._iUsesOffset) {
                    code += "mul " + tempColor + "," + tempTime + "," + deltaOffsetValues[i] + "\n";
                    code += "add " + animationRegisterCache.colorAddTarget + "," + animationRegisterCache.colorAddTarget + "," + tempColor + "\n";
                }
            }
            //for the last segment:
            if (this._iNumSegmentPoint == 0)
                tempTime = animationRegisterCache.vertexLife;
            else {
                switch (this._iNumSegmentPoint) {
                    case 1:
                        code += "sub " + accTime + "," + animationRegisterCache.vertexLife + "," + lifeTimeRegister + ".x\n";
                        break;
                    case 2:
                        code += "sub " + accTime + "," + accTime + "," + lifeTimeRegister + ".y\n";
                        break;
                    case 3:
                        code += "sub " + accTime + "," + accTime + "," + lifeTimeRegister + ".z\n";
                        break;
                    case 4:
                        code += "sub " + accTime + "," + accTime + "," + lifeTimeRegister + ".w\n";
                        break;
                }
                code += "max " + tempTime + "," + accTime + "," + animationRegisterCache.vertexZeroConst + "\n";
            }
            if (this._iUsesMultiplier) {
                code += "mul " + tempColor + "," + tempTime + "," + deltaMulValues[this._iNumSegmentPoint] + "\n";
                code += "add " + accMultiplierColor + "," + accMultiplierColor + "," + tempColor + "\n";
                code += "mul " + animationRegisterCache.colorMulTarget + "," + animationRegisterCache.colorMulTarget + "," + accMultiplierColor + "\n";
            }
            if (this._iUsesOffset) {
                code += "mul " + tempColor + "," + tempTime + "," + deltaOffsetValues[this._iNumSegmentPoint] + "\n";
                code += "add " + animationRegisterCache.colorAddTarget + "," + animationRegisterCache.colorAddTarget + "," + tempColor + "\n";
            }
        }
        return code;
    };
    return ParticleSegmentedColorNode;
})(ParticleNodeBase);
module.exports = ParticleSegmentedColorNode;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFuaW1hdG9ycy9ub2Rlcy9wYXJ0aWNsZXNlZ21lbnRlZGNvbG9ybm9kZS50cyJdLCJuYW1lcyI6WyJQYXJ0aWNsZVNlZ21lbnRlZENvbG9yTm9kZSIsIlBhcnRpY2xlU2VnbWVudGVkQ29sb3JOb2RlLmNvbnN0cnVjdG9yIiwiUGFydGljbGVTZWdtZW50ZWRDb2xvck5vZGUuX2lQcm9jZXNzQW5pbWF0aW9uU2V0dGluZyIsIlBhcnRpY2xlU2VnbWVudGVkQ29sb3JOb2RlLmdldEFHQUxWZXJ0ZXhDb2RlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFNQSxJQUFPLHFCQUFxQixXQUFhLGdFQUFnRSxDQUFDLENBQUM7QUFFM0csSUFBTyxvQkFBb0IsV0FBYyxzREFBc0QsQ0FBQyxDQUFDO0FBR2pHLElBQU8sc0JBQXNCLFdBQWEsNkRBQTZELENBQUMsQ0FBQztBQUN6RyxJQUFPLGdCQUFnQixXQUFlLHdEQUF3RCxDQUFDLENBQUM7QUFDaEcsSUFBTywyQkFBMkIsV0FBWSxvRUFBb0UsQ0FBQyxDQUFDO0FBRXBILEFBR0E7O0dBREc7SUFDRywwQkFBMEI7SUFBU0EsVUFBbkNBLDBCQUEwQkEsVUFBeUJBO0lBZXhEQSxTQWZLQSwwQkFBMEJBLENBZW5CQSxjQUFzQkEsRUFBRUEsVUFBa0JBLEVBQUVBLGVBQWVBLENBQVFBLE9BQURBLEFBQVFBLEVBQUVBLFVBQXlCQSxFQUFFQSxRQUF1QkEsRUFBRUEsYUFBc0NBO1FBRWpMQyxBQUNBQSw2RUFENkVBO1FBQzdFQSxrQkFBTUEsd0JBQXdCQSxFQUFFQSxzQkFBc0JBLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBLEVBQUVBLG9CQUFvQkEsQ0FBQ0EsY0FBY0EsQ0FBQ0EsQ0FBQ0E7UUFFdkdBLElBQUlBLENBQUNBLFlBQVlBLEdBQUdBLDJCQUEyQkEsQ0FBQ0E7UUFFaERBLEVBQUVBLENBQUNBLENBQUNBLGVBQWVBLEdBQUdBLENBQUNBLENBQUNBO1lBQ3ZCQSxNQUFLQSxDQUFDQSxJQUFJQSxLQUFLQSxDQUFDQSw2Q0FB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QSxpQkFBaUJBLENBQUNBLENBQUNBLENBQUNBO29CQUNoQ0EsS0FBS0EsQ0FBQ0E7d0JBQ0xBLElBQUlBLElBQUlBLE1BQU1BLEdBQUdBLE9BQU9BLEdBQUdBLEdBQUdBLEdBQUdBLHNCQUFzQkEsQ0FBQ0EsVUFBVUEsR0FBR0EsR0FBR0EsR0FBR0EsZ0JBQWdCQSxHQUFHQSxNQUFNQSxDQUFDQTt3QkFDckdBLEtBQUtBLENBQUNBO29CQUNQQSxLQUFLQSxDQUFDQTt3QkFDTEEsSUFBSUEsSUFBSUEsTUFBTUEsR0FBR0EsT0FBT0EsR0FBR0EsR0FBR0EsR0FBR0EsT0FBT0EsR0FBR0EsR0FBR0EsR0FBR0EsZ0JBQWdCQSxHQUFHQSxNQUFNQSxDQUFDQTt3QkFDM0VBLEtBQUtBLENBQUNBO29CQUNQQSxLQUFLQSxDQUFDQTt3QkFDTEEsSUFBSUEsSUFBSUEsTUFBTUEsR0FBR0EsT0FBT0EsR0FBR0EsR0FBR0EsR0FBR0EsT0FBT0EsR0FBR0EsR0FBR0EsR0FBR0EsZ0JBQWdCQSxHQUFHQSxNQUFNQSxDQUFDQTt3QkFDM0VBLEtBQUtBLENBQUNBO29CQUNQQSxLQUFLQSxDQUFDQTt3QkFDTEEsSUFBSUEsSUFBSUEsTUFBTUEsR0FBR0EsT0FBT0EsR0FBR0EsR0FBR0EsR0FBR0EsT0FBT0EsR0FBR0EsR0FBR0EsR0FBR0EsZ0JBQWdCQSxHQUFHQSxNQUFNQSxDQUFDQTt3QkFDM0VBLEtBQUtBLENBQUNBO2dCQUNSQSxDQUFDQTtnQkFDREEsSUFBSUEsSUFBSUEsTUFBTUEsR0FBR0EsUUFBUUEsR0FBR0EsR0FBR0EsR0FBR0EsT0FBT0EsR0FBR0EsR0FBR0EsR0FBR0Esc0JBQXNCQSxDQUFDQSxlQUFlQSxHQUFHQSxJQUFJQSxDQUFDQTtZQUNqR0EsQ0FBQ0E7WUFDREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDM0JBLElBQUlBLElBQUlBLE1BQU1BLEdBQUdBLFNBQVNBLEdBQUdBLEdBQUdBLEdBQUdBLFFBQVFBLEdBQUdBLEdBQUdBLEdBQUdBLGNBQWNBLENBQUNBLElBQUlBLENBQUNBLGlCQUFpQkEsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0E7Z0JBQ2xHQSxJQUFJQSxJQUFJQSxNQUFNQSxHQUFHQSxrQkFBa0JBLEdBQUdBLEdBQUdBLEdBQUdBLGtCQUFrQkEsR0FBR0EsR0FBR0EsR0FBR0EsU0FBU0EsR0FBR0EsSUFBSUEsQ0FBQ0E7Z0JBQ3hGQSxJQUFJQSxJQUFJQSxNQUFNQSxHQUFHQSxzQkFBc0JBLENBQUNBLGNBQWNBLEdBQUdBLEdBQUdBLEdBQUdBLHNCQUFzQkEsQ0FBQ0EsY0FBY0EsR0FBR0EsR0FBR0EsR0FBR0Esa0JBQWtCQSxHQUFHQSxJQUFJQSxDQUFDQTtZQUN4SUEsQ0FBQ0E7WUFDREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ3ZCQSxJQUFJQSxJQUFJQSxNQUFNQSxHQUFHQSxTQUFTQSxHQUFHQSxHQUFHQSxHQUFHQSxRQUFRQSxHQUFHQSxHQUFHQSxHQUFHQSxpQkFBaUJBLENBQUNBLElBQUlBLENBQUNBLGlCQUFpQkEsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0E7Z0JBQ3JHQSxJQUFJQSxJQUFJQSxNQUFNQSxHQUFHQSxzQkFBc0JBLENBQUNBLGNBQWNBLEdBQUdBLEdBQUdBLEdBQUdBLHNCQUFzQkEsQ0FBQ0EsY0FBY0EsR0FBR0EsR0FBR0EsR0FBR0EsU0FBU0EsR0FBR0EsSUFBSUEsQ0FBQ0E7WUFDL0hBLENBQUNBO1FBRUZBLENBQUNBO1FBQ0RBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBO0lBQ2JBLENBQUNBO0lBRUZILGlDQUFDQTtBQUFEQSxDQXJLQSxBQXFLQ0EsRUFyS3dDLGdCQUFnQixFQXFLeEQ7QUFFRCxBQUFvQyxpQkFBM0IsMEJBQTBCLENBQUMiLCJmaWxlIjoiYW5pbWF0b3JzL25vZGVzL1BhcnRpY2xlU2VnbWVudGVkQ29sb3JOb2RlLmpzIiwic291cmNlUm9vdCI6Ii9Vc2Vycy9yb2JiYXRlbWFuL1dlYnN0b3JtUHJvamVjdHMvYXdheWpzLXJlbmRlcmVyZ2wvIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IENvbG9yVHJhbnNmb3JtXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9jb3JlL2dlb20vQ29sb3JUcmFuc2Zvcm1cIik7XG5pbXBvcnQgVmVjdG9yM0RcdFx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9jb3JlL2dlb20vVmVjdG9yM0RcIik7XG5cbmltcG9ydCBBbmltYXRvckJhc2VcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYW5pbWF0b3JzL0FuaW1hdG9yQmFzZVwiKTtcbmltcG9ydCBBbmltYXRpb25SZWdpc3RlckNhY2hlXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2FuaW1hdG9ycy9kYXRhL0FuaW1hdGlvblJlZ2lzdGVyQ2FjaGVcIik7XG5pbXBvcnQgU2hhZGVyT2JqZWN0QmFzZVx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvbWF0ZXJpYWxzL2NvbXBpbGF0aW9uL1NoYWRlck9iamVjdEJhc2VcIik7XG5pbXBvcnQgU2hhZGVyUmVnaXN0ZXJFbGVtZW50XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL21hdGVyaWFscy9jb21waWxhdGlvbi9TaGFkZXJSZWdpc3RlckVsZW1lbnRcIik7XG5cbmltcG9ydCBQYXJ0aWNsZUFuaW1hdGlvblNldFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2FuaW1hdG9ycy9QYXJ0aWNsZUFuaW1hdGlvblNldFwiKTtcbmltcG9ydCBDb2xvclNlZ21lbnRQb2ludFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2FuaW1hdG9ycy9kYXRhL0NvbG9yU2VnbWVudFBvaW50XCIpO1xuaW1wb3J0IFBhcnRpY2xlUHJvcGVydGllc1x0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2FuaW1hdG9ycy9kYXRhL1BhcnRpY2xlUHJvcGVydGllc1wiKTtcbmltcG9ydCBQYXJ0aWNsZVByb3BlcnRpZXNNb2RlXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2FuaW1hdG9ycy9kYXRhL1BhcnRpY2xlUHJvcGVydGllc01vZGVcIik7XG5pbXBvcnQgUGFydGljbGVOb2RlQmFzZVx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvYW5pbWF0b3JzL25vZGVzL1BhcnRpY2xlTm9kZUJhc2VcIik7XG5pbXBvcnQgUGFydGljbGVTZWdtZW50ZWRDb2xvclN0YXRlXHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9hbmltYXRvcnMvc3RhdGVzL1BhcnRpY2xlU2VnbWVudGVkQ29sb3JTdGF0ZVwiKTtcblxuLyoqXG4gKlxuICovXG5jbGFzcyBQYXJ0aWNsZVNlZ21lbnRlZENvbG9yTm9kZSBleHRlbmRzIFBhcnRpY2xlTm9kZUJhc2Vcbntcblx0LyoqIEBwcml2YXRlICovXG5cdHB1YmxpYyBfaVVzZXNNdWx0aXBsaWVyOmJvb2xlYW47XG5cdC8qKiBAcHJpdmF0ZSAqL1xuXHRwdWJsaWMgX2lVc2VzT2Zmc2V0OmJvb2xlYW47XG5cdC8qKiBAcHJpdmF0ZSAqL1xuXHRwdWJsaWMgX2lTdGFydENvbG9yOkNvbG9yVHJhbnNmb3JtO1xuXHQvKiogQHByaXZhdGUgKi9cblx0cHVibGljIF9pRW5kQ29sb3I6Q29sb3JUcmFuc2Zvcm07XG5cdC8qKiBAcHJpdmF0ZSAqL1xuXHRwdWJsaWMgX2lOdW1TZWdtZW50UG9pbnQ6bnVtYmVyIC8qaW50Ki87XG5cdC8qKiBAcHJpdmF0ZSAqL1xuXHRwdWJsaWMgX2lTZWdtZW50UG9pbnRzOkFycmF5PENvbG9yU2VnbWVudFBvaW50PjtcblxuXHRjb25zdHJ1Y3Rvcih1c2VzTXVsdGlwbGllcjpib29sZWFuLCB1c2VzT2Zmc2V0OmJvb2xlYW4sIG51bVNlZ21lbnRQb2ludDpudW1iZXIgLyppbnQqLywgc3RhcnRDb2xvcjpDb2xvclRyYW5zZm9ybSwgZW5kQ29sb3I6Q29sb3JUcmFuc2Zvcm0sIHNlZ21lbnRQb2ludHM6QXJyYXk8Q29sb3JTZWdtZW50UG9pbnQ+KVxuXHR7XG5cdFx0Ly9iZWNhdXNlIG9mIHRoZSBzdGFnZTNkIHJlZ2lzdGVyIGxpbWl0YXRpb24sIGl0IG9ubHkgc3VwcG9ydCB0aGUgZ2xvYmFsIG1vZGVcblx0XHRzdXBlcihcIlBhcnRpY2xlU2VnbWVudGVkQ29sb3JcIiwgUGFydGljbGVQcm9wZXJ0aWVzTW9kZS5HTE9CQUwsIDAsIFBhcnRpY2xlQW5pbWF0aW9uU2V0LkNPTE9SX1BSSU9SSVRZKTtcblxuXHRcdHRoaXMuX3BTdGF0ZUNsYXNzID0gUGFydGljbGVTZWdtZW50ZWRDb2xvclN0YXRlO1xuXG5cdFx0aWYgKG51bVNlZ21lbnRQb2ludCA+IDQpXG5cdFx0XHR0aHJvdyhuZXcgRXJyb3IoXCJ0aGUgbnVtU2VnbWVudFBvaW50IG11c3QgYmUgbGVzcyBvciBlcXVhbCA0XCIpKTtcblx0XHR0aGlzLl9pVXNlc011bHRpcGxpZXIgPSB1c2VzTXVsdGlwbGllcjtcblx0XHR0aGlzLl9pVXNlc09mZnNldCA9IHVzZXNPZmZzZXQ7XG5cdFx0dGhpcy5faU51bVNlZ21lbnRQb2ludCA9IG51bVNlZ21lbnRQb2ludDtcblx0XHR0aGlzLl9pU3RhcnRDb2xvciA9IHN0YXJ0Q29sb3I7XG5cdFx0dGhpcy5faUVuZENvbG9yID0gZW5kQ29sb3I7XG5cdFx0dGhpcy5faVNlZ21lbnRQb2ludHMgPSBzZWdtZW50UG9pbnRzO1xuXHR9XG5cblx0LyoqXG5cdCAqIEBpbmhlcml0RG9jXG5cdCAqL1xuXHRwdWJsaWMgX2lQcm9jZXNzQW5pbWF0aW9uU2V0dGluZyhwYXJ0aWNsZUFuaW1hdGlvblNldDpQYXJ0aWNsZUFuaW1hdGlvblNldClcblx0e1xuXHRcdGlmICh0aGlzLl9pVXNlc011bHRpcGxpZXIpXG5cdFx0XHRwYXJ0aWNsZUFuaW1hdGlvblNldC5oYXNDb2xvck11bE5vZGUgPSB0cnVlO1xuXHRcdGlmICh0aGlzLl9pVXNlc09mZnNldClcblx0XHRcdHBhcnRpY2xlQW5pbWF0aW9uU2V0Lmhhc0NvbG9yQWRkTm9kZSA9IHRydWU7XG5cdH1cblxuXHQvKipcblx0ICogQGluaGVyaXREb2Ncblx0ICovXG5cdHB1YmxpYyBnZXRBR0FMVmVydGV4Q29kZShzaGFkZXJPYmplY3Q6U2hhZGVyT2JqZWN0QmFzZSwgYW5pbWF0aW9uUmVnaXN0ZXJDYWNoZTpBbmltYXRpb25SZWdpc3RlckNhY2hlKTpzdHJpbmdcblx0e1xuXHRcdHZhciBjb2RlOnN0cmluZyA9IFwiXCI7XG5cdFx0aWYgKGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGUubmVlZEZyYWdtZW50QW5pbWF0aW9uKSB7XG5cdFx0XHR2YXIgYWNjTXVsdGlwbGllckNvbG9yOlNoYWRlclJlZ2lzdGVyRWxlbWVudDtcblx0XHRcdC8vdmFyIGFjY09mZnNldENvbG9yOlNoYWRlclJlZ2lzdGVyRWxlbWVudDtcblx0XHRcdGlmICh0aGlzLl9pVXNlc011bHRpcGxpZXIpIHtcblx0XHRcdFx0YWNjTXVsdGlwbGllckNvbG9yID0gYW5pbWF0aW9uUmVnaXN0ZXJDYWNoZS5nZXRGcmVlVmVydGV4VmVjdG9yVGVtcCgpO1xuXHRcdFx0XHRhbmltYXRpb25SZWdpc3RlckNhY2hlLmFkZFZlcnRleFRlbXBVc2FnZXMoYWNjTXVsdGlwbGllckNvbG9yLCAxKTtcblx0XHRcdH1cblxuXHRcdFx0dmFyIHRlbXBDb2xvcjpTaGFkZXJSZWdpc3RlckVsZW1lbnQgPSBhbmltYXRpb25SZWdpc3RlckNhY2hlLmdldEZyZWVWZXJ0ZXhWZWN0b3JUZW1wKCk7XG5cdFx0XHRhbmltYXRpb25SZWdpc3RlckNhY2hlLmFkZFZlcnRleFRlbXBVc2FnZXModGVtcENvbG9yLCAxKTtcblxuXHRcdFx0dmFyIHRlbXA6U2hhZGVyUmVnaXN0ZXJFbGVtZW50ID0gYW5pbWF0aW9uUmVnaXN0ZXJDYWNoZS5nZXRGcmVlVmVydGV4VmVjdG9yVGVtcCgpO1xuXHRcdFx0dmFyIGFjY1RpbWU6U2hhZGVyUmVnaXN0ZXJFbGVtZW50ID0gbmV3IFNoYWRlclJlZ2lzdGVyRWxlbWVudCh0ZW1wLnJlZ05hbWUsIHRlbXAuaW5kZXgsIDApO1xuXHRcdFx0dmFyIHRlbXBUaW1lOlNoYWRlclJlZ2lzdGVyRWxlbWVudCA9IG5ldyBTaGFkZXJSZWdpc3RlckVsZW1lbnQodGVtcC5yZWdOYW1lLCB0ZW1wLmluZGV4LCAxKTtcblxuXHRcdFx0aWYgKHRoaXMuX2lVc2VzTXVsdGlwbGllcilcblx0XHRcdFx0YW5pbWF0aW9uUmVnaXN0ZXJDYWNoZS5yZW1vdmVWZXJ0ZXhUZW1wVXNhZ2UoYWNjTXVsdGlwbGllckNvbG9yKTtcblxuXHRcdFx0YW5pbWF0aW9uUmVnaXN0ZXJDYWNoZS5yZW1vdmVWZXJ0ZXhUZW1wVXNhZ2UodGVtcENvbG9yKTtcblxuXHRcdFx0Ly9mb3Igc2F2aW5nIGFsbCB0aGUgbGlmZSB2YWx1ZXMgKGF0IG1vc3QgNClcblx0XHRcdHZhciBsaWZlVGltZVJlZ2lzdGVyOlNoYWRlclJlZ2lzdGVyRWxlbWVudCA9IGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGUuZ2V0RnJlZVZlcnRleENvbnN0YW50KCk7XG5cdFx0XHRhbmltYXRpb25SZWdpc3RlckNhY2hlLnNldFJlZ2lzdGVySW5kZXgodGhpcywgUGFydGljbGVTZWdtZW50ZWRDb2xvclN0YXRlLlRJTUVfREFUQV9JTkRFWCwgbGlmZVRpbWVSZWdpc3Rlci5pbmRleCk7XG5cblx0XHRcdHZhciBpOm51bWJlciAvKmludCovO1xuXG5cdFx0XHR2YXIgc3RhcnRNdWxWYWx1ZTpTaGFkZXJSZWdpc3RlckVsZW1lbnQ7XG5cdFx0XHR2YXIgZGVsdGFNdWxWYWx1ZXM6QXJyYXk8U2hhZGVyUmVnaXN0ZXJFbGVtZW50Pjtcblx0XHRcdGlmICh0aGlzLl9pVXNlc011bHRpcGxpZXIpIHtcblx0XHRcdFx0c3RhcnRNdWxWYWx1ZSA9IGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGUuZ2V0RnJlZVZlcnRleENvbnN0YW50KCk7XG5cdFx0XHRcdGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGUuc2V0UmVnaXN0ZXJJbmRleCh0aGlzLCBQYXJ0aWNsZVNlZ21lbnRlZENvbG9yU3RhdGUuU1RBUlRfTVVMVElQTElFUl9JTkRFWCwgc3RhcnRNdWxWYWx1ZS5pbmRleCk7XG5cdFx0XHRcdGRlbHRhTXVsVmFsdWVzID0gbmV3IEFycmF5PFNoYWRlclJlZ2lzdGVyRWxlbWVudD4oKTtcblx0XHRcdFx0Zm9yIChpID0gMDsgaSA8IHRoaXMuX2lOdW1TZWdtZW50UG9pbnQgKyAxOyBpKyspXG5cdFx0XHRcdFx0ZGVsdGFNdWxWYWx1ZXMucHVzaChhbmltYXRpb25SZWdpc3RlckNhY2hlLmdldEZyZWVWZXJ0ZXhDb25zdGFudCgpKTtcblx0XHRcdH1cblxuXHRcdFx0dmFyIHN0YXJ0T2Zmc2V0VmFsdWU6U2hhZGVyUmVnaXN0ZXJFbGVtZW50O1xuXHRcdFx0dmFyIGRlbHRhT2Zmc2V0VmFsdWVzOkFycmF5PFNoYWRlclJlZ2lzdGVyRWxlbWVudD47XG5cdFx0XHRpZiAodGhpcy5faVVzZXNPZmZzZXQpIHtcblx0XHRcdFx0c3RhcnRPZmZzZXRWYWx1ZSA9IGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGUuZ2V0RnJlZVZlcnRleENvbnN0YW50KCk7XG5cdFx0XHRcdGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGUuc2V0UmVnaXN0ZXJJbmRleCh0aGlzLCBQYXJ0aWNsZVNlZ21lbnRlZENvbG9yU3RhdGUuU1RBUlRfT0ZGU0VUX0lOREVYLCBzdGFydE9mZnNldFZhbHVlLmluZGV4KTtcblx0XHRcdFx0ZGVsdGFPZmZzZXRWYWx1ZXMgPSBuZXcgQXJyYXk8U2hhZGVyUmVnaXN0ZXJFbGVtZW50PigpO1xuXHRcdFx0XHRmb3IgKGkgPSAwOyBpIDwgdGhpcy5faU51bVNlZ21lbnRQb2ludCArIDE7IGkrKylcblx0XHRcdFx0XHRkZWx0YU9mZnNldFZhbHVlcy5wdXNoKGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGUuZ2V0RnJlZVZlcnRleENvbnN0YW50KCkpO1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAodGhpcy5faVVzZXNNdWx0aXBsaWVyKVxuXHRcdFx0XHRjb2RlICs9IFwibW92IFwiICsgYWNjTXVsdGlwbGllckNvbG9yICsgXCIsXCIgKyBzdGFydE11bFZhbHVlICsgXCJcXG5cIjtcblx0XHRcdGlmICh0aGlzLl9pVXNlc09mZnNldClcblx0XHRcdFx0Y29kZSArPSBcImFkZCBcIiArIGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGUuY29sb3JBZGRUYXJnZXQgKyBcIixcIiArIGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGUuY29sb3JBZGRUYXJnZXQgKyBcIixcIiArIHN0YXJ0T2Zmc2V0VmFsdWUgKyBcIlxcblwiO1xuXG5cdFx0XHRmb3IgKGkgPSAwOyBpIDwgdGhpcy5faU51bVNlZ21lbnRQb2ludDsgaSsrKSB7XG5cdFx0XHRcdHN3aXRjaCAoaSkge1xuXHRcdFx0XHRcdGNhc2UgMDpcblx0XHRcdFx0XHRcdGNvZGUgKz0gXCJtaW4gXCIgKyB0ZW1wVGltZSArIFwiLFwiICsgYW5pbWF0aW9uUmVnaXN0ZXJDYWNoZS52ZXJ0ZXhMaWZlICsgXCIsXCIgKyBsaWZlVGltZVJlZ2lzdGVyICsgXCIueFxcblwiO1xuXHRcdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdFx0Y2FzZSAxOlxuXHRcdFx0XHRcdFx0Y29kZSArPSBcInN1YiBcIiArIGFjY1RpbWUgKyBcIixcIiArIGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGUudmVydGV4TGlmZSArIFwiLFwiICsgbGlmZVRpbWVSZWdpc3RlciArIFwiLnhcXG5cIjtcblx0XHRcdFx0XHRcdGNvZGUgKz0gXCJtYXggXCIgKyB0ZW1wVGltZSArIFwiLFwiICsgYWNjVGltZSArIFwiLFwiICsgYW5pbWF0aW9uUmVnaXN0ZXJDYWNoZS52ZXJ0ZXhaZXJvQ29uc3QgKyBcIlxcblwiO1xuXHRcdFx0XHRcdFx0Y29kZSArPSBcIm1pbiBcIiArIHRlbXBUaW1lICsgXCIsXCIgKyB0ZW1wVGltZSArIFwiLFwiICsgbGlmZVRpbWVSZWdpc3RlciArIFwiLnlcXG5cIjtcblx0XHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRcdGNhc2UgMjpcblx0XHRcdFx0XHRcdGNvZGUgKz0gXCJzdWIgXCIgKyBhY2NUaW1lICsgXCIsXCIgKyBhY2NUaW1lICsgXCIsXCIgKyBsaWZlVGltZVJlZ2lzdGVyICsgXCIueVxcblwiO1xuXHRcdFx0XHRcdFx0Y29kZSArPSBcIm1heCBcIiArIHRlbXBUaW1lICsgXCIsXCIgKyBhY2NUaW1lICsgXCIsXCIgKyBhbmltYXRpb25SZWdpc3RlckNhY2hlLnZlcnRleFplcm9Db25zdCArIFwiXFxuXCI7XG5cdFx0XHRcdFx0XHRjb2RlICs9IFwibWluIFwiICsgdGVtcFRpbWUgKyBcIixcIiArIHRlbXBUaW1lICsgXCIsXCIgKyBsaWZlVGltZVJlZ2lzdGVyICsgXCIuelxcblwiO1xuXHRcdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdFx0Y2FzZSAzOlxuXHRcdFx0XHRcdFx0Y29kZSArPSBcInN1YiBcIiArIGFjY1RpbWUgKyBcIixcIiArIGFjY1RpbWUgKyBcIixcIiArIGxpZmVUaW1lUmVnaXN0ZXIgKyBcIi56XFxuXCI7XG5cdFx0XHRcdFx0XHRjb2RlICs9IFwibWF4IFwiICsgdGVtcFRpbWUgKyBcIixcIiArIGFjY1RpbWUgKyBcIixcIiArIGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGUudmVydGV4WmVyb0NvbnN0ICsgXCJcXG5cIjtcblx0XHRcdFx0XHRcdGNvZGUgKz0gXCJtaW4gXCIgKyB0ZW1wVGltZSArIFwiLFwiICsgdGVtcFRpbWUgKyBcIixcIiArIGxpZmVUaW1lUmVnaXN0ZXIgKyBcIi53XFxuXCI7XG5cdFx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0fVxuXHRcdFx0XHRpZiAodGhpcy5faVVzZXNNdWx0aXBsaWVyKSB7XG5cdFx0XHRcdFx0Y29kZSArPSBcIm11bCBcIiArIHRlbXBDb2xvciArIFwiLFwiICsgdGVtcFRpbWUgKyBcIixcIiArIGRlbHRhTXVsVmFsdWVzW2ldICsgXCJcXG5cIjtcblx0XHRcdFx0XHRjb2RlICs9IFwiYWRkIFwiICsgYWNjTXVsdGlwbGllckNvbG9yICsgXCIsXCIgKyBhY2NNdWx0aXBsaWVyQ29sb3IgKyBcIixcIiArIHRlbXBDb2xvciArIFwiXFxuXCI7XG5cdFx0XHRcdH1cblx0XHRcdFx0aWYgKHRoaXMuX2lVc2VzT2Zmc2V0KSB7XG5cdFx0XHRcdFx0Y29kZSArPSBcIm11bCBcIiArIHRlbXBDb2xvciArIFwiLFwiICsgdGVtcFRpbWUgKyBcIixcIiArIGRlbHRhT2Zmc2V0VmFsdWVzW2ldICsgXCJcXG5cIjtcblx0XHRcdFx0XHRjb2RlICs9IFwiYWRkIFwiICsgYW5pbWF0aW9uUmVnaXN0ZXJDYWNoZS5jb2xvckFkZFRhcmdldCArIFwiLFwiICsgYW5pbWF0aW9uUmVnaXN0ZXJDYWNoZS5jb2xvckFkZFRhcmdldCArIFwiLFwiICsgdGVtcENvbG9yICsgXCJcXG5cIjtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXG5cdFx0XHQvL2ZvciB0aGUgbGFzdCBzZWdtZW50OlxuXHRcdFx0aWYgKHRoaXMuX2lOdW1TZWdtZW50UG9pbnQgPT0gMClcblx0XHRcdFx0dGVtcFRpbWUgPSBhbmltYXRpb25SZWdpc3RlckNhY2hlLnZlcnRleExpZmU7XG5cdFx0XHRlbHNlIHtcblx0XHRcdFx0c3dpdGNoICh0aGlzLl9pTnVtU2VnbWVudFBvaW50KSB7XG5cdFx0XHRcdFx0Y2FzZSAxOlxuXHRcdFx0XHRcdFx0Y29kZSArPSBcInN1YiBcIiArIGFjY1RpbWUgKyBcIixcIiArIGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGUudmVydGV4TGlmZSArIFwiLFwiICsgbGlmZVRpbWVSZWdpc3RlciArIFwiLnhcXG5cIjtcblx0XHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRcdGNhc2UgMjpcblx0XHRcdFx0XHRcdGNvZGUgKz0gXCJzdWIgXCIgKyBhY2NUaW1lICsgXCIsXCIgKyBhY2NUaW1lICsgXCIsXCIgKyBsaWZlVGltZVJlZ2lzdGVyICsgXCIueVxcblwiO1xuXHRcdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdFx0Y2FzZSAzOlxuXHRcdFx0XHRcdFx0Y29kZSArPSBcInN1YiBcIiArIGFjY1RpbWUgKyBcIixcIiArIGFjY1RpbWUgKyBcIixcIiArIGxpZmVUaW1lUmVnaXN0ZXIgKyBcIi56XFxuXCI7XG5cdFx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0XHRjYXNlIDQ6XG5cdFx0XHRcdFx0XHRjb2RlICs9IFwic3ViIFwiICsgYWNjVGltZSArIFwiLFwiICsgYWNjVGltZSArIFwiLFwiICsgbGlmZVRpbWVSZWdpc3RlciArIFwiLndcXG5cIjtcblx0XHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGNvZGUgKz0gXCJtYXggXCIgKyB0ZW1wVGltZSArIFwiLFwiICsgYWNjVGltZSArIFwiLFwiICsgYW5pbWF0aW9uUmVnaXN0ZXJDYWNoZS52ZXJ0ZXhaZXJvQ29uc3QgKyBcIlxcblwiO1xuXHRcdFx0fVxuXHRcdFx0aWYgKHRoaXMuX2lVc2VzTXVsdGlwbGllcikge1xuXHRcdFx0XHRjb2RlICs9IFwibXVsIFwiICsgdGVtcENvbG9yICsgXCIsXCIgKyB0ZW1wVGltZSArIFwiLFwiICsgZGVsdGFNdWxWYWx1ZXNbdGhpcy5faU51bVNlZ21lbnRQb2ludF0gKyBcIlxcblwiO1xuXHRcdFx0XHRjb2RlICs9IFwiYWRkIFwiICsgYWNjTXVsdGlwbGllckNvbG9yICsgXCIsXCIgKyBhY2NNdWx0aXBsaWVyQ29sb3IgKyBcIixcIiArIHRlbXBDb2xvciArIFwiXFxuXCI7XG5cdFx0XHRcdGNvZGUgKz0gXCJtdWwgXCIgKyBhbmltYXRpb25SZWdpc3RlckNhY2hlLmNvbG9yTXVsVGFyZ2V0ICsgXCIsXCIgKyBhbmltYXRpb25SZWdpc3RlckNhY2hlLmNvbG9yTXVsVGFyZ2V0ICsgXCIsXCIgKyBhY2NNdWx0aXBsaWVyQ29sb3IgKyBcIlxcblwiO1xuXHRcdFx0fVxuXHRcdFx0aWYgKHRoaXMuX2lVc2VzT2Zmc2V0KSB7XG5cdFx0XHRcdGNvZGUgKz0gXCJtdWwgXCIgKyB0ZW1wQ29sb3IgKyBcIixcIiArIHRlbXBUaW1lICsgXCIsXCIgKyBkZWx0YU9mZnNldFZhbHVlc1t0aGlzLl9pTnVtU2VnbWVudFBvaW50XSArIFwiXFxuXCI7XG5cdFx0XHRcdGNvZGUgKz0gXCJhZGQgXCIgKyBhbmltYXRpb25SZWdpc3RlckNhY2hlLmNvbG9yQWRkVGFyZ2V0ICsgXCIsXCIgKyBhbmltYXRpb25SZWdpc3RlckNhY2hlLmNvbG9yQWRkVGFyZ2V0ICsgXCIsXCIgKyB0ZW1wQ29sb3IgKyBcIlxcblwiO1xuXHRcdFx0fVxuXG5cdFx0fVxuXHRcdHJldHVybiBjb2RlO1xuXHR9XG5cbn1cblxuZXhwb3J0ID0gUGFydGljbGVTZWdtZW50ZWRDb2xvck5vZGU7Il19