var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var ParticlePropertiesMode = require("awayjs-renderergl/lib/animators/data/ParticlePropertiesMode");
var ParticleNodeBase = require("awayjs-renderergl/lib/animators/nodes/ParticleNodeBase");
var ParticleScaleState = require("awayjs-renderergl/lib/animators/states/ParticleScaleState");
/**
 * A particle animation node used to control the scale variation of a particle over time.
 */
var ParticleScaleNode = (function (_super) {
    __extends(ParticleScaleNode, _super);
    /**
     * Creates a new <code>ParticleScaleNode</code>
     *
     * @param               mode            Defines whether the mode of operation acts on local properties of a particle or global properties of the node.
     * @param    [optional] usesCycle       Defines whether the node uses the <code>cycleDuration</code> property in the shader to calculate the period of animation independent of particle duration. Defaults to false.
     * @param    [optional] usesPhase       Defines whether the node uses the <code>cyclePhase</code> property in the shader to calculate a starting offset to the animation cycle. Defaults to false.
     * @param    [optional] minScale        Defines the default min scale transform of the node, when in global mode. Defaults to 1.
     * @param    [optional] maxScale        Defines the default max color transform of the node, when in global mode. Defaults to 1.
     * @param    [optional] cycleDuration   Defines the default duration of the animation in seconds, used as a period independent of particle duration when in global mode. Defaults to 1.
     * @param    [optional] cyclePhase      Defines the default phase of the cycle in degrees, used as the starting offset of the cycle when in global mode. Defaults to 0.
     */
    function ParticleScaleNode(mode /*uint*/, usesCycle, usesPhase, minScale, maxScale, cycleDuration, cyclePhase) {
        if (minScale === void 0) { minScale = 1; }
        if (maxScale === void 0) { maxScale = 1; }
        if (cycleDuration === void 0) { cycleDuration = 1; }
        if (cyclePhase === void 0) { cyclePhase = 0; }
        _super.call(this, "ParticleScale", mode, (usesCycle && usesPhase) ? 4 : ((usesCycle || usesPhase) ? 3 : 2), 3);
        this._pStateClass = ParticleScaleState;
        this._iUsesCycle = usesCycle;
        this._iUsesPhase = usesPhase;
        this._iMinScale = minScale;
        this._iMaxScale = maxScale;
        this._iCycleDuration = cycleDuration;
        this._iCyclePhase = cyclePhase;
    }
    /**
     * @inheritDoc
     */
    ParticleScaleNode.prototype.getAGALVertexCode = function (shaderObject, animationRegisterCache) {
        var code = "";
        var temp = animationRegisterCache.getFreeVertexSingleTemp();
        var scaleRegister = (this._pMode == ParticlePropertiesMode.GLOBAL) ? animationRegisterCache.getFreeVertexConstant() : animationRegisterCache.getFreeVertexAttribute();
        animationRegisterCache.setRegisterIndex(this, ParticleScaleState.SCALE_INDEX, scaleRegister.index);
        if (this._iUsesCycle) {
            code += "mul " + temp + "," + animationRegisterCache.vertexTime + "," + scaleRegister + ".z\n";
            if (this._iUsesPhase)
                code += "add " + temp + "," + temp + "," + scaleRegister + ".w\n";
            code += "sin " + temp + "," + temp + "\n";
        }
        code += "mul " + temp + "," + scaleRegister + ".y," + ((this._iUsesCycle) ? temp : animationRegisterCache.vertexLife) + "\n";
        code += "add " + temp + "," + scaleRegister + ".x," + temp + "\n";
        code += "mul " + animationRegisterCache.scaleAndRotateTarget + ".xyz," + animationRegisterCache.scaleAndRotateTarget + ".xyz," + temp + "\n";
        return code;
    };
    /**
     * @inheritDoc
     */
    ParticleScaleNode.prototype.getAnimationState = function (animator) {
        return animator.getAnimationState(this);
    };
    /**
     * @inheritDoc
     */
    ParticleScaleNode.prototype._iGeneratePropertyOfOneParticle = function (param) {
        var scale = param[ParticleScaleNode.SCALE_VECTOR3D];
        if (!scale)
            throw (new Error("there is no " + ParticleScaleNode.SCALE_VECTOR3D + " in param!"));
        if (this._iUsesCycle) {
            this._pOneData[0] = (scale.x + scale.y) / 2;
            this._pOneData[1] = Math.abs(scale.x - scale.y) / 2;
            if (scale.z <= 0)
                throw (new Error("the cycle duration must be greater than zero"));
            this._pOneData[2] = Math.PI * 2 / scale.z;
            if (this._iUsesPhase)
                this._pOneData[3] = scale.w * Math.PI / 180;
        }
        else {
            this._pOneData[0] = scale.x;
            this._pOneData[1] = scale.y - scale.x;
        }
    };
    /**
     * Reference for scale node properties on a single particle (when in local property mode).
     * Expects a <code>Vector3D</code> representing the min scale (x), max scale(y), optional cycle speed (z) and phase offset (w) applied to the particle.
     */
    ParticleScaleNode.SCALE_VECTOR3D = "ScaleVector3D";
    return ParticleScaleNode;
})(ParticleNodeBase);
module.exports = ParticleScaleNode;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9hbmltYXRvcnMvbm9kZXMvcGFydGljbGVzY2FsZW5vZGUudHMiXSwibmFtZXMiOlsiUGFydGljbGVTY2FsZU5vZGUiLCJQYXJ0aWNsZVNjYWxlTm9kZS5jb25zdHJ1Y3RvciIsIlBhcnRpY2xlU2NhbGVOb2RlLmdldEFHQUxWZXJ0ZXhDb2RlIiwiUGFydGljbGVTY2FsZU5vZGUuZ2V0QW5pbWF0aW9uU3RhdGUiLCJQYXJ0aWNsZVNjYWxlTm9kZS5faUdlbmVyYXRlUHJvcGVydHlPZk9uZVBhcnRpY2xlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFRQSxJQUFPLHNCQUFzQixXQUFhLDZEQUE2RCxDQUFDLENBQUM7QUFDekcsSUFBTyxnQkFBZ0IsV0FBZSx3REFBd0QsQ0FBQyxDQUFDO0FBQ2hHLElBQU8sa0JBQWtCLFdBQWMsMkRBQTJELENBQUMsQ0FBQztBQUVwRyxBQUdBOztHQURHO0lBQ0csaUJBQWlCO0lBQVNBLFVBQTFCQSxpQkFBaUJBLFVBQXlCQTtJQXVCL0NBOzs7Ozs7Ozs7O09BVUdBO0lBQ0hBLFNBbENLQSxpQkFBaUJBLENBa0NWQSxJQUFJQSxDQUFRQSxRQUFEQSxBQUFTQSxFQUFFQSxTQUFpQkEsRUFBRUEsU0FBaUJBLEVBQUVBLFFBQW1CQSxFQUFFQSxRQUFtQkEsRUFBRUEsYUFBd0JBLEVBQUVBLFVBQXFCQTtRQUF6RkMsd0JBQW1CQSxHQUFuQkEsWUFBbUJBO1FBQUVBLHdCQUFtQkEsR0FBbkJBLFlBQW1CQTtRQUFFQSw2QkFBd0JBLEdBQXhCQSxpQkFBd0JBO1FBQUVBLDBCQUFxQkEsR0FBckJBLGNBQXFCQTtRQUVoS0Esa0JBQU1BLGVBQWVBLEVBQUVBLElBQUlBLEVBQUVBLENBQUNBLFNBQVNBLElBQUlBLFNBQVNBLENBQUNBLEdBQUVBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLFNBQVNBLElBQUlBLFNBQVNBLENBQUNBLEdBQUVBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBO1FBRWpHQSxJQUFJQSxDQUFDQSxZQUFZQSxHQUFHQSxrQkFBa0JBLENBQUNBO1FBRXZDQSxJQUFJQSxDQUFDQSxXQUFXQSxHQUFHQSxTQUFTQSxDQUFDQTtRQUM3QkEsSUFBSUEsQ0FBQ0EsV0FBV0EsR0FBR0EsU0FBU0EsQ0FBQ0E7UUFFN0JBLElBQUlBLENBQUNBLFVBQVVBLEdBQUdBLFFBQVFBLENBQUNBO1FBQzNCQSxJQUFJQSxDQUFDQSxVQUFVQSxHQUFHQSxRQUFRQSxDQUFDQTtRQUMzQkEsSUFBSUEsQ0FBQ0EsZUFBZUEsR0FBR0EsYUFBYUEsQ0FBQ0E7UUFDckNBLElBQUlBLENBQUNBLFlBQVlBLEdBQUdBLFVBQVVBLENBQUNBO0lBQ2hDQSxDQUFDQTtJQUVERDs7T0FFR0E7SUFDSUEsNkNBQWlCQSxHQUF4QkEsVUFBeUJBLFlBQTZCQSxFQUFFQSxzQkFBNkNBO1FBRXBHRSxJQUFJQSxJQUFJQSxHQUFVQSxFQUFFQSxDQUFDQTtRQUNyQkEsSUFBSUEsSUFBSUEsR0FBeUJBLHNCQUFzQkEsQ0FBQ0EsdUJBQXVCQSxFQUFFQSxDQUFDQTtRQUVsRkEsSUFBSUEsYUFBYUEsR0FBeUJBLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLElBQUlBLHNCQUFzQkEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsR0FBRUEsc0JBQXNCQSxDQUFDQSxxQkFBcUJBLEVBQUVBLEdBQUdBLHNCQUFzQkEsQ0FBQ0Esc0JBQXNCQSxFQUFFQSxDQUFDQTtRQUMzTEEsc0JBQXNCQSxDQUFDQSxnQkFBZ0JBLENBQUNBLElBQUlBLEVBQUVBLGtCQUFrQkEsQ0FBQ0EsV0FBV0EsRUFBRUEsYUFBYUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0E7UUFFbkdBLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLENBQUNBLENBQUNBO1lBQ3RCQSxJQUFJQSxJQUFJQSxNQUFNQSxHQUFHQSxJQUFJQSxHQUFHQSxHQUFHQSxHQUFHQSxzQkFBc0JBLENBQUNBLFVBQVVBLEdBQUdBLEdBQUdBLEdBQUdBLGFBQWFBLEdBQUdBLE1BQU1BLENBQUNBO1lBRS9GQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQTtnQkFDcEJBLElBQUlBLElBQUlBLE1BQU1BLEdBQUdBLElBQUlBLEdBQUdBLEdBQUdBLEdBQUdBLElBQUlBLEdBQUdBLEdBQUdBLEdBQUdBLGFBQWFBLEdBQUdBLE1BQU1BLENBQUNBO1lBRW5FQSxJQUFJQSxJQUFJQSxNQUFNQSxHQUFHQSxJQUFJQSxHQUFHQSxHQUFHQSxHQUFHQSxJQUFJQSxHQUFHQSxJQUFJQSxDQUFDQTtRQUMzQ0EsQ0FBQ0E7UUFFREEsSUFBSUEsSUFBSUEsTUFBTUEsR0FBR0EsSUFBSUEsR0FBR0EsR0FBR0EsR0FBR0EsYUFBYUEsR0FBR0EsS0FBS0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsR0FBRUEsSUFBSUEsR0FBR0Esc0JBQXNCQSxDQUFDQSxVQUFVQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQTtRQUM1SEEsSUFBSUEsSUFBSUEsTUFBTUEsR0FBR0EsSUFBSUEsR0FBR0EsR0FBR0EsR0FBR0EsYUFBYUEsR0FBR0EsS0FBS0EsR0FBR0EsSUFBSUEsR0FBR0EsSUFBSUEsQ0FBQ0E7UUFDbEVBLElBQUlBLElBQUlBLE1BQU1BLEdBQUdBLHNCQUFzQkEsQ0FBQ0Esb0JBQW9CQSxHQUFHQSxPQUFPQSxHQUFHQSxzQkFBc0JBLENBQUNBLG9CQUFvQkEsR0FBR0EsT0FBT0EsR0FBR0EsSUFBSUEsR0FBR0EsSUFBSUEsQ0FBQ0E7UUFFN0lBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBO0lBQ2JBLENBQUNBO0lBRURGOztPQUVHQTtJQUNJQSw2Q0FBaUJBLEdBQXhCQSxVQUF5QkEsUUFBcUJBO1FBRTdDRyxNQUFNQSxDQUFzQkEsUUFBUUEsQ0FBQ0EsaUJBQWlCQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtJQUM5REEsQ0FBQ0E7SUFFREg7O09BRUdBO0lBQ0lBLDJEQUErQkEsR0FBdENBLFVBQXVDQSxLQUF3QkE7UUFFOURJLElBQUlBLEtBQUtBLEdBQVlBLEtBQUtBLENBQUNBLGlCQUFpQkEsQ0FBQ0EsY0FBY0EsQ0FBQ0EsQ0FBQ0E7UUFDN0RBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLEtBQUtBLENBQUNBO1lBQ1ZBLE1BQUtBLENBQUNBLElBQUlBLEtBQUtBLENBQUNBLGNBQWNBLEdBQUdBLGlCQUFpQkEsQ0FBQ0EsY0FBY0EsR0FBR0EsWUFBWUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFFcEZBLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLENBQUNBLENBQUNBO1lBQ3RCQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxLQUFLQSxDQUFDQSxDQUFDQSxHQUFHQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFDQSxDQUFDQSxDQUFDQTtZQUMxQ0EsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDbERBLEVBQUVBLENBQUNBLENBQUNBLEtBQUtBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLENBQUNBO2dCQUNoQkEsTUFBS0EsQ0FBQ0EsSUFBSUEsS0FBS0EsQ0FBQ0EsOENBQThDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNsRUEsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsRUFBRUEsR0FBQ0EsQ0FBQ0EsR0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDdENBLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBO2dCQUNwQkEsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsS0FBS0EsQ0FBQ0EsQ0FBQ0EsR0FBQ0EsSUFBSUEsQ0FBQ0EsRUFBRUEsR0FBQ0EsR0FBR0EsQ0FBQ0E7UUFDMUNBLENBQUNBO1FBQUNBLElBQUlBLENBQUNBLENBQUNBO1lBQ1BBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLEtBQUtBLENBQUNBLENBQUNBLENBQUNBO1lBQzVCQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxLQUFLQSxDQUFDQSxDQUFDQSxHQUFHQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUN2Q0EsQ0FBQ0E7SUFDRkEsQ0FBQ0E7SUF4RkRKOzs7T0FHR0E7SUFDV0EsZ0NBQWNBLEdBQVVBLGVBQWVBLENBQUNBO0lBcUZ2REEsd0JBQUNBO0FBQURBLENBMUdBLEFBMEdDQSxFQTFHK0IsZ0JBQWdCLEVBMEcvQztBQUVELEFBQTJCLGlCQUFsQixpQkFBaUIsQ0FBQyIsImZpbGUiOiJhbmltYXRvcnMvbm9kZXMvUGFydGljbGVTY2FsZU5vZGUuanMiLCJzb3VyY2VSb290IjoiLi4vIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFZlY3RvcjNEXHRcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvZ2VvbS9WZWN0b3IzRFwiKTtcblxuaW1wb3J0IEFuaW1hdG9yQmFzZVx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9hbmltYXRvcnMvQW5pbWF0b3JCYXNlXCIpO1xuaW1wb3J0IEFuaW1hdGlvblJlZ2lzdGVyQ2FjaGVcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvYW5pbWF0b3JzL2RhdGEvQW5pbWF0aW9uUmVnaXN0ZXJDYWNoZVwiKTtcbmltcG9ydCBTaGFkZXJPYmplY3RCYXNlXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9jb21waWxhdGlvbi9TaGFkZXJPYmplY3RCYXNlXCIpO1xuaW1wb3J0IFNoYWRlclJlZ2lzdGVyRWxlbWVudFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9jb21waWxhdGlvbi9TaGFkZXJSZWdpc3RlckVsZW1lbnRcIik7XG5cbmltcG9ydCBQYXJ0aWNsZVByb3BlcnRpZXNcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9hbmltYXRvcnMvZGF0YS9QYXJ0aWNsZVByb3BlcnRpZXNcIik7XG5pbXBvcnQgUGFydGljbGVQcm9wZXJ0aWVzTW9kZVx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9hbmltYXRvcnMvZGF0YS9QYXJ0aWNsZVByb3BlcnRpZXNNb2RlXCIpO1xuaW1wb3J0IFBhcnRpY2xlTm9kZUJhc2VcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2FuaW1hdG9ycy9ub2Rlcy9QYXJ0aWNsZU5vZGVCYXNlXCIpO1xuaW1wb3J0IFBhcnRpY2xlU2NhbGVTdGF0ZVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2FuaW1hdG9ycy9zdGF0ZXMvUGFydGljbGVTY2FsZVN0YXRlXCIpO1xuXG4vKipcbiAqIEEgcGFydGljbGUgYW5pbWF0aW9uIG5vZGUgdXNlZCB0byBjb250cm9sIHRoZSBzY2FsZSB2YXJpYXRpb24gb2YgYSBwYXJ0aWNsZSBvdmVyIHRpbWUuXG4gKi9cbmNsYXNzIFBhcnRpY2xlU2NhbGVOb2RlIGV4dGVuZHMgUGFydGljbGVOb2RlQmFzZVxue1xuXHQvKiogQHByaXZhdGUgKi9cblx0cHVibGljIF9pVXNlc0N5Y2xlOmJvb2xlYW47XG5cblx0LyoqIEBwcml2YXRlICovXG5cdHB1YmxpYyBfaVVzZXNQaGFzZTpib29sZWFuO1xuXG5cdC8qKiBAcHJpdmF0ZSAqL1xuXHRwdWJsaWMgX2lNaW5TY2FsZTpudW1iZXI7XG5cdC8qKiBAcHJpdmF0ZSAqL1xuXHRwdWJsaWMgX2lNYXhTY2FsZTpudW1iZXI7XG5cdC8qKiBAcHJpdmF0ZSAqL1xuXHRwdWJsaWMgX2lDeWNsZUR1cmF0aW9uOm51bWJlcjtcblx0LyoqIEBwcml2YXRlICovXG5cdHB1YmxpYyBfaUN5Y2xlUGhhc2U6bnVtYmVyO1xuXG5cdC8qKlxuXHQgKiBSZWZlcmVuY2UgZm9yIHNjYWxlIG5vZGUgcHJvcGVydGllcyBvbiBhIHNpbmdsZSBwYXJ0aWNsZSAod2hlbiBpbiBsb2NhbCBwcm9wZXJ0eSBtb2RlKS5cblx0ICogRXhwZWN0cyBhIDxjb2RlPlZlY3RvcjNEPC9jb2RlPiByZXByZXNlbnRpbmcgdGhlIG1pbiBzY2FsZSAoeCksIG1heCBzY2FsZSh5KSwgb3B0aW9uYWwgY3ljbGUgc3BlZWQgKHopIGFuZCBwaGFzZSBvZmZzZXQgKHcpIGFwcGxpZWQgdG8gdGhlIHBhcnRpY2xlLlxuXHQgKi9cblx0cHVibGljIHN0YXRpYyBTQ0FMRV9WRUNUT1IzRDpzdHJpbmcgPSBcIlNjYWxlVmVjdG9yM0RcIjtcblxuXHQvKipcblx0ICogQ3JlYXRlcyBhIG5ldyA8Y29kZT5QYXJ0aWNsZVNjYWxlTm9kZTwvY29kZT5cblx0ICpcblx0ICogQHBhcmFtICAgICAgICAgICAgICAgbW9kZSAgICAgICAgICAgIERlZmluZXMgd2hldGhlciB0aGUgbW9kZSBvZiBvcGVyYXRpb24gYWN0cyBvbiBsb2NhbCBwcm9wZXJ0aWVzIG9mIGEgcGFydGljbGUgb3IgZ2xvYmFsIHByb3BlcnRpZXMgb2YgdGhlIG5vZGUuXG5cdCAqIEBwYXJhbSAgICBbb3B0aW9uYWxdIHVzZXNDeWNsZSAgICAgICBEZWZpbmVzIHdoZXRoZXIgdGhlIG5vZGUgdXNlcyB0aGUgPGNvZGU+Y3ljbGVEdXJhdGlvbjwvY29kZT4gcHJvcGVydHkgaW4gdGhlIHNoYWRlciB0byBjYWxjdWxhdGUgdGhlIHBlcmlvZCBvZiBhbmltYXRpb24gaW5kZXBlbmRlbnQgb2YgcGFydGljbGUgZHVyYXRpb24uIERlZmF1bHRzIHRvIGZhbHNlLlxuXHQgKiBAcGFyYW0gICAgW29wdGlvbmFsXSB1c2VzUGhhc2UgICAgICAgRGVmaW5lcyB3aGV0aGVyIHRoZSBub2RlIHVzZXMgdGhlIDxjb2RlPmN5Y2xlUGhhc2U8L2NvZGU+IHByb3BlcnR5IGluIHRoZSBzaGFkZXIgdG8gY2FsY3VsYXRlIGEgc3RhcnRpbmcgb2Zmc2V0IHRvIHRoZSBhbmltYXRpb24gY3ljbGUuIERlZmF1bHRzIHRvIGZhbHNlLlxuXHQgKiBAcGFyYW0gICAgW29wdGlvbmFsXSBtaW5TY2FsZSAgICAgICAgRGVmaW5lcyB0aGUgZGVmYXVsdCBtaW4gc2NhbGUgdHJhbnNmb3JtIG9mIHRoZSBub2RlLCB3aGVuIGluIGdsb2JhbCBtb2RlLiBEZWZhdWx0cyB0byAxLlxuXHQgKiBAcGFyYW0gICAgW29wdGlvbmFsXSBtYXhTY2FsZSAgICAgICAgRGVmaW5lcyB0aGUgZGVmYXVsdCBtYXggY29sb3IgdHJhbnNmb3JtIG9mIHRoZSBub2RlLCB3aGVuIGluIGdsb2JhbCBtb2RlLiBEZWZhdWx0cyB0byAxLlxuXHQgKiBAcGFyYW0gICAgW29wdGlvbmFsXSBjeWNsZUR1cmF0aW9uICAgRGVmaW5lcyB0aGUgZGVmYXVsdCBkdXJhdGlvbiBvZiB0aGUgYW5pbWF0aW9uIGluIHNlY29uZHMsIHVzZWQgYXMgYSBwZXJpb2QgaW5kZXBlbmRlbnQgb2YgcGFydGljbGUgZHVyYXRpb24gd2hlbiBpbiBnbG9iYWwgbW9kZS4gRGVmYXVsdHMgdG8gMS5cblx0ICogQHBhcmFtICAgIFtvcHRpb25hbF0gY3ljbGVQaGFzZSAgICAgIERlZmluZXMgdGhlIGRlZmF1bHQgcGhhc2Ugb2YgdGhlIGN5Y2xlIGluIGRlZ3JlZXMsIHVzZWQgYXMgdGhlIHN0YXJ0aW5nIG9mZnNldCBvZiB0aGUgY3ljbGUgd2hlbiBpbiBnbG9iYWwgbW9kZS4gRGVmYXVsdHMgdG8gMC5cblx0ICovXG5cdGNvbnN0cnVjdG9yKG1vZGU6bnVtYmVyIC8qdWludCovLCB1c2VzQ3ljbGU6Ym9vbGVhbiwgdXNlc1BoYXNlOmJvb2xlYW4sIG1pblNjYWxlOm51bWJlciA9IDEsIG1heFNjYWxlOm51bWJlciA9IDEsIGN5Y2xlRHVyYXRpb246bnVtYmVyID0gMSwgY3ljbGVQaGFzZTpudW1iZXIgPSAwKVxuXHR7XG5cdFx0c3VwZXIoXCJQYXJ0aWNsZVNjYWxlXCIsIG1vZGUsICh1c2VzQ3ljbGUgJiYgdXNlc1BoYXNlKT8gNCA6ICgodXNlc0N5Y2xlIHx8IHVzZXNQaGFzZSk/IDMgOiAyKSwgMyk7XG5cblx0XHR0aGlzLl9wU3RhdGVDbGFzcyA9IFBhcnRpY2xlU2NhbGVTdGF0ZTtcblxuXHRcdHRoaXMuX2lVc2VzQ3ljbGUgPSB1c2VzQ3ljbGU7XG5cdFx0dGhpcy5faVVzZXNQaGFzZSA9IHVzZXNQaGFzZTtcblxuXHRcdHRoaXMuX2lNaW5TY2FsZSA9IG1pblNjYWxlO1xuXHRcdHRoaXMuX2lNYXhTY2FsZSA9IG1heFNjYWxlO1xuXHRcdHRoaXMuX2lDeWNsZUR1cmF0aW9uID0gY3ljbGVEdXJhdGlvbjtcblx0XHR0aGlzLl9pQ3ljbGVQaGFzZSA9IGN5Y2xlUGhhc2U7XG5cdH1cblxuXHQvKipcblx0ICogQGluaGVyaXREb2Ncblx0ICovXG5cdHB1YmxpYyBnZXRBR0FMVmVydGV4Q29kZShzaGFkZXJPYmplY3Q6U2hhZGVyT2JqZWN0QmFzZSwgYW5pbWF0aW9uUmVnaXN0ZXJDYWNoZTpBbmltYXRpb25SZWdpc3RlckNhY2hlKTpzdHJpbmdcblx0e1xuXHRcdHZhciBjb2RlOnN0cmluZyA9IFwiXCI7XG5cdFx0dmFyIHRlbXA6U2hhZGVyUmVnaXN0ZXJFbGVtZW50ID0gYW5pbWF0aW9uUmVnaXN0ZXJDYWNoZS5nZXRGcmVlVmVydGV4U2luZ2xlVGVtcCgpO1xuXG5cdFx0dmFyIHNjYWxlUmVnaXN0ZXI6U2hhZGVyUmVnaXN0ZXJFbGVtZW50ID0gKHRoaXMuX3BNb2RlID09IFBhcnRpY2xlUHJvcGVydGllc01vZGUuR0xPQkFMKT8gYW5pbWF0aW9uUmVnaXN0ZXJDYWNoZS5nZXRGcmVlVmVydGV4Q29uc3RhbnQoKSA6IGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGUuZ2V0RnJlZVZlcnRleEF0dHJpYnV0ZSgpO1xuXHRcdGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGUuc2V0UmVnaXN0ZXJJbmRleCh0aGlzLCBQYXJ0aWNsZVNjYWxlU3RhdGUuU0NBTEVfSU5ERVgsIHNjYWxlUmVnaXN0ZXIuaW5kZXgpO1xuXG5cdFx0aWYgKHRoaXMuX2lVc2VzQ3ljbGUpIHtcblx0XHRcdGNvZGUgKz0gXCJtdWwgXCIgKyB0ZW1wICsgXCIsXCIgKyBhbmltYXRpb25SZWdpc3RlckNhY2hlLnZlcnRleFRpbWUgKyBcIixcIiArIHNjYWxlUmVnaXN0ZXIgKyBcIi56XFxuXCI7XG5cblx0XHRcdGlmICh0aGlzLl9pVXNlc1BoYXNlKVxuXHRcdFx0XHRjb2RlICs9IFwiYWRkIFwiICsgdGVtcCArIFwiLFwiICsgdGVtcCArIFwiLFwiICsgc2NhbGVSZWdpc3RlciArIFwiLndcXG5cIjtcblxuXHRcdFx0Y29kZSArPSBcInNpbiBcIiArIHRlbXAgKyBcIixcIiArIHRlbXAgKyBcIlxcblwiO1xuXHRcdH1cblxuXHRcdGNvZGUgKz0gXCJtdWwgXCIgKyB0ZW1wICsgXCIsXCIgKyBzY2FsZVJlZ2lzdGVyICsgXCIueSxcIiArICgodGhpcy5faVVzZXNDeWNsZSk/IHRlbXAgOiBhbmltYXRpb25SZWdpc3RlckNhY2hlLnZlcnRleExpZmUpICsgXCJcXG5cIjtcblx0XHRjb2RlICs9IFwiYWRkIFwiICsgdGVtcCArIFwiLFwiICsgc2NhbGVSZWdpc3RlciArIFwiLngsXCIgKyB0ZW1wICsgXCJcXG5cIjtcblx0XHRjb2RlICs9IFwibXVsIFwiICsgYW5pbWF0aW9uUmVnaXN0ZXJDYWNoZS5zY2FsZUFuZFJvdGF0ZVRhcmdldCArIFwiLnh5eixcIiArIGFuaW1hdGlvblJlZ2lzdGVyQ2FjaGUuc2NhbGVBbmRSb3RhdGVUYXJnZXQgKyBcIi54eXosXCIgKyB0ZW1wICsgXCJcXG5cIjtcblxuXHRcdHJldHVybiBjb2RlO1xuXHR9XG5cblx0LyoqXG5cdCAqIEBpbmhlcml0RG9jXG5cdCAqL1xuXHRwdWJsaWMgZ2V0QW5pbWF0aW9uU3RhdGUoYW5pbWF0b3I6QW5pbWF0b3JCYXNlKTpQYXJ0aWNsZVNjYWxlU3RhdGVcblx0e1xuXHRcdHJldHVybiA8UGFydGljbGVTY2FsZVN0YXRlPiBhbmltYXRvci5nZXRBbmltYXRpb25TdGF0ZSh0aGlzKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBAaW5oZXJpdERvY1xuXHQgKi9cblx0cHVibGljIF9pR2VuZXJhdGVQcm9wZXJ0eU9mT25lUGFydGljbGUocGFyYW06UGFydGljbGVQcm9wZXJ0aWVzKVxuXHR7XG5cdFx0dmFyIHNjYWxlOlZlY3RvcjNEID0gcGFyYW1bUGFydGljbGVTY2FsZU5vZGUuU0NBTEVfVkVDVE9SM0RdO1xuXHRcdGlmICghc2NhbGUpXG5cdFx0XHR0aHJvdyhuZXcgRXJyb3IoXCJ0aGVyZSBpcyBubyBcIiArIFBhcnRpY2xlU2NhbGVOb2RlLlNDQUxFX1ZFQ1RPUjNEICsgXCIgaW4gcGFyYW0hXCIpKTtcblxuXHRcdGlmICh0aGlzLl9pVXNlc0N5Y2xlKSB7XG5cdFx0XHR0aGlzLl9wT25lRGF0YVswXSA9IChzY2FsZS54ICsgc2NhbGUueSkvMjtcblx0XHRcdHRoaXMuX3BPbmVEYXRhWzFdID0gTWF0aC5hYnMoc2NhbGUueCAtIHNjYWxlLnkpLzI7XG5cdFx0XHRpZiAoc2NhbGUueiA8PSAwKVxuXHRcdFx0XHR0aHJvdyhuZXcgRXJyb3IoXCJ0aGUgY3ljbGUgZHVyYXRpb24gbXVzdCBiZSBncmVhdGVyIHRoYW4gemVyb1wiKSk7XG5cdFx0XHR0aGlzLl9wT25lRGF0YVsyXSA9IE1hdGguUEkqMi9zY2FsZS56O1xuXHRcdFx0aWYgKHRoaXMuX2lVc2VzUGhhc2UpXG5cdFx0XHRcdHRoaXMuX3BPbmVEYXRhWzNdID0gc2NhbGUudypNYXRoLlBJLzE4MDtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhpcy5fcE9uZURhdGFbMF0gPSBzY2FsZS54O1xuXHRcdFx0dGhpcy5fcE9uZURhdGFbMV0gPSBzY2FsZS55IC0gc2NhbGUueDtcblx0XHR9XG5cdH1cbn1cblxuZXhwb3J0ID0gUGFydGljbGVTY2FsZU5vZGU7Il19