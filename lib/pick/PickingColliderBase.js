var Point = require("awayjs-core/lib/geom/Point");
var Vector3D = require("awayjs-core/lib/geom/Vector3D");
var AbstractMethodError = require("awayjs-core/lib/errors/AbstractMethodError");
var BillboardRenderable = require("awayjs-renderergl/lib/pool/BillboardRenderable");
var TriangleSubMeshRenderable = require("awayjs-renderergl/lib/pool/TriangleSubMeshRenderable");
var RenderablePoolBase = require("awayjs-renderergl/lib/pool/RenderablePoolBase");
/**
 * An abstract base class for all picking collider classes. It should not be instantiated directly.
 *
 * @class away.pick.PickingColliderBase
 */
var PickingColliderBase = (function () {
    function PickingColliderBase(stage) {
        //TODO
        this._billboardRenderablePool = RenderablePoolBase.getPool(BillboardRenderable, stage);
        this._subMeshRenderablePool = RenderablePoolBase.getPool(TriangleSubMeshRenderable, stage);
    }
    PickingColliderBase.prototype._pPetCollisionNormal = function (indexData /*uint*/, vertexData, triangleIndex) {
        var normal = new Vector3D();
        var i0 = indexData[triangleIndex] * 3;
        var i1 = indexData[triangleIndex + 1] * 3;
        var i2 = indexData[triangleIndex + 2] * 3;
        var p0 = new Vector3D(vertexData[i0], vertexData[i0 + 1], vertexData[i0 + 2]);
        var p1 = new Vector3D(vertexData[i1], vertexData[i1 + 1], vertexData[i1 + 2]);
        var p2 = new Vector3D(vertexData[i2], vertexData[i2 + 1], vertexData[i2 + 2]);
        var side0 = p1.subtract(p0);
        var side1 = p2.subtract(p0);
        normal = side0.crossProduct(side1);
        normal.normalize();
        return normal;
    };
    PickingColliderBase.prototype._pGetCollisionUV = function (indexData /*uint*/, uvData, triangleIndex, v, w, u, uvOffset, uvStride) {
        var uv = new Point();
        var uIndex = indexData[triangleIndex] * uvStride + uvOffset;
        var uv0 = new Vector3D(uvData[uIndex], uvData[uIndex + 1]);
        uIndex = indexData[triangleIndex + 1] * uvStride + uvOffset;
        var uv1 = new Vector3D(uvData[uIndex], uvData[uIndex + 1]);
        uIndex = indexData[triangleIndex + 2] * uvStride + uvOffset;
        var uv2 = new Vector3D(uvData[uIndex], uvData[uIndex + 1]);
        uv.x = u * uv0.x + v * uv1.x + w * uv2.x;
        uv.y = u * uv0.y + v * uv1.y + w * uv2.y;
        return uv;
    };
    /**
     * @inheritDoc
     */
    PickingColliderBase.prototype._pTestRenderableCollision = function (renderable, pickingCollisionVO, shortestCollisionDistance) {
        throw new AbstractMethodError();
    };
    /**
     * @inheritDoc
     */
    PickingColliderBase.prototype.setLocalRay = function (localPosition, localDirection) {
        this.rayPosition = localPosition;
        this.rayDirection = localDirection;
    };
    /**
     * Tests a <code>Billboard</code> object for a collision with the picking ray.
     *
     * @param billboard The billboard instance to be tested.
     * @param pickingCollisionVO The collision object used to store the collision results
     * @param shortestCollisionDistance The current value of the shortest distance to a detected collision along the ray.
     * @param findClosest
     */
    PickingColliderBase.prototype.testBillboardCollision = function (billboard, pickingCollisionVO, shortestCollisionDistance) {
        this.setLocalRay(pickingCollisionVO.localRayPosition, pickingCollisionVO.localRayDirection);
        pickingCollisionVO.renderableOwner = null;
        if (this._pTestRenderableCollision(this._billboardRenderablePool.getItem(billboard), pickingCollisionVO, shortestCollisionDistance)) {
            shortestCollisionDistance = pickingCollisionVO.rayEntryDistance;
            pickingCollisionVO.renderableOwner = billboard;
            return true;
        }
        return false;
    };
    /**
     * Tests a <code>Mesh</code> object for a collision with the picking ray.
     *
     * @param mesh The mesh instance to be tested.
     * @param pickingCollisionVO The collision object used to store the collision results
     * @param shortestCollisionDistance The current value of the shortest distance to a detected collision along the ray.
     * @param findClosest
     */
    PickingColliderBase.prototype.testMeshCollision = function (mesh, pickingCollisionVO, shortestCollisionDistance, findClosest) {
        this.setLocalRay(pickingCollisionVO.localRayPosition, pickingCollisionVO.localRayDirection);
        pickingCollisionVO.renderableOwner = null;
        var subMesh;
        var len = mesh.subMeshes.length;
        for (var i = 0; i < len; ++i) {
            subMesh = mesh.subMeshes[i];
            if (this._pTestRenderableCollision(this._subMeshRenderablePool.getItem(subMesh), pickingCollisionVO, shortestCollisionDistance)) {
                shortestCollisionDistance = pickingCollisionVO.rayEntryDistance;
                pickingCollisionVO.renderableOwner = subMesh;
                if (!findClosest)
                    return true;
            }
        }
        return pickingCollisionVO.renderableOwner != null;
    };
    return PickingColliderBase;
})();
module.exports = PickingColliderBase;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9waWNrL1BpY2tpbmdDb2xsaWRlckJhc2UudHMiXSwibmFtZXMiOlsiUGlja2luZ0NvbGxpZGVyQmFzZSIsIlBpY2tpbmdDb2xsaWRlckJhc2UuY29uc3RydWN0b3IiLCJQaWNraW5nQ29sbGlkZXJCYXNlLl9wUGV0Q29sbGlzaW9uTm9ybWFsIiwiUGlja2luZ0NvbGxpZGVyQmFzZS5fcEdldENvbGxpc2lvblVWIiwiUGlja2luZ0NvbGxpZGVyQmFzZS5fcFRlc3RSZW5kZXJhYmxlQ29sbGlzaW9uIiwiUGlja2luZ0NvbGxpZGVyQmFzZS5zZXRMb2NhbFJheSIsIlBpY2tpbmdDb2xsaWRlckJhc2UudGVzdEJpbGxib2FyZENvbGxpc2lvbiIsIlBpY2tpbmdDb2xsaWRlckJhc2UudGVzdE1lc2hDb2xsaXNpb24iXSwibWFwcGluZ3MiOiJBQUFBLElBQU8sS0FBSyxXQUFpQiw0QkFBNEIsQ0FBQyxDQUFDO0FBQzNELElBQU8sUUFBUSxXQUFpQiwrQkFBK0IsQ0FBQyxDQUFDO0FBQ2pFLElBQU8sbUJBQW1CLFdBQWMsNENBQTRDLENBQUMsQ0FBQztBQVN0RixJQUFPLG1CQUFtQixXQUFjLGdEQUFnRCxDQUFDLENBQUM7QUFFMUYsSUFBTyx5QkFBeUIsV0FBWSxzREFBc0QsQ0FBQyxDQUFDO0FBQ3BHLElBQU8sa0JBQWtCLFdBQWUsK0NBQStDLENBQUMsQ0FBQztBQUV6RixBQUtBOzs7O0dBREc7SUFDRyxtQkFBbUI7SUFReEJBLFNBUktBLG1CQUFtQkEsQ0FRWkEsS0FBV0E7UUFFdEJDLEFBQ0FBLE1BRE1BO1FBQ05BLElBQUlBLENBQUNBLHdCQUF3QkEsR0FBR0Esa0JBQWtCQSxDQUFDQSxPQUFPQSxDQUFDQSxtQkFBbUJBLEVBQUVBLEtBQUtBLENBQUNBLENBQUNBO1FBQ3ZGQSxJQUFJQSxDQUFDQSxzQkFBc0JBLEdBQUdBLGtCQUFrQkEsQ0FBQ0EsT0FBT0EsQ0FBQ0EseUJBQXlCQSxFQUFFQSxLQUFLQSxDQUFDQSxDQUFDQTtJQUM1RkEsQ0FBQ0E7SUFFTUQsa0RBQW9CQSxHQUEzQkEsVUFBNEJBLFNBQVNBLENBQWVBLFFBQURBLEFBQVNBLEVBQUVBLFVBQXdCQSxFQUFFQSxhQUFvQkE7UUFFM0dFLElBQUlBLE1BQU1BLEdBQVlBLElBQUlBLFFBQVFBLEVBQUVBLENBQUNBO1FBQ3JDQSxJQUFJQSxFQUFFQSxHQUFVQSxTQUFTQSxDQUFFQSxhQUFhQSxDQUFFQSxHQUFDQSxDQUFDQSxDQUFDQTtRQUM3Q0EsSUFBSUEsRUFBRUEsR0FBVUEsU0FBU0EsQ0FBRUEsYUFBYUEsR0FBR0EsQ0FBQ0EsQ0FBRUEsR0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDakRBLElBQUlBLEVBQUVBLEdBQVVBLFNBQVNBLENBQUVBLGFBQWFBLEdBQUdBLENBQUNBLENBQUVBLEdBQUNBLENBQUNBLENBQUNBO1FBQ2pEQSxJQUFJQSxFQUFFQSxHQUFZQSxJQUFJQSxRQUFRQSxDQUFDQSxVQUFVQSxDQUFFQSxFQUFFQSxDQUFFQSxFQUFFQSxVQUFVQSxDQUFFQSxFQUFFQSxHQUFHQSxDQUFDQSxDQUFFQSxFQUFFQSxVQUFVQSxDQUFFQSxFQUFFQSxHQUFHQSxDQUFDQSxDQUFFQSxDQUFDQSxDQUFDQTtRQUM3RkEsSUFBSUEsRUFBRUEsR0FBWUEsSUFBSUEsUUFBUUEsQ0FBQ0EsVUFBVUEsQ0FBRUEsRUFBRUEsQ0FBRUEsRUFBRUEsVUFBVUEsQ0FBRUEsRUFBRUEsR0FBR0EsQ0FBQ0EsQ0FBRUEsRUFBRUEsVUFBVUEsQ0FBRUEsRUFBRUEsR0FBR0EsQ0FBQ0EsQ0FBRUEsQ0FBQ0EsQ0FBQ0E7UUFDN0ZBLElBQUlBLEVBQUVBLEdBQVlBLElBQUlBLFFBQVFBLENBQUNBLFVBQVVBLENBQUVBLEVBQUVBLENBQUVBLEVBQUVBLFVBQVVBLENBQUVBLEVBQUVBLEdBQUdBLENBQUNBLENBQUVBLEVBQUVBLFVBQVVBLENBQUVBLEVBQUVBLEdBQUdBLENBQUNBLENBQUVBLENBQUNBLENBQUNBO1FBQzdGQSxJQUFJQSxLQUFLQSxHQUFZQSxFQUFFQSxDQUFDQSxRQUFR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Q0FBQ0EsSUFBSUEsQ0FBQ0EseUJBQXlCQSxDQUFrQkEsSUFBSUEsQ0FBQ0Esc0JBQXNCQSxDQUFDQSxPQUFPQSxDQUFDQSxPQUFPQSxDQUFDQSxFQUFFQSxrQkFBa0JBLEVBQUVBLHlCQUF5QkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ2xKQSx5QkFBeUJBLEdBQUdBLGtCQUFrQkEsQ0FBQ0EsZ0JBQWdCQSxDQUFDQTtnQkFFaEVBLGtCQUFrQkEsQ0FBQ0EsZUFBZUEsR0FBR0EsT0FBT0EsQ0FBQ0E7Z0JBRTdDQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxXQUFXQSxDQUFDQTtvQkFDaEJBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBO1lBQ2RBLENBQUNBO1FBQ0ZBLENBQUNBO1FBRURBLE1BQU1BLENBQUNBLGtCQUFrQkEsQ0FBQ0EsZUFBZUEsSUFBSUEsSUFBSUEsQ0FBQ0E7SUFDbkRBLENBQUNBO0lBQ0ZQLDBCQUFDQTtBQUFEQSxDQXJIQSxBQXFIQ0EsSUFBQTtBQUVELEFBQTZCLGlCQUFwQixtQkFBbUIsQ0FBQyIsImZpbGUiOiJwaWNrL1BpY2tpbmdDb2xsaWRlckJhc2UuanMiLCJzb3VyY2VSb290IjoiLi4vIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFBvaW50XHRcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvZ2VvbS9Qb2ludFwiKTtcclxuaW1wb3J0IFZlY3RvcjNEXHRcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvZ2VvbS9WZWN0b3IzRFwiKTtcclxuaW1wb3J0IEFic3RyYWN0TWV0aG9kRXJyb3JcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9lcnJvcnMvQWJzdHJhY3RNZXRob2RFcnJvclwiKTtcclxuXHJcbmltcG9ydCBJU3ViTWVzaFx0XHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL2Jhc2UvSVN1Yk1lc2hcIik7XHJcbmltcG9ydCBQaWNraW5nQ29sbGlzaW9uVk9cdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9waWNrL1BpY2tpbmdDb2xsaXNpb25WT1wiKTtcclxuaW1wb3J0IEJpbGxib2FyZFx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9lbnRpdGllcy9CaWxsYm9hcmRcIik7XHJcbmltcG9ydCBNZXNoXHRcdFx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9lbnRpdGllcy9NZXNoXCIpO1xyXG5cclxuaW1wb3J0IFN0YWdlXHRcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYmFzZS9TdGFnZVwiKTtcclxuXHJcbmltcG9ydCBCaWxsYm9hcmRSZW5kZXJhYmxlXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvcG9vbC9CaWxsYm9hcmRSZW5kZXJhYmxlXCIpO1xyXG5pbXBvcnQgUmVuZGVyYWJsZUJhc2VcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL3Bvb2wvUmVuZGVyYWJsZUJhc2VcIik7XHJcbmltcG9ydCBUcmlhbmdsZVN1Yk1lc2hSZW5kZXJhYmxlXHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9wb29sL1RyaWFuZ2xlU3ViTWVzaFJlbmRlcmFibGVcIik7XHJcbmltcG9ydCBSZW5kZXJhYmxlUG9vbEJhc2VcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL3Bvb2wvUmVuZGVyYWJsZVBvb2xCYXNlXCIpO1xyXG5cclxuLyoqXHJcbiAqIEFuIGFic3RyYWN0IGJhc2UgY2xhc3MgZm9yIGFsbCBwaWNraW5nIGNvbGxpZGVyIGNsYXNzZXMuIEl0IHNob3VsZCBub3QgYmUgaW5zdGFudGlhdGVkIGRpcmVjdGx5LlxyXG4gKlxyXG4gKiBAY2xhc3MgYXdheS5waWNrLlBpY2tpbmdDb2xsaWRlckJhc2VcclxuICovXHJcbmNsYXNzIFBpY2tpbmdDb2xsaWRlckJhc2Vcclxue1xyXG5cdHByaXZhdGUgX2JpbGxib2FyZFJlbmRlcmFibGVQb29sOlJlbmRlcmFibGVQb29sQmFzZTtcclxuXHRwcml2YXRlIF9zdWJNZXNoUmVuZGVyYWJsZVBvb2w6UmVuZGVyYWJsZVBvb2xCYXNlO1xyXG5cclxuXHRwdWJsaWMgcmF5UG9zaXRpb246VmVjdG9yM0Q7XHJcblx0cHVibGljIHJheURpcmVjdGlvbjpWZWN0b3IzRDtcclxuXHJcblx0Y29uc3RydWN0b3Ioc3RhZ2U6U3RhZ2UpXHJcblx0e1xyXG5cdFx0Ly9UT0RPXHJcblx0XHR0aGlzLl9iaWxsYm9hcmRSZW5kZXJhYmxlUG9vbCA9IFJlbmRlcmFibGVQb29sQmFzZS5nZXRQb29sKEJpbGxib2FyZFJlbmRlcmFibGUsIHN0YWdlKTtcclxuXHRcdHRoaXMuX3N1Yk1lc2hSZW5kZXJhYmxlUG9vbCA9IFJlbmRlcmFibGVQb29sQmFzZS5nZXRQb29sKFRyaWFuZ2xlU3ViTWVzaFJlbmRlcmFibGUsIHN0YWdlKTtcclxuXHR9XHJcblxyXG5cdHB1YmxpYyBfcFBldENvbGxpc2lvbk5vcm1hbChpbmRleERhdGE6QXJyYXk8bnVtYmVyPiAvKnVpbnQqLywgdmVydGV4RGF0YTpBcnJheTxudW1iZXI+LCB0cmlhbmdsZUluZGV4Om51bWJlcik6VmVjdG9yM0QgLy8gUFJPVEVDVEVEXHJcblx0e1xyXG5cdFx0dmFyIG5vcm1hbDpWZWN0b3IzRCA9IG5ldyBWZWN0b3IzRCgpO1xyXG5cdFx0dmFyIGkwOm51bWJlciA9IGluZGV4RGF0YVsgdHJpYW5nbGVJbmRleCBdKjM7XHJcblx0XHR2YXIgaTE6bnVtYmVyID0gaW5kZXhEYXRhWyB0cmlhbmdsZUluZGV4ICsgMSBdKjM7XHJcblx0XHR2YXIgaTI6bnVtYmVyID0gaW5kZXhEYXRhWyB0cmlhbmdsZUluZGV4ICsgMiBdKjM7XHJcblx0XHR2YXIgcDA6VmVjdG9yM0QgPSBuZXcgVmVjdG9yM0QodmVydGV4RGF0YVsgaTAgXSwgdmVydGV4RGF0YVsgaTAgKyAxIF0sIHZlcnRleERhdGFbIGkwICsgMiBdKTtcclxuXHRcdHZhciBwMTpWZWN0b3IzRCA9IG5ldyBWZWN0b3IzRCh2ZXJ0ZXhEYXRhWyBpMSBdLCB2ZXJ0ZXhEYXRhWyBpMSArIDEgXSwgdmVydGV4RGF0YVsgaTEgKyAyIF0pO1xyXG5cdFx0dmFyIHAyOlZlY3RvcjNEID0gbmV3IFZlY3RvcjNEKHZlcnRleERhdGFbIGkyIF0sIHZlcnRleERhdGFbIGkyICsgMSBdLCB2ZXJ0ZXhEYXRhWyBpMiArIDIgXSk7XHJcblx0XHR2YXIgc2lkZTA6VmVjdG9yM0QgPSBwMS5zdWJ0cmFjdChwMCk7XHJcblx0XHR2YXIgc2lkZTE6VmVjdG9yM0QgPSBwMi5zdWJ0cmFjdChwMCk7XHJcblx0XHRub3JtYWwgPSBzaWRlMC5jcm9zc1Byb2R1Y3Qoc2lkZTEpO1xyXG5cdFx0bm9ybWFsLm5vcm1hbGl6ZSgpO1xyXG5cdFx0cmV0dXJuIG5vcm1hbDtcclxuXHR9XHJcblxyXG5cdHB1YmxpYyBfcEdldENvbGxpc2lvblVWKGluZGV4RGF0YTpBcnJheTxudW1iZXI+IC8qdWludCovLCB1dkRhdGE6QXJyYXk8bnVtYmVyPiwgdHJpYW5nbGVJbmRleDpudW1iZXIsIHY6bnVtYmVyLCB3Om51bWJlciwgdTpudW1iZXIsIHV2T2Zmc2V0Om51bWJlciwgdXZTdHJpZGU6bnVtYmVyKTpQb2ludCAvLyBQUk9URUNURURcclxuXHR7XHJcblx0XHR2YXIgdXY6UG9pbnQgPSBuZXcgUG9pbnQoKTtcclxuXHRcdHZhciB1SW5kZXg6bnVtYmVyID0gaW5kZXhEYXRhWyB0cmlhbmdsZUluZGV4IF0qdXZTdHJpZGUgKyB1dk9mZnNldDtcclxuXHRcdHZhciB1djA6VmVjdG9yM0QgPSBuZXcgVmVjdG9yM0QodXZEYXRhWyB1SW5kZXggXSwgdXZEYXRhWyB1SW5kZXggKyAxIF0pO1xyXG5cdFx0dUluZGV4ID0gaW5kZXhEYXRhWyB0cmlhbmdsZUluZGV4ICsgMSBdKnV2U3RyaWRlICsgdXZPZmZzZXQ7XHJcblx0XHR2YXIgdXYxOlZlY3RvcjNEID0gbmV3IFZlY3RvcjNEKHV2RGF0YVsgdUluZGV4IF0sIHV2RGF0YVsgdUluZGV4ICsgMSBdKTtcclxuXHRcdHVJbmRleCA9IGluZGV4RGF0YVsgdHJpYW5nbGVJbmRleCArIDIgXSp1dlN0cmlkZSArIHV2T2Zmc2V0O1xyXG5cdFx0dmFyIHV2MjpWZWN0b3IzRCA9IG5ldyBWZWN0b3IzRCh1dkRhdGFbIHVJbmRleCBdLCB1dkRhdGFbIHVJbmRleCArIDEgXSk7XHJcblx0XHR1di54ID0gdSp1djAueCArIHYqdXYxLnggKyB3KnV2Mi54O1xyXG5cdFx0dXYueSA9IHUqdXYwLnkgKyB2KnV2MS55ICsgdyp1djIueTtcclxuXHRcdHJldHVybiB1djtcclxuXHR9XHJcblxyXG5cdC8qKlxyXG5cdCAqIEBpbmhlcml0RG9jXHJcblx0ICovXHJcblx0cHVibGljIF9wVGVzdFJlbmRlcmFibGVDb2xsaXNpb24ocmVuZGVyYWJsZTpSZW5kZXJhYmxlQmFzZSwgcGlja2luZ0NvbGxpc2lvblZPOlBpY2tpbmdDb2xsaXNpb25WTywgc2hvcnRlc3RDb2xsaXNpb25EaXN0YW5jZTpudW1iZXIpOmJvb2xlYW5cclxuXHR7XHJcblx0XHR0aHJvdyBuZXcgQWJzdHJhY3RNZXRob2RFcnJvcigpO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogQGluaGVyaXREb2NcclxuXHQgKi9cclxuXHRwdWJsaWMgc2V0TG9jYWxSYXkobG9jYWxQb3NpdGlvbjpWZWN0b3IzRCwgbG9jYWxEaXJlY3Rpb246VmVjdG9yM0QpXHJcblx0e1xyXG5cdFx0dGhpcy5yYXlQb3NpdGlvbiA9IGxvY2FsUG9zaXRpb247XHJcblx0XHR0aGlzLnJheURpcmVjdGlvbiA9IGxvY2FsRGlyZWN0aW9uO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogVGVzdHMgYSA8Y29kZT5CaWxsYm9hcmQ8L2NvZGU+IG9iamVjdCBmb3IgYSBjb2xsaXNpb24gd2l0aCB0aGUgcGlja2luZyByYXkuXHJcblx0ICpcclxuXHQgKiBAcGFyYW0gYmlsbGJvYXJkIFRoZSBiaWxsYm9hcmQgaW5zdGFuY2UgdG8gYmUgdGVzdGVkLlxyXG5cdCAqIEBwYXJhbSBwaWNraW5nQ29sbGlzaW9uVk8gVGhlIGNvbGxpc2lvbiBvYmplY3QgdXNlZCB0byBzdG9yZSB0aGUgY29sbGlzaW9uIHJlc3VsdHNcclxuXHQgKiBAcGFyYW0gc2hvcnRlc3RDb2xsaXNpb25EaXN0YW5jZSBUaGUgY3VycmVudCB2YWx1ZSBvZiB0aGUgc2hvcnRlc3QgZGlzdGFuY2UgdG8gYSBkZXRlY3RlZCBjb2xsaXNpb24gYWxvbmcgdGhlIHJheS5cclxuXHQgKiBAcGFyYW0gZmluZENsb3Nlc3RcclxuXHQgKi9cclxuXHRwdWJsaWMgdGVzdEJpbGxib2FyZENvbGxpc2lvbihiaWxsYm9hcmQ6QmlsbGJvYXJkLCBwaWNraW5nQ29sbGlzaW9uVk86UGlja2luZ0NvbGxpc2lvblZPLCBzaG9ydGVzdENvbGxpc2lvbkRpc3RhbmNlOm51bWJlcilcclxuXHR7XHJcblx0XHR0aGlzLnNldExvY2FsUmF5KHBpY2tpbmdDb2xsaXNpb25WTy5sb2NhbFJheVBvc2l0aW9uLCBwaWNraW5nQ29sbGlzaW9uVk8ubG9jYWxSYXlEaXJlY3Rpb24pO1xyXG5cdFx0cGlja2luZ0NvbGxpc2lvblZPLnJlbmRlcmFibGVPd25lciA9IG51bGw7XHJcblxyXG5cdFx0aWYgKHRoaXMuX3BUZXN0UmVuZGVyYWJsZUNvbGxpc2lvbig8UmVuZGVyYWJsZUJhc2U+IHRoaXMuX2JpbGxib2FyZFJlbmRlcmFibGVQb29sLmdldEl0ZW0oYmlsbGJvYXJkKSwgcGlja2luZ0NvbGxpc2lvblZPLCBzaG9ydGVzdENvbGxpc2lvbkRpc3RhbmNlKSkge1xyXG5cdFx0XHRzaG9ydGVzdENvbGxpc2lvbkRpc3RhbmNlID0gcGlja2luZ0NvbGxpc2lvblZPLnJheUVudHJ5RGlzdGFuY2U7XHJcblxyXG5cdFx0XHRwaWNraW5nQ29sbGlzaW9uVk8ucmVuZGVyYWJsZU93bmVyID0gYmlsbGJvYXJkO1xyXG5cclxuXHRcdFx0cmV0dXJuIHRydWU7XHJcblx0XHR9XHJcblxyXG5cdFx0cmV0dXJuIGZhbHNlO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogVGVzdHMgYSA8Y29kZT5NZXNoPC9jb2RlPiBvYmplY3QgZm9yIGEgY29sbGlzaW9uIHdpdGggdGhlIHBpY2tpbmcgcmF5LlxyXG5cdCAqXHJcblx0ICogQHBhcmFtIG1lc2ggVGhlIG1lc2ggaW5zdGFuY2UgdG8gYmUgdGVzdGVkLlxyXG5cdCAqIEBwYXJhbSBwaWNraW5nQ29sbGlzaW9uVk8gVGhlIGNvbGxpc2lvbiBvYmplY3QgdXNlZCB0byBzdG9yZSB0aGUgY29sbGlzaW9uIHJlc3VsdHNcclxuXHQgKiBAcGFyYW0gc2hvcnRlc3RDb2xsaXNpb25EaXN0YW5jZSBUaGUgY3VycmVudCB2YWx1ZSBvZiB0aGUgc2hvcnRlc3QgZGlzdGFuY2UgdG8gYSBkZXRlY3RlZCBjb2xsaXNpb24gYWxvbmcgdGhlIHJheS5cclxuXHQgKiBAcGFyYW0gZmluZENsb3Nlc3RcclxuXHQgKi9cclxuXHRwdWJsaWMgdGVzdE1lc2hDb2xsaXNpb24obWVzaDpNZXNoLCBwaWNraW5nQ29sbGlzaW9uVk86UGlja2luZ0NvbGxpc2lvblZPLCBzaG9ydGVzdENvbGxpc2lvbkRpc3RhbmNlOm51bWJlciwgZmluZENsb3Nlc3Q6Ym9vbGVhbik6Ym9vbGVhblxyXG5cdHtcclxuXHRcdHRoaXMuc2V0TG9jYWxSYXkocGlja2luZ0NvbGxpc2lvblZPLmxvY2FsUmF5UG9zaXRpb24sIHBpY2tpbmdDb2xsaXNpb25WTy5sb2NhbFJheURpcmVjdGlvbik7XHJcblx0XHRwaWNraW5nQ29sbGlzaW9uVk8ucmVuZGVyYWJsZU93bmVyID0gbnVsbDtcclxuXHJcblx0XHR2YXIgc3ViTWVzaDpJU3ViTWVzaDtcclxuXHJcblx0XHR2YXIgbGVuOm51bWJlciA9IG1lc2guc3ViTWVzaGVzLmxlbmd0aDtcclxuXHRcdGZvciAodmFyIGk6bnVtYmVyID0gMDsgaSA8IGxlbjsgKytpKSB7XHJcblx0XHRcdHN1Yk1lc2ggPSBtZXNoLnN1Yk1lc2hlc1tpXTtcclxuXHJcblx0XHRcdGlmICh0aGlzLl9wVGVzdFJlbmRlcmFibGVDb2xsaXNpb24oPFJlbmRlcmFibGVCYXNlPiB0aGlzLl9zdWJNZXNoUmVuZGVyYWJsZVBvb2wuZ2V0SXRlbShzdWJNZXNoKSwgcGlja2luZ0NvbGxpc2lvblZPLCBzaG9ydGVzdENvbGxpc2lvbkRpc3RhbmNlKSkge1xyXG5cdFx0XHRcdHNob3J0ZXN0Q29sbGlzaW9uRGlzdGFuY2UgPSBwaWNraW5nQ29sbGlzaW9uVk8ucmF5RW50cnlEaXN0YW5jZTtcclxuXHJcblx0XHRcdFx0cGlja2luZ0NvbGxpc2lvblZPLnJlbmRlcmFibGVPd25lciA9IHN1Yk1lc2g7XHJcblxyXG5cdFx0XHRcdGlmICghZmluZENsb3Nlc3QpXHJcblx0XHRcdFx0XHRyZXR1cm4gdHJ1ZTtcclxuXHRcdFx0fVxyXG5cdFx0fVxyXG5cclxuXHRcdHJldHVybiBwaWNraW5nQ29sbGlzaW9uVk8ucmVuZGVyYWJsZU93bmVyICE9IG51bGw7XHJcblx0fVxyXG59XHJcblxyXG5leHBvcnQgPSBQaWNraW5nQ29sbGlkZXJCYXNlOyJdfQ==