var Point = require("awayjs-core/lib/geom/Point");
var Vector3D = require("awayjs-core/lib/geom/Vector3D");
var AbstractMethodError = require("awayjs-core/lib/errors/AbstractMethodError");
var RenderablePool = require("awayjs-display/lib/pool/RenderablePool");
var BillboardRenderable = require("awayjs-renderergl/lib/pool/BillboardRenderable");
var TriangleSubMeshRenderable = require("awayjs-renderergl/lib/pool/TriangleSubMeshRenderable");
/**
 * An abstract base class for all picking collider classes. It should not be instantiated directly.
 *
 * @class away.pick.PickingColliderBase
 */
var PickingColliderBase = (function () {
    function PickingColliderBase() {
        this._billboardRenderablePool = RenderablePool.getPool(BillboardRenderable);
        this._subMeshRenderablePool = RenderablePool.getPool(TriangleSubMeshRenderable);
    }
    PickingColliderBase.prototype._pPetCollisionNormal = function (indexData /*uint*/, vertexData, triangleIndex) {
        var normal = new Vector3D();
        var i0 = indexData[triangleIndex] * 3;
        var i1 = indexData[triangleIndex + 1] * 3;
        var i2 = indexData[triangleIndex + 2] * 3;
        var p0 = new Vector3D(vertexData[i0], vertexData[i0 + 1], vertexData[i0 + 2]);
        var p1 = new Vector3D(vertexData[i1], vertexData[i1 + 1], vertexData[i1 + 2]);
        var p2 = new Vector3D(vertexData[i2], vertexData[i2 + 1], vertexData[i2 + 2]);
        var side0 = p1.subtract(p0);
        var side1 = p2.subtract(p0);
        normal = side0.crossProduct(side1);
        normal.normalize();
        return normal;
    };
    PickingColliderBase.prototype._pGetCollisionUV = function (indexData /*uint*/, uvData, triangleIndex, v, w, u, uvOffset, uvStride) {
        var uv = new Point();
        var uIndex = indexData[triangleIndex] * uvStride + uvOffset;
        var uv0 = new Vector3D(uvData[uIndex], uvData[uIndex + 1]);
        uIndex = indexData[triangleIndex + 1] * uvStride + uvOffset;
        var uv1 = new Vector3D(uvData[uIndex], uvData[uIndex + 1]);
        uIndex = indexData[triangleIndex + 2] * uvStride + uvOffset;
        var uv2 = new Vector3D(uvData[uIndex], uvData[uIndex + 1]);
        uv.x = u * uv0.x + v * uv1.x + w * uv2.x;
        uv.y = u * uv0.y + v * uv1.y + w * uv2.y;
        return uv;
    };
    /**
     * @inheritDoc
     */
    PickingColliderBase.prototype._pTestRenderableCollision = function (renderable, pickingCollisionVO, shortestCollisionDistance) {
        throw new AbstractMethodError();
    };
    /**
     * @inheritDoc
     */
    PickingColliderBase.prototype.setLocalRay = function (localPosition, localDirection) {
        this.rayPosition = localPosition;
        this.rayDirection = localDirection;
    };
    /**
     * Tests a <code>Billboard</code> object for a collision with the picking ray.
     *
     * @param billboard The billboard instance to be tested.
     * @param pickingCollisionVO The collision object used to store the collision results
     * @param shortestCollisionDistance The current value of the shortest distance to a detected collision along the ray.
     * @param findClosest
     */
    PickingColliderBase.prototype.testBillboardCollision = function (billboard, pickingCollisionVO, shortestCollisionDistance) {
        this.setLocalRay(pickingCollisionVO.localRayPosition, pickingCollisionVO.localRayDirection);
        pickingCollisionVO.materialOwner = null;
        if (this._pTestRenderableCollision(this._billboardRenderablePool.getItem(billboard), pickingCollisionVO, shortestCollisionDistance)) {
            shortestCollisionDistance = pickingCollisionVO.rayEntryDistance;
            pickingCollisionVO.materialOwner = billboard;
            return true;
        }
        return false;
    };
    /**
     * Tests a <code>Mesh</code> object for a collision with the picking ray.
     *
     * @param mesh The mesh instance to be tested.
     * @param pickingCollisionVO The collision object used to store the collision results
     * @param shortestCollisionDistance The current value of the shortest distance to a detected collision along the ray.
     * @param findClosest
     */
    PickingColliderBase.prototype.testMeshCollision = function (mesh, pickingCollisionVO, shortestCollisionDistance, findClosest) {
        this.setLocalRay(pickingCollisionVO.localRayPosition, pickingCollisionVO.localRayDirection);
        pickingCollisionVO.materialOwner = null;
        var subMesh;
        var len = mesh.subMeshes.length;
        for (var i = 0; i < len; ++i) {
            subMesh = mesh.subMeshes[i];
            if (this._pTestRenderableCollision(this._subMeshRenderablePool.getItem(subMesh), pickingCollisionVO, shortestCollisionDistance)) {
                shortestCollisionDistance = pickingCollisionVO.rayEntryDistance;
                pickingCollisionVO.materialOwner = subMesh;
                if (!findClosest)
                    return true;
            }
        }
        return pickingCollisionVO.materialOwner != null;
    };
    return PickingColliderBase;
})();
module.exports = PickingColliderBase;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9waWNrL3BpY2tpbmdjb2xsaWRlcmJhc2UudHMiXSwibmFtZXMiOlsiUGlja2luZ0NvbGxpZGVyQmFzZSIsIlBpY2tpbmdDb2xsaWRlckJhc2UuY29uc3RydWN0b3IiLCJQaWNraW5nQ29sbGlkZXJCYXNlLl9wUGV0Q29sbGlzaW9uTm9ybWFsIiwiUGlja2luZ0NvbGxpZGVyQmFzZS5fcEdldENvbGxpc2lvblVWIiwiUGlja2luZ0NvbGxpZGVyQmFzZS5fcFRlc3RSZW5kZXJhYmxlQ29sbGlzaW9uIiwiUGlja2luZ0NvbGxpZGVyQmFzZS5zZXRMb2NhbFJheSIsIlBpY2tpbmdDb2xsaWRlckJhc2UudGVzdEJpbGxib2FyZENvbGxpc2lvbiIsIlBpY2tpbmdDb2xsaWRlckJhc2UudGVzdE1lc2hDb2xsaXNpb24iXSwibWFwcGluZ3MiOiJBQUFBLElBQU8sS0FBSyxXQUFpQiw0QkFBNEIsQ0FBQyxDQUFDO0FBQzNELElBQU8sUUFBUSxXQUFpQiwrQkFBK0IsQ0FBQyxDQUFDO0FBQ2pFLElBQU8sbUJBQW1CLFdBQWMsNENBQTRDLENBQUMsQ0FBQztBQUl0RixJQUFPLGNBQWMsV0FBZSx3Q0FBd0MsQ0FBQyxDQUFDO0FBSTlFLElBQU8sbUJBQW1CLFdBQWMsZ0RBQWdELENBQUMsQ0FBQztBQUUxRixJQUFPLHlCQUF5QixXQUFZLHNEQUFzRCxDQUFDLENBQUM7QUFFcEcsQUFLQTs7OztHQURHO0lBQ0csbUJBQW1CO0lBUXhCQSxTQVJLQSxtQkFBbUJBO1FBVXZCQyxJQUFJQSxDQUFDQSx3QkFBd0JBLEdBQUdBLGNBQWNBLENBQUNBLE9BQU9BLENBQUNBLG1CQUFtQkEsQ0FBQ0EsQ0FBQ0E7UUFDNUVBLElBQUlBLENBQUNBLHNCQUFzQkEsR0FBR0EsY0FBY0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EseUJBQXlCQSxDQUFDQSxDQUFDQTtJQUNqRkEsQ0FBQ0E7SUFFTUQsa0RBQW9CQSxHQUEzQkEsVUFBNEJBLFNBQVNBLENBQWVBLFFBQURBLEFBQVNBLEVBQUVBLFVBQXdCQSxFQUFFQSxhQUFvQkE7UUFFM0dFLElBQUlBLE1BQU1BLEdBQVlBLElBQUlBLFFBQVFBLEVBQUVBLENBQUNBO1FBQ3JDQSxJQUFJQSxFQUFFQSxHQUFVQSxTQUFTQSxDQUFFQSxhQUFhQSxDQUFFQSxHQUFDQSxDQUFDQSxDQUFDQTtRQUM3Q0EsSUFBSUEsRUFBRUEsR0FBVUEsU0FBU0EsQ0FBRUEsYUFBYUEsR0FBR0EsQ0FBQ0EsQ0FBRUEsR0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDakRBLElBQUlBLEVBQUVBLEdBQVVBLFNBQVNBLENBQUVBLGFBQWFBLEdBQUdBLENBQUNBLENBQUVBLEdBQUNBLENBQUNBLENBQUNBO1FBQ2pEQSxJQUFJQSxFQUFFQSxHQUFZQSxJQUFJQSxRQUFRQSxDQUFDQSxVQUFVQSxDQUFFQSxFQUFFQSxDQUFFQSxFQUFFQSxVQUFVQSxDQUFFQSxFQUFFQSxHQUFHQSxDQUFDQSxDQUFFQSxFQUFFQSxVQUFVQSxDQUFFQSxFQUFFQSxHQUFHQSxDQUFDQSxDQUFFQSxDQUFDQSxDQUFDQTtRQUM3RkEsSUFBSUEsRUFBRUEsR0FBWUEsSUFBSUEsUUFBUUEsQ0FBQ0EsVUFBVUEsQ0FBRUEsRUFBRUEsQ0FBRUEsRUFBRUEsVUFBVUEsQ0FBRUEsRUFBRUEsR0FBR0EsQ0FBQ0EsQ0FBRUEsRUFBRUEsVUFBVUEsQ0FBRUEsRUFBRUEsR0FBR0EsQ0FBQ0EsQ0FBRUEsQ0FBQ0EsQ0FBQ0E7UUFDN0ZBLElBQUlBLEVBQUVBLEdBQVlBLElBQUlBLFFBQVFBLENBQUNBLFVBQVVBLENBQUVBLEVBQUVBLENBQUVBLEVBQUVBLFVBQVVBLENBQUVBLEVBQUVBLEdBQUdBLENBQUNBLENBQUVBLEVBQUVBLFVBQVVBLENBQUVBLEVBQUVBLEdBQUdBLENBQUNBLENBQUVBLENBQUNBLENBQUNBO1FBQzdGQSxJQUFJQSxLQUFLQSxHQUFZQSxFQUFFQSxDQUFDQSxRQUFRQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQTtRQUNyQ0EsSUFBSUEsS0FBS0EsR0FBWUEsRUFBRUEsQ0FB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QUFPQSxDQUFDQSxPQUFPQSxDQUFDQSxFQUFFQSxrQkFBa0JBLEVBQUVBLHlCQUF5QkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ2xKQSx5QkFBeUJBLEdBQUdBLGtCQUFrQkEsQ0FBQ0EsZ0JBQWdCQSxDQUFDQTtnQkFFaEVBLGtCQUFrQkEsQ0FBQ0EsYUFBYUEsR0FBR0EsT0FBT0EsQ0FBQ0E7Z0JBRTNDQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxXQUFXQSxDQUFDQTtvQkFDaEJBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBO1lBQ2RBLENBQUNBO1FBQ0ZBLENBQUNBO1FBRURBLE1BQU1BLENBQUNBLGtCQUFrQkEsQ0FBQ0EsYUFBYUEsSUFBSUEsSUFBSUEsQ0FBQ0E7SUFDakRBLENBQUNBO0lBQ0ZQLDBCQUFDQTtBQUFEQSxDQXBIQSxBQW9IQ0EsSUFBQTtBQUVELEFBQTZCLGlCQUFwQixtQkFBbUIsQ0FBQyIsImZpbGUiOiJwaWNrL1BpY2tpbmdDb2xsaWRlckJhc2UuanMiLCJzb3VyY2VSb290IjoiLi4vIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFBvaW50XHRcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvZ2VvbS9Qb2ludFwiKTtcbmltcG9ydCBWZWN0b3IzRFx0XHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2dlb20vVmVjdG9yM0RcIik7XG5pbXBvcnQgQWJzdHJhY3RNZXRob2RFcnJvclx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2Vycm9ycy9BYnN0cmFjdE1ldGhvZEVycm9yXCIpO1xuXG5pbXBvcnQgSVN1Yk1lc2hcdFx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9iYXNlL0lTdWJNZXNoXCIpO1xuaW1wb3J0IFBpY2tpbmdDb2xsaXNpb25WT1x0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL3BpY2svUGlja2luZ0NvbGxpc2lvblZPXCIpO1xuaW1wb3J0IFJlbmRlcmFibGVQb29sXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9wb29sL1JlbmRlcmFibGVQb29sXCIpO1xuaW1wb3J0IEJpbGxib2FyZFx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9lbnRpdGllcy9CaWxsYm9hcmRcIik7XG5pbXBvcnQgTWVzaFx0XHRcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvZW50aXRpZXMvTWVzaFwiKTtcblxuaW1wb3J0IEJpbGxib2FyZFJlbmRlcmFibGVcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9wb29sL0JpbGxib2FyZFJlbmRlcmFibGVcIik7XG5pbXBvcnQgUmVuZGVyYWJsZUJhc2VcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL3Bvb2wvUmVuZGVyYWJsZUJhc2VcIik7XG5pbXBvcnQgVHJpYW5nbGVTdWJNZXNoUmVuZGVyYWJsZVx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvcG9vbC9UcmlhbmdsZVN1Yk1lc2hSZW5kZXJhYmxlXCIpO1xuXG4vKipcbiAqIEFuIGFic3RyYWN0IGJhc2UgY2xhc3MgZm9yIGFsbCBwaWNraW5nIGNvbGxpZGVyIGNsYXNzZXMuIEl0IHNob3VsZCBub3QgYmUgaW5zdGFudGlhdGVkIGRpcmVjdGx5LlxuICpcbiAqIEBjbGFzcyBhd2F5LnBpY2suUGlja2luZ0NvbGxpZGVyQmFzZVxuICovXG5jbGFzcyBQaWNraW5nQ29sbGlkZXJCYXNlXG57XG5cdHByaXZhdGUgX2JpbGxib2FyZFJlbmRlcmFibGVQb29sOlJlbmRlcmFibGVQb29sO1xuXHRwcml2YXRlIF9zdWJNZXNoUmVuZGVyYWJsZVBvb2w6UmVuZGVyYWJsZVBvb2w7XG5cblx0cHVibGljIHJheVBvc2l0aW9uOlZlY3RvcjNEO1xuXHRwdWJsaWMgcmF5RGlyZWN0aW9uOlZlY3RvcjNEO1xuXG5cdGNvbnN0cnVjdG9yKClcblx0e1xuXHRcdHRoaXMuX2JpbGxib2FyZFJlbmRlcmFibGVQb29sID0gUmVuZGVyYWJsZVBvb2wuZ2V0UG9vbChCaWxsYm9hcmRSZW5kZXJhYmxlKTtcblx0XHR0aGlzLl9zdWJNZXNoUmVuZGVyYWJsZVBvb2wgPSBSZW5kZXJhYmxlUG9vbC5nZXRQb29sKFRyaWFuZ2xlU3ViTWVzaFJlbmRlcmFibGUpO1xuXHR9XG5cblx0cHVibGljIF9wUGV0Q29sbGlzaW9uTm9ybWFsKGluZGV4RGF0YTpBcnJheTxudW1iZXI+IC8qdWludCovLCB2ZXJ0ZXhEYXRhOkFycmF5PG51bWJlcj4sIHRyaWFuZ2xlSW5kZXg6bnVtYmVyKTpWZWN0b3IzRCAvLyBQUk9URUNURURcblx0e1xuXHRcdHZhciBub3JtYWw6VmVjdG9yM0QgPSBuZXcgVmVjdG9yM0QoKTtcblx0XHR2YXIgaTA6bnVtYmVyID0gaW5kZXhEYXRhWyB0cmlhbmdsZUluZGV4IF0qMztcblx0XHR2YXIgaTE6bnVtYmVyID0gaW5kZXhEYXRhWyB0cmlhbmdsZUluZGV4ICsgMSBdKjM7XG5cdFx0dmFyIGkyOm51bWJlciA9IGluZGV4RGF0YVsgdHJpYW5nbGVJbmRleCArIDIgXSozO1xuXHRcdHZhciBwMDpWZWN0b3IzRCA9IG5ldyBWZWN0b3IzRCh2ZXJ0ZXhEYXRhWyBpMCBdLCB2ZXJ0ZXhEYXRhWyBpMCArIDEgXSwgdmVydGV4RGF0YVsgaTAgKyAyIF0pO1xuXHRcdHZhciBwMTpWZWN0b3IzRCA9IG5ldyBWZWN0b3IzRCh2ZXJ0ZXhEYXRhWyBpMSBdLCB2ZXJ0ZXhEYXRhWyBpMSArIDEgXSwgdmVydGV4RGF0YVsgaTEgKyAyIF0pO1xuXHRcdHZhciBwMjpWZWN0b3IzRCA9IG5ldyBWZWN0b3IzRCh2ZXJ0ZXhEYXRhWyBpMiBdLCB2ZXJ0ZXhEYXRhWyBpMiArIDEgXSwgdmVydGV4RGF0YVsgaTIgKyAyIF0pO1xuXHRcdHZhciBzaWRlMDpWZWN0b3IzRCA9IHAxLnN1YnRyYWN0KHAwKTtcblx0XHR2YXIgc2lkZTE6VmVjdG9yM0QgPSBwMi5zdWJ0cmFjdChwMCk7XG5cdFx0bm9ybWFsID0gc2lkZTAuY3Jvc3NQcm9kdWN0KHNpZGUxKTtcblx0XHRub3JtYWwubm9ybWFsaXplKCk7XG5cdFx0cmV0dXJuIG5vcm1hbDtcblx0fVxuXG5cdHB1YmxpYyBfcEdldENvbGxpc2lvblVWKGluZGV4RGF0YTpBcnJheTxudW1iZXI+IC8qdWludCovLCB1dkRhdGE6QXJyYXk8bnVtYmVyPiwgdHJpYW5nbGVJbmRleDpudW1iZXIsIHY6bnVtYmVyLCB3Om51bWJlciwgdTpudW1iZXIsIHV2T2Zmc2V0Om51bWJlciwgdXZTdHJpZGU6bnVtYmVyKTpQb2ludCAvLyBQUk9URUNURURcblx0e1xuXHRcdHZhciB1djpQb2ludCA9IG5ldyBQb2ludCgpO1xuXHRcdHZhciB1SW5kZXg6bnVtYmVyID0gaW5kZXhEYXRhWyB0cmlhbmdsZUluZGV4IF0qdXZTdHJpZGUgKyB1dk9mZnNldDtcblx0XHR2YXIgdXYwOlZlY3RvcjNEID0gbmV3IFZlY3RvcjNEKHV2RGF0YVsgdUluZGV4IF0sIHV2RGF0YVsgdUluZGV4ICsgMSBdKTtcblx0XHR1SW5kZXggPSBpbmRleERhdGFbIHRyaWFuZ2xlSW5kZXggKyAxIF0qdXZTdHJpZGUgKyB1dk9mZnNldDtcblx0XHR2YXIgdXYxOlZlY3RvcjNEID0gbmV3IFZlY3RvcjNEKHV2RGF0YVsgdUluZGV4IF0sIHV2RGF0YVsgdUluZGV4ICsgMSBdKTtcblx0XHR1SW5kZXggPSBpbmRleERhdGFbIHRyaWFuZ2xlSW5kZXggKyAyIF0qdXZTdHJpZGUgKyB1dk9mZnNldDtcblx0XHR2YXIgdXYyOlZlY3RvcjNEID0gbmV3IFZlY3RvcjNEKHV2RGF0YVsgdUluZGV4IF0sIHV2RGF0YVsgdUluZGV4ICsgMSBdKTtcblx0XHR1di54ID0gdSp1djAueCArIHYqdXYxLnggKyB3KnV2Mi54O1xuXHRcdHV2LnkgPSB1KnV2MC55ICsgdip1djEueSArIHcqdXYyLnk7XG5cdFx0cmV0dXJuIHV2O1xuXHR9XG5cblx0LyoqXG5cdCAqIEBpbmhlcml0RG9jXG5cdCAqL1xuXHRwdWJsaWMgX3BUZXN0UmVuZGVyYWJsZUNvbGxpc2lvbihyZW5kZXJhYmxlOlJlbmRlcmFibGVCYXNlLCBwaWNraW5nQ29sbGlzaW9uVk86UGlja2luZ0NvbGxpc2lvblZPLCBzaG9ydGVzdENvbGxpc2lvbkRpc3RhbmNlOm51bWJlcik6Ym9vbGVhblxuXHR7XG5cdFx0dGhyb3cgbmV3IEFic3RyYWN0TWV0aG9kRXJyb3IoKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBAaW5oZXJpdERvY1xuXHQgKi9cblx0cHVibGljIHNldExvY2FsUmF5KGxvY2FsUG9zaXRpb246VmVjdG9yM0QsIGxvY2FsRGlyZWN0aW9uOlZlY3RvcjNEKVxuXHR7XG5cdFx0dGhpcy5yYXlQb3NpdGlvbiA9IGxvY2FsUG9zaXRpb247XG5cdFx0dGhpcy5yYXlEaXJlY3Rpb24gPSBsb2NhbERpcmVjdGlvbjtcblx0fVxuXG5cdC8qKlxuXHQgKiBUZXN0cyBhIDxjb2RlPkJpbGxib2FyZDwvY29kZT4gb2JqZWN0IGZvciBhIGNvbGxpc2lvbiB3aXRoIHRoZSBwaWNraW5nIHJheS5cblx0ICpcblx0ICogQHBhcmFtIGJpbGxib2FyZCBUaGUgYmlsbGJvYXJkIGluc3RhbmNlIHRvIGJlIHRlc3RlZC5cblx0ICogQHBhcmFtIHBpY2tpbmdDb2xsaXNpb25WTyBUaGUgY29sbGlzaW9uIG9iamVjdCB1c2VkIHRvIHN0b3JlIHRoZSBjb2xsaXNpb24gcmVzdWx0c1xuXHQgKiBAcGFyYW0gc2hvcnRlc3RDb2xsaXNpb25EaXN0YW5jZSBUaGUgY3VycmVudCB2YWx1ZSBvZiB0aGUgc2hvcnRlc3QgZGlzdGFuY2UgdG8gYSBkZXRlY3RlZCBjb2xsaXNpb24gYWxvbmcgdGhlIHJheS5cblx0ICogQHBhcmFtIGZpbmRDbG9zZXN0XG5cdCAqL1xuXHRwdWJsaWMgdGVzdEJpbGxib2FyZENvbGxpc2lvbihiaWxsYm9hcmQ6QmlsbGJvYXJkLCBwaWNraW5nQ29sbGlzaW9uVk86UGlja2luZ0NvbGxpc2lvblZPLCBzaG9ydGVzdENvbGxpc2lvbkRpc3RhbmNlOm51bWJlcilcblx0e1xuXHRcdHRoaXMuc2V0TG9jYWxSYXkocGlja2luZ0NvbGxpc2lvblZPLmxvY2FsUmF5UG9zaXRpb24sIHBpY2tpbmdDb2xsaXNpb25WTy5sb2NhbFJheURpcmVjdGlvbik7XG5cdFx0cGlja2luZ0NvbGxpc2lvblZPLm1hdGVyaWFsT3duZXIgPSBudWxsO1xuXG5cdFx0aWYgKHRoaXMuX3BUZXN0UmVuZGVyYWJsZUNvbGxpc2lvbig8UmVuZGVyYWJsZUJhc2U+IHRoaXMuX2JpbGxib2FyZFJlbmRlcmFibGVQb29sLmdldEl0ZW0oYmlsbGJvYXJkKSwgcGlja2luZ0NvbGxpc2lvblZPLCBzaG9ydGVzdENvbGxpc2lvbkRpc3RhbmNlKSkge1xuXHRcdFx0c2hvcnRlc3RDb2xsaXNpb25EaXN0YW5jZSA9IHBpY2tpbmdDb2xsaXNpb25WTy5yYXlFbnRyeURpc3RhbmNlO1xuXG5cdFx0XHRwaWNraW5nQ29sbGlzaW9uVk8ubWF0ZXJpYWxPd25lciA9IGJpbGxib2FyZDtcblxuXHRcdFx0cmV0dXJuIHRydWU7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIGZhbHNlO1xuXHR9XG5cblx0LyoqXG5cdCAqIFRlc3RzIGEgPGNvZGU+TWVzaDwvY29kZT4gb2JqZWN0IGZvciBhIGNvbGxpc2lvbiB3aXRoIHRoZSBwaWNraW5nIHJheS5cblx0ICpcblx0ICogQHBhcmFtIG1lc2ggVGhlIG1lc2ggaW5zdGFuY2UgdG8gYmUgdGVzdGVkLlxuXHQgKiBAcGFyYW0gcGlja2luZ0NvbGxpc2lvblZPIFRoZSBjb2xsaXNpb24gb2JqZWN0IHVzZWQgdG8gc3RvcmUgdGhlIGNvbGxpc2lvbiByZXN1bHRzXG5cdCAqIEBwYXJhbSBzaG9ydGVzdENvbGxpc2lvbkRpc3RhbmNlIFRoZSBjdXJyZW50IHZhbHVlIG9mIHRoZSBzaG9ydGVzdCBkaXN0YW5jZSB0byBhIGRldGVjdGVkIGNvbGxpc2lvbiBhbG9uZyB0aGUgcmF5LlxuXHQgKiBAcGFyYW0gZmluZENsb3Nlc3Rcblx0ICovXG5cdHB1YmxpYyB0ZXN0TWVzaENvbGxpc2lvbihtZXNoOk1lc2gsIHBpY2tpbmdDb2xsaXNpb25WTzpQaWNraW5nQ29sbGlzaW9uVk8sIHNob3J0ZXN0Q29sbGlzaW9uRGlzdGFuY2U6bnVtYmVyLCBmaW5kQ2xvc2VzdDpib29sZWFuKTpib29sZWFuXG5cdHtcblx0XHR0aGlzLnNldExvY2FsUmF5KHBpY2tpbmdDb2xsaXNpb25WTy5sb2NhbFJheVBvc2l0aW9uLCBwaWNraW5nQ29sbGlzaW9uVk8ubG9jYWxSYXlEaXJlY3Rpb24pO1xuXHRcdHBpY2tpbmdDb2xsaXNpb25WTy5tYXRlcmlhbE93bmVyID0gbnVsbDtcblxuXHRcdHZhciBzdWJNZXNoOklTdWJNZXNoO1xuXG5cdFx0dmFyIGxlbjpudW1iZXIgPSBtZXNoLnN1Yk1lc2hlcy5sZW5ndGg7XG5cdFx0Zm9yICh2YXIgaTpudW1iZXIgPSAwOyBpIDwgbGVuOyArK2kpIHtcblx0XHRcdHN1Yk1lc2ggPSBtZXNoLnN1Yk1lc2hlc1tpXTtcblxuXHRcdFx0aWYgKHRoaXMuX3BUZXN0UmVuZGVyYWJsZUNvbGxpc2lvbig8UmVuZGVyYWJsZUJhc2U+IHRoaXMuX3N1Yk1lc2hSZW5kZXJhYmxlUG9vbC5nZXRJdGVtKHN1Yk1lc2gpLCBwaWNraW5nQ29sbGlzaW9uVk8sIHNob3J0ZXN0Q29sbGlzaW9uRGlzdGFuY2UpKSB7XG5cdFx0XHRcdHNob3J0ZXN0Q29sbGlzaW9uRGlzdGFuY2UgPSBwaWNraW5nQ29sbGlzaW9uVk8ucmF5RW50cnlEaXN0YW5jZTtcblxuXHRcdFx0XHRwaWNraW5nQ29sbGlzaW9uVk8ubWF0ZXJpYWxPd25lciA9IHN1Yk1lc2g7XG5cblx0XHRcdFx0aWYgKCFmaW5kQ2xvc2VzdClcblx0XHRcdFx0XHRyZXR1cm4gdHJ1ZTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4gcGlja2luZ0NvbGxpc2lvblZPLm1hdGVyaWFsT3duZXIgIT0gbnVsbDtcblx0fVxufVxuXG5leHBvcnQgPSBQaWNraW5nQ29sbGlkZXJCYXNlOyJdfQ==