var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var Matrix3DUtils = require("awayjs-core/lib/geom/Matrix3DUtils");
var CurveSubGeometry = require("awayjs-display/lib/base/CurveSubGeometry");
var ContextGLProgramType = require("awayjs-stagegl/lib/base/ContextGLProgramType");
var RenderableBase = require("awayjs-renderergl/lib/pool/RenderableBase");
/**
 * @class away.pool.TriangleSubMeshRenderable
 */
var CurveSubMeshRenderable = (function (_super) {
    __extends(CurveSubMeshRenderable, _super);
    /**
     * //TODO
     *
     * @param pool
     * @param subMesh
     * @param level
     * @param indexOffset
     */
    function CurveSubMeshRenderable(pool, subMesh, stage, level, indexOffset) {
        if (level === void 0) { level = 0; }
        if (indexOffset === void 0) { indexOffset = 0; }
        _super.call(this, pool, subMesh.parentMesh, subMesh, subMesh.material, stage, level, indexOffset);
        this._constants = new Array(0, 0, 0, 0);
        this.subMesh = subMesh;
    }
    /**
     *
     * @returns {SubGeometryBase}
     * @protected
     */
    CurveSubMeshRenderable.prototype._pGetSubGeometry = function () {
        var subGeometry;
        if (this.subMesh.animator)
            subGeometry = this.subMesh.animator.getRenderableSubGeometry(this, this.subMesh.subGeometry);
        else
            subGeometry = this.subMesh.subGeometry;
        this._pVertexDataDirty[CurveSubGeometry.POSITION_DATA] = true;
        if (subGeometry.curves)
            this._pVertexDataDirty[CurveSubGeometry.CURVE_DATA] = true;
        if (subGeometry.uvs)
            this._pVertexDataDirty[CurveSubGeometry.UV_DATA] = true;
        return subGeometry;
    };
    CurveSubMeshRenderable._iIncludeDependencies = function (shaderObject) {
        shaderObject.localPosDependencies++;
    };
    CurveSubMeshRenderable._iGetVertexCode = function (shaderObject, registerCache, sharedRegisters) {
        var code = "";
        //get the projection coordinates
        var position = (shaderObject.globalPosDependencies > 0) ? sharedRegisters.globalPositionVertex : sharedRegisters.localPosition;
        //reserving vertex constants for projection matrix
        var viewMatrixReg = registerCache.getFreeVertexConstant();
        registerCache.getFreeVertexConstant();
        registerCache.getFreeVertexConstant();
        registerCache.getFreeVertexConstant();
        shaderObject.viewMatrixIndex = viewMatrixReg.index * 4;
        if (shaderObject.projectionDependencies > 0) {
            sharedRegisters.projectionFragment = registerCache.getFreeVarying();
            var temp = registerCache.getFreeVertexVectorTemp();
            code += "m44 " + temp + ", " + position + ".xyw, " + viewMatrixReg + "\n" + "mov " + sharedRegisters.projectionFragment + ", " + temp + "\n" + "mov op, " + temp + "\n";
        }
        else {
            code += "mov v2 va1 \n";
            code += "m44 op, " + position + ".xyw, " + viewMatrixReg + "\n";
        }
        return code;
    };
    /**
     * @inheritDoc
     */
    CurveSubMeshRenderable._iGetFragmentCode = function (shaderObject, registerCache, sharedRegisters) {
        var uv = "v2"; //sharedRegisters.uvVarying //shaderObject.uvTarget;
        var pos = sharedRegisters.localPositionVarying;
        var out = sharedRegisters.shadedTarget; //registerCache.fragmentOutputRegister.toString();
        var free = registerCache.getFreeFragmentVectorTemp();
        var d = free + ".x"; //registerCache.getFreeFragmentConstant().toString();
        var less = free + ".y"; //registerCache.getFreeFragmentSingleTemp().toString();
        var half = free + ".z"; //registerCache.getFreeFragmentSingleTemp().toString();
        var code = "";
        code += "mov " + d + " " + uv + ".x\n";
        code += "mul " + d + " " + d + " " + d + "\n";
        code += "sub " + d + " " + d + " " + uv + ".y\n";
        // code += "mov "+ out + " " + sharedRegisters.uvVarying+"\n";
        // code += "mul "+ d + " " + d + " " + less + "\n";
        //code += "sub "+ d + " " + d + " " + pos + ".z " + "\n";
        code += "mul " + d + " " + d + " " + pos + ".z " + "\n";
        code += "mov " + half + " fc7.x\n";
        code += "slt " + less + " " + d + " " + half + "\n";
        code += "mul " + d + " " + d + " " + less + "\n";
        code += "abs " + d + " " + d + "\n";
        // code += "kil " + less + "\n";
        //  code += "sub "+ less + " " + less + " " + pos + ".z " + "\n";
        code += "mov " + out + ".w " + less + "\n";
        return code;
    };
    /**
     * @inheritDoc
     */
    CurveSubMeshRenderable.prototype._iActivate = function (pass, camera) {
        _super.prototype._iActivate.call(this, pass, camera);
        var context = this._stage.context;
        context.setProgramConstantsFromArray(ContextGLProgramType.FRAGMENT, 7, this._constants, 1);
    };
    /**
     * @inheritDoc
     */
    CurveSubMeshRenderable.prototype._iRender = function (pass, camera, viewProjection) {
        _super.prototype._iRender.call(this, pass, camera, viewProjection);
        var shader = pass.shader;
        if (shader.sceneMatrixIndex >= 0) {
            this.sourceEntity.getRenderSceneTransform(camera).copyRawDataTo(shader.vertexConstantData, shader.sceneMatrixIndex, true);
            viewProjection.copyRawDataTo(shader.vertexConstantData, shader.viewMatrixIndex, true);
        }
        else {
            var matrix3D = Matrix3DUtils.CALCULATION_MATRIX;
            matrix3D.copyFrom(this.sourceEntity.getRenderSceneTransform(camera));
            matrix3D.append(viewProjection);
            matrix3D.copyRawDataTo(shader.vertexConstantData, shader.viewMatrixIndex, true);
        }
        var context = this._stage.context;
        context.setProgramConstantsFromArray(ContextGLProgramType.VERTEX, 0, shader.vertexConstantData, shader.numUsedVertexConstants);
        context.setProgramConstantsFromArray(ContextGLProgramType.FRAGMENT, 0, shader.fragmentConstantData, shader.numUsedFragmentConstants);
        this._stage.activateBuffer(0, this.getVertexData(CurveSubGeometry.POSITION_DATA), this.getVertexOffset(CurveSubGeometry.POSITION_DATA), CurveSubGeometry.POSITION_FORMAT);
        this._stage.activateBuffer(1, this.getVertexData(CurveSubGeometry.CURVE_DATA), this.getVertexOffset(CurveSubGeometry.CURVE_DATA), CurveSubGeometry.POSITION_FORMAT);
        this._stage.context.drawTriangles(this._stage.getIndexBuffer(this.getIndexData()), 0, this.numTriangles);
    };
    /**
     * //TODO
     *
     * @param pool
     * @param renderableOwner
     * @param level
     * @param indexOffset
     * @returns {away.pool.TriangleSubMeshRenderable}
     * @protected
     */
    CurveSubMeshRenderable.prototype._pGetOverflowRenderable = function (indexOffset) {
        return new CurveSubMeshRenderable(this._pool, this.renderableOwner, this._stage, this._level + 1, indexOffset);
    };
    /**
     *
     */
    CurveSubMeshRenderable.id = "curvesubmesh";
    CurveSubMeshRenderable.vertexAttributesOffset = 1;
    return CurveSubMeshRenderable;
})(RenderableBase);
module.exports = CurveSubMeshRenderable;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9wb29sL0N1cnZlU3ViTWVzaFJlbmRlcmFibGUudHMiXSwibmFtZXMiOlsiQ3VydmVTdWJNZXNoUmVuZGVyYWJsZSIsIkN1cnZlU3ViTWVzaFJlbmRlcmFibGUuY29uc3RydWN0b3IiLCJDdXJ2ZVN1Yk1lc2hSZW5kZXJhYmxlLl9wR2V0U3ViR2VvbWV0cnkiLCJDdXJ2ZVN1Yk1lc2hSZW5kZXJhYmxlLl9pSW5jbHVkZURlcGVuZGVuY2llcyIsIkN1cnZlU3ViTWVzaFJlbmRlcmFibGUuX2lHZXRWZXJ0ZXhDb2RlIiwiQ3VydmVTdWJNZXNoUmVuZGVyYWJsZS5faUdldEZyYWdtZW50Q29kZSIsIkN1cnZlU3ViTWVzaFJlbmRlcmFibGUuX2lBY3RpdmF0ZSIsIkN1cnZlU3ViTWVzaFJlbmRlcmFibGUuX2lSZW5kZXIiLCJDdXJ2ZVN1Yk1lc2hSZW5kZXJhYmxlLl9wR2V0T3ZlcmZsb3dSZW5kZXJhYmxlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFDQSxJQUFPLGFBQWEsV0FBYyxvQ0FBb0MsQ0FBQyxDQUFDO0FBSXhFLElBQU8sZ0JBQWdCLFdBQWlCLDBDQUEwQyxDQUFDLENBQUM7QUFNcEYsSUFBTyxvQkFBb0IsV0FBYSw4Q0FBOEMsQ0FBQyxDQUFDO0FBTXhGLElBQU8sY0FBYyxXQUFjLDJDQUEyQyxDQUFDLENBQUM7QUFJaEYsQUFHQTs7R0FERztJQUNHLHNCQUFzQjtJQUFTQSxVQUEvQkEsc0JBQXNCQSxVQUF1QkE7SUFlbERBOzs7Ozs7O09BT0dBO0lBQ0hBLFNBdkJLQSxzQkFBc0JBLENBdUJmQSxJQUF1QkEsRUFBRUEsT0FBb0JBLEVBQUVBLEtBQVdBLEVBQUVBLEtBQWdCQSxFQUFFQSxXQUFzQkE7UUFBeENDLHFCQUFnQkEsR0FBaEJBLFNBQWdCQTtRQUFFQSwyQkFBc0JBLEdBQXRCQSxlQUFzQkE7UUFFL0dBLGtCQUFNQSxJQUFJQSxFQUFFQSxPQUFPQSxDQUFDQSxVQUFVQSxFQUFFQSxPQUFPQSxFQUFFQSxP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LGVBQWVBLENBQUNBLENBQUNBO1FBRXBLQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxPQUFPQSxDQUFDQSxhQUFhQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxjQUFjQSxDQUFDQSxJQUFJQSxDQUFDQSxZQUFZQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxJQUFJQSxDQUFDQSxZQUFZQSxDQUFDQSxDQUFDQTtJQUNoSEEsQ0FBQ0E7SUFFRFA7Ozs7Ozs7OztPQVNHQTtJQUNJQSx3REFBdUJBLEdBQTlCQSxVQUErQkEsV0FBa0JBO1FBRWhEUSxNQUFNQSxDQUFDQSxJQUFJQSxzQkFBc0JBLENBQUNBLElBQUlBLENBQUNBLEtBQUtBLEVBQWlCQSxJQUFJQSxDQUFDQSxlQUFlQSxFQUFFQSxJQUFJQSxDQUFDQSxNQUFNQSxFQUFFQSxJQUFJQSxDQUFDQSxNQUFNQSxHQUFHQSxDQUFDQSxFQUFFQSxXQUFXQSxDQUFDQSxDQUFDQTtJQUMvSEEsQ0FBQ0E7SUFuTERSOztPQUVHQTtJQUNXQSx5QkFBRUEsR0FBVUEsY0FBY0EsQ0FBQ0E7SUFFM0JBLDZDQUFzQkEsR0FBVUEsQ0FBQ0EsQ0FBQ0E7SUErS2pEQSw2QkFBQ0E7QUFBREEsQ0F0TEEsQUFzTENBLEVBdExvQyxjQUFjLEVBc0xsRDtBQUVELEFBQWdDLGlCQUF2QixzQkFBc0IsQ0FBQyIsImZpbGUiOiJwb29sL0N1cnZlU3ViTWVzaFJlbmRlcmFibGUuanMiLCJzb3VyY2VSb290IjoiLi4vIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IE1hdHJpeDNEXHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2dlb20vTWF0cml4M0RcIik7XG5pbXBvcnQgTWF0cml4M0RVdGlsc1x0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2dlb20vTWF0cml4M0RVdGlsc1wiKTtcblxuaW1wb3J0IElSZW5kZXJhYmxlT3duZXJcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9iYXNlL0lSZW5kZXJhYmxlT3duZXJcIik7XG5pbXBvcnQgQ3VydmVTdWJNZXNoXHRcdFx0XHQgICAgPSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL2Jhc2UvQ3VydmVTdWJNZXNoXCIpO1xuaW1wb3J0IEN1cnZlU3ViR2VvbWV0cnlcdFx0ICAgIFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL2Jhc2UvQ3VydmVTdWJHZW9tZXRyeVwiKTtcbmltcG9ydCBDYW1lcmFcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvZW50aXRpZXMvQ2FtZXJhXCIpO1xuXG5pbXBvcnQgQ29udGV4dEdMVmVydGV4QnVmZmVyRm9ybWF0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYmFzZS9Db250ZXh0R0xWZXJ0ZXhCdWZmZXJGb3JtYXRcIik7XG5pbXBvcnQgSUNvbnRleHRHTFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYmFzZS9JQ29udGV4dEdMXCIpO1xuaW1wb3J0IFN0YWdlXHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2Jhc2UvU3RhZ2VcIik7XG5pbXBvcnQgQ29udGV4dEdMUHJvZ3JhbVR5cGVcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYmFzZS9Db250ZXh0R0xQcm9ncmFtVHlwZVwiKTtcblxuaW1wb3J0IFNoYWRlck9iamVjdEJhc2VcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9jb21waWxhdGlvbi9TaGFkZXJPYmplY3RCYXNlXCIpO1xuaW1wb3J0IFNoYWRlclJlZ2lzdGVyQ2FjaGVcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvY29tcGlsYXRpb24vU2hhZGVyUmVnaXN0ZXJDYWNoZVwiKTtcbmltcG9ydCBTaGFkZXJSZWdpc3RlckRhdGFcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvY29tcGlsYXRpb24vU2hhZGVyUmVnaXN0ZXJEYXRhXCIpO1xuaW1wb3J0IFNoYWRlclJlZ2lzdGVyRWxlbWVudFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvY29tcGlsYXRpb24vU2hhZGVyUmVnaXN0ZXJFbGVtZW50XCIpO1xuaW1wb3J0IFJlbmRlcmFibGVCYXNlXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvcG9vbC9SZW5kZXJhYmxlQmFzZVwiKTtcbmltcG9ydCBSZW5kZXJhYmxlUG9vbEJhc2VcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvcG9vbC9SZW5kZXJhYmxlUG9vbEJhc2VcIik7XG5pbXBvcnQgUmVuZGVyUGFzc0Jhc2VcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9wYXNzZXMvUmVuZGVyUGFzc0Jhc2VcIik7XG5cbi8qKlxuICogQGNsYXNzIGF3YXkucG9vbC5UcmlhbmdsZVN1Yk1lc2hSZW5kZXJhYmxlXG4gKi9cbmNsYXNzIEN1cnZlU3ViTWVzaFJlbmRlcmFibGUgZXh0ZW5kcyBSZW5kZXJhYmxlQmFzZVxue1xuXHQvKipcblx0ICpcblx0ICovXG5cdHB1YmxpYyBzdGF0aWMgaWQ6c3RyaW5nID0gXCJjdXJ2ZXN1Ym1lc2hcIjtcblxuXHRwdWJsaWMgc3RhdGljIHZlcnRleEF0dHJpYnV0ZXNPZmZzZXQ6bnVtYmVyID0gMTtcblxuXHQvKipcblx0ICpcblx0ICovXG5cdHB1YmxpYyBzdWJNZXNoOkN1cnZlU3ViTWVzaDtcblxuXG5cdC8qKlxuXHQgKiAvL1RPRE9cblx0ICpcblx0ICogQHBhcmFtIHBvb2xcblx0ICogQHBhcmFtIHN1Yk1lc2hcblx0ICogQHBhcmFtIGxldmVsXG5cdCAqIEBwYXJhbSBpbmRleE9mZnNldFxuXHQgKi9cblx0Y29uc3RydWN0b3IocG9vbDpSZW5kZXJhYmxlUG9vbEJhc2UsIHN1Yk1lc2g6Q3VydmVTdWJNZXNoLCBzdGFnZTpTdGFnZSwgbGV2ZWw6bnVtYmVyID0gMCwgaW5kZXhPZmZzZXQ6bnVtYmVyID0gMClcblx0e1xuXHRcdHN1cGVyKHBvb2wsIHN1Yk1lc2gucGFyZW50TWVzaCwgc3ViTWVzaCwgc3ViTWVzaC5tYXRlcmlhbCwgc3RhZ2UsIGxldmVsLCBpbmRleE9mZnNldCk7XG5cblx0XHR0aGlzLnN1Yk1lc2ggPSBzdWJNZXNoO1xuXHR9XG5cblx0LyoqXG5cdCAqXG5cdCAqIEByZXR1cm5zIHtTdWJHZW9tZXRyeUJhc2V9XG5cdCAqIEBwcm90ZWN0ZWRcblx0ICovXG5cdHB1YmxpYyBfcEdldFN1Ykdlb21ldHJ5KCk6Q3VydmVTdWJHZW9tZXRyeVxuXHR7XG5cdFx0dmFyIHN1Ykdlb21ldHJ5OkN1cnZlU3ViR2VvbWV0cnk7XG5cblx0XHRpZiAodGhpcy5zdWJNZXNoLmFuaW1hdG9yKVxuXHRcdFx0c3ViR2VvbWV0cnkgPSA8Q3VydmVTdWJHZW9tZXRyeT4gdGhpcy5zdWJNZXNoLmFuaW1hdG9yLmdldFJlbmRlcmFibGVTdWJHZW9tZXRyeSh0aGlzLCB0aGlzLnN1Yk1lc2guc3ViR2VvbWV0cnkpO1xuXHRcdGVsc2Vcblx0XHRcdHN1Ykdlb21ldHJ5ID0gdGhpcy5zdWJNZXNoLnN1Ykdlb21ldHJ5O1xuXG5cdFx0dGhpcy5fcFZlcnRleERhdGFEaXJ0eVtDdXJ2ZVN1Ykdlb21ldHJ5LlBPU0lUSU9OX0RBVEFdID0gdHJ1ZTtcblxuXHRcdGlmIChzdWJHZW9tZXRyeS5jdXJ2ZXMpXG5cdFx0XHR0aGlzLl9wVmVydGV4RGF0YURpcnR5W0N1cnZlU3ViR2VvbWV0cnkuQ1VSVkVfREFUQV0gPSB0cnVlO1xuXG5cdFx0aWYgKHN1Ykdlb21ldHJ5LnV2cylcblx0XHRcdHRoaXMuX3BWZXJ0ZXhEYXRhRGlydHlbQ3VydmVTdWJHZW9tZXRyeS5VVl9EQVRBXSA9IHRydWU7XG5cblx0XHRyZXR1cm4gc3ViR2VvbWV0cnk7XG5cdH1cblxuXG5cdHB1YmxpYyBzdGF0aWMgX2lJbmNsdWRlRGVwZW5kZW5jaWVzKHNoYWRlck9iamVjdDpTaGFkZXJPYmplY3RCYXNlKVxuXHR7XG4gICAgICAgIHNoYWRlck9iamVjdC5sb2NhbFBvc0RlcGVuZGVuY2llcysrO1xuXHR9XG5cblx0cHVibGljIHN0YXRpYyBfaUdldFZlcnRleENvZGUoc2hhZGVyT2JqZWN0OlNoYWRlck9iamVjdEJhc2UsIHJlZ2lzdGVyQ2FjaGU6U2hhZGVyUmVnaXN0ZXJDYWNoZSwgc2hhcmVkUmVnaXN0ZXJzOlNoYWRlclJlZ2lzdGVyRGF0YSk6c3RyaW5nXG5cdHtcblx0XHR2YXIgY29kZTpzdHJpbmcgPSBcIlwiO1xuXG5cdFx0Ly9nZXQgdGhlIHByb2plY3Rpb24gY29vcmRpbmF0ZXNcblx0XHR2YXIgcG9zaXRpb246U2hhZGVyUmVnaXN0ZXJFbGVtZW50ID0gKHNoYWRlck9iamVjdC5nbG9iYWxQb3NEZXBlbmRlbmNpZXMgPiAwKT8gc2hhcmVkUmVnaXN0ZXJzLmdsb2JhbFBvc2l0aW9uVmVydGV4IDogc2hhcmVkUmVnaXN0ZXJzLmxvY2FsUG9zaXRpb247XG5cblx0XHQvL3Jlc2VydmluZyB2ZXJ0ZXggY29uc3RhbnRzIGZvciBwcm9qZWN0aW9uIG1hdHJpeFxuXHRcdHZhciB2aWV3TWF0cml4UmVnOlNoYWRlclJlZ2lzdGVyRWxlbWVudCA9IHJlZ2lzdGVyQ2FjaGUuZ2V0RnJlZVZlcnRleENvbnN0YW50KCk7XG5cdFx0cmVnaXN0ZXJDYWNoZS5nZXRGcmVlVmVydGV4Q29uc3RhbnQoKTtcblx0XHRyZWdpc3RlckNhY2hlLmdldEZyZWVWZXJ0ZXhDb25zdGFudCgpO1xuXHRcdHJlZ2lzdGVyQ2FjaGUuZ2V0RnJlZVZlcnRleENvbnN0YW50KCk7XG5cdFx0c2hhZGVyT2JqZWN0LnZpZXdNYXRyaXhJbmRleCA9IHZpZXdNYXRyaXhSZWcuaW5kZXgqNDtcblxuXG5cdFx0aWYgKHNoYWRlck9iamVjdC5wcm9qZWN0aW9uRGVwZW5kZW5jaWVzID4gMCkge1xuXHRcdFx0c2hhcmVkUmVnaXN0ZXJzLnByb2plY3Rpb25GcmFnbWVudCA9IHJlZ2lzdGVyQ2FjaGUuZ2V0RnJlZVZhcnlpbmcoKTtcblx0XHRcdHZhciB0ZW1wOlNoYWRlclJlZ2lzdGVyRWxlbWVudCA9IHJlZ2lzdGVyQ2FjaGUuZ2V0RnJlZVZlcnRleFZlY3RvclRlbXAoKTtcblx0XHRcdGNvZGUgKz0gXCJtNDQgXCIgKyB0ZW1wICsgXCIsIFwiICsgcG9zaXRpb24gKyBcIi54eXcsIFwiICsgdmlld01hdHJpeFJlZyArIFwiXFxuXCIgK1xuXHRcdFx0XCJtb3YgXCIgKyBzaGFyZWRSZWdpc3RlcnMucHJvamVjdGlvbkZyYWdtZW50ICsgXCIsIFwiICsgdGVtcCArIFwiXFxuXCIgK1xuXHRcdFx0XCJtb3Ygb3AsIFwiICsgdGVtcCArIFwiXFxuXCI7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGNvZGUgKz0gXCJtb3YgdjIgdmExIFxcblwiO1xuXHRcdFx0Y29kZSArPSBcIm00NCBvcCwgXCIgKyBwb3NpdGlvbiArIFwiLnh5dywgXCIgKyB2aWV3TWF0cml4UmVnICsgXCJcXG5cIjtcblx0XHR9XG5cblx0XHRyZXR1cm4gY29kZTtcblx0fVxuICAgIC8qKlxuICAgICAqIEBpbmhlcml0RG9jXG4gICAgICovXG4gICAgcHVibGljIHN0YXRpYyBfaUdldEZyYWdtZW50Q29kZShzaGFkZXJPYmplY3Q6U2hhZGVyT2JqZWN0QmFzZSwgcmVnaXN0ZXJDYWNoZTpTaGFkZXJSZWdpc3RlckNhY2hlLCBzaGFyZWRSZWdpc3RlcnM6U2hhZGVyUmVnaXN0ZXJEYXRhKTpzdHJpbmdcbiAgICB7XG4gICAgICAgIHZhciB1djpTdHJpbmcgPSBcInYyXCI7Ly9zaGFyZWRSZWdpc3RlcnMudXZWYXJ5aW5nIC8vc2hhZGVyT2JqZWN0LnV2VGFyZ2V0O1xuICAgICAgICB2YXIgcG9zOlNoYWRlclJlZ2lzdGVyRWxlbWVudCA9IHNoYXJlZFJlZ2lzdGVycy5sb2NhbFBvc2l0aW9uVmFyeWluZztcbiAgICAgICAgdmFyIG91dDpTaGFkZXJSZWdpc3RlckVsZW1lbnQgPSBzaGFyZWRSZWdpc3RlcnMuc2hhZGVkVGFyZ2V0Oy8vcmVnaXN0ZXJDYWNoZS5mcmFnbWVudE91dHB1dFJlZ2lzdGVyLnRvU3RyaW5nKCk7XG5cbiAgICAgICAgdmFyIGZyZWU6U2hhZGVyUmVnaXN0ZXJFbGVtZW50ID0gcmVnaXN0ZXJDYWNoZS5nZXRGcmVlRnJhZ21lbnRWZWN0b3JUZW1wKCk7XG4gICAgICAgIHZhciBkOlN0cmluZyA9IGZyZWUgKyBcIi54XCI7Ly9yZWdpc3RlckNhY2hlLmdldEZyZWVGcmFnbWVudENvbnN0YW50KCkudG9TdHJpbmcoKTtcbiAgICAgICAgdmFyIGxlc3M6U3RyaW5nID0gZnJlZSArIFwiLnlcIjsvL3JlZ2lzdGVyQ2FjaGUuZ2V0RnJlZUZyYWdtZW50U2luZ2xlVGVtcCgpLnRvU3RyaW5nKCk7XG4gICAgICAgIHZhciBoYWxmOlN0cmluZyA9IGZyZWUgKyBcIi56XCI7Ly9yZWdpc3RlckNhY2hlLmdldEZyZWVGcmFnbWVudFNpbmdsZVRlbXAoKS50b1N0cmluZygpO1xuXG4gICAgICAgIHZhciBjb2RlOnN0cmluZyA9IFwiXCI7XG4gICAgICAgIGNvZGUgKz0gXCJtb3YgXCIgKyBkICsgXCIgXCIgKyB1diArIFwiLnhcXG5cIjtcbiAgICAgICAgY29kZSArPSBcIm11bCBcIiArIGQgKyBcIiBcIiArIGQgKyBcIiBcIiArIGQrXCJcXG5cIjtcbiAgICAgICAgY29kZSArPSBcInN1YiBcIiArIGQgKyBcIiBcIiArIGQgKyBcIiBcIiArIHV2K1wiLnlcXG5cIjtcblxuICAgICAgICAgICAgIC8vIGNvZGUgKz0gXCJtb3YgXCIrIG91dCArIFwiIFwiICsgc2hhcmVkUmVnaXN0ZXJzLnV2VmFyeWluZytcIlxcblwiO1xuXG4gICAgICAgLy8gY29kZSArPSBcIm11bCBcIisgZCArIFwiIFwiICsgZCArIFwiIFwiICsgbGVzcyArIFwiXFxuXCI7XG4gICAgICAgIC8vY29kZSArPSBcInN1YiBcIisgZCArIFwiIFwiICsgZCArIFwiIFwiICsgcG9zICsgXCIueiBcIiArIFwiXFxuXCI7XG4gICAgICAgIGNvZGUgKz0gXCJtdWwgXCIrIGQgKyBcIiBcIiArIGQgKyBcIiBcIiArIHBvcyArIFwiLnogXCIgKyBcIlxcblwiO1xuICAgICAgICBjb2RlICs9IFwibW92IFwiKyBoYWxmICsgXCIgZmM3LnhcXG5cIjtcbiAgICAgICAgY29kZSArPSBcInNsdCBcIisgbGVzcyArIFwiIFwiICsgZCArIFwiIFwiICsgaGFsZiArIFwiXFxuXCI7XG4gICAgICAgIGNvZGUgKz0gXCJtdWwgXCIrIGQgKyBcIiBcIiArIGQgKyBcIiBcIiArIGxlc3MgKyBcIlxcblwiO1xuICAgICAgICBjb2RlICs9IFwiYWJzIFwiKyBkICsgXCIgXCIgKyBkICsgXCJcXG5cIjtcbiAgICAgICAvLyBjb2RlICs9IFwia2lsIFwiICsgbGVzcyArIFwiXFxuXCI7XG4gICAgICAvLyAgY29kZSArPSBcInN1YiBcIisgbGVzcyArIFwiIFwiICsgbGVzcyArIFwiIFwiICsgcG9zICsgXCIueiBcIiArIFwiXFxuXCI7XG5cbiAgICAgICAgY29kZSArPSBcIm1vdiBcIiArIG91dCArIFwiLncgXCIgKyBsZXNzICsgXCJcXG5cIjtcblxuICAgICAgICByZXR1cm4gY29kZTtcbiAgICB9XG4gICAgcHJpdmF0ZSBfY29uc3RhbnRzOkFycmF5PG51bWJlcj4gPSBuZXcgQXJyYXk8bnVtYmVyPigwLCAwLCAwLCAwKTtcbiAgICAvKipcbiAgICAgKiBAaW5oZXJpdERvY1xuICAgICAqL1xuICAgIHB1YmxpYyBfaUFjdGl2YXRlKHBhc3M6UmVuZGVyUGFzc0Jhc2UsIGNhbWVyYTpDYW1lcmEpXG4gICAge1xuICAgICAgICBzdXBlci5faUFjdGl2YXRlKHBhc3MsIGNhbWVyYSk7XG5cbiAgICAgICAgdmFyIGNvbnRleHQ6SUNvbnRleHRHTCA9IHRoaXMuX3N0YWdlLmNvbnRleHQ7XG5cbiAgICAgICAgY29udGV4dC5zZXRQcm9ncmFtQ29uc3RhbnRzRnJvbUFycmF5KENvbnRleHRHTFByb2dyYW1UeXBlLkZSQUdNRU5ULCA3LCB0aGlzLl9jb25zdGFudHMsIDEpO1xuXG4gICAgfVxuXHQvKipcblx0ICogQGluaGVyaXREb2Ncblx0ICovXG5cdHB1YmxpYyBfaVJlbmRlcihwYXNzOlJlbmRlclBhc3NCYXNlLCBjYW1lcmE6Q2FtZXJhLCB2aWV3UHJvamVjdGlvbjpNYXRyaXgzRClcblx0e1xuXHRcdHN1cGVyLl9pUmVuZGVyKHBhc3MsIGNhbWVyYSwgdmlld1Byb2plY3Rpb24pO1xuXG5cdFx0dmFyIHNoYWRlcjpTaGFkZXJPYmplY3RCYXNlID0gcGFzcy5zaGFkZXI7XG5cblx0XHRpZiAoc2hhZGVyLnNjZW5lTWF0cml4SW5kZXggPj0gMCkge1xuXHRcdFx0dGhpcy5zb3VyY2VFbnRpdHkuZ2V0UmVuZGVyU2NlbmVUcmFuc2Zvcm0oY2FtZXJhKS5jb3B5UmF3RGF0YVRvKHNoYWRlci52ZXJ0ZXhDb25zdGFudERhdGEsIHNoYWRlci5zY2VuZU1hdHJpeEluZGV4LCB0cnVlKTtcblx0XHRcdHZpZXdQcm9qZWN0aW9uLmNvcHlSYXdEYXRhVG8oc2hhZGVyLnZlcnRleENvbnN0YW50RGF0YSwgc2hhZGVyLnZpZXdNYXRyaXhJbmRleCwgdHJ1ZSk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHZhciBtYXRyaXgzRDpNYXRyaXgzRCA9IE1hdHJpeDNEVXRpbHMuQ0FMQ1VMQVRJT05fTUFUUklYO1xuXG5cdFx0XHRtYXRyaXgzRC5jb3B5RnJvbSh0aGlzLnNvdXJjZUVudGl0eS5nZXRSZW5kZXJTY2VuZVRyYW5zZm9ybShjYW1lcmEpKTtcblx0XHRcdG1hdHJpeDNELmFwcGVuZCh2aWV3UHJvamVjdGlvbik7XG5cblx0XHRcdG1hdHJpeDNELmNvcHlSYXdEYXRhVG8oc2hhZGVyLnZlcnRleENvbnN0YW50RGF0YSwgc2hhZGVyLnZpZXdNYXRyaXhJbmRleCwgdHJ1ZSk7XG5cdFx0fVxuXG5cdFx0dmFyIGNvbnRleHQ6SUNvbnRleHRHTCA9IHRoaXMuX3N0YWdlLmNvbnRleHQ7XG5cdFx0Y29udGV4dC5zZXRQcm9ncmFtQ29uc3RhbnRzRnJvbUFycmF5KENvbnRleHRHTFByb2dyYW1UeXBlLlZFUlRFWCwgMCwgc2hhZGVyLnZlcnRleENvbnN0YW50RGF0YSwgc2hhZGVyLm51bVVzZWRWZXJ0ZXhDb25zdGFudHMpO1xuXHRcdGNvbnRleHQuc2V0UHJvZ3JhbUNvbnN0YW50c0Zyb21BcnJheShDb250ZXh0R0xQcm9ncmFtVHlwZS5GUkFHTUVOVCwgMCwgc2hhZGVyLmZyYWdtZW50Q29uc3RhbnREYXRhLCBzaGFkZXIubnVtVXNlZEZyYWdtZW50Q29uc3RhbnRzKTtcblxuXHRcdHRoaXMuX3N0YWdlLmFjdGl2YXRlQnVmZmVyKDAsIHRoaXMuZ2V0VmVydGV4RGF0YShDdXJ2ZVN1Ykdlb21ldHJ5LlBPU0lUSU9OX0RBVEEpLCB0aGlzLmdldFZlcnRleE9mZnNldChDdXJ2ZVN1Ykdlb21ldHJ5LlBPU0lUSU9OX0RBVEEpLCBDdXJ2ZVN1Ykdlb21ldHJ5LlBPU0lUSU9OX0ZPUk1BVCk7XG4gICAgICAgIHRoaXMuX3N0YWdlLmFjdGl2YXRlQnVmZmVyKDEsIHRoaXMuZ2V0VmVydGV4RGF0YShDdXJ2ZVN1Ykdlb21ldHJ5LkNVUlZFX0RBVEEpLCB0aGlzLmdldFZlcnRleE9mZnNldChDdXJ2ZVN1Ykdlb21ldHJ5LkNVUlZFX0RBVEEpLCBDdXJ2ZVN1Ykdlb21ldHJ5LlBPU0lUSU9OX0ZPUk1BVCk7XG5cbiAgICAgICAgdGhpcy5fc3RhZ2UuY29udGV4dC5kcmF3VHJpYW5nbGVzKHRoaXMuX3N0YWdlLmdldEluZGV4QnVmZmVyKHRoaXMuZ2V0SW5kZXhEYXRhKCkpLCAwLCB0aGlzLm51bVRyaWFuZ2xlcyk7XG5cdH1cblxuXHQvKipcblx0ICogLy9UT0RPXG5cdCAqXG5cdCAqIEBwYXJhbSBwb29sXG5cdCAqIEBwYXJhbSByZW5kZXJhYmxlT3duZXJcblx0ICogQHBhcmFtIGxldmVsXG5cdCAqIEBwYXJhbSBpbmRleE9mZnNldFxuXHQgKiBAcmV0dXJucyB7YXdheS5wb29sLlRyaWFuZ2xlU3ViTWVzaFJlbmRlcmFibGV9XG5cdCAqIEBwcm90ZWN0ZWRcblx0ICovXG5cdHB1YmxpYyBfcEdldE92ZXJmbG93UmVuZGVyYWJsZShpbmRleE9mZnNldDpudW1iZXIpOlJlbmRlcmFibGVCYXNlXG5cdHtcblx0XHRyZXR1cm4gbmV3IEN1cnZlU3ViTWVzaFJlbmRlcmFibGUodGhpcy5fcG9vbCwgPEN1cnZlU3ViTWVzaD4gdGhpcy5yZW5kZXJhYmxlT3duZXIsIHRoaXMuX3N0YWdlLCB0aGlzLl9sZXZlbCArIDEsIGluZGV4T2Zmc2V0KTtcblx0fVxufVxuXG5leHBvcnQgPSBDdXJ2ZVN1Yk1lc2hSZW5kZXJhYmxlOyJdfQ==