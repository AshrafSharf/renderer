var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var Matrix3DUtils = require("awayjs-core/lib/geom/Matrix3DUtils");
var TriangleSubGeometry = require("awayjs-display/lib/base/TriangleSubGeometry");
var ContextGLProgramType = require("awayjs-stagegl/lib/base/ContextGLProgramType");
var RenderableBase = require("awayjs-renderergl/lib/pool/RenderableBase");
/**
 * @class away.pool.RenderableListItem
 */
var BillboardRenderable = (function (_super) {
    __extends(BillboardRenderable, _super);
    /**
     * //TODO
     *
     * @param pool
     * @param billboard
     */
    function BillboardRenderable(pool, billboard, stage) {
        _super.call(this, pool, billboard, billboard, billboard.material, stage);
        this._billboard = billboard;
    }
    /**
     * //TODO
     *
     * @returns {away.base.TriangleSubGeometry}
     */
    BillboardRenderable.prototype._pGetSubGeometry = function () {
        var material = this._billboard.material;
        var geometry = BillboardRenderable._materialGeometry[material.id];
        if (!geometry) {
            geometry = BillboardRenderable._materialGeometry[material.id] = new TriangleSubGeometry(true);
            geometry.autoDeriveNormals = false;
            geometry.autoDeriveTangents = false;
            geometry.updateIndices(Array(0, 1, 2, 0, 2, 3));
            geometry.updatePositions(Array(0, material.height, 0, material.width, material.height, 0, material.width, 0, 0, 0, 0, 0));
            geometry.updateVertexNormals(Array(1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0));
            geometry.updateVertexTangents(Array(0, 0, -1, 0, 0, -1, 0, 0, -1, 0, 0, -1));
            geometry.updateUVs(Array(0, 0, 1, 0, 1, 1, 0, 1));
        }
        else {
            geometry.updatePositions(Array(0, material.height, 0, material.width, material.height, 0, material.width, 0, 0, 0, 0, 0));
        }
        this._pVertexDataDirty[TriangleSubGeometry.POSITION_DATA] = true;
        this._pVertexDataDirty[TriangleSubGeometry.NORMAL_DATA] = true;
        this._pVertexDataDirty[TriangleSubGeometry.TANGENT_DATA] = true;
        this._pVertexDataDirty[TriangleSubGeometry.UV_DATA] = true;
        return geometry;
    };
    BillboardRenderable._iIncludeDependencies = function (shaderObject) {
    };
    BillboardRenderable._iGetVertexCode = function (shaderObject, registerCache, sharedRegisters) {
        var code = "";
        //get the projection coordinates
        var position = (shaderObject.globalPosDependencies > 0) ? sharedRegisters.globalPositionVertex : sharedRegisters.localPosition;
        //reserving vertex constants for projection matrix
        var viewMatrixReg = registerCache.getFreeVertexConstant();
        registerCache.getFreeVertexConstant();
        registerCache.getFreeVertexConstant();
        registerCache.getFreeVertexConstant();
        shaderObject.viewMatrixIndex = viewMatrixReg.index * 4;
        if (shaderObject.projectionDependencies > 0) {
            sharedRegisters.projectionFragment = registerCache.getFreeVarying();
            var temp = registerCache.getFreeVertexVectorTemp();
            code += "m44 " + temp + ", " + position + ", " + viewMatrixReg + "\n" + "mov " + sharedRegisters.projectionFragment + ", " + temp + "\n" + "mov op, " + temp + "\n";
        }
        else {
            code += "m44 op, " + position + ", " + viewMatrixReg + "\n";
        }
        return code;
    };
    /**
     * @inheritDoc
     */
    BillboardRenderable.prototype._iRender = function (pass, camera, viewProjection) {
        _super.prototype._iRender.call(this, pass, camera, viewProjection);
        var shader = pass.shader;
        if (shader.sceneMatrixIndex >= 0) {
            this.sourceEntity.getRenderSceneTransform(camera).copyRawDataTo(shader.vertexConstantData, shader.sceneMatrixIndex, true);
            viewProjection.copyRawDataTo(shader.vertexConstantData, shader.viewMatrixIndex, true);
        }
        else {
            var matrix3D = Matrix3DUtils.CALCULATION_MATRIX;
            matrix3D.copyFrom(this.sourceEntity.getRenderSceneTransform(camera));
            matrix3D.append(viewProjection);
            matrix3D.copyRawDataTo(shader.vertexConstantData, shader.viewMatrixIndex, true);
        }
        var context = this._stage.context;
        context.setProgramConstantsFromArray(ContextGLProgramType.VERTEX, 0, shader.vertexConstantData, shader.numUsedVertexConstants);
        context.setProgramConstantsFromArray(ContextGLProgramType.FRAGMENT, 0, shader.fragmentConstantData, shader.numUsedFragmentConstants);
        this._stage.activateBuffer(0, this.getVertexData(TriangleSubGeometry.POSITION_DATA), this.getVertexOffset(TriangleSubGeometry.POSITION_DATA), TriangleSubGeometry.POSITION_FORMAT);
        this._stage.context.drawTriangles(this._stage.getIndexBuffer(this.getIndexData()), 0, this.numTriangles);
    };
    BillboardRenderable._materialGeometry = new Object();
    /**
     *
     */
    BillboardRenderable.id = "billboard";
    BillboardRenderable.vertexAttributesOffset = 1;
    return BillboardRenderable;
})(RenderableBase);
module.exports = BillboardRenderable;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9wb29sL2JpbGxib2FyZHJlbmRlcmFibGUudHMiXSwibmFtZXMiOlsiQmlsbGJvYXJkUmVuZGVyYWJsZSIsIkJpbGxib2FyZFJlbmRlcmFibGUuY29uc3RydWN0b3IiLCJCaWxsYm9hcmRSZW5kZXJhYmxlLl9wR2V0U3ViR2VvbWV0cnkiLCJCaWxsYm9hcmRSZW5kZXJhYmxlLl9pSW5jbHVkZURlcGVuZGVuY2llcyIsIkJpbGxib2FyZFJlbmRlcmFibGUuX2lHZXRWZXJ0ZXhDb2RlIiwiQmlsbGJvYXJkUmVuZGVyYWJsZS5faVJlbmRlciJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQ0EsSUFBTyxhQUFhLFdBQWMsb0NBQW9DLENBQUMsQ0FBQztBQUd4RSxJQUFPLG1CQUFtQixXQUFhLDZDQUE2QyxDQUFDLENBQUM7QUFPdEYsSUFBTyxvQkFBb0IsV0FBYSw4Q0FBOEMsQ0FBQyxDQUFDO0FBTXhGLElBQU8sY0FBYyxXQUFjLDJDQUEyQyxDQUFDLENBQUM7QUFJaEYsQUFHQTs7R0FERztJQUNHLG1CQUFtQjtJQUFTQSxVQUE1QkEsbUJBQW1CQSxVQUF1QkE7SUFnQi9DQTs7Ozs7T0FLR0E7SUFDSEEsU0F0QktBLG1CQUFtQkEsQ0FzQlpBLElBQXVCQSxFQUFFQSxTQUFtQkEsRUFBRUEsS0FBV0E7UUFFcEVDLGtCQUFNQSxJQUFJQSxFQUFFQSxTQUFTQSxFQUFFQSxTQUFTQSxFQUFFQSxTQUFTQSxDQUFDQSxRQUFRQSxFQUFFQSxLQUFLQSxDQUFDQSxDQUFDQTtRQUU3REEsSUFBSUEsQ0FBQ0EsVUFBVUEsR0FBR0EsU0FBU0EsQ0FBQ0E7SUFDN0JBLENBQUNBO0lBRUREOzs7O09BSUdBO0lBQ0lBLDhDQUFnQkEsR0FBdkJBO1FBRUNFLElBQUlBLFFBQVFBLEdBQWdCQSxJQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxRQUFRQSxDQUFDQTtRQUVyREEsSUFBSUEsUUFBUUEsR0FBdUJBLG1CQUFtQkEsQ0FBQ0EsaUJBQWlCQSxDQUFDQSxRQUFRQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQTtRQUV0RkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDZkEsUUFBUUEsR0FBR0EsbUJBQW1CQSxDQUFDQSxpQkFBaUJBLENBQUNBLFFBQVFBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLElBQUlBLG1CQUFtQkEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFDOUZBLFFBQVFBLENBQUNBLGlCQUFpQkEsR0FBR0EsS0FBS0EsQ0FBQ0E7WUFDbkNBLFFBQVFBLENBQUNBLGtCQUFrQkEsR0FBR0EsS0FBS0EsQ0FBQ0E7WUFDcENBLFFBQVFBLENBQUNBLGFBQWFBLENBQUNBLEtBQUtBLENBQVNBLENBQUNBLEVBQUVBLENBQUNBLEVBQUVBLENBQUNBLEVBQUVBLENBQUNBLEVBQUVBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1lBQ3hEQSxRQUFRQSxDQUFDQSxlQUFlQSxDQUFDQSxLQUFLQSxDQUFTQSxDQUFDQSxFQUFFQSxRQUFRQSxDQUFDQSxNQUFNQSxFQUFFQSxDQUFDQSxFQUFFQSxRQUFRQSxDQUFDQSxLQUFLQSxFQUFFQSxRQUFRQSxDQUFDQSxNQUFNQSxFQUFFQSxDQUFDQSxFQUFFQSxRQUFRQSxDQUFDQSxLQUFLQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNsSUEsUUFBUUEsQ0FBQ0EsbUJBQW1CQSxDQUFDQSxLQUFLQSxDQUFTQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNoRkEsUUFBUUEsQ0FBQ0Esb0JBQW9CQSxDQUFDQSxLQUFLQSxDQUFTQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNyRkEsUUFBUUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsS0FBS0EsQ0FBU0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDM0RBLENBQUNBO1FBQUNBLElBQUlBLENBQUNBLENBQUNBO1lBQ1BBLFFBQVFBLENBQUNBLGVBQWVBLENBQUNBLEtBQUtBLENBQVNBLENBQUNBLEVBQUVBLFFBQVFBLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBLEVBQUVBLFFBQVFBLENBQUNBLEtBQUtBLEVBQUVBLFFBQVFBLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBLEVBQUVBLFFBQVFBLENBQUNBLEtBQUtBLEVBQUVBLENBQUNBLEVBQUVBLENBQUNBLEVBQUVBLENBQUNBLEVBQUVBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1FBQ25JQSxDQUFDQTtRQUVEQSxJQUFJQSxDQUFDQSxpQkFBaUJBLENBQUNBLG1CQUFtQkEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0E7UUFDakVBLElBQUlBLENBQUNBLGlCQUFpQkEsQ0FBQ0EsbUJBQW1CQSxDQUFDQSxXQUFXQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQTtRQUMvREEsSUFBSUEsQ0FBQ0EsaUJBQWlCQSxDQUFDQSxtQkFBbUJBLENBQUNBLFlBQVlBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBO1FBQ2hFQSxJQUFJQSxDQUFDQSxpQkFBaUJBLENBQUNB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Q0FBQ0EsRUFBRUEsQ0FBQ0EsRUFBRUEsSUFBSUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsQ0FBQ0E7SUFDMUdBLENBQUNBO0lBdEhjTCxxQ0FBaUJBLEdBQVVBLElBQUlBLE1BQU1BLEVBQUVBLENBQUNBO0lBRXZEQTs7T0FFR0E7SUFDV0Esc0JBQUVBLEdBQVVBLFdBQVdBLENBQUNBO0lBRXhCQSwwQ0FBc0JBLEdBQVVBLENBQUNBLENBQUNBO0lBZ0hqREEsMEJBQUNBO0FBQURBLENBekhBLEFBeUhDQSxFQXpIaUMsY0FBYyxFQXlIL0M7QUFFRCxBQUE2QixpQkFBcEIsbUJBQW1CLENBQUMiLCJmaWxlIjoicG9vbC9CaWxsYm9hcmRSZW5kZXJhYmxlLmpzIiwic291cmNlUm9vdCI6Ii4uLyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBNYXRyaXgzRFx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9nZW9tL01hdHJpeDNEXCIpO1xuaW1wb3J0IE1hdHJpeDNEVXRpbHNcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9nZW9tL01hdHJpeDNEVXRpbHNcIik7XG5cbmltcG9ydCBTdWJHZW9tZXRyeUJhc2VcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9iYXNlL1N1Ykdlb21ldHJ5QmFzZVwiKTtcbmltcG9ydCBUcmlhbmdsZVN1Ykdlb21ldHJ5XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL2Jhc2UvVHJpYW5nbGVTdWJHZW9tZXRyeVwiKTtcbmltcG9ydCBCaWxsYm9hcmRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL2VudGl0aWVzL0JpbGxib2FyZFwiKTtcbmltcG9ydCBNYXRlcmlhbEJhc2VcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL21hdGVyaWFscy9NYXRlcmlhbEJhc2VcIik7XG5pbXBvcnQgQ2FtZXJhXHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL2VudGl0aWVzL0NhbWVyYVwiKTtcblxuaW1wb3J0IFN0YWdlXHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2Jhc2UvU3RhZ2VcIik7XG5pbXBvcnQgSUNvbnRleHRHTFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYmFzZS9JQ29udGV4dEdMXCIpO1xuaW1wb3J0IENvbnRleHRHTFByb2dyYW1UeXBlXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2Jhc2UvQ29udGV4dEdMUHJvZ3JhbVR5cGVcIik7XG5cbmltcG9ydCBTaGFkZXJPYmplY3RCYXNlXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvY29tcGlsYXRpb24vU2hhZGVyT2JqZWN0QmFzZVwiKTtcbmltcG9ydCBTaGFkZXJSZWdpc3RlckNhY2hlXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2NvbXBpbGF0aW9uL1NoYWRlclJlZ2lzdGVyQ2FjaGVcIik7XG5pbXBvcnQgU2hhZGVyUmVnaXN0ZXJEYXRhXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2NvbXBpbGF0aW9uL1NoYWRlclJlZ2lzdGVyRGF0YVwiKTtcbmltcG9ydCBTaGFkZXJSZWdpc3RlckVsZW1lbnRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2NvbXBpbGF0aW9uL1NoYWRlclJlZ2lzdGVyRWxlbWVudFwiKTtcbmltcG9ydCBSZW5kZXJhYmxlQmFzZVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL3Bvb2wvUmVuZGVyYWJsZUJhc2VcIik7XG5pbXBvcnQgUmVuZGVyYWJsZVBvb2xCYXNlXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL3Bvb2wvUmVuZGVyYWJsZVBvb2xCYXNlXCIpO1xuaW1wb3J0IFJlbmRlclBhc3NCYXNlXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvcGFzc2VzL1JlbmRlclBhc3NCYXNlXCIpO1xuXG4vKipcbiAqIEBjbGFzcyBhd2F5LnBvb2wuUmVuZGVyYWJsZUxpc3RJdGVtXG4gKi9cbmNsYXNzIEJpbGxib2FyZFJlbmRlcmFibGUgZXh0ZW5kcyBSZW5kZXJhYmxlQmFzZVxue1xuXHRwcml2YXRlIHN0YXRpYyBfbWF0ZXJpYWxHZW9tZXRyeTpPYmplY3QgPSBuZXcgT2JqZWN0KCk7XG5cblx0LyoqXG5cdCAqXG5cdCAqL1xuXHRwdWJsaWMgc3RhdGljIGlkOnN0cmluZyA9IFwiYmlsbGJvYXJkXCI7XG5cblx0cHVibGljIHN0YXRpYyB2ZXJ0ZXhBdHRyaWJ1dGVzT2Zmc2V0Om51bWJlciA9IDE7XG5cblx0LyoqXG5cdCAqXG5cdCAqL1xuXHRwcml2YXRlIF9iaWxsYm9hcmQ6QmlsbGJvYXJkO1xuXG5cdC8qKlxuXHQgKiAvL1RPRE9cblx0ICpcblx0ICogQHBhcmFtIHBvb2xcblx0ICogQHBhcmFtIGJpbGxib2FyZFxuXHQgKi9cblx0Y29uc3RydWN0b3IocG9vbDpSZW5kZXJhYmxlUG9vbEJhc2UsIGJpbGxib2FyZDpCaWxsYm9hcmQsIHN0YWdlOlN0YWdlKVxuXHR7XG5cdFx0c3VwZXIocG9vbCwgYmlsbGJvYXJkLCBiaWxsYm9hcmQsIGJpbGxib2FyZC5tYXRlcmlhbCwgc3RhZ2UpO1xuXG5cdFx0dGhpcy5fYmlsbGJvYXJkID0gYmlsbGJvYXJkO1xuXHR9XG5cblx0LyoqXG5cdCAqIC8vVE9ET1xuXHQgKlxuXHQgKiBAcmV0dXJucyB7YXdheS5iYXNlLlRyaWFuZ2xlU3ViR2VvbWV0cnl9XG5cdCAqL1xuXHRwdWJsaWMgX3BHZXRTdWJHZW9tZXRyeSgpOlN1Ykdlb21ldHJ5QmFzZVxuXHR7XG5cdFx0dmFyIG1hdGVyaWFsOk1hdGVyaWFsQmFzZSA9IHRoaXMuX2JpbGxib2FyZC5tYXRlcmlhbDtcblxuXHRcdHZhciBnZW9tZXRyeTpUcmlhbmdsZVN1Ykdlb21ldHJ5ID0gQmlsbGJvYXJkUmVuZGVyYWJsZS5fbWF0ZXJpYWxHZW9tZXRyeVttYXRlcmlhbC5pZF07XG5cblx0XHRpZiAoIWdlb21ldHJ5KSB7XG5cdFx0XHRnZW9tZXRyeSA9IEJpbGxib2FyZFJlbmRlcmFibGUuX21hdGVyaWFsR2VvbWV0cnlbbWF0ZXJpYWwuaWRdID0gbmV3IFRyaWFuZ2xlU3ViR2VvbWV0cnkodHJ1ZSk7XG5cdFx0XHRnZW9tZXRyeS5hdXRvRGVyaXZlTm9ybWFscyA9IGZhbHNlO1xuXHRcdFx0Z2VvbWV0cnkuYXV0b0Rlcml2ZVRhbmdlbnRzID0gZmFsc2U7XG5cdFx0XHRnZW9tZXRyeS51cGRhdGVJbmRpY2VzKEFycmF5PG51bWJlcj4oMCwgMSwgMiwgMCwgMiwgMykpO1xuXHRcdFx0Z2VvbWV0cnkudXBkYXRlUG9zaXRpb25zKEFycmF5PG51bWJlcj4oMCwgbWF0ZXJpYWwuaGVpZ2h0LCAwLCBtYXRlcmlhbC53aWR0aCwgbWF0ZXJpYWwuaGVpZ2h0LCAwLCBtYXRlcmlhbC53aWR0aCwgMCwgMCwgMCwgMCwgMCkpO1xuXHRcdFx0Z2VvbWV0cnkudXBkYXRlVmVydGV4Tm9ybWFscyhBcnJheTxudW1iZXI+KDEsIDAsIDAsIDEsIDAsIDAsIDEsIDAsIDAsIDEsIDAsIDApKTtcblx0XHRcdGdlb21ldHJ5LnVwZGF0ZVZlcnRleFRhbmdlbnRzKEFycmF5PG51bWJlcj4oMCwgMCwgLTEsIDAsIDAsIC0xLCAwLCAwLCAtMSwgMCwgMCwgLTEpKTtcblx0XHRcdGdlb21ldHJ5LnVwZGF0ZVVWcyhBcnJheTxudW1iZXI+KDAsIDAsIDEsIDAsIDEsIDEsIDAsIDEpKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0Z2VvbWV0cnkudXBkYXRlUG9zaXRpb25zKEFycmF5PG51bWJlcj4oMCwgbWF0ZXJpYWwuaGVpZ2h0LCAwLCBtYXRlcmlhbC53aWR0aCwgbWF0ZXJpYWwuaGVpZ2h0LCAwLCBtYXRlcmlhbC53aWR0aCwgMCwgMCwgMCwgMCwgMCkpO1xuXHRcdH1cblxuXHRcdHRoaXMuX3BWZXJ0ZXhEYXRhRGlydHlbVHJpYW5nbGVTdWJHZW9tZXRyeS5QT1NJVElPTl9EQVRBXSA9IHRydWU7XG5cdFx0dGhpcy5fcFZlcnRleERhdGFEaXJ0eVtUcmlhbmdsZVN1Ykdlb21ldHJ5Lk5PUk1BTF9EQVRBXSA9IHRydWU7XG5cdFx0dGhpcy5fcFZlcnRleERhdGFEaXJ0eVtUcmlhbmdsZVN1Ykdlb21ldHJ5LlRBTkdFTlRfREFUQV0gPSB0cnVlO1xuXHRcdHRoaXMuX3BWZXJ0ZXhEYXRhRGlydHlbVHJpYW5nbGVTdWJHZW9tZXRyeS5VVl9EQVRBXSA9IHRydWU7XG5cblx0XHRyZXR1cm4gZ2VvbWV0cnk7XG5cdH1cblxuXHRwdWJsaWMgc3RhdGljIF9pSW5jbHVkZURlcGVuZGVuY2llcyhzaGFkZXJPYmplY3Q6U2hhZGVyT2JqZWN0QmFzZSlcblx0e1xuXG5cdH1cblxuXHRwdWJsaWMgc3RhdGljIF9pR2V0VmVydGV4Q29kZShzaGFkZXJPYmplY3Q6U2hhZGVyT2JqZWN0QmFzZSwgcmVnaXN0ZXJDYWNoZTpTaGFkZXJSZWdpc3RlckNhY2hlLCBzaGFyZWRSZWdpc3RlcnM6U2hhZGVyUmVnaXN0ZXJEYXRhKTpzdHJpbmdcblx0e1xuXHRcdHZhciBjb2RlOnN0cmluZyA9IFwiXCI7XG5cblx0XHQvL2dldCB0aGUgcHJvamVjdGlvbiBjb29yZGluYXRlc1xuXHRcdHZhciBwb3NpdGlvbjpTaGFkZXJSZWdpc3RlckVsZW1lbnQgPSAoc2hhZGVyT2JqZWN0Lmdsb2JhbFBvc0RlcGVuZGVuY2llcyA+IDApPyBzaGFyZWRSZWdpc3RlcnMuZ2xvYmFsUG9zaXRpb25WZXJ0ZXggOiBzaGFyZWRSZWdpc3RlcnMubG9jYWxQb3NpdGlvbjtcblxuXHRcdC8vcmVzZXJ2aW5nIHZlcnRleCBjb25zdGFudHMgZm9yIHByb2plY3Rpb24gbWF0cml4XG5cdFx0dmFyIHZpZXdNYXRyaXhSZWc6U2hhZGVyUmVnaXN0ZXJFbGVtZW50ID0gcmVnaXN0ZXJDYWNoZS5nZXRGcmVlVmVydGV4Q29uc3RhbnQoKTtcblx0XHRyZWdpc3RlckNhY2hlLmdldEZyZWVWZXJ0ZXhDb25zdGFudCgpO1xuXHRcdHJlZ2lzdGVyQ2FjaGUuZ2V0RnJlZVZlcnRleENvbnN0YW50KCk7XG5cdFx0cmVnaXN0ZXJDYWNoZS5nZXRGcmVlVmVydGV4Q29uc3RhbnQoKTtcblx0XHRzaGFkZXJPYmplY3Qudmlld01hdHJpeEluZGV4ID0gdmlld01hdHJpeFJlZy5pbmRleCo0O1xuXG5cdFx0aWYgKHNoYWRlck9iamVjdC5wcm9qZWN0aW9uRGVwZW5kZW5jaWVzID4gMCkge1xuXHRcdFx0c2hhcmVkUmVnaXN0ZXJzLnByb2plY3Rpb25GcmFnbWVudCA9IHJlZ2lzdGVyQ2FjaGUuZ2V0RnJlZVZhcnlpbmcoKTtcblx0XHRcdHZhciB0ZW1wOlNoYWRlclJlZ2lzdGVyRWxlbWVudCA9IHJlZ2lzdGVyQ2FjaGUuZ2V0RnJlZVZlcnRleFZlY3RvclRlbXAoKTtcblx0XHRcdGNvZGUgKz0gXCJtNDQgXCIgKyB0ZW1wICsgXCIsIFwiICsgcG9zaXRpb24gKyBcIiwgXCIgKyB2aWV3TWF0cml4UmVnICsgXCJcXG5cIiArXG5cdFx0XHRcIm1vdiBcIiArIHNoYXJlZFJlZ2lzdGVycy5wcm9qZWN0aW9uRnJhZ21lbnQgKyBcIiwgXCIgKyB0ZW1wICsgXCJcXG5cIiArXG5cdFx0XHRcIm1vdiBvcCwgXCIgKyB0ZW1wICsgXCJcXG5cIjtcblx0XHR9IGVsc2Uge1xuXHRcdFx0Y29kZSArPSBcIm00NCBvcCwgXCIgKyBwb3NpdGlvbiArIFwiLCBcIiArIHZpZXdNYXRyaXhSZWcgKyBcIlxcblwiO1xuXHRcdH1cblxuXHRcdHJldHVybiBjb2RlO1xuXHR9XG5cblx0LyoqXG5cdCAqIEBpbmhlcml0RG9jXG5cdCAqL1xuXHRwdWJsaWMgX2lSZW5kZXIocGFzczpSZW5kZXJQYXNzQmFzZSwgY2FtZXJhOkNhbWVyYSwgdmlld1Byb2plY3Rpb246TWF0cml4M0QpXG5cdHtcblx0XHRzdXBlci5faVJlbmRlcihwYXNzLCBjYW1lcmEsIHZpZXdQcm9qZWN0aW9uKTtcblxuXHRcdHZhciBzaGFkZXI6U2hhZGVyT2JqZWN0QmFzZSA9IHBhc3Muc2hhZGVyO1xuXG5cdFx0aWYgKHNoYWRlci5zY2VuZU1hdHJpeEluZGV4ID49IDApIHtcblx0XHRcdHRoaXMuc291cmNlRW50aXR5LmdldFJlbmRlclNjZW5lVHJhbnNmb3JtKGNhbWVyYSkuY29weVJhd0RhdGFUbyhzaGFkZXIudmVydGV4Q29uc3RhbnREYXRhLCBzaGFkZXIuc2NlbmVNYXRyaXhJbmRleCwgdHJ1ZSk7XG5cdFx0XHR2aWV3UHJvamVjdGlvbi5jb3B5UmF3RGF0YVRvKHNoYWRlci52ZXJ0ZXhDb25zdGFudERhdGEsIHNoYWRlci52aWV3TWF0cml4SW5kZXgsIHRydWUpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHR2YXIgbWF0cml4M0Q6TWF0cml4M0QgPSBNYXRyaXgzRFV0aWxzLkNBTENVTEFUSU9OX01BVFJJWDtcblxuXHRcdFx0bWF0cml4M0QuY29weUZyb20odGhpcy5zb3VyY2VFbnRpdHkuZ2V0UmVuZGVyU2NlbmVUcmFuc2Zvcm0oY2FtZXJhKSk7XG5cdFx0XHRtYXRyaXgzRC5hcHBlbmQodmlld1Byb2plY3Rpb24pO1xuXG5cdFx0XHRtYXRyaXgzRC5jb3B5UmF3RGF0YVRvKHNoYWRlci52ZXJ0ZXhDb25zdGFudERhdGEsIHNoYWRlci52aWV3TWF0cml4SW5kZXgsIHRydWUpO1xuXHRcdH1cblxuXHRcdHZhciBjb250ZXh0OklDb250ZXh0R0wgPSB0aGlzLl9zdGFnZS5jb250ZXh0O1xuXHRcdGNvbnRleHQuc2V0UHJvZ3JhbUNvbnN0YW50c0Zyb21BcnJheShDb250ZXh0R0xQcm9ncmFtVHlwZS5WRVJURVgsIDAsIHNoYWRlci52ZXJ0ZXhDb25zdGFudERhdGEsIHNoYWRlci5udW1Vc2VkVmVydGV4Q29uc3RhbnRzKTtcblx0XHRjb250ZXh0LnNldFByb2dyYW1Db25zdGFudHNGcm9tQXJyYXkoQ29udGV4dEdMUHJvZ3JhbVR5cGUuRlJBR01FTlQsIDAsIHNoYWRlci5mcmFnbWVudENvbnN0YW50RGF0YSwgc2hhZGVyLm51bVVzZWRGcmFnbWVudENvbnN0YW50cyk7XG5cblx0XHR0aGlzLl9zdGFnZS5hY3RpdmF0ZUJ1ZmZlcigwLCB0aGlzLmdldFZlcnRleERhdGEoVHJpYW5nbGVTdWJHZW9tZXRyeS5QT1NJVElPTl9EQVRBKSwgdGhpcy5nZXRWZXJ0ZXhPZmZzZXQoVHJpYW5nbGVTdWJHZW9tZXRyeS5QT1NJVElPTl9EQVRBKSwgVHJpYW5nbGVTdWJHZW9tZXRyeS5QT1NJVElPTl9GT1JNQVQpO1xuXHRcdHRoaXMuX3N0YWdlLmNvbnRleHQuZHJhd1RyaWFuZ2xlcyh0aGlzLl9zdGFnZS5nZXRJbmRleEJ1ZmZlcih0aGlzLmdldEluZGV4RGF0YSgpKSwgMCwgdGhpcy5udW1UcmlhbmdsZXMpO1xuXHR9XG59XG5cbmV4cG9ydCA9IEJpbGxib2FyZFJlbmRlcmFibGU7Il19