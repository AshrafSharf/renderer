var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var Matrix3DUtils = require("awayjs-core/lib/geom/Matrix3DUtils");
var TriangleSubGeometry = require("awayjs-display/lib/base/TriangleSubGeometry");
var ContextGLVertexBufferFormat = require("awayjs-stagegl/lib/base/ContextGLVertexBufferFormat");
var ContextGLProgramType = require("awayjs-stagegl/lib/base/ContextGLProgramType");
var RenderableBase = require("awayjs-renderergl/lib/pool/RenderableBase");
/**
 * @class away.pool.TriangleSubMeshRenderable
 */
var TriangleSubMeshRenderable = (function (_super) {
    __extends(TriangleSubMeshRenderable, _super);
    /**
     * //TODO
     *
     * @param pool
     * @param subMesh
     * @param level
     * @param indexOffset
     */
    function TriangleSubMeshRenderable(pool, subMesh, stage, level, indexOffset) {
        if (level === void 0) { level = 0; }
        if (indexOffset === void 0) { indexOffset = 0; }
        _super.call(this, pool, subMesh.parentMesh, subMesh, subMesh.material, stage, level, indexOffset);
        this.subMesh = subMesh;
    }
    /**
     *
     * @returns {SubGeometryBase}
     * @protected
     */
    TriangleSubMeshRenderable.prototype._pGetSubGeometry = function () {
        var subGeometry;
        if (this.subMesh.animator)
            subGeometry = this.subMesh.animator.getRenderableSubGeometry(this, this.subMesh.subGeometry);
        else
            subGeometry = this.subMesh.subGeometry;
        this._pVertexDataDirty[TriangleSubGeometry.POSITION_DATA] = true;
        if (subGeometry.vertexNormals)
            this._pVertexDataDirty[TriangleSubGeometry.NORMAL_DATA] = true;
        if (subGeometry.vertexTangents)
            this._pVertexDataDirty[TriangleSubGeometry.TANGENT_DATA] = true;
        if (subGeometry.uvs)
            this._pVertexDataDirty[TriangleSubGeometry.UV_DATA] = true;
        if (subGeometry.secondaryUVs)
            this._pVertexDataDirty[TriangleSubGeometry.SECONDARY_UV_DATA] = true;
        if (subGeometry.jointIndices)
            this._pVertexDataDirty[TriangleSubGeometry.JOINT_INDEX_DATA] = true;
        if (subGeometry.jointWeights)
            this._pVertexDataDirty[TriangleSubGeometry.JOINT_WEIGHT_DATA] = true;
        switch (subGeometry.jointsPerVertex) {
            case 1:
                this.JOINT_INDEX_FORMAT = this.JOINT_WEIGHT_FORMAT = ContextGLVertexBufferFormat.FLOAT_1;
                break;
            case 2:
                this.JOINT_INDEX_FORMAT = this.JOINT_WEIGHT_FORMAT = ContextGLVertexBufferFormat.FLOAT_2;
                break;
            case 3:
                this.JOINT_INDEX_FORMAT = this.JOINT_WEIGHT_FORMAT = ContextGLVertexBufferFormat.FLOAT_3;
                break;
            case 4:
                this.JOINT_INDEX_FORMAT = this.JOINT_WEIGHT_FORMAT = ContextGLVertexBufferFormat.FLOAT_4;
                break;
            default:
        }
        return subGeometry;
    };
    TriangleSubMeshRenderable._iIncludeDependencies = function (shaderObject) {
    };
    TriangleSubMeshRenderable._iGetVertexCode = function (shaderObject, registerCache, sharedRegisters) {
        var code = "";
        //get the projection coordinates
        var position = (shaderObject.globalPosDependencies > 0) ? sharedRegisters.globalPositionVertex : sharedRegisters.localPosition;
        //reserving vertex constants for projection matrix
        var viewMatrixReg = registerCache.getFreeVertexConstant();
        registerCache.getFreeVertexConstant();
        registerCache.getFreeVertexConstant();
        registerCache.getFreeVertexConstant();
        shaderObject.viewMatrixIndex = viewMatrixReg.index * 4;
        if (shaderObject.projectionDependencies > 0) {
            sharedRegisters.projectionFragment = registerCache.getFreeVarying();
            var temp = registerCache.getFreeVertexVectorTemp();
            code += "m44 " + temp + ", " + position + ", " + viewMatrixReg + "\n" + "mov " + sharedRegisters.projectionFragment + ", " + temp + "\n" + "mov op, " + temp + "\n";
        }
        else {
            code += "m44 op, " + position + ", " + viewMatrixReg + "\n";
        }
        return code;
    };
    /**
     * @inheritDoc
     */
    TriangleSubMeshRenderable.prototype._iRender = function (shader, camera, viewProjection) {
        _super.prototype._iRender.call(this, shader, camera, viewProjection);
        if (shader.sceneMatrixIndex >= 0) {
            this.sourceEntity.getRenderSceneTransform(camera).copyRawDataTo(shader.vertexConstantData, shader.sceneMatrixIndex, true);
            viewProjection.copyRawDataTo(shader.vertexConstantData, shader.viewMatrixIndex, true);
        }
        else {
            var matrix3D = Matrix3DUtils.CALCULATION_MATRIX;
            matrix3D.copyFrom(this.sourceEntity.getRenderSceneTransform(camera));
            matrix3D.append(viewProjection);
            matrix3D.copyRawDataTo(shader.vertexConstantData, shader.viewMatrixIndex, true);
        }
        var context = this._stage.context;
        context.setProgramConstantsFromArray(ContextGLProgramType.VERTEX, 0, shader.vertexConstantData, shader.numUsedVertexConstants);
        context.setProgramConstantsFromArray(ContextGLProgramType.FRAGMENT, 0, shader.fragmentConstantData, shader.numUsedFragmentConstants);
        this._stage.activateBuffer(0, this.getVertexData(TriangleSubGeometry.POSITION_DATA), this.getVertexOffset(TriangleSubGeometry.POSITION_DATA), TriangleSubGeometry.POSITION_FORMAT);
        this._stage.context.drawTriangles(this._stage.getIndexBuffer(this.getIndexData()), 0, this.numTriangles);
    };
    /**
     * //TODO
     *
     * @param pool
     * @param renderableOwner
     * @param level
     * @param indexOffset
     * @returns {away.pool.TriangleSubMeshRenderable}
     * @protected
     */
    TriangleSubMeshRenderable.prototype._pGetOverflowRenderable = function (indexOffset) {
        return new TriangleSubMeshRenderable(this._pool, this.renderableOwner, this._stage, this._level + 1, indexOffset);
    };
    /**
     *
     */
    TriangleSubMeshRenderable.id = "trianglesubmesh";
    TriangleSubMeshRenderable.vertexAttributesOffset = 1;
    return TriangleSubMeshRenderable;
})(RenderableBase);
module.exports = TriangleSubMeshRenderable;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9wb29sL3RyaWFuZ2xlc3VibWVzaHJlbmRlcmFibGUudHMiXSwibmFtZXMiOlsiVHJpYW5nbGVTdWJNZXNoUmVuZGVyYWJsZSIsIlRyaWFuZ2xlU3ViTWVzaFJlbmRlcmFibGUuY29uc3RydWN0b3IiLCJUcmlhbmdsZVN1Yk1lc2hSZW5kZXJhYmxlLl9wR2V0U3ViR2VvbWV0cnkiLCJUcmlhbmdsZVN1Yk1lc2hSZW5kZXJhYmxlLl9pSW5jbHVkZURlcGVuZGVuY2llcyIsIlRyaWFuZ2xlU3ViTWVzaFJlbmRlcmFibGUuX2lHZXRWZXJ0ZXhDb2RlIiwiVHJpYW5nbGVTdWJNZXNoUmVuZGVyYWJsZS5faVJlbmRlciIsIlRyaWFuZ2xlU3ViTWVzaFJlbmRlcmFibGUuX3BHZXRPdmVyZmxvd1JlbmRlcmFibGUiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUNBLElBQU8sYUFBYSxXQUFjLG9DQUFvQyxDQUFDLENBQUM7QUFJeEUsSUFBTyxtQkFBbUIsV0FBYSw2Q0FBNkMsQ0FBQyxDQUFDO0FBR3RGLElBQU8sMkJBQTJCLFdBQVcscURBQXFELENBQUMsQ0FBQztBQUdwRyxJQUFPLG9CQUFvQixXQUFhLDhDQUE4QyxDQUFDLENBQUM7QUFNeEYsSUFBTyxjQUFjLFdBQWMsMkNBQTJDLENBQUMsQ0FBQztBQUloRixBQUdBOztHQURHO0lBQ0cseUJBQXlCO0lBQVNBLFVBQWxDQSx5QkFBeUJBLFVBQXVCQTtJQWVyREE7Ozs7Ozs7T0FPR0E7SUFDSEEsU0F2QktBLHlCQUF5QkEsQ0F1QmxCQSxJQUFtQkEsRUFBRUEsT0FBdUJBLEVBQUVBLEtBQVdBLEVBQUVBLEtBQWdCQSxFQUFFQSxXQUFzQkE7UUFBeENDLHFCQUFnQkEsR0FBaEJBLFNBQWdCQTtRQUFFQSwyQkFBc0JBLEdBQXRCQSxlQUFzQkE7UUFFOUdBLGtCQUFNQSxJQUFJQSxFQUFFQSxPQUFPQSxDQUFDQSxVQUFVQSxFQUFFQSxPQUFPQSxFQUFFQSxPQUFPQSxDQUFDQSxRQUFR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LENBQUNBO0lBRURMOzs7Ozs7Ozs7T0FTR0E7SUFDSUEsMkRBQXVCQSxHQUE5QkEsVUFBK0JBLFdBQWtCQTtRQUVoRE0sTUFBTUEsQ0FBQ0EsSUFBSUEseUJBQXlCQSxDQUFDQSxJQUFJQSxDQUFDQSxLQUFLQSxFQUFvQkEsSUFBSUEsQ0FBQ0EsZUFBZUEsRUFBRUEsSUFBSUEsQ0FBQ0EsTUFBTUEsRUFBRUEsSUFBSUEsQ0FBQ0EsTUFBTUEsR0FBR0EsQ0FBQ0EsRUFBRUEsV0FBV0EsQ0FBQ0EsQ0FBQ0E7SUFDcklBLENBQUNBO0lBMUpETjs7T0FFR0E7SUFDV0EsNEJBQUVBLEdBQVVBLGlCQUFpQkEsQ0FBQ0E7SUFFOUJBLGdEQUFzQkEsR0FBVUEsQ0FBQ0EsQ0FBQ0E7SUFzSmpEQSxnQ0FBQ0E7QUFBREEsQ0E3SkEsQUE2SkNBLEVBN0p1QyxjQUFjLEVBNkpyRDtBQUVELEFBQW1DLGlCQUExQix5QkFBeUIsQ0FBQyIsImZpbGUiOiJwb29sL1RyaWFuZ2xlU3ViTWVzaFJlbmRlcmFibGUuanMiLCJzb3VyY2VSb290IjoiLi4vIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IE1hdHJpeDNEXHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2dlb20vTWF0cml4M0RcIik7XG5pbXBvcnQgTWF0cml4M0RVdGlsc1x0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2dlb20vTWF0cml4M0RVdGlsc1wiKTtcblxuaW1wb3J0IElSZW5kZXJhYmxlT3duZXJcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9iYXNlL0lSZW5kZXJhYmxlT3duZXJcIik7XG5pbXBvcnQgVHJpYW5nbGVTdWJNZXNoXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvYmFzZS9UcmlhbmdsZVN1Yk1lc2hcIik7XG5pbXBvcnQgVHJpYW5nbGVTdWJHZW9tZXRyeVx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9iYXNlL1RyaWFuZ2xlU3ViR2VvbWV0cnlcIik7XG5pbXBvcnQgQ2FtZXJhXHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL2VudGl0aWVzL0NhbWVyYVwiKTtcblxuaW1wb3J0IENvbnRleHRHTFZlcnRleEJ1ZmZlckZvcm1hdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2Jhc2UvQ29udGV4dEdMVmVydGV4QnVmZmVyRm9ybWF0XCIpO1xuaW1wb3J0IElDb250ZXh0R0xcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2Jhc2UvSUNvbnRleHRHTFwiKTtcbmltcG9ydCBTdGFnZVx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9iYXNlL1N0YWdlXCIpO1xuaW1wb3J0IENvbnRleHRHTFByb2dyYW1UeXBlXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2Jhc2UvQ29udGV4dEdMUHJvZ3JhbVR5cGVcIik7XG5cbmltcG9ydCBTaGFkZXJPYmplY3RCYXNlXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvY29tcGlsYXRpb24vU2hhZGVyT2JqZWN0QmFzZVwiKTtcbmltcG9ydCBTaGFkZXJSZWdpc3RlckNhY2hlXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2NvbXBpbGF0aW9uL1NoYWRlclJlZ2lzdGVyQ2FjaGVcIik7XG5pbXBvcnQgU2hhZGVyUmVnaXN0ZXJEYXRhXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2NvbXBpbGF0aW9uL1NoYWRlclJlZ2lzdGVyRGF0YVwiKTtcbmltcG9ydCBTaGFkZXJSZWdpc3RlckVsZW1lbnRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2NvbXBpbGF0aW9uL1NoYWRlclJlZ2lzdGVyRWxlbWVudFwiKTtcbmltcG9ydCBSZW5kZXJhYmxlQmFzZVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL3Bvb2wvUmVuZGVyYWJsZUJhc2VcIik7XG5pbXBvcnQgUmVuZGVyYWJsZVBvb2xcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9wb29sL1JlbmRlcmFibGVQb29sXCIpO1xuaW1wb3J0IFJlbmRlck9iamVjdEJhc2VcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9jb21waWxhdGlvbi9SZW5kZXJPYmplY3RCYXNlXCIpO1xuXG4vKipcbiAqIEBjbGFzcyBhd2F5LnBvb2wuVHJpYW5nbGVTdWJNZXNoUmVuZGVyYWJsZVxuICovXG5jbGFzcyBUcmlhbmdsZVN1Yk1lc2hSZW5kZXJhYmxlIGV4dGVuZHMgUmVuZGVyYWJsZUJhc2Vcbntcblx0LyoqXG5cdCAqXG5cdCAqL1xuXHRwdWJsaWMgc3RhdGljIGlkOnN0cmluZyA9IFwidHJpYW5nbGVzdWJtZXNoXCI7XG5cblx0cHVibGljIHN0YXRpYyB2ZXJ0ZXhBdHRyaWJ1dGVzT2Zmc2V0Om51bWJlciA9IDE7XG5cblx0LyoqXG5cdCAqXG5cdCAqL1xuXHRwdWJsaWMgc3ViTWVzaDpUcmlhbmdsZVN1Yk1lc2g7XG5cblxuXHQvKipcblx0ICogLy9UT0RPXG5cdCAqXG5cdCAqIEBwYXJhbSBwb29sXG5cdCAqIEBwYXJhbSBzdWJNZXNoXG5cdCAqIEBwYXJhbSBsZXZlbFxuXHQgKiBAcGFyYW0gaW5kZXhPZmZzZXRcblx0ICovXG5cdGNvbnN0cnVjdG9yKHBvb2w6UmVuZGVyYWJsZVBvb2wsIHN1Yk1lc2g6VHJpYW5nbGVTdWJNZXNoLCBzdGFnZTpTdGFnZSwgbGV2ZWw6bnVtYmVyID0gMCwgaW5kZXhPZmZzZXQ6bnVtYmVyID0gMClcblx0e1xuXHRcdHN1cGVyKHBvb2wsIHN1Yk1lc2gucGFyZW50TWVzaCwgc3ViTWVzaCwgc3ViTWVzaC5tYXRlcmlhbCwgc3RhZ2UsIGxldmVsLCBpbmRleE9mZnNldCk7XG5cblx0XHR0aGlzLnN1Yk1lc2ggPSBzdWJNZXNoO1xuXHR9XG5cblx0LyoqXG5cdCAqXG5cdCAqIEByZXR1cm5zIHtTdWJHZW9tZXRyeUJhc2V9XG5cdCAqIEBwcm90ZWN0ZWRcblx0ICovXG5cdHB1YmxpYyBfcEdldFN1Ykdlb21ldHJ5KCk6VHJpYW5nbGVTdWJHZW9tZXRyeVxuXHR7XG5cdFx0dmFyIHN1Ykdlb21ldHJ5OlRyaWFuZ2xlU3ViR2VvbWV0cnk7XG5cblx0XHRpZiAodGhpcy5zdWJNZXNoLmFuaW1hdG9yKVxuXHRcdFx0c3ViR2VvbWV0cnkgPSA8VHJpYW5nbGVTdWJHZW9tZXRyeT4gdGhpcy5zdWJNZXNoLmFuaW1hdG9yLmdldFJlbmRlcmFibGVTdWJHZW9tZXRyeSh0aGlzLCB0aGlzLnN1Yk1lc2guc3ViR2VvbWV0cnkpO1xuXHRcdGVsc2Vcblx0XHRcdHN1Ykdlb21ldHJ5ID0gdGhpcy5zdWJNZXNoLnN1Ykdlb21ldHJ5O1xuXG5cdFx0dGhpcy5fcFZlcnRleERhdGFEaXJ0eVtUcmlhbmdsZVN1Ykdlb21ldHJ5LlBPU0lUSU9OX0RBVEFdID0gdHJ1ZTtcblxuXHRcdGlmIChzdWJHZW9tZXRyeS52ZXJ0ZXhOb3JtYWxzKVxuXHRcdFx0dGhpcy5fcFZlcnRleERhdGFEaXJ0eVtUcmlhbmdsZVN1Ykdlb21ldHJ5Lk5PUk1BTF9EQVRBXSA9IHRydWU7XG5cblx0XHRpZiAoc3ViR2VvbWV0cnkudmVydGV4VGFuZ2VudHMpXG5cdFx0XHR0aGlzLl9wVmVydGV4RGF0YURpcnR5W1RyaWFuZ2xlU3ViR2VvbWV0cnkuVEFOR0VOVF9EQVRBXSA9IHRydWU7XG5cblx0XHRpZiAoc3ViR2VvbWV0cnkudXZzKVxuXHRcdFx0dGhpcy5fcFZlcnRleERhdGFEaXJ0eVtUcmlhbmdsZVN1Ykdlb21ldHJ5LlVWX0RBVEFdID0gdHJ1ZTtcblxuXHRcdGlmIChzdWJHZW9tZXRyeS5zZWNvbmRhcnlVVnMpXG5cdFx0XHR0aGlzLl9wVmVydGV4RGF0YURpcnR5W1RyaWFuZ2xlU3ViR2VvbWV0cnkuU0VDT05EQVJZX1VWX0RBVEFdID0gdHJ1ZTtcblxuXHRcdGlmIChzdWJHZW9tZXRyeS5qb2ludEluZGljZXMpXG5cdFx0XHR0aGlzLl9wVmVydGV4RGF0YURpcnR5W1RyaWFuZ2xlU3ViR2VvbWV0cnkuSk9JTlRfSU5ERVhfREFUQV0gPSB0cnVlO1xuXG5cdFx0aWYgKHN1Ykdlb21ldHJ5LmpvaW50V2VpZ2h0cylcblx0XHRcdHRoaXMuX3BWZXJ0ZXhEYXRhRGlydHlbVHJpYW5nbGVTdWJHZW9tZXRyeS5KT0lOVF9XRUlHSFRfREFUQV0gPSB0cnVlO1xuXG5cdFx0c3dpdGNoKHN1Ykdlb21ldHJ5LmpvaW50c1BlclZlcnRleCkge1xuXHRcdFx0Y2FzZSAxOlxuXHRcdFx0XHR0aGlzLkpPSU5UX0lOREVYX0ZPUk1BVCA9IHRoaXMuSk9JTlRfV0VJR0hUX0ZPUk1BVCA9IENvbnRleHRHTFZlcnRleEJ1ZmZlckZvcm1hdC5GTE9BVF8xO1xuXHRcdFx0XHRicmVhaztcblx0XHRcdGNhc2UgMjpcblx0XHRcdFx0dGhpcy5KT0lOVF9JTkRFWF9GT1JNQVQgPSB0aGlzLkpPSU5UX1dFSUdIVF9GT1JNQVQgPSBDb250ZXh0R0xWZXJ0ZXhCdWZmZXJGb3JtYXQuRkxPQVRfMjtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRjYXNlIDM6XG5cdFx0XHRcdHRoaXMuSk9JTlRfSU5ERVhfRk9STUFUID0gdGhpcy5KT0lOVF9XRUlHSFRfRk9STUFUID0gQ29udGV4dEdMVmVydGV4QnVmZmVyRm9ybWF0LkZMT0FUXzM7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0Y2FzZSA0OlxuXHRcdFx0XHR0aGlzLkpPSU5UX0lOREVYX0ZPUk1BVCA9IHRoaXMuSk9JTlRfV0VJR0hUX0ZPUk1BVCA9IENvbnRleHRHTFZlcnRleEJ1ZmZlckZvcm1hdC5GTE9BVF80O1xuXHRcdFx0XHRicmVhaztcblx0XHRcdGRlZmF1bHQ6XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHN1Ykdlb21ldHJ5O1xuXHR9XG5cblxuXHRwdWJsaWMgc3RhdGljIF9pSW5jbHVkZURlcGVuZGVuY2llcyhzaGFkZXJPYmplY3Q6U2hhZGVyT2JqZWN0QmFzZSlcblx0e1xuXG5cdH1cblxuXHRwdWJsaWMgc3RhdGljIF9pR2V0VmVydGV4Q29kZShzaGFkZXJPYmplY3Q6U2hhZGVyT2JqZWN0QmFzZSwgcmVnaXN0ZXJDYWNoZTpTaGFkZXJSZWdpc3RlckNhY2hlLCBzaGFyZWRSZWdpc3RlcnM6U2hhZGVyUmVnaXN0ZXJEYXRhKTpzdHJpbmdcblx0e1xuXHRcdHZhciBjb2RlOnN0cmluZyA9IFwiXCI7XG5cblx0XHQvL2dldCB0aGUgcHJvamVjdGlvbiBjb29yZGluYXRlc1xuXHRcdHZhciBwb3NpdGlvbjpTaGFkZXJSZWdpc3RlckVsZW1lbnQgPSAoc2hhZGVyT2JqZWN0Lmdsb2JhbFBvc0RlcGVuZGVuY2llcyA+IDApPyBzaGFyZWRSZWdpc3RlcnMuZ2xvYmFsUG9zaXRpb25WZXJ0ZXggOiBzaGFyZWRSZWdpc3RlcnMubG9jYWxQb3NpdGlvbjtcblxuXHRcdC8vcmVzZXJ2aW5nIHZlcnRleCBjb25zdGFudHMgZm9yIHByb2plY3Rpb24gbWF0cml4XG5cdFx0dmFyIHZpZXdNYXRyaXhSZWc6U2hhZGVyUmVnaXN0ZXJFbGVtZW50ID0gcmVnaXN0ZXJDYWNoZS5nZXRGcmVlVmVydGV4Q29uc3RhbnQoKTtcblx0XHRyZWdpc3RlckNhY2hlLmdldEZyZWVWZXJ0ZXhDb25zdGFudCgpO1xuXHRcdHJlZ2lzdGVyQ2FjaGUuZ2V0RnJlZVZlcnRleENvbnN0YW50KCk7XG5cdFx0cmVnaXN0ZXJDYWNoZS5nZXRGcmVlVmVydGV4Q29uc3RhbnQoKTtcblx0XHRzaGFkZXJPYmplY3Qudmlld01hdHJpeEluZGV4ID0gdmlld01hdHJpeFJlZy5pbmRleCo0O1xuXG5cdFx0aWYgKHNoYWRlck9iamVjdC5wcm9qZWN0aW9uRGVwZW5kZW5jaWVzID4gMCkge1xuXHRcdFx0c2hhcmVkUmVnaXN0ZXJzLnByb2plY3Rpb25GcmFnbWVudCA9IHJlZ2lzdGVyQ2FjaGUuZ2V0RnJlZVZhcnlpbmcoKTtcblx0XHRcdHZhciB0ZW1wOlNoYWRlclJlZ2lzdGVyRWxlbWVudCA9IHJlZ2lzdGVyQ2FjaGUuZ2V0RnJlZVZlcnRleFZlY3RvclRlbXAoKTtcblx0XHRcdGNvZGUgKz0gXCJtNDQgXCIgKyB0ZW1wICsgXCIsIFwiICsgcG9zaXRpb24gKyBcIiwgXCIgKyB2aWV3TWF0cml4UmVnICsgXCJcXG5cIiArXG5cdFx0XHRcIm1vdiBcIiArIHNoYXJlZFJlZ2lzdGVycy5wcm9qZWN0aW9uRnJhZ21lbnQgKyBcIiwgXCIgKyB0ZW1wICsgXCJcXG5cIiArXG5cdFx0XHRcIm1vdiBvcCwgXCIgKyB0ZW1wICsgXCJcXG5cIjtcblx0XHR9IGVsc2Uge1xuXHRcdFx0Y29kZSArPSBcIm00NCBvcCwgXCIgKyBwb3NpdGlvbiArIFwiLCBcIiArIHZpZXdNYXRyaXhSZWcgKyBcIlxcblwiO1xuXHRcdH1cblxuXHRcdHJldHVybiBjb2RlO1xuXHR9XG5cblx0LyoqXG5cdCAqIEBpbmhlcml0RG9jXG5cdCAqL1xuXHRwdWJsaWMgX2lSZW5kZXIoc2hhZGVyOlNoYWRlck9iamVjdEJhc2UsIGNhbWVyYTpDYW1lcmEsIHZpZXdQcm9qZWN0aW9uOk1hdHJpeDNEKVxuXHR7XG5cdFx0c3VwZXIuX2lSZW5kZXIoc2hhZGVyLCBjYW1lcmEsIHZpZXdQcm9qZWN0aW9uKTtcblxuXHRcdGlmIChzaGFkZXIuc2NlbmVNYXRyaXhJbmRleCA+PSAwKSB7XG5cdFx0XHR0aGlzLnNvdXJjZUVudGl0eS5nZXRSZW5kZXJTY2VuZVRyYW5zZm9ybShjYW1lcmEpLmNvcHlSYXdEYXRhVG8oc2hhZGVyLnZlcnRleENvbnN0YW50RGF0YSwgc2hhZGVyLnNjZW5lTWF0cml4SW5kZXgsIHRydWUpO1xuXHRcdFx0dmlld1Byb2plY3Rpb24uY29weVJhd0RhdGFUbyhzaGFkZXIudmVydGV4Q29uc3RhbnREYXRhLCBzaGFkZXIudmlld01hdHJpeEluZGV4LCB0cnVlKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dmFyIG1hdHJpeDNEOk1hdHJpeDNEID0gTWF0cml4M0RVdGlscy5DQUxDVUxBVElPTl9NQVRSSVg7XG5cblx0XHRcdG1hdHJpeDNELmNvcHlGcm9tKHRoaXMuc291cmNlRW50aXR5LmdldFJlbmRlclNjZW5lVHJhbnNmb3JtKGNhbWVyYSkpO1xuXHRcdFx0bWF0cml4M0QuYXBwZW5kKHZpZXdQcm9qZWN0aW9uKTtcblxuXHRcdFx0bWF0cml4M0QuY29weVJhd0RhdGFUbyhzaGFkZXIudmVydGV4Q29uc3RhbnREYXRhLCBzaGFkZXIudmlld01hdHJpeEluZGV4LCB0cnVlKTtcblx0XHR9XG5cblx0XHR2YXIgY29udGV4dDpJQ29udGV4dEdMID0gdGhpcy5fc3RhZ2UuY29udGV4dDtcblx0XHRjb250ZXh0LnNldFByb2dyYW1Db25zdGFudHNGcm9tQXJyYXkoQ29udGV4dEdMUHJvZ3JhbVR5cGUuVkVSVEVYLCAwLCBzaGFkZXIudmVydGV4Q29uc3RhbnREYXRhLCBzaGFkZXIubnVtVXNlZFZlcnRleENvbnN0YW50cyk7XG5cdFx0Y29udGV4dC5zZXRQcm9ncmFtQ29uc3RhbnRzRnJvbUFycmF5KENvbnRleHRHTFByb2dyYW1UeXBlLkZSQUdNRU5ULCAwLCBzaGFkZXIuZnJhZ21lbnRDb25zdGFudERhdGEsIHNoYWRlci5udW1Vc2VkRnJhZ21lbnRDb25zdGFudHMpO1xuXG5cdFx0dGhpcy5fc3RhZ2UuYWN0aXZhdGVCdWZmZXIoMCwgdGhpcy5nZXRWZXJ0ZXhEYXRhKFRyaWFuZ2xlU3ViR2VvbWV0cnkuUE9TSVRJT05fREFUQSksIHRoaXMuZ2V0VmVydGV4T2Zmc2V0KFRyaWFuZ2xlU3ViR2VvbWV0cnkuUE9TSVRJT05fREFUQSksIFRyaWFuZ2xlU3ViR2VvbWV0cnkuUE9TSVRJT05fRk9STUFUKTtcblx0XHR0aGlzLl9zdGFnZS5jb250ZXh0LmRyYXdUcmlhbmdsZXModGhpcy5fc3RhZ2UuZ2V0SW5kZXhCdWZmZXIodGhpcy5nZXRJbmRleERhdGEoKSksIDAsIHRoaXMubnVtVHJpYW5nbGVzKTtcblx0fVxuXG5cdC8qKlxuXHQgKiAvL1RPRE9cblx0ICpcblx0ICogQHBhcmFtIHBvb2xcblx0ICogQHBhcmFtIHJlbmRlcmFibGVPd25lclxuXHQgKiBAcGFyYW0gbGV2ZWxcblx0ICogQHBhcmFtIGluZGV4T2Zmc2V0XG5cdCAqIEByZXR1cm5zIHthd2F5LnBvb2wuVHJpYW5nbGVTdWJNZXNoUmVuZGVyYWJsZX1cblx0ICogQHByb3RlY3RlZFxuXHQgKi9cblx0cHVibGljIF9wR2V0T3ZlcmZsb3dSZW5kZXJhYmxlKGluZGV4T2Zmc2V0Om51bWJlcik6UmVuZGVyYWJsZUJhc2Vcblx0e1xuXHRcdHJldHVybiBuZXcgVHJpYW5nbGVTdWJNZXNoUmVuZGVyYWJsZSh0aGlzLl9wb29sLCA8VHJpYW5nbGVTdWJNZXNoPiB0aGlzLnJlbmRlcmFibGVPd25lciwgdGhpcy5fc3RhZ2UsIHRoaXMuX2xldmVsICsgMSwgaW5kZXhPZmZzZXQpO1xuXHR9XG59XG5cbmV4cG9ydCA9IFRyaWFuZ2xlU3ViTWVzaFJlbmRlcmFibGU7Il19