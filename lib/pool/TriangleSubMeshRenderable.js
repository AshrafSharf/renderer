var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var Matrix3DUtils = require("awayjs-core/lib/geom/Matrix3DUtils");
var TriangleSubGeometry = require("awayjs-display/lib/base/TriangleSubGeometry");
var ContextGLVertexBufferFormat = require("awayjs-stagegl/lib/base/ContextGLVertexBufferFormat");
var ContextGLProgramType = require("awayjs-stagegl/lib/base/ContextGLProgramType");
var RenderableBase = require("awayjs-renderergl/lib/pool/RenderableBase");
/**
 * @class away.pool.TriangleSubMeshRenderable
 */
var TriangleSubMeshRenderable = (function (_super) {
    __extends(TriangleSubMeshRenderable, _super);
    /**
     * //TODO
     *
     * @param pool
     * @param subMesh
     * @param level
     * @param indexOffset
     */
    function TriangleSubMeshRenderable(pool, subMesh, stage, level, indexOffset) {
        if (level === void 0) { level = 0; }
        if (indexOffset === void 0) { indexOffset = 0; }
        _super.call(this, pool, subMesh.parentMesh, subMesh, subMesh.material, stage, level, indexOffset);
        this.subMesh = subMesh;
    }
    /**
     *
     * @returns {SubGeometryBase}
     * @protected
     */
    TriangleSubMeshRenderable.prototype._pGetSubGeometry = function () {
        var subGeometry;
        if (this.subMesh.animator)
            subGeometry = this.subMesh.animator.getRenderableSubGeometry(this, this.subMesh.subGeometry);
        else
            subGeometry = this.subMesh.subGeometry;
        this._pVertexDataDirty[TriangleSubGeometry.POSITION_DATA] = true;
        if (subGeometry.vertexNormals)
            this._pVertexDataDirty[TriangleSubGeometry.NORMAL_DATA] = true;
        if (subGeometry.vertexTangents)
            this._pVertexDataDirty[TriangleSubGeometry.TANGENT_DATA] = true;
        if (subGeometry.uvs)
            this._pVertexDataDirty[TriangleSubGeometry.UV_DATA] = true;
        if (subGeometry.secondaryUVs)
            this._pVertexDataDirty[TriangleSubGeometry.SECONDARY_UV_DATA] = true;
        if (subGeometry.jointIndices)
            this._pVertexDataDirty[TriangleSubGeometry.JOINT_INDEX_DATA] = true;
        if (subGeometry.jointWeights)
            this._pVertexDataDirty[TriangleSubGeometry.JOINT_WEIGHT_DATA] = true;
        switch (subGeometry.jointsPerVertex) {
            case 1:
                this.JOINT_INDEX_FORMAT = this.JOINT_WEIGHT_FORMAT = ContextGLVertexBufferFormat.FLOAT_1;
                break;
            case 2:
                this.JOINT_INDEX_FORMAT = this.JOINT_WEIGHT_FORMAT = ContextGLVertexBufferFormat.FLOAT_2;
                break;
            case 3:
                this.JOINT_INDEX_FORMAT = this.JOINT_WEIGHT_FORMAT = ContextGLVertexBufferFormat.FLOAT_3;
                break;
            case 4:
                this.JOINT_INDEX_FORMAT = this.JOINT_WEIGHT_FORMAT = ContextGLVertexBufferFormat.FLOAT_4;
                break;
            default:
        }
        return subGeometry;
    };
    TriangleSubMeshRenderable._iIncludeDependencies = function (shaderObject) {
    };
    TriangleSubMeshRenderable._iGetVertexCode = function (shaderObject, registerCache, sharedRegisters) {
        var code = "";
        //get the projection coordinates
        var position = (shaderObject.globalPosDependencies > 0) ? sharedRegisters.globalPositionVertex : sharedRegisters.localPosition;
        //reserving vertex constants for projection matrix
        var viewMatrixReg = registerCache.getFreeVertexConstant();
        registerCache.getFreeVertexConstant();
        registerCache.getFreeVertexConstant();
        registerCache.getFreeVertexConstant();
        shaderObject.viewMatrixIndex = viewMatrixReg.index * 4;
        if (shaderObject.projectionDependencies > 0) {
            sharedRegisters.projectionFragment = registerCache.getFreeVarying();
            var temp = registerCache.getFreeVertexVectorTemp();
            code += "m44 " + temp + ", " + position + ", " + viewMatrixReg + "\n" + "mov " + sharedRegisters.projectionFragment + ", " + temp + "\n" + "mov op, " + temp + "\n";
        }
        else {
            code += "m44 op, " + position + ", " + viewMatrixReg + "\n";
        }
        return code;
    };
    /**
     * @inheritDoc
     */
    TriangleSubMeshRenderable.prototype._iRender = function (pass, camera, viewProjection) {
        _super.prototype._iRender.call(this, pass, camera, viewProjection);
        var shader = pass.shader;
        if (shader.sceneMatrixIndex >= 0) {
            this.sourceEntity.getRenderSceneTransform(camera).copyRawDataTo(shader.vertexConstantData, shader.sceneMatrixIndex, true);
            viewProjection.copyRawDataTo(shader.vertexConstantData, shader.viewMatrixIndex, true);
        }
        else {
            var matrix3D = Matrix3DUtils.CALCULATION_MATRIX;
            matrix3D.copyFrom(this.sourceEntity.getRenderSceneTransform(camera));
            matrix3D.append(viewProjection);
            matrix3D.copyRawDataTo(shader.vertexConstantData, shader.viewMatrixIndex, true);
        }
        var context = this._stage.context;
        context.setProgramConstantsFromArray(ContextGLProgramType.VERTEX, 0, shader.vertexConstantData, shader.numUsedVertexConstants);
        context.setProgramConstantsFromArray(ContextGLProgramType.FRAGMENT, 0, shader.fragmentConstantData, shader.numUsedFragmentConstants);
        this._stage.activateBuffer(0, this.getVertexData(TriangleSubGeometry.POSITION_DATA), this.getVertexOffset(TriangleSubGeometry.POSITION_DATA), TriangleSubGeometry.POSITION_FORMAT);
        this._stage.context.drawTriangles(this._stage.getIndexBuffer(this.getIndexData()), 0, this.numTriangles);
    };
    /**
     * //TODO
     *
     * @param pool
     * @param renderableOwner
     * @param level
     * @param indexOffset
     * @returns {away.pool.TriangleSubMeshRenderable}
     * @protected
     */
    TriangleSubMeshRenderable.prototype._pGetOverflowRenderable = function (indexOffset) {
        return new TriangleSubMeshRenderable(this._pool, this.renderableOwner, this._stage, this._level + 1, indexOffset);
    };
    /**
     *
     */
    TriangleSubMeshRenderable.id = "trianglesubmesh";
    TriangleSubMeshRenderable.vertexAttributesOffset = 1;
    return TriangleSubMeshRenderable;
})(RenderableBase);
module.exports = TriangleSubMeshRenderable;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9wb29sL1RyaWFuZ2xlU3ViTWVzaFJlbmRlcmFibGUudHMiXSwibmFtZXMiOlsiVHJpYW5nbGVTdWJNZXNoUmVuZGVyYWJsZSIsIlRyaWFuZ2xlU3ViTWVzaFJlbmRlcmFibGUuY29uc3RydWN0b3IiLCJUcmlhbmdsZVN1Yk1lc2hSZW5kZXJhYmxlLl9wR2V0U3ViR2VvbWV0cnkiLCJUcmlhbmdsZVN1Yk1lc2hSZW5kZXJhYmxlLl9pSW5jbHVkZURlcGVuZGVuY2llcyIsIlRyaWFuZ2xlU3ViTWVzaFJlbmRlcmFibGUuX2lHZXRWZXJ0ZXhDb2RlIiwiVHJpYW5nbGVTdWJNZXNoUmVuZGVyYWJsZS5faVJlbmRlciIsIlRyaWFuZ2xlU3ViTWVzaFJlbmRlcmFibGUuX3BHZXRPdmVyZmxvd1JlbmRlcmFibGUiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUNBLElBQU8sYUFBYSxXQUFjLG9DQUFvQyxDQUFDLENBQUM7QUFJeEUsSUFBTyxtQkFBbUIsV0FBYSw2Q0FBNkMsQ0FBQyxDQUFDO0FBR3RGLElBQU8sMkJBQTJCLFdBQVcscURBQXFELENBQUMsQ0FBQztBQUdwRyxJQUFPLG9CQUFvQixXQUFhLDhDQUE4QyxDQUFDLENBQUM7QUFNeEYsSUFBTyxjQUFjLFdBQWMsMkNBQTJDLENBQUMsQ0FBQztBQUloRixBQUdBOztHQURHO0lBQ0cseUJBQXlCO0lBQVNBLFVBQWxDQSx5QkFBeUJBLFVBQXVCQTtJQWVyREE7Ozs7Ozs7T0FPR0E7SUFDSEEsU0F2QktBLHlCQUF5QkEsQ0F1QmxCQSxJQUF1QkEsRUFBRUEsT0FBdUJBLEVBQUVBLEtBQVdBLEVBQUVBLEtBQWdCQSxFQUFFQSxXQUFzQkE7UUFBeENDLHFCQUFnQkEsR0FBaEJBLFNBQWdCQTtRQUFFQSwyQkFBc0JBLEdBQXRCQSxlQUFzQkE7UUFFbEhBLGtCQUFNQSxJQUFJQSxFQUFFQSxPQUFPQSxDQUFDQSxVQUFVQSxFQUFFQSxPQUFPQSxFQUFFQSxPQUFPQSxDQUFDQSxRQUFR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QSxDQUFDQSxFQUFFQSxJQUFJQSxDQUFDQSxZQUFZQSxDQUFDQSxDQUFDQTtJQUMxR0EsQ0FBQ0E7SUFFREw7Ozs7Ozs7OztPQVNHQTtJQUNJQSwyREFBdUJBLEdBQTlCQSxVQUErQkEsV0FBa0JBO1FBRWhETSxNQUFNQSxDQUFDQSxJQUFJQSx5QkFBeUJBLENBQUNBLElBQUlBLENBQUNBLEtBQUtBLEVBQW9CQSxJQUFJQSxDQUFDQSxlQUFlQSxFQUFFQSxJQUFJQSxDQUFDQSxNQUFNQSxFQUFFQSxJQUFJQSxDQUFDQSxNQUFNQSxHQUFHQSxDQUFDQSxFQUFFQSxXQUFXQSxDQUFDQSxDQUFDQTtJQUNySUEsQ0FBQ0E7SUE1SkROOztPQUVHQTtJQUNXQSw0QkFBRUEsR0FBVUEsaUJBQWlCQSxDQUFDQTtJQUU5QkEsZ0RBQXNCQSxHQUFVQSxDQUFDQSxDQUFDQTtJQXdKakRBLGdDQUFDQTtBQUFEQSxDQS9KQSxBQStKQ0EsRUEvSnVDLGNBQWMsRUErSnJEO0FBRUQsQUFBbUMsaUJBQTFCLHlCQUF5QixDQUFDIiwiZmlsZSI6InBvb2wvVHJpYW5nbGVTdWJNZXNoUmVuZGVyYWJsZS5qcyIsInNvdXJjZVJvb3QiOiIuLi8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgTWF0cml4M0RcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvZ2VvbS9NYXRyaXgzRFwiKTtcclxuaW1wb3J0IE1hdHJpeDNEVXRpbHNcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9nZW9tL01hdHJpeDNEVXRpbHNcIik7XHJcblxyXG5pbXBvcnQgSVJlbmRlcmFibGVPd25lclx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL2Jhc2UvSVJlbmRlcmFibGVPd25lclwiKTtcclxuaW1wb3J0IFRyaWFuZ2xlU3ViTWVzaFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL2Jhc2UvVHJpYW5nbGVTdWJNZXNoXCIpO1xyXG5pbXBvcnQgVHJpYW5nbGVTdWJHZW9tZXRyeVx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9iYXNlL1RyaWFuZ2xlU3ViR2VvbWV0cnlcIik7XHJcbmltcG9ydCBDYW1lcmFcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvZW50aXRpZXMvQ2FtZXJhXCIpO1xyXG5cclxuaW1wb3J0IENvbnRleHRHTFZlcnRleEJ1ZmZlckZvcm1hdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2Jhc2UvQ29udGV4dEdMVmVydGV4QnVmZmVyRm9ybWF0XCIpO1xyXG5pbXBvcnQgSUNvbnRleHRHTFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYmFzZS9JQ29udGV4dEdMXCIpO1xyXG5pbXBvcnQgU3RhZ2VcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYmFzZS9TdGFnZVwiKTtcclxuaW1wb3J0IENvbnRleHRHTFByb2dyYW1UeXBlXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2Jhc2UvQ29udGV4dEdMUHJvZ3JhbVR5cGVcIik7XHJcblxyXG5pbXBvcnQgU2hhZGVyT2JqZWN0QmFzZVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2NvbXBpbGF0aW9uL1NoYWRlck9iamVjdEJhc2VcIik7XHJcbmltcG9ydCBTaGFkZXJSZWdpc3RlckNhY2hlXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2NvbXBpbGF0aW9uL1NoYWRlclJlZ2lzdGVyQ2FjaGVcIik7XHJcbmltcG9ydCBTaGFkZXJSZWdpc3RlckRhdGFcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvY29tcGlsYXRpb24vU2hhZGVyUmVnaXN0ZXJEYXRhXCIpO1xyXG5pbXBvcnQgU2hhZGVyUmVnaXN0ZXJFbGVtZW50XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9jb21waWxhdGlvbi9TaGFkZXJSZWdpc3RlckVsZW1lbnRcIik7XHJcbmltcG9ydCBSZW5kZXJhYmxlQmFzZVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL3Bvb2wvUmVuZGVyYWJsZUJhc2VcIik7XHJcbmltcG9ydCBSZW5kZXJhYmxlUG9vbEJhc2VcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvcG9vbC9SZW5kZXJhYmxlUG9vbEJhc2VcIik7XHJcbmltcG9ydCBSZW5kZXJQYXNzQmFzZVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL3Bhc3Nlcy9SZW5kZXJQYXNzQmFzZVwiKTtcclxuXHJcbi8qKlxyXG4gKiBAY2xhc3MgYXdheS5wb29sLlRyaWFuZ2xlU3ViTWVzaFJlbmRlcmFibGVcclxuICovXHJcbmNsYXNzIFRyaWFuZ2xlU3ViTWVzaFJlbmRlcmFibGUgZXh0ZW5kcyBSZW5kZXJhYmxlQmFzZVxyXG57XHJcblx0LyoqXHJcblx0ICpcclxuXHQgKi9cclxuXHRwdWJsaWMgc3RhdGljIGlkOnN0cmluZyA9IFwidHJpYW5nbGVzdWJtZXNoXCI7XHJcblxyXG5cdHB1YmxpYyBzdGF0aWMgdmVydGV4QXR0cmlidXRlc09mZnNldDpudW1iZXIgPSAxO1xyXG5cclxuXHQvKipcclxuXHQgKlxyXG5cdCAqL1xyXG5cdHB1YmxpYyBzdWJNZXNoOlRyaWFuZ2xlU3ViTWVzaDtcclxuXHJcblxyXG5cdC8qKlxyXG5cdCAqIC8vVE9ET1xyXG5cdCAqXHJcblx0ICogQHBhcmFtIHBvb2xcclxuXHQgKiBAcGFyYW0gc3ViTWVzaFxyXG5cdCAqIEBwYXJhbSBsZXZlbFxyXG5cdCAqIEBwYXJhbSBpbmRleE9mZnNldFxyXG5cdCAqL1xyXG5cdGNvbnN0cnVjdG9yKHBvb2w6UmVuZGVyYWJsZVBvb2xCYXNlLCBzdWJNZXNoOlRyaWFuZ2xlU3ViTWVzaCwgc3RhZ2U6U3RhZ2UsIGxldmVsOm51bWJlciA9IDAsIGluZGV4T2Zmc2V0Om51bWJlciA9IDApXHJcblx0e1xyXG5cdFx0c3VwZXIocG9vbCwgc3ViTWVzaC5wYXJlbnRNZXNoLCBzdWJNZXNoLCBzdWJNZXNoLm1hdGVyaWFsLCBzdGFnZSwgbGV2ZWwsIGluZGV4T2Zmc2V0KTtcclxuXHJcblx0XHR0aGlzLnN1Yk1lc2ggPSBzdWJNZXNoO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICpcclxuXHQgKiBAcmV0dXJucyB7U3ViR2VvbWV0cnlCYXNlfVxyXG5cdCAqIEBwcm90ZWN0ZWRcclxuXHQgKi9cclxuXHRwdWJsaWMgX3BHZXRTdWJHZW9tZXRyeSgpOlRyaWFuZ2xlU3ViR2VvbWV0cnlcclxuXHR7XHJcblx0XHR2YXIgc3ViR2VvbWV0cnk6VHJpYW5nbGVTdWJHZW9tZXRyeTtcclxuXHJcblx0XHRpZiAodGhpcy5zdWJNZXNoLmFuaW1hdG9yKVxyXG5cdFx0XHRzdWJHZW9tZXRyeSA9IDxUcmlhbmdsZVN1Ykdlb21ldHJ5PiB0aGlzLnN1Yk1lc2guYW5pbWF0b3IuZ2V0UmVuZGVyYWJsZVN1Ykdlb21ldHJ5KHRoaXMsIHRoaXMuc3ViTWVzaC5zdWJHZW9tZXRyeSk7XHJcblx0XHRlbHNlXHJcblx0XHRcdHN1Ykdlb21ldHJ5ID0gdGhpcy5zdWJNZXNoLnN1Ykdlb21ldHJ5O1xyXG5cclxuXHRcdHRoaXMuX3BWZXJ0ZXhEYXRhRGlydHlbVHJpYW5nbGVTdWJHZW9tZXRyeS5QT1NJVElPTl9EQVRBXSA9IHRydWU7XHJcblxyXG5cdFx0aWYgKHN1Ykdlb21ldHJ5LnZlcnRleE5vcm1hbHMpXHJcblx0XHRcdHRoaXMuX3BWZXJ0ZXhEYXRhRGlydHlbVHJpYW5nbGVTdWJHZW9tZXRyeS5OT1JNQUxfREFUQV0gPSB0cnVlO1xyXG5cclxuXHRcdGlmIChzdWJHZW9tZXRyeS52ZXJ0ZXhUYW5nZW50cylcclxuXHRcdFx0dGhpcy5fcFZlcnRleERhdGFEaXJ0eVtUcmlhbmdsZVN1Ykdlb21ldHJ5LlRBTkdFTlRfREFUQV0gPSB0cnVlO1xyXG5cclxuXHRcdGlmIChzdWJHZW9tZXRyeS51dnMpXHJcblx0XHRcdHRoaXMuX3BWZXJ0ZXhEYXRhRGlydHlbVHJpYW5nbGVTdWJHZW9tZXRyeS5VVl9EQVRBXSA9IHRydWU7XHJcblxyXG5cdFx0aWYgKHN1Ykdlb21ldHJ5LnNlY29uZGFyeVVWcylcclxuXHRcdFx0dGhpcy5fcFZlcnRleERhdGFEaXJ0eVtUcmlhbmdsZVN1Ykdlb21ldHJ5LlNFQ09OREFSWV9VVl9EQVRBXSA9IHRydWU7XHJcblxyXG5cdFx0aWYgKHN1Ykdlb21ldHJ5LmpvaW50SW5kaWNlcylcclxuXHRcdFx0dGhpcy5fcFZlcnRleERhdGFEaXJ0eVtUcmlhbmdsZVN1Ykdlb21ldHJ5LkpPSU5UX0lOREVYX0RBVEFdID0gdHJ1ZTtcclxuXHJcblx0XHRpZiAoc3ViR2VvbWV0cnkuam9pbnRXZWlnaHRzKVxyXG5cdFx0XHR0aGlzLl9wVmVydGV4RGF0YURpcnR5W1RyaWFuZ2xlU3ViR2VvbWV0cnkuSk9JTlRfV0VJR0hUX0RBVEFdID0gdHJ1ZTtcclxuXHJcblx0XHRzd2l0Y2goc3ViR2VvbWV0cnkuam9pbnRzUGVyVmVydGV4KSB7XHJcblx0XHRcdGNhc2UgMTpcclxuXHRcdFx0XHR0aGlzLkpPSU5UX0lOREVYX0ZPUk1BVCA9IHRoaXMuSk9JTlRfV0VJR0hUX0ZPUk1BVCA9IENvbnRleHRHTFZlcnRleEJ1ZmZlckZvcm1hdC5GTE9BVF8xO1xyXG5cdFx0XHRcdGJyZWFrO1xyXG5cdFx0XHRjYXNlIDI6XHJcblx0XHRcdFx0dGhpcy5KT0lOVF9JTkRFWF9GT1JNQVQgPSB0aGlzLkpPSU5UX1dFSUdIVF9GT1JNQVQgPSBDb250ZXh0R0xWZXJ0ZXhCdWZmZXJGb3JtYXQuRkxPQVRfMjtcclxuXHRcdFx0XHRicmVhaztcclxuXHRcdFx0Y2FzZSAzOlxyXG5cdFx0XHRcdHRoaXMuSk9JTlRfSU5ERVhfRk9STUFUID0gdGhpcy5KT0lOVF9XRUlHSFRfRk9STUFUID0gQ29udGV4dEdMVmVydGV4QnVmZmVyRm9ybWF0LkZMT0FUXzM7XHJcblx0XHRcdFx0YnJlYWs7XHJcblx0XHRcdGNhc2UgNDpcclxuXHRcdFx0XHR0aGlzLkpPSU5UX0lOREVYX0ZPUk1BVCA9IHRoaXMuSk9JTlRfV0VJR0hUX0ZPUk1BVCA9IENvbnRleHRHTFZlcnRleEJ1ZmZlckZvcm1hdC5GTE9BVF80O1xyXG5cdFx0XHRcdGJyZWFrO1xyXG5cdFx0XHRkZWZhdWx0OlxyXG5cdFx0fVxyXG5cclxuXHRcdHJldHVybiBzdWJHZW9tZXRyeTtcclxuXHR9XHJcblxyXG5cclxuXHRwdWJsaWMgc3RhdGljIF9pSW5jbHVkZURlcGVuZGVuY2llcyhzaGFkZXJPYmplY3Q6U2hhZGVyT2JqZWN0QmFzZSlcclxuXHR7XHJcblxyXG5cdH1cclxuXHJcblx0cHVibGljIHN0YXRpYyBfaUdldFZlcnRleENvZGUoc2hhZGVyT2JqZWN0OlNoYWRlck9iamVjdEJhc2UsIHJlZ2lzdGVyQ2FjaGU6U2hhZGVyUmVnaXN0ZXJDYWNoZSwgc2hhcmVkUmVnaXN0ZXJzOlNoYWRlclJlZ2lzdGVyRGF0YSk6c3RyaW5nXHJcblx0e1xyXG5cdFx0dmFyIGNvZGU6c3RyaW5nID0gXCJcIjtcclxuXHJcblx0XHQvL2dldCB0aGUgcHJvamVjdGlvbiBjb29yZGluYXRlc1xyXG5cdFx0dmFyIHBvc2l0aW9uOlNoYWRlclJlZ2lzdGVyRWxlbWVudCA9IChzaGFkZXJPYmplY3QuZ2xvYmFsUG9zRGVwZW5kZW5jaWVzID4gMCk/IHNoYXJlZFJlZ2lzdGVycy5nbG9iYWxQb3NpdGlvblZlcnRleCA6IHNoYXJlZFJlZ2lzdGVycy5sb2NhbFBvc2l0aW9uO1xyXG5cclxuXHRcdC8vcmVzZXJ2aW5nIHZlcnRleCBjb25zdGFudHMgZm9yIHByb2plY3Rpb24gbWF0cml4XHJcblx0XHR2YXIgdmlld01hdHJpeFJlZzpTaGFkZXJSZWdpc3RlckVsZW1lbnQgPSByZWdpc3RlckNhY2hlLmdldEZyZWVWZXJ0ZXhDb25zdGFudCgpO1xyXG5cdFx0cmVnaXN0ZXJDYWNoZS5nZXRGcmVlVmVydGV4Q29uc3RhbnQoKTtcclxuXHRcdHJlZ2lzdGVyQ2FjaGUuZ2V0RnJlZVZlcnRleENvbnN0YW50KCk7XHJcblx0XHRyZWdpc3RlckNhY2hlLmdldEZyZWVWZXJ0ZXhDb25zdGFudCgpO1xyXG5cdFx0c2hhZGVyT2JqZWN0LnZpZXdNYXRyaXhJbmRleCA9IHZpZXdNYXRyaXhSZWcuaW5kZXgqNDtcclxuXHJcblx0XHRpZiAoc2hhZGVyT2JqZWN0LnByb2plY3Rpb25EZXBlbmRlbmNpZXMgPiAwKSB7XHJcblx0XHRcdHNoYXJlZFJlZ2lzdGVycy5wcm9qZWN0aW9uRnJhZ21lbnQgPSByZWdpc3RlckNhY2hlLmdldEZyZWVWYXJ5aW5nKCk7XHJcblx0XHRcdHZhciB0ZW1wOlNoYWRlclJlZ2lzdGVyRWxlbWVudCA9IHJlZ2lzdGVyQ2FjaGUuZ2V0RnJlZVZlcnRleFZlY3RvclRlbXAoKTtcclxuXHRcdFx0Y29kZSArPSBcIm00NCBcIiArIHRlbXAgKyBcIiwgXCIgKyBwb3NpdGlvbiArIFwiLCBcIiArIHZpZXdNYXRyaXhSZWcgKyBcIlxcblwiICtcclxuXHRcdFx0XCJtb3YgXCIgKyBzaGFyZWRSZWdpc3RlcnMucHJvamVjdGlvbkZyYWdtZW50ICsgXCIsIFwiICsgdGVtcCArIFwiXFxuXCIgK1xyXG5cdFx0XHRcIm1vdiBvcCwgXCIgKyB0ZW1wICsgXCJcXG5cIjtcclxuXHRcdH0gZWxzZSB7XHJcblx0XHRcdGNvZGUgKz0gXCJtNDQgb3AsIFwiICsgcG9zaXRpb24gKyBcIiwgXCIgKyB2aWV3TWF0cml4UmVnICsgXCJcXG5cIjtcclxuXHRcdH1cclxuXHJcblx0XHRyZXR1cm4gY29kZTtcclxuXHR9XHJcblxyXG5cdC8qKlxyXG5cdCAqIEBpbmhlcml0RG9jXHJcblx0ICovXHJcblx0cHVibGljIF9pUmVuZGVyKHBhc3M6UmVuZGVyUGFzc0Jhc2UsIGNhbWVyYTpDYW1lcmEsIHZpZXdQcm9qZWN0aW9uOk1hdHJpeDNEKVxyXG5cdHtcclxuXHRcdHN1cGVyLl9pUmVuZGVyKHBhc3MsIGNhbWVyYSwgdmlld1Byb2plY3Rpb24pO1xyXG5cclxuXHRcdHZhciBzaGFkZXI6U2hhZGVyT2JqZWN0QmFzZSA9IHBhc3Muc2hhZGVyO1xyXG5cclxuXHRcdGlmIChzaGFkZXIuc2NlbmVNYXRyaXhJbmRleCA+PSAwKSB7XHJcblx0XHRcdHRoaXMuc291cmNlRW50aXR5LmdldFJlbmRlclNjZW5lVHJhbnNmb3JtKGNhbWVyYSkuY29weVJhd0RhdGFUbyhzaGFkZXIudmVydGV4Q29uc3RhbnREYXRhLCBzaGFkZXIuc2NlbmVNYXRyaXhJbmRleCwgdHJ1ZSk7XHJcblx0XHRcdHZpZXdQcm9qZWN0aW9uLmNvcHlSYXdEYXRhVG8oc2hhZGVyLnZlcnRleENvbnN0YW50RGF0YSwgc2hhZGVyLnZpZXdNYXRyaXhJbmRleCwgdHJ1ZSk7XHJcblx0XHR9IGVsc2Uge1xyXG5cdFx0XHR2YXIgbWF0cml4M0Q6TWF0cml4M0QgPSBNYXRyaXgzRFV0aWxzLkNBTENVTEFUSU9OX01BVFJJWDtcclxuXHJcblx0XHRcdG1hdHJpeDNELmNvcHlGcm9tKHRoaXMuc291cmNlRW50aXR5LmdldFJlbmRlclNjZW5lVHJhbnNmb3JtKGNhbWVyYSkpO1xyXG5cdFx0XHRtYXRyaXgzRC5hcHBlbmQodmlld1Byb2plY3Rpb24pO1xyXG5cclxuXHRcdFx0bWF0cml4M0QuY29weVJhd0RhdGFUbyhzaGFkZXIudmVydGV4Q29uc3RhbnREYXRhLCBzaGFkZXIudmlld01hdHJpeEluZGV4LCB0cnVlKTtcclxuXHRcdH1cclxuXHJcblx0XHR2YXIgY29udGV4dDpJQ29udGV4dEdMID0gdGhpcy5fc3RhZ2UuY29udGV4dDtcclxuXHRcdGNvbnRleHQuc2V0UHJvZ3JhbUNvbnN0YW50c0Zyb21BcnJheShDb250ZXh0R0xQcm9ncmFtVHlwZS5WRVJURVgsIDAsIHNoYWRlci52ZXJ0ZXhDb25zdGFudERhdGEsIHNoYWRlci5udW1Vc2VkVmVydGV4Q29uc3RhbnRzKTtcclxuXHRcdGNvbnRleHQuc2V0UHJvZ3JhbUNvbnN0YW50c0Zyb21BcnJheShDb250ZXh0R0xQcm9ncmFtVHlwZS5GUkFHTUVOVCwgMCwgc2hhZGVyLmZyYWdtZW50Q29uc3RhbnREYXRhLCBzaGFkZXIubnVtVXNlZEZyYWdtZW50Q29uc3RhbnRzKTtcclxuXHJcblx0XHR0aGlzLl9zdGFnZS5hY3RpdmF0ZUJ1ZmZlcigwLCB0aGlzLmdldFZlcnRleERhdGEoVHJpYW5nbGVTdWJHZW9tZXRyeS5QT1NJVElPTl9EQVRBKSwgdGhpcy5nZXRWZXJ0ZXhPZmZzZXQoVHJpYW5nbGVTdWJHZW9tZXRyeS5QT1NJVElPTl9EQVRBKSwgVHJpYW5nbGVTdWJHZW9tZXRyeS5QT1NJVElPTl9GT1JNQVQpO1xyXG5cdFx0dGhpcy5fc3RhZ2UuY29udGV4dC5kcmF3VHJpYW5nbGVzKHRoaXMuX3N0YWdlLmdldEluZGV4QnVmZmVyKHRoaXMuZ2V0SW5kZXhEYXRhKCkpLCAwLCB0aGlzLm51bVRyaWFuZ2xlcyk7XHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiAvL1RPRE9cclxuXHQgKlxyXG5cdCAqIEBwYXJhbSBwb29sXHJcblx0ICogQHBhcmFtIHJlbmRlcmFibGVPd25lclxyXG5cdCAqIEBwYXJhbSBsZXZlbFxyXG5cdCAqIEBwYXJhbSBpbmRleE9mZnNldFxyXG5cdCAqIEByZXR1cm5zIHthd2F5LnBvb2wuVHJpYW5nbGVTdWJNZXNoUmVuZGVyYWJsZX1cclxuXHQgKiBAcHJvdGVjdGVkXHJcblx0ICovXHJcblx0cHVibGljIF9wR2V0T3ZlcmZsb3dSZW5kZXJhYmxlKGluZGV4T2Zmc2V0Om51bWJlcik6UmVuZGVyYWJsZUJhc2VcclxuXHR7XHJcblx0XHRyZXR1cm4gbmV3IFRyaWFuZ2xlU3ViTWVzaFJlbmRlcmFibGUodGhpcy5fcG9vbCwgPFRyaWFuZ2xlU3ViTWVzaD4gdGhpcy5yZW5kZXJhYmxlT3duZXIsIHRoaXMuX3N0YWdlLCB0aGlzLl9sZXZlbCArIDEsIGluZGV4T2Zmc2V0KTtcclxuXHR9XHJcbn1cclxuXHJcbmV4cG9ydCA9IFRyaWFuZ2xlU3ViTWVzaFJlbmRlcmFibGU7Il19