var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var ContextGLMipFilter = require("awayjs-stagegl/lib/base/ContextGLMipFilter");
var ContextGLTextureFilter = require("awayjs-stagegl/lib/base/ContextGLTextureFilter");
var ContextGLWrapMode = require("awayjs-stagegl/lib/base/ContextGLWrapMode");
var RenderObjectBase = require("awayjs-renderergl/lib/compilation/RenderObjectBase");
var ShaderObjectBase = require("awayjs-renderergl/lib/compilation/ShaderObjectBase");
var ShaderCompilerHelper = require("awayjs-renderergl/lib/utils/ShaderCompilerHelper");
/**
 * DepthRenderObject forms an abstract base class for the default shaded materials provided by Stage,
 * using material methods to define their appearance.
 */
var DepthRenderObject = (function (_super) {
    __extends(DepthRenderObject, _super);
    function DepthRenderObject(pool, material, renderableClass, stage) {
        _super.call(this, pool, material, renderableClass, stage);
        this._diffuseColor = 0xffffff;
        this._diffuseR = 1;
        this._diffuseG = 1;
        this._diffuseB = 1;
        this._diffuseA = 1;
        this._pAddScreenShader(new ShaderObjectBase(material, renderableClass, this, this._stage));
    }
    DepthRenderObject.prototype._iIncludeDependencies = function (shaderObject) {
        _super.prototype._iIncludeDependencies.call(this, shaderObject);
        shaderObject.projectionDependencies++;
        if (shaderObject.alphaThreshold > 0)
            shaderObject.uvDependencies++;
    };
    DepthRenderObject.prototype._iInitConstantData = function (shaderObject) {
        _super.prototype._iInitConstantData.call(this, shaderObject);
        var index = this._fragmentConstantsIndex;
        var data = shaderObject.fragmentConstantData;
        data[index] = 1.0;
        data[index + 1] = 255.0;
        data[index + 2] = 65025.0;
        data[index + 3] = 16581375.0;
        data[index + 4] = 1.0 / 255.0;
        data[index + 5] = 1.0 / 255.0;
        data[index + 6] = 1.0 / 255.0;
        data[index + 7] = 0.0;
    };
    /**
     * @inheritDoc
     */
    DepthRenderObject.prototype._iGetFragmentCode = function (shaderObject, registerCache, sharedRegisters) {
        var code = "";
        var targetReg = sharedRegisters.shadedTarget;
        var diffuseInputReg = registerCache.getFreeTextureReg();
        var dataReg1 = registerCache.getFreeFragmentConstant();
        var dataReg2 = registerCache.getFreeFragmentConstant();
        this._fragmentConstantsIndex = dataReg1.index * 4;
        var temp1 = registerCache.getFreeFragmentVectorTemp();
        registerCache.addFragmentTempUsages(temp1, 1);
        var temp2 = registerCache.getFreeFragmentVectorTemp();
        registerCache.addFragmentTempUsages(temp2, 1);
        code += "div " + temp1 + ", " + sharedRegisters.projectionFragment + ", " + sharedRegisters.projectionFragment + ".w\n" + "mul " + temp1 + ", " + dataReg1 + ", " + temp1 + ".z\n" + "frc " + temp1 + ", " + temp1 + "\n" + "mul " + temp2 + ", " + temp1 + ".yzww, " + dataReg2 + "\n";
        //codeF += "mov ft1.w, fc1.w	\n" +
        //    "mov ft0.w, fc0.x	\n";
        if (shaderObject.alphaThreshold > 0) {
            diffuseInputReg = registerCache.getFreeTextureReg();
            this._texturesIndex = diffuseInputReg.index;
            var albedo = registerCache.getFreeFragmentVectorTemp();
            code += ShaderCompilerHelper.getTex2DSampleCode(albedo, sharedRegisters, diffuseInputReg, shaderObject.texture, shaderObject.useSmoothTextures, shaderObject.repeatTextures, shaderObject.useMipmapping);
            var cutOffReg = registerCache.getFreeFragmentConstant();
            code += "sub " + albedo + ".w, " + albedo + ".w, " + cutOffReg + ".x\n" + "kil " + albedo + ".w\n";
        }
        code += "sub " + targetReg + ", " + temp1 + ", " + temp2 + "\n";
        registerCache.removeFragmentTempUsage(temp1);
        registerCache.removeFragmentTempUsage(temp2);
        return code;
    };
    /**
     * @inheritDoc
     */
    DepthRenderObject.prototype._iActivate = function (shader, camera) {
        _super.prototype._iActivate.call(this, shader, camera);
        var context = this._stage.context;
        if (shader.alphaThreshold > 0) {
            context.setSamplerStateAt(this._texturesIndex, shader.repeatTextures ? ContextGLWrapMode.REPEAT : ContextGLWrapMode.CLAMP, shader.useSmoothTextures ? ContextGLTextureFilter.LINEAR : ContextGLTextureFilter.NEAREST, shader.useMipmapping ? ContextGLMipFilter.MIPLINEAR : ContextGLMipFilter.MIPNONE);
            this._stage.activateTexture(this._texturesIndex, shader.texture);
            shader.fragmentConstantData[this._fragmentConstantsIndex + 8] = shader.alphaThreshold;
        }
    };
    /**
     *
     */
    DepthRenderObject.id = "depth";
    return DepthRenderObject;
})(RenderObjectBase);
module.exports = DepthRenderObject;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9jb21waWxhdGlvbi9kZXB0aHJlbmRlcm9iamVjdC50cyJdLCJuYW1lcyI6WyJEZXB0aFJlbmRlck9iamVjdCIsIkRlcHRoUmVuZGVyT2JqZWN0LmNvbnN0cnVjdG9yIiwiRGVwdGhSZW5kZXJPYmplY3QuX2lJbmNsdWRlRGVwZW5kZW5jaWVzIiwiRGVwdGhSZW5kZXJPYmplY3QuX2lJbml0Q29uc3RhbnREYXRhIiwiRGVwdGhSZW5kZXJPYmplY3QuX2lHZXRGcmFnbWVudENvZGUiLCJEZXB0aFJlbmRlck9iamVjdC5faUFjdGl2YXRlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFZQSxJQUFPLGtCQUFrQixXQUFhLDRDQUE0QyxDQUFDLENBQUM7QUFDcEYsSUFBTyxzQkFBc0IsV0FBWSxnREFBZ0QsQ0FBQyxDQUFDO0FBQzNGLElBQU8saUJBQWlCLFdBQWEsMkNBQTJDLENBQUMsQ0FBQztBQUtsRixJQUFPLGdCQUFnQixXQUFjLG9EQUFvRCxDQUFDLENBQUM7QUFFM0YsSUFBTyxnQkFBZ0IsV0FBYyxvREFBb0QsQ0FBQyxDQUFDO0FBSTNGLElBQU8sb0JBQW9CLFdBQWEsa0RBQWtELENBQUMsQ0FBQztBQUc1RixBQUlBOzs7R0FERztJQUNHLGlCQUFpQjtJQUFTQSxVQUExQkEsaUJBQWlCQSxVQUF5QkE7SUFnQi9DQSxTQWhCS0EsaUJBQWlCQSxDQWdCVkEsSUFBcUJBLEVBQUVBLFFBQXFCQSxFQUFFQSxlQUFnQ0EsRUFBRUEsS0FBV0E7UUFFdEdDLGtCQUFNQSxJQUFJQSxFQUFFQSxRQUFRQSxFQUFFQSxlQUFlQSxFQUFFQSxLQUFLQSxDQUFDQSxDQUFDQTtRQVh2Q0Esa0JBQWFBLEdBQVVBLFFBQVFBLENBQUNBO1FBQ2hDQSxjQUFTQSxHQUFVQSxDQUFDQSxDQUFDQTtRQUNyQkEsY0FBU0EsR0FBVUEsQ0FBQ0EsQ0FBQ0E7UUFDckJBLGNBQVNBLEdBQVVBLENBQUNBLENBQUNBO1FBQ3JCQSxjQUFTQSxHQUFVQSxDQUFD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Q0EsZUFBZUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsY0FBY0EsRUFBRUEsTUFBTUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0E7WUFFakVBLE1BQU1BLENBQUNBLG9CQUFvQkEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsdUJBQXVCQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxNQUFNQSxDQUFDQSxjQUFjQSxDQUFDQTtRQUN2RkEsQ0FBQ0E7SUFDRkEsQ0FBQ0E7SUEvR0RMOztPQUVHQTtJQUNXQSxvQkFBRUEsR0FBVUEsT0FBT0EsQ0FBQ0E7SUE4R25DQSx3QkFBQ0E7QUFBREEsQ0FuSEEsQUFtSENBLEVBbkgrQixnQkFBZ0IsRUFtSC9DO0FBRUQsQUFBMkIsaUJBQWxCLGlCQUFpQixDQUFDIiwiZmlsZSI6ImNvbXBpbGF0aW9uL0RlcHRoUmVuZGVyT2JqZWN0LmpzIiwic291cmNlUm9vdCI6Ii4uLyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBNYXRyaXhcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvZ2VvbS9NYXRyaXhcIik7XG5pbXBvcnQgTWF0cml4M0RcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvZ2VvbS9NYXRyaXgzRFwiKTtcbmltcG9ydCBNYXRyaXgzRFV0aWxzXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvZ2VvbS9NYXRyaXgzRFV0aWxzXCIpO1xuaW1wb3J0IFRleHR1cmUyREJhc2VcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi90ZXh0dXJlcy9UZXh0dXJlMkRCYXNlXCIpO1xuXG5pbXBvcnQgQmxlbmRNb2RlXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9iYXNlL0JsZW5kTW9kZVwiKTtcbmltcG9ydCBUcmlhbmdsZVN1Ykdlb21ldHJ5XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL2Jhc2UvVHJpYW5nbGVTdWJHZW9tZXRyeVwiKTtcbmltcG9ydCBDYW1lcmFcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvZW50aXRpZXMvQ2FtZXJhXCIpO1xuaW1wb3J0IE1hdGVyaWFsQmFzZVx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvbWF0ZXJpYWxzL01hdGVyaWFsQmFzZVwiKTtcblxuaW1wb3J0IENvbnRleHRHTENvbXBhcmVNb2RlXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2Jhc2UvQ29udGV4dEdMQ29tcGFyZU1vZGVcIik7XG5pbXBvcnQgQ29udGV4dEdMUHJvZ3JhbVR5cGVcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYmFzZS9Db250ZXh0R0xQcm9ncmFtVHlwZVwiKTtcbmltcG9ydCBDb250ZXh0R0xNaXBGaWx0ZXJcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYmFzZS9Db250ZXh0R0xNaXBGaWx0ZXJcIik7XG5pbXBvcnQgQ29udGV4dEdMVGV4dHVyZUZpbHRlclx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYmFzZS9Db250ZXh0R0xUZXh0dXJlRmlsdGVyXCIpO1xuaW1wb3J0IENvbnRleHRHTFdyYXBNb2RlXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2Jhc2UvQ29udGV4dEdMV3JhcE1vZGVcIik7XG5pbXBvcnQgSUNvbnRleHRHTFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYmFzZS9JQ29udGV4dEdMXCIpO1xuaW1wb3J0IFN0YWdlXHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2Jhc2UvU3RhZ2VcIik7XG5cbmltcG9ydCBSZW5kZXJhYmxlQmFzZVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL3Bvb2wvUmVuZGVyYWJsZUJhc2VcIik7XG5pbXBvcnQgUmVuZGVyT2JqZWN0QmFzZVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2NvbXBpbGF0aW9uL1JlbmRlck9iamVjdEJhc2VcIik7XG5pbXBvcnQgUmVuZGVyT2JqZWN0UG9vbFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2NvbXBpbGF0aW9uL1JlbmRlck9iamVjdFBvb2xcIik7XG5pbXBvcnQgU2hhZGVyT2JqZWN0QmFzZVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL2NvbXBpbGF0aW9uL1NoYWRlck9iamVjdEJhc2VcIik7XG5pbXBvcnQgU2hhZGVyUmVnaXN0ZXJDYWNoZVx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9jb21waWxhdGlvbi9TaGFkZXJSZWdpc3RlckNhY2hlXCIpO1xuaW1wb3J0IFNoYWRlclJlZ2lzdGVyRGF0YVx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9jb21waWxhdGlvbi9TaGFkZXJSZWdpc3RlckRhdGFcIik7XG5pbXBvcnQgU2hhZGVyUmVnaXN0ZXJFbGVtZW50XHRcdD0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9jb21waWxhdGlvbi9TaGFkZXJSZWdpc3RlckVsZW1lbnRcIik7XG5pbXBvcnQgU2hhZGVyQ29tcGlsZXJIZWxwZXJcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvdXRpbHMvU2hhZGVyQ29tcGlsZXJIZWxwZXJcIik7XG5pbXBvcnQgSVJlbmRlcmFibGVDbGFzc1x0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL3Bvb2wvSVJlbmRlcmFibGVDbGFzc1wiKTtcblxuLyoqXG4gKiBEZXB0aFJlbmRlck9iamVjdCBmb3JtcyBhbiBhYnN0cmFjdCBiYXNlIGNsYXNzIGZvciB0aGUgZGVmYXVsdCBzaGFkZWQgbWF0ZXJpYWxzIHByb3ZpZGVkIGJ5IFN0YWdlLFxuICogdXNpbmcgbWF0ZXJpYWwgbWV0aG9kcyB0byBkZWZpbmUgdGhlaXIgYXBwZWFyYW5jZS5cbiAqL1xuY2xhc3MgRGVwdGhSZW5kZXJPYmplY3QgZXh0ZW5kcyBSZW5kZXJPYmplY3RCYXNlXG57XG5cdC8qKlxuXHQgKlxuXHQgKi9cblx0cHVibGljIHN0YXRpYyBpZDpzdHJpbmcgPSBcImRlcHRoXCI7XG5cblx0cHJpdmF0ZSBfZGlmZnVzZUNvbG9yOm51bWJlciA9IDB4ZmZmZmZmO1xuXHRwcml2YXRlIF9kaWZmdXNlUjpudW1iZXIgPSAxO1xuXHRwcml2YXRlIF9kaWZmdXNlRzpudW1iZXIgPSAxO1xuXHRwcml2YXRlIF9kaWZmdXNlQjpudW1iZXIgPSAxO1xuXHRwcml2YXRlIF9kaWZmdXNlQTpudW1iZXIgPSAxO1xuXG5cdHByaXZhdGUgX2ZyYWdtZW50Q29uc3RhbnRzSW5kZXg6bnVtYmVyO1xuXHRwcml2YXRlIF90ZXh0dXJlc0luZGV4Om51bWJlcjtcblxuXHRjb25zdHJ1Y3Rvcihwb29sOlJlbmRlck9iamVjdFBvb2wsIG1hdGVyaWFsOk1hdGVyaWFsQmFzZSwgcmVuZGVyYWJsZUNsYXNzOklSZW5kZXJhYmxlQ2xhc3MsIHN0YWdlOlN0YWdlKVxuXHR7XG5cdFx0c3VwZXIocG9vbCwgbWF0ZXJpYWwsIHJlbmRlcmFibGVDbGFzcywgc3RhZ2UpO1xuXG5cdFx0dGhpcy5fcEFkZFNjcmVlblNoYWRlcihuZXcgU2hhZGVyT2JqZWN0QmFzZShtYXRlcmlhbCwgcmVuZGVyYWJsZUNsYXNzLCB0aGlzLCB0aGlzLl9zdGFnZSkpO1xuXHR9XG5cblx0cHVibGljIF9pSW5jbHVkZURlcGVuZGVuY2llcyhzaGFkZXJPYmplY3Q6U2hhZGVyT2JqZWN0QmFzZSlcblx0e1xuXHRcdHN1cGVyLl9pSW5jbHVkZURlcGVuZGVuY2llcyhzaGFkZXJPYmplY3QpO1xuXG5cdFx0c2hhZGVyT2JqZWN0LnByb2plY3Rpb25EZXBlbmRlbmNpZXMrKztcblxuXHRcdGlmIChzaGFkZXJPYmplY3QuYWxwaGFUaHJlc2hvbGQgPiAwKVxuXHRcdFx0c2hhZGVyT2JqZWN0LnV2RGVwZW5kZW5jaWVzKys7XG5cdH1cblxuXG5cdHB1YmxpYyBfaUluaXRDb25zdGFudERhdGEoc2hhZGVyT2JqZWN0OlNoYWRlck9iamVjdEJhc2UpXG5cdHtcblx0XHRzdXBlci5faUluaXRDb25zdGFudERhdGEoc2hhZGVyT2JqZWN0KTtcblxuXHRcdHZhciBpbmRleDpudW1iZXIgPSB0aGlzLl9mcmFnbWVudENvbnN0YW50c0luZGV4O1xuXHRcdHZhciBkYXRhOkFycmF5PG51bWJlcj4gPSBzaGFkZXJPYmplY3QuZnJhZ21lbnRDb25zdGFudERhdGE7XG5cdFx0ZGF0YVtpbmRleF0gPSAxLjA7XG5cdFx0ZGF0YVtpbmRleCArIDFdID0gMjU1LjA7XG5cdFx0ZGF0YVtpbmRleCArIDJdID0gNjUwMjUuMDtcblx0XHRkYXRhW2luZGV4ICsgM10gPSAxNjU4MTM3NS4wO1xuXHRcdGRhdGFbaW5kZXggKyA0XSA9IDEuMC8yNTUuMDtcblx0XHRkYXRhW2luZGV4ICsgNV0gPSAxLjAvMjU1LjA7XG5cdFx0ZGF0YVtpbmRleCArIDZdID0gMS4wLzI1NS4wO1xuXHRcdGRhdGFbaW5kZXggKyA3XSA9IDAuMDtcblx0fVxuXG5cdC8qKlxuXHQgKiBAaW5oZXJpdERvY1xuXHQgKi9cblx0cHVibGljIF9pR2V0RnJhZ21lbnRDb2RlKHNoYWRlck9iamVjdDpTaGFkZXJPYmplY3RCYXNlLCByZWdpc3RlckNhY2hlOlNoYWRlclJlZ2lzdGVyQ2FjaGUsIHNoYXJlZFJlZ2lzdGVyczpTaGFkZXJSZWdpc3RlckRhdGEpOnN0cmluZ1xuXHR7XG5cdFx0dmFyIGNvZGU6c3RyaW5nID0gXCJcIjtcblx0XHR2YXIgdGFyZ2V0UmVnOlNoYWRlclJlZ2lzdGVyRWxlbWVudCA9IHNoYXJlZFJlZ2lzdGVycy5zaGFkZWRUYXJnZXQ7XG5cdFx0dmFyIGRpZmZ1c2VJbnB1dFJlZzpTaGFkZXJSZWdpc3RlckVsZW1lbnQgPSByZWdpc3RlckNhY2hlLmdldEZyZWVUZXh0dXJlUmVnKCk7XG5cdFx0dmFyIGRhdGFSZWcxOlNoYWRlclJlZ2lzdGVyRWxlbWVudCA9IHJlZ2lzdGVyQ2FjaGUuZ2V0RnJlZUZyYWdtZW50Q29uc3RhbnQoKTtcblx0XHR2YXIgZGF0YVJlZzI6U2hhZGVyUmVnaXN0ZXJFbGVtZW50ID0gcmVnaXN0ZXJDYWNoZS5nZXRGcmVlRnJhZ21lbnRDb25zdGFudCgpO1xuXG5cdFx0dGhpcy5fZnJhZ21lbnRDb25zdGFudHNJbmRleCA9IGRhdGFSZWcxLmluZGV4KjQ7XG5cblx0XHR2YXIgdGVtcDE6U2hhZGVyUmVnaXN0ZXJFbGVtZW50ID0gcmVnaXN0ZXJDYWNoZS5nZXRGcmVlRnJhZ21lbnRWZWN0b3JUZW1wKCk7XG5cdFx0cmVnaXN0ZXJDYWNoZS5hZGRGcmFnbWVudFRlbXBVc2FnZXModGVtcDEsIDEpO1xuXHRcdHZhciB0ZW1wMjpTaGFkZXJSZWdpc3RlckVsZW1lbnQgPSByZWdpc3RlckNhY2hlLmdldEZyZWVGcmFnbWVudFZlY3RvclRlbXAoKTtcblx0XHRyZWdpc3RlckNhY2hlLmFkZEZyYWdtZW50VGVtcFVzYWdlcyh0ZW1wMiwgMSk7XG5cblx0XHRjb2RlICs9IFwiZGl2IFwiICsgdGVtcDEgKyBcIiwgXCIgKyBzaGFyZWRSZWdpc3RlcnMucHJvamVjdGlvbkZyYWdtZW50ICsgXCIsIFwiICsgc2hhcmVkUmVnaXN0ZXJzLnByb2plY3Rpb25GcmFnbWVudCArIFwiLndcXG5cIiArIC8vXCJzdWIgZnQyLnosIGZjMC54LCBmdDIuelxcblwiICsgICAgLy9pbnZlcnRcblx0XHRcIm11bCBcIiArIHRlbXAxICsgXCIsIFwiICsgZGF0YVJlZzEgKyBcIiwgXCIgKyB0ZW1wMSArIFwiLnpcXG5cIiArXG5cdFx0XCJmcmMgXCIgKyB0ZW1wMSArIFwiLCBcIiArIHRlbXAxICsgXCJcXG5cIiArXG5cdFx0XCJtdWwgXCIgKyB0ZW1wMiArIFwiLCBcIiArIHRlbXAxICsgXCIueXp3dywgXCIgKyBkYXRhUmVnMiArIFwiXFxuXCI7XG5cblx0XHQvL2NvZGVGICs9IFwibW92IGZ0MS53LCBmYzEud1x0XFxuXCIgK1xuXHRcdC8vICAgIFwibW92IGZ0MC53LCBmYzAueFx0XFxuXCI7XG5cblx0XHRpZiAoc2hhZGVyT2JqZWN0LmFscGhhVGhyZXNob2xkID4gMCkge1xuXHRcdFx0ZGlmZnVzZUlucHV0UmVnID0gcmVnaXN0ZXJDYWNoZS5nZXRGcmVlVGV4dHVyZVJlZygpO1xuXG5cdFx0XHR0aGlzLl90ZXh0dXJlc0luZGV4ID0gZGlmZnVzZUlucHV0UmVnLmluZGV4O1xuXG5cdFx0XHR2YXIgYWxiZWRvOlNoYWRlclJlZ2lzdGVyRWxlbWVudCA9IHJlZ2lzdGVyQ2FjaGUuZ2V0RnJlZUZyYWdtZW50VmVjdG9yVGVtcCgpO1xuXHRcdFx0Y29kZSArPSBTaGFkZXJDb21waWxlckhlbHBlci5nZXRUZXgyRFNhbXBsZUNvZGUoYWxiZWRvLCBzaGFyZWRSZWdpc3RlcnMsIGRpZmZ1c2VJbnB1dFJlZywgc2hhZGVyT2JqZWN0LnRleHR1cmUsIHNoYWRlck9iamVjdC51c2VTbW9vdGhUZXh0dXJlcywgc2hhZGVyT2JqZWN0LnJlcGVhdFRleHR1cmVzLCBzaGFkZXJPYmplY3QudXNlTWlwbWFwcGluZyk7XG5cblx0XHRcdHZhciBjdXRPZmZSZWc6U2hhZGVyUmVnaXN0ZXJFbGVtZW50ID0gcmVnaXN0ZXJDYWNoZS5nZXRGcmVlRnJhZ21lbnRDb25zdGFudCgpO1xuXG5cdFx0XHRjb2RlICs9IFwic3ViIFwiICsgYWxiZWRvICsgXCIudywgXCIgKyBhbGJlZG8gKyBcIi53LCBcIiArIGN1dE9mZlJlZyArIFwiLnhcXG5cIiArXG5cdFx0XHRcImtpbCBcIiArIGFsYmVkbyArIFwiLndcXG5cIjtcblx0XHR9XG5cblx0XHRjb2RlICs9IFwic3ViIFwiICsgdGFyZ2V0UmVnICsgXCIsIFwiICsgdGVtcDEgKyBcIiwgXCIgKyB0ZW1wMiArIFwiXFxuXCI7XG5cblx0XHRyZWdpc3RlckNhY2hlLnJlbW92ZUZyYWdtZW50VGVtcFVzYWdlKHRlbXAxKTtcblx0XHRyZWdpc3RlckNhY2hlLnJlbW92ZUZyYWdtZW50VGVtcFVzYWdlKHRlbXAyKTtcblxuXHRcdHJldHVybiBjb2RlO1xuXHR9XG5cblx0LyoqXG5cdCAqIEBpbmhlcml0RG9jXG5cdCAqL1xuXHRwdWJsaWMgX2lBY3RpdmF0ZShzaGFkZXI6U2hhZGVyT2JqZWN0QmFzZSwgY2FtZXJhOkNhbWVyYSlcblx0e1xuXHRcdHN1cGVyLl9pQWN0aXZhdGUoc2hhZGVyLCBjYW1lcmEpO1xuXG5cdFx0dmFyIGNvbnRleHQ6SUNvbnRleHRHTCA9IHRoaXMuX3N0YWdlLmNvbnRleHQ7XG5cblx0XHRpZiAoc2hhZGVyLmFscGhhVGhyZXNob2xkID4gMCkge1xuXHRcdFx0Y29udGV4dC5zZXRTYW1wbGVyU3RhdGVBdCh0aGlzLl90ZXh0dXJlc0luZGV4LCBzaGFkZXIucmVwZWF0VGV4dHVyZXM/IENvbnRleHRHTFdyYXBNb2RlLlJFUEVBVDpDb250ZXh0R0xXcmFwTW9kZS5DTEFNUCwgc2hhZGVyLnVzZVNtb290aFRleHR1cmVzPyBDb250ZXh0R0xUZXh0dXJlRmlsdGVyLkxJTkVBUiA6IENvbnRleHRHTFRleHR1cmVGaWx0ZXIuTkVBUkVTVCwgc2hhZGVyLnVzZU1pcG1hcHBpbmc/IENvbnRleHRHTE1pcEZpbHRlci5NSVBMSU5FQVIgOiBDb250ZXh0R0xNaXBGaWx0ZXIuTUlQTk9ORSk7XG5cdFx0XHR0aGlzLl9zdGFnZS5hY3RpdmF0ZVRleHR1cmUodGhpcy5fdGV4dHVyZXNJbmRleCwgc2hhZGVyLnRleHR1cmUpO1xuXG5cdFx0XHRzaGFkZXIuZnJhZ21lbnRDb25zdGFudERhdGFbdGhpcy5fZnJhZ21lbnRDb25zdGFudHNJbmRleCArIDhdID0gc2hhZGVyLmFscGhhVGhyZXNob2xkO1xuXHRcdH1cblx0fVxuXG59XG5cbmV4cG9ydCA9IERlcHRoUmVuZGVyT2JqZWN0OyJdfQ==