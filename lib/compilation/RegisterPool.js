var ShaderRegisterElement = require("awayjs-renderergl/lib/compilation/ShaderRegisterElement");
/**
 * RegisterPool is used by the shader compilation process to keep track of which registers of a certain type are
 * currently used and should not be allowed to be written to. Either entire registers can be requested and locked,
 * or single components (x, y, z, w) of a single register.
 * It is used by ShaderRegisterCache to track usages of individual register types.
 *
 * @see away.materials.ShaderRegisterCache
 */
var RegisterPool = (function () {
    /**
     * Creates a new RegisterPool object.
     * @param regName The base name of the register type ("ft" for fragment temporaries, "vc" for vertex constants, etc)
     * @param regCount The amount of available registers of this type.
     * @param persistent Whether or not registers, once reserved, can be freed again. For example, temporaries are not persistent, but constants are.
     */
    function RegisterPool(regName, regCount, persistent) {
        if (persistent === void 0) { persistent = true; }
        this._regName = regName;
        this._regCount = regCount;
        this._persistent = persistent;
        this.initRegisters(regName, regCount);
    }
    /**
     * Retrieve an entire vector register that's still available.
     */
    RegisterPool.prototype.requestFreeVectorReg = function () {
        for (var i = 0; i < this._regCount; ++i) {
            if (!this.isRegisterUsed(i)) {
                if (this._persistent)
                    this._usedVectorCount[i]++;
                return this._vectorRegisters[i];
            }
        }
        throw new Error("Register overflow!");
    };
    /**
     * Retrieve a single vector component that's still available.
     */
    RegisterPool.prototype.requestFreeRegComponent = function () {
        for (var i = 0; i < this._regCount; ++i) {
            if (this._usedVectorCount[i] > 0)
                continue;
            for (var j = 0; j < 4; ++j) {
                if (this._usedSingleCount[j][i] == 0) {
                    if (this._persistent)
                        this._usedSingleCount[j][i]++;
                    return this._registerComponents[j][i];
                }
            }
        }
        throw new Error("Register overflow!");
    };
    /**
     * Marks a register as used, so it cannot be retrieved. The register won't be able to be used until removeUsage
     * has been called usageCount times again.
     * @param register The register to mark as used.
     * @param usageCount The amount of usages to add.
     */
    RegisterPool.prototype.addUsage = function (register, usageCount) {
        if (register._component > -1)
            this._usedSingleCount[register._component][register.index] += usageCount;
        else
            this._usedVectorCount[register.index] += usageCount;
    };
    /**
     * Removes a usage from a register. When usages reach 0, the register is freed again.
     * @param register The register for which to remove a usage.
     */
    RegisterPool.prototype.removeUsage = function (register) {
        if (register._component > -1) {
            if (--this._usedSingleCount[register._component][register.index] < 0)
                throw new Error("More usages removed than exist!");
        }
        else {
            if (--this._usedVectorCount[register.index] < 0)
                throw new Error("More usages removed than exist!");
        }
    };
    /**
     * Disposes any resources used by the current RegisterPool object.
     */
    RegisterPool.prototype.dispose = function () {
        this._vectorRegisters = null;
        this._registerComponents = null;
        this._usedSingleCount = null;
        this._usedVectorCount = null;
    };
    /**
     * Indicates whether or not any registers are in use.
     */
    RegisterPool.prototype.hasRegisteredRegs = function () {
        for (var i = 0; i < this._regCount; ++i)
            if (this.isRegisterUsed(i))
                return true;
        return false;
    };
    /**
     * Initializes all registers.
     */
    RegisterPool.prototype.initRegisters = function (regName, regCount) {
        var hash = RegisterPool._initPool(regName, regCount);
        this._vectorRegisters = RegisterPool._regPool[hash];
        this._registerComponents = RegisterPool._regCompsPool[hash];
        this._usedVectorCount = this._initArray(Array(regCount), 0);
        this._usedSingleCount = new Array(4);
        this._usedSingleCount[0] = this._initArray(new Array(regCount), 0);
        this._usedSingleCount[1] = this._initArray(new Array(regCount), 0);
        this._usedSingleCount[2] = this._initArray(new Array(regCount), 0);
        this._usedSingleCount[3] = this._initArray(new Array(regCount), 0);
    };
    RegisterPool._initPool = function (regName, regCount) {
        var hash = regName + regCount;
        if (RegisterPool._regPool[hash] != undefined)
            return hash;
        var vectorRegisters = new Array(regCount);
        RegisterPool._regPool[hash] = vectorRegisters;
        var registerComponents = [
            [],
            [],
            [],
            []
        ];
        RegisterPool._regCompsPool[hash] = registerComponents;
        for (var i = 0; i < regCount; ++i) {
            vectorRegisters[i] = new ShaderRegisterElement(regName, i);
            for (var j = 0; j < 4; ++j)
                registerComponents[j][i] = new ShaderRegisterElement(regName, i, j);
        }
        return hash;
    };
    /**
     * Check if the temp register is either used for single or vector use
     */
    RegisterPool.prototype.isRegisterUsed = function (index) {
        if (this._usedVectorCount[index] > 0)
            return true;
        for (var i = 0; i < 4; ++i)
            if (this._usedSingleCount[i][index] > 0)
                return true;
        return false;
    };
    RegisterPool.prototype._initArray = function (a, val) {
        var l = a.length;
        for (var c = 0; c < l; c++)
            a[c] = val;
        return a;
    };
    RegisterPool._regPool = new Object();
    RegisterPool._regCompsPool = new Object();
    return RegisterPool;
})();
module.exports = RegisterPool;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9jb21waWxhdGlvbi9SZWdpc3RlclBvb2wudHMiXSwibmFtZXMiOlsiUmVnaXN0ZXJQb29sIiwiUmVnaXN0ZXJQb29sLmNvbnN0cnVjdG9yIiwiUmVnaXN0ZXJQb29sLnJlcXVlc3RGcmVlVmVjdG9yUmVnIiwiUmVnaXN0ZXJQb29sLnJlcXVlc3RGcmVlUmVnQ29tcG9uZW50IiwiUmVnaXN0ZXJQb29sLmFkZFVzYWdlIiwiUmVnaXN0ZXJQb29sLnJlbW92ZVVzYWdlIiwiUmVnaXN0ZXJQb29sLmRpc3Bvc2UiLCJSZWdpc3RlclBvb2wuaGFzUmVnaXN0ZXJlZFJlZ3MiLCJSZWdpc3RlclBvb2wuaW5pdFJlZ2lzdGVycyIsIlJlZ2lzdGVyUG9vbC5faW5pdFBvb2wiLCJSZWdpc3RlclBvb2wuaXNSZWdpc3RlclVzZWQiLCJSZWdpc3RlclBvb2wuX2luaXRBcnJheSJdLCJtYXBwaW5ncyI6IkFBQUEsSUFBTyxxQkFBcUIsV0FBWSx5REFBeUQsQ0FBQyxDQUFDO0FBRW5HLEFBUUE7Ozs7Ozs7R0FERztJQUNHLFlBQVk7SUFlakJBOzs7OztPQUtHQTtJQUNIQSxTQXJCS0EsWUFBWUEsQ0FxQkxBLE9BQWNBLEVBQUVBLFFBQWVBLEVBQUVBLFVBQXlCQTtRQUF6QkMsMEJBQXlCQSxHQUF6QkEsaUJBQXlCQTtRQUVyRUEsSUFBSUEsQ0FBQ0EsUUFBUUEsR0FBR0EsT0FBT0EsQ0FBQ0E7UUFDeEJBLElBQUlBLENBQUNBLFNBQVNBLEdBQUdBLFFBQVFBLENBQUNBO1FBQzFCQSxJQUFJQSxDQUFDQSxXQUFXQSxHQUFHQSxVQUFVQSxDQUFDQTtRQUM5QkEsSUFBSUEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsT0FBT0EsRUFBRUEsUUFBUUEsQ0FBQ0EsQ0FBQ0E7SUFDdkNBLENBQUNBO0lBRUREOztPQUVHQTtJQUNJQSwyQ0FBb0JBLEdBQTNCQTtRQUVDRSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFVQSxDQUFDQSxF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QUlBLElBQUlBLEdBQVVBLE9BQU9BLEdBQUdBLFFBQVFBLENBQUNBO1FBRXJDQSxFQUFFQSxDQUFDQSxDQUFDQSxZQUFZQSxDQUFDQSxRQUFRQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxTQUFTQSxDQUFDQTtZQUM1Q0EsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0E7UUFFYkEsSUFBSUEsZUFBZUEsR0FBZ0NBLElBQUlBLEtBQUtBLENBQXdCQSxRQUFRQSxDQUFDQSxDQUFDQTtRQUM5RkEsWUFBWUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsR0FBR0EsZUFBZUEsQ0FBQ0E7UUFFOUNBLElBQUlBLGtCQUFrQkEsR0FBR0E7WUFDeEJBLEVBQUVBO1lBQ0ZBLEVBQUVBO1lBQ0ZBLEVBQUVBO1lBQ0ZBLEVBQUVBO1NBQ0ZBLENBQUNBO1FBQ0ZBLFlBQVlBLENBQUNBLGFBQWFBLENBQUNBLElBQUlBLENBQUNBLEdBQUdBLGtCQUFrQkEsQ0FBQ0E7UUFFdERBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEdBQVVBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLFFBQVFBLEVBQUVBLEVBQUVBLENBQUNBLEVBQUVBLENBQUNBO1lBRTFDQSxlQUFlQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxJQUFJQSxxQkFBcUJBLENBQUNBLE9BQU9BLEVBQUVBLENBQUNBLENBQUNBLENBQUNBO1lBRTNEQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFVQSxDQUFDQSxFQUFFQSxDQUFDQSxHQUFHQSxDQUFDQSxFQUFFQSxFQUFFQSxDQUFDQTtnQkFDaENBLGtCQUFrQkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsSUFBSUEscUJBQXFCQSxDQUFDQSxPQUFPQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUN0RUEsQ0FBQ0E7UUFFREEsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0E7SUFDYkEsQ0FBQ0E7SUFHRFQ7O09BRUdBO0lBQ0tBLHFDQUFjQSxHQUF0QkEsVUFBdUJBLEtBQVlBO1FBRWxDVSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxnQkFBZ0JBLENBQUNBLEtBQUtBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBO1lBQ3BDQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQTtRQUViQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFVQSxDQUFDQSxFQUFFQSxDQUFDQSxHQUFHQSxDQUFDQSxFQUFFQSxFQUFFQSxDQUFDQTtZQUNoQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxLQUFLQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQTtnQkFDdkNBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBO1FBRWRBLE1BQU1BLENBQUNBLEtBQUtBLENBQUNBO0lBQ2RBLENBQUNBO0lBR09WLGlDQUFVQSxHQUFsQkEsVUFBbUJBLENBQVlBLEVBQUVBLEdBQU9BO1FBRXZDVyxJQUFJQSxDQUFDQSxHQUFVQSxDQUFDQSxDQUFDQSxNQUFNQSxDQUFDQTtRQUV4QkEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBVUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsRUFBRUE7WUFDaENBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBO1FBRVpBLE1BQU1BLENBQUNBLENBQUNBLENBQUNBO0lBQ1ZBLENBQUNBO0lBL0xjWCxxQkFBUUEsR0FBVUEsSUFBSUEsTUFBTUEsRUFBRUEsQ0FBQ0E7SUFDL0JBLDBCQUFhQSxHQUFVQSxJQUFJQSxNQUFNQSxFQUFFQSxDQUFDQTtJQStMcERBLG1CQUFDQTtBQUFEQSxDQWxNQSxBQWtNQ0EsSUFBQTtBQUVELEFBQXNCLGlCQUFiLFlBQVksQ0FBQyIsImZpbGUiOiJjb21waWxhdGlvbi9SZWdpc3RlclBvb2wuanMiLCJzb3VyY2VSb290IjoiLi4vIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFNoYWRlclJlZ2lzdGVyRWxlbWVudFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtcmVuZGVyZXJnbC9saWIvY29tcGlsYXRpb24vU2hhZGVyUmVnaXN0ZXJFbGVtZW50XCIpO1xyXG5cclxuLyoqXHJcbiAqIFJlZ2lzdGVyUG9vbCBpcyB1c2VkIGJ5IHRoZSBzaGFkZXIgY29tcGlsYXRpb24gcHJvY2VzcyB0byBrZWVwIHRyYWNrIG9mIHdoaWNoIHJlZ2lzdGVycyBvZiBhIGNlcnRhaW4gdHlwZSBhcmVcclxuICogY3VycmVudGx5IHVzZWQgYW5kIHNob3VsZCBub3QgYmUgYWxsb3dlZCB0byBiZSB3cml0dGVuIHRvLiBFaXRoZXIgZW50aXJlIHJlZ2lzdGVycyBjYW4gYmUgcmVxdWVzdGVkIGFuZCBsb2NrZWQsXHJcbiAqIG9yIHNpbmdsZSBjb21wb25lbnRzICh4LCB5LCB6LCB3KSBvZiBhIHNpbmdsZSByZWdpc3Rlci5cclxuICogSXQgaXMgdXNlZCBieSBTaGFkZXJSZWdpc3RlckNhY2hlIHRvIHRyYWNrIHVzYWdlcyBvZiBpbmRpdmlkdWFsIHJlZ2lzdGVyIHR5cGVzLlxyXG4gKlxyXG4gKiBAc2VlIGF3YXkubWF0ZXJpYWxzLlNoYWRlclJlZ2lzdGVyQ2FjaGVcclxuICovXHJcbmNsYXNzIFJlZ2lzdGVyUG9vbFxyXG57XHJcblx0cHJpdmF0ZSBzdGF0aWMgX3JlZ1Bvb2w6T2JqZWN0ID0gbmV3IE9iamVjdCgpO1xyXG5cdHByaXZhdGUgc3RhdGljIF9yZWdDb21wc1Bvb2w6T2JqZWN0ID0gbmV3IE9iamVjdCgpO1xyXG5cclxuXHRwcml2YXRlIF92ZWN0b3JSZWdpc3RlcnM6QXJyYXk8U2hhZGVyUmVnaXN0ZXJFbGVtZW50PjtcclxuXHRwcml2YXRlIF9yZWdpc3RlckNvbXBvbmVudHM7XHJcblxyXG5cdHByaXZhdGUgX3JlZ05hbWU6c3RyaW5nO1xyXG5cdHByaXZhdGUgX3VzZWRTaW5nbGVDb3VudDpBcnJheTxBcnJheTxudW1iZXI+PjtcclxuXHRwcml2YXRlIF91c2VkVmVjdG9yQ291bnQ6QXJyYXk8bnVtYmVyPiAvKnVpbnQqLztcclxuXHRwcml2YXRlIF9yZWdDb3VudDpudW1iZXI7XHJcblxyXG5cdHByaXZhdGUgX3BlcnNpc3RlbnQ6Ym9vbGVhbjtcclxuXHJcblx0LyoqXHJcblx0ICogQ3JlYXRlcyBhIG5ldyBSZWdpc3RlclBvb2wgb2JqZWN0LlxyXG5cdCAqIEBwYXJhbSByZWdOYW1lIFRoZSBiYXNlIG5hbWUgb2YgdGhlIHJlZ2lzdGVyIHR5cGUgKFwiZnRcIiBmb3IgZnJhZ21lbnQgdGVtcG9yYXJpZXMsIFwidmNcIiBmb3IgdmVydGV4IGNvbnN0YW50cywgZXRjKVxyXG5cdCAqIEBwYXJhbSByZWdDb3VudCBUaGUgYW1vdW50IG9mIGF2YWlsYWJsZSByZWdpc3RlcnMgb2YgdGhpcyB0eXBlLlxyXG5cdCAqIEBwYXJhbSBwZXJzaXN0ZW50IFdoZXRoZXIgb3Igbm90IHJlZ2lzdGVycywgb25jZSByZXNlcnZlZCwgY2FuIGJlIGZyZWVkIGFnYWluLiBGb3IgZXhhbXBsZSwgdGVtcG9yYXJpZXMgYXJlIG5vdCBwZXJzaXN0ZW50LCBidXQgY29uc3RhbnRzIGFyZS5cclxuXHQgKi9cclxuXHRjb25zdHJ1Y3RvcihyZWdOYW1lOnN0cmluZywgcmVnQ291bnQ6bnVtYmVyLCBwZXJzaXN0ZW50OmJvb2xlYW4gPSB0cnVlKVxyXG5cdHtcclxuXHRcdHRoaXMuX3JlZ05hbWUgPSByZWdOYW1lO1xyXG5cdFx0dGhpcy5fcmVnQ291bnQgPSByZWdDb3VudDtcclxuXHRcdHRoaXMuX3BlcnNpc3RlbnQgPSBwZXJzaXN0ZW50O1xyXG5cdFx0dGhpcy5pbml0UmVnaXN0ZXJzKHJlZ05hbWUsIHJlZ0NvdW50KTtcclxuXHR9XHJcblxyXG5cdC8qKlxyXG5cdCAqIFJldHJpZXZlIGFuIGVudGlyZSB2ZWN0b3IgcmVnaXN0ZXIgdGhhdCdzIHN0aWxsIGF2YWlsYWJsZS5cclxuXHQgKi9cclxuXHRwdWJsaWMgcmVxdWVzdEZyZWVWZWN0b3JSZWcoKTpTaGFkZXJSZWdpc3RlckVsZW1lbnRcclxuXHR7XHJcblx0XHRmb3IgKHZhciBpOm51bWJlciA9IDA7IGkgPCB0aGlzLl9yZWdDb3VudDsgKytpKSB7XHJcblx0XHRcdGlmICghdGhpcy5pc1JlZ2lzdGVyVXNlZChpKSkge1xyXG5cdFx0XHRcdGlmICh0aGlzLl9wZXJzaXN0ZW50KVxyXG5cdFx0XHRcdFx0dGhpcy5fdXNlZFZlY3RvckNvdW50W2ldKys7XHJcblxyXG5cdFx0XHRcdHJldHVybiB0aGlzLl92ZWN0b3JSZWdpc3RlcnNbaV07XHJcblx0XHRcdH1cclxuXHRcdH1cclxuXHJcblx0XHR0aHJvdyBuZXcgRXJyb3IoXCJSZWdpc3RlciBvdmVyZmxvdyFcIik7XHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiBSZXRyaWV2ZSBhIHNpbmdsZSB2ZWN0b3IgY29tcG9uZW50IHRoYXQncyBzdGlsbCBhdmFpbGFibGUuXHJcblx0ICovXHJcblx0cHVibGljIHJlcXVlc3RGcmVlUmVnQ29tcG9uZW50KCk6U2hhZGVyUmVnaXN0ZXJFbGVtZW50XHJcblx0e1xyXG5cdFx0Zm9yICh2YXIgaTpudW1iZXIgPSAwOyBpIDwgdGhpcy5fcmVnQ291bnQ7ICsraSkge1xyXG5cdFx0XHRpZiAodGhpcy5fdXNlZFZlY3RvckNvdW50W2ldID4gMClcclxuXHRcdFx0XHRjb250aW51ZTtcclxuXHJcblx0XHRcdGZvciAodmFyIGo6bnVtYmVyID0gMDsgaiA8IDQ7ICsraikge1xyXG5cdFx0XHRcdGlmICh0aGlzLl91c2VkU2luZ2xlQ291bnRbal1baV0gPT0gMCkge1xyXG5cdFx0XHRcdFx0aWYgKHRoaXMuX3BlcnNpc3RlbnQpXHJcblx0XHRcdFx0XHRcdHRoaXMuX3VzZWRTaW5nbGVDb3VudFtqXVtpXSsrO1xyXG5cclxuXHRcdFx0XHRcdHJldHVybiB0aGlzLl9yZWdpc3RlckNvbXBvbmVudHNbal1baV07XHJcblx0XHRcdFx0fVxyXG5cdFx0XHR9XHJcblx0XHR9XHJcblxyXG5cdFx0dGhyb3cgbmV3IEVycm9yKFwiUmVnaXN0ZXIgb3ZlcmZsb3chXCIpO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogTWFya3MgYSByZWdpc3RlciBhcyB1c2VkLCBzbyBpdCBjYW5ub3QgYmUgcmV0cmlldmVkLiBUaGUgcmVnaXN0ZXIgd29uJ3QgYmUgYWJsZSB0byBiZSB1c2VkIHVudGlsIHJlbW92ZVVzYWdlXHJcblx0ICogaGFzIGJlZW4gY2FsbGVkIHVzYWdlQ291bnQgdGltZXMgYWdhaW4uXHJcblx0ICogQHBhcmFtIHJlZ2lzdGVyIFRoZSByZWdpc3RlciB0byBtYXJrIGFzIHVzZWQuXHJcblx0ICogQHBhcmFtIHVzYWdlQ291bnQgVGhlIGFtb3VudCBvZiB1c2FnZXMgdG8gYWRkLlxyXG5cdCAqL1xyXG5cdHB1YmxpYyBhZGRVc2FnZShyZWdpc3RlcjpTaGFkZXJSZWdpc3RlckVsZW1lbnQsIHVzYWdlQ291bnQ6bnVtYmVyKVxyXG5cdHtcclxuXHRcdGlmIChyZWdpc3Rlci5fY29tcG9uZW50ID4gLTEpXHJcblx0XHRcdHRoaXMuX3VzZWRTaW5nbGVDb3VudFtyZWdpc3Rlci5fY29tcG9uZW50XVtyZWdpc3Rlci5pbmRleF0gKz0gdXNhZ2VDb3VudDtcclxuXHRcdGVsc2VcclxuXHRcdFx0dGhpcy5fdXNlZFZlY3RvckNvdW50W3JlZ2lzdGVyLmluZGV4XSArPSB1c2FnZUNvdW50O1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogUmVtb3ZlcyBhIHVzYWdlIGZyb20gYSByZWdpc3Rlci4gV2hlbiB1c2FnZXMgcmVhY2ggMCwgdGhlIHJlZ2lzdGVyIGlzIGZyZWVkIGFnYWluLlxyXG5cdCAqIEBwYXJhbSByZWdpc3RlciBUaGUgcmVnaXN0ZXIgZm9yIHdoaWNoIHRvIHJlbW92ZSBhIHVzYWdlLlxyXG5cdCAqL1xyXG5cdHB1YmxpYyByZW1vdmVVc2FnZShyZWdpc3RlcjpTaGFkZXJSZWdpc3RlckVsZW1lbnQpXHJcblx0e1xyXG5cdFx0aWYgKHJlZ2lzdGVyLl9jb21wb25lbnQgPiAtMSkge1xyXG5cdFx0XHRpZiAoLS10aGlzLl91c2VkU2luZ2xlQ291bnRbcmVnaXN0ZXIuX2NvbXBvbmVudF1bcmVnaXN0ZXIuaW5kZXhdIDwgMClcclxuXHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoXCJNb3JlIHVzYWdlcyByZW1vdmVkIHRoYW4gZXhpc3QhXCIpO1xyXG5cdFx0fSBlbHNlIHtcclxuXHRcdFx0aWYgKC0tdGhpcy5fdXNlZFZlY3RvckNvdW50W3JlZ2lzdGVyLmluZGV4XSA8IDApXHJcblx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKFwiTW9yZSB1c2FnZXMgcmVtb3ZlZCB0aGFuIGV4aXN0IVwiKTtcclxuXHRcdH1cclxuXHR9XHJcblxyXG5cdC8qKlxyXG5cdCAqIERpc3Bvc2VzIGFueSByZXNvdXJjZXMgdXNlZCBieSB0aGUgY3VycmVudCBSZWdpc3RlclBvb2wgb2JqZWN0LlxyXG5cdCAqL1xyXG5cdHB1YmxpYyBkaXNwb3NlKClcclxuXHR7XHJcblx0XHR0aGlzLl92ZWN0b3JSZWdpc3RlcnMgPSBudWxsO1xyXG5cdFx0dGhpcy5fcmVnaXN0ZXJDb21wb25lbnRzID0gbnVsbDtcclxuXHRcdHRoaXMuX3VzZWRTaW5nbGVDb3VudCA9IG51bGw7XHJcblx0XHR0aGlzLl91c2VkVmVjdG9yQ291bnQgPSBudWxsO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogSW5kaWNhdGVzIHdoZXRoZXIgb3Igbm90IGFueSByZWdpc3RlcnMgYXJlIGluIHVzZS5cclxuXHQgKi9cclxuXHRwdWJsaWMgaGFzUmVnaXN0ZXJlZFJlZ3MoKTpib29sZWFuXHJcblx0e1xyXG5cdFx0Zm9yICh2YXIgaTpudW1iZXIgPSAwOyBpIDwgdGhpcy5fcmVnQ291bnQ7ICsraSlcclxuXHRcdFx0aWYgKHRoaXMuaXNSZWdpc3RlclVzZWQoaSkpXHJcblx0XHRcdFx0cmV0dXJuIHRydWU7XHJcblxyXG5cdFx0cmV0dXJuIGZhbHNlO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogSW5pdGlhbGl6ZXMgYWxsIHJlZ2lzdGVycy5cclxuXHQgKi9cclxuXHRwcml2YXRlIGluaXRSZWdpc3RlcnMocmVnTmFtZTpzdHJpbmcsIHJlZ0NvdW50Om51bWJlcilcclxuXHR7XHJcblx0XHR2YXIgaGFzaDpzdHJpbmcgPSBSZWdpc3RlclBvb2wuX2luaXRQb29sKHJlZ05hbWUsIHJlZ0NvdW50KTtcclxuXHJcblx0XHR0aGlzLl92ZWN0b3JSZWdpc3RlcnMgPSBSZWdpc3RlclBvb2wuX3JlZ1Bvb2xbaGFzaF07XHJcblx0XHR0aGlzLl9yZWdpc3RlckNvbXBvbmVudHMgPSBSZWdpc3RlclBvb2wuX3JlZ0NvbXBzUG9vbFtoYXNoXTtcclxuXHJcblx0XHR0aGlzLl91c2VkVmVjdG9yQ291bnQgPSB0aGlzLl9pbml0QXJyYXkoQXJyYXk8bnVtYmVyPihyZWdDb3VudCksIDApO1xyXG5cclxuXHRcdHRoaXMuX3VzZWRTaW5nbGVDb3VudCA9IG5ldyBBcnJheTxBcnJheTxudW1iZXI+Pig0KTtcclxuXHRcdHRoaXMuX3VzZWRTaW5nbGVDb3VudFswXSA9IHRoaXMuX2luaXRBcnJheShuZXcgQXJyYXk8bnVtYmVyPihyZWdDb3VudCksIDApO1xyXG5cdFx0dGhpcy5fdXNlZFNpbmdsZUNvdW50WzFdID0gdGhpcy5faW5pdEFycmF5KG5ldyBBcnJheTxudW1iZXI+KHJlZ0NvdW50KSwgMCk7XHJcblx0XHR0aGlzLl91c2VkU2luZ2xlQ291bnRbMl0gPSB0aGlzLl9pbml0QXJyYXkobmV3IEFycmF5PG51bWJlcj4ocmVnQ291bnQpLCAwKTtcclxuXHRcdHRoaXMuX3VzZWRTaW5nbGVDb3VudFszXSA9IHRoaXMuX2luaXRBcnJheShuZXcgQXJyYXk8bnVtYmVyPihyZWdDb3VudCksIDApO1xyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSBzdGF0aWMgX2luaXRQb29sKHJlZ05hbWU6c3RyaW5nLCByZWdDb3VudDpudW1iZXIpOnN0cmluZ1xyXG5cdHtcclxuXHRcdHZhciBoYXNoOnN0cmluZyA9IHJlZ05hbWUgKyByZWdDb3VudDtcclxuXHJcblx0XHRpZiAoUmVnaXN0ZXJQb29sLl9yZWdQb29sW2hhc2hdICE9IHVuZGVmaW5lZClcclxuXHRcdFx0cmV0dXJuIGhhc2g7XHJcblxyXG5cdFx0dmFyIHZlY3RvclJlZ2lzdGVyczpBcnJheTxTaGFkZXJSZWdpc3RlckVsZW1lbnQ+ID0gbmV3IEFycmF5PFNoYWRlclJlZ2lzdGVyRWxlbWVudD4ocmVnQ291bnQpO1xyXG5cdFx0UmVnaXN0ZXJQb29sLl9yZWdQb29sW2hhc2hdID0gdmVjdG9yUmVnaXN0ZXJzO1xyXG5cclxuXHRcdHZhciByZWdpc3RlckNvbXBvbmVudHMgPSBbXHJcblx0XHRcdFtdLFxyXG5cdFx0XHRbXSxcclxuXHRcdFx0W10sXHJcblx0XHRcdFtdXHJcblx0XHRdO1xyXG5cdFx0UmVnaXN0ZXJQb29sLl9yZWdDb21wc1Bvb2xbaGFzaF0gPSByZWdpc3RlckNvbXBvbmVudHM7XHJcblxyXG5cdFx0Zm9yICh2YXIgaTpudW1iZXIgPSAwOyBpIDwgcmVnQ291bnQ7ICsraSkge1xyXG5cclxuXHRcdFx0dmVjdG9yUmVnaXN0ZXJzW2ldID0gbmV3IFNoYWRlclJlZ2lzdGVyRWxlbWVudChyZWdOYW1lLCBpKTtcclxuXHJcblx0XHRcdGZvciAodmFyIGo6bnVtYmVyID0gMDsgaiA8IDQ7ICsrailcclxuXHRcdFx0XHRyZWdpc3RlckNvbXBvbmVudHNbal1baV0gPSBuZXcgU2hhZGVyUmVnaXN0ZXJFbGVtZW50KHJlZ05hbWUsIGksIGopO1xyXG5cdFx0fVxyXG5cclxuXHRcdHJldHVybiBoYXNoO1xyXG5cdH1cclxuXHJcblxyXG5cdC8qKlxyXG5cdCAqIENoZWNrIGlmIHRoZSB0ZW1wIHJlZ2lzdGVyIGlzIGVpdGhlciB1c2VkIGZvciBzaW5nbGUgb3IgdmVjdG9yIHVzZVxyXG5cdCAqL1xyXG5cdHByaXZhdGUgaXNSZWdpc3RlclVzZWQoaW5kZXg6bnVtYmVyKTpib29sZWFuXHJcblx0e1xyXG5cdFx0aWYgKHRoaXMuX3VzZWRWZWN0b3JDb3VudFtpbmRleF0gPiAwKVxyXG5cdFx0XHRyZXR1cm4gdHJ1ZTtcclxuXHJcblx0XHRmb3IgKHZhciBpOm51bWJlciA9IDA7IGkgPCA0OyArK2kpXHJcblx0XHRcdGlmICh0aGlzLl91c2VkU2luZ2xlQ291bnRbaV1baW5kZXhdID4gMClcclxuXHRcdFx0XHRyZXR1cm4gdHJ1ZTtcclxuXHJcblx0XHRyZXR1cm4gZmFsc2U7XHJcblx0fVxyXG5cclxuXHJcblx0cHJpdmF0ZSBfaW5pdEFycmF5KGE6QXJyYXk8YW55PiwgdmFsOmFueSk6QXJyYXk8YW55PlxyXG5cdHtcclxuXHRcdHZhciBsOm51bWJlciA9IGEubGVuZ3RoO1xyXG5cclxuXHRcdGZvciAodmFyIGM6bnVtYmVyID0gMDsgYyA8IGw7IGMrKylcclxuXHRcdFx0YVtjXSA9IHZhbDtcclxuXHJcblx0XHRyZXR1cm4gYTtcclxuXHR9XHJcbn1cclxuXHJcbmV4cG9ydCA9IFJlZ2lzdGVyUG9vbDtcclxuIl19